<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notas - Real Madrid CF</title>
        
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/png" href="./favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="./favicon.svg" />
    <link rel="shortcut icon" href="./favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="https://upload.wikimedia.org/wikipedia/en/thumb/5/56/Real_Madrid_CF.svg/180px-Real_Madrid_CF.svg.png">

    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js" defer></script>    
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0" defer></script>

    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js" defer></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js" defer></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js" defer></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" defer></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js" defer></script>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/css/shepherd.css"/>
    <script src="https://cdn.jsdelivr.net/npm/shepherd.js@10.0.1/dist/js/shepherd.min.js" defer></script>
    <link rel="stylesheet" href="styles.css">

</head>
<body class="bg-gray-100 min-h-screen">
    
    <!-- WELCOME SCREEN -->
    <section id="section-welcome" class="welcome-bg min-h-screen flex flex-col items-center justify-center p-4 text-white">
        <div class="text-center mb-10">
            <img src="https://upload.wikimedia.org/wikipedia/en/thumb/5/56/Real_Madrid_CF.svg/1200px-Real_Madrid_CF.svg.png" 
                 alt="Real Madrid" class="w-24 h-24 object-contain mx-auto mb-4 drop-shadow-2xl">
            <h1 class="text-3xl md:text-5xl font-bold mb-2 drop-shadow-md">Notas Real Madrid</h1>
            <p class="text-blue-100 font-medium text-lg drop-shadow-md">Temporada 2025/2026</p>
            
            <!-- STORAGE MODE TOGGLE -->
            <div class="mt-6 bg-white/10 backdrop-blur-md p-1 rounded-lg inline-flex">
                <button onclick="setStorageMode('local')" id="btn-mode-local" class="px-4 py-2 rounded-md font-bold bg-white text-slate-900 shadow-sm transition-all text-sm">üì± Local</button>
                <button onclick="setStorageMode('global')" id="btn-mode-global" class="px-4 py-2 rounded-md font-bold text-white hover:bg-white/10 transition-all text-sm">‚òÅÔ∏è Global (Nube)</button>
            </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-4xl">
            <!-- MASCULINO -->
            <div onclick="selectTeam('masculino')" class="welcome-card bg-white/10 backdrop-blur-sm text-white rounded-2xl p-8 text-center shadow-2xl border-b-8 border-blue-600 hover:bg-white/20 transition-all">
                <h2 class="text-2xl font-bold mb-2">Real Madrid Masculino</h2>
                <p class="text-black-200 font-semibold">Temporada 2025/2026</p>
                <p class="text-sm text-black-300 mt-2">La Liga, Champions, Copa del Rey...</p>
            </div>

            <!-- FEMENINO -->
            <div onclick="selectTeam('femenino')" class="welcome-card bg-white/10 backdrop-blur-sm text-white rounded-2xl p-8 text-center shadow-2xl border-b-8 border-purple-500 hover:bg-white/20 transition-all">
                <h2 class="text-2xl font-bold mb-2">Real Madrid Femenino</h2>
                <p class="text-black-200 font-semibold">Temporada 2025/2026</p>
                <p class="text-sm text-black-300 mt-2">Liga F, UWCL, Copa de la Reina...</p>
            </div>
        </div>
    </section>
    <!-- APP CONTAINER (Hidden initially) -->
    <div id="app-container" class="hidden bg-gray-100">
        <!-- Header Real Madrid -->
        <header class="rm-header-gradient text-white shadow-lg">


            <div class="container mx-auto px-4 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3 cursor-pointer hover:opacity-80 transition" onclick="returnToWelcome()" title="Volver a selecci√≥n de equipo">
                        <img src="https://upload.wikimedia.org/wikipedia/en/thumb/5/56/Real_Madrid_CF.svg/1200px-Real_Madrid_CF.svg.png" 
                             alt="Real Madrid" class="w-12 h-12 object-contain" loading="lazy">
                        <div>
                            <h1 class="text-2xl font-bold">An√°lisis Real Madrid</h1>
                            <p id="header-subtitle" class="text-blue-200 text-sm">Real Madrid CF</p>
                        </div>
                    </div>

                    <!-- MATCHDAY BANNER (Desktop) -->
                    <div id="matchday-banner-desktop" class="hidden md:flex items-center gap-4 bg-white/10 px-4 py-2 rounded-lg border border-white/10 backdrop-blur-sm animate-pulse">
                        <span class="text-2xl">‚öΩ</span>
                        <div class="text-right">
                            <div class="text-xs font-bold text-amber-400 uppercase tracking-widest">D√çA DE PARTIDO</div>
                            <div class="font-bold text-sm leading-none text-white" id="matchday-desktop-text">vs Rival</div>
                            <div class="text-[10px] text-blue-200" id="matchday-desktop-info">21:00 ‚Ä¢ Liga</div>
                        </div>
                    </div>

                    <button onclick="toggleDarkMode()" id="btn-dark-mode" class="p-2 rounded-full bg-white/10 hover:bg-white/20 transition backdrop-blur-sm" title="Cambiar Tema">
                        üåô
                    </button>
                    <button id="btn-tour" class="ml-2 p-2 rounded-full bg-white/10 hover:bg-white/20 transition backdrop-blur-sm" title="Iniciar Tour Guiado">
                        üéì
                    </button>
                    <button id="btn-auth" class="ml-2 p-2 rounded-full bg-white/10 hover:bg-white/20 transition backdrop-blur-sm text-xs font-bold" title="Iniciar Sesi√≥n">
                        üîí
                    </button>
                </div>

                <!-- MATCHDAY BANNER (Mobile) -->
                <div id="matchday-banner-mobile" class="md:hidden hidden mt-4 bg-gradient-to-r from-amber-600 to-orange-600 rounded-lg p-3 shadow-lg flex items-center justify-between animate-in slide-in-from-top-2">
                    <div class="flex items-center gap-3">
                        <div class="bg-white/20 p-2 rounded-full">‚öΩ</div>
                        <div>
                            <div class="text-[10px] font-black text-amber-100 uppercase tracking-widest">HOY JUEGA EL MADRID</div>
                            <div class="font-bold text-sm text-white" id="matchday-mobile-text">vs Rival</div>
                        </div>
                    </div>
                    <div class="text-right text-xs text-white font-mono bg-black/20 px-2 py-1 rounded" id="matchday-mobile-time">
                        21:00
                    </div>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="bg-slate-800 shadow-sm sticky top-0 z-40">
            <div class="container mx-auto px-4">
                <div class="flex gap-1 overflow-x-auto">
                    <button onclick="showTab('principal')" id="tab-principal" class="tab-btn px-4 py-3 font-medium text-gray-300 hover:text-amber-400 whitespace-nowrap">
                        üè† Principal
                    </button>
                    <button onclick="showTab('plantilla')" id="tab-plantilla" class="tab-btn px-4 py-3 font-medium text-gray-300 hover:text-amber-400 whitespace-nowrap tab-active">
                        üë• Plantilla
                    </button>
                    <button onclick="showTab('calendario')" id="tab-calendario" class="tab-btn px-4 py-3 font-medium text-gray-300 hover:text-amber-400 whitespace-nowrap">
                        üìÖ Calendario
                    </button>
                    <button onclick="showTab('nuevo')" id="tab-nuevo" class="tab-btn px-4 py-3 font-medium text-gray-300 hover:text-amber-400 whitespace-nowrap">
                        ‚ûï Registrar Partido
                    </button>
                    <button onclick="showTab('partidos')" id="tab-partidos" class="tab-btn px-4 py-3 font-medium text-gray-300 hover:text-amber-400 whitespace-nowrap">
                        ‚öΩ Partidos
                    </button>
                    <button onclick="showTab('stats')" id="tab-stats" class="tab-btn px-4 py-3 font-medium text-gray-300 hover:text-amber-400 whitespace-nowrap">
                        üìä Estad√≠sticas
                    </button>
                    <button onclick="showTab('comparador')" id="tab-comparador" class="tab-btn px-4 py-3 font-medium text-gray-300 hover:text-amber-400 whitespace-nowrap">
                        üÜö Comparador
                    </button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="container mx-auto px-4 py-6">
            <!--Men√∫ principal-->
            <section id="section-principal" class="hidden fade-in">
                <div class="mb-6 flex flex-col sm:flex-row justify-between items-start sm:items-end gap-4">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Panel General</h2>
                        <p class="text-gray-500 text-sm">Resumen de la temporada actual</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="toggleDashboardEditMode()" id="btn-edit-dashboard" class="bg-white text-gray-600 border border-gray-300 hover:bg-gray-50 font-bold py-2 px-4 rounded-lg shadow-sm flex items-center gap-2 transition-all text-sm">
                            <span>‚úèÔ∏è</span> Editar Panel
                        </button>
                    </div>
                    <button onclick="showCrystalBall()" class="bg-gradient-to-r from-purple-500 to-pink-500 hover:from-purple-600 hover:to-pink-600 text-white font-bold py-2 px-4 rounded-lg shadow-md flex items-center gap-2 transition-all transform hover:scale-105 text-sm">
                        <span>üîÆ</span> Bola de Cristal
                    </button>
                </div>
                <div id="club-trophies-container" class="hidden fade-in"></div>
                <div id="competition-status" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6"></div>
                <div id="dashboard-widgets-area" class="space-y-6">
                <div id="widget-top-stats" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" draggable="false">
                    
                    <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 border-slate-800 relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-4 opacity-10 text-slate-800 text-6xl">üìÖ</div>
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Pr√≥ximo Partido</h3>
                        <div id="dashboard-next-match">
                            <p class="text-gray-500 text-sm">Cargando...</p>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 border-amber-400 relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-4 opacity-10 text-amber-500 text-6xl">üî•</div>
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Estado de Forma (√öltimos 5)</h3>
                        <div id="dashboard-form" class="flex items-center gap-2 mt-2">
                            <span class="text-gray-500 text-sm">Sin datos</span>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 border-blue-600 relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-4 opacity-10 text-blue-600 text-6xl">üìä</div>
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Resumen Temporada</h3>
                        <div id="dashboard-summary" class="flex justify-between items-end mt-2">
                             <div class="text-center">
                                <span class="block text-2xl font-bold text-green-600" id="dash-wins">0</span>
                                <span class="text-xs text-gray-500">Vic</span>
                             </div>
                             <div class="text-center">
                                <span class="block text-2xl font-bold text-amber-600" id="dash-draws">0</span>
                                <span class="text-xs text-gray-500">Emp</span>
                             </div>
                             <div class="text-center">
                                <span class="block text-2xl font-bold text-red-600" id="dash-losses">0</span>
                                <span class="text-xs text-gray-500">Der</span>
                             </div>
                             <div class="w-px h-8 bg-gray-200 mx-1"></div>
                             <div class="text-center">
                                <span class="block text-xl font-bold text-slate-700" id="dash-gf">0</span>
                                <span class="text-xs text-gray-500">GF</span>
                             </div>
                             <div class="text-center">
                                <span class="block text-xl font-bold text-slate-700" id="dash-ga">0</span>
                                <span class="text-xs text-gray-500">GC</span>
                             </div>
                        </div>
                    </div>
                </div> <!-- End Top Stats -->
                  <div id="ai-prediction-card" class="hidden bg-gradient-to-r from-violet-600 to-indigo-600 rounded-xl shadow-lg p-1 text-white relative overflow-hidden" draggable="false">
                    <div class="absolute top-0 right-0 p-8 opacity-10 text-9xl">ü§ñ</div>
                    
                    <div class="bg-slate-900/40 backdrop-blur-md rounded-lg p-5">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
                            
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="bg-violet-500 text-white text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wider shadow-sm border border-violet-400">AI Analysis</span>
                                    <span class="text-violet-200 text-xs font-mono" id="ai-match-label">Analizando datos...</span>
                                </div>
                                <h3 class="text-2xl font-bold text-white mb-1 flex items-center gap-2">
                                    <span id="ai-prediction-text">Calculando probabilidades...</span>
                                </h3>
                                <p class="text-indigo-200 text-sm" id="ai-reasoning">Procesando racha y estad√≠sticas...</p>
                            </div>

                            <div class="w-full md:w-auto flex flex-col gap-2 min-w-[200px]">
                                <div class="flex justify-between text-xs font-bold text-indigo-100 uppercase tracking-widest">
                                    <span>Probabilidad de Victoria</span>
                                    <span id="ai-win-prob">--%</span>
                                </div>
                                <div class="w-full h-3 bg-slate-700/50 rounded-full overflow-hidden flex">
                                    <div id="prob-bar-win" class="h-full bg-green-400 shadow-[0_0_10px_rgba(74,222,128,0.5)] transition-all duration-1000" style="width: 0%"></div>
                                    <div id="prob-bar-draw" class="h-full bg-yellow-400 opacity-80 transition-all duration-1000" style="width: 0%"></div>
                                </div>
                                <div class="flex justify-between text-[10px] text-gray-300 mt-1">
                                    <span class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-green-400"></div> Victoria</span>
                                    <span class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-yellow-400"></div> Empate</span>
                                    <span class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-slate-600"></div> Derrota</span>
                                </div>
                            </div>

                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6 border-t border-white/10 pt-4">
                            <div class="flex items-center gap-3">
                                <div class="text-3xl">üîÆ</div>
                                <div>
                                    <p class="text-[10px] uppercase text-indigo-300 font-bold">Marcador Probable</p>
                                    <p class="text-xl font-bold text-white" id="ai-score-prediction">-</p>
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-3">
                                <div class="text-3xl">üî•</div>
                                <div>
                                    <p class="text-[10px] uppercase text-indigo-300 font-bold">Jugador a Seguir</p>
                                    <p class="text-sm font-bold text-white" id="ai-player-watch">-</p>
                                    <p class="text-[10px] text-indigo-200" id="ai-player-reason">-</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
              <div class="w-full mt-6"> <h3 class="text-lg font-bold text-gray-700 mb-4 flex items-center gap-2 px-1">
        üö¶ Sem√°foro de Forma <span class="text-xs font-normal text-gray-400 ml-auto">√öltimos 3 partidos</span>
    </h3>

    <div id="semaforo-content" class="w-full"></div>

    <div id="semaforo-expand-btn-container" class="hidden mt-3 text-center">
        <button id="btn-traffic-all" onclick="toggleTrafficAll()" 
                class="w-full py-2 bg-gray-50 hover:bg-gray-100 text-xs font-bold text-gray-500 hover:text-blue-600 rounded-lg transition-colors uppercase tracking-wide border border-dashed border-gray-200">
            Ver todos los jugadores ‚ñº
        </button>
    </div>
</div>
            <div id="top-performances-container" class="animate-fade-in hidden" draggable="false">
    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
        <span>üåü</span> Actuaciones Legendarias (Top 5)
    </h3>
    <div id="top-performances-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
        </div>
    </div> <!-- End Top Perf -->
                <div id="widget-bottom-stats" class="grid grid-cols-1 lg:grid-cols-3 gap-6" draggable="false">
                    
                    <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="px-5 py-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                             <h3 class="font-bold text-gray-700">√öltimos Resultados</h3>
                             <button onclick="showTab('partidos')" class="text-xs text-blue-600 hover:underline">Ver todos</button>
                        </div>
                        <div id="dashboard-last-results" class="divide-y divide-gray-100">
                             </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="px-5 py-4 border-b border-gray-100 bg-gray-50">
                             <h3 class="font-bold text-gray-700">L√≠deres</h3>
                        </div>
                        <div id="dashboard-leaders" class="p-4 space-y-4">
                             </div>
                    </div>

                </div> <!-- End Bottom Stats -->
                </div> <!-- End Dashboard Widgets Area -->
<div id="probableLineupContainer" class="w-full h-full min-h-[500px]">
    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-full animate-pulse flex flex-col gap-4">
        <div class="h-6 bg-gray-200 rounded w-1/3"></div>
        <div class="space-y-2">
            <div class="h-10 bg-gray-100 rounded"></div>
            <div class="h-10 bg-gray-100 rounded"></div>
            <div class="h-10 bg-gray-100 rounded"></div>
            <div class="h-10 bg-gray-100 rounded"></div>
        </div>
    </div>
</div>
                <div class="mt-8 bg-white rounded-xl shadow-sm p-6 border border-gray-200" id="widget-data-management">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                        üíæ Gesti√≥n de Datos
                    </h3>
                    <p class="text-sm text-gray-500 mb-4">
                        Guarda una copia de seguridad de toda tu temporada o restaura un archivo guardado anteriormente. 
                        <span class="text-amber-600 font-bold">¬°Haz esto frecuentemente para no perder datos!</span>
                    </p>
                    
                   <div class="flex flex-col sm:flex-row gap-4">
                        <button onclick="backupData()" class="flex-1 bg-green-50 hover:bg-green-100 text-green-700 border border-green-200 px-4 py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition-all">
                            ‚¨áÔ∏è Descargar Copia
                        </button>

                        <div class="flex-1 relative">
                            <input type="file" id="import-file" accept=".json" class="hidden" onchange="restoreData(this)">
                            <button onclick="document.getElementById('import-file').click()" class="w-full bg-blue-50 hover:bg-blue-100 text-blue-700 border border-blue-200 px-4 py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition-all">
                                ‚¨ÜÔ∏è Restaurar Datos
                            </button>
                        </div>

                       <div class="flex-1 relative flex gap-2">
                            <input type="file" id="import-csv" accept=".csv" class="hidden" onchange="importFromCSV(this)">
                            
                            <button onclick="document.getElementById('import-csv').click()" class="flex-1 bg-orange-50 hover:bg-orange-100 text-orange-700 border border-orange-200 px-4 py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition-all">
                                üìä Importar Excel (CSV)
                            </button>

                            <button onclick="toggleCSVInfo()" class="w-12 flex items-center justify-center bg-white border border-gray-200 rounded-xl hover:bg-gray-50 transition-all shadow-sm" title="Ver formato requerido">
                                <img src="https://cdn-icons-png.flaticon.com/512/8/8201.png" alt="Info" class="w-6 h-6 opacity-70" loading="lazy">
                            </button>

                            <div id="csv-info-modal" class="hidden absolute bottom-full right-0 mb-2 w-80 md:w-96 bg-white rounded-xl shadow-2xl border border-gray-200 z-50 p-0 overflow-hidden animate-in fade-in zoom-in duration-200">
                                <div class="bg-slate-800 text-white p-3 flex justify-between items-center">
                                    <h4 class="font-bold text-sm">üìÑ Formato Requerido para Excel</h4>
                                    <button onclick="toggleCSVInfo()" class="text-gray-400 hover:text-white">‚úï</button>
                                </div>
                                <div class="p-4 text-sm text-gray-600">
                                    <p class="mb-3">Para que la importaci√≥n funcione correctamente y detecte las fechas, usa esta estructura:</p>
                                    
                                    <div class="border border-gray-300 rounded overflow-hidden mb-3">
                                        <table class="w-full text-xs text-center">
                                            <tr class="bg-gray-100 font-bold border-b border-gray-300">
                                                <td class="p-1 border-r"></td>
                                                <td class="p-1 border-r text-blue-600">Rival A</td>
                                                <td class="p-1 text-blue-600">Rival B</td>
                                            </tr>
                                            <tr class="bg-yellow-50 border-b border-gray-300 font-mono text-[10px]">
                                                <td class="p-1 border-r font-bold text-gray-400">FECHA -></td>
                                                <td class="p-1 border-r text-orange-600 font-bold">26/10/2024</td>
                                                <td class="p-1 text-orange-600 font-bold">03/11/2024</td>
                                            </tr>
                                            <tr class="border-b border-gray-100">
                                                <td class="p-1 border-r font-bold text-left pl-2">Mbapp√©</td>
                                                <td class="p-1 border-r">8,5</td>
                                                <td class="p-1">7</td>
                                            </tr>
                                            <tr>
                                                <td class="p-1 border-r font-bold text-left pl-2">Vini Jr</td>
                                                <td class="p-1 border-r">9</td>
                                                <td class="p-1">6,5</td>
                                            </tr>
                                        </table>
                                    </div>

                                    <ul class="list-disc list-inside text-xs space-y-1 text-gray-500">
                                        <li><b>Fila 1:</b> Nombres de los Rivales.</li>
                                        <li><b>Fila 2:</b> Fechas (DD/MM/AAAA) <span class="text-orange-600 font-bold">*Importante</span>.</li>
                                        <li><b>Columna A:</b> Nombres de los Jugadores.</li>
                                        <li>Guarda el archivo como <b>CSV (delimitado por comas o punto y coma)</b>.</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4 pt-4 border-t border-gray-100 text-right">
                        <button onclick="hardReset()" class="text-xs text-red-400 hover:text-red-600 underline">
                            Borrar todo y empezar de cero
                        </button>
                    </div>
                </div>
            </section>
            
            <!-- PLANTILLA SECTION -->
            <section id="section-plantilla" class="fade-in">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Plantilla</h2>
                        <p class="text-gray-500 text-sm">Gesti√≥n de estado de jugadores</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="filterPlayers('all')" id="filter-all" class="px-3 py-1.5 text-sm bg-slate-800 text-white rounded-lg">
                            Todos
                        </button>
                        <button onclick="filterPlayers('active')" id="filter-active" class="px-3 py-1.5 text-sm bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                            Activos
                        </button>
                        <button onclick="filterPlayers('inactive')" id="filter-inactive" class="px-3 py-1.5 text-sm bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                            Inactivos
                        </button>
                        <button onclick="filterPlayers('loaned')" id="filter-loaned" class="px-3 py-1.5 text-sm bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                            Cedidos
                        </button>
                    </div>
                </div>
                <div class="mb-4 relative">
    <input type="text" id="player-search" placeholder="üîç Buscar jugador por nombre o dorsal..." 
           class="w-full pl-10 pr-4 py-3 rounded-xl border border-gray-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all"
           onkeyup="renderPlayers()">
    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
    </div>
    </div>
                <!-- Filter by Position -->
                <div class="bg-white rounded-xl shadow-sm p-4 mb-4">
                    <div class="flex flex-wrap gap-2">
                        <button onclick="filterByPosition('')" class="pos-filter px-3 py-1 text-sm rounded-full bg-slate-800 text-white">Todas</button>
                        <button onclick="filterByPosition('entrenador')" class="pos-filter px-3 py-1 text-sm rounded-full bg-gray-200 hover:bg-slate-300 font-bold border border-slate-400">Entrenador</button>
                        <button onclick="filterByPosition('portero')" class="pos-filter px-3 py-1 text-sm rounded-full bg-gray-200 hover:bg-amber-100">Porter√≠a</button>
                        <button onclick="filterByPosition('defensa')" class="pos-filter px-3 py-1 text-sm rounded-full bg-gray-200 hover:bg-blue-100">Defensa</button>
                        <button onclick="filterByPosition('centrocampista')" class="pos-filter px-3 py-1 text-sm rounded-full bg-gray-200 hover:bg-green-100">Medio</button>
                        <button onclick="filterByPosition('extremo')" class="pos-filter px-3 py-1 text-sm rounded-full bg-gray-200 hover:bg-purple-100">Extremo</button>
                        <button onclick="filterByPosition('delantero')" class="pos-filter px-3 py-1 text-sm rounded-full bg-gray-200 hover:bg-red-100">Delantera</button>
                    </div>
                </div>
                
                <div id="players-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                </div>
            </section>

            <!-- CALENDARIO SECTION -->
            <section id="section-calendario" class="hidden fade-in">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Calendario Oficial</h2>
                        <p class="text-gray-500 text-sm">Haz clic en partidos pasados para registrar estad√≠sticas</p>
                    </div>
                    <div class="flex gap-2">
                        <div class="bg-white rounded-lg p-1 border flex">
                            <button onclick="switchCalendarView('list')" id="cal-view-list" class="px-3 py-1.5 text-sm rounded-md font-medium transition text-gray-600 hover:bg-gray-100">
                                üìÉ Lista
                            </button>
                            <button onclick="switchCalendarView('month')" id="cal-view-month" class="px-3 py-1.5 text-sm rounded-md font-medium transition bg-slate-800 text-white">
                                üóìÔ∏è Mes
                            </button>
                        </div>
                        <button onclick="loadCalendar()" class="bg-slate-800 hover:bg-slate-700 text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2">
                            üîÑ Actualizar
                        </button>
                    </div>
                </div>

                <!-- Calendar Select Hint -->
                <div class="calendar-select-hint rounded-xl p-4 mb-4 flex justify-between items-center">
                    <p class="text-sm">
                        <strong>üí° Consejo:</strong> Los partidos marcados en gris ya han sido registrados.
                    </p>
                    <label class="flex items-center gap-2 text-sm font-medium cursor-pointer">
                        <input type="checkbox" id="hide-registered-matches" onchange="renderCalendar()" class="w-4 h-4 text-slate-800">
                        Ocultar registrados
                    </label>
                </div>
                
                <!-- Competition Filters -->
                <div class="bg-white rounded-xl shadow-sm p-4 mb-4">
                    <div id="calendar-filters-container" class="flex flex-wrap gap-2">
                        <!-- Filters populated dynamically -->
                    </div>
                </div>

                <!-- Time Filter (Only for list view) -->
                <div id="cal-time-filters" class="hidden bg-white rounded-xl shadow-sm p-4 mb-4">
                    <div class="flex flex-wrap gap-2">
                        <button onclick="filterCalendarTime('all')" class="time-filter px-3 py-1 text-sm rounded-full bg-slate-800 text-white">Todos</button>
                        <button onclick="filterCalendarTime('past')" class="time-filter px-3 py-1 text-sm rounded-full bg-gray-200 text-gray-700">Pasados</button>
                        <button onclick="filterCalendarTime('future')" class="time-filter px-3 py-1 text-sm rounded-full bg-gray-200 text-gray-700">Pr√≥ximos</button>
                    </div>
                </div>
                
                <!-- Month Navigation (Only for month view) -->
                <div id="cal-month-nav" class="bg-white rounded-xl shadow-sm p-4 mb-4 flex justify-between items-center">
                    <button onclick="changeCalendarMonth(-1)" class="p-2 hover:bg-gray-100 rounded-full">‚¨ÖÔ∏è Anterior</button>
                    <h3 id="current-month-display" class="text-lg font-bold text-slate-800"></h3>
                    <button onclick="changeCalendarMonth(1)" class="p-2 hover:bg-gray-100 rounded-full">Siguiente ‚û°Ô∏è</button>
                </div>
                
                <div id="calendar-container" class="space-y-3">
                    <div class="calendar-loading text-center py-12">
                        <div class="text-4xl mb-4">‚è≥</div>
                        <p class="text-gray-600">Cargando calendario...</p>
                    </div>
                </div>
            </section>

            <!-- NUEVO PARTIDO SECTION -->
            <section id="section-nuevo" class="hidden fade-in">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Registrar Nuevo Partido</h2>
                    <p class="text-gray-500 text-sm">Registro en 2 pasos: Datos y Jugadores</p>
                </div>
                
                <!-- Prompt to select from Calendar -->
                <div id="select-match-prompt" class="text-center py-12 bg-white rounded-xl shadow-sm">
                    <div class="text-6xl mb-4">üìÖ</div>
                    <h3 class="text-xl font-medium text-gray-800 mb-2">Selecciona un partido del calendario</h3>
                    <p class="text-gray-500 mb-6 max-w-md mx-auto">Para garantizar la integridad de los datos, todos los partidos deben ser seleccionados primero desde la secci√≥n de Calendario.</p>
                    <button onclick="showTab('calendario')" class="bg-slate-800 hover:bg-slate-700 text-white px-6 py-3 rounded-lg font-medium transition">
                        Ir al Calendario
                    </button>
                </div>

                <div id="new-match-form-container" class="hidden">
                    <!-- Selected Fixture Info -->
                    <div id="selected-fixture-info" class="bg-amber-50 border-2 border-amber-400 rounded-xl p-4 mb-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-amber-800 font-medium">üìÖ Partido seleccionado del calendario:</p>
                                <p id="selected-fixture-details" class="text-amber-900 font-semibold"></p>
                            </div>
                            <button onclick="clearSelectedFixture()" class="text-amber-600 hover:text-amber-800 text-sm font-medium">
                                ‚úï Cancelar selecci√≥n
                            </button>
                        </div>
                    </div>

                    <!-- New Match Form -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <form id="new-match-form" class="space-y-6">
                            <input type="hidden" id="calendar-event-id" value="">
                            
                            <div id="wizard-step-1">
                                <h3 class="text-lg font-bold text-gray-800 mb-4 pb-2 border-b">Paso 1: Datos del Partido</h3>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Competici√≥n *</label>
                                        <select id="new-competition" required onchange="updateRoundOptions()" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500 bg-white">
                                            <option value="">Seleccionar competici√≥n...</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Jornada / Ronda *</label>
                                        <select id="new-round" required onchange="handleRoundChange()" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500 bg-white">
                                            <option value="">Primero selecciona competici√≥n...</option>
                                        </select>
                                        <p id="round-info" class="text-xs text-gray-500 mt-1"></p>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Rival *</label>
                                        <input type="text" id="new-opponent" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500 bg-gray-100" readonly>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Fecha *</label>
                                        <input type="date" id="new-date" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500">
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div id="stadium-container">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Estadio / Condici√≥n</label>
                                        <div class="flex gap-2">
                                            <select id="new-venue" class="w-1/3 px-2 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500 bg-white" onchange="updateStadiumField()">
                                                <option value="local">üè† Local</option>
                                                <option value="visitante">‚úàÔ∏è Visitante</option>
                                                <option value="neutral">‚öñÔ∏è Neutral</option>
                                            </select>
                                            <input type="text" id="new-stadium" class="w-2/3 px-3 py-2 border rounded-lg bg-gray-100" value="Santiago Bernab√©u" readonly>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Resultado (Goles) *</label>
                                        <input type="text" id="new-result" required oninput="updateOvertimeOptions()" placeholder="Ej: 2-1" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500 font-bold text-lg text-center tracking-widest" pattern="^\d+-\d+$">
                                        <p class="text-xs text-gray-500 mt-1 text-center">Formato: local-visitante (ej: 3-1)</p>
                                    </div>
                                </div>
                                
                                <div id="overtime-controls" class="hidden mt-4 p-4 bg-orange-50 border border-orange-200 rounded-lg">
                                    <h4 class="font-bold text-orange-800 mb-2 text-sm">Desenlace Eliminatoria</h4>
                                    
                                    <div id="extra-time-option" class="mb-2 hidden">
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" id="chk-extra-time" class="w-4 h-4 text-orange-600">
                                            <span class="text-sm font-medium text-gray-700">Pr√≥rroga jugada</span>
                                        </label>
                                    </div>
                                    
                                    <div id="penalties-option" class="hidden">
                                        <label class="flex items-center gap-2 cursor-pointer mb-2">
                                            <input type="checkbox" id="chk-penalties" class="w-4 h-4 text-orange-600" onchange="togglePenaltyWinner()">
                                            <span class="text-sm font-medium text-gray-700">Tanda de Penaltis</span>
                                        </label>
                                        <div id="penalty-winner-select" class="hidden ml-6">
                                            <p class="text-xs text-gray-500 mb-1">Resultado de la tanda:</p>
                                            <div class="flex gap-4">
                                                <label class="flex items-center gap-1 cursor-pointer">
                                                    <input type="radio" name="penalties-outcome" value="win" class="text-green-600">
                                                    <span class="text-sm text-green-700 font-bold">Victoria</span>
                                                </label>
                                                <label class="flex items-center gap-1 cursor-pointer">
                                                    <input type="radio" name="penalties-outcome" value="loss" class="text-red-600">
                                                    <span class="text-sm text-red-700 font-bold">Derrota</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div id="leg-indicator" class="hidden p-4 global-result rounded-lg mb-4 mt-4">
                                    <p id="leg-info" class="text-sm text-blue-800"></p>
                                </div>

                                <div id="venue-alternation-warning" class="hidden p-4 bg-amber-50 border border-amber-200 rounded-lg mb-4">
                                    <p id="venue-alternation-info" class="text-sm text-amber-800"></p>
                                </div>
                                
                                <div class="flex justify-end pt-4 border-t">
                                    <button type="button" onclick="goToStep2()" class="px-6 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-700 font-medium shadow-lg transform active:scale-95 transition-all">
                                        Siguiente: Jugadores ‚û°Ô∏è
                                    </button>
                                </div>
                            </div>

                            <!-- STEP 2: JUGADORES -->
                            <div id="wizard-step-2" class="hidden h-full">
                                <div class="flex flex-col sm:flex-row justify-between items-center mb-2 pb-2 border-b gap-3">
                                    <h3 class="text-lg font-bold text-gray-800">Paso 2: Alineaci√≥n</h3>
                                    
                                    <div class="flex items-center gap-3">
                                        <div class="bg-gray-100 p-1 rounded-lg flex text-sm">
                                            <button type="button" id="btn-mode-list" class="px-3 py-1 text-gray-500 hover:text-gray-700 transition-all" onclick="switchLineupMode('list')">Lista</button>
                                            <button type="button" id="btn-mode-pitch" class="px-3 py-1 bg-white shadow rounded text-gray-800 font-medium transition-all" onclick="switchLineupMode('pitch')">Pizarra</button>
                                        </div>
                                        <button type="button" onclick="goToStep1()" class="text-sm text-blue-600 hover:underline">‚¨ÖÔ∏è Volver</button>
                                    </div>
                                </div>
                                <div class="flex justify-center gap-3 mb-3 mt-1 animate-in fade-in slide-in-from-top-2 no-capture">
    
                                <button type="button" onclick="loadLastLineup()" class="flex items-center gap-1 text-xs font-bold bg-white text-slate-700 px-3 py-1.5 rounded-full border border-slate-200 hover:bg-slate-50 hover:border-slate-300 transition shadow-sm">
                                ‚Ü∫ Repetir √öltimo Once
                                </button>

                                <button type="button" onclick="loadBestXILineup()" class="flex items-center gap-1 text-xs font-bold bg-amber-50 text-amber-700 px-3 py-1.5 rounded-full border border-amber-200 hover:bg-amber-100 hover:border-amber-300 transition shadow-sm">
                                ‚≠ê Cargar Once de Gala
                                </button>

                                <button type="button" onclick="exportLineupToImage()" class="flex items-center gap-1 text-xs font-bold bg-blue-50 text-blue-700 px-3 py-1.5 rounded-full border border-blue-200 hover:bg-blue-100 hover:border-blue-300 transition shadow-sm">
                                üì∏ Foto
                                </button>

                                </div>

                                <div id="mode-list-container" class="hidden">
                                    <div class="mb-2 text-sm text-amber-700 bg-amber-50 p-2 rounded">‚ö†Ô∏è Selecciona "Titular" o "Suplente".</div>
                                    <div id="new-match-players-stats" class="space-y-3 h-[60vh] overflow-y-auto border border-gray-200 rounded-xl p-4 bg-gray-50"></div>
                                </div>

                                <div id="mode-pitch-container" class="flex flex-col h-full">

    <div class="mb-3 flex flex-col md:flex-row items-center justify-between gap-3 bg-white p-2 rounded-xl border border-gray-200 shadow-sm mx-1">
        
        <div class="flex items-center gap-2">
            <label class="text-xs font-bold text-gray-500 uppercase tracking-wider">Esquema</label>
            <select id="formation-select" class="border-gray-300 rounded text-sm font-bold text-slate-700 focus:ring-indigo-500 focus:border-indigo-500 py-1 cursor-pointer bg-gray-50" onchange="updatePitchFormation()">
                 <option value="4-3-3">4-3-3</option>
                 <option value="4-4-2">4-4-2</option>
                 <option value="4-2-3-1" selected>4-2-3-1</option> 
                 <option value="3-5-2">3-5-2</option>
            </select>
        </div>
    
    <div class="flex items-center gap-3 text-sm">
    
    <div class="flex flex-col items-end leading-tight">
        <span class="text-[10px] text-gray-400 font-bold uppercase">Once Inicial</span>
        <span id="value-starters" class="font-black text-emerald-600">0 M‚Ç¨</span>
    </div>

    <div class="w-px h-6 bg-gray-200"></div> <div class="flex flex-col items-end leading-tight">
        <span class="text-[10px] text-gray-400 font-bold uppercase">Convocatoria</span>
        <span id="value-total" class="font-black text-slate-700">0 M‚Ç¨</span>
    </div>

    <div class="w-px h-6 bg-gray-200"></div> <div class="flex flex-col items-end leading-tight">
        <span class="text-[10px] text-gray-400 font-bold uppercase">Edad Media (XI)</span>
        <span id="value-age" class="font-black text-blue-600">0.0 a√±os</span>
    </div>

    </div>
    
    </div>

    <div id="tactical-board-container" class="flex flex-col md:flex-row gap-4 h-[550px]">

        <div class="flex-1 relative bg-gray-800 rounded-xl border-4 border-gray-800 overflow-hidden shadow-xl">
            <div class="pitch-container w-full h-full" id="tactical-pitch" style="margin: 0; border: none; border-radius: 0;">
                <div class="pitch-line-mid"></div>
                <div class="pitch-circle"></div>
                <div class="pitch-box-left" style="left:0; border-left:none;"></div>
                <div class="pitch-box-right" style="right:0; border-right:none;"></div>
                
                <div id="pitch-slots-layer"></div>
                <div id="pitch-players-layer"></div>
            </div>
        </div>

        <div class="w-full md:w-72 flex flex-col gap-2 h-full">
            
            <div class="flex-1 bg-white rounded-xl border border-gray-300 flex flex-col shadow-sm overflow-hidden">
                <div class="bg-gray-100 p-2 border-b border-gray-200">
                    <h5 class="text-xs font-bold text-gray-600 uppercase text-center">Plantilla Disponible</h5>
                </div>
                <div id="bench-zone" class="bench-container flex-1 overflow-y-auto p-2 bg-gray-50 content-start">
                    </div>
            </div>
            
            <div class="h-32 bg-blue-50 rounded-xl border-2 border-dashed border-blue-300 flex flex-col overflow-hidden">
                <div class="bg-blue-100 p-1 border-b border-blue-200">
                    <h5 class="text-[10px] font-bold text-blue-600 uppercase text-center">Suplentes Convocados</h5>
                </div>
                <div id="subs-zone" class="flex-1 p-2 overflow-y-auto flex flex-wrap gap-2 content-start">
                    </div>
            </div>

        </div>
    </div>
    </div>
                                <div class="flex gap-3 pt-4 border-t mt-4">
                                    <button type="button" onclick="goToStep1()" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 font-medium">Atr√°s</button>
                                    <button type="button" onclick="goToStep3()" class="flex-1 px-4 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-700 font-bold text-lg shadow-lg flex items-center justify-center gap-2 transform hover:scale-[1.01] transition-all">
                                        CONFIRMAR ALINEACI√ìN ‚û°Ô∏è
                                    </button>
                                </div>
                            </div>
                            <div id="wizard-step-3" class="hidden">
                                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 pb-2 border-b gap-3">
                                    <h3 class="text-lg font-bold text-gray-800">Paso 3: Rendimiento</h3>
                                    <button type="button" onclick="goToStep2()" class="text-sm text-blue-600 hover:underline">‚¨ÖÔ∏è Volver a Pizarra</button>
                                </div>

                                <div class="mb-2 text-sm text-green-700 bg-green-50 p-2 rounded">‚úÖ Alineaci√≥n confirmada. Introduce las estad√≠sticas del partido.</div>
                                
                                <div id="final-stats-container" class="space-y-3 h-[60vh] overflow-y-auto border border-gray-200 rounded-xl p-4 bg-gray-50"></div>

                                <div class="flex gap-3 pt-4 border-t mt-4">
                                    <button type="button" onclick="resetNewMatchForm()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Cancelar</button>
                                    <button type="submit" class="flex-1 px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 font-medium font-bold text-lg shadow-md hover:shadow-lg transition-all transform hover:-translate-y-0.5">üíæ GUARDAR PARTIDO</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </section>

            <!-- PARTIDOS REGISTRADOS SECTION -->
            <section id="section-partidos" class="hidden fade-in">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Partidos Registrados</h2>
                        <p class="text-gray-500 text-sm">Historial de partidos con estad√≠sticas</p>
                    </div>
                    <button onclick="openAdvancedSearch()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-bold shadow-md flex items-center gap-2 transition-all text-sm">
                        <span>üîé</span> Buscador Avanzado
                    </button>
                </div>

                <!-- Match Filters -->
                <div class="bg-white rounded-xl shadow-sm p-4 mb-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Competici√≥n</label>
                            <select id="filter-competition" onchange="renderMatches()" class="w-full px-3 py-2 border rounded-lg">
                                <option value="">Todas las competiciones</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Condici√≥n</label>
                            <select id="filter-venue" onchange="renderMatches()" class="w-full px-3 py-2 border rounded-lg">
                                <option value="">Todos</option>
                                <option value="local">Local</option>
                                <option value="visitante">Visitante</option>
                                <option value="neutral">Campo Neutral</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Resultado</label>
                            <select id="filter-result" onchange="renderMatches()" class="w-full px-3 py-2 border rounded-lg">
                                <option value="">Todos</option>
                                <option value="victoria">Victorias</option>
                                <option value="empate">Empates</option>
                                <option value="derrota">Derrotas</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-100 p-3 rounded-lg mb-4 flex flex-col md:flex-row gap-3 items-center border border-gray-200">
                                    <div class="flex-1 w-full">
                                        <input type="text" id="filter-rival" placeholder="üîç Buscar rival (ej: Bar√ßa)" 
                                               class="w-full px-3 py-2 rounded border border-gray-300 text-sm focus:ring-2 focus:ring-blue-500"
                                               onkeyup="applyMatchFilters()">
                                    </div>
                                    <div class="w-full md:w-auto">
                                        <select id="filter-competition" class="w-full px-3 py-2 rounded border border-gray-300 text-sm" onchange="applyMatchFilters()">
                                            <option value="all">Todas las Competiciones</option>
                                            <option value="Liga">Liga</option>
                                            <option value="Champions">Champions League</option>
                                            <option value="Copa">Copa del Rey</option>
                                            <option value="Supercopa">Supercopa</option>
                                        </select>
                                    </div>
                                    <div class="w-full md:w-auto">
                                        <select id="filter-result" class="w-full px-3 py-2 rounded border border-gray-300 text-sm" onchange="applyMatchFilters()">
                                            <option value="all">Todos los resultados</option>
                                            <option value="victoria">‚úÖ Victorias</option>
                                            <option value="empate">‚ûñ Empates</option>
                                            <option value="derrota">‚ùå Derrotas</option>
                                        </select>
                                    </div>
                                </div>
                <div id="matches-list" class="space-y-4"></div>
                <div id="no-matches" class="hidden text-center py-12">
                    <div class="text-6xl mb-4">üìÖ</div>
                    <h3 class="text-xl font-medium text-gray-600">No hay partidos registrados</h3>
                    <p class="text-gray-500">Ve a "üìÖ Calendario" y haz clic en un partido pasado para registrarlo</p>
                </div>
            </section>

            <!-- COMPARATOR SECTION -->
            <section id="section-comparador" class="hidden fade-in">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">‚öîÔ∏è Duelo de Estad√≠sticas</h2>
                    <p class="text-gray-500 text-sm">Compara el rendimiento detallado de dos jugadores</p>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
                    
                    <div class="flex flex-col md:flex-row justify-between items-center gap-6 mb-8 bg-gray-50 p-4 rounded-xl border border-gray-100">
                        <div class="w-full md:w-1/3">
                            <label class="block text-xs font-bold text-blue-800 uppercase mb-2 tracking-wider">Jugador 1</label>
                            <select id="radar-p1" onchange="updateComparatorChart()" class="w-full p-3 border-2 border-blue-200 rounded-xl font-bold text-gray-700 focus:border-blue-500 focus:ring-4 focus:ring-blue-100 bg-white transition-all"></select>
                        </div>
                        
                        <div class="flex flex-col items-center justify-center">
                            <span class="text-3xl font-black text-slate-200">VS</span>
                        </div>

                        <div class="w-full md:w-1/3">
                            <label class="block text-xs font-bold text-red-800 uppercase mb-2 tracking-wider">Jugador 2</label>
                            <select id="radar-p2" onchange="updateComparatorChart()" class="w-full p-3 border-2 border-red-200 rounded-xl font-bold text-gray-700 focus:border-red-500 focus:ring-4 focus:ring-red-100 bg-white transition-all"></select>
                        </div>
                    </div>

                    <div class="flex flex-col lg:flex-row gap-8 items-center">
                        
                        <div class="flex-1 w-full relative h-[400px] flex items-center justify-center p-4">
                            <canvas id="chart-radar-vs"></canvas>
                        </div>

                        <div class="w-full lg:w-1/3 bg-slate-50 p-6 rounded-2xl border border-slate-200 shadow-inner">
                            <h4 class="text-xs font-bold text-slate-500 uppercase mb-6 text-center tracking-widest border-b border-slate-200 pb-2">Comparativa Directa</h4>
                            <div id="radar-stats-table" class="space-y-4 text-sm">
                                <p class="text-center text-gray-400 italic">Selecciona dos jugadores para comparar</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

           <!-- STATS SECTION --> 
            <section id="section-stats" class="hidden fade-in">
            <div class="mb-6">
    
    <div class="flex flex-wrap gap-2 mb-4 border-b border-slate-200 pb-2">
        <button onclick="showStatCategory('team')" id="cat-btn-team" class="px-4 py-2 rounded-lg font-bold text-slate-600 hover:bg-slate-100 transition-all text-sm flex items-center gap-2 category-btn active-category">
            üìä EQUIPO
        </button>
        <button onclick="showStatCategory('players')" id="cat-btn-players" class="px-4 py-2 rounded-lg font-bold text-slate-600 hover:bg-slate-100 transition-all text-sm flex items-center gap-2 category-btn">
            üë§ PROTAGONISTAS
        </button>
        <button onclick="showStatCategory('rivals')" id="cat-btn-rivals" class="px-4 py-2 rounded-lg font-bold text-slate-600 hover:bg-slate-100 transition-all text-sm flex items-center gap-2 category-btn">
            ‚öîÔ∏è RIVALES
        </button>
        <button onclick="showStatCategory('history')" id="cat-btn-history" class="px-4 py-2 rounded-lg font-bold text-slate-600 hover:bg-slate-100 transition-all text-sm flex items-center gap-2 category-btn">
            üèõÔ∏è CLUB E HISTORIA
        </button>
    </div>

    <div class="bg-slate-50 p-3 rounded-xl border border-slate-200">
        
        <div id="cat-content-team" class="category-content flex flex-wrap gap-2">
            <button onclick="switchStatsTab('general')" id="btn-stats-general" class="stats-subtab px-3 py-1.5 rounded-md text-sm font-medium bg-white border border-slate-200 shadow-sm hover:text-blue-600 transition-colors active">
                üìà General
            </button>
            <button onclick="switchStatsTab('advanced')" id="btn-stats-advanced" class="stats-subtab px-3 py-1.5 rounded-md text-sm font-medium bg-white border border-slate-200 shadow-sm hover:text-blue-600 transition-colors">
                üß† Avanzado / T√°ctico
            </button>
        </div>

        <div id="cat-content-players" class="category-content hidden flex flex-wrap gap-2">
            <button onclick="switchStatsTab('coaches')" id="btn-stats-coaches" class="stats-subtab px-3 py-1.5 rounded-md text-sm font-medium bg-white border border-slate-200 shadow-sm hover:text-blue-600 transition-colors">
                üëî Entrenadores
            </button>
            <button onclick="switchStatsTab('goalkeepers')" id="btn-stats-goalkeepers" class="stats-subtab px-3 py-1.5 rounded-md text-sm font-medium bg-white border border-slate-200 shadow-sm hover:text-blue-600 transition-colors">
                üß§ Porteros
            </button>
            <button onclick="switchStatsTab('cantera')" id="btn-stats-cantera" class="stats-subtab px-3 py-1.5 rounded-md text-sm font-medium bg-white border border-slate-200 shadow-sm hover:text-blue-600 transition-colors">
                üéì La F√°brica
            </button>
        </div>

        <div id="cat-content-rivals" class="category-content hidden flex flex-wrap gap-2">
            <button onclick="switchStatsTab('h2h')" id="btn-stats-h2h" class="stats-subtab px-3 py-1.5 rounded-md text-sm font-medium bg-white border border-slate-200 shadow-sm hover:text-blue-600 transition-colors">
                üÜö Historial H2H
            </button>
        </div>

        <div id="cat-content-history" class="category-content hidden flex flex-wrap gap-2">
            <button onclick="openTrophyRoom()" class="px-3 py-1.5 rounded-md text-sm font-medium bg-amber-100 text-amber-800 border border-amber-200 shadow-sm hover:bg-amber-200 transition-colors flex items-center gap-1">
                üèÜ Trofeos
            </button>
            <button onclick="switchStatsTab('mvp')" id="btn-stats-mvp" class="stats-subtab px-3 py-1.5 rounded-md text-sm font-medium bg-white border border-slate-200 shadow-sm hover:text-blue-600 transition-colors">
                ‚≠ê Muro de la Fama
            </button>
            <button onclick="switchStatsTab('awards')" id="btn-stats-awards" class="stats-subtab px-3 py-1.5 rounded-md text-sm font-medium bg-white border border-slate-200 shadow-sm hover:text-blue-600 transition-colors">
                üèÖ Gala de Premios
            </button>
            <button onclick="switchStatsTab('records')" id="btn-stats-records" class="stats-subtab px-3 py-1.5 rounded-md text-sm font-medium bg-white border border-slate-200 shadow-sm hover:text-blue-600 transition-colors">
                üìú Libro de R√©cords
            </button>
        </div>

    </div>
    </div>            
                
                <!-- SUB-SECTION: GENERAL -->
                        <div id="stats-general" class="stats-content fade-in bg-white rounded-xl shadow-lg border-t-4 border-indigo-500 p-6">
                        <div class="flex justify-between items-center mb-6 pb-4 border-b">
                         <h3 class="text-lg font-bold text-gray-800">Estad√≠sticas Generales</h3>

                    <div class="flex gap-2">
                  <button onclick="exportStats()" class="bg-white text-gray-600 border border-gray-300 hover:bg-gray-50 font-bold py-2 px-4 rounded-lg shadow-sm flex items-center gap-2 transition-all text-sm">
                            üì• Exportar CSV
                         </button>

                        <button onclick="showTab('comparador')" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 shadow transition transform hover:scale-105">
                              üÜö Comparador VS
                        </button>
                        <button onclick="generateSeasonYearbook()" class="w-full py-3 bg-gradient-to-r from-purple-900 to-indigo-900 text-white rounded-xl font-bold shadow-lg flex items-center justify-center gap-2 hover:scale-[1.02] transition-transform border border-purple-500/30">
                         üìö Generar Anuario PDF
                        </button>
                         </div> </div>

                    <!-- Summary Cards -->
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-4 xl:grid-cols-8 gap-4 mb-8">
                        <div class="bg-gradient-to-br from-slate-700 to-slate-800 rounded-xl p-4 text-white">
                            <p class="text-slate-300 text-sm">Partidos</p>
                            <p id="stat-total-matches" class="text-3xl font-bold">0</p>
                        </div>
                        <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl p-4 text-white">
                            <p class="text-green-100 text-sm">Victorias</p>
                            <p id="stat-wins" class="text-3xl font-bold">0</p>
                        </div>
                        <div class="bg-gradient-to-br from-amber-500 to-amber-600 rounded-xl p-4 text-white">
                            <p class="text-amber-100 text-sm">Empates</p>
                            <p id="stat-draws" class="text-3xl font-bold">0</p>
                        </div>
                        <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-xl p-4 text-white">
                            <p class="text-red-100 text-sm">Derrotas</p>
                            <p id="stat-losses" class="text-3xl font-bold">0</p>
                        </div>
                        <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-xl p-4 text-white">
                            <p class="text-emerald-100 text-sm">Goles Favor</p>
                            <p id="stat-total-goals" class="text-3xl font-bold">0</p>
                        </div>
                        <div class="bg-gradient-to-br from-rose-500 to-rose-600 rounded-xl p-4 text-white">
                            <p class="text-rose-100 text-sm">Goles Contra</p>
                            <p id="stat-total-goals-against" class="text-3xl font-bold">0</p>
                        </div>
                        <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl p-4 text-white">
                            <p class="text-purple-100 text-sm">Asistencias</p>
                            <p id="stat-total-assists" class="text-3xl font-bold">0</p>
                        </div>
                        <div class="bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-xl p-4 text-white">
                            <p class="text-indigo-100 text-sm">Jugadores</p>
                            <p id="stat-total-players" class="text-3xl font-bold">0</p>
                        </div>
                    </div>
                    <div class="mb-8">
                        <h4 class="font-bold text-gray-700 text-xl mb-4 flex items-center gap-2">
                            üåü El Once de Gala <span class="text-xs font-normal text-gray-500 bg-gray-100 px-2 py-1 rounded">Basado en Nota Media</span>
                        </h4>
                        
                        <div class="bg-emerald-600 rounded-xl shadow-lg border-4 border-emerald-700 p-4 relative h-[600px] w-full max-w-3xl mx-auto overflow-hidden">
                            
                            <div class="absolute inset-0 opacity-20 pointer-events-none">
                                <div class="w-full h-full bg-[linear-gradient(to_bottom,transparent_50%,rgba(0,0,0,0.1)_50%),linear-gradient(to_right,rgba(0,0,0,0.05)_50%,transparent_50%)] bg-[length:100%_100px,100px_100%]"></div>
                                <div class="absolute top-0 left-1/2 -translate-x-1/2 w-3/5 h-1/6 border-2 border-white bg-transparent"></div>
                                <div class="absolute top-0 left-1/2 -translate-x-1/2 w-2/5 h-[6%] border-2 border-white bg-transparent"></div>
                                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-32 h-32 border-2 border-white rounded-full"></div>
                                <div class="absolute top-1/2 left-0 w-full h-0.5 bg-white/50"></div>
                                <div class="absolute bottom-0 left-1/2 -translate-x-1/2 w-3/5 h-1/6 border-2 border-white bg-transparent"></div>
                                <div class="absolute bottom-0 left-1/2 -translate-x-1/2 w-2/5 h-[6%] border-2 border-white bg-transparent"></div>
                            </div>

                            <div id="best-xi-container" class="relative w-full h-full z-10">
                                </div>

                        </div>
                    </div>
                   
                    <div class="mb-8 bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <h4 class="font-bold text-gray-700 text-xl mb-2">üìä Cuadrante de Rendimiento</h4>
                        <p class="text-xs text-gray-500 mb-6">Relaci√≥n entre Cantidad de Minutos y Calidad de Juego</p>
                        
                        <div class="w-full h-[400px]">
                            <canvas id="chart-scatter-performance"></canvas>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2 mt-4 text-xs text-center opacity-70">
                            <div class="p-2 bg-yellow-50 text-yellow-700 rounded border border-yellow-100">üíé Juegan poco / Rinden mucho</div>
                            <div class="p-2 bg-green-50 text-green-700 rounded border border-green-100">üåü Estrellas (Juegan mucho / Rinden bien)</div>
                            <div class="p-2 bg-gray-50 text-gray-600 rounded border border-gray-100">üìâ Necesitan mejorar</div>
                            <div class="p-2 bg-red-50 text-red-600 rounded border border-red-100">‚ö†Ô∏è Fatiga (Juegan mucho / Rinden bajo)</div>
                        </div>
                    </div>
                    <div class="bg-white rounded-xl shadow-lg border-t-4 border-blue-500 p-6 mb-8 fade-in">
    <div class="flex justify-between items-center mb-6">
        <h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">
            üè∞ La Fortaleza vs ‚úàÔ∏è El Viajero
        </h3>
        <span class="text-xs font-semibold text-blue-600 bg-blue-50 px-3 py-1 rounded-full border border-blue-100">
            Rendimiento Local vs Visitante
        </span>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="col-span-1 flex flex-col justify-center space-y-4">
            
            <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                <div class="flex justify-between items-center mb-2">
                    <span class="font-bold text-slate-700 flex items-center gap-2">üè† EN CASA</span>
                    <span id="home-points-display" class="text-sm font-bold text-blue-600">0 Puntos</span>
                </div>
                <div class="grid grid-cols-3 text-center gap-2 text-sm">
                    <div class="bg-white p-2 rounded border shadow-sm">
                        <div class="text-xs text-gray-500">Partidos</div>
                        <div id="home-matches" class="font-bold text-lg">0</div>
                    </div>
                    <div class="bg-white p-2 rounded border shadow-sm">
                        <div class="text-xs text-green-600">Victorias</div>
                        <div id="home-wins" class="font-bold text-lg text-green-700">0</div>
                    </div>
                    <div class="bg-white p-2 rounded border shadow-sm">
                        <div class="text-xs text-blue-500">Goles</div>
                        <div id="home-goals" class="font-bold text-lg text-blue-700">0</div>
                    </div>
                </div>
            </div>

            <div class="flex justify-center -my-2 relative z-10">
                <span class="bg-white text-gray-400 font-bold text-xs border rounded-full px-2 py-1 shadow-sm">VS</span>
            </div>

            <div class="bg-slate-50 rounded-lg p-4 border border-slate-200">
                <div class="flex justify-between items-center mb-2">
                    <span class="font-bold text-slate-700 flex items-center gap-2">‚úàÔ∏è FUERA</span>
                    <span id="away-points-display" class="text-sm font-bold text-indigo-600">0 Puntos</span>
                </div>
                <div class="grid grid-cols-3 text-center gap-2 text-sm">
                    <div class="bg-white p-2 rounded border shadow-sm">
                        <div class="text-xs text-gray-500">Partidos</div>
                        <div id="away-matches" class="font-bold text-lg">0</div>
                    </div>
                    <div class="bg-white p-2 rounded border shadow-sm">
                        <div class="text-xs text-green-600">Victorias</div>
                        <div id="away-wins" class="font-bold text-lg text-green-700">0</div>
                    </div>
                    <div class="bg-white p-2 rounded border shadow-sm">
                        <div class="text-xs text-indigo-500">Goles</div>
                        <div id="away-goals" class="font-bold text-lg text-indigo-700">0</div>
                    </div>
                </div>
            </div>

        </div>

        <div class="col-span-1 lg:col-span-2 relative h-64 md:h-auto min-h-[250px] bg-slate-50 rounded-xl border border-slate-100 p-2">
            <canvas id="chart-home-away"></canvas>
        </div>
    </div>
    </div>
<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mt-6">
    <div class="flex justify-between items-center mb-6 border-b border-gray-100 pb-2">
        <h3 class="font-bold text-gray-800 text-lg">
            üß† An√°lisis de Fiabilidad
        </h3>
        
        <div class="flex bg-gray-100 p-1 rounded-lg gap-1">
            <button onclick="switchConsistencyTab('ranking')" id="btn-ranking" 
                    class="px-3 py-1 text-xs font-bold rounded-md bg-white text-blue-600 shadow-sm transition-all">
                üõ°Ô∏è Ranking
            </button>
            <button onclick="switchConsistencyTab('scatter')" id="btn-mapa" 
                    class="px-3 py-1 text-xs font-bold rounded-md text-gray-500 hover:bg-gray-200 transition-all">
                üíé Mapa
            </button>
        </div>
    </div>
    
    <div id="view-ranking" class="block animate-fade-in">
        <div class="relative h-96 w-full">
            <canvas id="guaranteeChart"></canvas>
        </div>
        <div class="mt-4 flex flex-wrap justify-center gap-4 text-[10px] text-gray-500">
            <span class="flex items-center gap-1"><span class="w-2 h-2 rounded bg-emerald-500"></span> Fiable</span>
            <span class="flex items-center gap-1"><span class="w-2 h-2 rounded bg-blue-500"></span> Normal</span>
            <span class="flex items-center gap-1"><span class="w-2 h-2 rounded bg-rose-500"></span> Irregular</span>
        </div>
        <p class="text-center text-[10px] text-gray-400 mt-1">* Top 12 jugadores por minutos.</p>
    </div>

    <div id="view-mapa" class="hidden animate-fade-in"> <div class="relative h-96 w-full">
            <canvas id="qualityScatterChart"></canvas>
        </div>
        <p class="text-center text-[10px] text-gray-400 mt-2">
            * Eje Y: Abajo = M√°s Estable. | Eje X: Derecha = Mejor Nota.
        </p>
    </div>
</div>
<div id="general-subs-heatmap-container"></div>


                    <!-- Stats Filters -->
                    <div class="bg-gray-50 rounded-xl p-4 mb-6 border border-gray-100">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Competici√≥n</label>
                                <select id="stats-filter-competition" onchange="renderStats()" class="w-full px-3 py-2 border rounded-lg bg-white">
                                    <option value="">Todas las competiciones</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Estado del Jugador</label>
                                <select id="stats-filter-status" onchange="renderStats()" class="w-full px-3 py-2 border rounded-lg bg-white">
                                    <option value="">Todos</option>
                                    <option value="Activo">Solo Activos</option>
                                    <option value="Inactivo">Solo Inactivos</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Stats Table -->
                    <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                        <div class="p-4 border-b bg-gray-50">
                            <h3 class="font-semibold text-gray-800">Rendimiento Individual</h3>
                            <p class="text-xs text-gray-500 mt-1">Haz clic en los encabezados para ordenar.</p>
                        </div>
                        <div class="table-container">
                            <table class="w-full">
<thead class="text-xs text-gray-200 uppercase bg-slate-800 border-b border-slate-700 select-none sticky top-0 z-10">
    <tr>
        <th class="px-4 py-3 text-left font-semibold cursor-pointer hover:text-amber-400 transition-colors" onclick="handleSort('name')" id="th-name">
            Jugador
        </th>
        
        <th id="th-matchesPlayed" class="px-4 py-3 text-center font-semibold cursor-pointer hover:text-amber-400 transition-colors" onclick="handleSort('matchesPlayed')" title="Partidos Jugados">PJ</th>
        
        <th id="th-starts" class="px-4 py-3 text-center font-semibold cursor-pointer hover:text-amber-400 transition-colors" onclick="handleSort('starts')" title="Partidos como Titular">TIT</th>

        <th id="th-avgRating" class="px-4 py-3 text-center font-semibold cursor-pointer hover:text-amber-400 transition-colors" onclick="handleSort('avgRating')" title="Nota Media">Nota</th>
        
        <th id="th-goals" class="px-4 py-3 text-center font-semibold cursor-pointer hover:text-amber-400 transition-colors" onclick="handleSort('goals')" title="Goles Totales">Gol</th>
        
        <th id="th-gPer90" class="px-2 py-3 text-center font-semibold cursor-pointer hover:text-amber-400 transition-colors" onclick="handleSort('gPer90')" title="Goles cada 90 min">G/90'</th>
        
        <th id="th-assists" class="px-4 py-3 text-center font-semibold cursor-pointer hover:text-amber-400 transition-colors" onclick="handleSort('assists')" title="Asistencias Totales">Asis</th>
        
        <th id="th-aPer90" class="px-2 py-3 text-center font-semibold cursor-pointer hover:text-amber-400 transition-colors" onclick="handleSort('aPer90')" title="Asistencias cada 90 min">A/90'</th>
        
        <th id="th-ga" class="px-4 py-3 text-center font-semibold cursor-pointer hover:text-amber-400 transition-colors" onclick="handleSort('ga')" title="Goles + Asistencias">G+A</th>
        
        <th id="th-gaPer90" class="px-2 py-3 text-center font-semibold cursor-pointer hover:text-amber-400 transition-colors" onclick="handleSort('gaPer90')" title="Producci√≥n (G+A) cada 90 min">G+A/90'</th>
        
        <th id="th-minutes" class="px-4 py-3 text-center font-semibold cursor-pointer hover:text-amber-400 transition-colors" onclick="handleSort('minutes')" title="Minutos Totales">Min</th>
        
        <th id="th-minPerMatch" class="px-2 py-3 text-center font-semibold cursor-pointer hover:text-amber-400 transition-colors" onclick="handleSort('minPerMatch')" title="Promedio Minutos por Partido">Min/P</th>
        
        <th id="th-mvpCount" class="px-4 py-3 text-center font-semibold cursor-pointer hover:text-amber-400 transition-colors" onclick="handleSort('mvpCount')" title="MVPs Ganados">MVP</th>
        
        <th id="th-wins" class="px-4 py-3 text-center font-semibold cursor-pointer text-emerald-400 hover:text-white" onclick="handleSort('wins')" title="Victorias">V</th>
        <th id="th-draws" class="px-4 py-3 text-center font-semibold cursor-pointer text-amber-400 hover:text-white" onclick="handleSort('draws')" title="Empates">E</th>
        <th id="th-losses" class="px-4 py-3 text-center font-semibold cursor-pointer text-rose-400 hover:text-white" onclick="handleSort('losses')" title="Derrotas">D</th>
        
        <th id="th-yellowCards" class="px-4 py-3 text-center font-semibold cursor-pointer hover:text-amber-400 transition-colors" onclick="handleSort('yellowCards')" title="Amarillas">üü®</th>
        <th id="th-redCards" class="px-4 py-3 text-center font-semibold cursor-pointer hover:text-amber-400 transition-colors" onclick="handleSort('redCards')" title="Rojas">üü•</th>
    </tr>
</thead>
                                <tbody id="stats-table-body"></tbody>
                            </table>
                        </div>
                        <div id="no-stats" class="hidden text-center py-8 text-gray-500">
                            No hay estad√≠sticas disponibles.
                        </div>
                    </div>
                </div>

                <!-- SUB-SECTION: ADVANCED -->
                <div id="stats-advanced" class="stats-content hidden fade-in space-y-8">
    
    

    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <div class="flex flex-col md:flex-row justify-between items-center mb-4">
            <div>
                <h4 class="font-bold text-gray-800 text-lg">‚öîÔ∏è Guerra de L√≠neas</h4>
                <p class="text-xs text-gray-500">Rendimiento por l√≠neas (Defensa vs Medio vs Delantera)</p>
            </div>
            <div class="flex gap-4 text-xs font-medium text-gray-500">
                <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-blue-500"></span><span id="legend-def-val">Defensa</span></div>
                <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-emerald-500"></span><span id="legend-mid-val">Medio</span></div>
                <div class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-rose-500"></span><span id="legend-fwd-val">Delantera</span></div>
            </div>
        </div>
        <div class="w-full h-[350px] relative">
            <canvas id="chart-line-wars"></canvas>
        </div>
    </div>

    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mt-6">
    <h3 class="font-bold text-gray-800 text-lg mb-4 flex items-center gap-2">
        üèÜ Rendimiento por Competici√≥n
    </h3>
    
    <div class="relative h-72 w-full">
        <canvas id="competitionChart"></canvas>
    </div>

    <div class="flex justify-center gap-6 mt-4 text-xs font-medium text-gray-600">
        <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-green-500"></span> Victorias</div>
        <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-gray-400"></span> Empates</div>
        <div class="flex items-center gap-1"><span class="w-3 h-3 rounded-full bg-red-500"></span> Derrotas</div>
    </div>
</div>

    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <h4 class="font-bold text-gray-800 text-lg mb-4 flex items-center gap-2">
            üìä Histograma de Rigurosidad 
            <span class="text-xs font-normal text-gray-500 bg-gray-100 px-2 py-1 rounded">Distribuci√≥n de notas</span>
        </h4>
        <div class="h-[250px] w-full relative">
            <canvas id="chart-rating-histogram"></canvas>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
        <h4 class="font-bold text-gray-800 text-lg mb-4">üèÜ Tier List de la Temporada</h4>
        <div id="tier-list-container" class="space-y-2"></div>
    </div>

<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mt-6 overflow-hidden">
    <div class="flex justify-between items-end mb-4">
        <h3 class="font-bold text-gray-800 text-lg flex items-center gap-2">
            üåä Olas de Forma
            <span class="text-xs font-normal text-gray-500 ml-auto">(Rendimiento por Competici√≥n)</span>
        </h3>
    </div>

    <div id="wavesTabsContainer" class="flex gap-2 mb-4 overflow-x-auto pb-2 border-b border-gray-100">
        </div>
    
    <div class="overflow-x-auto pb-2">
        <div id="formHeatmapContainer" class="min-w-full">
            </div>
    </div>

    <div class="mt-4 flex flex-wrap justify-center gap-3 text-[10px] text-gray-500 font-medium">
        <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-sm bg-emerald-600"></span> 9+</span>
        <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-sm bg-emerald-400"></span> 8-9</span>
        <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-sm bg-blue-400"></span> 7-8</span>
        <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-sm bg-yellow-300"></span> 6-7</span>
        <span class="flex items-center gap-1"><span class="w-3 h-3 rounded-sm bg-rose-400"></span> -6</span>
    </div>
</div>


    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mt-6">
    <div class="flex justify-between items-end mb-4">
        <h3 class="font-bold text-gray-800 text-lg flex items-center gap-2">
            ‚öñÔ∏è Balance Ofensivo
            <span class="text-xs font-normal text-gray-500">(Goles vs Asistencias)</span>
        </h3>
        <div class="flex gap-3 text-[10px] text-gray-500 uppercase font-semibold tracking-wider">
            <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-blue-500"></span> Goleador</span>
            <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-amber-400"></span> Playmaker</span>
            <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-purple-600"></span> Total</span>
        </div>
    </div>
    
    <div class="relative h-80 w-full">
        <canvas id="scatterGoalAssistChart"></canvas>
    </div>
    
    <p class="text-center text-xs text-gray-400 mt-2">
        * El tama√±o del c√≠rculo representa los minutos jugados.
    </p>
</div>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
    
    <div class="bg-white rounded-xl shadow-sm p-4 border border-slate-100 relative">
        <h3 class="text-sm font-bold text-slate-700 mb-4 flex items-center gap-2">
            <span>üç©</span> ADN del Equipo (Goles/Posici√≥n)
        </h3>
        <div class="relative h-64 w-full">
            <canvas id="chart-goals-position"></canvas>
        </div>
    </div>

    <div class="bg-white rounded-xl shadow-sm p-4 border border-slate-100 relative">
        <h3 class="text-sm font-bold text-slate-700 mb-4 flex items-center gap-2">
            <span>‚è±Ô∏è</span> Zona Cesarini (¬øCu√°ndo marcamos?)
        </h3>
        <div class="relative h-64 w-full">
            <canvas id="chart-goals-minutes"></canvas>
        </div>
    </div>
    </div>
    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mt-6">
    <h3 class="font-bold text-gray-800 text-lg mb-4 flex items-center gap-2">
        üé™ Factor X
        <span class="text-xs font-normal text-gray-500 ml-auto">(Puntos rescatados con G+A)</span>
    </h3>
    
    <div class="relative h-80 w-full">
        <canvas id="factorXChart"></canvas>
    </div>
    
    <div class="mt-4 text-center">
        <p class="text-[10px] text-gray-400">
            * Puntos que el equipo habr√≠a perdido si restamos los goles y asistencias de ese jugador.
        </p>
    </div>
</div>
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-8">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                            <div>
                                <h4 class="font-bold text-gray-800 text-lg">üç© El Rosco de la Carga</h4>
                                <p class="text-xs text-gray-500">Distribuci√≥n de minutos jugados (¬øQui√©n est√° "quemado"?)</p>
                            </div>
                        </div>
                        <div class="flex flex-col md:flex-row items-center gap-8">
                            <div class="w-full md:w-1/2 h-[300px] relative">
                                <canvas id="chart-minutes-doughnut"></canvas>
                                <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                                    <span class="text-xs text-gray-400 uppercase font-bold">Total Equipo</span>
                                    <span id="total-season-minutes" class="text-2xl font-black text-slate-700">0'</span>
                                </div>
                            </div>
                            
                            <div class="w-full md:w-1/2 grid grid-cols-2 gap-4">
                                <div class="bg-red-50 p-3 rounded-lg border border-red-100">
                                    <p class="text-xs text-red-500 uppercase font-bold mb-1">üî• El "Quemado"</p>
                                    <p id="min-max-player" class="font-bold text-gray-800 text-sm">-</p>
                                    <p id="min-max-value" class="text-xs text-gray-500">- min</p>
                                </div>
                                <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
                                    <p class="text-xs text-blue-500 uppercase font-bold mb-1">‚ùÑÔ∏è El "Olvidado"</p>
                                    <p id="min-min-player" class="font-bold text-gray-800 text-sm">-</p>
                                    <p id="min-min-value" class="text-xs text-gray-500">- min</p>
                                </div>
                                <div class="col-span-2 bg-gray-50 p-3 rounded-lg text-xs text-gray-500 border border-gray-100">
                                    <p><strong>üí° An√°lisis:</strong> Si un trozo ocupa m√°s del 10% del gr√°fico, ese jugador es indispensable. Si no aparece o es una l√≠nea fina, necesita m√°s oportunidades.</p>
                                </div>
                            </div>
                        </div>
                        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mt-6">
<div id="unified-connections-wrapper" class="mt-8">
    </div>
<div id="stats-visual-section" class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-8 mb-12 hidden">

    <div class="lg:col-span-2 flex flex-col gap-6">
        
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 min-h-[300px]">
            <h3 class="font-bold text-gray-700 mb-4 px-2 border-l-4 border-indigo-500">üìà An√°lisis de Temporada</h3>
            <div id="stats-charts-wrapper"></div> 
        </div>

        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100">
            <h3 class="font-bold text-gray-800 text-lg mb-4 flex items-center gap-2">
                ‚ö° Estilo de Victoria
                <span class="text-xs font-normal text-gray-500 ml-auto">(Margen de goles)</span>
            </h3>
            
            <div class="relative h-64 w-full">
                <canvas id="victoryStyleChart"></canvas>
            </div>
        </div>

    </div> <div class="lg:col-span-1 h-full" id="stats-goal-analysis-container">
        </div>

</div>
                    </div>
<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mt-6">
    <h3 class="font-bold text-gray-800 text-lg mb-4 flex items-center gap-2">
        üî• Racha de Contribuciones
        <span class="text-xs font-normal text-gray-500 ml-auto">(Partidos seguidos G+A)</span>
    </h3>
    
    <div class="relative h-80 w-full">
        <canvas id="streakChart"></canvas>
    </div>
    
    <div class="mt-4 flex justify-center gap-6 text-xs text-gray-500">
        <div class="flex items-center gap-1">
            <span class="w-3 h-3 rounded bg-orange-500"></span> Racha Actual
        </div>
        <div class="flex items-center gap-1">
            <span class="w-3 h-3 rounded bg-gray-300"></span> R√©cord Personal
        </div>
    </div>
</div>
<div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mt-6">
    <h3 class="font-bold text-gray-800 text-lg mb-4 flex items-center gap-2">
        üéØ Dependencia del Gol
        <span class="text-xs font-normal text-gray-500 ml-auto">(% sobre el total)</span>
    </h3>
    
    <div class="relative h-64 w-full">
        <canvas id="dependencyChart"></canvas>
        
        <div id="dependencyAlert" class="absolute inset-0 flex items-center justify-center pointer-events-none flex-col">
            </div>
    </div>

    <div id="dependencyLegend" class="flex flex-wrap justify-center gap-3 mt-4 text-xs text-gray-600">
        </div>
</div>
                    <!-- Heatmap by Position -->
                    <div class="mb-8">
                        <h4 class="font-bold text-gray-700 mb-4">Mapa de Rendimiento (Nota Media por Posici√≥n)</h4>
                        <div class="heatmap-pitch" id="heatmap-container">
                             <!-- Populated by JS -->
                        </div>
                    </div>

                    <!-- Monthly Report -->
                    <div class="mb-8">
                        <h4 class="font-bold text-gray-700 mb-4">Reporte Mensual</h4>
                        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                             <table class="w-full text-sm">
                                <thead class="bg-slate-800 text-white">
                                    <tr>
                                        <th class="px-4 py-2 text-left">Mes</th>
                                        <th class="px-4 py-2 text-center">Partidos</th>
                                        <th class="px-4 py-2 text-center">V-E-D</th>
                                        <th class="px-4 py-2 text-center">GF / GC</th>
                                        <th class="px-4 py-2 text-center">Nota Media Equipo</th>
                                    </tr>
                                </thead>
                                <tbody id="monthly-report-body">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="mt-6 mb-8">
    <h3 class="text-lg font-bold text-gray-700 mb-3 border-l-4 border-indigo-500 pl-3">
        üß© Rendimiento por Esquema
    </h3>
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left">
                <thead class="bg-gray-50 text-gray-500 font-bold uppercase text-xs">
                    <tr>
                        <th class="px-4 py-3">Esquema</th>
                        <th class="px-4 py-3 text-center">PJ</th>
                        <th class="px-4 py-3 text-center text-emerald-600">V</th>
                        <th class="px-4 py-3 text-center text-amber-600">E</th>
                        <th class="px-4 py-3 text-center text-red-600">D</th>
                        <th class="px-4 py-3 text-center">Efectividad</th>
                    </tr>
                </thead>
                <tbody id="formation-stats-body" class="divide-y divide-gray-100">
                    </tbody>
            </table>
        </div>
        <div id="formation-no-data" class="hidden p-8 text-center text-gray-400 text-sm">
            No hay datos suficientes para generar estad√≠sticas t√°cticas.
        </div>
    </div>
    </div>
                </div>

                <!-- SUB-SECTION: H2H -->
                <div id="stats-h2h" class="stats-content hidden fade-in bg-white rounded-xl shadow-lg border-t-4 border-indigo-500 p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-6 pb-2 border-b">Historial contra Rival (Head to Head)</h3>
                    <div class="bg-gray-50 rounded-xl p-4 mb-6 border border-gray-100">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Selecciona un rival hist√≥rico</label>
                        <select id="h2h-opponent-select" onchange="renderH2H()" class="w-full px-3 py-2 border rounded-lg bg-white">
                            <option value="">Selecciona rival...</option>
                        </select>
                    </div>
                    <div id="h2h-content" class="hidden space-y-6">
                        <!-- Populated by JS -->
                    </div>
                </div>
                <div id="stats-mvp" class="stats-content hidden fade-in bg-white rounded-xl shadow-lg border-t-4 border-indigo-500 p-6">
                    <div class="bg-gradient-to-r from-amber-500 to-orange-600 rounded-xl shadow-lg p-8 text-white text-center mb-8 relative overflow-hidden">
                        <div class="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
                        <h3 class="text-3xl font-black mb-2 relative z-10">üèÜ EL MURO DE LA FAMA</h3>
                        <p class="text-amber-100 text-lg relative z-10">Los h√©roes de cada jornada</p>
                    </div>

                    <div class="flex justify-end mb-4">
                        <select id="mvp-filter-comp" onchange="renderMVPGallery()" class="px-4 py-2 border border-gray-200 rounded-lg bg-white text-sm shadow-sm focus:ring-2 focus:ring-amber-500 outline-none">
                            <option value="">Todas las competiciones</option>
                            </select>
                    </div>

                    <div id="mvp-gallery-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        </div>
                    
                    <div id="no-mvps-msg" class="hidden text-center py-12 text-gray-500">
                        <div class="text-6xl mb-4">üï∏Ô∏è</div>
                        <p>A√∫n no hay MVPs registrados. Juega partidos y elige al mejor jugador.</p>
                    </div>
                </div>
                <div id="stats-coaches" class="stats-content hidden fade-in bg-white rounded-xl shadow-lg border-t-4 border-indigo-500 p-6"></div>
                <div id="stats-goalkeepers" class="stats-content hidden fade-in bg-white rounded-xl shadow-lg border-t-4 border-indigo-500 p-6"></div>
                <div id="stats-cantera" class="stats-content hidden fade-in bg-white rounded-xl shadow-lg border-t-4 border-indigo-500 p-6"></div>
                <div id="stats-awards" class="stats-content hidden fade-in bg-white rounded-xl shadow-lg border-t-4 border-indigo-500 p-6"></div>
                <div id="stats-records" class="stats-content hidden fade-in bg-white rounded-xl shadow-lg border-t-4 border-indigo-500 p-6"></div>
            </section>
        </main>
    </div>

    <!-- PLAYER DETAILS & STATS MODAL -->

    <div id="player-details-modal" class="modal fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[100] hidden opacity-0 transition-opacity duration-300">
    <div class="bg-white rounded-2xl w-full max-w-5xl max-h-[90vh] overflow-hidden flex flex-col shadow-2xl m-4">
        
        <div id="player-modal-header-container" class="bg-white border-b border-gray-100 z-10 flex-none"></div>

        <div id="player-details-content" class="flex-1 overflow-y-auto bg-slate-50 p-4 md:p-6 relative"></div>
    </div>
    </div>

    <!-- MATCH DETAIL MODAL -->
    <div id="match-detail-modal" class="hidden modal fixed inset-0 bg-black/50 items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b sticky top-0 bg-slate-800 text-white rounded-t-2xl">
                <div class="flex justify-between items-center">
                    <h3 id="match-detail-title" class="text-xl font-bold">Detalles del Partido</h3>
                    <button onclick="closeMatchDetailModal()" class="text-slate-300 hover:text-white cursor-pointer z-50 p-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div id="match-detail-content" class="p-6"></div>
        </div>
    </div>
    <div id="edit-match-modal" class="fixed inset-0 bg-black/80 hidden z-[9999] items-center justify-center backdrop-blur-sm">
    <div id="edit-match-content" class="bg-white rounded-xl w-full max-w-6xl h-[95vh] shadow-2xl overflow-hidden relative flex flex-col">
        </div>
    </div>

    <!-- PLAYER STATUS MODAL -->
   <div id="player-status-modal" class=" hidden modal fixed inset-0 bg-black/50 items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-md">
            <div class="p-6 border-b bg-slate-800 text-white rounded-t-2xl">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold">Cambiar Estado</h3>
                    <button onclick="closePlayerStatusModal()" class="text-slate-300 hover:text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div id="player-status-content" class="p-6"></div>
        </div>
    </div>

    <div id="extra-round-modal" class="hidden modal fixed inset-0 bg-black/50 items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-md">
            <div class="p-6 border-b bg-slate-800 text-white rounded-t-2xl">
                <h3 class="text-xl font-bold">Ronda Adicional</h3>
            </div>
            <div class="p-6">
                <p class="text-gray-700 mb-4">Se ha terminado la fase regular. Seg√∫n tu posici√≥n en la tabla:</p>
                <p class="font-bold text-lg text-slate-800 mb-6">¬øDebe jugarse la ronda extra (Play-offs / Eliminatoria previa)?</p>
                
                <div class="bg-amber-50 border border-amber-200 rounded-lg p-3 mb-6 flex items-start gap-3">
                    <input type="checkbox" id="chk-play-extra" class="w-5 h-5 text-amber-600 mt-0.5">
                    <div>
                        <label for="chk-play-extra" class="font-bold text-amber-800 cursor-pointer">S√≠, jugar ronda extra</label>
                        <p class="text-xs text-amber-700">Marca esto si has quedado entre la posici√≥n 9 y 24 (Masculino) o necesitas jugar ronda previa (Femenino).</p>
                    </div>
                </div>

                <div class="flex gap-3">
                    <button onclick="confirmExtraRound()" class="flex-1 px-4 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-700 font-medium">
                        Confirmar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="player-selector-modal" class="hidden modal fixed inset-0 bg-black/80 items-center justify-center p-4 backdrop-blur-sm" style="z-index: 9999 !important;">
        <div class="bg-white rounded-xl w-full max-w-md shadow-2xl overflow-hidden flex flex-col max-h-[80vh] relative z-[10000]">
            <div class="p-4 border-b bg-slate-900 text-white flex justify-between items-center">
                <h3 class="font-bold">Seleccionar Jugador</h3>
                <button onclick="closePlayerSelector()" class="text-gray-400 hover:text-white text-xl font-bold">‚úï</button>
            </div>
            
            <div class="p-3 bg-gray-50 border-b">
                <input type="text" id="player-selector-search" 
                       onkeyup="filterSelectorList()" 
                       onkeydown="handleSelectorKey(event)"
                       placeholder="üîç Buscar jugador (ej: Roc√≠o, Vini...)" 
                       class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-gray-800">
            </div>

            <div id="player-selector-list" class="overflow-y-auto p-2 space-y-1 flex-1 bg-white">
                </div>
            
            <div class="p-3 border-t bg-gray-50 text-center">
                <button onclick="selectPlayerForSlot(null)" class="text-red-500 text-sm font-bold hover:underline py-2 w-full border border-red-100 rounded hover:bg-red-50">
                    üóëÔ∏è Dejar posici√≥n vac√≠a
                </button>
            </div>
        </div>
    </div>

    <div id="trophy-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm hidden">
        <div class="bg-white w-full max-w-5xl h-[90vh] rounded-xl shadow-2xl overflow-hidden flex flex-col m-4">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gradient-to-r from-amber-50 to-white">
                <div class="flex items-center gap-3">
                    <span class="text-3xl">üèÜ</span>
                    <div>
                        <h2 class="text-xl font-bold text-gray-800">Sala de Trofeos</h2>
                        <p class="text-xs text-gray-500 font-medium">Logros desbloqueados: <span id="trophy-count" class="text-amber-600 font-bold">0/0</span></p>
                    </div>
                </div>
                <button onclick="closeTrophyRoom()" class="text-gray-400 hover:text-gray-600 p-2 hover:bg-gray-100 rounded-full transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto bg-slate-50 p-4">
                <div id="trophy-container" class="trophy-grid"></div>
            </div>
        </div>
    </div>

        <div id="minute-modal" class="modal fixed inset-0 z-[99999] hidden flex items-center justify-center" style="z-index: 99999 !important;">
    <div class="absolute inset-0 bg-black bg-opacity-60 transition-opacity backdrop-blur-sm" onclick="closeMinuteModal()"></div>
    
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm m-4 relative z-[100000] overflow-hidden border border-gray-200 h-auto">
        <div class="bg-slate-800 px-4 py-3 border-b border-slate-700 flex justify-between items-center">
            <h3 class="font-bold text-white flex items-center gap-2">
                <span>‚è±Ô∏è</span> 
                <span id="minute-modal-title">Registrar Minutos</span>
            </h3>
            <button onclick="closeMinuteModal()" class="text-gray-400 hover:text-white font-bold text-xl">&times;</button>
        </div>
        <div class="p-5">
            <p class="text-xs text-gray-500 mb-4 font-medium">
                Introduce los minutos separados por comas.
            </p>
            <input type="text" id="minute-input-field" 
                   class="w-full border-2 border-gray-200 rounded-lg px-3 py-3 text-xl font-mono text-center font-bold text-slate-700 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-50 outline-none transition-all placeholder-gray-300" 
                   placeholder="Ej: 15, 67" autocomplete="off">
            <div class="flex gap-2 mt-4 justify-center">
                <button onclick="addMinuteToInput('45')" class="px-3 py-1.5 bg-gray-100 rounded hover:bg-gray-200 text-xs font-bold text-gray-600">45'</button>
                <button onclick="addMinuteToInput('90')" class="px-3 py-1.5 bg-gray-100 rounded hover:bg-gray-200 text-xs font-bold text-gray-600">90'</button>
                <button onclick="addMinuteToInput('120')" class="px-3 py-1.5 bg-gray-100 rounded hover:bg-gray-200 text-xs font-bold text-gray-600">120'</button>
                <button onclick="addMinuteToInput('+')" class="px-3 py-1.5 bg-indigo-50 text-indigo-600 rounded hover:bg-indigo-100 text-xs font-bold">+</button>
            </div>
        </div>
        <div class="bg-gray-50 px-4 py-3 border-t border-gray-100 flex justify-end gap-2">
            <button onclick="closeMinuteModal()" class="px-4 py-2 text-sm text-gray-600 font-bold hover:bg-gray-200 rounded">Cancelar</button>
            <button onclick="saveMinutesFromModal()" class="px-4 py-2 text-sm bg-indigo-600 text-white rounded font-bold hover:bg-indigo-700 shadow-lg transform active:scale-95 transition-all">‚úÖ Guardar</button>
        </div>
    </div>
    </div>

    <!-- ADVANCED SEARCH MODAL -->
    <div id="advanced-search-modal" class="modal fixed inset-0 bg-black/80 items-center justify-center z-50 p-4 hidden" style="z-index: 10000;">
        <div class="bg-white rounded-2xl w-full max-w-2xl shadow-2xl overflow-hidden transform transition-all">
            <div class="p-5 border-b bg-slate-900 text-white flex justify-between items-center">
                <h3 class="text-xl font-bold flex items-center gap-2">üîé Buscador Avanzado (Data Mining)</h3>
                <button onclick="closeAdvancedSearch()" class="text-slate-400 hover:text-white font-bold text-xl">‚úï</button>
            </div>
            <div class="p-6 bg-gray-50 space-y-4 max-h-[70vh] overflow-y-auto">
                
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Competici√≥n</label>
                        <select id="adv-search-comp" class="w-full p-2 border rounded-lg text-sm bg-white focus:ring-2 focus:ring-indigo-500 outline-none">
                            <option value="">Todas</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Rival (contiene)</label>
                        <input type="text" id="adv-search-rival" class="w-full p-2 border rounded-lg text-sm focus:ring-2 focus:ring-indigo-500 outline-none" placeholder="Ej: Bar√ßa">
                    </div>
                </div>

                <div class="bg-white p-4 rounded-xl border border-gray-200 shadow-sm">
                    <h4 class="text-sm font-bold text-indigo-600 mb-3 border-b pb-2 flex items-center gap-2">üë§ Filtros de Jugador</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Jugador</label>
                            <select id="adv-search-player" class="w-full p-2 border rounded-lg text-sm bg-gray-50 focus:ring-2 focus:ring-indigo-500 outline-none">
                                <option value="">Cualquiera</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Condici√≥n</label>
                            <select id="adv-search-condition" class="w-full p-2 border rounded-lg text-sm bg-gray-50 focus:ring-2 focus:ring-indigo-500 outline-none">
                                <option value="played">Jug√≥ el partido</option>
                                <option value="starter">Fue Titular</option>
                                <option value="sub">Sali√≥ del Banquillo</option>
                                <option value="goal">Marc√≥ Gol</option>
                                <option value="assist">Dio Asistencia</option>
                                <option value="mvp">Fue MVP</option>
                                <option value="yellow">Tarjeta Amarilla</option>
                                <option value="red">Tarjeta Roja</option>
                                <option value="rating_8">Nota >= 8.0</option>
                                <option value="rating_9">Nota >= 9.0</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Resultado</label>
                        <select id="adv-search-outcome" class="w-full p-2 border rounded-lg text-sm bg-white"><option value="">Cualquiera</option><option value="victoria">Victoria</option><option value="empate">Empate</option><option value="derrota">Derrota</option></select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Local/Visitante</label>
                        <select id="adv-search-venue" class="w-full p-2 border rounded-lg text-sm bg-white"><option value="">Cualquiera</option><option value="local">Local</option><option value="visitante">Visitante</option></select>
                    </div>
                     <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Porter√≠a a Cero</label>
                        <select id="adv-search-cleansheet" class="w-full p-2 border rounded-lg text-sm bg-white"><option value="">Indiferente</option><option value="yes">S√≠ (0 Goles en contra)</option><option value="no">No (Encajamos gol)</option></select>
                    </div>
                </div>

            </div>
            <div class="p-4 bg-white border-t flex justify-end gap-3">
                <button onclick="closeAdvancedSearch()" class="px-4 py-2 text-gray-500 font-bold hover:bg-gray-100 rounded-lg transition-colors">Cancelar</button>
                <button onclick="executeAdvancedSearch()" class="px-6 py-2 bg-indigo-600 hover:bg-indigo-700 text-white font-bold rounded-lg shadow-lg flex items-center gap-2 transition-transform active:scale-95"><span>üîç</span> Buscar</button>
            </div>
        </div>
    </div>

    <!-- BOT√ìN VOLVER ARRIBA -->
    <button id="back-to-top" onclick="window.scrollTo({top: 0, behavior: 'smooth'})" class="fixed bottom-6 right-6 bg-slate-800 text-white p-3 rounded-full shadow-lg z-40 hidden hover:bg-slate-700 transition-all transform hover:scale-110 border-2 border-white/20">
        ‚¨ÜÔ∏è
    </button>

    <!-- LOGIN MODAL (Moved to end of body) -->
    <div id="login-modal" class="modal fixed inset-0 bg-black/80 items-center justify-center z-[10000] hidden backdrop-blur-sm">
        <div class="bg-white rounded-xl w-full max-w-sm p-6 shadow-2xl m-4">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-xl font-bold text-gray-800">Acceso Administrador</h3>
                <button id="btn-close-login" class="text-gray-400 hover:text-gray-600">‚úï</button>    
            </div>
            <form id="login-form" onsubmit="handleLogin(event)" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>
                    <input type="email" id="login-email" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-1">Contrase√±a</label>
                    <input type="password" id="login-password" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500" required>
                </div>
                <button type="submit" class="w-full py-2 bg-blue-600 text-white rounded-lg font-bold hover:bg-blue-700 transition">Entrar</button>
            </form>
            <div id="login-user-info" class="hidden mt-4 pt-4 border-t text-center">
                <p class="text-sm text-gray-600 mb-2">Sesi√≥n iniciada como: <span id="user-email-display" class="font-bold"></span></p>
                <button onclick="handleLogout()" class="text-sm text-red-600 hover:underline font-medium">Cerrar Sesi√≥n</button>
            </div>
        </div>
    </div>

<script>
const DB_MASCULINO=[
            // CUERPO T√âCNICO
            { id: "dt1", nombre: "Xabi", apellido: "Alonso", apodo: "Xabi Alonso", posicion: "entrenador", rol: "ENT", dorsal: "DT", nacionalidad: "Espa√±a", fechaNacimiento: "1981-11-25", categoria: "Primer Equipo", estado: "Inactivo", altura: "1.83 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20XABI_CARITA_380x501%20%E2%80%93%202?$Desktop$&fit=wrap&wid=288&hei=384" },
            { id: "dt2", nombre: "√Ålvaro", apellido: "Arbeloa", apodo: "Arbeloa", posicion: "entrenador", rol: "ENT", dorsal: "DT", nacionalidad: "Espa√±a", fechaNacimiento: "1983-01-17", categoria: "Primer Equipo", estado: "Activo", altura: "1.84 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/ALVARO_ARBELOA_550x650-1?$Desktop$&fit=wrap&wid=420" },

             { id: "p1", nombre: "Thibaut", apellido: "Courtois", apodo: "Courtois", posicion: "portero", rol: "POR", dorsal: 1, piePreferido:'Izquierdo', nacionalidad: "B√©lgica", fechaNacimiento: "1992-05-11", categoria: "Primer Equipo", estado: "Activo", valorMercado: "18", unidad:"M‚Ç¨", fechaFichaje: "09-08-2018", costeFichaje: "35 M‚Ç¨", finContrato: "30-06-2027", altura: "2.00 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20COURTOIS_EQUIPO_CARITA_380x501?Desktop&fit=wrap&wid=288&hei=384", 
	historialTemporadas: [
		    {'temporada': '2024/25', 'partidos': 47, 'goles': 0, 'asistencias': 0, 'amarillas': 0, 'rojas': 0},
	        {'temporada': '2023/24', 'partidos': 5, 'goles': 0, 'asistencias': 0, 'amarillas': 0, 'rojas': 0},
	        {'temporada': '2022/23', 'partidos': 49, 'goles': 0, 'asistencias': 0, 'amarillas': 1, 'rojas': 0},
        	{'temporada': '2021/22', 'partidos': 52, 'goles': 0, 'asistencias': 0, 'amarillas': 1, 'rojas': 0},
	        {'temporada': '2020/21', 'partidos': 51, 'goles': 0, 'asistencias': 0, 'amarillas': 1, 'rojas': 0},
        	{'temporada': '2019/20', 'partidos': 43, 'goles': 0, 'asistencias': 0, 'amarillas': 2, 'rojas': 0},
	        {'temporada': '2018/19', 'partidos': 35, 'goles': 0, 'asistencias': 0, 'amarillas': 2, 'rojas': 0}
],
                historialValor: [
                                { fecha: '21-12-2018', valor: 65 },
                                { fecha: '11-06-2019', valor: 55 },
                                { fecha: '20-12-2019', valor: 55 },
                                { fecha: '05-03-2020', valor: 60 },
                                { fecha: '08-04-2020', valor: 48 },
                                { fecha: '23-07-2020', valor: 60 },
                                { fecha: '08-10-2020', valor: 75 },
                                { fecha: '05-01-2021', valor: 75 },
                                { fecha: '26-05-2021', valor: 60 },
                                { fecha: '30-12-2021', valor: 65 },
                                { fecha: '03-06-2022', valor: 60 },
                                { fecha: '07-11-2022', valor: 60 },
                                { fecha: '13-06-2023', valor: 45 },
                                { fecha: '22-12-2023', valor: 35 },
                                { fecha: '21-03-2024', valor: 30 },
                                { fecha: '07-06-2024', valor: 28 },
                                { fecha: '11-10-2024', valor: 25 },
                                { fecha: '27-12-2024', valor: 25 },
                                { fecha: '09-06-2025', valor: 20 },
                                { fecha: '12-12-2025', valor: 18 }
              ]  },
            { id: "p13", nombre: "Andriy", apellido: "Lunin", apodo: "Lunin", posicion: "portero", rol: "POR", dorsal: 13, piePreferido:'Derecho', nacionalidad: "Ucrania", fechaNacimiento: "1999-02-11", categoria: "Primer Equipo", estado: "Activo", valorMercado: "15", unidad:"M‚Ç¨", fechaFichaje: "01-07-2018", costeFichaje: "8.5 M‚Ç¨", finContrato: "30-06-2030", altura: "1.91 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20LUNIN_EQUIPO_CARITA_380x501?Desktop&fit=wrap&wid=288&hei=384", 
	historialTemporadas: [
		    {'temporada': '2024/25', 'partidos': 14, 'goles': 0, 'asistencias': 1, 'amarillas': 0, 'rojas': 0},
        	{'temporada': '2023/24', 'partidos': 31, 'goles': 0, 'asistencias': 0, 'amarillas': 2, 'rojas': 0},
	        {'temporada': '2022/23', 'partidos': 12, 'goles': 0, 'asistencias': 0, 'amarillas': 0, 'rojas': 0},
        	{'temporada': '2021/22', 'partidos': 4, 'goles': 0, 'asistencias': 0, 'amarillas': 0, 'rojas': 0},
	        {'temporada': '2020/21', 'partidos': 1, 'goles': 0, 'asistencias': 0, 'amarillas': 1, 'rojas': 0},
],
                historialValor: [
                  { fecha: '12-07-2018', valor: 8.5 },
                  { fecha: '08-10-2020', valor: 3 },
                  { fecha: "05-01-2021", valor: 3 },
                  { fecha: "27-05-2021", valor: 3 },
                  { fecha: '30-12-2021', valor: 2 },
                  { fecha: '03-06-2022', valor: 2.5},
                  { fecha: '07-11-2022', valor: 4 },
                  { fecha: '23-03-2023', valor: 5 },
                  { fecha: "13-06-2023", valor: 5 },
                  { fecha: '22-12-2023', valor: 8 },
                  { fecha: '21-03-2024', valor: 16 },
                  { fecha: '07-06-2024', valor: 25 },
                  { fecha: '27-12-2024', valor: 20 },
                  { fecha: '09-06-2025', valor: 18 },
                  { fecha: '12-12-2025', valor: 15 }
              ]  },
            // DEFENSAS
            { id: "p2", nombre: "Dani", apellido: "Carvajal", apodo: "Carvajal", posicion: "defensa", rol: "LD", dorsal: 2, piePreferido:'Derecho', nacionalidad: "Espa√±a", fechaNacimiento: "1992-01-11", categoria: "Primer Equipo", estado: "Activo", valorMercado: "7", unidad:"M‚Ç¨", fechaFichaje: "01-07-2013", costeFichaje: "6.5 M‚Ç¨", finContrato: "30-06-2026", altura: "1.73 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20CARVAJAL_EQUIPO_CARITA_380x501%20%E2%80%93%206?Desktop&fit=wrap&wid=288&hei=384", historialTemporadas: [],
                            historialValor: [
                  { fecha: '25-07-2013', valor: 10 },
                  { fecha: '23-01-2014', valor: 12 },
                  { fecha: '20-07-2014', valor: 18 },
                  { fecha: '23-01-2015', valor: 22 },
                  { fecha: '01-07-2015', valor: 25 },
                  { fecha: '22-02-2016', valor: 25 },
                  { fecha: '15-07-2016', valor: 25 },
                  { fecha: '24-01-2017', valor: 30 },
                  { fecha: '05-06-2017', valor: 32 },
                  { fecha: '01-01-2018', valor: 45 },
                  { fecha: '22-03-2018', valor: 60 },
                  { fecha: '11-06-2019', valor: 50 },
                  { fecha: '08-04-2020', valor: 40 },
                  { fecha: '10-06-2021', valor: 30 },
                  { fecha: '13-10-2021', valor: 25 },
                  { fecha: '30-12-2021', valor: 20 },
                  { fecha: '21-03-2022', valor: 18 },
                  { fecha: '23-03-2023', valor: 15 },
                  { fecha: '13-06-2023', valor: 12 },
                  { fecha: '27-12-2024', valor: 10 },
                  { fecha: '09-06-2025', valor: 8  },
                  { fecha: '12-12-2025', valor: 7  }

              ]},
            { id: "p3", nombre: "√âder", apellido: "Milit√£o", apodo: "Milit√£o", posicion: "defensa", rol: "DFC", dorsal: 3, piePreferido:'Derecho', nacionalidad: "Brasil", fechaNacimiento: "1998-01-18", categoria: "Primer Equipo", estado: "Activo", valorMercado: "30", unidad:"M‚Ç¨", fechaFichaje: "01-07-2019", costeFichaje: "50 M‚Ç¨", finContrato: "30-06-2028", altura: "1.86 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20MILITAO_EQUIPO_CARITA_380x501%20%E2%80%93%2013?Desktop&fit=wrap&wid=288&hei=384", 
	    historialTemporadas: [
	    {'temporada': '2024/25', 'partidos': 17, 'goles': 1, 'asistencias': 1, 'amarillas': 4, 'rojas': 0},
        {'temporada': '2023/24', 'partidos': 13, 'goles': 0, 'asistencias': 0, 'amarillas': 0, 'rojas': 0},
        {'temporada': '2022/23', 'partidos': 51, 'goles': 7, 'asistencias': 0, 'amarillas': 9, 'rojas': 0},
        {'temporada': '2021/22', 'partidos': 50, 'goles': 2, 'asistencias': 2, 'amarillas': 9, 'rojas': 1},
        {'temporada': '2020/21', 'partidos': 21, 'goles': 2, 'asistencias': 1, 'amarillas': 4, 'rojas': 1},
        {'temporada': '2019/20', 'partidos': 20, 'goles': 0, 'asistencias': 0, 'amarillas': 4, 'rojas': 0}
	],
                                      historialValor: [
                                { fecha: '20-12-2019', valor: 45 },
                                { fecha: '05-03-2020', valor: 40 },
                                { fecha: '08-04-2020', valor: 36 },
                                { fecha: '08-10-2020', valor: 40 },
                                { fecha: '05-01-2021', valor: 30 },
                                { fecha: '10-06-2021', valor: 40 },                               
                                { fecha: '30-12-2021', valor: 60 },
                                { fecha: '03-06-2022', valor: 60 },
                                { fecha: '07-11-2022', valor: 60 },
                                { fecha: '23-03-2023', valor: 70 },
                                { fecha: '13-06-2023', valor: 70 },
                                { fecha: '22-12-2023', valor: 70 },
                                { fecha: '07-06-2024', valor: 60 },
                                { fecha: '27-12-2024', valor: 40 },
                                { fecha: '09-06-2025', valor: 30 },
                                { fecha: '12-12-2025', valor: 30 }          
              ]},
            { id: "p4", nombre: "David", apellido: "Alaba", apodo: "Alaba", posicion: "defensa", rol: "DFC", dorsal: 4, piePreferido:'Izquierdo', nacionalidad: "Austria", fechaNacimiento: "1992-06-24", categoria: "Primer Equipo", estado: "Activo", valorMercado: "4", unidad:"M‚Ç¨", fechaFichaje: "01-07-2021", costeFichaje: "Libre", finContrato: "30-06-2026", altura: "1.80 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20ALABA_EQUIPO_CARITA_380x501%20%E2%80%93%201?Desktop&fit=wrap&wid=288&hei=384", 
	historialTemporadas: [
		    {'temporada': '2024/25', 'partidos': 14, 'goles': 0, 'asistencias': 0, 'amarillas': 2, 'rojas': 0},
	        {'temporada': '2023/24', 'partidos': 17, 'goles': 0, 'asistencias': 2, 'amarillas': 3, 'rojas': 0},
        	{'temporada': '2022/23', 'partidos': 39, 'goles': 2, 'asistencias': 3, 'amarillas': 4, 'rojas': 0},
	        {'temporada': '2021/22', 'partidos': 46, 'goles': 3, 'asistencias': 4, 'amarillas': 4, 'rojas': 0}
],
                          historialValor: [
                                { fecha: '30-12-2021', valor: 55 },
                                { fecha: '03-06-2022', valor: 55 },
                                { fecha: '07-11-2022', valor: 55 },
                                { fecha: '23-03-2023', valor: 50 },
                                { fecha: '13-06-2023', valor: 40 },
                                { fecha: '22-12-2023', valor: 30 },
                                { fecha: '21-03-2024', valor: 25 },
                                { fecha: '07-06-2024', valor: 20 },
                                { fecha: '11-10-2024', valor: 15 },
                                { fecha: '27-12-2024', valor: 10 },
                                { fecha: '09-06-2025', valor:  6 },
                                { fecha: '12-12-2025', valor: 4 }
              ] },
            { id: "p12", nombre: "Trent", apellido: "Alexander-Arnold", apodo: "Alexander-Arnold", posicion: "defensa", rol: "LD", dorsal: 12, piePreferido:'Derecho', nacionalidad: "Inglaterra", fechaNacimiento: "1998-10-07", categoria: "Primer Equipo", estado: "Activo", valorMercado: "70", unidad:"M‚Ç¨", fechaFichaje: "01-07-2025", costeFichaje: "10 M‚Ç¨", finContrato: "30-06-2030", altura: "1.80 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20TRENT_EQUIPO_CARITA_380x501%20v2?Desktop&fit=wrap&wid=288&hei=384", 
	historialTemporadas: [],
                          historialValor: [
                  { fecha: '12-12-2025', valor: 70 }
              ] },
            { id: "p17", nombre: "Lucas", apellido: "V√°zquez", apodo: "Lucas V√°zquez", posicion: "defensa", rol: "LD", dorsal: 17, piePreferido:'Derecho', nacionalidad: "Espa√±a", fechaNacimiento: "1991-07-01", categoria: "Primer Equipo", estado: "Leyenda", valorMercado: "-", unidad:"M‚Ç¨", fechaFichaje: "02-07-2015", costeFichaje: "1 M‚Ç¨", finContrato: "30-06-2026", altura: "1.73 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/LUCAS_VAZQUEZ_EQUIPO_CARITA_550X650+%E2%80%93+1-1", historialTemporadas: [] },
            { id: "p17b", nombre: "Ra√∫l", apellido: "Asencio", apodo: "Asencio", posicion: "defensa", rol: "DFC", dorsal: 17, piePreferido:'Derecho', nacionalidad: "Espa√±a", fechaNacimiento: "2003-03-13", categoria: "Primer Equipo", estado: "Activo", valorMercado: "30", unidad:"M‚Ç¨", fechaFichaje: "01-07-2024", costeFichaje: "Cantera", finContrato: "30-06-2028", altura: "1.84 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20ASENCIO_EQUIPO_CARITA_380x501%20%E2%80%93%203?Desktop&fit=wrap&wid=288&hei=384", 
	historialTemporadas: [
		{'temporada': '2024/25', 'partidos': 42, 'goles': 0, 'asistencias': 2, 'amarillas': 8, 'rojas': 0}
],
            historialValor: [
                { fecha: '24-06-2024', valor: 0.3 },
                { fecha: '27-12-2024', valor: 75 },
                { fecha: '21-03-2025', valor: 30 },
                { fecha: '09-06-2025', valor: 40 },
                { fecha: '02-10-2025', valor: 30 },
                { fecha: '12-12-2025', valor: 30 }

            ] },
            { id: "p18", nombre: "√Ålvaro", apellido: "Carreras", apodo: "Carreras", posicion: "defensa", rol: "LI", dorsal: 18, piePreferido:'Izquierdo', nacionalidad: "Espa√±a", fechaNacimiento: "2003-03-23", categoria: "Primer Equipo", estado: "Activo", valorMercado: "60", unidad:"M‚Ç¨", fechaFichaje: "01-07-2025", costeFichaje: "20 M‚Ç¨", finContrato: "30-06-2030", altura: "1.86 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20CARRERAS_EQUIPO_CARITA_380x501%20%E2%80%93%202?Desktop&fit=wrap&wid=288&hei=384", historialTemporadas: [],
            historialValor: [
                { fecha: '02-10-2025', valor: 50 },
                { fecha: '12-12-2025', valor: 60 }
            ]  },
            { id: "p20", nombre: "Fran", apellido: "Garc√≠a", apodo: "Fran Garc√≠a", posicion: "defensa", rol: "LI", dorsal: 20, piePreferido:'Izquierdo', nacionalidad: "Espa√±a", fechaNacimiento: "1999-08-14", categoria: "Primer Equipo", estado: "Activo", valorMercado: "15", unidad:"M‚Ç¨", fechaFichaje: "09-06-2023", costeFichaje: "5 M‚Ç¨", finContrato: "30-06-2027", altura: "1.69 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20FRAN_GARCIA_EQUIPO_CARITA_380x501%20%E2%80%93%201?Desktop&fit=wrap&wid=288&hei=384", 
	historialTemporadas: [
		    {'temporada': '2024/25', 'partidos': 48, 'goles': 0, 'asistencias': 4, 'amarillas': 0, 'rojas': 0},
        	{'temporada': '2023/24', 'partidos': 31, 'goles': 1, 'asistencias': 6, 'amarillas': 2, 'rojas': 0}
],
            historialValor: [
                { fecha: '13-10-2023', valor: 15 },
                { fecha: '22-12-2023', valor: 15 },
                { fecha: '07-06-2024', valor: 15 },
                { fecha: '27-12-2024', valor: 15 },
                { fecha: '09-06-2025', valor: 18 },
                { fecha: '12-12-2025', valor: 15 }
            ]  },
            { id: "p22", nombre: "Antonio", apellido: "R√ºdiger", apodo: "R√ºdiger", posicion: "defensa", rol: "DFC", dorsal: 22,piePreferido:'Derecho', nacionalidad: "Alemania", fechaNacimiento: "1993-03-03", categoria: "Primer Equipo", estado: "Activo", valorMercado: "12", unidad:"M‚Ç¨", fechaFichaje: "02-06-2022", costeFichaje: "Libre", finContrato: "30-06-2026", altura: "1.90 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20RUDIGUER_EQUIPO_CARITA_380x501%20%E2%80%93%202?Desktop&fit=wrap&wid=288&hei=384", 
	historialTemporadas: [
		    {'temporada': '2024/25', 'partidos': 50, 'goles': 3, 'asistencias': 0, 'amarillas': 7, 'rojas': 1},
	        {'temporada': '2023/24', 'partidos': 48, 'goles': 2, 'asistencias': 2, 'amarillas': 8, 'rojas': 0},
        	{'temporada': '2022/23', 'partidos': 53, 'goles': 2, 'asistencias': 0, 'amarillas': 2, 'rojas': 0}
],
            historialValor: [
                { fecha: '07-11-2022', valor: 40 },
                { fecha: '13-06-2023', valor: 32 },
                { fecha: '22-12-2023', valor: 25 },
                { fecha: '07-06-2024', valor: 25 },
                { fecha: '27-12-2024', valor: 24 },
                { fecha: '09-06-2025', valor: 20 },
                { fecha: '02-10-2025', valor: 15 },
                { fecha: '12-12-2025', valor: 12 }
            ]  },
            { id: "p23", nombre: "Ferland", apellido: "Mendy", apodo: "Mendy", posicion: "defensa", rol: "LI", dorsal: 23,piePreferido:'Izquierdo', nacionalidad: "Francia", fechaNacimiento: "1995-06-08", categoria: "Primer Equipo", estado: "Activo", valorMercado: "8", unidad:"M‚Ç¨", fechaFichaje: "01-07-2019", costeFichaje: "48 M‚Ç¨", finContrato: "30-06-2027", altura: "1.80 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20MENDY_EQUIPO_CARITA_380x501%20%E2%80%93%201", 
	historialTemporadas: [
	    {'temporada': '2024/25', 'partidos': 31, 'goles': 0, 'asistencias': 2, 'amarillas': 2, 'rojas': 1},
        {'temporada': '2023/24', 'partidos': 37, 'goles': 1, 'asistencias': 0, 'amarillas': 6, 'rojas': 0},
        {'temporada': '2022/23', 'partidos': 28, 'goles': 0, 'asistencias': 1, 'amarillas': 4, 'rojas': 0},
        {'temporada': '2021/22', 'partidos': 35, 'goles': 2, 'asistencias': 4, 'amarillas': 7, 'rojas': 0},
        {'temporada': '2020/21', 'partidos': 38, 'goles': 2, 'asistencias': 0, 'amarillas': 5, 'rojas': 0},
        {'temporada': '2019/20', 'partidos': 32, 'goles': 1, 'asistencias': 2, 'amarillas': 8, 'rojas': 1}
],
            historialValor: [
                { fecha: '10-09-2019', valor: 40 },
                { fecha: '20-12-2019', valor: 35 },
                { fecha: '05-03-2020', valor: 40 },
                { fecha: '08-04-2020', valor: 32 },
                { fecha: '23-07-2020', valor: 40 },
                { fecha: '08-10-2020', valor: 40 },
                { fecha: '05-01-2021', valor: 40 },
                { fecha: '19-03-2021', valor: 50 },
                { fecha: '10-06-2021', valor: 50 },
                { fecha: '30-12-2021', valor: 50 },
                { fecha: '03-06-2022', valor: 40 },
                { fecha: '07-11-2022', valor: 40 },
                { fecha: '23-03-2023', valor: 35 },
                { fecha: '13-06-2023', valor: 25 },
                { fecha: '13-10-2023', valor: 20 },
                { fecha: '22-12-2023', valor: 20 },
                { fecha: '07-06-2024', valor: 22 },
                { fecha: '27-12-2024', valor: 18 },
                { fecha: '09-06-2025', valor: 14 },
                { fecha: '02-10-2025', valor: 10 },
                { fecha: '12-12-2025', valor: 8 }
                
            ]  },
            { id: "p24", nombre: "Dean", apellido: "Huijsen", apodo: "Huijsen", posicion: "defensa", rol: "DFC", dorsal: 24,piePreferido:'Derecho', nacionalidad: "Espa√±a", fechaNacimiento: "2005-04-14", categoria: "Primer Equipo", estado: "Activo", valorMercado: "70", unidad:"M‚Ç¨", fechaFichaje: "01-07-2025", costeFichaje: "15 M‚Ç¨", finContrato: "30-06-2030", altura: "1.96 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20HUIJSEN_EQUIPO_CARITA_380x501%20%E2%80%93%201", historialTemporadas: [],
            historialValor: [
                { fecha: '02-10-2025', valor: 70 },
                { fecha: '12-12-2025', valor: 70 }
            ]  },
            { id: "p31", nombre: "Jacobo", apellido: "Ram√≥n", apodo: "Jacobo Ram√≥n", posicion: "defensa", rol: "DFC", dorsal: 31,piePreferido:'Derecho', nacionalidad: "Espa√±a", fechaNacimiento: "2005-01-06", categoria: "Cantera", estado: "Inactivo", valorMercado: "-", unidad:"M‚Ç¨", fechaFichaje: "01-07-2024", costeFichaje: "Cantera", finContrato: "30-06-2028", altura: "1.96 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/JACOBO-RAMON-MONTAJE_JT18489", historialTemporadas: [] },
            { id: "p35", nombre: "David", apellido: "Jim√©nez", apodo: "David Jim√©nez", posicion: "defensa", rol: "LD", dorsal: 35,piePreferido:'Derecho', nacionalidad: "Espa√±a", fechaNacimiento: "2004-03-14", categoria: "Cantera", estado: "Activo", valorMercado: "4", unidad:"K‚Ç¨", fechaFichaje: "01-07-2023", costeFichaje: "Cantera", finContrato: "30-06-2027", altura: "1.70 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/DAVID_JIMENEZ_550x650?$Desktop$&fit=wrap&wid=420", historialTemporadas: [] },
            { id: "p40", nombre: "Victor", apellido: "Valdepe√±as", apodo: "Valdepe√±as", posicion: "defensa", rol: "LI", dorsal: 40,piePreferido:'Izquierdo', nacionalidad: "Espa√±a", fechaNacimiento: "2006-10-20", categoria: "Cantera", estado: "Activo", valorMercado: "5", unidad:"K‚Ç¨", fechaFichaje: "01-07-2024", costeFichaje: "Cantera", finContrato: "30-06-2028", altura: "1.88 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/VICTOR_VALDEPE%C3%91AS_550x650?$Desktop$&fit=wrap&wid=420", historialTemporadas: [] },

            // CENTROCAMPISTAS
            { id: "p5", nombre: "Jude", apellido: "Bellingham", apodo: "Bellingham", posicion: "centrocampista", rol: "MCO", dorsal: 5,piePreferido:'Derecho', nacionalidad: "Inglaterra", fechaNacimiento: "2003-06-29", categoria: "Primer Equipo", estado: "Activo", valorMercado: "160", unidad:"M‚Ç¨", fechaFichaje: "14-06-2023", costeFichaje: "103 M‚Ç¨", finContrato: "30-06-2029", altura: "1.86 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20BELLINGHAM_EQUIPO_CARITA_380x501%20%E2%80%93%201?Desktop&fit=wrap&wid=288&hei=384",
              historialTemporadas: [
                { temporada: "2024/25", partidos: 44, goles: 14, asistencias: 13, amarillas: 11, rojas: 2 },
                { temporada: "2023/24", partidos: 42, goles: 23, asistencias: 13, amarillas: 9, rojas: 1 }
              ],
              historialValor: [
                { fecha: '13-10-2023', valor: 150 },
                { fecha: '22-12-2023', valor: 180 },
                { fecha: '07-06-2024', valor: 180 },
                { fecha: '27-12-2024', valor: 180 },
                { fecha: '09-06-2025', valor: 180 },
                { fecha: '02-10-2025', valor: 180 },
                { fecha: '12-12-2025', valor: 160 }

              ]
            },
            { id: "p6", nombre: "Eduardo", apellido: "Camavinga", apodo: "Camavinga", posicion: "centrocampista", rol: "MC", dorsal: 6,piePreferido:'Izquierdo', nacionalidad: "Francia", fechaNacimiento: "2002-11-10", categoria: "Primer Equipo", estado: "Activo", valorMercado: "50", unidad:"M‚Ç¨", fechaFichaje: "31-08-2021", costeFichaje: "31 M‚Ç¨", finContrato: "30-06-2029", altura: "1.85 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20CAMAVINGA_EQUIPO_CARITA_380x501%20%E2%80%93%201?Desktop&fit=wrap&wid=288&hei=384",
            historialValor: [
                { fecha: '30-12-2021', valor: 55 },
                { fecha: '03-06-2022', valor: 55 },
                { fecha: '07-11-2022', valor: 50 },
                { fecha: '23-03-2023', valor: 60 },
                { fecha: '13-06-2023', valor: 85 },
                { fecha: '13-10-2023', valor: 90 },
                { fecha: '22-12-2023', valor: 90 },
                { fecha: '07-06-2024', valor: 100 },
                { fecha: '27-12-2024', valor: 80 },
                { fecha: '09-06-2025', valor: 60 },
                { fecha: '02-10-2025', valor: 50 },
                { fecha: '12-12-2025', valor: 50 }
                
            ]  },

            { id: "p8", nombre: "Federico", apellido: "Valverde", apodo: "Valverde", posicion: "centrocampista", rol: "MC", dorsal: 8,piePreferido:'Derecho', nacionalidad: "Uruguay", fechaNacimiento: "1998-07-22", categoria: "Primer Equipo", estado: "Activo", valorMercado: "120", unidad:"M‚Ç¨", fechaFichaje: "22-07-2016", costeFichaje: "5 M‚Ç¨", finContrato: "30-06-2029", altura: "1.82 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20VALVERDE_EQUIPO_CARITA_380x501%20%E2%80%93%201?Desktop&fit=wrap&wid=288&hei=384",
            historialTemporadas: [
                { temporada: "2024/25", partidos: 59, goles: 9, asistencias: 8, amarillas: 5, rojas: 0 },
                { temporada: "2023/24", partidos: 54, goles: 3, asistencias: 8, amarillas: 2, rojas: 0 },
                { temporada: "2022/23", partidos: 56, goles: 12, asistencias: 7, amarillas: 6, rojas: 0 },
                { temporada: "2021/22", partidos: 46, goles: 1, asistencias: 2, amarillas: 5, rojas: 0 },
                { temporada: "2020/21", partidos: 33, goles: 3, asistencias: 1, amarillas: 3, rojas: 0 },
                { temporada: "2019/20", partidos: 44, goles: 2, asistencias: 5, amarillas: 4, rojas: 1 },
                { temporada: "2018/19", partidos: 25, goles: 0, asistencias: 0, amarillas: 6, rojas: 0 }
            ],
            historialValor: [
                { fecha: '21-12-2018', valor: 6 },
                { fecha: '11-06-2019', valor: 20 },
                { fecha: '20-12-2019', valor: 50 },
                { fecha: '05-03-2020', valor: 60 },
                { fecha: '08-04-2020', valor: 54 },
                { fecha: '08-10-2020', valor: 70 },
                { fecha: '05-01-2021', valor: 70 },
                { fecha: '10-06-2021', valor: 65 },
                { fecha: '30-12-2021', valor: 65 },
                { fecha: '03-06-2022', valor: 70 },
                { fecha: '23-09-2022', valor: 80 },
                { fecha: '07-11-2022', valor: 100 },
                { fecha: '13-06-2023', valor: 100 },
                { fecha: '22-12-2023', valor: 100 },
                { fecha: '07-06-2024', valor: 120 },
                { fecha: '11-10-2024', valor: 130 },
                { fecha: '27-12-2024', valor: 130 },
                { fecha: '09-06-2025', valor: 130 },
                { fecha: '12-12-2025', valor: 120 }
                
            ]  },
            { id: "p10b", nombre: "Luka", apellido: "Modriƒá", apodo: "Modriƒá", posicion: "centrocampista", rol: "MC", dorsal: 10,piePreferido:'Derecho', nacionalidad: "Croacia", fechaNacimiento: "1985-09-09", categoria: "Primer Equipo", estado: "Leyenda", valorMercado: "-", unidad:"M‚Ç¨", fechaFichaje: "27-08-2012", costeFichaje: "35 M‚Ç¨", finContrato: "30-06-2026", altura: "1.72 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/MODRIC_EQUIPO_CARITA_550X650+%E2%80%93+1", historialTemporadas: [] },
            { id: "p14", nombre: "Aur√©lien", apellido: "Tchouam√©ni", apodo: "Tchouam√©ni", posicion: "centrocampista", rol: "MCD", dorsal: 14,piePreferido:'Derecho', nacionalidad: "Francia", fechaNacimiento: "2000-01-27", categoria: "Primer Equipo", estado: "Activo", valorMercado: "75", unidad:"M‚Ç¨", fechaFichaje: "01-07-2022", costeFichaje: "80 M‚Ç¨", finContrato: "30-06-2028", altura: "1.88 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20TCHOUAMENI_EQUIPO_CARITA_380x501%20%E2%80%93%201?Desktop&fit=wrap&wid=288&hei=384", historialTemporadas: [],
            historialValor: [
                { fecha: '23-09-2022', valor: 80 },
                { fecha: '07-11-2022', valor: 80 },
                { fecha: '23-12-2022', valor: 90 },
                { fecha: '13-06-2023', valor: 85 },
                { fecha: '13-10-2023', valor: 90 },
                { fecha: '22-12-2023', valor: 90 },
                { fecha: '07-06-2024', valor: 100 },
                { fecha: '27-12-2024', valor: 80 },
                { fecha: '09-06-2025', valor: 75 },
                { fecha: '12-12-2025', valor: 75 }
                
            ]  },
            { id: "p15", nombre: "Arda", apellido: "G√ºler", apodo: "Arda G√ºler", posicion: "centrocampista", rol: "MCO", dorsal: 15,piePreferido:'Izquierdo', nacionalidad: "Turqu√≠a", fechaNacimiento: "2005-02-25", categoria: "Primer Equipo", estado: "Activo", valorMercado: "90", unidad:"M‚Ç¨", fechaFichaje: "06-07-2023", costeFichaje: "20 M‚Ç¨", finContrato: "30-06-2029", altura: "1.75 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20ARDA_EQUIPO_CARITA_380x501%20%E2%80%93%202?Desktop&fit=wrap&wid=288&hei=384", historialTemporadas: [],
            historialValor: [
                { fecha: '22-12-2023', valor: 15 },
                { fecha: '07-06-2024', valor: 30 },
                { fecha: '18-07-2024', valor: 45 },
                { fecha: '27-12-2024', valor: 45 },
                { fecha: '09-06-2025', valor: 45 },
                { fecha: '02-10-2025', valor: 60 },
                { fecha: '12-12-2025', valor: 90 }
                
            ]  },
            { id: "p19", nombre: "Dani", apellido: "Ceballos", apodo: "Ceballos", posicion: "centrocampista", rol: "MC", dorsal: 19,piePreferido:'Derecho', nacionalidad: "Espa√±a", fechaNacimiento: "1996-08-07", categoria: "Primer Equipo", estado: "Activo", valorMercado: "8", unidad:"M‚Ç¨", fechaFichaje: "14-07-2017", costeFichaje: "16.5 M‚Ç¨", finContrato: "30-06-2027", altura: "1.79 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20CEBALLOS_EQUIPO_CARITA_380x501%20%E2%80%93%201?Desktop&fit=wrap&wid=288&hei=384", historialTemporadas: [],
            historialValor: [
                { fecha: '13-10-2021', valor: 20 },
                { fecha: '30-12-2021', valor: 18 },
                { fecha: '21-03-2021', valor: 15 },
                { fecha: '03-06-2022', valor: 14 },
                { fecha: '07-11-2022', valor: 9 },
                { fecha: '23-03-2023', valor: 12 },
                { fecha: '13-06-2023', valor: 12 },
                { fecha: '22-12-2023', valor: 9 },
                { fecha: '21-03-2024', valor: 8 },
                { fecha: '07-06-2024', valor: 6 },
                { fecha: '11-10-2024', valor: 4 },
                { fecha: '27-12-2024', valor: 4 },
                { fecha: '21-03-2025', valor: 10 },
                { fecha: '09-06-2025', valor: 10 },
                { fecha: '02-10-2025', valor: 8 },
                { fecha: '12-12-2025', valor: 8 }
            ]  },
            { id: "p28", nombre: "Jorge", apellido: "Cestero", apodo: "Cestero", posicion: "centrocampista", rol: "MC", dorsal: 28,piePreferido:'Derecho', nacionalidad: "Espa√±a", fechaNacimiento: "2006-03-24", categoria: "Cantera", estado: "Activo", valorMercado: "3", unidad:"M‚Ç¨", fechaFichaje: "01-07-2024", costeFichaje: "Cantera", finContrato: "30-06-2028", altura: "1.80 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/JORGE_CESTERO_550x650?$Desktop$&fit=wrap&wid=420" },
            { id: "p37", nombre: "Manuel √Ångel", apellido: "Mor√°n", apodo: "Manuel √Ångel", posicion: "centrocampista", rol: "MC", dorsal: 37,piePreferido:'Derecho', nacionalidad: "Espa√±a", fechaNacimiento: "2004-03-15", categoria: "Cantera", estado: "Activo", valorMercado: "0.5", unidad:"M‚Ç¨", fechaFichaje: "01-07-2023", costeFichaje: "Cantera", finContrato: "30-06-2027", altura: "1.70 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/MANUEL_ANGEL_550x650-1?$Desktop$&fit=wrap&wid=420" },
            { id: "p38", nombre: "C√©sar", apellido: "Palacios", apodo: "Palacios", posicion: "centrocampista", rol: "MC", dorsal: 38,piePreferido:'Derecho', nacionalidad: "Espa√±a", fechaNacimiento: "2004-11-11", categoria: "Cantera", estado: "Activo", valorMercado: "0.5", unidad:"M‚Ç¨", fechaFichaje: "01-07-2023", costeFichaje: "Cantera", finContrato: "30-06-2027", altura: "1.82 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/CESAR_PALACIOS_550x650-1?$Desktop$&fit=wrap&wid=420" },
            { id: "p47", nombre: "Daniel", apellido: "Mesonero", apodo: "Meso", posicion: "centrocampista", rol: "MC", dorsal: 47,piePreferido:'Izquierdo', nacionalidad: "Espa√±a", fechaNacimiento: "2005-03-09", categoria: "Cantera", estado: "Activo", valorMercado: "0.05", unidad:"M‚Ç¨", fechaFichaje: "01-07-2024", costeFichaje: "Cantera", finContrato: "30-06-2028", altura: "1.73 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/DANIEL_MESONERO_550x650?$Desktop$&fit=wrap&wid=420" },

            // DELANTEROS Y EXTREMOS
            { id: "p7", nombre: "Vin√≠cius", apellido: "J√∫nior", apodo: "Vini Jr.", posicion: "extremo", rol: "EI", dorsal: 7,piePreferido:'Derecho', nacionalidad: "Brasil", fechaNacimiento: "2000-07-12", categoria: "Primer Equipo", estado: "Activo", valorMercado: "150", fechaFichaje: "12-07-2018", costeFichaje: "45 M‚Ç¨", finContrato: "30-06-2027", altura: "1.76 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20VINI_EQUIPO_CARITA_380x501%20%E2%80%93%201?Desktop&fit=wrap&wid=288&hei=384",
            historialTemporadas: [
                { temporada: "2024/25", partidos: 52, goles: 21, asistencias: 16, amarillas: 15, rojas: 1 },
                { temporada: "2023/24", partidos: 39, goles: 24, asistencias: 10, amarillas: 11, rojas: 0 },
                { temporada: "2022/23", partidos: 55, goles: 23, asistencias: 19, amarillas: 16, rojas: 1 },
                { temporada: "2021/22", partidos: 52, goles: 22, asistencias: 16, amarillas: 7, rojas: 0 },
                { temporada: "2020/21", partidos: 49, goles: 6, asistencias: 4, amarillas: 4, rojas: 0 },
                { temporada: "2019/20", partidos: 38, goles: 5, asistencias: 3, amarillas: 6, rojas: 0 },
                { temporada: "2018/19", partidos: 31, goles: 4, asistencias: 8, amarillas: 1, rojas: 0 }
            ],
            historialValor: [
                { fecha: '21-12-2018', valor: 35 },
                { fecha: '28-02-2019', valor: 70 },
                { fecha: '11-06-2019', valor: 70 },
                { fecha: '20-12-2019', valor: 50 },
                { fecha: '08-04-2020', valor: 45 },
                { fecha: '05-01-2021', valor: 40 },
                { fecha: '10-06-2021', valor: 40 },
                { fecha: '13-10-2021', valor: 50 },
                { fecha: '30-12-2021', valor: 100 },
                { fecha: '03-06-2022', valor: 100 },
                { fecha: '23-09-2022', valor: 120 },
                { fecha: '07-11-2022', valor: 120 },
                { fecha: '13-06-2023', valor: 150 },
                { fecha: '22-12-2023', valor: 150 },
                { fecha: '07-06-2024', valor: 180 },
                { fecha: '11-10-2024', valor: 200 },
                { fecha: '27-12-2024', valor: 200 },
                { fecha: '09-06-2025', valor: 170 },
                { fecha: '02-10-2025', valor: 150 },
                { fecha: '12-12-2025', valor: 150 }
            ]  },
            { id: "p9", nombre: "Endrick", apellido: "Felipe", apodo: "Endrick", posicion: "delantero", rol: "DC", dorsal: 9,piePreferido:'Izquierdo', nacionalidad: "Brasil", fechaNacimiento: "2006-07-21", categoria: "Primer Equipo", estado: "Inactivo", valorMercado: "25", unidad:"M‚Ç¨", fechaFichaje: "21-07-2024", costeFichaje: "47.5 M‚Ç¨", finContrato: "30-06-2030", altura: "1.73 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20ENDRICK_EQUIPO_CARITA_380x501%20%E2%80%93%208?Desktop&fit=wrap&wid=288&hei=384",
            historialValor: [
                { fecha: '25-07-2024', valor: 25 }
            ]  },
            { id: "p10", nombre: "Kylian", apellido: "Mbapp√©", apodo: "Mbapp√©", posicion: "delantero", rol: "DC", dorsal: 10,piePreferido:'Derecho', nacionalidad: "Francia", fechaNacimiento: "1998-12-20", categoria: "Primer Equipo", estado: "Activo", valorMercado: "200", unidad:"M‚Ç¨", fechaFichaje: "01-07-2024", costeFichaje: "Libre", finContrato: "30-06-2029", altura: "1.80 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20MBAPPE_EQUIPO_CARITA_380x501%20%E2%80%93%201?Desktop&fit=wrap&wid=288&hei=384",
            historialValor: [
                { fecha: '27-12-2024', valor: 160 },
                { fecha: '21-03-2025', valor: 170 },
                { fecha: '09-06-2025', valor: 180 },
                { fecha: '12-12-2025', valor: 200 }
            ]  },
            { id: "p11", nombre: "Rodrygo", apellido: "Goes", apodo: "Rodrygo", posicion: "extremo", rol: "ED", dorsal: 11,piePreferido:'Derecho', nacionalidad: "Brasil", fechaNacimiento: "2001-01-09", categoria: "Primer Equipo", estado: "Activo", valorMercado: "60", unidad:"M‚Ç¨", fechaFichaje: "01-07-2019", costeFichaje: "45 M‚Ç¨", finContrato: "30-06-2028", altura: "1.74 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20RODRYGO_EQUIPO_CARITA_380x501%20%E2%80%93%201?Desktop&fit=wrap&wid=288&hei=384",
            historialValor: [
                { fecha: '01-08-2019', valor: 40 },
                { fecha: '20-12-2019', valor: 50 },
                { fecha: '08-04-2020', valor: 45 },
                { fecha: '08-10-2020', valor: 45 },
                { fecha: '05-01-2021', valor: 45 },
                { fecha: '10-06-2021', valor: 35 },
                { fecha: '30-12-2021', valor: 40 },
                { fecha: '03-06-2022', valor: 60 },
                { fecha: '23-09-2022', valor: 70 },
                { fecha: '07-11-2022', valor: 80 },
                { fecha: '13-06-2023', valor: 100 },
                { fecha: '22-12-2023', valor: 100 },
                { fecha: '07-06-2024', valor: 110 },
                { fecha: '27-12-2024', valor: 100 },
                { fecha: '09-06-2025', valor: 90 },
                { fecha: '02-10-2025', valor: 80 },
                { fecha: '12-12-2025', valor: 60 }
            ]  },
            { id: "p16", nombre: "Gonzalo", apellido: "Garc√≠a", apodo: "Gonzalo", posicion: "delantero", rol: "DC", dorsal: 16,piePreferido:'Derecho', nacionalidad: "Espa√±a", fechaNacimiento: "2004-03-24", categoria: "Primer Equipo", estado: "Activo", valorMercado: "15", unidad:"M‚Ç¨", fechaFichaje: "01-07-2023", costeFichaje: "Cantera", finContrato: "30-06-2028", altura: "1.82 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20GONZALO_EQUIPO_CARITA_380x501%20%E2%80%93%202?Desktop&fit=wrap&wid=288&hei=384", historialTemporadas: [],
            historialValor: [
                { fecha: '25-06-2025', valor: 8 },
                { fecha: '02-10-2025', valor: 15 },
                { fecha: '12-12-2025', valor: 15 }
            ]  },
            { id: "p21", nombre: "Brahim", apellido: "D√≠az", apodo: "Brahim", posicion: "extremo", rol: "ED", dorsal: 21,piePreferido:'Derecho', nacionalidad: "Marruecos", fechaNacimiento: "1999-08-03", categoria: "Primer Equipo", estado: "Activo", valorMercado: "35", unidad:"M‚Ç¨", fechaFichaje: "06-01-2019", costeFichaje: "17 M‚Ç¨", finContrato: "30-06-2027", altura: "1.72 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20BRAHIM_EQUIPO_CARITA_380x501%20%E2%80%93%201?Desktop&fit=wrap&wid=288&hei=384", historialTemporadas: [],
            historialValor: [
                { fecha: '22-12-2023', valor: 20 },
                { fecha: '21-03-2024', valor: 35 },
                { fecha: '07-06-2024', valor: 40 },
                { fecha: '27-12-2024', valor: 35 },
                { fecha: '21-03-2025', valor: 45 },
                { fecha: '09-06-2025', valor: 40 },
                { fecha: '12-12-2025', valor: 35 }
            ]  },
            { id: "p30", nombre: "Franco", apellido: "Mastantuono", apodo: "Mastantuono", posicion: "extremo", rol: "ED", dorsal: 30,piePreferido:'Izquierdo', nacionalidad: "Argentina", fechaNacimiento: "2007-08-14", categoria: "Primer Equipo", estado: "Activo", valorMercado: "50", unidad:"M‚Ç¨", fechaFichaje: "01-07-2025", costeFichaje: "25 M‚Ç¨", finContrato: "30-06-2031", altura: "1.70 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20Mastantuono_EQUIPO_CARITA_380x501%20%E2%80%93%202%20v2?Desktop&fit=wrap&wid=288&hei=384", historialTemporadas: [],
            historialValor: [
                { fecha: '02-10-2025', valor: 50 },
                { fecha: '12-12-2025', valor: 50 }               
            ]  },
            { id: "p44", nombre: "V√≠ctor", apellido: "Mu√±oz", apodo: "V√≠ctor M√∫√±oz", posicion: "extremo", rol: "EI", dorsal: 44,piePreferido:'Derecho', nacionalidad: "Espa√±a", fechaNacimiento: "2003-07-13", categoria: "Cantera", estado: "Inactivo", valorMercado: "-", unidad:"M‚Ç¨", fechaFichaje: "01-07-2023", costeFichaje: "Cantera", finContrato: "30-06-2026", altura: "1.73 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/VICTOR_MU%C3%91OZ", historialTemporadas: [] }

]
const DB_FEMENINO=[
    // CUERPO T√âCNICO
            { id: "dt_fem", nombre: "Pau", apellido: "Quesada", apodo: "Pau Quesada", posicion: "entrenador", rol: "ENT", dorsal: "DT", nacionalidad: "Espa√±a", fechaNacimiento: "1992-10-31", categoria: "Primer Equipo", estado: "Activo", altura: "1.80 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/PAU_QUESADA_CT_AV39125_380x501?$Desktop$&fit=wrap&wid=288&hei=384" },

            // PORTERAS
            { id: "pf1", nombre: "Misa", apellido: "Rodr√≠guez", apodo: "Misa", posicion: "portero", rol: "POR", dorsal: 1,piePreferido:'Izquierdo', nacionalidad: "Espa√±a", fechaNacimiento: "1999-07-22", categoria: "Primer Equipo", estado: "Activo", valorMercado: "150", unidad:"K‚Ç¨", altura: "1.73 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/MISA_AV38131_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf13", nombre: "Merle", apellido: "Frohms", apodo: "Frohms", posicion: "portero", rol: "POR", dorsal: 13,piePreferido:'Izquierdo', nacionalidad: "Alemania", fechaNacimiento: "1995-01-28", categoria: "Primer Equipo", estado: "Activo", valorMercado: "135", unidad:"K‚Ç¨", altura: "1.73 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/FROHMS_SG11686_380x501?Desktop&fit=wrap&wid=288&hei=384" },

            // DEFENSAS
            { id: "pf2", nombre: "Ant√¥nia", apellido: "Silva", apodo: "Ant√¥nia Silva", posicion: "defensa", rol: "LD", dorsal: 2,piePreferido:'Izquierdo', nacionalidad: "Brasil", fechaNacimiento: "1994-04-26", categoria: "Primer Equipo", estado: "Activo", valorMercado: "190", unidad:"K‚Ç¨", altura: "1.74 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/ANTONIA_AV38661_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf4", nombre: "Roc√≠o", apellido: "G√°lvez", apodo: "Roc√≠o", posicion: "defensa", rol: "DFC", dorsal: 4,piePreferido:'Izquierdo', nacionalidad: "Espa√±a", fechaNacimiento: "1997-04-15", categoria: "Primer Equipo", estado: "Activo", valorMercado: "175", unidad:"K‚Ç¨", altura: "1.79 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/ROCIO_SG11273_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf12", nombre: "Yasmim", apellido: "Ribeiro", apodo: "Yasmim", posicion: "defensa", rol: "LI", dorsal: 12,piePreferido:'Izquierdo', nacionalidad: "Brasil", fechaNacimiento: "1996-10-28", categoria: "Primer Equipo", estado: "Activo", valorMercado: "160", unidad:"K‚Ç¨", altura: "1.65 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/YASMIM_AV38779_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf14", nombre: "Mar√≠a", apellido: "M√©ndez", apodo: "Mar√≠a M√©ndez", posicion: "defensa", rol: "DFC", dorsal: 14,piePreferido:'Izquierdo', nacionalidad: "Espa√±a", fechaNacimiento: "2001-04-10", categoria: "Primer Equipo", estado: "Activo", valorMercado: "450", unidad:"K‚Ç¨", altura: "1.74 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/MENDEZ_AV39701_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf15", nombre: "Sheila", apellido: "Garc√≠a", apodo: "Sheila", posicion: "defensa", rol: "LD", dorsal: 15,piePreferido:'Izquierdo', nacionalidad: "Espa√±a", fechaNacimiento: "1997-03-15", categoria: "Primer Equipo", estado: "Activo", valorMercado: "280", unidad:"K‚Ç¨", altura: "1.62 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/SHEI_AV38558_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf21", nombre: "Sara", apellido: "Holmgaard", apodo: "Holmgaard", posicion: "defensa", rol: "LI", dorsal: 21,piePreferido:'Izquierdo', nacionalidad: "Dinamarca", fechaNacimiento: "1999-01-28", categoria: "Primer Equipo", estado: "Activo", valorMercado: "110", unidad:"K‚Ç¨", altura: "1.73 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/HOLMGAARD_SG11429_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf22", nombre: "Bella", apellido: "Andersson", apodo: "Bella Andersson", posicion: "defensa", rol: "DFC", dorsal: 22,piePreferido:'Izquierdo', nacionalidad: "Suecia", fechaNacimiento: "2006-07-12", categoria: "Primer Equipo", estado: "Activo", valorMercado: "125", unidad:"K‚Ç¨", altura: "1.75 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/ANDERSSON_SG11562_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf23", nombre: "Ma√´lle", apellido: "Lakrar", apodo: "Lakrar", posicion: "defensa", rol: "DFC", dorsal: 23,piePreferido:'Izquierdo', nacionalidad: "Francia", fechaNacimiento: "2000-05-27", categoria: "Primer Equipo", estado: "Activo", valorMercado: "380", unidad:"K‚Ç¨", altura: "1.72 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/LAKRAR_SG12372_380x501?$Desktop$&fit=wrap&wid=288&hei=384" },
            { id: "pf27", nombre: "Noem√≠", apellido: "Bejarano", apodo: "Noe", posicion: "defensa", rol: "LD", dorsal: 27,piePreferido:'Izquierdo', nacionalidad: "Espa√±a", fechaNacimiento: "2006-06-27", categoria: "Cantera", estado: "Activo", valorMercado: "40", unidad:"K‚Ç¨", altura: "1.65 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/NOE_BEJARANO_JT11209_550x650?$Desktop$&fit=wrap&wid=420" },
            { id: "pf29", nombre: "Silvia", apellido: "Cristobal", apodo: "Silvi", posicion: "defensa", rol: "DFC", dorsal: 29,piePreferido:'Izquierdo', nacionalidad: "Espa√±a", fechaNacimiento: "2008-05-01", categoria: "Cantera", estado: "Activo", valorMercado: "80", unidad:"K‚Ç¨", altura: "1.70 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/SILVIA_CRISTOBAL_JT11245_550x650?$Desktop$&fit=wrap&wid=288&hei=384" },

            // CENTROCAMPISTAS
            { id: "pf3", nombre: "Teresa", apellido: "Abelleira", apodo: "Tere", posicion: "centrocampista", rol: "MCD", dorsal: 3,piePreferido:'Izquierdo', nacionalidad: "Espa√±a", fechaNacimiento: "2000-01-09", categoria: "Primer Equipo", estado: "Activo", valorMercado: "390", unidad:"K‚Ç¨", altura: "1.60 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/TERESA_AV38432_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf6", nombre: "Sandie", apellido: "Toletti", apodo: "Toletti", posicion: "centrocampista", rol: "MCD", dorsal: 6,piePreferido:'Izquierdo', nacionalidad: "Francia", fechaNacimiento: "1995-07-13", categoria: "Primer Equipo", estado: "Activo", valorMercado: "365", unidad:"K‚Ç¨", altura: "1.68 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/TOLETTI__AV39153_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf8", nombre: "Sara", apellido: "D√§britz", apodo: "D√§britz", posicion: "centrocampista", rol: "MCO", dorsal: 8,piePreferido:'Izquierdo', nacionalidad: "Alemania", fechaNacimiento: "1995-02-15", categoria: "Primer Equipo", estado: "Activo", valorMercado: "400", unidad:"K‚Ç¨", altura: "1.71 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/DABRITZ_AV38874_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf10", nombre: "Caroline", apellido: "Weir", apodo: "Weir", posicion: "centrocampista", rol: "MCO", dorsal: 10,piePreferido:'Izquierdo', nacionalidad: "Escocia", fechaNacimiento: "1995-06-20", categoria: "Primer Equipo", estado: "Activo", valorMercado: "800", unidad:"K‚Ç¨", altura: "1.70 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/WEIR_AV39819_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf16", nombre: "Filippa", apellido: "Angeldahl", apodo: "Angeldahl", posicion: "centrocampista", rol: "MC", dorsal: 16,piePreferido:'Izquierdo', nacionalidad: "Suecia", fechaNacimiento: "1997-07-14", categoria: "Primer Equipo", estado: "Activo", valorMercado: "575", unidad:"K‚Ç¨", altura: "1.70 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/ANGELDAHL_SG11965_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf17", nombre: "Hanna", apellido: "Bennison", apodo: "Hanna Bennison", posicion: "centrocampista", rol: "MC", dorsal: 17,piePreferido:'Izquierdo', nacionalidad: "Suecia", fechaNacimiento: "2002-10-16", categoria: "Primer Equipo", estado: "Activo", valorMercado: "260", unidad:"K‚Ç¨", altura: "1.63 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/BENNISON_AV39265_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf28", nombre: "Irune", apellido: "Dorado", apodo: "Irune", posicion: "centrocampista", rol: "MCD", dorsal: 28,piePreferido:'Izquierdo', nacionalidad: "Espa√±a", fechaNacimiento: "2008-03-22", categoria: "Cantera", estado: "Activo", valorMercado: "70", unidad:"K‚Ç¨", altura: "1.65 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/IRUNE_DORADO_JT11218_550x650?$Desktop$&fit=wrap&wid=288&hei=384" },
            { id: "pf33", nombre: "Adriana", apellido: "Folgado", apodo: "Adri Folgado", posicion: "centrocampista", rol: "MCD", dorsal: 33,piePreferido:'Izquierdo', nacionalidad: "Espa√±a", fechaNacimiento: "2007-04-10", categoria: "Cantera", estado: "Activo", valorMercado: "30", unidad:"K‚Ç¨", altura: "1.68 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/ADRIANA_FOLGADO_JT11189_550x650?$Desktop$&fit=wrap&wid=288&hei=384" },

            // DELANTERAS Y EXTREMOS
            { id: "pf5", nombre: "Paula", apellido: "Comendador", apodo: "Pau Comendador", posicion: "delantero", rol: "ED", dorsal: 5,piePreferido:'Izquierdo', nacionalidad: "Espa√±a", fechaNacimiento: "2007-01-12", categoria: "Primer Equipo", estado: "Activo", valorMercado: "70", unidad:"K‚Ç¨", altura: "1.65 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/PAU_AV38975_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf7", nombre: "Athenea", apellido: "del Castillo", apodo: "Athenea", posicion: "extremo", rol: "ED", dorsal: 7,piePreferido:'Izquierdo', nacionalidad: "Espa√±a", fechaNacimiento: "2000-10-24", categoria: "Primer Equipo", estado: "Activo", valorMercado: "650", unidad:"K‚Ç¨", altura: "1.60 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/ATHENEA_AV38283_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf9", nombre: "Signe", apellido: "Bruun", apodo: "Bruun", posicion: "delantero", rol: "DC", dorsal: 9,piePreferido:'Izquierdo', nacionalidad: "Dinamarca", fechaNacimiento: "1998-04-02", categoria: "Primer Equipo", estado: "Activo", valorMercado: "325", unidad:"K‚Ç¨", altura: "1.78 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/BRUUN_SG12081_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf11", nombre: "Alba", apellido: "Redondo", apodo: "Alba Redondo", posicion: "delantero", rol: "DC", dorsal: 11,piePreferido:'Izquierdo', nacionalidad: "Espa√±a", fechaNacimiento: "1996-08-27", categoria: "Primer Equipo", estado: "Activo", valorMercado: "480", unidad:"K‚Ç¨", altura: "1.69 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/REDONDO_SG11818_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf18", nombre: "Linda", apellido: "Caicedo", apodo: "Linda Caicedo", posicion: "extremo", rol: "EI", dorsal: 18,piePreferido:'Izquierdo', nacionalidad: "Colombia", fechaNacimiento: "2005-02-22", categoria: "Primer Equipo", estado: "Activo", valorMercado: "1", unidad:"M‚Ç¨", altura: "1.61 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/LINDA_AV39478_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf19", nombre: "Eva", apellido: "Navarro", apodo: "Eva Navarro", posicion: "extremo", rol: "ED", dorsal: 19,piePreferido:'Izquierdo', nacionalidad: "Espa√±a", fechaNacimiento: "2001-01-27", categoria: "Primer Equipo", estado: "Activo", valorMercado: "200", unidad:"K‚Ç¨", altura: "1.62 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/EVA_NAVARRO_AV39366_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf20", nombre: "Naomie", apellido: "Feller", apodo: "Feller", posicion: "extremo", rol: "ED", dorsal: 20,piePreferido:'Izquierdo', nacionalidad: "Francia", fechaNacimiento: "2001-11-06", categoria: "Primer Equipo", estado: "Activo", valorMercado: "275", unidad:"K‚Ç¨", altura: "1.70 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/FELLER_AV39583_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf24", nombre: "Lotte", apellido: "Keukelaar", apodo: "Keukelaar", posicion: "extremo", rol: "ED", dorsal: 24,piePreferido:'Izquierdo', nacionalidad: "Pa√≠ses Bajos", fechaNacimiento: "2005-09-25", categoria: "Primer Equipo", estado: "Activo", valorMercado: "175", unidad:"K‚Ç¨", altura: "1.75 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/KEUKELAAR_380x501?$Desktop$&fit=wrap&wid=288&hei=384" },
            { id: "pf38", nombre: "Naiara", apellido: "Sanmart√≠n", apodo: "Naiara", posicion: "extremo", rol: "EI", dorsal: 38,piePreferido:'Izquierdo', nacionalidad: "Espa√±a", fechaNacimiento: "2006-01-23", categoria: "Cantera", estado: "Activo", valorMercado: "40", unidad:"K‚Ç¨", altura: "1.65 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/NAIARA_SAN_MARTIN_JT11237_550x650?$Desktop$&fit=wrap&wid=420" },
            { id: "pf43", nombre: "Iris", apellido: "Ashley", apodo: "Iris Ashley", posicion: "delantero", rol: "DC", dorsal: 43,piePreferido:'Izquierdo', nacionalidad: "Espa√±a", fechaNacimiento: "2007-11-09", categoria: "Cantera", estado: "Activo", valorMercado: "30", unidad:"K‚Ç¨", altura: "1.68 m", foto: "https://assets.realmadrid.com/is/image/realmadrid/IRIS_JT11144_550x650?$Desktop$&fit=wrap&wid=420" }

]
// ==========================================
// 1. VARIABLES GLOBALES Y ESTADO
// ==========================================
// Variables de la App (¬°SOLO UNA VEZ!)
let editingMatchPlayersPool = null; 
let currentTeam = null; 
let COMPETICIONES_ACTUALES = {};

// Variables de Datos
let PLANTILLA_MASCULINO = DB_MASCULINO;
let PLANTILLA_FEMENINO = DB_FEMENINO;
let PLANTILLA_ACTUAL = []; 

// Variables de la Interfaz (Filtros y Calendario)
let calendarEvents = [];
let currentPlayerFilter = 'all';
let currentPositionFilter = '';
let currentCalendarFilter = '';
let currentTimeFilter = 'all';
let hideRegisteredMatches = false;
let selectedCalendarFixture = null;
let calendarViewMode = 'month'; 
let currentCalendarDate = new Date(); 
let currentSortColumn = 'matchesPlayed';
let currentSortOrder = 'desc'; 

// ==========================================
// 2. CONSTANTES GLOBALES
// ==========================================
const CUSTOM_ORDER_MASCULINO = [
    'dt1', 'p1', 'p13', 'p12', 'p2', 'p24', 'p17b', 'p22', 'p3', 'p4', 'p18', 'p20', 'p23', 
    'p14', 'p6', 'p8', 'p19', 'p5', 'p15', 'p7', 'p11', 'p21', 'p10', 'p16', 'p9', 'p30', 
    'p10b', 'p17', 'p44', 'p31','p40','p35','p28'
];

const CUSTOM_ORDER_FEMENINO = [
    'dt_fem', 'pf1', 'pf13', 'pf15', 'pf2', 'pf23', 'pf14', 'pf4','pf22' ,'pf21', 'pf12', 'pf3', 'pf6', 'pf16', 
    'pf17', 'pf10', 'pf8', 'pf18', 'pf7', 'pf19', 'pf5', 'pf20', 'pf9', 'pf11', 'pf24', 'pf28', 'pf29', 
    'pf33', 'pf43', 'pf27','pf38'
];

const FORMATION_ROLES = {
    '4-3-3': ['Portero', 'Lateral Izq', 'Central', 'Central', 'Lateral Der', 'Pivote', 'Interior', 'Interior', 'Extremo Izq', 'Delantero Centro', 'Extremo Der'],
    '4-4-2': ['Portero', 'Lateral Izq', 'Central', 'Central', 'Lateral Der', 'Extremo Izq', 'Medio Centro', 'Medio Centro', 'Extremo Der', 'Delantero', 'Delantero'],
    '4-2-3-1': ['Portero', 'Lateral Izq', 'Central', 'Central', 'Lateral Der', 'Pivote', 'Pivote', 'Extremo Izq', 'Mediapunta','Extremo Der','Delantero'],
    '3-5-2': ['Portero', 'Central', 'Central', 'Central', 'Carrilero Izq', 'Pivote', 'Carrilero Der', 'Interior', 'Interior', 'Delantero', 'Delantero'],
    'default': ['Portero', 'Defensa', 'Defensa', 'Defensa', 'Defensa', 'Centrocampista', 'Centrocampista', 'Centrocampista', 'Delantero', 'Delantero', 'Delantero']
};

const FORMACIONES = {
    '4-4-2': [ { left: 5, top: 50 }, { left: 25, top: 15 }, { left: 25, top: 38 }, { left: 25, top: 62 }, { left: 25, top: 85 }, { left: 50, top: 15 }, { left: 50, top: 38 }, { left: 50, top: 62 }, { left: 50, top: 85 }, { left: 80, top: 35 }, { left: 80, top: 65 } ],
    '4-3-3': [ { left: 5, top: 50 }, { left: 25, top: 10 }, { left: 25, top: 35 }, { left: 25, top: 65 }, { left: 25, top: 90 }, { left: 45, top: 50 }, { left: 60, top: 25 }, { left: 60, top: 75 }, { left: 85, top: 15 }, { left: 85, top: 50 }, { left: 85, top: 85 } ],
    '4-2-3-1': [ { left: 5, top: 50 }, { left: 22, top: 10 }, { left: 22, top: 35 }, { left: 22, top: 65 }, { left: 22, top: 90 }, { left: 42, top: 35 }, { left: 42, top: 65 }, { left: 65, top: 15 }, { left: 65, top: 50 }, { left: 65, top: 85 }, { left: 85, top: 50 } ],
    '3-5-2': [ { left: 5, top: 50 }, { left: 22, top: 30 }, { left: 22, top: 50 }, { left: 22, top: 70 }, { left: 45, top: 10 }, { left: 45, top: 90 }, { left: 45, top: 50 }, { left: 60, top: 35 }, { left: 60, top: 65 }, { left: 80, top: 35 }, { left: 80, top: 65 } ]
};

// --- COMPETICIONES ---
const COMPETICIONES_MASCULINO = {
    'Liga EA Sports': { id: 'liga', nombre: 'Liga EA Sports', color: 'comp-liga', borderColor: 'border-comp-liga', tipo: 'liga', ordenLibre: true, fases: [{ tipo: 'liga', rondas: Array.from({length: 38}, (_, i) => ({ id: `jornada-${i+1}`, nombre: `Jornada ${i+1}`, orden: i+1 })) }] },
    'Mundial de Clubes': { id: 'mundial', nombre: 'Mundial de Clubes', color: 'comp-mundial', borderColor: 'border-comp-mundial', tipo: 'copa', campoNeutral: true, fases: [{ tipo: 'grupos', nombre: 'Fase de Grupos', rondas: [{ id: 'grupos-1', nombre: 'Fase de Grupos - J1', orden: 1 }, { id: 'grupos-2', nombre: 'Fase de Grupos - J2', orden: 2 }, { id: 'grupos-3', nombre: 'Fase de Grupos - J3', orden: 3 }] }, { tipo: 'eliminatoria', nombre: 'Eliminatorias', rondas: [{ id: 'octavos', nombre: 'Octavos', orden: 4, eliminatoria: true, partidoUnico: true }, { id: 'cuartos', nombre: 'Cuartos', orden: 5, eliminatoria: true, partidoUnico: true }, { id: 'semifinal', nombre: 'Semifinal', orden: 6, eliminatoria: true, partidoUnico: true }, { id: 'final', nombre: 'Final', orden: 7, eliminatoria: true, partidoUnico: true }] }] },
    'Champions League': { id: 'champions', nombre: 'Champions League', color: 'comp-champions', borderColor: 'border-comp-champions', tipo: 'copa', fases: [{ tipo: 'liga', nombre: 'Fase de Liga', ordenLibre: true, rondas: Array.from({length: 8}, (_, i) => ({ id: `fase-liga-${i+1}`, nombre: `Fase de Liga - J${i+1}`, orden: i+1 })) }, { tipo: 'eliminatoria', nombre: 'Eliminatorias', rondas: [{ id: 'dieciseisavos-ida', nombre: 'Play-offs - Ida', orden: 8.1, eliminatoria: true, idaVuelta: 'ida', pareja: 'dieciseisavos-vuelta', rondaExtra: true }, { id: 'dieciseisavos-vuelta', nombre: 'Play-offs - Vuelta', orden: 8.2, eliminatoria: true, idaVuelta: 'vuelta', pareja: 'dieciseisavos-ida', rondaExtra: true }, { id: 'octavos-ida', nombre: 'Octavos - Ida', orden: 9, eliminatoria: true, idaVuelta: 'ida', pareja: 'octavos-vuelta' }, { id: 'octavos-vuelta', nombre: 'Octavos - Vuelta', orden: 10, eliminatoria: true, idaVuelta: 'vuelta', pareja: 'octavos-ida' }, { id: 'cuartos-ida', nombre: 'Cuartos - Ida', orden: 11, eliminatoria: true, idaVuelta: 'ida', pareja: 'cuartos-vuelta' }, { id: 'cuartos-vuelta', nombre: 'Cuartos - Vuelta', orden: 12, eliminatoria: true, idaVuelta: 'vuelta', pareja: 'cuartos-ida' }, { id: 'semifinal-ida', nombre: 'Semifinal - Ida', orden: 13, eliminatoria: true, idaVuelta: 'ida', pareja: 'semifinal-vuelta' }, { id: 'semifinal-vuelta', nombre: 'Semifinal - Vuelta', orden: 14, eliminatoria: true, idaVuelta: 'vuelta', pareja: 'semifinal-ida' }, { id: 'final', nombre: 'Final', orden: 15, eliminatoria: true, partidoUnico: true }] }] },
    'Copa del Rey': { id: 'copa', nombre: 'Copa del Rey', color: 'comp-copa', borderColor: 'border-comp-copa', tipo: 'copa', fases: [{ tipo: 'eliminatoria', nombre: 'Eliminatorias', rondas: [{ id: 'dieciseisavos', nombre: 'Dieciseisavos', orden: 1, eliminatoria: true, partidoUnico: true }, { id: 'octavos', nombre: 'Octavos', orden: 2, eliminatoria: true, partidoUnico: true }, { id: 'cuartos', nombre: 'Cuartos', orden: 3, eliminatoria: true, partidoUnico: true }, { id: 'semifinal-ida', nombre: 'Semifinal - Ida', orden: 4, eliminatoria: true, idaVuelta: 'ida', pareja: 'semifinal-vuelta' }, { id: 'semifinal-vuelta', nombre: 'Semifinal - Vuelta', orden: 5, eliminatoria: true, idaVuelta: 'vuelta', pareja: 'semifinal-ida' }, { id: 'final', nombre: 'Final', orden: 6, eliminatoria: true, partidoUnico: true }] }] },
    'Supercopa de Espa√±a': { id: 'supercopa', nombre: 'Supercopa de Espa√±a', color: 'comp-supercopa', borderColor: 'border-comp-supercopa', tipo: 'copa', fases: [{ tipo: 'eliminatoria', nombre: 'Eliminatorias', rondas: [{ id: 'semifinal', nombre: 'Semifinal', orden: 1, eliminatoria: true, partidoUnico: true }, { id: 'final', nombre: 'Final', orden: 2, eliminatoria: true, partidoUnico: true }] }] }
};

const COMPETICIONES_FEMENINO = {
    'Liga F': { id: 'liga-f', nombre: 'Liga F', color: 'comp-liga', borderColor: 'border-comp-liga', tipo: 'liga', ordenLibre: true, fases: [{ tipo: 'liga', rondas: Array.from({length: 30}, (_, i) => ({ id: `jornada-${i+1}`, nombre: `Jornada ${i+1}`, orden: i+1 })) }] },
    'UWCL': { id: 'uwcl', nombre: 'UWCL', color: 'comp-champions', borderColor: 'border-comp-champions', tipo: 'copa', fases: [{ tipo: 'eliminatoria', nombre: 'Fase Previa', rondas: [{ id: 'fase-previa-ida', nombre: 'Previa - Ida', orden: 1, eliminatoria: true, idaVuelta: 'ida', pareja: 'fase-previa-vuelta' }, { id: 'fase-previa-vuelta', nombre: 'Previa - Vuelta', orden: 2, eliminatoria: true, idaVuelta: 'vuelta', pareja: 'fase-previa-ida' }] }, { tipo: 'grupos', nombre: 'Fase de Grupos', rondas: Array.from({length: 6}, (_, i) => ({ id: `grupos-${i+1}`, nombre: `Fase Grupos - J${i+1}`, orden: i+3 })) }, { tipo: 'eliminatoria', nombre: 'Eliminatorias', rondas: [{ id: 'octavos-ida', nombre: 'Octavos - Ida', orden: 9, eliminatoria: true, idaVuelta: 'ida', pareja: 'octavos-vuelta', oculto: true }, { id: 'octavos-vuelta', nombre: 'Octavos - Vuelta', orden: 10, eliminatoria: true, idaVuelta: 'vuelta', pareja: 'octavos-ida', oculto: true }, { id: 'cuartos-ida', nombre: 'Cuartos - Ida', orden: 11, eliminatoria: true, idaVuelta: 'ida', pareja: 'cuartos-vuelta' }, { id: 'cuartos-vuelta', nombre: 'Cuartos - Vuelta', orden: 12, eliminatoria: true, idaVuelta: 'vuelta', pareja: 'cuartos-ida' }, { id: 'semifinal-ida', nombre: 'Semifinal - Ida', orden: 13, eliminatoria: true, idaVuelta: 'ida', pareja: 'semifinal-vuelta' }, { id: 'semifinal-vuelta', nombre: 'Semifinal - Vuelta', orden: 14, eliminatoria: true, idaVuelta: 'vuelta', pareja: 'semifinal-ida' }, { id: 'final', nombre: 'Final', orden: 15, eliminatoria: true, partidoUnico: true }] }] },
    'Copa de la Reina': { id: 'copa-reina', nombre: 'Copa de la Reina', color: 'comp-copa', borderColor: 'border-comp-copa', tipo: 'copa', fases: [{ tipo: 'eliminatoria', nombre: 'Eliminatorias', rondas: [{ id: 'octavos', nombre: 'Octavos', orden: 1, eliminatoria: true, partidoUnico: true }, { id: 'cuartos', nombre: 'Cuartos', orden: 2, eliminatoria: true, partidoUnico: true }, { id: 'semifinal-ida', nombre: 'Semifinal - Ida', orden: 3, eliminatoria: true, idaVuelta: 'ida', pareja: 'semifinal-vuelta' }, { id: 'semifinal-vuelta', nombre: 'Semifinal - Vuelta', orden: 4, eliminatoria: true, idaVuelta: 'vuelta', pareja: 'semifinal-ida' }, { id: 'final', nombre: 'Final', orden: 5, eliminatoria: true, partidoUnico: true }] }] },
    'Supercopa Femenina': { id: 'supercopa-fem', nombre: 'Supercopa Femenina', color: 'comp-supercopa', borderColor: 'border-comp-supercopa', tipo: 'copa', fases: [{ tipo: 'eliminatoria', nombre: 'Eliminatorias', rondas: [{ id: 'semifinal', nombre: 'Semifinal', orden: 1, eliminatoria: true, partidoUnico: true }, { id: 'final', nombre: 'Final', orden: 2, eliminatoria: true, partidoUnico: true }] }] }
};

const TEAMS_CONFIG = {
    masculino: {
        icalUrl: 'https://publish.realmadrid.com/content/sling/app-servlets/realmadrid/ical.3kq9cckrnlogidldtdie2fkbl.es-es.ics',
        plantilla: PLANTILLA_MASCULINO, 
        competiciones: COMPETICIONES_MASCULINO,
        title: 'Real Madrid Masculino',
        manualJuneMatches: true
    },
    femenino: {
        icalUrl: 'https://publish.realmadrid.com/content/sling/app-servlets/realmadrid/ical.vaikl8nl7hdr4y9jj4jyb9ey.es-es.ics',
        plantilla: PLANTILLA_FEMENINO,
        competiciones: COMPETICIONES_FEMENINO,
        title: 'Real Madrid Femenino',
        manualJuneMatches: false
    }
};





// ==========================================
// 4. FUNCIONES PRINCIPALES
// ==========================================

// AQU√ç DEBAJO EMPIEZA TU function selectTeam(team) { ...
        function selectTeam(team){

            currentTeam = team;
            // IMPORTANT: Clear calendar events to avoid mixing teams
            calendarEvents = [];
            
            const config = TEAMS_CONFIG[team];
            PLANTILLA_ACTUAL = config.plantilla;
            COMPETICIONES_ACTUALES = config.competiciones;

            if (team === 'masculino') {
        PLANTILLA_ACTUAL = PLANTILLA_MASCULINO;
    } else {
        PLANTILLA_ACTUAL = PLANTILLA_FEMENINO;
    }

            document.getElementById('header-subtitle').textContent = config.title + (appMode === 'global' ? ' (‚òÅÔ∏è Nube)' : ' (üì± Local)');
            document.getElementById('section-welcome').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');

            currentPlayerFilter = 'all';
            currentPositionFilter = '';
            
            // RESET FILTERS
            currentTimeFilter = 'all';
            currentCalendarFilter = '';
            hideRegisteredMatches = false;
            document.getElementById('hide-registered-matches').checked = false;
            calendarViewMode = 'month'; // Ensure default is month
            currentCalendarDate = new Date();
            
            renderPlayers();
            populateComparatorSelects();
            populateCompetitionSelect();
            populateH2HOpponents();
            showTab('principal');

            // Force load calendar immediately after setup
            loadCalendar();
        }

        function returnToWelcome() {
            document.getElementById('app-container').classList.add('hidden');
            document.getElementById('section-welcome').classList.remove('hidden');
            currentTeam = null;
            PLANTILLA_ACTUAL = [];
            COMPETICIONES_ACTUALES = {};
            calendarEvents = [];
        }

        // ==========================================
        // DATA MANAGEMENT (TEAM SCOPED)
        // ==========================================

        // ‚ö†Ô∏è CONFIGURACI√ìN FIREBASE: Reemplaza esto con tus datos de la consola de Firebase
        const FIREBASE_CONFIG = {
            apiKey: "AIzaSyAPk1iayY5xiDMXpQ5_H0eRKB8ZZ22TEQs",
            authDomain: "real-madrid-web.firebaseapp.com",
            databaseURL: "https://real-madrid-web-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "real-madrid-web",
            storageBucket: "real-madrid-web.firebasestorage.app",
            messagingSenderId: "956440950120",
            appId: "1:956440950120:web:06250e00147814c61352dd"
        };

        let appMode = 'global'; // 'local' | 'global'
        let cloudCache = {};
        let isFirebaseInitialized = false;
        let currentUser = null;

        function initFirebase() {
            if (!isFirebaseInitialized && typeof firebase !== 'undefined') {
                try {
                    // Detectar configuraci√≥n (soporta ambos nombres: FIREBASE_CONFIG o firebaseConfig)
                    let config = null;
                    if (typeof FIREBASE_CONFIG !== 'undefined') config = FIREBASE_CONFIG;
                    else if (typeof firebaseConfig !== 'undefined') config = firebaseConfig;

                    if (!config) {
                        alert("‚ö†Ô∏è Error: No se encuentra la configuraci√≥n. Aseg√∫rate de pegar el c√≥digo de Firebase Console.");
                        return false;
                    }

                    if (config.apiKey === "API_KEY_AQUI" || config.apiKey.includes("API_KEY")) {
                        alert("‚ö†Ô∏è ATENCI√ìN: Para usar el modo Global, debes editar el c√≥digo HTML y poner tu configuraci√≥n de Firebase real.");
                        return false;
                    }

                    firebase.initializeApp(config);
                    isFirebaseInitialized = true;
                    
                    if (firebase.auth) {
                        firebase.auth().onAuthStateChanged((user) => {
                            currentUser = user;
                            updateAuthUI();
                            // Recargar vistas si estamos en modo global para actualizar botones
                            if (appMode === 'global') {
                                if (!document.getElementById('section-partidos').classList.contains('hidden')) renderMatches();
                                if (!document.getElementById('section-plantilla').classList.contains('hidden')) renderPlayers();
                            }
                        });
                    }
                    return true;
                } catch (e) {
                    console.error("Firebase init error:", e);
                    alert("Error conectando con Firebase: " + e.message);
                    return false;
                }
            }
            return isFirebaseInitialized;
        }

/**
 * Muestra/oculta el modal de login. VERSI√ìN CORREGIDA Y DEFINITIVA.
 * Utiliza el sistema de clases .active del CSS de la aplicaci√≥n.
 */
function toggleLoginModal() {
    const modal = document.getElementById('login-modal');
    if (!modal) {
        console.error("ERROR FATAL: No se encuentra el elemento #login-modal en el HTML.");
        return;
    }

    if (!isFirebaseInitialized || typeof firebase.auth !== 'function') {
        console.error(`ERROR DE FIREBASE: isFirebaseInitialized es '${isFirebaseInitialized}' y firebase.auth es de tipo '${typeof firebase.auth}'.`);
        showToast("El servicio de autenticaci√≥n no est√° disponible.", "error");
        return;
    }

    // Comprobamos si el modal ya tiene la clase 'active'
    const isActive = modal.classList.contains('active');

    if (!isActive) {
        // --- L√ìGICA PARA ABRIR EL MODAL ---

        // 1. Mover el modal al final del body para asegurar el z-index
        document.body.appendChild(modal);

        // 2. Mostrar formulario o info de usuario
        const form = document.getElementById('login-form');
        const info = document.getElementById('login-user-info');
        if (currentUser) {
            form.classList.add('hidden');
            info.classList.remove('hidden');
            document.getElementById('user-email-display').textContent = currentUser.email;
        } else {
            form.classList.remove('hidden');
            info.classList.add('hidden');
        }

        // 3. LA CORRECCI√ìN: A√±adimos la clase .active para que el CSS lo muestre
        modal.classList.add('active');
        
        // Y por seguridad, nos aseguramos de que no tenga la clase 'hidden' de Tailwind
        modal.classList.remove('hidden');
        
        lockScroll();

    } else {
        // --- L√ìGICA PARA CERRAR EL MODAL ---
        modal.classList.remove('active');
        unlockScroll();
    }
}




        function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            firebase.auth().signInWithEmailAndPassword(email, password)
                .then(() => {
                    toggleLoginModal();
                    showToast('Sesi√≥n iniciada correctamente', 'success');
                })
                .catch((error) => {
                    alert("Error de inicio de sesi√≥n: " + error.message);
                });
        }

        function handleLogout() {
            firebase.auth().signOut().then(() => {
                toggleLoginModal();
                showToast('Sesi√≥n cerrada', 'info');
            });
        }

        function updateAuthUI() {
            const btn = document.getElementById('btn-auth');
            if (currentUser) {
                btn.textContent = 'üîì';
                btn.classList.add('bg-green-500', 'text-white');
                btn.classList.remove('bg-white/10');
            } else {
                btn.textContent = 'üîí';
                btn.classList.remove('bg-green-500', 'text-white');
                btn.classList.add('bg-white/10');
            }
        }

        async function setStorageMode(mode) {
            appMode = mode;
            const btnLocal = document.getElementById('btn-mode-local');
            const btnGlobal = document.getElementById('btn-mode-global');
            
            if (mode === 'local') {
                btnLocal.className = "px-4 py-2 rounded-md font-bold bg-white text-slate-900 shadow-sm transition-all text-sm";
                btnGlobal.className = "px-4 py-2 rounded-md font-bold text-white hover:bg-white/10 transition-all text-sm";
                cloudCache = {};
            } else {
                if (initFirebase()) {
                    btnGlobal.className = "px-4 py-2 rounded-md font-bold bg-blue-600 text-white shadow-sm transition-all text-sm";
                    btnLocal.className = "px-4 py-2 rounded-md font-bold text-white hover:bg-white/10 transition-all text-sm";
                    setupRealtimeListener();
                } else {
                    appMode = 'local';
                }
            }
        }

        function setupRealtimeListener() {
            const loader = document.createElement('div');
            loader.id = "cloud-loader";
            loader.className = "fixed inset-0 bg-black/80 z-[99999] flex flex-col items-center justify-center text-white";
            loader.innerHTML = `<div class="text-4xl mb-4 animate-bounce">‚òÅÔ∏è</div><p>Conectando tiempo real...</p>`;
            document.body.appendChild(loader);

            const dbRef = firebase.database().ref('/');
            dbRef.off(); // Limpiar listeners anteriores

            dbRef.on('value', (snapshot) => {
                const val = snapshot.val();
                cloudCache = val || {};
                console.log("üîÑ Datos actualizados (Realtime)");
                
                const existingLoader = document.getElementById("cloud-loader");
                if (existingLoader) existingLoader.remove();

                // Refrescar la vista activa
                const activeTabBtn = document.querySelector('.tab-btn.tab-active');
                if (activeTabBtn) {
                    const tabId = activeTabBtn.id;
                    if (tabId === 'tab-principal') renderPrincipal();
                    else if (tabId === 'tab-plantilla') renderPlayers();
                    else if (tabId === 'tab-calendario') renderCalendar();
                    else if (tabId === 'tab-partidos') renderMatches();
                    else if (tabId === 'tab-stats') {
                        if (!document.getElementById('stats-h2h').classList.contains('hidden')) renderH2H();
                        else if (!document.getElementById('stats-general').classList.contains('hidden')) renderStats();
                    }
                }
            });
        }

        function getData(key) {
            if (!currentTeam) return [];
            const scopedKey = `${currentTeam}_${key}`;

            if (appMode === 'global' && isFirebaseInitialized) {
                const data = cloudCache[scopedKey];
                return data ? data : [];
            } else {
                const data = localStorage.getItem(scopedKey);
                return data ? JSON.parse(data) : [];
            }
        }

        function saveData(key, data) {
            if (!currentTeam) return;
            const scopedKey = `${currentTeam}_${key}`;

            if (appMode === 'global' && isFirebaseInitialized) {
                if (!currentUser) {
                    alert("‚ö†Ô∏è Modo Lectura: Debes iniciar sesi√≥n para guardar cambios en la nube.");
                    return;
                }
                cloudCache[scopedKey] = data;
                firebase.database().ref(scopedKey).set(data).catch(e => console.error("Error guardando en nube:", e));
            } else {
                localStorage.setItem(scopedKey, JSON.stringify(data));
            }
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function getPlayers() {
            if (!currentTeam) return [];
            const customStates = getData('playerStates');
            return PLANTILLA_ACTUAL.map(p => {
                const customState = customStates.find(cs => cs.id === p.id);
                return customState ? { ...p, estado: customState.estado } : p;
            });
        }

        function getActivePlayers() {
            return getPlayers().filter(p => p.estado === 'Activo');
        }
        
        function getLoanedPlayers() {
            return getPlayers().filter(p => p.estado === 'Cedido');
        }

        function updatePlayerState(playerId, newState) {
            let customStates = getData('playerStates');
            const existingIndex = customStates.findIndex(cs => cs.id === playerId);
            if (existingIndex !== -1) {
                customStates[existingIndex].estado = newState;
            } else {
                customStates.push({ id: playerId, estado: newState });
            }
            saveData('playerStates', customStates);
        }

        // ==========================================
        // COMPETITION STATE MANAGEMENT
        // ==========================================
        
        function getCompetitionState() {
            return getData('competitionState') || {};
        }

        function saveCompetitionState(state) {
            saveData('competitionState', state);
        }

        function getAvailableRounds(compName) {
            const comp = COMPETICIONES_ACTUALES[compName];
            if (!comp) return [];
            
            const matches = getData('matches').filter(m => m.competition === compName);
            const state = getCompetitionState();
            
            // Datos del estado guardado
            const eliminatedAt = state[compName]?.eliminatedAt;
            const extraRoundState = state[compName]?.playsExtra;
            
            let allRounds = [];
            // Aplanar estructura
            comp.fases.forEach(fase => {
                fase.rondas.forEach(ronda => {
                    allRounds.push({ ...ronda, faseTipo: fase.tipo, faseNombre: fase.nombre, faseOrdenLibre: fase.ordenLibre });
                });
            });

            // Filtrar ronda extra si el usuario dijo que NO se juega
            if (extraRoundState === false) {
                allRounds = allRounds.filter(r => !r.rondaExtra);
            }

            // Ordenar por orden num√©rico
            allRounds.sort((a, b) => a.orden - b.orden);
            
            const completedRoundIds = matches.map(m => m.roundId);
            const result = [];
            const isLeagueFormat = comp.ordenLibre || comp.tipo === 'liga';
            
            let eliminationTriggered = false; // Flag maestro de bloqueo

            for (let i = 0; i < allRounds.length; i++) {
                const ronda = allRounds[i];
                const isCompleted = completedRoundIds.includes(ronda.id);
                
                // Si ya pasamos la ronda de eliminaci√≥n en una iteraci√≥n anterior, bloqueamos todo lo que queda
                if (eliminationTriggered) {
                    result.push({ ...ronda, status: 'locked' });
                    continue;
                }

                let isAvailable = false;
                
                if (ronda.faseTipo === 'liga' || ronda.faseOrdenLibre || isLeagueFormat) {
                    isAvailable = !isCompleted;
                } else {
                    // L√≥gica secuencial: Si la anterior est√° completa, esta est√° disponible
                    if (i === 0) {
                        isAvailable = !isCompleted; 
                    } else {
                        const prevRound = allRounds[i - 1];
                        // La anterior cuenta como completada si se jug√≥ O si era de tipo liga (que no bloquea)
                        const isPrevCompleted = completedRoundIds.includes(prevRound.id) || prevRound.faseTipo === 'liga' || prevRound.faseOrdenLibre;
                        isAvailable = !isCompleted && isPrevCompleted;
                    }
                }
                
                // DETECCI√ìN DE ELIMINACI√ìN
                // Si esta ronda es donde nos eliminaron, activamos el flag para bloquear las siguientes
                if (eliminatedAt === ronda.id) {
                    eliminationTriggered = true;
                }
                
                result.push({
                    ...ronda,
                    status: isCompleted ? 'completed' : (isAvailable ? 'available' : 'locked')
                });
            }
            return result;
        }

        function checkEliminationAfterMatch(match) {
            const comp = COMPETICIONES_ACTUALES[match.competition];
            if (!comp) return;
            
            let roundInfo = null;
            // Buscar la ronda en todas las fases
            comp.fases.forEach(fase => {
                const found = fase.rondas.find(r => r.id === match.roundId);
                if (found) roundInfo = { ...found, faseTipo: fase.tipo };
            });
            
            // Si no es eliminatoria o es liga, no hacemos nada
            if (!roundInfo || !roundInfo.eliminatoria || roundInfo.faseTipo === 'liga') return;
            
            let isEliminated = false;

            // 1. Eliminaci√≥n forzada manual
            if (match.forceElimination) {
                isEliminated = true;
            }
            // 2. Partido √önico (Copa, Supercopa, Finales)
            else if (roundInfo.partidoUnico) {
                isEliminated = match.outcome === 'derrota';
            } 
            // 3. Partido de Vuelta (Champions, UWCL)
            else if (roundInfo.idaVuelta === 'vuelta') {
                const matches = getData('matches').filter(m => m.competition === match.competition);
                const idaMatch = matches.find(m => m.roundId === roundInfo.pareja);
                
                if (idaMatch) {
                    const globalResult = calculateGlobalResult(idaMatch, match);
                    isEliminated = globalResult.outcome === 'derrota';
                }
            }
            
            // SI ESTAMOS ELIMINADOS, GUARDAMOS EL ESTADO
            if (isEliminated) {
                console.log(`‚ùå Eliminado de ${match.competition} en ${match.roundId}`);
                const state = getCompetitionState();
                
                // Aseguramos que existe el objeto para esa compe
                if (!state[match.competition]) state[match.competition] = {};
                
                // Actualizamos flags sin borrar lo que hubiera (ej: playsExtra)
                state[match.competition].eliminated = true;
                state[match.competition].eliminatedAt = match.roundId;
                
                saveCompetitionState(state);
            }
        }

        function calculateGlobalResult(idaMatch, vueltaMatch) {
            const getGoals = (m) => {
                const parts = m.result.replace('*','').split('-').map(Number);
                if (m.venue === 'local') return { us: parts[0], them: parts[1] };
                if (m.venue === 'visitante') return { us: parts[1], them: parts[0] };
                return { us: parts[0], them: parts[1] }; 
            };

            const ida = getGoals(idaMatch);
            const vuelta = getGoals(vueltaMatch);

            const totalUs = ida.us + vuelta.us;
            const totalThem = ida.them + vuelta.them;

            let outcome;
            if (totalUs > totalThem) outcome = 'victoria';
            else if (totalUs < totalThem) outcome = 'derrota';
            else {
                const awayGoalsUs = (idaMatch.venue === 'visitante' ? ida.us : 0) + (vueltaMatch.venue === 'visitante' ? vuelta.us : 0);
                const awayGoalsThem = (idaMatch.venue === 'local' ? ida.them : 0) + (vueltaMatch.venue === 'local' ? vuelta.them : 0);

                if (awayGoalsUs > awayGoalsThem) outcome = 'victoria';
                else if (awayGoalsUs < awayGoalsThem) outcome = 'derrota';
                else outcome = 'empate'; 
            }
            
            return { totalFavor: totalUs, totalContra: totalThem, outcome };
        }
        
       function recalculateCompetitionState(compName) {
            console.log(`Recalculando estado para: ${compName}`);
            
            // 1. Obtener estado actual
            let state = getCompetitionState();
            
            // 2. Limpiar SOLO los flags de eliminaci√≥n (respetando playsExtra si existe)
            if (state[compName]) {
                delete state[compName].eliminated;
                delete state[compName].eliminatedAt;
            } else {
                state[compName] = {};
            }
            saveCompetitionState(state);
            
            // 3. Obtener partidos y re-evaluar cronol√≥gicamente
            const matches = getData('matches')
                .filter(m => m.competition === compName)
                .sort((a, b) => new Date(a.date) - new Date(b.date));
                
            matches.forEach(match => {
                checkEliminationAfterMatch(match);
            });
            
            // Log para verificar
            const newState = getCompetitionState();
            console.log("Estado final:", newState[compName]);
       }

// ==========================================
// üîÑ GESTI√ìN DE PESTA√ëAS (VERSI√ìN SEGURA)
// ==========================================
function switchStatsTab(tabName) {
    // 1. GESTI√ìN VISUAL (BOTONES)
    // Quitamos activo a todos
    document.querySelectorAll('.stats-subtab').forEach(btn => {
        if(btn) {
            btn.classList.remove('active', 'bg-blue-600', 'text-white');
            btn.classList.add('inactive'); // O tu estilo por defecto
        }
    });

    // Activamos el pulsado
    const targetBtn = document.getElementById(`btn-stats-${tabName}`);
    if (targetBtn) {
        targetBtn.classList.remove('inactive');
        targetBtn.classList.add('active', 'bg-blue-600', 'text-white');
    }

    // 2. GESTI√ìN DE CONTENIDO (DIVS)
    // Ocultamos TODOS los divs de contenido
    document.querySelectorAll('.stats-content').forEach(div => div.classList.add('hidden'));

    // Buscamos el div destino
    let targetDiv = document.getElementById(`stats-${tabName}`);
    // Compatibilidad con nombres antiguos
    if (!targetDiv) targetDiv = document.getElementById(`section-${tabName}`);

    if (targetDiv) {
        targetDiv.classList.remove('hidden');
    } else {
        // Si no existe el div (ej: para 'bench' si aun no lo has creado), salimos sin error
        console.warn(`‚ö†Ô∏è AVISO: No existe el contenedor <div id="stats-${tabName}"> todav√≠a.`);
        return;
    }

    // 3. RENDERIZADO (L√≥gica)
    const matches = (typeof getData === 'function') ? getData('matches') || [] : [];

    try {
        if (tabName === 'general') {
            if (typeof renderGeneralStats === 'function') renderGeneralStats();
            // Gr√°ficos que van en General
            setTimeout(() => {
                if (typeof renderGalaXI === 'function') renderGalaXI();
                if (typeof renderPerformanceQuadrant === 'function') renderPerformanceQuadrant();
                if (typeof renderHomeAwayStats === 'function') renderHomeAwayStats();
                if (typeof renderSeasonEvolutionChart === 'function') renderSeasonEvolutionChart();
            }, 50);
        } 
        else if (tabName === 'advanced') {
            if (typeof renderAdvancedStats === 'function') renderAdvancedStats();
            // Gr√°ficos Avanzados
            setTimeout(() => {
                // El error ven√≠a de aqu√≠: renderCharts busca 'stats-charts-wrapper'
                if (typeof renderCharts === 'function') renderCharts(matches);
                if (typeof renderLineWarsChart === 'function') renderLineWarsChart();
                if (typeof renderRigurosityHistogram === 'function') renderRigurosityHistogram();
                if (typeof renderTierList === 'function') renderTierList();
                if (typeof renderSchemePerformance === 'function') renderSchemePerformance();
            }, 50);
        }
        else if (tabName === 'h2h') {
            if (typeof populateH2HOpponents === 'function') populateH2HOpponents();
        }
        else if (tabName === 'mvp') {
            if (typeof renderMVPGallery === 'function') renderMVPGallery();
            else if (typeof renderHallOfFame === 'function') renderHallOfFame();
        }
        else if (tabName === 'coaches') {
            if (typeof renderCoachStats === 'function') renderCoachStats();
        }
        else if (tabName === 'goalkeepers') {
            if (typeof renderGoalkeeperStats === 'function') renderGoalkeeperStats();
        }
        else if (tabName === 'cantera') {
            if (typeof renderCanteraStats === 'function') renderCanteraStats();
        }
        else if (tabName === 'awards') {
            if (typeof renderSeasonAwards === 'function') renderSeasonAwards();
        }
        else if (tabName === 'records') {
            if (typeof renderRecords === 'function') renderRecords();
        }

    } catch (e) {
        console.error("Error controlado al renderizar:", e);
    }
}

  

// --- FUNCI√ìN DE ORDENACI√ìN (HANDLE SORT) ---
function handleSort(column) {
    // Si pulsamos la misma columna, invertimos el orden
    if (currentSortColumn === column) {
        currentSortOrder = currentSortOrder === 'desc' ? 'asc' : 'desc';
    } else {
        // Si es nueva columna, empezamos en descendente (lo m√°s alto arriba)
        currentSortColumn = column;
        currentSortOrder = 'desc';
        
        // Excepci√≥n: Si ordenamos por Nombre, mejor empezar Ascendente (A-Z)
        if (column === 'name') currentSortOrder = 'asc';
    }
    
    // IMPORTANTE: Repintar la tabla
    renderStats();
}
function renderTopPerformances() {
    const container = document.getElementById('top-performances-container');
    const listContainer = document.getElementById('top-performances-list');
    
    if (!container || !listContainer) return;

    const matches = getData('matches');
    const players = getPlayers();
    
    // 1. Recopilar TODAS las actuaciones individuales
    let allPerformances = [];

    matches.forEach(match => {
        match.playerStats.forEach(ps => {
            // Filtros: Que tenga nota, que no sea 0 (opcional), y que NO sea el entrenador
            if (ps.rating !== null && ps.rating !== undefined && ps.rating !== "") {
                const ratingVal = parseFloat(ps.rating);
                const player = players.find(p => p.id === ps.playerId);
                
                // Excluir entrenador y asegurar que el jugador existe
                if (player && player.posicion !== 'entrenador' && player.dorsal !== 'DT') {
                    allPerformances.push({
                        rating: ratingVal,
                        player: player,
                        match: match,
                        stats: ps
                    });
                }
            }
        });
    });

    // 2. Ordenar por Nota (Descendente)
    // Si hay empate de nota, desempata por goles, luego asistencias, luego fecha m√°s reciente
    allPerformances.sort((a, b) => {
        if (b.rating !== a.rating) return b.rating - a.rating;
        if ((b.stats.goals || 0) !== (a.stats.goals || 0)) return (b.stats.goals || 0) - (a.stats.goals || 0);
        return new Date(b.match.date) - new Date(a.match.date);
    });

    // 3. Coger el Top 5
    const top5 = allPerformances.slice(0, 5);

    if (top5.length === 0) {
        container.classList.add('hidden');
        return;
    }

    container.classList.remove('hidden');

    // 4. Renderizar HTML
    listContainer.innerHTML = top5.map((perf, index) => {
        const isNumberOne = index === 0;
        const p = perf.player;
        const m = perf.match;
        const s = perf.stats;

        // Estilos especiales para el n√∫mero 1
        const cardBorder = isNumberOne ? 'border-amber-400 ring-1 ring-amber-100' : 'border-gray-200';
        const ratingBg = isNumberOne ? 'bg-amber-500 text-white' : 'bg-gray-100 text-gray-800';

        return `
            <div class="bg-white rounded-xl shadow-sm border ${cardBorder} p-3 flex flex-col relative overflow-hidden transition-transform hover:scale-105">
                ${isNumberOne ? '<div class="absolute top-0 right-0 bg-amber-400 text-white text-[9px] font-bold px-2 py-0.5 rounded-bl-lg z-10">MVP TOTAL</div>' : ''}
                
                <div class="flex justify-between items-start mb-2">
                    <div class="flex items-center gap-2">
                        <img src="${p.foto}" class="w-10 h-10 rounded-full object-cover border border-gray-100">
                        <div class="min-w-0">
                            <p class="text-xs font-bold text-gray-800 truncate leading-tight">${p.apodo || p.apellido}</p>
                            <p class="text-[10px] text-gray-500">vs ${m.opponent}</p>
                        </div>
                    </div>
                    <div class="${ratingBg} font-bold text-lg px-2 rounded-lg shadow-sm">
                        ${perf.rating}
                    </div>
                </div>

                <div class="mt-auto pt-2 border-t border-gray-50">
                    <div class="flex justify-between items-center text-[10px] text-gray-500 mb-1">
                        <span class="truncate max-w-[80px]">${m.competition}</span>
                        <span>${m.result}</span>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-1 text-center bg-gray-50 rounded-lg py-1">
                        <div class="flex flex-col">
                            <span class="text-[9px] text-gray-400 uppercase">Gol</span>
                            <span class="font-bold text-emerald-600 text-xs">${s.goals || 0}</span>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-[9px] text-gray-400 uppercase">Asist</span>
                            <span class="font-bold text-blue-600 text-xs">${s.assists || 0}</span>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-[9px] text-gray-400 uppercase">Min</span>
                            <span class="font-bold text-gray-600 text-xs">${s.minutes}'</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

/* ========================================================= */
/* üìä RENDERIZAR ESTAD√çSTICAS (TABLA + GR√ÅFICOS)             */
/* ========================================================= */

function renderStats() {
    const matches = getData('matches');
    const players = getPlayers();
    
    const competitionFilter = document.getElementById('stats-filter-competition').value;
    const statusFilter = document.getElementById('stats-filter-status').value;
    
    // ---------------------------------------------------------
    // 1. GESTI√ìN VISUAL DE CABECERAS (LIMPIEZA TOTAL)
    // ---------------------------------------------------------
    

    if(typeof renderConsistencyWidget === 'function') renderConsistencyWidget();
    // Seleccionamos TODOS los th que tengan ID empezando por "th-"
    const allHeaders = document.querySelectorAll('th[id^="th-"]');

    allHeaders.forEach(th => {
        // A. RESETEAR COLORES:
        // Quitamos el "amarillo activo" y el fondo oscuro
        th.classList.remove('text-amber-400', 'bg-slate-700');
        
        // Ponemos el color por defecto (Gris/Blanco suave)
        th.classList.add('text-gray-200'); 

        // B. LIMPIEZA DE FLECHAS (La clave):
        // Usamos una Regex global (/.../g) para borrar CUALQUIER flecha que haya quedado
        // Borramos ‚ñ≤, ‚ñº y espacios extra al final
        let cleanText = th.innerText.replace(/[‚ñ≤‚ñº]/g, '').trim();
        th.innerText = cleanText;
    });

    // ---------------------------------------------------------
    // 2. MARCAR LA COLUMNA ACTIVA
    // ---------------------------------------------------------
    const activeTh = document.getElementById(`th-${currentSortColumn}`);
    
    if (activeTh) {
        // Quitamos el gris apagado
        activeTh.classList.remove('text-gray-200');

        // Ponemos el estilo ACTIVO (Texto √Åmbar + Fondo Slate)
        activeTh.classList.add('text-amber-400', 'bg-slate-700'); 

        // A√±adimos la flecha nueva
        const arrow = currentSortOrder === 'asc' ? ' ‚ñ≤' : ' ‚ñº';
        activeTh.innerText = activeTh.innerText + arrow;
    }

    // 2. FILTRAR PARTIDOS
    let filteredMatches = matches;
    if (competitionFilter) {
        filteredMatches = filteredMatches.filter(m => m.competition === competitionFilter);
    }

    // L√≥gica de Rachas
    const streakContainer = document.getElementById('team-streak');
    const last5Matches = [...matches].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
    if (last5Matches.length > 0 && streakContainer) {
        streakContainer.innerHTML = last5Matches.map(m => {
            let outcomeClass = 'streak-d'; let letter = 'E';
            if (m.outcome === 'victoria') { outcomeClass = 'streak-w'; letter = 'V'; }
            else if (m.outcome === 'derrota') { outcomeClass = 'streak-l'; letter = 'D'; }
            return `<span class="streak-dot ${outcomeClass}" title="${m.opponent} (${m.result})">${letter}</span>`;
        }).join('');
    } else if (streakContainer) {
        streakContainer.innerHTML = '<span class="text-gray-500 text-sm">Sin partidos jugados</span>';
    }

    // TOTALES GLOBALES
    let totalWins = 0, totalDraws = 0, totalLosses = 0;
    let totalGoalsFor = 0, totalGoalsAgainst = 0;
    let totalAssists = 0;
    
    filteredMatches.forEach(m => {
        if (m.outcome === 'victoria') totalWins++;
        else if (m.outcome === 'empate') totalDraws++;
        else if (m.outcome === 'derrota') totalLosses++;

        if (m.result && m.result.includes('-')) {
            const parts = m.result.replace('*','').split('-').map(Number);
            if (m.venue === 'local') { totalGoalsFor += parts[0]; totalGoalsAgainst += parts[1]; }
            else if (m.venue === 'visitante') { totalGoalsFor += parts[1]; totalGoalsAgainst += parts[0]; }
            else { totalGoalsFor += parts[0]; totalGoalsAgainst += parts[1]; }
        }
    });
    
    if(document.getElementById('stat-total-matches')) document.getElementById('stat-total-matches').textContent = filteredMatches.length;
    if(document.getElementById('stat-wins')) document.getElementById('stat-wins').textContent = totalWins;
    if(document.getElementById('stat-draws')) document.getElementById('stat-draws').textContent = totalDraws;
    if(document.getElementById('stat-losses')) document.getElementById('stat-losses').textContent = totalLosses;
    if(document.getElementById('stat-total-goals')) document.getElementById('stat-total-goals').textContent = totalGoalsFor;
    if(document.getElementById('stat-total-goals-against')) document.getElementById('stat-total-goals-against').textContent = totalGoalsAgainst;

    let filteredPlayers = [...players];
    if (statusFilter) {
        if (statusFilter === 'Inactivo') {
             filteredPlayers = filteredPlayers.filter(p => p.estado === 'Inactivo' || p.estado === 'Leyenda');
        } else {
             filteredPlayers = filteredPlayers.filter(p => p.estado === statusFilter);
        }
    }
    
    const playerOnlyCount = filteredPlayers.filter(p => p.posicion !== 'entrenador').length;
    if(document.getElementById('stat-total-players')) document.getElementById('stat-total-players').textContent = playerOnlyCount;

    // 3. MAPEAR DATOS
    const playerStats = filteredPlayers.map(player => {
        const stats = {
            id: player.id,
            name: player.apodo || `${player.nombre} ${player.apellido}`,
            number: player.dorsal,
            foto: player.foto,
            posicion: player.posicion,
            estado: player.estado,
            matchesPlayed: 0,
            starts: 0, 
            totalRating: 0,
            ratingCount: 0,
            goals: 0,
            assists: 0,
            ga: 0,
            minutes: 0,
            mvpCount: 0,
            wins: 0, draws: 0, losses: 0,
            yellowCards: 0, redCards: 0,
            last5Ratings: [],
            positionsPlayed: {},
            minPerMatch: 0, gPer90: 0, aPer90: 0, gaPer90: 0, avgRating: '-'
        };
        
        filteredMatches.forEach(match => {
            const ps = match.playerStats?.find(s => String(s.playerId) === String(player.id));
            if (ps) {
                if (ps.minutes > 0 || ps.played) {
                    stats.matchesPlayed++;
                    if (ps.isStarter) stats.starts++;
                    const posName = ps.specificPosition || (ps.isStarter ? 'Titular' : 'Suplente');
                    stats.positionsPlayed[posName] = (stats.positionsPlayed[posName] || 0) + 1;
                }
                stats.goals += (ps.goals || 0);
                stats.assists += (ps.assists || 0);
                stats.minutes += (ps.minutes || 0);
                stats.yellowCards += (ps.yellowCards || 0);
                stats.redCards += (ps.redCards || 0);
                
                if (ps.rating !== null && ps.rating !== "" && ps.rating !== undefined) {
                    stats.totalRating += parseFloat(ps.rating);
                    stats.ratingCount++;
                    stats.last5Ratings.push(parseFloat(ps.rating));
                }
                
                if (match.outcome === 'victoria') stats.wins++;
                else if (match.outcome === 'empate') stats.draws++;
                else if (match.outcome === 'derrota') stats.losses++;
            }
            if (String(match.mvp) === String(player.id)) stats.mvpCount++;
        });
        
        stats.avgRating = stats.ratingCount > 0 ? (stats.totalRating / stats.ratingCount).toFixed(2) : '-';
        stats.ga = stats.goals + stats.assists;
        stats.minPerMatch = stats.matchesPlayed > 0 ? (stats.minutes / stats.matchesPlayed).toFixed(0) : '-';
        
        const factor = stats.minutes > 0 ? (90 / stats.minutes) : 0;
        stats.gPer90 = (stats.goals * factor).toFixed(2);
        stats.aPer90 = (stats.assists * factor).toFixed(2);
        stats.gaPer90 = (stats.ga * factor).toFixed(2);

        totalAssists += stats.assists;
        return stats;
    });

    if(document.getElementById('stat-total-assists')) document.getElementById('stat-total-assists').textContent = totalAssists;

    // 4. ORDENAR
    playerStats.sort((a, b) => {
        const inactA = a.estado === 'Inactivo' || a.estado === 'Leyenda';
        const inactB = b.estado === 'Inactivo' || b.estado === 'Leyenda';

        if (inactA && !inactB) return 1;
        if (!inactA && inactB) return -1;

        let valA = a[currentSortColumn];
        let valB = b[currentSortColumn];

        if (currentSortColumn === 'name') return currentSortOrder === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
        if (currentSortColumn === 'avgRating') {
            valA = (valA === '-' || valA === null) ? -1 : parseFloat(valA);
            valB = (valB === '-' || valB === null) ? -1 : parseFloat(valB);
        }
        else if (currentSortColumn === 'number') {
            if (valA === 'DT') valA = -1; else valA = parseInt(valA) || 0;
            if (valB === 'DT') valB = -1; else valB = parseInt(valB) || 0;
        }
        else {
            valA = parseFloat(valA) || 0;
            valB = parseFloat(valB) || 0;
        }
        return currentSortOrder === 'asc' ? valA - valB : valB - valA;
    });

    // 5. PINTAR TABLA
    const tableBody = document.getElementById('stats-table-body');
    const noStats = document.getElementById('no-stats');
    
    if (playerStats.length === 0) {
        tableBody.innerHTML = '';
        noStats.classList.remove('hidden');
    } else {
        noStats.classList.add('hidden');
        tableBody.innerHTML = playerStats.map(stats => {
            const isCoach = stats.number === 'DT' || stats.posicion === 'entrenador';
            const isInactive = stats.estado === 'Inactivo' || stats.estado === 'Leyenda';
            
            return `
            <tr class="border-t hover:bg-gray-50 cursor-pointer ${isInactive ? 'opacity-60 bg-gray-50' : ''}" onclick="viewPlayerDetails('${stats.id}')">
                <td class="px-4 py-3">
                    <div class="flex items-center gap-3">
                        <img src="${stats.foto}" class="player-photo-small" onerror="this.src='https://via.placeholder.com/40x40?text=${stats.number}'">
                        <div>
                            <span class="font-medium text-gray-800">${stats.name}</span>
                            <span class="text-gray-500 text-sm ml-1">${stats.number === 'DT' ? 'DT' : '#' + stats.number}</span>
                            ${stats.estado !== 'Activo' ? `<span class="text-xs ${stats.estado === 'Leyenda' ? 'text-amber-600' : 'text-red-500'} font-bold ml-1">(${stats.estado})</span>` : ''}
                        </div>
                    </div>
                </td>
                <td class="px-4 py-3 text-center font-medium">${stats.matchesPlayed}</td>
                <td class="px-4 py-3 text-center font-semibold text-indigo-600">${stats.starts}</td>
                <td class="px-4 py-3 text-center font-semibold ${getRatingColor(stats.avgRating)}">${stats.avgRating}</td>
                <td class="px-4 py-3 text-center font-medium text-emerald-600">${isCoach ? '-' : stats.goals}</td>
                <td class="px-2 py-3 text-center text-xs text-blue-500 font-mono">${isCoach ? '-' : stats.gPer90}</td>
                <td class="px-4 py-3 text-center">${isCoach ? '-' : stats.assists}</td>
                <td class="px-2 py-3 text-center text-xs text-blue-500 font-mono">${isCoach ? '-' : stats.aPer90}</td>
                <td class="px-4 py-3 text-center font-bold">${isCoach ? '-' : stats.ga}</td>
                <td class="px-2 py-3 text-center text-xs text-purple-600 font-bold font-mono">${isCoach ? '-' : stats.gaPer90}</td>
                <td class="px-4 py-3 text-center text-gray-600">${isCoach ? '-' : stats.minutes + "'"}</td>
                <td class="px-2 py-3 text-center text-xs text-gray-500 italic">${isCoach ? '-' : stats.minPerMatch + "'"}</td>
                <td class="px-4 py-3 text-center">
                    ${stats.mvpCount > 0 ? `<span class="bg-amber-100 text-amber-700 px-2 py-0.5 rounded-full text-sm font-medium">${stats.mvpCount}</span>` : '-'}
                </td>
                <td class="px-4 py-3 text-center text-green-600 font-medium">${stats.wins}</td>
                <td class="px-4 py-3 text-center text-amber-600">${stats.draws}</td>
                <td class="px-4 py-3 text-center text-red-600">${stats.losses}</td>
                <td class="px-4 py-3 text-center">${stats.yellowCards > 0 ? stats.yellowCards : '-'}</td>
                <td class="px-4 py-3 text-center">${stats.redCards > 0 ? `<span class="text-red-600 font-medium">${stats.redCards}</span>` : '-'}</td>
            </tr>
            `}).join('');
    }

    // ... (Todo el c√≥digo anterior de la tabla sigue igual) ...

    // =========================================================
    // 6. RENDERIZAR GR√ÅFICOS Y AN√ÅLISIS VISUAL
    // =========================================================
    
    // 1. Mostrar la secci√≥n visual (por si estaba oculta)
    const visualSection = document.getElementById('stats-visual-section');
    if (visualSection) {
        visualSection.classList.remove('hidden');
    }

    // 2. Inyectar el An√°lisis de Goles en su hueco espec√≠fico
    // ... (Tu c√≥digo anterior) ...

    const goalContainer = document.getElementById('stats-goal-analysis-container');
    if (goalContainer) {
        // Llamamos a la funci√≥n que crea las barras y lo metemos en el DIV
        goalContainer.innerHTML = (typeof renderGoalAnalysis === 'function') 
            ? renderGoalAnalysis() 
            : '';
        
        // --- AQU√ç EST√Å EL BLOQUE A MODIFICAR ---
        const subsContainer = document.getElementById('general-subs-heatmap-container');
        if (subsContainer) {
            // 1. Mapa de Calor (Heatmap)
            subsContainer.innerHTML = getSubstitutionHeatmapHTML(matches);
            
            // 2. Goles por Posici√≥n
            const goalsByPosHTML = getGoalsByPositionWidget();    
            subsContainer.innerHTML += `<div class="mt-6">${goalsByPosHTML}</div>`;

            // 3. NUEVO: Jerarqu√≠a de Plantilla (Titularidad)
            const hierarchyHTML = getSquadHierarchyWidget();
            subsContainer.innerHTML += `<div class="mt-6">${hierarchyHTML}</div>`;
            subsContainer.innerHTML += `<div class="mt-6">${getOffensiveParticipationWidget()}</div>`;
        }
    }


    // o el ID que tengas configurado para ello.
    if(typeof renderCharts === 'function') renderCharts(filteredMatches);
    if(typeof renderBestXI === 'function') renderBestXI();
    if(typeof renderScatterChart === 'function') renderScatterChart();
    if(typeof renderRegularityAnalysis === 'function') renderRegularityAnalysis();
    if(typeof renderFormationStats === 'function') renderFormationStats();
    if(typeof renderHomeAwayStats === 'function') renderHomeAwayStats(filteredMatches);
    if (typeof renderSeasonEvolutionChart === 'function')renderSeasonEvolutionChart(filteredMatches);
}

function renderCoachStats() {
    const container = document.getElementById('stats-coaches');
    if (!container) return;
    
    const matches = getData('matches');
    const players = getPlayers();
    const coaches = players.filter(p => p.posicion === 'entrenador');

    if (coaches.length === 0) {
        container.innerHTML = `<div class="text-center py-12 text-gray-500">No hay entrenadores registrados.</div>`;
        return;
    }

    let html = '<div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">';

    coaches.forEach(coach => {
        const coachMatches = matches.filter(m => 
            m.playerStats && m.playerStats.some(ps => ps.playerId === coach.id)
        );

        if (coachMatches.length === 0) return;

        let stats = { played: 0, wins: 0, draws: 0, losses: 0, gf: 0, ga: 0, totalRating: 0, ratingCount: 0 };

        coachMatches.forEach(m => {
            stats.played++;
            if (m.outcome === 'victoria') stats.wins++;
            else if (m.outcome === 'empate') stats.draws++;
            else stats.losses++;

            const parts = m.result.replace('*','').split('-').map(Number);
            if (m.venue === 'local') { stats.gf += parts[0]; stats.ga += parts[1]; }
            else if (m.venue === 'visitante') { stats.gf += parts[1]; stats.ga += parts[0]; }
            else { stats.gf += parts[0]; stats.ga += parts[1]; }

            const ps = m.playerStats.find(s => s.playerId === coach.id);
            if (ps && ps.rating) {
                stats.totalRating += parseFloat(ps.rating);
                stats.ratingCount++;
            }
        });

        const avgRating = stats.ratingCount > 0 ? (stats.totalRating / stats.ratingCount).toFixed(2) : '-';
        const winRate = stats.played > 0 ? ((stats.wins / stats.played) * 100).toFixed(0) : 0;
        const ppm = stats.played > 0 ? ((stats.wins * 3 + stats.draws) / stats.played).toFixed(2) : '0.00';
        const gd = stats.gf - stats.ga;

        html += `
            <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden hover:shadow-xl transition-shadow">
                <div class="bg-slate-800 p-4 flex items-center gap-4 relative overflow-hidden">
                    <div class="absolute right-0 top-0 h-full w-1/2 bg-gradient-to-l from-white/10 to-transparent"></div>
                    <img src="${coach.foto}" class="w-16 h-16 rounded-full object-cover border-2 border-white shadow-md z-10 bg-white" onerror="this.src='https://via.placeholder.com/64'">
                    <div class="z-10 text-white">
                        <h3 class="font-bold text-lg leading-tight">${coach.nombre} ${coach.apellido}</h3>
                        <p class="text-xs text-slate-300 uppercase font-bold tracking-wider">Entrenador</p>
                    </div>
                </div>
                <div class="p-5">
                    <div class="flex justify-between items-center mb-4">
                        <div class="text-center"><span class="block text-3xl font-black text-slate-700">${stats.played}</span><span class="text-[10px] text-gray-400 uppercase font-bold">Partidos</span></div>
                        <div class="h-8 w-px bg-gray-200"></div>
                        <div class="text-center"><span class="block text-3xl font-black text-indigo-600">${ppm}</span><span class="text-[10px] text-gray-400 uppercase font-bold">Pts/Partido</span></div>
                    </div>
                    <div class="grid grid-cols-3 gap-2 mb-4">
                        <div class="bg-green-50 rounded-lg p-2 text-center border border-green-100"><span class="block font-bold text-green-700 text-lg">${stats.wins}</span><span class="text-[10px] text-green-600 uppercase">Vic</span></div>
                        <div class="bg-amber-50 rounded-lg p-2 text-center border border-amber-100"><span class="block font-bold text-amber-700 text-lg">${stats.draws}</span><span class="text-[10px] text-amber-600 uppercase">Emp</span></div>
                        <div class="bg-red-50 rounded-lg p-2 text-center border border-red-100"><span class="block font-bold text-red-700 text-lg">${stats.losses}</span><span class="text-[10px] text-red-600 uppercase">Der</span></div>
                    </div>
                    <div class="space-y-2 text-sm text-gray-600 bg-gray-50 p-3 rounded-lg border border-gray-100">
                        <div class="flex justify-between"><span>Goles a Favor</span><span class="font-bold text-slate-700">${stats.gf}</span></div>
                        <div class="flex justify-between"><span>Goles en Contra</span><span class="font-bold text-slate-700">${stats.ga}</span></div>
                        <div class="flex justify-between border-t border-gray-200 pt-2 mt-2"><span class="font-medium">Diferencia</span><span class="font-bold ${gd > 0 ? 'text-green-600' : (gd < 0 ? 'text-red-600' : 'text-gray-600')}">${gd > 0 ? '+' : ''}${gd}</span></div>
                    </div>
                    <div class="mt-4 flex items-center justify-between">
                        <div class="flex items-center gap-2"><div class="text-xs font-bold text-gray-400 uppercase">Efectividad</div><div class="text-sm font-black text-slate-700">${winRate}%</div></div>
                        <div class="flex items-center gap-2"><div class="text-xs font-bold text-gray-400 uppercase">Nota Media</div><div class="px-2 py-1 bg-indigo-100 text-indigo-700 rounded font-bold text-sm">${avgRating}</div></div>
                    </div>
                </div>
            </div>
        `;
    });

    html += '</div>';
    container.innerHTML = html;
}

function renderGoalkeeperStats() {
    const container = document.getElementById('stats-goalkeepers');
    if (!container) return;

    const players = getPlayers();
    const matches = getData('matches').sort((a, b) => new Date(a.date) - new Date(b.date));
    
    // Filtrar Porteros
    const gks = players.filter(p => p.posicion === 'portero' || p.posicion === 'portera');

    if (gks.length === 0) {
        container.innerHTML = '<div class="text-center py-12 text-gray-500">No hay porteros registrados.</div>';
        return;
    }

    const stats = {};
    gks.forEach(gk => {
        stats[gk.id] = { player: gk, matches: 0, minutes: 0, conceded: 0, cleanSheets: 0, wins: 0, draws: 0, losses: 0, ratingsSum: 0, ratingsCount: 0 };
    });

    matches.forEach(m => {
        // Calcular goles encajados por el equipo en este partido
        const parts = m.result.replace('*','').split('-').map(Number);
        let ga = 0;
        if (m.venue === 'visitante') ga = parts[0];
        else ga = parts[1]; // local o neutral (asumimos formato Local-Visitante)
        
        m.playerStats.forEach(ps => {
            const gkStat = stats[ps.playerId];
            if (gkStat && (ps.played || ps.minutes > 0)) {
                gkStat.matches++;
                gkStat.minutes += ps.minutes;
                gkStat.conceded += ga;
                if (ga === 0) gkStat.cleanSheets++;
                if (m.outcome === 'victoria') gkStat.wins++;
                else if (m.outcome === 'empate') gkStat.draws++;
                else gkStat.losses++;
                if (ps.rating) { gkStat.ratingsSum += parseFloat(ps.rating); gkStat.ratingsCount++; }
            }
        });
    });

    const sortedGKs = Object.values(stats).sort((a, b) => b.matches - a.matches);
    let html = `<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">`;

    sortedGKs.forEach(s => {
        if (s.matches === 0) return;
        const avgRating = s.ratingsCount > 0 ? (s.ratingsSum / s.ratingsCount).toFixed(2) : '-';
        const concededPerMatch = (s.conceded / s.matches).toFixed(2);
        const cleanSheetPct = ((s.cleanSheets / s.matches) * 100).toFixed(0);
        
        html += `
            <div class="bg-white rounded-xl shadow-lg border border-gray-200 overflow-hidden relative">
                <div class="bg-gradient-to-r from-slate-800 to-slate-900 p-4 flex items-center gap-4">
                    <img src="${s.player.foto}" class="w-16 h-16 rounded-full object-cover border-2 border-amber-400 bg-white">
                    <div>
                        <h3 class="text-white font-bold text-lg">${s.player.apodo || s.player.apellido}</h3>
                        <p class="text-slate-400 text-xs uppercase font-bold">Portero</p>
                    </div>
                    <div class="ml-auto text-right">
                        <div class="text-2xl font-black text-amber-400">${avgRating}</div>
                        <div class="text-[10px] text-slate-400">Nota Media</div>
                    </div>
                </div>
                <div class="p-4 grid grid-cols-2 gap-4">
                    <div class="text-center p-2 bg-red-50 rounded-lg border border-red-100">
                        <div class="text-2xl font-black text-red-600">${s.conceded}</div>
                        <div class="text-xs text-red-400 font-bold uppercase">Goles Encajados</div>
                        <div class="text-[10px] text-red-300 mt-1">${concededPerMatch} por partido</div>
                    </div>
                    <div class="text-center p-2 bg-emerald-50 rounded-lg border border-emerald-100">
                        <div class="text-2xl font-black text-emerald-600">${s.cleanSheets}</div>
                        <div class="text-xs text-emerald-400 font-bold uppercase">Porter√≠as a Cero</div>
                        <div class="text-[10px] text-emerald-300 mt-1">${cleanSheetPct}% de partidos</div>
                    </div>
                </div>
                <div class="px-4 pb-4">
                    <div class="flex justify-between items-center text-sm text-gray-600 mb-1"><span>Partidos Jugados</span><span class="font-bold">${s.matches}</span></div>
                    <div class="flex justify-between items-center text-sm text-gray-600 mb-1"><span>Minutos</span><span class="font-bold">${s.minutes}'</span></div>
                    <div class="w-full bg-gray-100 rounded-full h-2 mt-2 overflow-hidden flex">
                        <div class="bg-green-500 h-full" style="width: ${(s.wins/s.matches)*100}%"></div>
                        <div class="bg-amber-400 h-full" style="width: ${(s.draws/s.matches)*100}%"></div>
                        <div class="bg-red-500 h-full" style="width: ${(s.losses/s.matches)*100}%"></div>
                    </div>
                    <div class="flex justify-between text-[10px] text-gray-400 mt-1"><span>${s.wins} V</span><span>${s.draws} E</span><span>${s.losses} D</span></div>
                </div>
            </div>
        `;
    });
    html += `</div>`;
    container.innerHTML = html;
}

function renderCanteraStats() {
    const container = document.getElementById('stats-cantera');
    if (!container) return;

    const players = getPlayers();
    const matches = getData('matches');
    
    // Filtrar Canteranos
    const canteranos = players.filter(p => p.categoria === 'Cantera');
    const firstTeam = players.filter(p => p.categoria === 'Primer Equipo' && p.posicion !== 'entrenador');

    if (canteranos.length === 0) {
        container.innerHTML = '<div class="text-center py-12 text-gray-500">No hay jugadores registrados con categor√≠a "Cantera".</div>';
        return;
    }

    // Calcular medias
    const calculateAvg = (group) => {
        let totalRating = 0, count = 0, minutes = 0, goals = 0;
        group.forEach(p => {
            matches.forEach(m => {
                const ps = m.playerStats.find(s => s.playerId === p.id);
                if (ps) {
                    if (ps.rating) { totalRating += parseFloat(ps.rating); count++; }
                    minutes += ps.minutes || 0;
                    goals += ps.goals || 0;
                }
            });
        });
        return {
            rating: count > 0 ? (totalRating / count).toFixed(2) : 0,
            minutesPerPlayer: group.length > 0 ? (minutes / group.length).toFixed(0) : 0,
            goals: goals
        };
    };

    const statsCantera = calculateAvg(canteranos);
    const statsFirstTeam = calculateAvg(firstTeam);

    // Renderizar
    let html = `
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2">üìä Impacto de La F√°brica</h3>
                <div class="space-y-4">
                    <div>
                        <div class="flex justify-between text-xs font-bold text-gray-500 mb-1"><span>Nota Media</span><span>vs Primer Equipo</span></div>
                        <div class="w-full bg-gray-100 rounded-full h-4 overflow-hidden flex">
                            <div class="bg-blue-500 h-full flex items-center justify-center text-[9px] text-white font-bold" style="width: ${(statsCantera.rating / 10) * 100}%">${statsCantera.rating}</div>
                            <div class="w-1 bg-white h-full relative"><div class="absolute -top-1 left-0 w-0.5 h-6 bg-gray-400" style="left: 0;"></div></div>
                            <div class="bg-gray-300 h-full opacity-30" style="width: ${(statsFirstTeam.rating / 10) * 100}%"></div>
                        </div>
                        <div class="text-right text-[10px] text-gray-400 mt-1">Media 1er Equipo: ${statsFirstTeam.rating}</div>
                    </div>
                    <div class="grid grid-cols-2 gap-4 mt-4">
                        <div class="bg-blue-50 p-3 rounded-lg text-center">
                            <div class="text-2xl font-black text-blue-600">${statsCantera.goals}</div>
                            <div class="text-xs text-blue-400 font-bold uppercase">Goles Cantera</div>
                        </div>
                        <div class="bg-indigo-50 p-3 rounded-lg text-center">
                            <div class="text-2xl font-black text-indigo-600">${statsCantera.minutesPerPlayer}'</div>
                            <div class="text-xs text-indigo-400 font-bold uppercase">Min/Jugador</div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="bg-gradient-to-br from-slate-800 to-slate-900 rounded-xl shadow-lg p-6 text-white relative overflow-hidden">
                <div class="absolute top-0 right-0 p-4 opacity-10 text-8xl">üéì</div>
                <h3 class="font-bold text-xl mb-2">Filosof√≠a de Club</h3>
                <p class="text-slate-300 text-sm mb-4">"La F√°brica no solo forma jugadores, forma personas."</p>
                <div class="flex items-center gap-2 text-xs font-mono text-amber-400">
                    <span class="text-2xl">‚ö°</span>
                    <span>${canteranos.length} Jugadores convocados esta temporada</span>
                </div>
            </div>
        </div>

        <h3 class="font-bold text-gray-800 mb-4">üíé Joyas de la Cantera</h3>
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
    `;

    canteranos.forEach(p => {
        // Calcular stats individuales
        let pMatches = 0, pGoals = 0, pMins = 0, pRatingSum = 0, pRatingCount = 0;
        matches.forEach(m => {
            const ps = m.playerStats.find(s => s.playerId === p.id);
            if (ps && (ps.played || ps.minutes > 0)) {
                pMatches++; pGoals += ps.goals || 0; pMins += ps.minutes || 0;
                if (ps.rating) { pRatingSum += parseFloat(ps.rating); pRatingCount++; }
            }
        });
        const pAvg = pRatingCount > 0 ? (pRatingSum / pRatingCount).toFixed(2) : '-';

        html += `
            <div class="bg-white rounded-xl border border-gray-200 p-4 flex items-center gap-4 hover:shadow-md transition-shadow cursor-pointer" onclick="viewPlayerDetails('${p.id}')">
                <div class="relative">
                    <img src="${p.foto}" class="w-14 h-14 rounded-full object-cover border-2 border-blue-100">
                    <div class="absolute -bottom-1 -right-1 bg-blue-600 text-white text-[10px] px-1.5 rounded-full font-bold shadow-sm">${pAvg}</div>
                </div>
                <div class="flex-1 min-w-0">
                    <h4 class="font-bold text-gray-800 truncate">${p.apodo || p.apellido}</h4>
                    <p class="text-xs text-gray-500">${p.posicion} ‚Ä¢ ${calculateAge(p.fechaNacimiento)} a√±os</p>
                    <div class="flex gap-2 mt-2 text-[10px] font-bold text-gray-400">
                        <span class="bg-gray-100 px-1.5 py-0.5 rounded">üèüÔ∏è ${pMatches}</span>
                        <span class="bg-gray-100 px-1.5 py-0.5 rounded">‚öΩ ${pGoals}</span>
                        <span class="bg-gray-100 px-1.5 py-0.5 rounded">‚è±Ô∏è ${pMins}'</span>
                    </div>
                </div>
            </div>
        `;
    });

    html += `</div>`;
    container.innerHTML = html;
}

// ==========================================
// 3. GALA DE PREMIOS (SEASON AWARDS)
// ==========================================
function renderSeasonAwards() {
    const container = document.getElementById('stats-awards');
    if (!container) return;

    const matches = getData('matches');
    const players = getPlayers();
    
    if (matches.length === 0) {
        container.innerHTML = '<div class="text-center py-12 text-gray-500">Juega partidos para celebrar la Gala de Premios.</div>';
        return;
    }

    // Calcular estad√≠sticas
    const stats = {};
    players.forEach(p => {
        stats[p.id] = { 
            player: p, goals: 0, assists: 0, ratingSum: 0, ratingCount: 0, 
            cleanSheets: 0, matches: 0, mvps: 0 
        };
    });

    matches.forEach(m => {
        // Clean Sheet check
        const parts = m.result.replace('*','').split('-').map(Number);
        const ga = m.venue === 'local' ? parts[1] : parts[0];
        const isCleanSheet = ga === 0;

        if (m.mvp && stats[m.mvp]) stats[m.mvp].mvps++;

        m.playerStats.forEach(ps => {
            const s = stats[ps.playerId];
            if (s && (ps.played || ps.minutes > 0)) {
                s.matches++;
                s.goals += (ps.goals || 0);
                s.assists += (ps.assists || 0);
                if (ps.rating) { s.ratingSum += parseFloat(ps.rating); s.ratingCount++; }
                if (isCleanSheet && (s.player.posicion === 'portero' || s.player.posicion === 'portera') && ps.isStarter) {
                    s.cleanSheets++;
                }
            }
        });
    });

    // Determinar Ganadores
    const getWinner = (sortFn, filterFn = () => true) => {
        const candidates = Object.values(stats).filter(s => s.matches > 0 && filterFn(s));
        candidates.sort(sortFn);
        return candidates.length > 0 ? candidates[0] : null;
    };

    const pichichi = getWinner((a, b) => b.goals - a.goals || b.matches - a.matches);
    const mvpSeason = getWinner((a, b) => (b.ratingSum/b.ratingCount) - (a.ratingSum/a.ratingCount), s => s.matches >= 5);
    const goldenBoy = getWinner((a, b) => (b.ratingSum/b.ratingCount) - (a.ratingSum/a.ratingCount), s => {
        const age = calculateAge(s.player.fechaNacimiento);
        return age < 21 && s.matches >= 3;
    });
    const zamora = getWinner((a, b) => b.cleanSheets - a.cleanSheets, s => s.player.posicion === 'portero' || s.player.posicion === 'portera');
    const assistant = getWinner((a, b) => b.assists - a.assists);

    // Render HTML
    const renderCard = (title, icon, winner, statLabel, statValue) => {
        if (!winner) return '';
        return `
            <div class="award-card rounded-xl p-6 text-center shadow-lg transform hover:scale-105 transition-transform">
                <div class="award-icon">${icon}</div>
                <h3 class="text-xl font-black text-amber-600 mb-1 uppercase tracking-widest">${title}</h3>
                <div class="w-16 h-1 bg-amber-400 mx-auto mb-4 rounded-full"></div>
                
                <div class="relative w-24 h-24 mx-auto mb-3">
                    <img src="${winner.player.foto}" class="w-full h-full rounded-full object-cover border-4 border-amber-300 shadow-md">
                    <div class="absolute -bottom-2 -right-2 bg-amber-500 text-white text-xs font-bold px-2 py-1 rounded-full border-2 border-white">
                        ${statValue}
                    </div>
                </div>
                
                <h4 class="text-lg font-bold text-gray-800">${winner.player.apodo || winner.player.apellido}</h4>
                <p class="text-xs text-gray-500 uppercase font-bold mt-1">${statLabel}</p>
            </div>
        `;
    };

    container.innerHTML = `
        <div class="text-center mb-8">
            <h2 class="text-3xl font-black text-slate-800">‚ú® GALA DE PREMIOS</h2>
            <p class="text-gray-500">Los mejores de la temporada ${currentTeam === 'masculino' ? '2025/26' : '2025/26'}</p>
        </div>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8 max-w-5xl mx-auto">
            ${renderCard('MVP Temporada', 'üëë', mvpSeason, 'Nota Media', mvpSeason ? (mvpSeason.ratingSum/mvpSeason.ratingCount).toFixed(2) : 0)}
            ${renderCard('Pichichi', 'üëü', pichichi, 'Goles', pichichi ? pichichi.goals : 0)}
            ${renderCard('Golden Boy', 'üíé', goldenBoy, 'Nota Media (<21)', goldenBoy ? (goldenBoy.ratingSum/goldenBoy.ratingCount).toFixed(2) : 0)}
            ${renderCard('Guante de Oro', 'üß§', zamora, 'Porter√≠as a 0', zamora ? zamora.cleanSheets : 0)}
            ${renderCard('Asistente', 'üéØ', assistant, 'Asistencias', assistant ? assistant.assists : 0)}
        </div>
    `;
}

function renderRecords() {
    const container = document.getElementById('stats-records');
    if (!container) return;

    const matches = getData('matches');
    const players = getPlayers();

    if (matches.length === 0) {
        container.innerHTML = '<div class="text-center py-12 text-gray-500">Juega partidos para generar el Libro de R√©cords.</div>';
        return;
    }

    let fastestGoal = { min: 999, player: null, match: null };
    let latestGoal = { min: -1, player: null, match: null };
    let youngestScorer = { age: 999, player: null, match: null, exactAge: '' };
    let oldestScorer = { age: -1, player: null, match: null, exactAge: '' };
    
    let maxGoalsMatch = { count: -1, match: null };
    let biggestWin = { diff: -1, match: null };
    
    let currentWinStreak = 0, maxWinStreak = 0;
    let currentCleanSheet = 0, maxCleanSheet = 0;

    const sortedMatches = [...matches].sort((a, b) => new Date(a.date) - new Date(b.date));

    sortedMatches.forEach(m => {
        if (m.outcome === 'victoria') currentWinStreak++;
        else currentWinStreak = 0;
        if (currentWinStreak > maxWinStreak) maxWinStreak = currentWinStreak;

        const parts = m.result.replace('*','').split('-').map(Number);
        const ga = m.venue === 'local' ? parts[1] : parts[0];
        const gf = m.venue === 'local' ? parts[0] : parts[1];
        const totalGoals = gf + ga;
        const diff = gf - ga;

        if (ga === 0) currentCleanSheet++;
        else currentCleanSheet = 0;
        if (currentCleanSheet > maxCleanSheet) maxCleanSheet = currentCleanSheet;

        if (totalGoals > maxGoalsMatch.count) maxGoalsMatch = { count: totalGoals, match: m };
        if (diff > biggestWin.diff) biggestWin = { diff: diff, match: m };

        m.playerStats.forEach(ps => {
            if (ps.detailGoals) {
                const goals = ps.detailGoals.split(',').map(s => s.trim());
                goals.forEach(gStr => {
                    const min = parseInt(gStr);
                    if (!isNaN(min)) {
                        const p = players.find(pl => pl.id === ps.playerId);
                        if (p) {
                            if (min < fastestGoal.min) fastestGoal = { min: min, player: p, match: m };
                            if (min > latestGoal.min) latestGoal = { min: min, player: p, match: m };

                            if (p.fechaNacimiento) {
                                const birth = new Date(p.fechaNacimiento);
                                const matchDate = new Date(m.date);
                                const ageInDays = (matchDate - birth) / (1000 * 60 * 60 * 24);
                                const years = Math.floor(ageInDays / 365.25);
                                const days = Math.floor(ageInDays % 365.25);
                                const exactAge = `${years}a ${days}d`;
                                
                                if (ageInDays < youngestScorer.age) youngestScorer = { age: ageInDays, player: p, match: m, exactAge };
                                if (ageInDays > oldestScorer.age) oldestScorer = { age: ageInDays, player: p, match: m, exactAge };
                            }
                        }
                    }
                });
            }
        });
    });

    const createRecordCard = (icon, title, value, subtext, colorClass) => `
        <div class="bg-white rounded-xl p-4 border border-gray-100 shadow-sm flex items-center gap-4 hover:shadow-md transition-shadow">
            <div class="w-12 h-12 rounded-full flex items-center justify-center text-2xl ${colorClass} bg-opacity-20 shrink-0">
                ${icon}
            </div>
            <div class="min-w-0">
                <p class="text-xs font-bold text-gray-400 uppercase tracking-wider truncate">${title}</p>
                <p class="text-lg font-black text-gray-800 leading-tight truncate">${value}</p>
                <p class="text-xs text-gray-500 truncate" title="${subtext}">${subtext}</p>
            </div>
        </div>
    `;

    let html = `<div class="mb-6"><h3 class="text-xl font-bold text-gray-800 flex items-center gap-2">üìú Libro de R√©cords <span class="text-sm font-normal text-gray-500 bg-gray-100 px-2 py-1 rounded">Hitos de la Temporada</span></h3></div><div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">`;

    if (fastestGoal.player) html += createRecordCard('‚ö°', 'Gol m√°s R√°pido', `${fastestGoal.min}'`, `${fastestGoal.player.apodo} vs ${fastestGoal.match.opponent}`, 'bg-yellow-500 text-yellow-600');
    if (latestGoal.player) html += createRecordCard('‚è±Ô∏è', 'Gol m√°s Tard√≠o', `${latestGoal.min}'`, `${latestGoal.player.apodo} vs ${latestGoal.match.opponent}`, 'bg-gray-500 text-gray-600');
    if (maxWinStreak > 0) html += createRecordCard('üî•', 'Mejor Racha Victorias', `${maxWinStreak}`, `Partidos consecutivos`, 'bg-green-500 text-green-600');
    if (maxCleanSheet > 0) html += createRecordCard('üß±', 'Muro Defensivo', `${maxCleanSheet}`, `Partidos seguidos sin encajar`, 'bg-blue-500 text-blue-600');
    if (maxGoalsMatch.match) html += createRecordCard('üçø', 'Partido con m√°s Goles', `${maxGoalsMatch.count}`, `${maxGoalsMatch.match.result} vs ${maxGoalsMatch.match.opponent}`, 'bg-purple-500 text-purple-600');
    if (biggestWin.match) html += createRecordCard('üöÄ', 'Mayor Goleada', `+${biggestWin.diff}`, `${biggestWin.match.result} vs ${biggestWin.match.opponent}`, 'bg-red-500 text-red-600');
    if (youngestScorer.player) html += createRecordCard('üë∂', 'Goleador m√°s Joven', `${youngestScorer.exactAge}`, `${youngestScorer.player.apodo}`, 'bg-pink-500 text-pink-600');
    if (oldestScorer.player) html += createRecordCard('üë¥', 'Goleador m√°s Veterano', `${oldestScorer.exactAge}`, `${oldestScorer.player.apodo}`, 'bg-indigo-500 text-indigo-600');

    html += `</div>`;
    container.innerHTML = html;
}

        // ===============================================
        // FUNCI√ìN PARA LIMPIAR EMOJIS DE TEXTO
        // ===============================================
        function cleanText(text) {
    if (!text) return "";
    // \p{Extended_Pictographic} busca cualquier s√≠mbolo gr√°fico/emoji
    // La bandera 'u' (unicode) es OBLIGATORIA para que esto funcione
    return text.replace(/\p{Extended_Pictographic}/gu, '').trim();
}

                /* ========================================================= */
        /* üìà RENDERIZAR GR√ÅFICOS (TODOS EN UNO) - VERSI√ìN FINAL       */
        /* ========================================================= */
        let evolutionChart = null;
        let goalsPositionChart = null;
        let goalsTimingChart = null;

        function renderCharts(filteredMatches) {
            const players = getPlayers();
            const isDark = document.body.classList.contains('dark-mode');
            const textColor = isDark ? '#e2e8f0' : '#4b5563';
            const gridColor = isDark ? '#334155' : '#e5e7eb';
            
            // --- GR√ÅFICO 1: AN√ÅLISIS DE TEMPORADA (L√çNEA) ---
            const wrapper = document.getElementById('stats-charts-wrapper');
            if (wrapper) {
                wrapper.innerHTML = `<div class="relative h-60 w-full"><canvas id="chart-season-evolution"></canvas></div>`;
                const evoCtx = document.getElementById('chart-season-evolution');

                if (evoCtx) {
                    const sortedMatches = [...filteredMatches].sort((a, b) => new Date(a.date) - new Date(b.date));
                    const labels = sortedMatches.map(m => cleanText(m.opponent).substring(0, 3).toUpperCase());
                    
                    const ratings = sortedMatches.map(m => {
                        let total = 0, count = 0;
                        if(m.playerStats) {
                            m.playerStats.forEach(ps => {
                                if (ps.rating) { total += parseFloat(ps.rating); count++; }
                            });
                        }
                        return count > 0 ? (total / count).toFixed(2) : null;
                    });

                    if (evolutionChart) evolutionChart.destroy();
                    evolutionChart = new Chart(evoCtx, {
                        type: 'line',
                        data: {
                            labels: labels,
                            datasets: [{
                                label: 'Nota Media Equipo',
                                data: ratings,
                                borderColor: '#6366f1',
                                backgroundColor: 'rgba(99, 102, 241, 0.1)',
                                tension: 0.3,
                                fill: true,
                                pointBackgroundColor: '#fff',
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: {
                                legend: { display: false },
                                // ‚úÖ MEJORA: A√ëADIMOS EL CALLBACK DEL TOOLTIP
                                tooltip: {
                                    callbacks: {
                                        title: function(context) {
                                            const index = context[0].dataIndex;
                                            const fullOpponentName = sortedMatches[index].opponent;
                                            return cleanText(fullOpponentName); // Devuelve el nombre completo limpio
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: { min: 4, max: 10, grid: { color: gridColor }, ticks: { color: textColor } },
                                x: { grid: { display: false }, ticks: { color: textColor, font: { size: 9 } } }
                            }
                        }
                    });
                }
            }

            // --- GR√ÅFICO 2: ADN DEL EQUIPO (DONUT) ---
            const posCtx = document.getElementById('chart-goals-position');
            if (posCtx) {
                const goalsByPos = { 'Delantera': 0, 'Centrocampista': 0, 'Defensa': 0 };
                let totalGoals = 0;

                filteredMatches.forEach(m => {
                    if(m.playerStats) {
                        m.playerStats.forEach(ps => {
                            const p = players.find(pl => pl.id === ps.playerId);
                            if (p && ps.goals > 0) {
                                totalGoals += ps.goals;
                                if (p.posicion === 'delantero' || p.posicion === 'extremo') goalsByPos['Delantera'] += ps.goals;
                                else if (p.posicion === 'centrocampista') goalsByPos['Centrocampista'] += ps.goals;
                                else if (p.posicion === 'defensa') goalsByPos['Defensa'] += ps.goals;
                            }
                        });
                    }
                });

                if (goalsPositionChart) goalsPositionChart.destroy();
                
                if (totalGoals === 0) {
                    const ctx = posCtx.getContext('2d');
                    ctx.clearRect(0, 0, posCtx.width, posCtx.height);
                    ctx.font = "14px Inter"; ctx.textAlign = 'center'; ctx.fillStyle = textColor;
                    ctx.fillText("Sin goles registrados.", posCtx.width / 2, posCtx.height / 2);
                } else {
                    goalsPositionChart = new Chart(posCtx, {
                        type: 'doughnut',
                        data: {
                            labels: Object.keys(goalsByPos),
                            datasets: [{
                                data: Object.values(goalsByPos),
                                backgroundColor: ['#ef4444', '#10b981', '#3b82f6'],
                                borderColor: isDark ? '#1e293b' : '#fff',
                                borderWidth: 4, hoverOffset: 8
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: {
                                legend: { position: 'bottom', labels: { color: textColor } },
                                tooltip: { callbacks: { label: (c) => ` ${c.raw} Goles` } }
                            }
                        }
                    });
                }
            }

            // --- GR√ÅFICO 3: ZONA CESARINI (BARRAS) ---
            const timeCtx = document.getElementById('chart-goals-minutes');
            if(timeCtx) {
                const timingBuckets = { '0-15': 0, '16-30': 0, '31-45+': 0, '46-60': 0, '61-75': 0, '76-90+': 0 };
                let totalTimedGoals = 0;
                
                filteredMatches.forEach(m => {
                    if(m.playerStats) {
                        m.playerStats.forEach(ps => {
                            if (ps.detailGoals) {
                                ps.detailGoals.split(',').map(s => s.trim()).filter(Boolean).forEach(g => {
                                    totalTimedGoals++;
                                    let min = parseInt(g);
                                    if (!isNaN(min)) {
                                        if (min <= 15) timingBuckets['0-15']++;
                                        else if (min <= 30) timingBuckets['16-30']++;
                                        else if (min <= 45 || g.includes('+')) timingBuckets['31-45+']++;
                                        else if (min <= 60) timingBuckets['46-60']++;
                                        else if (min <= 75) timingBuckets['61-75']++;
                                        else timingBuckets['76-90+']++;
                                    }
                                });
                            }
                        });
                    }
                });

                if (goalsTimingChart) goalsTimingChart.destroy();
                
                if (totalTimedGoals === 0) {
                     const ctx = timeCtx.getContext('2d');
                     ctx.clearRect(0, 0, timeCtx.width, timeCtx.height);
                     ctx.font = "14px Inter"; ctx.textAlign = 'center'; ctx.fillStyle = textColor;
                     ctx.fillText("No hay minutos de gol detallados.", timeCtx.width / 2, (timeCtx.height / 2));
                } else {
                    goalsTimingChart = new Chart(timeCtx, {
                        type: 'bar',
                        data: {
                            labels: Object.keys(timingBuckets),
                            datasets: [{
                                label: 'Goles marcados',
                                data: Object.values(timingBuckets),
                                backgroundColor: 'rgba(99, 102, 241, 0.8)',
                                borderRadius: 5
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: {
                                y: { beginAtZero: true, ticks: { stepSize: 1, color: textColor } },
                                x: { ticks: { color: textColor } }
                            }
                        }
                    });
                }
            }
        }





// --- FUNCI√ìN AUXILIAR PARA DIBUJAR LA MATRIZ ---
        // --- FUNCI√ìN AUXILIAR PARA DIBUJAR LA MATRIZ (CON NOTA MEDIA DE TEMPORADA) ---
function renderPerformanceMatrix(matches) {
    // 1. Buscar o Crear el contenedor
    let container = document.getElementById('performance-matrix-container');
    if (!container) {
        const chartsSection = document.getElementById('chart-season-evolution')?.closest('.bg-white') || document.getElementById('charts-view');
        if (chartsSection && chartsSection.parentNode) {
            container = document.createElement('div');
            container.id = 'performance-matrix-container';
            container.className = 'mt-6 bg-white p-4 rounded-xl shadow-sm border border-gray-200';
            chartsSection.parentNode.insertBefore(container, chartsSection.nextSibling);
        } else {
            return; 
        }
    }

    // 2. Agrupar partidos y CALCULAR MEDIA GLOBAL
    const matchesByComp = {};
    let globalSum = 0;
    let globalCount = 0;

    matches.forEach(m => {
        // --- C√°lculo de media para este partido ---
        let matchTotal = 0, matchPCount = 0;
        m.playerStats.forEach(ps => {
            if (ps.rating) {
                matchTotal += parseFloat(ps.rating);
                matchPCount++;
            }
        });
        
        if (matchPCount > 0) {
            const matchAvg = matchTotal / matchPCount;
            globalSum += matchAvg;
            globalCount++;
        }
        // -----------------------------------------

        let compName = m.competition;
        if (typeof COMPETICIONES_ACTUALES !== 'undefined') {
            const key = Object.keys(COMPETICIONES_ACTUALES).find(k => 
                k === m.competition || COMPETICIONES_ACTUALES[k].nombre === m.competition
            );
            if (key) compName = COMPETICIONES_ACTUALES[key].nombre; 
        }
        
        if (!matchesByComp[compName]) matchesByComp[compName] = [];
        matchesByComp[compName].push(m);
    });

    // Calcular nota final de temporada
    const seasonAvg = globalCount > 0 ? (globalSum / globalCount).toFixed(2) : '-';
    const seasonColor = getTeamRatingColor(seasonAvg);

    // 3. Generar HTML
    // He modificado el header para incluir la nota media
    let html = `
        <div class="mb-4 flex flex-wrap items-center justify-between gap-2">
            <div class="flex items-center gap-3">
                <h3 class="font-bold text-gray-700 text-sm uppercase tracking-wide">üìä Matriz de Rendimiento</h3>
                
                <div class="px-3 py-1 rounded-lg text-white font-bold text-sm shadow-sm flex items-center gap-2" 
                     style="background-color: ${seasonColor}">
                    <span>Nota Temp:</span>
                    <span class="text-lg">${seasonAvg}</span>
                </div>
            </div>

            <div class="flex gap-1 text-[10px] text-gray-400">
                <span class="px-1 rounded bg-[#dc0c00] text-white">Bad</span>
                <span class="px-1 rounded bg-[#d9af00] text-white">Avg</span>
                <span class="px-1 rounded bg-[#00c424] text-white">Good</span>
                <span class="px-1 rounded bg-[#00adc4] text-white">Top</span>
            </div>
        </div>
        <div class="space-y-3 overflow-x-auto">
    `;

    Object.keys(matchesByComp).forEach(comp => {
        const compMatches = matchesByComp[comp];
        
        html += `
            <div class="flex flex-col md:flex-row md:items-center gap-2">
                <div class="w-full md:w-32 shrink-0">
                    <span class="text-xs font-bold text-gray-600 truncate block" title="${comp}">${comp}</span>
                </div>
                <div class="flex-1 flex flex-wrap gap-1">
        `;

        compMatches.forEach(m => {
            let total = 0, count = 0;
            m.playerStats.forEach(ps => {
                if (ps.rating) {
                    total += parseFloat(ps.rating);
                    count++;
                }
            });
            
            const avgRating = count > 0 ? (total / count).toFixed(1) : '-';
            const color = getTeamRatingColor(avgRating);
            const isWin = m.outcome === 'victoria';
            const isLoss = m.outcome === 'derrota';
            const borderColor = isWin ? 'border-amber-400' : (isLoss ? 'border-red-200' : 'border-gray-200');

            html += `
                <div onclick="viewMatchDetails('${m.id}')" 
                     class="w-8 h-8 rounded flex items-center justify-center cursor-pointer transition-transform hover:scale-110 hover:z-10 border ${borderColor}"
                     style="background-color: ${color}; color: white;"
                     title="${m.date} vs ${m.opponent}\nNota Equipo: ${avgRating}\nResultado: ${m.result}">
                    <span class="text-[10px] font-bold">${avgRating}</span>
                </div>
            `;
        });

        html += `
                </div>
            </div>
        `;
    });

    html += `</div>`;
    container.innerHTML = html;
}

        // ==========================================
        // ADVANCED STATISTICS
        // ==========================================

        function renderAdvancedStats() {
            renderLineWarsChart();
            renderMinutesChart();
            renderTierList();
            renderGoalConnections();
            setTimeout(() => {
        if(typeof updateCompetitionChart === 'function') updateCompetitionChart();
        if(typeof updateVictoryStyleChart === 'function') updateVictoryStyleChart();
        if(typeof renderGoalsAssistsScatter === 'function') renderGoalsAssistsScatter();
        if(typeof renderStreakChart === 'function') renderStreakChart();
        if(typeof renderDependencyChart === 'function') renderDependencyChart();
        if(typeof renderFactorXChart === 'function') renderFactorXChart();
        if(typeof renderFormWaves === 'function') renderFormWaves();
        if(typeof renderNetworkWidget === 'function')renderNetworkWidget();
        if(typeof renderUnifiedConnections === 'function')renderUnifiedConnections();

    }, 100);
            const matches = getData('matches');
            const players = getPlayers();

            // 2. Heatmap
            const zones = {
                'delantero': { total: 0, count: 0, label: 'Delantera', color: 'bg-red-500' },
                'centrocampista': { total: 0, count: 0, label: 'Medio', color: 'bg-green-500' },
                'defensa': { total: 0, count: 0, label: 'Defensa', color: 'bg-blue-500' },
                'portero': { total: 0, count: 0, label: 'Porter√≠a', color: 'bg-amber-400' }
            };

            matches.forEach(m => {
                m.playerStats.forEach(ps => {
                    const p = players.find(pl => pl.id === ps.playerId);
                    if (p && zones[p.posicion] && ps.rating) {
                        zones[p.posicion].total += parseFloat(ps.rating);
                        zones[p.posicion].count++;
                    }
                });
            });

            const getHeatColor = (avg) => {
                if (avg >= 8) return 'bg-emerald-600';
                if (avg >= 7) return 'bg-emerald-500';
                if (avg >= 6) return 'bg-yellow-500';
                return 'bg-red-500';
            };

            let heatmapHtml = '';
            // Order: Portero at bottom? No, typically pitch: Forward -> Mid -> Def -> GK
            ['delantero', 'centrocampista', 'defensa', 'portero'].forEach(pos => {
                const z = zones[pos];
                const avg = z.count > 0 ? (z.total / z.count).toFixed(2) : '-';
                const colorClass = z.count > 0 ? getHeatColor(parseFloat(avg)) : 'bg-gray-300';
                heatmapHtml += `
                    <div class="heatmap-zone ${colorClass}">
                        <span class="heatmap-val">${avg}</span>
                        <span class="heatmap-label">${z.label}</span>
                    </div>
                `;
            });
            document.getElementById('heatmap-container').innerHTML = heatmapHtml;

            // 3. Monthly Report
            const monthlyData = {};
            matches.forEach(m => {
                const date = new Date(m.date);
                const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                if (!monthlyData[key]) monthlyData[key] = { matches: [], wins: 0, draws: 0, losses: 0, gf: 0, ga: 0, totalRating: 0, ratingCount: 0 };
                
                const md = monthlyData[key];
                md.matches.push(m);
                if (m.outcome === 'victoria') md.wins++;
                else if (m.outcome === 'empate') md.draws++;
                else md.losses++;

                const parts = m.result.replace('*','').split('-').map(Number);
                if(m.venue === 'local') { md.gf += parts[0]; md.ga += parts[1]; }
                else if(m.venue === 'visitante') { md.gf += parts[1]; md.ga += parts[0]; }
                else { md.gf += parts[0]; md.ga += parts[1]; }

                m.playerStats.forEach(ps => {
                    if (ps.rating) { md.totalRating += parseFloat(ps.rating); md.ratingCount++; }
                });
            });

            const sortedMonths = Object.keys(monthlyData).sort().reverse();
            document.getElementById('monthly-report-body').innerHTML = sortedMonths.map(key => {
                const d = monthlyData[key];
                const monthName = new Date(key + '-01').toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
                const avg = d.ratingCount > 0 ? (d.totalRating / d.ratingCount).toFixed(2) : '-';
                return `
                    <tr class="border-t hover:bg-slate-50">
                        <td class="px-4 py-2 capitalize font-medium text-gray-700">${monthName}</td>
                        <td class="px-4 py-2 text-center text-gray-600">${d.matches.length}</td>
                        <td class="px-4 py-2 text-center text-gray-600 font-mono">${d.wins}-${d.draws}-${d.losses}</td>
                        <td class="px-4 py-2 text-center text-gray-600 font-mono">${d.gf} / ${d.ga}</td>
                        <td class="px-4 py-2 text-center font-bold ${getRatingColor(avg)}">${avg}</td>
                    </tr>
                `;
            }).join('');
            renderRatingHistogram();
        }

        // ==========================================
        // H2H STATISTICS
        // ==========================================

        function populateH2HOpponents() {
            const matches = getData('matches');
            const opponents = [...new Set(matches.map(m => m.opponent))].sort();
            const select = document.getElementById('h2h-opponent-select');
            select.innerHTML = '<option value="">Selecciona rival...</option>' + 
                opponents.map(op => `<option value="${op}">${op}</option>`).join('');
        }

        function renderH2H() {
    const opponent = document.getElementById('h2h-opponent-select').value;
    const container = document.getElementById('h2h-content');
    
    if (!opponent) {
        container.classList.add('hidden');
        return;
    }
    let matches = getData('matches').filter(m => m.opponent === opponent);
    matches.sort((a, b) => new Date(b.date) - new Date(a.date));
    const players = getPlayers();

    let wins = 0, draws = 0, losses = 0, gf = 0, ga = 0;
    let biggestWin = null, maxDiff = 0;
    let worstLoss = null, minDiff = 0;
    const playerPerfs = {};

    matches.forEach(m => {
        const parts = m.result.replace('*','').split('-').map(Number);
        let localGoals, awayGoals;
        if (m.venue === 'local') {
            localGoals = parts[0];
            awayGoals = parts[1];
        } else {
            localGoals = parts[1];
            awayGoals = parts[0];
        }

        const diff = localGoals - awayGoals;

        if (m.outcome === 'victoria') {
            wins++;
            if (diff > maxDiff) {
                maxDiff = diff;
                biggestWin = m;
            }
        }
        else if (m.outcome === 'empate') draws++;
        else {
            losses++;
            if (diff < minDiff) {
                minDiff = diff;
                worstLoss = m;
            }
        }

        gf += localGoals;
        ga += awayGoals;

        m.playerStats.forEach(ps => {
            if (!playerPerfs[ps.playerId]) playerPerfs[ps.playerId] = { goals: 0, rating: 0, count: 0, name: '' };
            const pp = playerPerfs[ps.playerId];
            pp.goals += ps.goals || 0;
            if (ps.rating) { pp.rating += parseFloat(ps.rating); pp.count++; }
        });
    });

    let topScorer = { id: null, val: -1 };
    let bestRated = { id: null, val: -1 };

    Object.entries(playerPerfs).forEach(([pid, data]) => {
        if (data.goals > topScorer.val) topScorer = { id: pid, val: data.goals };
        const avg = data.count > 0 ? data.rating / data.count : 0;
        if (avg > bestRated.val && data.count > 0) bestRated = { id: pid, val: avg };
    });

    const scorerP = topScorer.id ? players.find(p => p.id === topScorer.id) : null;
    const ratedP = bestRated.id ? players.find(p => p.id === bestRated.id) : null;
    const lastMatch = matches.length > 0 ? matches[0] : null;

    container.innerHTML = `
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="bg-slate-800 text-white p-4 rounded-xl text-center shadow-md">
                <p class="text-slate-400 text-sm">Balance</p>
                <p class="text-2xl font-bold">${wins}V - ${draws}E - ${losses}D</p>
                <p class="text-xs text-slate-400 mt-1">${gf} Goles Favor - ${ga} Contra</p>
            </div>
            ${scorerP ? `
            <div class="bg-white border border-gray-200 p-4 rounded-xl flex items-center gap-3 shadow-sm">
                <img src="${scorerP.foto}" class="w-12 h-12 rounded-full object-top">
                <div>
                    <p class="text-xs text-gray-500 uppercase font-bold">Goleador</p>
                    <p class="font-bold text-gray-800">${scorerP.nombre}</p>
                    <p class="text-sm text-green-600 font-bold">${topScorer.val} Goles</p>
                </div>
            </div>` : ''}
            ${ratedP ? `
            <div class="bg-white border border-gray-200 p-4 rounded-xl flex items-center gap-3 shadow-sm">
                <img src="${ratedP.foto}" class="w-12 h-12 rounded-full object-top">
                <div>
                    <p class="text-xs text-gray-500 uppercase font-bold">Mejor Valoraci√≥n</p>
                    <p class="font-bold text-gray-800">${ratedP.nombre}</p>
                    <p class="text-sm text-blue-600 font-bold">${bestRated.val.toFixed(2)} Nota Media</p>
                </div>
            </div>` : ''}
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
            ${lastMatch ? `
            <div class="bg-gray-50 p-3 rounded-xl border border-gray-200">
                <p class="text-xs text-gray-500 uppercase font-bold mb-1">√öltimo Enfrentamiento</p>
                <div class="flex justify-between items-center">
                    <span class="font-bold text-gray-800">${formatDate(lastMatch.date)}</span>
                    <span class="font-black text-lg ${getResultClass(lastMatch.outcome).replace('bg-', 'text-')}">${lastMatch.result}</span>
                </div>
            </div>` : ''}
            ${biggestWin ? `
            <div class="bg-gray-50 p-3 rounded-xl border border-gray-200">
                <p class="text-xs text-gray-500 uppercase font-bold mb-1">Mayor Goleada</p>
                <div class="flex justify-between items-center">
                    <span class="font-bold text-gray-800">${formatDate(biggestWin.date)}</span>
                    <span class="font-black text-lg text-green-600">${biggestWin.result}</span>
                </div>
            </div>` : ''}
            ${worstLoss ? `
            <div class="bg-gray-50 p-3 rounded-xl border border-gray-200">
                <p class="text-xs text-gray-500 uppercase font-bold mb-1">Peor Derrota</p>
                <div class="flex justify-between items-center">
                    <span class="font-bold text-gray-800">${formatDate(worstLoss.date)}</span>
                    <span class="font-black text-lg text-red-600">${worstLoss.result}</span>
                </div>
            </div>` : ''}
        </div>
        
        <h4 class="font-bold text-gray-800 mt-4">Partidos jugados</h4>
        <div class="space-y-2">
            ${matches.map(m => `
                <div class="bg-gray-50 p-3 rounded-lg flex justify-between items-center text-sm border border-gray-100">
                    <span>${formatDate(m.date)} (${m.competition})</span>
                    <span class="font-bold ${getResultClass(m.outcome).replace('bg-', 'text-')}">${m.venue === 'local' ? 'Local' : 'Visitante'}: ${m.result}</span>
                </div>
            `).join('')}
        </div>
    `;
    container.classList.remove('hidden');
}

        
        function exportStats() {
            const matches = getData('matches');
            const players = getPlayers();
            
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "ID,Nombre,Dorsal,Posicion,Estado,Partidos Jugados,Minutos,Goles,Asistencias,G/A,Nota Media,Tarjetas Amarillas,Tarjetas Rojas,MVPs,Victorias,Empates,Derrotas\n";

            players.forEach(player => {
                const stats = { matchesPlayed: 0, minutes: 0, goals: 0, assists: 0, totalRating: 0, ratingCount: 0, yellow: 0, red: 0, mvp: 0, wins: 0, draws: 0, losses: 0 };
                matches.forEach(m => {
                    const ps = m.playerStats?.find(s => String(s.playerId) === String(player.id));
                    if (ps) {
                        stats.matchesPlayed++;
                        stats.minutes += ps.minutes || 0;
                        stats.goals += ps.goals || 0;
                        stats.assists += ps.assists || 0;
                        stats.yellow += ps.yellowCards || 0;
                        stats.red += ps.redCards || 0;
                        // FIX: Ensure 0 is counted
                        if (ps.rating !== null && ps.rating !== "" && ps.rating !== undefined) { stats.totalRating += ps.rating; stats.ratingCount++; }
                        if (m.outcome === 'victoria') stats.wins++;
                        else if (m.outcome === 'empate') stats.draws++;
                        else if (m.outcome === 'derrota') stats.losses++;
                    }
                    if (String(m.mvp) === String(player.id)) stats.mvp++;
                });

                const avgRating = stats.ratingCount > 0 ? (stats.totalRating / stats.ratingCount).toFixed(2) : '0';
                const ga = stats.goals + stats.assists;
                const row = [player.id, `${player.nombre} ${player.apellido}`, player.dorsal, player.posicion, player.estado, stats.matchesPlayed, stats.minutes, stats.goals, stats.assists, ga, avgRating, stats.yellow, stats.red, stats.mvp, stats.wins, stats.draws, stats.losses].join(",");
                csvContent += row + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `real_madrid_${currentTeam}_stats.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        // ==========================================
        // PRINCIPAL / DASHBOARD LOGIC
        // ==========================================
        
        function renderClubTrophies() {
            const container = document.getElementById('club-trophies-container');
            if (!container) return;

            const matches = getData('matches');
            const state = getCompetitionState();
            const trophies = [];

            // 1. Detectar victorias en FINALES (Copa, Champions, Supercopa, Mundial)
            matches.forEach(m => {
                if (m.roundId === 'final' && m.outcome === 'victoria') {
                    trophies.push({ name: m.competition, icon: 'üèÜ' });
                }
            });

            // 2. Detectar LIGAS (Marcadas manualmente)
            Object.entries(state).forEach(([compName, data]) => {
                if (data.champion) {
                    // Evitar duplicados si por error hay final y marca manual (raro en liga, pero por seguridad)
                    if (!trophies.some(t => t.name === compName)) {
                        trophies.push({ name: compName, icon: 'üõ°Ô∏è' });
                    }
                }
            });

            if (trophies.length === 0) {
                container.classList.add('hidden');
                return;
            }

            container.classList.remove('hidden');
            container.innerHTML = `
                <div class="bg-gradient-to-r from-yellow-50 to-amber-100 border border-amber-200 rounded-xl p-5 mb-6 shadow-sm relative overflow-hidden">
                    <div class="absolute -right-6 -top-6 text-amber-300 opacity-20 text-9xl rotate-12 select-none">üèÜ</div>
                    <div class="relative z-10">
                        <h3 class="text-amber-900 font-black text-lg mb-1 flex items-center gap-2"><span>üèõÔ∏è</span> PALMAR√âS DE LA TEMPORADA</h3>
                        <p class="text-amber-700/70 text-xs font-medium mb-4">T√≠tulos oficiales conquistados</p>
                        <div class="flex flex-wrap gap-4">
                            ${trophies.map(t => `
                                <div class="bg-white/90 backdrop-blur-sm pl-3 pr-5 py-2 rounded-xl border border-amber-200 shadow-sm flex items-center gap-3 animate-in zoom-in duration-500 hover:scale-105 transition-transform cursor-default">
                                    <div class="w-10 h-10 rounded-full bg-gradient-to-br from-yellow-300 to-amber-500 flex items-center justify-center text-xl shadow-inner border-2 border-white">${t.icon}</div>
                                    <div><p class="text-[10px] text-amber-600 font-black uppercase tracking-widest">CAMPE√ìN</p><p class="font-bold text-slate-800 leading-none text-sm">${t.name}</p></div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
        }

        function renderPrincipal() {
            const matches = getData('matches');
            const players = getPlayers();
            const now = new Date();

            // 1. PR√ìXIMO RIVAL (Desde Calendario)
            // Filtramos eventos futuros y ordenamos por fecha
           // ... (dentro de renderPrincipal) ...

            // 1. PR√ìXIMO RIVAL
            const futureEvents = calendarEvents
                .filter(e => e.start > now)
                .sort((a, b) => a.start - b.start);
            
            const nextMatchContainer = document.getElementById('dashboard-next-match');
            const aiCard = document.getElementById('ai-prediction-card'); // Referencia a la tarjeta IA
            
            if (futureEvents.length > 0) {
                // --- HAY DATOS: MOSTRAR TODO ---
                const next = futureEvents[0];
                const dateStr = next.start.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
                const timeStr = next.start.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                const compName = next.possibleCompetition || 'Partido Oficial';
                
                nextMatchContainer.innerHTML = `
                    <div class="flex flex-col animate-in fade-in zoom-in duration-300">
                        <span class="text-2xl font-bold text-slate-800 truncate" title="${next.opponent}">${next.opponent}</span>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="text-xs font-semibold bg-amber-100 text-amber-800 px-2 py-0.5 rounded">${compName}</span>
                            <span class="text-xs text-gray-500">${next.venue === 'local' ? 'üè† Casa' : '‚úàÔ∏è Fuera'}</span>
                        </div>
                        <div class="mt-3 flex items-center gap-2 text-sm font-medium text-slate-600">
                            <span>üïí ${dateStr} - ${timeStr}</span>
                        </div>
                        <p class="text-xs text-gray-400 mt-1 truncate">üèüÔ∏è ${next.location || 'Estadio'}</p>
                    </div>
                `;
                
                // Mostrar y calcular IA ahora que tenemos datos
                renderAIPrediction(); 

            } else {
                // --- NO HAY DATOS A√öN: MOSTRAR CARGANDO ---
                // Si la lista est√° vac√≠a, asumimos que est√° cargando
                if (calendarEvents.length === 0) {
                    nextMatchContainer.innerHTML = `
                        <div class="py-4 text-center calendar-loading">
                            <div class="text-2xl mb-2">‚è≥</div>
                            <p class="text-slate-500 font-medium text-sm">Cargando calendario...</p>
                        </div>`;
                    aiCard.classList.add('hidden'); // Ocultar IA mientras carga
                } else {
                    // Si la lista NO est√° vac√≠a pero no hay futuros, es fin de temporada
                    nextMatchContainer.innerHTML = `
                        <div class="py-2">
                            <p class="text-slate-600 font-medium">No hay partidos pr√≥ximos.</p>
                            <p class="text-xs text-gray-400">Fin de temporada o par√≥n.</p>
                        </div>`;
                    aiCard.classList.add('hidden');
                }
            }

            // 2. FORMA DEL EQUIPO (L√≥gica copiada y adaptada)
            const last5Matches = [...matches].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5).reverse(); // Orden cronol√≥gico para la racha
            const formContainer = document.getElementById('dashboard-form');
            
            if (last5Matches.length > 0) {
                formContainer.innerHTML = last5Matches.map(m => {
                    let color = 'bg-gray-400';
                    let letter = 'E';
                    if (m.outcome === 'victoria') { color = 'bg-green-500'; letter = 'V'; }
                    else if (m.outcome === 'derrota') { color = 'bg-red-500'; letter = 'D'; }
                    
                    return `<div class="${color} text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm shadow-sm" title="${m.opponent} (${m.result})">${letter}</div>`;
                }).join('');
            } else {
                formContainer.innerHTML = '<span class="text-gray-400 text-sm italic">Sin partidos jugados</span>';
            }

            // 3. RESUMEN TEMPORADA
            let wins = 0, draws = 0, losses = 0, gf = 0, ga = 0;
            matches.forEach(m => {
                if (m.outcome === 'victoria') wins++;
                else if (m.outcome === 'empate') draws++;
                else losses++;
                
                if (m.result && m.result.includes('-')) {
                    const parts = m.result.replace('*','').split('-').map(Number);
                    if (m.venue === 'local') { gf += parts[0]; ga += parts[1]; }
                    else if (m.venue === 'visitante') { gf += parts[1]; ga += parts[0]; }
                    else { gf += parts[0]; ga += parts[1]; }
                }
            });
            document.getElementById('dash-wins').textContent = wins;
            document.getElementById('dash-draws').textContent = draws;
            document.getElementById('dash-losses').textContent = losses;
            document.getElementById('dash-gf').textContent = gf;
            document.getElementById('dash-ga').textContent = ga;

            // 4. √öLTIMOS 3 RESULTADOS
            const last3 = [...matches].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 3);
            const resultsContainer = document.getElementById('dashboard-last-results');
            
            if (last3.length > 0) {
                resultsContainer.innerHTML = last3.map(m => {
                    const outcomeColor = m.outcome === 'victoria' ? 'text-green-600' : (m.outcome === 'derrota' ? 'text-red-600' : 'text-amber-600');
                    return `
                    <div class="px-5 py-3 hover:bg-gray-50 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-1 h-8 rounded-full ${m.outcome === 'victoria' ? 'bg-green-500' : (m.outcome === 'derrota' ? 'bg-red-500' : 'bg-amber-500')}"></div>
                            <div>
                                <p class="font-bold text-gray-800 text-sm">${m.opponent}</p>
                                <p class="text-xs text-gray-500">${m.competition}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="font-bold text-lg ${outcomeColor}">${m.result}</span>
                            <p class="text-xs text-gray-400">${formatDate(m.date)}</p>
                        </div>
                    </div>`;
                }).join('');
            } else {
                resultsContainer.innerHTML = '<div class="p-5 text-gray-500 text-sm text-center">No hay partidos registrados a√∫n.</div>';
            }

            // 5. L√çDERES (Calculados al vuelo)
            // Estructura para contadores
            const stats = {};
            players.forEach(p => stats[p.id] = { 
                name: p.apodo || p.apellido,
                img: p.foto,
                goals: 0, 
                assists: 0, 
                mvps: 0,
                totalRating: 0,
                ratingCount: 0
            });

            matches.forEach(m => {
                if (stats[m.mvp]) stats[m.mvp].mvps++;
                m.playerStats.forEach(ps => {
                    if (stats[ps.playerId]) {
                        stats[ps.playerId].goals += (ps.goals || 0);
                        stats[ps.playerId].assists += (ps.assists || 0);
                        if (ps.rating) {
                            stats[ps.playerId].totalRating += parseFloat(ps.rating);
                            stats[ps.playerId].ratingCount++;
                        }
                    }
                });
            });

            // Encontrar m√°ximos
            let topG = { id: null, val: -1 }, topA = { id: null, val: -1 }, topM = { id: null, val: -1 }, topR = { id: null, val: -1 };

            Object.entries(stats).forEach(([id, s]) => {
                const avg = s.ratingCount > 0 ? (s.totalRating / s.ratingCount) : 0;
                
                if (s.goals > topG.val) topG = { id, val: s.goals, ...s };
                if (s.assists > topA.val) topA = { id, val: s.assists, ...s };
                if (s.mvps > topM.val) topM = { id, val: s.mvps, ...s };
                if (avg > topR.val && s.ratingCount >= 2) topR = { id, val: avg, ...s }; // M√≠nimo 2 partidos para nota media
            });

            // Renderizar L√≠deres
            const renderLeaderRow = (label, icon, data, isRating = false) => {
                if (!data.id || data.val <= 0) return '';
                const valDisplay = isRating ? data.val.toFixed(2) : data.val;
                return `
                <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg border border-gray-100">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center text-lg shadow-sm border border-gray-100">${icon}</div>
                        <div>
                            <p class="text-xs font-bold text-gray-500 uppercase">${label}</p>
                            <p class="text-sm font-bold text-slate-800">${data.name}</p>
                        </div>
                    </div>
                    <span class="text-lg font-bold text-amber-600">${valDisplay}</span>
                </div>`;
            };

            const leadersHtml = `
                ${renderLeaderRow('Goleador', '‚öΩ', topG)}
                ${renderLeaderRow('Asistente', 'üëü', topA)}
                ${renderLeaderRow('Mejor Nota', '‚≠ê', topR, true)}
                ${renderLeaderRow('M√°s MVPs', 'üèÜ', topM)}
            `;
            if (typeof renderProbableLineupWidget === 'function')renderProbableLineupWidget();


            document.getElementById('dashboard-leaders').innerHTML = leadersHtml || '<p class="text-gray-500 text-sm text-center">Faltan datos para calcular l√≠deres.</p>';
            renderAIPrediction();
            renderClubTrophies();
            renderTrafficLight();
            renderTopPerformances(); 

        }

        // ==========================================
        // DASHBOARD EDIT MODE (DRAG & DROP)
        // ==========================================
        let isDashboardEditing = false;

        function toggleDashboardEditMode() {
            isDashboardEditing = !isDashboardEditing;
            const btn = document.getElementById('btn-edit-dashboard');
            const container = document.getElementById('dashboard-widgets-area');
            const widgets = container.children;

            if (isDashboardEditing) {
                btn.innerHTML = '<span>üíæ</span> Guardar Panel';
                btn.classList.add('bg-green-50', 'text-green-700', 'border-green-200');
                btn.classList.remove('bg-white', 'text-gray-600', 'border-gray-300');
                
                Array.from(widgets).forEach(w => {
                    w.setAttribute('draggable', 'true');
                    w.classList.add('dashboard-draggable');
                    w.addEventListener('dragstart', handleDashDragStart);
                    w.addEventListener('dragover', handleDashDragOver);
                    w.addEventListener('drop', handleDashDrop);
                });
            } else {
                btn.innerHTML = '<span>‚úèÔ∏è</span> Editar Panel';
                btn.classList.remove('bg-green-50', 'text-green-700', 'border-green-200');
                btn.classList.add('bg-white', 'text-gray-600', 'border-gray-300');
                
                Array.from(widgets).forEach(w => {
                    w.setAttribute('draggable', 'false');
                    w.classList.remove('dashboard-draggable');
                    w.removeEventListener('dragstart', handleDashDragStart);
                    w.removeEventListener('dragover', handleDashDragOver);
                    w.removeEventListener('drop', handleDashDrop);
                });
                saveDashboardLayout();
            }
        }

        function handleDashDragStart(e) { e.dataTransfer.setData('text/plain', e.target.id); }
        function handleDashDragOver(e) { e.preventDefault(); }
        function handleDashDrop(e) {
            e.preventDefault();
            const id = e.dataTransfer.getData('text/plain');
            const draggable = document.getElementById(id);
            const dropzone = e.target.closest('[draggable="true"]');
            if (draggable && dropzone && draggable !== dropzone) {
                const container = document.getElementById('dashboard-widgets-area');
                // Simple swap logic: insert before
                const children = Array.from(container.children);
                const dragIdx = children.indexOf(draggable);
                const dropIdx = children.indexOf(dropzone);
                if (dragIdx < dropIdx) dropzone.after(draggable);
                else container.insertBefore(draggable, dropzone);
            }
        }

        function saveDashboardLayout() {
            const container = document.getElementById('dashboard-widgets-area');
            const order = Array.from(container.children).map(c => c.id);
            saveData('dashboardLayout', order);
            if(typeof showToast === 'function') showToast('Dise√±o del panel guardado', 'success');
        }

        function restoreDashboardLayout() {
            const order = getData('dashboardLayout');
            if (!order || order.length === 0) return;
            
            const container = document.getElementById('dashboard-widgets-area');
            // Create a map of current children
            const childrenMap = {};
            Array.from(container.children).forEach(c => childrenMap[c.id] = c);
            
            // Re-append in order
            order.forEach(id => {
                if (childrenMap[id]) container.appendChild(childrenMap[id]);
            });
        }

        // ==========================================
        // TAB NAVIGATION
        // ==========================================
        
        function showTab(tabName) {
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('tab-active'));
            
            document.getElementById(`section-${tabName}`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).classList.add('tab-active');
            if (tabName === 'principal') renderPrincipal();
            if (tabName === 'principal') restoreDashboardLayout();
            renderCompetitionStatus();
            if (tabName === 'principal') renderClubTrophies();
            if (calendarEvents.length === 0) loadCalendar();
            if (tabName === 'plantilla') renderPlayers();
            if (tabName === 'calendario') renderCalendar();
            if (tabName === 'nuevo') initNewMatchForm();
            if (tabName === 'partidos') renderMatches();
            if (tabName === 'stats') renderStats();
            if (tabName === 'comparador') { populateComparatorSelects(); /* updateComparatorChart se llama solo dentro de populate si hay jugadores */ }
            if (tabName === 'calendario') renderCalendar();
        }

        // ==========================================
        // PLAYERS RENDERING
        // ==========================================
        
        function filterPlayers(filter) {
            currentPlayerFilter = filter;
            document.querySelectorAll('#section-plantilla > div:first-of-type button').forEach(btn => {
                btn.classList.remove('bg-slate-800', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            document.getElementById(`filter-${filter}`).classList.remove('bg-gray-200', 'text-gray-700');
            document.getElementById(`filter-${filter}`).classList.add('bg-slate-800', 'text-white');
            renderPlayers();
        }

        function filterByPosition(position) {
            currentPositionFilter = position;
            document.querySelectorAll('.pos-filter').forEach(btn => {
                btn.classList.remove('bg-slate-800', 'text-white');
                btn.classList.add('bg-gray-200');
                if (btn.textContent.includes('Entrenador')) btn.classList.remove('bg-gray-200');
            });
            event.target.classList.remove('bg-gray-200');
            event.target.classList.add('bg-slate-800', 'text-white');
            renderPlayers();
        }
function renderPlayers() {
    let players = getPlayers();
    const matches = getData('matches'); 
    
    // --- Filtros ---
    const searchTerm = document.getElementById('player-search')?.value.toLowerCase() || '';

    if (currentPlayerFilter === 'active') {
        players = players.filter(p => p.estado === 'Activo');
    } else if (currentPlayerFilter === 'inactive') {
        players = players.filter(p => p.estado === 'Inactivo' || p.estado === 'Leyenda');
    } else if (currentPlayerFilter === 'loaned') {
        players = players.filter(p => p.estado === 'Cedido');
    }
    
    if (currentPositionFilter) players = players.filter(p => p.posicion === currentPositionFilter);

    if (searchTerm) {
        players = players.filter(p => 
            p.nombre.toLowerCase().includes(searchTerm) || 
            p.apellido.toLowerCase().includes(searchTerm) || 
            String(p.dorsal).includes(searchTerm) ||
            (p.apodo && p.apodo.toLowerCase().includes(searchTerm))
        );
    }
    
    // --- Ordenaci√≥n ---
    players.sort((a, b) => {
        const inactA = a.estado === 'Inactivo' || a.estado === 'Leyenda' || a.estado === 'Retirado';
        const inactB = b.estado === 'Inactivo' || b.estado === 'Leyenda' || b.estado === 'Retirado';

        if (inactA && !inactB) return 1;
        if (!inactA && inactB) return -1;

        if (a.posicion === 'entrenador') return -1;
        if (b.posicion === 'entrenador') return 1;
        return (parseInt(a.dorsal) || 999) - (parseInt(b.dorsal) || 999);
    });
    
    const container = document.getElementById('players-list');
    
    container.innerHTML = players.map((player, index) => {
        // Determinar si es editable
        const isEditable = appMode === 'local' || (appMode === 'global' && currentUser);

        const delay = index < 20 ? index * 50 : 0; 
        const styleDelay = `style="animation-delay: ${delay}ms"`;

        let statusClass = '';
        let badgeClass = '';
        let photoBorderClass = '';
        let fireIconHTML = '';      
        let fireOverlayHTML = '';   
        let holoClass = '';         

        if (player.estado === 'Leyenda') {
            statusClass = 'status-leyenda';
            badgeClass = 'bg-amber-100 text-amber-800 border-amber-200';
            photoBorderClass = 'border-amber-400';
            holoClass = 'holo-effect'; 
        } else if (player.estado === 'Cedido') {
            statusClass = 'status-cedido';
            badgeClass = 'bg-yellow-100 text-yellow-800 border-yellow-200';
            photoBorderClass = 'border-yellow-400';
        } else if (player.estado === 'Inactivo' || player.estado === 'Retirado') {
            statusClass = 'status-inactivo';
            badgeClass = 'bg-gray-100 text-gray-500 border-gray-200';
            photoBorderClass = 'border-gray-300';
        } else {
            statusClass = 'status-activo';
            badgeClass = 'status-active';
            photoBorderClass = 'border-amber-400';

            const pMatches = matches
                .filter(m => m.playerStats && m.playerStats.some(s => s.playerId === player.id && s.rating))
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 3);

            if (pMatches.length >= 2) {
                let sum = 0;
                pMatches.forEach(m => {
                    const s = m.playerStats.find(st => st.playerId === player.id);
                    sum += parseFloat(s.rating);
                });
                const avg = sum / pMatches.length;

                if (avg >= 9.0) {
                    holoClass = 'holo-effect'; 
                    fireOverlayHTML = `<div class="fire-overlay" style="border-color: #8b5cf6; box-shadow: inset 0 0 0 1px #8b5cf6;"></div>`;
                    fireIconHTML = `<div class="fire-badge-icon" style="background:#8b5cf6; border-color:#fff; color:white;" title="TIER S: ${avg.toFixed(1)}">üíé</div>`;
                } 
                else if (avg >= 8.0) {
                    statusClass += ' status-on-fire'; 
                    fireOverlayHTML = `<div class="fire-overlay"></div>`;
                    fireIconHTML = `<div class="fire-badge-icon" title="Racha: ${avg.toFixed(1)}">üî•</div>`;
                }
                else if (avg < 6.0) {
                    statusClass += ' status-frozen'; 
                    fireOverlayHTML = `<div class="frozen-overlay"></div>`;
                    fireIconHTML = `<div class="fire-badge-icon" style="background:#eff6ff; border-color:#93c5fd; color:#2563eb;" title="Mala Racha: ${avg.toFixed(1)}">‚ùÑÔ∏è</div>`;
                }
            }
        }

        const statusButton = isEditable ? `
            <button onclick="event.stopPropagation(); openPlayerStatusModal('${player.id}')" 
                    class="text-[10px] font-bold uppercase px-2 py-0.5 rounded border ${badgeClass} hover:opacity-80 transition">
                ${player.estado} ‚úèÔ∏è
            </button>` : `<span class="text-[10px] font-bold uppercase px-2 py-0.5 rounded border ${badgeClass}">${player.estado}</span>`;

        return `
            <div class="card player-card bg-white rounded-xl shadow-sm p-4 ${statusClass} ${holoClass} card-animate-enter cursor-pointer relative transition-transform hover:-translate-y-1" 
                 ${styleDelay} 
                 onclick="viewPlayerDetails('${player.id}')">
                
                ${fireOverlayHTML}
                ${fireIconHTML}

                <div class="flex items-start gap-4 relative z-10">
                    <img src="${player.foto}" 
                         class="player-photo border-4 ${photoBorderClass} rounded-full w-20 h-20 object-cover object-top" 
                         onerror="this.src='https://via.placeholder.com/80x80?text=${player.dorsal}'"
                         alt="${player.nombre}">
                         
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-2xl font-bold text-slate-700">${player.dorsal === "DT" ? "DT" : "#" + player.dorsal}</span>
                        </div>
                        
                        <h3 class="font-semibold text-gray-800 truncate text-lg leading-tight">${player.nombre} ${player.apellido}</h3>
                        
                        <div class="flex flex-wrap gap-1 mt-2">
                            <span class="position-badge pos-${player.posicion}">${capitalizeFirst(player.posicion)}</span>
                            ${statusButton}
                        </div>
                        
                        <div class="mt-2 text-sm text-gray-500 flex flex-col gap-0.5">
                            <p class="flex items-center gap-1">üéÇ ${calculateAge(player.fechaNacimiento)} a√±os</p>
                            <p class="flex items-center gap-1">üåç ${player.nacionalidad}</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}


let currentPlayerDetailsId = null;

// =========================================================
// 1. FUNCI√ìN PRINCIPAL (Recopila datos y calcula MINUTOS por comp)
// =========================================================
function viewPlayerDetails(playerId) {
    const players = getPlayers();
    const player = players.find(p => p.id === playerId);
    if (!player) return;

    currentPlayerDetailsId = playerId;

    const modal = document.getElementById('player-details-modal');
    const headerContainer = document.getElementById('player-modal-header-container');
    const contentContainer = document.getElementById('player-details-content');

    if (!modal || !headerContainer || !contentContainer) return;

    // --- PROCESAMIENTO DE DATOS ---
    const matches = getData('matches');
    const playerMatches = [];
    
    const stats = { matchesPlayed: 0, goals: 0, assists: 0, minutes: 0, totalRating: 0, ratingCount: 0, wins: 0, starts: 0 };
    const ratingsHistory = [];
    const statsByComp = {}; 

    matches.forEach(m => {
        const ps = m.playerStats ? m.playerStats.find(s => String(s.playerId) === String(playerId)) : null;
        
        if (ps && (ps.played || ps.minutes > 0)) {
            playerMatches.push({ ...m, ...ps });

            const isStarter = (ps.isStarter === true || ps.isStarter === 'true' || m.isStarter === true || m.isStarter === 'true');
            
            // Totales
            stats.matchesPlayed++;
            stats.goals += (Number(ps.goals) || 0);
            stats.assists += (Number(ps.assists) || 0);
            stats.minutes += (Number(ps.minutes) || 0);
            if (isStarter) stats.starts++;
            
            if (ps.rating) {
                const r = parseFloat(ps.rating);
                if (!isNaN(r)) {
                    stats.totalRating += r;
                    stats.ratingCount++;
                    
                    // Calcular media del equipo en ese partido
                    let teamSum = 0, teamCount = 0;
                    m.playerStats.forEach(t => { if(t.rating) { teamSum += parseFloat(t.rating); teamCount++; } });
                    const tAvg = teamCount > 0 ? (teamSum/teamCount).toFixed(2) : 0;

                    ratingsHistory.push({ rating: r, teamAvg: tAvg, opponent: m.opponent, date: m.date });
                }
            }
            if (m.outcome === 'victoria') stats.wins++;

            // Por Competici√≥n
            const compName = m.competition || "Otras"; 
            if (!statsByComp[compName]) {
                statsByComp[compName] = { pj: 0, g: 0, a: 0, min: 0, pi: 0, ta: 0, tr: 0, sumRating: 0, countRating: 0 };
            }
            const c = statsByComp[compName];
            c.pj++;
            c.g += (Number(ps.goals) || 0);
            c.a += (Number(ps.assists) || 0);
            c.min += (Number(ps.minutes) || 0);
            c.ta += (Number(ps.yellowCards) || 0);
            c.tr += (Number(ps.redCards) || 0);
            if (isStarter) c.pi++;
            if (ps.rating && !isNaN(parseFloat(ps.rating))) {
                c.sumRating += parseFloat(ps.rating);
                c.countRating++;
            }
        }
    });

    playerMatches.sort((a, b) => new Date(b.date) - new Date(a.date));
    const avgRating = stats.ratingCount > 0 ? (stats.totalRating / stats.ratingCount).toFixed(2) : '-';
    const safeAge = (d) => typeof calculateAge === 'function' ? calculateAge(d) : '';

    // --- RENDER HEADER ---
    headerContainer.innerHTML = `
        <div class="px-6 pt-6 pb-2 relative">
            <button onclick="closePlayerDetailsModal()" class="absolute top-4 right-4 p-2 bg-gray-100 hover:bg-gray-200 rounded-full text-gray-500 transition-colors z-10">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
            </button>

            <div class="flex flex-col items-center justify-center text-center">
                <div class="relative mb-3">
                    <img src="${player.foto}" class="w-24 h-24 rounded-full border-4 ${player.estado === 'Activo' ? 'border-amber-400' : 'border-gray-200'} object-cover shadow-md" onerror="this.src='https://via.placeholder.com/150'">
                    <div class="absolute -bottom-2 -right-2 bg-slate-800 text-white text-xs font-bold px-2 py-0.5 rounded-full border-2 border-white">
                        ${player.dorsal === 'DT' ? 'DT' : '#' + player.dorsal}
                    </div>
                </div>
                
                <h2 class="text-3xl font-bold text-slate-800 leading-tight mb-1">${player.nombre} ${player.apellido}</h2>
                
                <div class="flex items-center gap-2">
                    <span class="bg-slate-800 text-white px-3 py-1 rounded-full text-xs font-bold uppercase tracking-wider">${player.posicion}</span>
                    <button onclick="openPlayerStatusModal('${player.id}')" class="text-xs bg-slate-100 hover:bg-slate-200 px-2 py-1 rounded border transition-colors">
                        ${player.estado === 'Activo' ? '‚úÖ' : '‚ùå'}
                    </button>
                </div>
            </div>

            <div class="flex gap-6 mt-6 border-b border-gray-200 overflow-x-auto">
                <button onclick="switchPlayerTab('profile')" id="tab-btn-profile" class="pb-3 text-sm font-bold border-b-2 border-indigo-600 text-indigo-600 transition-colors flex items-center gap-2 whitespace-nowrap">
                    <span>üë§</span> Perfil
                </button>
                <button onclick="switchPlayerTab('season')" id="tab-btn-season" class="pb-3 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-gray-600 transition-colors flex items-center gap-2 whitespace-nowrap">
                    <span>üìä</span> Temporada
                </button>
                <button onclick="switchPlayerTab('history')" id="tab-btn-history" class="pb-3 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-gray-600 transition-colors flex items-center gap-2">
                    <span>üìã</span> Historial
                </button>
                <button onclick="switchPlayerTab('career')" id="tab-btn-career" class="pb-3 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-gray-600 transition-colors flex items-center gap-2">
                    <span>üìÖ</span> Trayectoria
                </button>
                <button onclick="switchPlayerTab('fut')" id="tab-btn-fut" class="pb-3 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-gray-600 transition-colors flex items-center gap-2">
                    <span>üé¥</span> Carta FUT
                </button>
            </div>
        </div>
    `;

    // --- PREPARAR CONTENIDO ---
    const trophiesHtml = getPlayerBadgesHTML(player.id);
    
    // 1. Pesta√±a Perfil
    const profileHTML = renderProfileTabContent(player, trophiesHtml);

    // 2. Pesta√±a Temporada
    let seasonHTML = renderSeasonTabContent(player, stats, avgRating, playerMatches, ratingsHistory, statsByComp);
    // Sustituye el bloque anterior por este:
seasonHTML += `
    <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mt-6">
        <h4 class="font-bold text-gray-800 text-sm mb-4 flex items-center gap-2 border-b pb-2">
            üéØ Origen de los Goles
            <span class="text-xs font-normal text-gray-500 ml-auto">(Desglose por tipo)</span>
        </h4>
        
        <div class="flex flex-col gap-6 items-center justify-center">
            <div class="relative h-72 w-full max-w-md flex-shrink-0">
                <canvas id="playerTargetChart"></canvas>
            </div>
            
            <div id="targetLegend" class="flex flex-wrap justify-center gap-x-6 gap-y-2 text-sm text-gray-700">
                </div>
        </div>
        
        <p class="text-center text-[10px] text-gray-400 mt-4 italic">
            * Basado en etiquetas de goles (Pie der/izq, Cabeza...)
        </p>
    </div>

`;
    seasonHTML += getComfortZoneHTML(player, matches);
    seasonHTML += getTacticalRadarHTML(player, matches); // <--- NUEVO RADAR
    seasonHTML += getStarterVsSubHTML(player, matches); // <--- NUEVO WIDGET
    seasonHTML += getDisciplineByOutcomeHTML(player, matches); // <--- NUEVA
    seasonHTML += getFormSparklineHTML(player, matches); // <--- NUEVO SPARKLINE

    
    // 3. Pesta√±a Historial
    const historyHTML = typeof renderHistoryTab === 'function' ? renderHistoryTab(player, playerMatches) : '';
    // 4. Pesta√±a Trayectoria
    const careerHTML = typeof renderCareerTab === 'function' ? renderCareerTab(player) : '';

    // INYECTAR CONTENIDO (badgesSection a√±adida al principio de visual)
    contentContainer.innerHTML = `
        <div id="tab-content-profile" class="animate-fade-in block space-y-6">${profileHTML}</div>
        <div id="tab-content-season" class="animate-fade-in hidden space-y-6">${seasonHTML}</div>
        <div id="tab-content-history" class="animate-fade-in hidden">${historyHTML}</div>
        <div id="tab-content-career" class="animate-fade-in hidden">${careerHTML}</div>
        <div id="tab-content-fut" class="animate-fade-in hidden flex justify-center py-10"></div>
    `;

    renderFutTab(player, stats, avgRating);

    modal.classList.remove('hidden');
    modal.classList.add('flex');
    modal.classList.add('active');
    lockScroll();
    
    setTimeout(() => { 
        modal.classList.remove('opacity-0'); 
        runCounters(); 
        renderPlayerDetailChart(ratingsHistory);
        renderMarketValueChart(player);
        if(typeof renderPlayerTargetChart === 'function') renderPlayerTargetChart(player.id);
    }, 50);
}

// =========================================================
// 2. RENDERIZADORES DE PESTA√ëAS
// =========================================================

function renderProfileTabContent(player, trophiesHtml) {
    // 1. Tarjeta de Datos Personales (NUEVA)
    const personalCard = `
        <div class="bg-white rounded-xl border border-gray-200 p-5 shadow-sm mb-6">
            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                <span>üë§ Datos Personales</span>
                <div class="h-px bg-gray-100 flex-1"></div>
            </h3>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="text-center p-2 bg-slate-50 rounded-lg border border-slate-100">
                    <p class="text-[10px] text-gray-500 uppercase font-bold mb-1">Nacionalidad</p>
                    <p class="text-sm font-bold text-slate-700 truncate">${player.nacionalidad}</p>
                </div>
                <div class="text-center p-2 bg-slate-50 rounded-lg border border-slate-100">
                    <p class="text-[10px] text-gray-500 uppercase font-bold mb-1">Edad</p>
                    <p class="text-sm font-bold text-slate-700">${calculateAge(player.fechaNacimiento)} a√±os</p>
                </div>
                <div class="text-center p-2 bg-slate-50 rounded-lg border border-slate-100">
                    <p class="text-[10px] text-gray-500 uppercase font-bold mb-1">Altura</p>
                    <p class="text-sm font-bold text-slate-700">${player.altura || '-'}</p>
                </div>
                <div class="text-center p-2 bg-slate-50 rounded-lg border border-slate-100">
                    <p class="text-[10px] text-gray-500 uppercase font-bold mb-1">Pie</p>
                    <p class="text-sm font-bold text-slate-700">${player.piePreferido || '-'}</p>
                </div>
            </div>
        </div>
    `;

    // 2. Tarjeta de Datos Contractuales
    const infoCard = `
        <div class="bg-white rounded-xl border border-gray-200 p-5 shadow-sm">
            <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                <span>üìã Informaci√≥n Contractual</span>
                <div class="h-px bg-gray-100 flex-1"></div>
            </h3>
            <div class="grid grid-cols-3 gap-4 text-center">
                <div class="p-3 bg-slate-50 rounded-xl border border-slate-100">
                    <p class="text-[10px] text-gray-500 uppercase font-bold mb-1">Fecha Fichaje</p>
                    <p class="text-sm font-bold text-slate-700">${player.fechaFichaje ? formatDate(player.fechaFichaje) : '-'}</p>
                </div>
                <div class="p-3 bg-slate-50 rounded-xl border border-slate-100">
                    <p class="text-[10px] text-gray-500 uppercase font-bold mb-1">Coste</p>
                    <p class="text-sm font-bold text-emerald-600">${player.costeFichaje || '-'}</p>
                </div>
                <div class="p-3 bg-slate-50 rounded-xl border border-slate-100">
                    <p class="text-[10px] text-gray-500 uppercase font-bold mb-1">Fin Contrato</p>
                    <p class="text-sm font-bold text-blue-600">${player.finContrato ? formatDate(player.finContrato) : '-'}</p>
                </div>
            </div>
        </div>
    `;

    // 3. Secci√≥n de Logros
    const badgesSection = trophiesHtml ? `
        <div class="bg-white rounded-xl border border-gray-200 p-5 shadow-sm">
             <h3 class="text-xs font-bold text-gray-400 uppercase tracking-widest mb-4 flex items-center gap-2">
                <span>üèÜ Logros y Trofeos</span>
                <div class="h-px bg-gray-100 flex-1"></div>
            </h3>
            <div class="bg-gray-50 rounded-xl p-4 border border-gray-100">
                ${trophiesHtml}
            </div>
        </div>
    ` : '';

    // 4. Gr√°fica de Valor de Mercado
    let marketChartHTML = '';
    if (player.historialValor && player.historialValor.length > 0) {
        marketChartHTML = `
        <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-200">
            <div class="flex justify-between items-center mb-4">
                <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider">Evoluci√≥n Valor de Mercado</h4>
                <div class="text-xs font-bold text-emerald-600 bg-emerald-50 px-3 py-1 rounded-full border border-emerald-100">Actual: ${player.valorMercado} ${player.unidad || 'M‚Ç¨'}</div>
            </div>
            <div class="relative h-64 w-full">
                <canvas id="chart-player-market-value"></canvas>
            </div>
        </div>`;
    } else {
        marketChartHTML = `
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 text-center">
            <p class="text-gray-400 text-sm italic">Sin historial de valor de mercado disponible.</p>
        </div>`;
    }

    return `${personalCard}${infoCard}${badgesSection}${marketChartHTML}`;
}

function renderSeasonTabContent(player, stats, avgRating, matches, ratingsHistory, statsByComp) {
    const isCoach = player.posicion === 'entrenador';
    
    // --- 1. TARJETAS DE RESUMEN ---
    const colorRating = typeof getRatingColor === 'function' ? getRatingColor(avgRating) : 'text-gray-800';
    
    // He vuelto a poner grid-cols-4 para que quede sim√©trico sin la tarjeta del pie
    const summaryCardsHTML = `
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center">
                <span class="text-3xl font-black text-slate-800 counter-anim" data-target="${stats.matchesPlayed}">0</span>
                <span class="text-xs font-bold text-gray-400 uppercase tracking-wider mt-1">Partidos</span>
            </div>
            <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center">
                <span class="text-3xl font-black ${colorRating} counter-anim" data-target="${avgRating !== '-' ? avgRating : 0}" data-float="true">0.00</span>
                <span class="text-xs font-bold text-gray-400 uppercase tracking-wider mt-1">Nota Media</span>
            </div>
            ${!isCoach ? `
            <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center">
                <span class="text-3xl font-black text-emerald-600 counter-anim" data-target="${stats.goals}">0</span>
                <span class="text-xs font-bold text-gray-400 uppercase tracking-wider mt-1">Goles</span>
            </div>
            <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center">
                <span class="text-3xl font-black text-blue-600 counter-anim" data-target="${stats.assists}">0</span>
                <span class="text-xs font-bold text-gray-400 uppercase tracking-wider mt-1">Asistencias</span>
            </div>
            ` : ''}
        </div>`;

    // --- 2. TABLA DARK (MANTENIDA) ---
    const compData = statsByComp || {};
    let tableDarkHTML = '';

    if (Object.keys(compData).length > 0) {
        let tPJ=0, tG=0, tA=0, tMIN=0, tTIT=0, tTA=0, tTR=0, sMed=0, cMed=0;

        const rows = Object.entries(compData).map(([compName, d]) => {
            tPJ += d.pj; tG += d.g; tA += d.a; tMIN += (d.min || 0); tTIT += (d.pi || d.tit || 0);
            tTA += d.ta; tTR += d.tr; sMed += d.sumRating; cMed += d.countRating;
            const med = d.countRating > 0 ? (d.sumRating / d.countRating).toFixed(2) : '-';

            return `
            <tr class="border-b border-gray-700/50 hover:bg-white/5 transition-colors text-sm">
                <td class="py-3 text-left pl-4 text-white font-medium truncate">${compName}</td>
                <td class="py-3 text-center text-gray-300">${d.pj}</td>
                <td class="py-3 text-center text-green-400 font-bold">${d.g}</td>
                <td class="py-3 text-center text-blue-300 font-bold">${d.a}</td>
                <td class="py-3 text-center text-gray-400 text-xs">${d.min}'</td>
                <td class="py-3 text-center text-gray-300">${d.pi || 0}</td>
                <td class="py-3 text-center text-yellow-400 font-bold">${d.ta}</td>
                <td class="py-3 text-center text-red-500 font-bold">${d.tr}</td>
                <td class="py-3 text-center font-bold text-white">${med}</td>
            </tr>`;
        }).join('');

        const totalMedia = cMed > 0 ? (sMed / cMed).toFixed(2) : '-';

        tableDarkHTML = `
        <div class="w-full bg-[#120f28] text-gray-300 rounded-xl overflow-hidden shadow-lg font-sans mb-6">
            <div class="overflow-x-auto">
                <table class="w-full border-collapse min-w-[600px]">
                    <thead>
                        <tr class="text-[11px] md:text-xs uppercase tracking-wider text-gray-400 border-b border-gray-700/50 bg-[#1a1635]">
                            <th class="py-3 text-left pl-4 font-semibold w-1/3">Competici√≥n</th>
                            <th class="py-3 text-center font-semibold">PJ</th>
                            <th class="py-3 text-center font-semibold">G</th>
                            <th class="py-3 text-center font-semibold">A</th>
                            <th class="py-3 text-center font-semibold">MIN</th>
                            <th class="py-3 text-center font-semibold" title="Titularidades">TIT</th>
                            <th class="py-3 text-center font-semibold text-base" title="Amarillas">üü®</th>
                            <th class="py-3 text-center font-semibold text-base" title="Rojas">üü•</th>
                            <th class="py-3 text-center font-semibold">MED</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                    <tfoot>
                        <tr class="text-sm font-bold text-white bg-[#1a1635] border-t border-gray-600">
                            <td class="py-3 text-left pl-4 opacity-90">Totales</td>
                            <td class="py-3 text-center">${tPJ}</td>
                            <td class="py-3 text-center">${tG}</td>
                            <td class="py-3 text-center">${tA}</td>
                            <td class="py-3 text-center text-xs text-gray-400">${tMIN}'</td>
                            <td class="py-3 text-center">${tTIT}</td>
                            <td class="py-3 text-center text-yellow-500">${tTA}</td>
                            <td class="py-3 text-center text-red-500">${tTR}</td>
                            <td class="py-3 text-center text-blue-300">${totalMedia}</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>`;
    }

    // --- 3. GR√ÅFICO (MODIFICADO A CANVAS) ---
    let chartHTML = '';
    if(ratingsHistory.length > 0) {
        chartHTML = `
        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mt-6">
            <div class="flex justify-between items-center mb-4">
                <h4 class="text-xs font-bold text-gray-400 uppercase tracking-wider">Evoluci√≥n vs Equipo</h4>
                <div class="flex gap-3 text-[10px] font-bold">
                    <div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-indigo-500"></div> Jugador</div>
                    <div class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-gray-300"></div> Equipo</div>
                </div>
            </div>
            <div class="relative h-48 w-full">
                <canvas id="chart-player-detail-evolution"></canvas>
            </div>
        </div>`;
    }

    // --- 4. TOP ACTUACIONES (MANTENIDO) ---
    let topPerfHTML = '';
    if (!isCoach) {
        let topPerformances = [...matches]
        .filter(m => m.rating).map(m => ({...m, rating: parseFloat(m.rating)}))
        .sort((a,b) => b.rating - a.rating).slice(0,5);

        if(topPerformances.length > 0) {
            topPerfHTML = `<div class="mt-6"><h3 class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-3">üíé Top 5 Actuaciones</h3><div class="grid grid-cols-5 gap-2">` + 
            topPerformances.map(m => `
                <div class="bg-white border border-gray-100 p-2 rounded shadow-sm text-center overflow-hidden">
                    <div class="text-[10px] text-gray-400 truncate">vs ${m.opponent}</div>
                    <div class="font-black text-lg text-slate-800">${m.rating}</div>
                </div>`).join('') + 
            `</div></div>`;
        }
    }
    
    setTimeout(runCounters, 50);

    return `${summaryCardsHTML}${tableDarkHTML}${chartHTML}${topPerfHTML}`;
}

let playerDetailChart = null;
function renderPlayerDetailChart(history) {
    const ctx = document.getElementById('chart-player-detail-evolution');
    if (!ctx) return;
    if (playerDetailChart) playerDetailChart.destroy();

    const data = [...history].sort((a, b) => new Date(a.date) - new Date(b.date)).slice(-15);

    playerDetailChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: data.map(d => d.opponent),
            datasets: [
                {
                    label: 'Jugador',
                    data: data.map(d => d.rating),
                    borderColor: '#6366f1', backgroundColor: 'rgba(99, 102, 241, 0.1)',
                    borderWidth: 3, tension: 0.3, pointBackgroundColor: '#fff', pointBorderColor: '#6366f1', pointRadius: 4
                },
                {
                    label: 'Equipo',
                    data: data.map(d => d.teamAvg),
                    borderColor: '#9ca3af', borderWidth: 2, borderDash: [5, 5],
                    tension: 0.3, pointRadius: 0, pointHoverRadius: 0
                }
            ]
        },
        options: {
            responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
            plugins: { legend: { display: false }, tooltip: { backgroundColor: 'rgba(255, 255, 255, 0.9)', titleColor: '#1f2937', bodyColor: '#1f2937', borderColor: '#e5e7eb', borderWidth: 1 } },
            scales: { y: { min: 0, max: 10, grid: { color: '#f3f4f6' }, ticks: { stepSize: 1 } }, x: { grid: { display: false }, ticks: { font: { size: 10 }, maxRotation: 45, minRotation: 45 } } }
        }
    });
}

let marketValueChart = null;
function renderMarketValueChart(player) {
    const ctx = document.getElementById('chart-player-market-value');
    if (!ctx || !player.historialValor || player.historialValor.length === 0) return;
    
    if (marketValueChart) marketValueChart.destroy();

    // Helper para parsear fecha DD-MM-YYYY (D√≠a-Mes-A√±o)
    const parseDate = (str) => {
        if (!str) return new Date();
        // Si detectamos formato DD-MM-YYYY (el d√≠a tiene 1 o 2 d√≠gitos al principio)
        if (str.includes('-') && str.split('-')[0].length <= 2) {
             const [day, month, year] = str.split('-').map(Number);
             const fullYear = year < 100 ? 2000 + year : year; // Soporte para 2 d√≠gitos (AA)
             return new Date(fullYear, month - 1, day);
        }
        return new Date(str); // Fallback para formato est√°ndar
    };

    // Ordenar por fecha
    const history = [...player.historialValor].sort((a, b) => parseDate(a.fecha) - parseDate(b.fecha));
    
    const labels = history.map(h => {
        const d = parseDate(h.fecha);
        // CAMBIO: Mes y A√±o (ej: Jun. 2023)
        return d.toLocaleDateString('es-ES', { month: 'short', year: 'numeric' });
    });
    const data = history.map(h => h.valor);

    marketValueChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [{
                label: `Valor (${player.unidad || 'M‚Ç¨'})`,
                data: data,
                borderColor: '#10b981', // Emerald 500
                backgroundColor: (context) => {
                    const ctx = context.chart.ctx;
                    const gradient = ctx.createLinearGradient(0, 0, 0, 200);
                    gradient.addColorStop(0, 'rgba(16, 185, 129, 0.2)');
                    gradient.addColorStop(1, 'rgba(16, 185, 129, 0.0)');
                    return gradient;
                },
                borderWidth: 3,
                tension: 0.4,
                fill: true,
                pointBackgroundColor: '#fff',
                pointBorderColor: '#10b981',
                pointRadius: 4,
                pointHoverRadius: 6
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: { legend: { display: false } },
            scales: {
                y: { 
                    beginAtZero: false, 
                    grid: { color: '#f3f4f6' },
                    ticks: { callback: (val) => val + (player.unidad || 'M‚Ç¨') }
                },
                x: { 
                    grid: { display: false }, 
                    ticks: { font: { size: 10 } } 
                }
            }
        }
    });
}

function renderPlayerHistoryTab(player, matches) {
    const isCoach = player.posicion === 'entrenador';
    
    if (matches.length === 0) {
        return `<div class="text-center py-10 text-gray-400 italic">No hay partidos registrados.</div>`;
    }

    return `
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-50 text-gray-500 font-bold uppercase text-xs">
                        <tr>
                            <th class="px-4 py-3">Fecha / Rival</th>
                            <th class="px-4 py-3 text-center">Rol</th>
                            <th class="px-4 py-3 text-center">Nota</th>
                            <th class="px-4 py-3 text-center text-emerald-600">G</th>
                            <th class="px-4 py-3 text-center text-blue-600">A</th>
                            <th class="px-4 py-3 text-center">Min</th>
                            <th class="px-4 py-3 text-center">T</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        ${matches.map(m => `
                            <tr class="hover:bg-slate-50 transition-colors">
                                <td class="px-4 py-3">
                                    <div class="font-bold text-slate-700">${m.opponent}</div>
                                    <div class="text-xs text-gray-400">${formatDate(m.date)}</div>
                                </td>
                                <td class="px-4 py-3 text-center">
                                    ${(m.isStarter === true || m.isStarter === 'true') 
                                        ? '<span class="bg-green-100 text-green-700 px-2 py-0.5 rounded-full text-[10px] font-bold uppercase">Titular</span>' 
                                        : '<span class="bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full text-[10px] font-bold uppercase">Suplente</span>'}
                                </td>
                                <td class="px-4 py-3 text-center font-bold text-base ${typeof getRatingColor === 'function' ? getRatingColor(m.rating) : ''}">
                                    ${m.rating || '-'}
                                </td>
                                <td class="px-4 py-3 text-center font-medium ${m.goals > 0 ? 'text-emerald-600 font-bold' : 'text-gray-300'}">
                                    ${isCoach ? '-' : (m.goals || '-')}
                                </td>
                                <td class="px-4 py-3 text-center font-medium ${m.assists > 0 ? 'text-blue-600 font-bold' : 'text-gray-300'}">
                                    ${isCoach ? '-' : (m.assists || '-')}
                                </td>
                                <td class="px-4 py-3 text-center text-gray-500">
                                    ${isCoach ? '-' : (m.minutes || 0)}'
                                </td>
                                <td class="px-4 py-3 text-center">
                                     ${m.redCards > 0 ? 'üü•' : (m.yellowCards > 0 ? 'üü®' : '')}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

        // ==========================================
        // CALENDAR FIXTURE SELECTION & DISPLAY
        // ==========================================
        
        function selectCalendarFixture(fixtureId) {
            const fixture = calendarEvents.find(e => e.id === fixtureId);
            if (!fixture) return;

            const matches = getData('matches');
            const isRegistered = matches.some(m => m.calendarEventId === fixtureId);
            if (isRegistered) {
                alert('‚ö†Ô∏è Este partido ya ha sido registrado.');
                return;
            }
            
            // Precise Date Validation
            const now = new Date();
            if (fixture.start > now) {
                alert('‚ö†Ô∏è No puedes registrar un partido antes de que comience.');
                return;
            }
            
            selectedCalendarFixture = fixture;
            
            // Switch tab and Show Form
            showTab('nuevo');
            document.getElementById('select-match-prompt').classList.add('hidden');
            document.getElementById('new-match-form-container').classList.remove('hidden');
            
            // Show Step 1, Hide Step 2
            document.getElementById('wizard-step-1').classList.remove('hidden');
            document.getElementById('wizard-step-2').classList.add('hidden');
            
            populateFormFromFixture(fixture);
        }

        function populateFormFromFixture(fixture) {
            document.getElementById('selected-fixture-info').classList.remove('hidden');
            
            const compLabel = fixture.competition ? ` - ${fixture.competition}` : '';
            document.getElementById('selected-fixture-details').textContent = 
                `${fixture.opponent}${compLabel} - ${fixture.start.toLocaleDateString('es-ES')} - ${fixture.location || 'Estadio'}`;
            
            // ‚úÖ BLOQUEO DE FECHA A√ëADIDO
            const dateInput = document.getElementById('new-date');
            dateInput.value = fixture.start.toISOString().split('T')[0];
            dateInput.readOnly = true;
            dateInput.classList.add('bg-gray-100', 'cursor-not-allowed');

            document.getElementById('new-opponent').value = fixture.opponent || '';
            document.getElementById('calendar-event-id').value = fixture.id;

            // --- L√ìGICA ROBUSTA PARA EL SELECTOR ---
            const compSelect = document.getElementById('new-competition');
            let foundCompKey = null;

            if (fixture.competition) {
                foundCompKey = Object.keys(COMPETICIONES_ACTUALES).find(k => 
                    k.toLowerCase().trim() === fixture.competition.toLowerCase().trim()
                );
            }

            if (foundCompKey) {
                compSelect.value = foundCompKey;
                compSelect.disabled = true; 
                compSelect.classList.add('readonly-input', 'bg-gray-100', 'text-gray-600'); 
                updateRoundOptions();
            } else {
                compSelect.value = "";
                compSelect.disabled = false;
                compSelect.classList.remove('readonly-input', 'bg-gray-100', 'text-gray-600');
            }

            const venueSelect = document.getElementById('new-venue');
            venueSelect.value = fixture.venue || '';
            if (fixture.venue) {
                venueSelect.classList.add('readonly-input');
                venueSelect.disabled = true; 
            }
            updateStadiumField();
            
            const stadiumInput = document.getElementById('new-stadium');
            if (fixture.location) {
                stadiumInput.value = fixture.location;
                stadiumInput.readOnly = true;
                stadiumInput.classList.add('readonly-input');
            }
        }

        function clearSelectedFixture() {
            selectedCalendarFixture = null;
            resetNewMatchForm();
        }

        // ==========================================
        // NEW MATCH FORM & WIZARD
        // ==========================================
        
        function initNewMatchForm() {
            populateCompetitionSelect();
            // renderPlayerStatsForm is called when entering Step 2
            
            if (!selectedCalendarFixture) {
                document.getElementById('select-match-prompt').classList.remove('hidden');
                document.getElementById('new-match-form-container').classList.add('hidden');
            } else {
                document.getElementById('select-match-prompt').classList.add('hidden');
                document.getElementById('new-match-form-container').classList.remove('hidden');
                document.getElementById('wizard-step-1').classList.remove('hidden');
                document.getElementById('wizard-step-2').classList.add('hidden');
            }
        }
        
function goToStep2() {
    // Validate Step 1
    const comp = document.getElementById('new-competition').value;
    const round = document.getElementById('new-round').value;
    const result = document.getElementById('new-result').value;
    
    if (!comp || !round || !result) {
        alert("Por favor, completa todos los campos obligatorios del Paso 1.");
        return;
    }
    if (!/^\d+-\d+$/.test(result)) {
        alert("El formato del resultado debe ser goles_local-goles_visitante (ej: 2-1)");
        return;
    }

    // Render players with suspension logic
    renderPlayerStatsForm('new-match-players-stats', comp);

    document.getElementById('wizard-step-1').classList.add('hidden');
    document.getElementById('wizard-step-2').classList.remove('hidden');
    document.getElementById('wizard-step-3').classList.add('hidden');

    currentPitchPlayers = {}; // Reseteamos alineaci√≥n
    currentSubstitutes = [];
    editingMatchPlayersPool = null;
    
    // --- CAMBIO CLAVE: Usamos comillas vac√≠as '' para usar los IDs originales ---
    renderBench('');
    updatePitchFormation(''); 
}

        function goToStep1() {
            document.getElementById('wizard-step-2').classList.add('hidden');
            document.getElementById('wizard-step-1').classList.remove('hidden');
        }

       function renderCompetitionStatus() {
            const container = document.getElementById('competition-status');
            const state = getCompetitionState();
            
            container.innerHTML = Object.entries(COMPETICIONES_ACTUALES).map(([name, comp]) => {
                const isEliminated = state[name]?.eliminated;
                const eliminatedAtId = state[name]?.eliminatedAt;
                const isLeague = comp.tipo === 'liga';
                const isChampion = state[name]?.champion;
                
                // L√≥gica para encontrar el nombre exacto de la ronda de eliminaci√≥n
                let eliminatedText = 'ELIMINADO DE LA COMPETICI√ìN';
                if (isEliminated && eliminatedAtId) {
                    comp.fases.forEach(fase => {
                        const r = fase.rondas.find(round => round.id === eliminatedAtId);
                        if (r) eliminatedText = `Eliminado en ${r.nombre}`;
                    });
                }

                const availableRounds = getAvailableRounds(name);
                const nextRound = availableRounds.find(r => r.status === 'available');
                const matches = getData('matches').filter(m => m.competition === name);
                
                return `
                    <div class="bg-white rounded-xl shadow-sm p-4 ${isEliminated ? 'opacity-60' : ''}">
                        <div class="flex items-center gap-3 mb-3">
                            <span class="${comp.color} px-3 py-1 rounded-full text-sm font-medium ${isEliminated ? 'comp-eliminated' : ''}">${name}</span>
                            ${isEliminated ? '<span class="text-red-500 text-sm">‚ùå Eliminados</span>' : ''}
                        </div>
                        <div class="text-sm text-gray-600">
                            <p>üìä Partidos jugados: <strong>${matches.length}</strong></p>
                            ${nextRound ? `<p>‚û°Ô∏è Disponible: <strong>${nextRound.nombre}</strong></p>` : 
                              (isEliminated ? `<p class="text-red-600 font-bold">‚õî ${eliminatedText}</p>` : '<p class="text-green-500">‚úÖ Competici√≥n completada</p>')}
                        </div>
                        ${isLeague ? `
                            <div class="mt-3 pt-3 border-t border-gray-100 flex justify-between items-center">
                                <span class="text-xs text-gray-500">Estado: ${isChampion ? '<span class="text-amber-600 font-bold">üèÜ CAMPE√ìN</span>' : 'En curso'}</span>
                                <button onclick="toggleLeagueChampion('${name}')" class="text-xs px-2 py-1 rounded border ${isChampion ? 'bg-amber-100 text-amber-700 border-amber-200' : 'bg-gray-50 text-gray-500 border-gray-200 hover:bg-amber-50 hover:text-amber-600'} transition-colors">
                                    ${isChampion ? 'Desmarcar' : 'üèÜ Ganar T√≠tulo'}
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }).join('');
        }
        
        function toggleLeagueChampion(compName) {
            const state = getCompetitionState();
            if (!state[compName]) state[compName] = {};
            state[compName].champion = !state[compName].champion;
            saveCompetitionState(state);
            renderCompetitionStatus();
            renderClubTrophies();
            if (state[compName].champion) { triggerConfetti(); showToast(`üèÜ ¬°Felicidades! Campeones de ${compName}`, 'success'); }
        }

        function populateCompetitionSelect() {
            const select = document.getElementById('new-competition');
            const state = getCompetitionState();
            
            select.innerHTML = '<option value="">Seleccionar competici√≥n...</option>' +
                Object.entries(COMPETICIONES_ACTUALES)
                    .map(([name, comp]) => {
                        const eliminated = state[name]?.eliminated;
                        const label = eliminated ? `${name} (Eliminado)` : name;
                        const disabled = eliminated ? 'disabled' : '';
                        return `<option value="${name}" ${disabled} class="${eliminated ? 'text-red-500' : ''}">${label}</option>`;
                    })
                    .join('');
            
            const filterSelect = document.getElementById('filter-competition');
            const statsFilterSelect = document.getElementById('stats-filter-competition');
            const compOptions = '<option value="">Todas las competiciones</option>' + Object.keys(COMPETICIONES_ACTUALES).map(name => `<option value="${name}">${name}</option>`).join('');
            
            filterSelect.innerHTML = compOptions;
            statsFilterSelect.innerHTML = compOptions;
            
             const calFilterContainer = document.getElementById('calendar-filters-container');
             calFilterContainer.innerHTML = '<button onclick="filterCalendar(\'\')" class="cal-filter px-3 py-1 text-sm rounded-full bg-slate-800 text-white">Todas</button>';
             Object.values(COMPETICIONES_ACTUALES).forEach(comp => {
                 calFilterContainer.innerHTML += `<button onclick="filterCalendar('${comp.id}')" class="cal-filter px-3 py-1 text-sm rounded-full ${comp.color}">${comp.nombre}</button>`;
             });
        }
        
        function updateRoundOptions() {
            const compName = document.getElementById('new-competition').value;
            const roundSelect = document.getElementById('new-round');
            const roundInfo = document.getElementById('round-info');
            const venueSelect = document.getElementById('new-venue');
            
            if (!compName) {
                roundSelect.innerHTML = '<option value="">Primero selecciona competici√≥n...</option>';
                roundInfo.textContent = '';
                return;
            }
            
            const comp = COMPETICIONES_ACTUALES[compName];
            const availableRounds = getAvailableRounds(compName);
            
            if (availableRounds.length === 0) {
                roundSelect.innerHTML = '<option value="">No hay rondas disponibles</option>';
                roundInfo.textContent = 'Esta competici√≥n est√° completada o eliminada.';
                return;
            }
            
            roundSelect.innerHTML = '<option value="">Seleccionar ronda...</option>' +
                availableRounds.map(r => {
                    const statusIcon = r.status === 'completed' ? '‚úÖ' : (r.status === 'available' ? 'üü¢' : 'üîí');
                    const disabled = r.status !== 'available' ? 'disabled' : '';
                    return `<option value="${r.id}" ${disabled} data-orden="${r.orden}">${statusIcon} ${r.nombre}</option>`;
                }).join('');
            
            if (comp.campoNeutral) {
                venueSelect.value = 'neutral';
                updateStadiumField();
                venueSelect.disabled = true;
                roundInfo.textContent = '‚ö†Ô∏è Esta competici√≥n se juega en campo neutral.';
            } else {
                roundInfo.textContent = comp.ordenLibre || comp.tipo === 'liga' ? 
                    'üìã Liga: puedes registrar jornadas en cualquier orden.' :
                    'üü¢ = Disponible, üîí = Ronda anterior pendiente, ‚úÖ = Completada';
            }
            updateOvertimeOptions();
        }

        // Logic for Extra Time and Penalties Controls
        function updateOvertimeOptions() {
            const compName = document.getElementById('new-competition').value;
            const roundId = document.getElementById('new-round').value;
            const result = document.getElementById('new-result').value;
            const container = document.getElementById('overtime-controls');
            const etOption = document.getElementById('extra-time-option');
            const penOption = document.getElementById('penalties-option');
            
            if (!compName || !roundId || !result || !/^\d+-\d+$/.test(result)) {
                container.classList.add('hidden');
                return;
            }

            const comp = COMPETICIONES_ACTUALES[compName];
            let roundInfo = null;
            comp.fases.forEach(fase => {
                const found = fase.rondas.find(r => r.id === roundId);
                if (found) roundInfo = { ...found, faseTipo: fase.tipo };
            });

            if (!roundInfo || !roundInfo.eliminatoria || roundInfo.faseTipo === 'liga') {
                container.classList.add('hidden');
                return;
            }

            let showET = false;
            let showPen = false;
            const currentResultParts = result.split('-').map(Number);
            const currentUs = currentResultParts[0]; // Assuming local input perspective roughly
            const currentThem = currentResultParts[1];

            // 1. Return Leg Logic
            if (roundInfo.idaVuelta === 'vuelta') {
                const matches = getData('matches').filter(m => m.competition === compName);
                const idaMatch = matches.find(m => m.roundId === roundInfo.pareja);

                if (idaMatch) {
                    // Calculate Global
                    // This is complex because we don't know venue yet perfectly from inputs, 
                    // but we can infer from `new-venue` which is likely disabled/set by `handleRoundChange`.
                    // Assume inputs are set correctly.
                    const venue = document.getElementById('new-venue').value;
                    const mockMatch = { result: result, venue: venue };
                    const globalRes = calculateGlobalResult(idaMatch, mockMatch);
                    
                    if (globalRes.outcome === 'empate') {
                         showET = true;
                         showPen = true;
                    }
                }
            }
            // 2. Single Leg Logic
            else if (roundInfo.partidoUnico) {
                if (currentUs === currentThem) {
                    showPen = true;
                }
            }

            if (showET || showPen) {
                container.classList.remove('hidden');
                if (showET) etOption.classList.remove('hidden');
                else etOption.classList.add('hidden');
                
                if (showPen) penOption.classList.remove('hidden');
                else penOption.classList.add('hidden');
            } else {
                container.classList.add('hidden');
            }
        }
        
        function togglePenaltyWinner() {
            const chk = document.getElementById('chk-penalties');
            const winnerSelect = document.getElementById('penalty-winner-select');
            if (chk.checked) winnerSelect.classList.remove('hidden');
            else winnerSelect.classList.add('hidden');
        }
        
        function handleRoundChange() {
            const compName = document.getElementById('new-competition').value;
            const roundId = document.getElementById('new-round').value;
            
            if (!compName || !roundId) return;
            
            const comp = COMPETICIONES_ACTUALES[compName];
            let roundInfo = null;
            
            comp.fases.forEach(fase => {
                const found = fase.rondas.find(r => r.id === roundId);
                if (found) roundInfo = { ...found, faseTipo: fase.tipo };
            });
            
            if (!roundInfo) return;
            
            // Handle two-leg ties
            if (roundInfo.idaVuelta === 'vuelta') {
                const matches = getData('matches').filter(m => m.competition === compName);
                const idaMatch = matches.find(m => m.roundId === roundInfo.pareja);
                
                if (idaMatch) {
                    const legIndicator = document.getElementById('leg-indicator');
                    const legInfo = document.getElementById('leg-info');
                    legIndicator.classList.remove('hidden');
                    legInfo.innerHTML = `<strong>üìä Partido de ida:</strong> vs ${idaMatch.opponent} - Resultado: ${idaMatch.result} (${idaMatch.venue === 'local' ? 'Local' : 'Visitante'})`;
                    
                    document.getElementById('new-opponent').value = idaMatch.opponent;
                    
                    const venueSelect = document.getElementById('new-venue');
                    const alternateVenue = idaMatch.venue === 'local' ? 'visitante' : 'local';
                    venueSelect.value = alternateVenue;
                    venueSelect.disabled = true;
                    
                    const venueWarning = document.getElementById('venue-alternation-warning');
                    const venueInfo = document.getElementById('venue-alternation-info');
                    venueWarning.classList.remove('hidden');
                    venueInfo.innerHTML = `<strong>üîÑ Alternancia autom√°tica:</strong> La ida fue ${idaMatch.venue === 'local' ? 'en casa' : 'fuera'}, la vuelta debe ser ${alternateVenue === 'local' ? 'en casa' : 'fuera'}.`;
                    
                    updateStadiumField();
                }
            } else {
                document.getElementById('leg-indicator').classList.add('hidden');
                document.getElementById('venue-alternation-warning').classList.add('hidden');
            }
            updateOvertimeOptions();
        }
        
        function updateStadiumField() {
            const venue = document.getElementById('new-venue').value;
            const stadiumInput = document.getElementById('new-stadium');
            const compName = document.getElementById('new-competition').value;
            const comp = COMPETICIONES_ACTUALES[compName];
            
            if (venue === 'local') {
                stadiumInput.value = 'Santiago Bernab√©u';
                stadiumInput.readOnly = true;
                stadiumInput.classList.add('bg-gray-100');
            } else if (venue === 'neutral' && comp?.campoNeutral) {
                if (!selectedCalendarFixture?.location) stadiumInput.value = '';
                else stadiumInput.value = selectedCalendarFixture.location;
                
                stadiumInput.readOnly = false;
                stadiumInput.classList.remove('bg-gray-100');
                stadiumInput.placeholder = 'Estadio del partido (campo neutral)';
            } else {
                if (!selectedCalendarFixture?.location) stadiumInput.value = '';
                else stadiumInput.value = selectedCalendarFixture.location;
                
                stadiumInput.readOnly = false;
                stadiumInput.classList.remove('bg-gray-100');
                stadiumInput.placeholder = 'Estadio del rival';
            }
        }

// A√ëADIDO PAR√ÅMETRO 'idPrefix' AL FINAL
function renderPlayerStatsForm(containerId, currentCompetition, preSelectedPlayers = null, idPrefix = '') {
    const container = document.getElementById(containerId);
    
    let players = preSelectedPlayers || getActivePlayers().map(p => ({...p, rol: 'Jugador', specificPos: p.posicion, isStarter: false}));

    // L√≥gica de Sanciones
    const matches = getData('matches').filter(m => m.competition === currentCompetition);
    const lastMatch = matches.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
    const suspendedPlayers = [];
    if (lastMatch) {
        lastMatch.playerStats.forEach(ps => { if (ps.redCards > 0) suspendedPlayers.push(ps.playerId); });
    }

    players.sort((a, b) => {
        if (a.rol === 'Entrenador') return 1; 
        if (b.rol === 'Entrenador') return -1;
        if (a.isStarter && !b.isStarter) return -1;
        if (!a.isStarter && b.isStarter) return 1;
        
        // Ordenar titulares por posici√≥n en el campo (pitchSlot)
        if (a.isStarter && b.isStarter) {
            if (typeof a.pitchSlot === 'number' && typeof b.pitchSlot === 'number') {
                return a.pitchSlot - b.pitchSlot;
            }
        }
        return 0;
    });

    container.innerHTML = players.map(p => {
        const isCoach = p.rol === 'Entrenador';
        const isSuspended = suspendedPlayers.includes(p.id) && !isCoach;
        
        // --- AQU√ç EST√Å EL CAMBIO IMPORTANTE ---
        // Concatenamos el prefijo (ej: "wizard-") al ID para hacerlo √∫nico
        const goalId = `${idPrefix}goals-${p.id}`;
        const assistId = `${idPrefix}assists-${p.id}`;
        const yellowId = `${idPrefix}yellow-${p.id}`;
        const redId = `${idPrefix}red-${p.id}`;

        let badgeHtml = '';
        if (isCoach) {
            badgeHtml = '<span class="bg-gray-200 text-gray-700 text-[10px] font-bold px-2 py-1 rounded uppercase">STAFF</span>';
        } else if (p.isStarter) {
            badgeHtml = `<span class="bg-emerald-100 text-emerald-700 text-[10px] font-bold px-2 py-1 rounded border border-emerald-200 uppercase">${p.specificPos || 'TITULAR'}</span>`;
        } else {
            badgeHtml = '<span class="bg-blue-50 text-blue-600 text-[10px] font-bold px-2 py-1 rounded border border-blue-100 uppercase">SUPLENTE</span>';
        }

        const btnClass = "w-full h-9 bg-white border border-gray-300 rounded text-sm text-gray-700 font-bold hover:border-indigo-400 hover:text-indigo-600 transition-colors flex items-center justify-center";

        // --- L√ìGICA CONDICIONAL PARA ENTRENADOR ---
        const goalsInput = isCoach 
            ? `<div class="w-full h-9 flex items-center justify-center text-gray-300 select-none">-</div>`
            : `<input type="hidden" class="stat-goals-minutes" id="${goalId}" value="">
               <button type="button" id="btn-${goalId}" onclick="openMinuteModal('${goalId}', 'Goles ‚öΩ')" class="${btnClass}">0</button>`;

        const assistsInput = isCoach
            ? `<div class="w-full h-9 flex items-center justify-center text-gray-300 select-none">-</div>`
            : `<input type="hidden" class="stat-assists-minutes" id="${assistId}" value="">
               <button type="button" id="btn-${assistId}" onclick="openMinuteModal('${assistId}', 'Asistencias üëü')" class="${btnClass}">0</button>`;

        const minsInput = isCoach
            ? `<div class="w-full h-9 flex items-center justify-center text-gray-300 select-none">-</div>`
            : `<input type="number" class="stat-minutes w-full h-9 px-2 border border-gray-300 rounded text-sm text-center font-mono text-gray-600 focus:ring-2 focus:ring-indigo-500 outline-none" min="0" max="120" value="${p.isStarter ? 90 : 0}">`;

        return `
        <div class="bg-white rounded-lg p-3 border border-gray-200 shadow-sm flex flex-col md:flex-row items-center gap-4 mb-2 ${isSuspended ? 'opacity-70 bg-gray-50' : ''}" 
             data-player-id="${p.id}" 
             data-rol="${p.rol}"
             data-specific-pos="${p.specificPos}"> 
             
            <div class="flex items-center gap-3 w-full md:w-1/3 min-w-[200px]">
                <div class="relative">
                    <img src="${p.foto}" class="w-10 h-10 rounded-full object-cover border border-gray-200" onerror="this.src='https://via.placeholder.com/40x40'">
                    ${isSuspended ? '<div class="absolute -top-1 -right-1 bg-red-500 text-white text-[8px] px-1 rounded-full font-bold">EXP</div>' : ''}
                </div>
                <div class="flex-1">
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-gray-800 text-sm truncate pr-2">${p.apodo || p.apellido}</span>
                        ${badgeHtml}
                    </div>
                    <span class="text-xs text-gray-400">#${p.dorsal} - ${p.posicion}</span>
                </div>
            </div>

            <div class="flex-1 grid grid-cols-5 gap-3 w-full">
                
                <div class="flex flex-col">
                    <label class="text-[9px] uppercase font-bold text-gray-400 mb-1 tracking-wider">Nota</label>
                    <input type="number" class="stat-rating w-full h-9 px-2 border border-gray-300 rounded text-sm text-center font-bold focus:ring-2 focus:ring-indigo-500 outline-none" min="0" max="10" step="0.25" placeholder="-">
                </div>

                <div class="flex flex-col">
                    <label class="text-[9px] uppercase font-bold text-gray-400 mb-1 tracking-wider">Gol</label>
                    ${goalsInput}
                </div>

                <div class="flex flex-col">
                    <label class="text-[9px] uppercase font-bold text-gray-400 mb-1 tracking-wider">Asis</label>
                    ${assistsInput}
                </div>

                <div class="flex flex-col">
                    <label class="text-[9px] uppercase font-bold text-gray-400 mb-1 tracking-wider">Min</label>
                    ${minsInput}
                </div>

                <div class="flex flex-col items-center">
                    <label class="text-[9px] uppercase font-bold text-gray-400 mb-1 tracking-wider">Tarj</label>
                    <div class="flex gap-1 w-full">
                        <div class="flex-1">
                            <input type="hidden" class="stat-yellow-minutes" id="${yellowId}" value="">
                            <button type="button" id="btn-${yellowId}" onclick="openMinuteModal('${yellowId}', 'Amarilla üü®')" 
                                    class="w-full h-9 bg-yellow-50 border border-yellow-200 rounded text-xs text-yellow-700 font-bold hover:bg-yellow-100 flex items-center justify-center">0</button>
                        </div>
                        <div class="flex-1">
                            <input type="hidden" class="stat-red-minutes" id="${redId}" value="">
                            <button type="button" id="btn-${redId}" onclick="openMinuteModal('${redId}', 'Roja üü•')" 
                                    class="w-full h-9 bg-red-50 border border-red-200 rounded text-xs text-red-700 font-bold hover:bg-red-100 flex items-center justify-center">0</button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
        `;
    }).join('');
}
        
        // Handles mutual exclusion for Starter/Sub checkboxes
        function handleRoleCheck(checkbox, role) {
            const container = checkbox.closest('[data-player-id]');
            const starterChk = container.querySelector('.chk-starter');
            const subChk = container.querySelector('.chk-sub');
            const inputs = container.querySelector('.player-performance-inputs');
            
            if (role === 'starter' && checkbox.checked) {
                subChk.checked = false;
            } else if (role === 'sub' && checkbox.checked) {
                starterChk.checked = false;
            }
            
            // Show inputs if either is checked
            inputs.style.display = (starterChk.checked || subChk.checked) ? 'grid' : 'none';
        }

       function resetNewMatchForm() {
            document.getElementById('new-match-form').reset();
            document.getElementById('new-round').innerHTML = '<option value="">Primero selecciona competici√≥n...</option>';
            document.getElementById('round-info').textContent = '';
            document.getElementById('leg-indicator').classList.add('hidden');
            document.getElementById('venue-alternation-warning').classList.add('hidden');
            
            // ‚úÖ DESBLOQUEAR FECHA
            const dateInput = document.getElementById('new-date');
            dateInput.readOnly = false;
            dateInput.classList.remove('bg-gray-100', 'cursor-not-allowed');

            // Resetear select de competici√≥n
            const compSelect = document.getElementById('new-competition');
            compSelect.disabled = false;
            compSelect.classList.remove('readonly-input', 'bg-gray-100', 'text-gray-600');
            
            document.getElementById('new-venue').disabled = false;
            document.getElementById('new-venue').classList.remove('readonly-input');
            document.getElementById('new-stadium').readOnly = true;
            document.getElementById('new-stadium').classList.add('readonly-input');
            document.getElementById('overtime-controls').classList.add('hidden');
            
            selectedCalendarFixture = null;
            document.getElementById('selected-fixture-info').classList.add('hidden');
            document.getElementById('new-match-form-container').classList.add('hidden');
            document.getElementById('select-match-prompt').classList.remove('hidden');
            
            // Reset Wizard
            document.getElementById('wizard-step-1').classList.remove('hidden');
            document.getElementById('wizard-step-2').classList.add('hidden');
            document.getElementById('wizard-step-3').classList.add('hidden');

            document.getElementById('new-match-players-stats').innerHTML = '';
        }
        
document.getElementById('new-match-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const calendarEventId = document.getElementById('calendar-event-id').value;
    if (!calendarEventId) {
        alert('Error: No se ha seleccionado un partido del calendario.');
        return;
    }

    const compName = document.getElementById('new-competition').value;
    const roundId = document.getElementById('new-round').value;
    const date = document.getElementById('new-date').value;
    const opponent = document.getElementById('new-opponent').value;
    const venue = document.getElementById('new-venue').value;
    const stadium = document.getElementById('new-stadium').value;
    let result = document.getElementById('new-result').value.trim();
    
    // L√≥gica de Penaltis
    const chkPenalties = document.getElementById('chk-penalties');
    if (chkPenalties && chkPenalties.checked) {
        const outcomeRadio = document.querySelector('input[name="penalties-outcome"]:checked');
        if (outcomeRadio) {
            const isWin = outcomeRadio.value === 'win';
            const parts = result.split('-').map(Number);
            let usIndex = (venue === 'visitante') ? 1 : 0;
            
            if (isWin) parts[usIndex]++;
            else parts[usIndex === 0 ? 1 : 0]++;
            
            result = `${parts[0]}-${parts[1]}*`;
        }
    }

    const comp = COMPETICIONES_ACTUALES[compName];
    let roundInfo = { nombre: roundId }; // Fallback
    if (comp) {
        comp.fases.forEach(fase => {
            const found = fase.rondas.find(r => r.id === roundId);
            if (found) roundInfo = { ...found, faseTipo: fase.tipo };
        });
    }
    
    const outcome = calculateMatchOutcome(result, venue);
    
    // --- RECOGIDA DE DATOS ---    
    const statsContainer = document.getElementById('final-stats-container');
    const playerStats = [];
    
    // --- DENTRO DEL LISTENER DE 'new-match-form' ---
    // (Sustituye el bloque donde rellenas playerStats)

    statsContainer.querySelectorAll('[data-player-id]').forEach(row => {
        const playerId = row.getAttribute('data-player-id');
        const specificPos = row.getAttribute('data-specific-pos');
        const isBadgeStarter = row.querySelector('.bg-emerald-100') !== null;
        
        // Inputs Ocultos (Minutos/Goles)
        const goalsStr = row.querySelector('.stat-goals-minutes')?.value || "";
        const assistsStr = row.querySelector('.stat-assists-minutes')?.value || "";
        const yellowStr = row.querySelector('.stat-yellow-minutes')?.value || "";
        const redStr = row.querySelector('.stat-red-minutes')?.value || "";

        const countItems = (str) => (!str || str.trim() === "") ? 0 : str.split(',').filter(s => s.trim() !== '').length;

        const goals = countItems(goalsStr);
        const assists = countItems(assistsStr);
        const yellow = countItems(yellowStr);
        const red = countItems(redStr);

        const ratingVal = row.querySelector('.stat-rating')?.value;
        const rating = (ratingVal === "" || ratingVal === null) ? null : parseFloat(ratingVal);
        const minVal = row.querySelector('.stat-minutes')?.value;
        const minutes = (parseInt(minVal) || 0);

        // =======================================================
        // NUEVO: DETECTAR POSICI√ìN EXACTA EN LA PIZARRA
        // =======================================================
        let savedSlot = null;
        // Buscamos si este jugador est√° en alguna casilla de la pizarra actual
        // currentPitchPlayers suele ser {"wizard-slot-0": "idJugador", ...}
        if (typeof currentPitchPlayers !== 'undefined') {
            const slotKey = Object.keys(currentPitchPlayers).find(key => currentPitchPlayers[key] === playerId);
            if (slotKey) {
                // Extraemos solo el n√∫mero (ej: de "wizard-slot-5" sacamos "5")
                const match = slotKey.match(/(\d+)$/); 
                if (match) savedSlot = parseInt(match[1]);
            }
        }
        // =======================================================

        playerStats.push({
            playerId: playerId,
            isStarter: isBadgeStarter,
            pitchSlot: savedSlot, // <--- AQU√ç GUARDAMOS LA COORDENADA
            specificPosition: specificPos,
            rating: rating,
            goals: goals,
            assists: assists,
            minutes: minutes,
            yellowCards: yellow,
            redCards: red,
            played: minutes > 0,
            detailGoals: goalsStr,
            detailAssists: assistsStr,
            detailYellow: yellowStr,
            detailRed: redStr
        });
    });
    
    const mvp = calculateAutoMVP(playerStats);
    
    // Calcular Finanzas y Edad (si tienes la funci√≥n)
    let squadStats = { valorTotal: 0, edadMedia: 0 };
    if (typeof getSquadStats === 'function') {
        squadStats = getSquadStats();
    }

    const matchData = {
        id: generateId(),
        calendarEventId: calendarEventId,
        // Aseg√∫rate de que este ID existe en tu HTML
        formation: document.getElementById('formation-select') ? document.getElementById('formation-select').value : '4-3-3',
        competition: compName,
        roundId: roundId,
        round: roundInfo.nombre,
        date: date,
        opponent: opponent,
        venue: venue,
        stadium: stadium,
        result: result,
        outcome: outcome,
        mvp: mvp,
        valorPlantilla: squadStats.valorTotal,
        edadMedia: squadStats.edadMedia,
        playerStats: playerStats
    };
    
    const matches = getData('matches');
    matches.push(matchData);
    saveData('matches', matches);
    
    if (typeof checkEliminationAfterMatch === 'function') checkEliminationAfterMatch(matchData);

    const triggered = (typeof checkExtraRoundTrigger === 'function') ? checkExtraRoundTrigger(matchData) : false;
    
    if (!triggered) {
        const hasPerfectRating = playerStats.some(p => p.rating === 10);
        if ((outcome === 'victoria' || hasPerfectRating) && typeof triggerConfetti === 'function') {
            triggerConfetti(); 
        }

        if (typeof resetNewMatchForm === 'function') resetNewMatchForm();
        if (typeof renderCompetitionStatus === 'function') renderCompetitionStatus();
        if (typeof populateCompetitionSelect === 'function') populateCompetitionSelect();
        
        if (typeof showToast === 'function') showToast('Partido registrado correctamente', 'success');
        if (typeof showTab === 'function') showTab('partidos');
    }
});
        
// ==========================================
// ‚öôÔ∏è CONFIGURACI√ìN DE CALENDARIOS Y CACH√â
// ==========================================

// ‚ö†Ô∏è PON AQU√ç TUS URLS REALES ‚ö†Ô∏è
const CALENDAR_URLS = {
    'masculino': 'https://publish.realmadrid.com/content/sling/app-servlets/realmadrid/ical.3kq9cckrnlogidldtdie2fkbl.es-es.ics', 
    'femenino': 'https://publish.realmadrid.com/content/sling/app-servlets/realmadrid/ical.vaikl8nl7hdr4y9jj4jyb9ey.es-es.ics'   
};

const CACHE_DURATION = 60 * 60 * 1000; // 1 hora de memoria

// üö¶ SEM√ÅFORO: Aqu√≠ guardaremos las promesas en curso
const activeRequests = {}; 

// ==========================================
// üß† L√ìGICA DE DATOS (Con Cach√© + Sem√°foro + MultiProxy)
// ==========================================

// ==========================================
// üõ°Ô∏è L√ìGICA DE DATOS BLINDADA (Anti-Bloqueo)
// ==========================================

async function getCalendarEvents(team) {
    if (!team || !CALENDAR_URLS[team]) return [];

    const cacheKey = `calendar_v2_${team}`; 
    const cachedRaw = localStorage.getItem(cacheKey);
    let cachedData = null;

    // 1. INTENTAR LEER DE CACH√â
    if (cachedRaw) {
        try {
            cachedData = JSON.parse(cachedRaw);
            const { timestamp, data } = cachedData;
            
            // Si la cach√© es reciente (menos de 1 hora), la usamos y NO molestamos a los proxies
            if (Date.now() - timestamp < CACHE_DURATION) {
                // console.log(`‚ö° Cach√© v√°lida para [${team}]`);
                return parseICalData(data, team); 
            }
        } catch (e) { localStorage.removeItem(cacheKey); }
    }

    // 2. SEM√ÅFORO (Evitar peticiones simult√°neas)
    if (activeRequests[team]) {
        return activeRequests[team];
    }

    // 3. INICIAR DESCARGA INTELIGENTE
    const requestPromise = (async () => {
        // Orden optimizado: corsproxy suele ser m√°s permisivo con los l√≠mites
        const proxies = [
            'https://corsproxy.io/?', 
            'https://api.allorigins.win/raw?url=',
            'https://thingproxy.freeboard.io/fetch/'
        ];

        let icalText = null;
        let success = false;

        console.log(`üåê Actualizando calendario [${team}] (Puede tardar unos segundos)...`);

        for (const proxyBase of proxies) {
            try {
                const targetUrl = CALENDAR_URLS[team];
                
                // ‚ö†Ô∏è CAMBIO CLAVE: NO enviamos timestamp al proxy.
                // Dejamos que el proxy nos de su versi√≥n cacheada si la tiene.
                // Esto evita que nos baneen por spam.
                const finalUrl = `${proxyBase}${encodeURIComponent(targetUrl)}`;
                
                const controller = new AbortController();
                const timeoutId = setTimeout(() => controller.abort(), 8000); // 8 segundos timeout

                const response = await fetch(finalUrl, { signal: controller.signal });
                clearTimeout(timeoutId);

                if (response.ok) {
                    const text = await response.text();
                    if (text.includes('BEGIN:VCALENDAR')) {
                        icalText = text;
                        success = true;
                        console.log(`   ‚úÖ Descargado v√≠a: ${proxyBase}`);
                        break; 
                    }
                }
            } catch (err) {
                // Silencioso para no ensuciar la consola
            }
        }

        try {
            // SI HA HABIDO √âXITO: Guardamos y devolvemos
            if (success && icalText) {
                localStorage.setItem(cacheKey, JSON.stringify({
                    timestamp: Date.now(),
                    data: icalText
                }));
                return parseICalData(icalText, team);
            }
            
            throw new Error("Fallo general en red/proxies");

        } catch (error) {
            // 4. PLAN DE RESCATE (CACH√â INMORTAL)
            // Si todo falla (proxies bloqueados), pero tenemos datos antiguos... ¬°USALOS!
            // Mejor mostrar un calendario de hace 2 horas que uno vac√≠o.
            if (cachedData && cachedData.data) {
                console.warn(`‚ö†Ô∏è Proxies saturados. Usando copia local de seguridad para [${team}].`);
                
                // Renovamos el timestamp de la cach√© vieja para que no vuelva a intentar descargar
                // hasta dentro de 1 hora. As√≠ dejamos descansar a los proxies.
                localStorage.setItem(cacheKey, JSON.stringify({
                    timestamp: Date.now(), // Enga√±amos al sistema: "Acabo de descargar esto"
                    data: cachedData.data
                }));
                
                return parseICalData(cachedData.data, team);
            }

            console.error(`‚ùå IMPOSIBLE CARGAR [${team}]. Sin conexi√≥n y sin cach√©.`);
            return [];
        } finally {
            delete activeRequests[team];
        }
    })();

    activeRequests[team] = requestPromise;
    return requestPromise;
}

// ==========================================
// üé® L√ìGICA DE UI (Tu funci√≥n mejorada)
// ==========================================

async function loadCalendar() {
    if (!currentTeam) return;

    const container = document.getElementById('calendar-container');
    
    // Solo mostramos el loading si NO tenemos los datos en memoria r√°pida ya
    // (Esto evita el parpadeo si ya visitaste la secci√≥n antes)
    if (container && (!calendarEvents || calendarEvents.length === 0)) {
        container.innerHTML = `
            <div class="calendar-loading text-center py-12">
                <div class="text-4xl mb-4 animate-bounce">‚è≥</div>
                <p class="text-gray-600">Sincronizando calendario...</p>
            </div>
        `;
    }

    // AQUI EST√Å LA MAGIA: Llamamos a la nueva funci√≥n con cach√©
    calendarEvents = await getCalendarEvents(currentTeam);
    
    console.log(`üóìÔ∏è Calendario para [${currentTeam}] listo con ${calendarEvents.length} eventos.`);

    // --- L√ìGICA DE TU INTERFAZ (Se mantiene igual) ---
    
    // Comprobar si hay partido hoy/cerca
    if (typeof checkMatchDay === 'function') checkMatchDay();

    // Renderizar solo si la secci√≥n es visible
    const sectionCalendario = document.getElementById('section-calendario'); // O 'stats-calendario' si lo cambiaste
    const sectionPrincipal = document.getElementById('section-principal'); // O 'stats-principal'

    if (sectionCalendario && !sectionCalendario.classList.contains('hidden')) {
        if (typeof renderCalendar === 'function') renderCalendar();
    }
    
    if (sectionPrincipal && !sectionPrincipal.classList.contains('hidden')) {
        if (typeof renderPrincipal === 'function') renderPrincipal();
    }
}

// ==========================================
// üöÄ PRECARGA (Mantenemos tu funci√≥n, es buena)
// ==========================================
async function preloadCalendars() {
    console.log("üöÄ Iniciando precarga inteligente en segundo plano...");
    try {
        // Al llamar a getCalendarEvents, si no est√°n en cach√©, se bajar√°n y guardar√°n.
        // Si ya est√°n, no har√°n nada. ¬°Eficiencia pura!
        await Promise.all([
            getCalendarEvents('masculino'),
            getCalendarEvents('femenino')
        ]);
        console.log("‚úÖ Calendarios sincronizados y listos.");
    } catch (err) {
        console.error("Error en precarga (no cr√≠tico):", err);
    }
}



       


function checkMatchDay() {
    const desktopBanner = document.getElementById('matchday-banner-desktop');
    const mobileBanner = document.getElementById('matchday-banner-mobile');
    
    if (!desktopBanner || !mobileBanner) return;

    const now = new Date();
    // Normalizamos 'today' a la medianoche para evitar problemas con la hora
    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());

    // 1. BUSCAR PARTIDO DE HOY
    const todayMatch = calendarEvents.find(e => {
        const eDate = new Date(e.start);
        return eDate.getFullYear() === today.getFullYear() &&
               eDate.getMonth() === today.getMonth() &&
               eDate.getDate() === today.getDate();
    });

    if (todayMatch) {
        // --- CASO 1: ¬°ES D√çA DE PARTIDO! ---
        const timeStr = todayMatch.start.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
        const opponent = todayMatch.opponent;
        const comp = todayMatch.competition || 'Partido';
        const location = todayMatch.location || 'Estadio'; // Obtenemos el estadio

        // Actualizar banner de Escritorio
        desktopBanner.innerHTML = `
            <span class="text-2xl animate-pulse">‚öΩ</span>
            <div class="text-right">
                <div class="text-xs font-bold text-amber-400 uppercase tracking-widest">D√çA DE PARTIDO</div>
                <div class="font-bold text-sm leading-none text-white">vs ${opponent}</div>
                <div class="text-[10px] text-blue-200">${location} &bull; ${timeStr} &bull; ${comp}</div>
            </div>`;
        desktopBanner.classList.remove('hidden');
        desktopBanner.classList.add('flex', 'animate-pulse');

        // Actualizar banner de M√≥vil (sin cambios, es m√°s simple)
        document.getElementById('matchday-mobile-text').textContent = `vs ${opponent}`;
        document.getElementById('matchday-mobile-time').textContent = timeStr;
        mobileBanner.classList.remove('hidden');
        mobileBanner.classList.add('flex');

    } else {
        // --- CASO 2: NO HAY PARTIDO HOY, BUSCAR EL SIGUIENTE ---
        const futureEvents = calendarEvents
            .filter(e => e.start > now)
            .sort((a, b) => a.start - b.start);
        
        if (futureEvents.length > 0) {
            const nextMatch = futureEvents[0];
            const dateStr = nextMatch.start.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
            const timeStr = nextMatch.start.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
            const opponent = nextMatch.opponent;
            const location = nextMatch.location || 'Estadio'; // Obtenemos el estadio

            // Actualizar banner de Escritorio (versi√≥n informativa)
            desktopBanner.innerHTML = `
                <span class="text-2xl">üóìÔ∏è</span>
                <div class="text-right">
                    <div class="text-xs font-bold text-blue-300 uppercase tracking-widest">PR√ìXIMO PARTIDO</div>
                    <div class="font-bold text-sm leading-none text-white">vs ${opponent}</div>
                    <div class="text-[10px] text-blue-200">${location} &bull; ${dateStr} &bull; ${timeStr}</div>
                </div>`;
            desktopBanner.classList.remove('hidden', 'animate-pulse');
            desktopBanner.classList.add('flex');

            // Ocultamos el de m√≥vil
            mobileBanner.classList.add('hidden');
            mobileBanner.classList.remove('flex');

        } else {
            // --- CASO 3: NO HAY PARTIDOS EN EL FUTURO ---
            desktopBanner.classList.add('hidden');
            desktopBanner.classList.remove('flex');
            mobileBanner.classList.add('hidden');
            mobileBanner.classList.remove('flex');
        }
    }
}



        // Mapa de traducci√≥n: Nombre en Calendario (.ics) -> Nombre en tu Web
        function mapIcsCompetition(icsDescription) {
            if (!icsDescription) return null;
            
            // 1. Convertimos todo a min√∫sculas para evitar errores de may√∫sculas
            const desc = icsDescription.toLowerCase().trim(); 

            // --- MASCULINO ---
            if (desc.includes('la liga') || desc.includes('laliga')) return 'Liga EA Sports';
            if (desc.includes('champions league')) return 'Champions League';
            if (desc.includes('fifa club world cup') || desc.includes('mundial de clubes') || desc.includes('intercontinental')) return 'Mundial de Clubes';
            if (desc.includes('supercopa de espa√±a')) return 'Supercopa de Espa√±a';
            if (desc.includes('copa del rey')) return 'Copa del Rey';
            
            // --- FEMENINO ---
            // Detecta "Primera Divisi√≥n" aunque venga con may√∫sculas
            if (desc.includes('primera divisi√≥n') || desc.includes('primera division') || desc.includes('liga f')) return 'Liga F';
            
            // Detecta Champions Femenina
            if ((desc.includes('women') && desc.includes('champions')) || desc.includes('uwcl')) return 'UWCL';
            
            // Copas
            if (desc.includes('copa de la reina')) return 'Copa de la Reina';
            if (desc.includes('supercopa') && (desc.includes('femenina') || desc.includes('women'))) return 'Supercopa Femenina';

            // --- OTROS ---
            if (desc.includes('amistoso')) return 'Amistoso';

            return null;
        }
       // AHORA ACEPTA 'teamContext' PARA SABER QU√â EQUIPO ES DURANTE LA PRECARGA
        function parseICalData(icalData, teamContext = currentTeam) {
            const events = [];
            const normalizedData = icalData.replace(/\r\n /g, '').replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            const lines = normalizedData.split('\n');
            
            let currentEvent = null;
            
            for (let i = 0; i < lines.length; i++) {
                let line = lines[i];
                while (i + 1 < lines.length && (lines[i + 1].startsWith(' ') || lines[i + 1].startsWith('\t'))) {
                    i++;
                    line += lines[i].substring(1);
                }
                line = line.trim();
                if (!line) continue;
                
                if (line === 'BEGIN:VEVENT') {
                    currentEvent = {};
                } else if (line === 'END:VEVENT' && currentEvent) {
                    // Generar ID Determinista (UID o Hash) para persistencia
                    if (!currentEvent.id) {
                        if (currentEvent.uid) {
                            currentEvent.id = currentEvent.uid;
                        } else if (currentEvent.start && currentEvent.summary) {
                            const dateStr = currentEvent.start.toISOString();
                            let hash = 0;
                            const str = currentEvent.summary;
                            for (let j = 0; j < str.length; j++) {
                                hash = ((hash << 5) - hash) + str.charCodeAt(j);
                                hash |= 0;
                            }
                            currentEvent.id = `evt-${dateStr}-${Math.abs(hash)}`;
                        } else {
                            currentEvent.id = generateId();
                        }
                    }

                    if (currentEvent.summary && currentEvent.start) {
                        currentEvent.opponent = extractOpponent(currentEvent.summary);
                        currentEvent.venue = detectVenue(currentEvent.summary, currentEvent.location);
                        
                        // 1. Detecci√≥n por Descripci√≥n (Plan A)
                        let realComp = mapIcsCompetition(currentEvent.description);
                        
                        // CORRECCI√ìN AUTOM√ÅTICA USANDO teamContext
                        if (teamContext === 'femenino' && realComp) {
                            if (realComp === 'Champions League') realComp = 'UWCL';
                            if (realComp === 'Liga EA Sports') realComp = 'Liga F';
                            if (realComp === 'Copa del Rey') realComp = 'Copa de la Reina';
                            if (realComp === 'Supercopa de Espa√±a') realComp = 'Supercopa Femenina';
                        }
                        
                        if (realComp) {
                            currentEvent.competition = realComp; 
                            currentEvent.possibleCompetition = realComp;
                        } else {
                            // 2. Detecci√≥n por T√≠tulo (Plan B)
                            const summaryLower = currentEvent.summary.toLowerCase();
                            let detectedComp = null;
                            
                             if (summaryLower.includes('champions') || summaryLower.includes('uwcl')) {
                                 detectedComp = teamContext === 'femenino' ? 'UWCL' : 'Champions League';
                             }
                             else if (summaryLower.includes('copa')) {
                                 detectedComp = teamContext === 'femenino' ? 'Copa de la Reina' : 'Copa del Rey';
                             }
                             else if (summaryLower.includes('liga')) {
                                 detectedComp = teamContext === 'femenino' ? 'Liga F' : 'Liga EA Sports';
                             }
                             else if (summaryLower.includes('supercopa')) {
                                 detectedComp = teamContext === 'femenino' ? 'Supercopa Femenina' : 'Supercopa de Espa√±a';
                             }
                             
                             // Fallback por defecto
                             if (!detectedComp && teamContext === 'femenino') {
                                 detectedComp = 'Liga F';
                             }
                             
                             if (detectedComp) {
                                 currentEvent.competition = detectedComp;
                             }
                             
                             currentEvent.possibleCompetition = detectedComp || 'Partido Oficial';
                        }
                        
                        events.push(currentEvent);
                    }
                    currentEvent = null;
                } else if (currentEvent) {
                    const colonIndex = line.indexOf(':');
                    if (colonIndex > 0) {
                        let key = line.substring(0, colonIndex);
                        let value = line.substring(colonIndex + 1);
                        if (key.includes(';')) key = key.split(';')[0];
                        
                        if (key === 'SUMMARY') currentEvent.summary = value.replace(/\\,/g, ',').replace(/\\;/g, ';').replace(/\\n/g, ' ');
                        else if (key === 'DTSTART') currentEvent.start = parseICalDate(value);
                        else if (key === 'UID') currentEvent.uid = value.trim();
                        else if (key === 'LOCATION') currentEvent.location = value.replace(/\\,/g, ',').replace(/\\;/g, ';');
                        else if (key === 'DESCRIPTION') currentEvent.description = value.replace(/\\,/g, ',').replace(/\\;/g, ';').replace(/\\n/g, ' ');
                    }
                }
            }
            return events.filter(e => e.start).sort((a, b) => a.start - b.start);
        }
        
        function parseICalDate(dateStr) {
            if (!dateStr) return null;
            dateStr = dateStr.trim();
            try {
                const year = parseInt(dateStr.substring(0, 4));
                const month = parseInt(dateStr.substring(4, 6)) - 1;
                const day = parseInt(dateStr.substring(6, 8));
                if (dateStr.includes('T')) {
                    const hour = parseInt(dateStr.substring(9, 11)) || 0;
                    const minute = parseInt(dateStr.substring(11, 13)) || 0;
                    if (dateStr.endsWith('Z')) return new Date(Date.UTC(year, month, day, hour, minute));
                    return new Date(year, month, day, hour, minute);
                }
                return new Date(year, month, day, 21, 0);
            } catch (e) { return null; }
        }
        
        function extractOpponent(summary) {
            if (!summary) return 'Rival';
            let opponent = summary
                .replace(/real madrid c\.?f\.?/gi, '')
                .replace(/real madrid/gi, '')
                .replace(/vs\.?/gi, '')
                .replace(/\s*-\s*/g, ' ')
                .trim();
            const words = opponent.split(/\s+/).filter(w => w.length > 1);
            return words.length > 4 ? words.slice(0, 3).join(' ') : words.join(' ');
        }
        
        function detectVenue(summary, location) {
            const s = ((summary || '') + ' ' + (location || '')).toLowerCase();
            if (s.includes('bernab√©u') || s.includes('di st√©fano') || s.includes('valdebebas')) return 'local';
            if (summary && summary.toLowerCase().trim().startsWith('real madrid')) return 'local';
            return 'visitante';
        }
        
        function switchCalendarView(mode) {
            calendarViewMode = mode;
            document.getElementById('cal-view-list').className = mode === 'list' ? 
                'px-3 py-1.5 text-sm rounded-md font-medium transition bg-slate-800 text-white' : 
                'px-3 py-1.5 text-sm rounded-md font-medium transition text-gray-600 hover:bg-gray-100';
            document.getElementById('cal-view-month').className = mode === 'month' ? 
                'px-3 py-1.5 text-sm rounded-md font-medium transition bg-slate-800 text-white' : 
                'px-3 py-1.5 text-sm rounded-md font-medium transition text-gray-600 hover:bg-gray-100';
            
            const timeFilters = document.getElementById('cal-time-filters');
            const monthNav = document.getElementById('cal-month-nav');
            
            if (mode === 'list') {
                timeFilters.classList.remove('hidden');
                monthNav.classList.add('hidden');
            } else {
                timeFilters.classList.add('hidden');
                monthNav.classList.remove('hidden');
            }
            
            renderCalendar();
        }
        
        function changeCalendarMonth(delta) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
            renderCalendar();
        }

        function filterCalendar(comp) {
            currentCalendarFilter = comp;
            document.querySelectorAll('.cal-filter').forEach(btn => btn.classList.remove('bg-slate-800', 'text-white'));
            event.target.classList.add('bg-slate-800', 'text-white');
            renderCalendar();
        }
        
        function filterCalendarTime(time) {
            currentTimeFilter = time;
            document.querySelectorAll('.time-filter').forEach(btn => {
                btn.classList.remove('bg-slate-800', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            event.target.classList.remove('bg-gray-200', 'text-gray-700');
            event.target.classList.add('bg-slate-800', 'text-white');
            renderCalendar();
        }
        
        function renderCalendar() {
            hideRegisteredMatches = document.getElementById('hide-registered-matches').checked;
            if (calendarViewMode === 'list') {
                renderCalendarList();
            } else {
                renderCalendarMonth();
            }
        }
        
function renderCalendarList() {
    const container = document.getElementById('calendar-container');
    const now = new Date();
    now.setHours(23, 59, 59, 999);
    
    // üîí L√ìGICA DE PERMISOS:
    // Se permite editar si es LOCAL o si es GLOBAL + LOGUEADO
    const hasPermission = (typeof appMode !== 'undefined' && appMode === 'local') || 
                          (typeof appMode !== 'undefined' && appMode === 'global' && typeof currentUser !== 'undefined' && currentUser);

    const matches = getData('matches');
    const registeredEventIds = matches.map(m => m.calendarEventId);
    
    let events = [...calendarEvents];
    
    if (hideRegisteredMatches) {
        events = events.filter(e => !registeredEventIds.includes(e.id));
    }

    if (currentCalendarFilter) {
            events = events.filter(e => {
                const isReg = registeredEventIds.includes(e.id);
                if (isReg) {
                    const m = matches.find(m => m.calendarEventId === e.id);
                    return m.competition === currentCalendarFilter;
                } else {
                    return false; 
                }
            });
    }
    
    if (currentTimeFilter === 'past') events = events.filter(e => e.start <= now);
    else if (currentTimeFilter === 'future') events = events.filter(e => e.start > now);
    
    if (events.length === 0) {
        container.innerHTML = '<div class="text-center py-12 text-gray-500">No hay partidos.</div>';
        return;
    }
    
    container.innerHTML = events.map(event => {
        const isPast = event.start <= now;
        const isFuture = event.start > now;
        let isRegistered = registeredEventIds.includes(event.id);
        let registeredMatch = isRegistered ? matches.find(m => m.calendarEventId === event.id) : null;
        
        // Fallback: Verificar por Fecha y Rival
        if (!isRegistered) {
            const evtDate = event.start.toISOString().split('T')[0];
            registeredMatch = matches.find(m => {
                if (m.date !== evtDate) return false;
                const mOpp = m.opponent.toLowerCase().trim();
                const eOpp = event.opponent.toLowerCase().trim();
                return mOpp.includes(eOpp) || eOpp.includes(mOpp);
            });
            if (registeredMatch) isRegistered = true;
        }
        
        const dateStr = event.start.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
        const timeStr = event.start.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
        
        let compName = event.competition || 'Pendiente de registro';
        let compColorClass = 'bg-gray-200 text-gray-600';
        let borderColorClass = 'border-gray-300';

        if (isRegistered) {
            compName = registeredMatch.competition;
        }

        const compObj = Object.values(COMPETICIONES_ACTUALES).find(c => c.nombre === compName);
        if (compObj) {
            compColorClass = compObj.color;
            borderColorClass = compObj.borderColor;
        } else if (compName === 'Amistoso') {
            compColorClass = 'bg-yellow-100 text-yellow-800 border border-yellow-200';
        }

        const venueText = isRegistered ? (registeredMatch.venue === 'local' ? 'üè† Local' : (registeredMatch.venue === 'neutral' ? 'üèüÔ∏è Neutral' : '‚úàÔ∏è Visitante')) 
                                        : (event.venue === 'local' ? 'üè† Local' : (event.venue === 'neutral' ? 'üèüÔ∏è Neutral' : '‚úàÔ∏è Visitante'));
        
        // üîí DETERMINAR SI ES CLICABLE
        // Solo es clicable si: Es pasado + No registrado + TIENE PERMISO
        const isClickable = isPast && !isRegistered && hasPermission;

        return `
            <div class="bg-white rounded-xl shadow-sm p-4 match-card ${borderColorClass} ${isRegistered ? 'match-registered' : ''}" 
                    ${isClickable ? `onclick="selectCalendarFixture('${event.id}')"` : ''} 
                    style="cursor: ${isClickable ? 'pointer' : 'default'}">
                <div class="flex flex-col md:flex-row md:items-center gap-3">
                    <div class="flex-1">
                        <div class="flex flex-wrap items-center gap-2 mb-2">
                            <span class="${compColorClass} px-2 py-0.5 rounded text-xs font-medium">${compName}</span>
                            <span class="text-xs text-gray-500">${venueText}</span>
                            ${isRegistered ? '<span class="text-xs bg-gray-200 text-gray-700 px-2 py-0.5 rounded">‚úÖ Registrado</span>' : 
                                (isClickable ? '<span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded">üìù Clic para registrar</span>' : '')}
                        </div>
                        <h4 class="font-semibold text-gray-800">${event.opponent}</h4>
                        <p class="text-sm text-gray-500">üèüÔ∏è ${event.location || 'Estadio'}</p>
                        ${isFuture ? `<button onclick="event.stopPropagation(); generateMatchdayPoster('${event.id}')" class="mt-2 text-xs bg-indigo-50 text-indigo-600 border border-indigo-100 px-3 py-1 rounded-full font-bold hover:bg-indigo-100 transition flex items-center gap-1 w-fit shadow-sm"><span>üñºÔ∏è</span> Crear Cartel</button>` : ''}
                    </div>
                    <div class="text-right">
                        <p class="font-medium text-gray-800">${dateStr}</p>
                        <p class="text-amber-600 font-semibold">${timeStr}</p>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

function renderCalendarMonth() {
    const container = document.getElementById('calendar-container');
    const matches = getData('matches');
    const registeredEventIds = matches.map(m => m.calendarEventId);
    
    // üîí L√ìGICA DE PERMISOS:
    const hasPermission = (typeof appMode !== 'undefined' && appMode === 'local') || 
                          (typeof appMode !== 'undefined' && appMode === 'global' && typeof currentUser !== 'undefined' && currentUser);

    const year = currentCalendarDate.getFullYear();
    const month = currentCalendarDate.getMonth();
    
    document.getElementById('current-month-display').textContent = new Date(year, month).toLocaleDateString('es-ES', { month: 'long', year: 'numeric' }).toUpperCase();
    
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    
    let startDayOfWeek = firstDay.getDay() - 1;
    if (startDayOfWeek < 0) startDayOfWeek = 6;
    
    const totalDays = lastDay.getDate();
    
    let gridHtml = `
        <div class="calendar-grid bg-white rounded-xl overflow-hidden shadow-sm">
            <div class="calendar-day-header">LUN</div>
            <div class="calendar-day-header">MAR</div>
            <div class="calendar-day-header">MIE</div>
            <div class="calendar-day-header">JUE</div>
            <div class="calendar-day-header">VIE</div>
            <div class="calendar-day-header">SAB</div>
            <div class="calendar-day-header">DOM</div>
    `;
    
    for (let i = 0; i < startDayOfWeek; i++) {
        gridHtml += `<div class="calendar-day other-month"></div>`;
    }
    
    const now = new Date();
    now.setHours(0, 0, 0, 0);

    for (let day = 1; day <= totalDays; day++) {
        const currentDate = new Date(year, month, day);
        currentDate.setHours(0, 0, 0, 0);
        
        const isToday = currentDate.getTime() === now.getTime();
        
        const daysEvents = calendarEvents.filter(e => {
            const eDate = new Date(e.start);
            return eDate.getDate() === day && eDate.getMonth() === month && eDate.getFullYear() === year;
        });
        
        let eventsHtml = '';
        daysEvents.forEach(e => {
            let isRegistered = registeredEventIds.includes(e.id);
            
            if (!isRegistered) {
                const evtDate = e.start.toISOString().split('T')[0];
                const matchFound = matches.find(m => {
                    if (m.date !== evtDate) return false;
                    const mOpp = m.opponent.toLowerCase().trim();
                    const eOpp = e.opponent.toLowerCase().trim();
                    return mOpp.includes(eOpp) || eOpp.includes(mOpp);
                });
                if (matchFound) isRegistered = true;
            }

            if (hideRegisteredMatches && isRegistered) return;

            const isPast = e.start <= new Date();
            
            let style = 'background-color: #e5e7eb; color: #374151;'; 
            let title = e.opponent;

            let compName = e.competition; 
            if (isRegistered) {
                const m = matches.find(m => m.calendarEventId === e.id) || matches.find(m => {
                    if (m.date !== e.start.toISOString().split('T')[0]) return false;
                    const mOpp = m.opponent.toLowerCase().trim();
                    const eOpp = e.opponent.toLowerCase().trim();
                    return mOpp.includes(eOpp) || eOpp.includes(mOpp);
                });
                if (m) compName = m.competition;
            }

            if (compName) {
                    const compObj = Object.values(COMPETICIONES_ACTUALES).find(c => c.nombre === compName);
                    
                    if (compObj) {
                        const id = compObj.id;
                        if (id.includes('liga') || id === 'liga-f') style = 'background-color: #dbeafe; color: #1e40af;';
                        else if (id.includes('champions') || id === 'uwcl') style = 'background-color: #ede9fe; color: #5b21b6;';
                        else if (id.includes('copa')) style = 'background-color: #d1fae5; color: #065f46;';
                        else if (id.includes('mundial')) style = 'background-color: #fef3c7; color: #92400e;';
                        else if (id.includes('supercopa')) style = 'background-color: #fee2e2; color: #991b1b;';
                    } 
                    else if (compName === 'Amistoso') {
                        style = 'background-color: #fef9c3; color: #854d0e;'; 
                    }
            }

            if (isRegistered) {
                    style += ' text-decoration: line-through; opacity: 0.7; border: 1px solid rgba(0,0,0,0.1);';
            }

            // üîí APLICAR L√ìGICA DE PERMISOS AQU√ç
            // Si est√° en pasado, no registrado Y TIENE PERMISO => a√±ade onclick. Si no, nada.
            const action = (isPast && !isRegistered && hasPermission) ? `onclick="selectCalendarFixture('${e.id}')"` : '';
            // Opcional: Cambiar cursor si no tiene permiso
            const cursorStyle = (isPast && !isRegistered && !hasPermission) ? 'cursor: default;' : '';
            
            eventsHtml += `<div class="cal-event-dot" style="${style} ${cursorStyle}" ${action} title="${title}">
                ${e.start.getHours()}:${e.start.getMinutes().toString().padStart(2,'0')} ${e.opponent}
            </div>`;
        });
        
        gridHtml += `
            <div class="calendar-day ${isToday ? 'today' : ''}">
                <span class="day-number">${day}</span>
                ${eventsHtml}
            </div>
        `;
    }
    
    gridHtml += '</div>';
    container.innerHTML = gridHtml;
}

        // ==========================================
        // MATCH HELPERS
        // ==========================================
        
        function calculateMatchOutcome(result, venue) {
            if (!result || !result.includes('-')) return null;
            const parts = result.replace('*','').split('-');
            const homeGoals = parseInt(parts[0]);
            const awayGoals = parseInt(parts[1]);
            if (isNaN(homeGoals) || isNaN(awayGoals)) return null;
            
            if (homeGoals === awayGoals) return 'empate';
            
            if (venue === 'local') return homeGoals > awayGoals ? 'victoria' : 'derrota';
            if (venue === 'visitante') return awayGoals > homeGoals ? 'victoria' : 'derrota';
            
            return homeGoals > awayGoals ? 'victoria' : 'derrota';
        }

        function calculateAutoMVP(playerStats) {
            if (!playerStats || playerStats.length === 0) return '';
            let bestPlayer = null;
            let highestRating = -1;
            playerStats.forEach(ps => {
                if (ps.rating !== null && ps.rating !== "" && ps.rating > highestRating) {
                    highestRating = ps.rating;
                    bestPlayer = ps.playerId;
                }
            });
            return bestPlayer || '';
        }

        function getResultClass(outcome) {
            if (outcome === 'victoria') return 'result-win';
            if (outcome === 'empate') return 'result-draw';
            if (outcome === 'derrota') return 'result-loss';
            return 'bg-gray-100';
        }

        function getRatingColor(rating) {
            if (rating === '-' || rating === null) return 'text-gray-400';
            const num = parseFloat(rating);
            if (num >= 8) return 'text-emerald-600';
            if (num >= 6) return 'text-blue-600';
            if (num >= 5) return 'text-amber-600';
            return 'text-red-600';
        }

        // ==========================================
        // MATCH DISPLAY & ACTIONS
        // ==========================================
        // Funci√≥n para obtener el color exacto seg√∫n la escala solicitada
        function getTeamRatingColor(rating) {
            if (rating === '-' || !rating) return '#6b7280'; // Gris por defecto
            const num = parseFloat(rating);
            
            if (num < 5) return '#dc0c00';      // Rojo
            if (num >= 5 && num < 6) return '#ed7e07'; // Naranja
            if (num >= 6 && num < 7) return '#d9af00'; // Amarillo
            if (num >= 7 && num < 8) return '#00c424'; // Verde
            if (num >= 8) return '#00adc4';     // Azul
            
            return '#6b7280';
        }
function renderMatches(matchesData = null) {
    let matches = matchesData || getData('matches');
    const players = getPlayers();
    const container = document.getElementById('matches-list');
    const noMatches = document.getElementById('no-matches');
    
    const competitionFilter = document.getElementById('filter-competition').value;
    const venueFilter = document.getElementById('filter-venue').value;
    const resultFilter = document.getElementById('filter-result').value;
    
    if (competitionFilter) matches = matches.filter(m => m.competition === competitionFilter);
    if (venueFilter) matches = matches.filter(m => m.venue === venueFilter);
    if (resultFilter) matches = matches.filter(m => m.outcome === resultFilter);
    
    if (!matches || matches.length === 0) {
        container.innerHTML = '';
        if(noMatches) noMatches.classList.remove('hidden');
        return;
    }
    
    if(noMatches) noMatches.classList.add('hidden');
    
    // Ordenar por fecha descendente
    matches.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    container.innerHTML = matches.map(match => {
        // Determinar si es editable
        const isEditable = appMode === 'local' || (appMode === 'global' && currentUser);

        const mvpPlayer = players.find(p => p.id === match.mvp);
        const totalGoals = match.playerStats ? match.playerStats.reduce((sum, ps) => sum + (ps.goals || 0), 0) : 0;
        const outcomeClass = getResultClass(match.outcome);
        const compColor = COMPETICIONES_ACTUALES[match.competition]?.color || 'bg-gray-200';
        
        // C√°lculo de nota media
        let totalRating = 0;
        let ratedCount = 0;
        if (match.playerStats) {
            match.playerStats.forEach(ps => {
                if (ps.rating !== null && ps.rating !== "" && ps.rating !== undefined) {
                    totalRating += parseFloat(ps.rating);
                    ratedCount++;
                }
            });
        }
        const teamAvg = ratedCount > 0 ? (totalRating / ratedCount).toFixed(2) : '-';
        const ratingColor = getTeamRatingColor(teamAvg);

        // --- VALORES NUEVOS (Con protecci√≥n para partidos antiguos) ---
        const squadValue = match.valorPlantilla || 0;
        const squadAge = match.edadMedia || '-';

        const actionButtons = isEditable ? `
            <button onclick="editMatch('${match.id}')" class="flex-1 px-3 py-1.5 text-xs font-bold bg-blue-50 text-blue-600 rounded hover:bg-blue-100 transition text-center">
                ‚úèÔ∏è EDIT
            </button>
            <button onclick="deleteMatch('${match.id}')" class="px-3 py-1.5 text-xs font-bold bg-red-50 text-red-600 rounded hover:bg-red-100 transition text-center" title="Eliminar">
                üóëÔ∏è
            </button>
        ` : '';

        return `
            <div class="card bg-white rounded-xl shadow-sm p-4 mb-3 border border-gray-100">
                <div class="flex flex-col sm:flex-row sm:items-center gap-4">
                    
                    <div class="flex-1">
                        <div class="flex flex-wrap items-center gap-2 mb-2">
                            <span class="text-gray-500 text-xs font-mono">${formatDate(match.date)}</span>
                            <span class="${compColor} px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide">${match.competition}</span>
                            <span class="text-xs text-gray-400">üìç ${match.venue}</span>
                            ${match.round ? `<span class="text-xs text-gray-400">‚Ä¢ ${match.round}</span>` : ''}
                            ${match.result ? `<span class="${outcomeClass} px-2 py-0.5 rounded text-xs font-bold ml-auto sm:ml-2">${match.result}</span>` : ''}
                        </div>

                        <h3 class="text-xl font-black text-gray-800 tracking-tight leading-none mb-3">
                            <span class="text-gray-400 font-normal text-base">vs</span> ${match.opponent}
                        </h3>
                        
                        <div class="flex flex-wrap gap-3 text-xs text-gray-600 items-center bg-gray-50 p-2 rounded-lg border border-gray-100">
                            
                            <span class="font-bold flex items-center gap-1">
                                ‚öΩ ${totalGoals}
                            </span>
                            
                            <span class="border-l border-gray-300 pl-3 font-bold flex items-center gap-1" style="color: ${ratingColor}">
                                üìä ${teamAvg}
                            </span>

                            <span class="border-l border-gray-300 pl-3 flex items-center gap-1 text-emerald-700" title="Valor Convocatoria">
                                üí∞ <span class="font-bold">${squadValue} M‚Ç¨</span>
                            </span>

                            <span class="border-l border-gray-300 pl-3 flex items-center gap-1 text-blue-700" title="Edad Media XI Inicial">
                                üéÇ <span class="font-bold">${squadAge} a√±os</span>
                            </span>
                            
                            ${mvpPlayer ? `
                                <span class="text-amber-600 border-l border-gray-300 pl-3 flex items-center gap-1 font-bold">
                                    üèÜ ${mvpPlayer.apodo || mvpPlayer.nombre}
                                </span>` : ''}
                        </div>

                    </div>

                    <div class="flex sm:flex-col gap-2 border-t sm:border-t-0 sm:border-l border-gray-100 pt-3 sm:pt-0 sm:pl-3 justify-end">
                        <button onclick="viewMatchDetails('${match.id}')" class="flex-1 px-3 py-1.5 text-xs font-bold bg-slate-100 text-slate-600 rounded hover:bg-slate-200 transition text-center">
                            üëÅÔ∏è VER
                        </button>
                        ${actionButtons}
                    </div>
                </div>
            </div>
        `;
    }).join('');
}
        
function viewMatchDetails(matchId) {
    const matches = getData('matches');
    const match = matches.find(m => m.id === matchId);
    if (!match) return;

    // 1. Crear Modal
    let modal = document.getElementById('match-details-modal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'match-details-modal';
        modal.className = "fixed inset-0 bg-black/80 hidden z-[9999] items-center justify-center backdrop-blur-sm";
        // Aumentamos altura m√°xima para que quepa bien el campo grande
        modal.innerHTML = `<div id="match-details-content" class="bg-white rounded-xl w-full max-w-4xl h-[95vh] shadow-2xl overflow-hidden relative flex flex-col m-4"></div>`;
        document.body.appendChild(modal);
    }
    
    const content = document.getElementById('match-details-content');

    // 2. Timeline
    const timelineHtml = (typeof renderMatchTimeline === 'function') 
        ? renderMatchTimeline(match) 
        : '<div class="p-4 text-center text-gray-400">Timeline no disponible</div>';

    // 3. Generar Lista de Jugadores (Ahora m√°s ancha)
    const players = getPlayers();
    
    // Ordenar stats para visualizaci√≥n
    const sortedStats = [...match.playerStats].sort((a, b) => {
        if (a.isStarter && !b.isStarter) return -1;
        if (!a.isStarter && b.isStarter) return 1;
        if (a.isStarter && b.isStarter) {
             if (typeof a.pitchSlot === 'number' && typeof b.pitchSlot === 'number') {
                 return a.pitchSlot - b.pitchSlot;
             }
        }
        return 0;
    });

    const statsHtml = sortedStats.map(ps => {
        const p = players.find(pl => pl.id === ps.playerId) || { apodo: '?', apellido: '?' };
        if (!ps.played && !ps.isStarter && !ps.goals && !ps.yellowCards && !ps.redCards) return '';

        let metas = [];
        if (ps.goals > 0) metas.push(`<span class="bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded text-xs font-bold">‚öΩ ${ps.detailGoals || ps.goals}</span>`);
        if (ps.assists > 0) metas.push(`<span class="bg-blue-50 text-blue-600 px-2 py-0.5 rounded text-xs">üëü ${ps.assists}</span>`);
        if (ps.yellowCards > 0) metas.push(`<span class="bg-yellow-100 text-yellow-700 px-1.5 py-0.5 rounded text-xs">üü®</span>`);
        if (ps.redCards > 0) metas.push(`<span class="bg-red-100 text-red-700 px-1.5 py-0.5 rounded text-xs">üü•</span>`);

        return `
            <div class="flex justify-between items-center py-3 border-b border-gray-100 last:border-0 hover:bg-gray-50 px-4 transition-colors">
                <div class="flex items-center gap-4">
                    <div class="w-8 text-center text-sm font-bold text-gray-400 bg-gray-100 rounded">${p.dorsal || '-'}</div>
                    <img src="${p.foto}" class="w-10 h-10 rounded-full object-cover border border-gray-200">
                    <div>
                        <div class="text-sm font-bold text-gray-800">${p.apodo}</div>
                        ${ps.isStarter ? '<span class="text-[10px] uppercase font-bold text-green-600">Titular</span>' : '<span class="text-[10px] uppercase font-bold text-gray-400">Suplente</span>'}
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="flex gap-2">${metas.join('')}</div>
                    <div class="text-xs font-mono text-gray-500 bg-gray-100 px-2 py-1 rounded">Min ${ps.minutes}'</div>
                    <div class="w-10 h-10 flex items-center justify-center font-black text-lg rounded-lg ${getRatingColor ? getRatingColor(ps.rating) : 'bg-gray-200 text-gray-600'}">
                        ${ps.rating || '-'}
                    </div>
                </div>
            </div>
        `;
    }).join('');

    // 4. Inyectar HTML con PESTA√ëAS (Y BOT√ìN DE FOTO)
    content.innerHTML = `
        <div class="bg-slate-900 text-white p-4 shrink-0 relative overflow-hidden shadow-lg z-10 print:hidden">
            
            <div class="absolute top-4 right-4 flex gap-2 z-50">
                <button onclick="downloadMatchCard('${match.id}')" title="Descargar Ficha" 
                        class="text-white/50 hover:text-yellow-400 hover:bg-white/10 rounded-full w-8 h-8 flex items-center justify-center transition cursor-pointer">
                    üì∑
                </button>
                
                <button onclick="closeViewMatchModal()" 
                        class="text-white/50 hover:text-white hover:bg-white/10 rounded-full w-8 h-8 flex items-center justify-center transition cursor-pointer">
                    ‚úï
                </button>
            </div>
            
            <div class="flex justify-between items-center relative z-10 max-w-3xl mx-auto">
                <div class="text-center w-1/3">
                    <div class="text-3xl font-bold tracking-tighter text-yellow-400 filter drop-shadow-lg">REAL MADRID</div>
                </div>
                <div class="text-center w-1/3">
                    <div class="text-5xl font-black mb-1">${match.result}</div>
                    <div class="text-xs uppercase tracking-widest text-white/60 bg-white/10 px-2 py-1 rounded-full inline-block">${match.opponent}</div>
                </div>
                <div class="text-center w-1/3 opacity-90">
                    <div class="text-2xl font-bold truncate">${match.opponent}</div>
                </div>
            </div>
        </div>

        <div class="bg-white border-b border-gray-200 shadow-sm z-0">
            ${timelineHtml}
        </div>

        <div class="flex border-b border-gray-200 bg-white shrink-0">
            <button id="btn-tab-stats" onclick="switchViewTab('stats')" class="flex-1 py-3 text-sm font-bold text-indigo-600 border-b-2 border-indigo-600 bg-indigo-50/50 transition">
                üìä Estad√≠sticas y Notas
            </button>
            <button id="btn-tab-pitch" onclick="switchViewTab('pitch')" class="flex-1 py-3 text-sm font-bold text-gray-400 border-b-2 border-transparent hover:text-gray-600 transition">
                üèüÔ∏è Esquema Inicial
            </button>
        </div>

        <div class="flex-1 overflow-hidden bg-gray-50 relative">
            
            <div id="view-tab-stats" class="absolute inset-0 overflow-y-auto p-4 animate-in fade-in duration-300">
                <div class="max-w-3xl mx-auto bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    ${statsHtml || '<div class="p-8 text-center text-gray-400">Sin datos registrados</div>'}
                </div>
            </div>

            <div id="view-tab-pitch" class="absolute inset-0 hidden p-4 animate-in fade-in duration-300 flex items-center justify-center">
                <div class="w-full max-w-4xl h-full max-h-[600px] bg-emerald-800 rounded-xl shadow-2xl border-4 border-white/20 overflow-hidden relative">
                     <div class="pitch-container w-full h-full" style="margin:0; border:none; border-radius:0; pointer-events: none;">
                        <div class="pitch-line-mid"></div><div class="pitch-circle"></div>
                        <div class="pitch-box-left" style="left:0; border-left:none;"></div>
                        <div class="pitch-box-right" style="right:0; border-right:none;"></div>
                        
                        <div id="readonly-pitch-players-layer"></div>
                     </div>
                     
                     <div class="absolute top-4 right-4 bg-black/50 text-white px-3 py-1 rounded-full text-xs font-bold backdrop-blur-sm border border-white/20">
                        ${match.formation || '4-3-3'}
                     </div>
                </div>
            </div>

        </div>
    `;

    // 5. RENDERIZAR PIZARRA (TRUCO GLOBAL)
    const savedPitch = { ...currentPitchPlayers };
    const savedForm = currentFormation;
    const savedSubs = [...currentSubstitutes];

    const tempPitch = {};
    match.playerStats.forEach(ps => {
        if (ps.isStarter && ps.pitchSlot !== undefined && ps.pitchSlot !== null) {
            tempPitch[`readonly-slot-${ps.pitchSlot}`] = ps.playerId;
        }
    });

    currentPitchPlayers = tempPitch;
    currentFormation = match.formation || "4-3-3";
    currentSubstitutes = [];

    if (typeof renderTacticalBoard === 'function') {
        renderTacticalBoard('readonly-');
    }

    currentPitchPlayers = savedPitch;
    currentFormation = savedForm;
    currentSubstitutes = savedSubs;

    // 6. MOSTRAR
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    lockScroll();
}
/* ========================================================= */
/* üîÑ CAMBIAR PESTA√ëAS EN "VER DETALLES"                     */
/* ========================================================= */
function switchViewTab(tabName) {
    // Botones
    const btnStats = document.getElementById('btn-tab-stats');
    const btnPitch = document.getElementById('btn-tab-pitch');
    
    // Contenedores
    const contentStats = document.getElementById('view-tab-stats');
    const contentPitch = document.getElementById('view-tab-pitch');

    // Resetear estilos
    btnStats.className = "flex-1 py-3 text-sm font-bold text-gray-400 border-b-2 border-transparent hover:text-gray-600 transition";
    btnPitch.className = "flex-1 py-3 text-sm font-bold text-gray-400 border-b-2 border-transparent hover:text-gray-600 transition";
    
    contentStats.classList.add('hidden');
    contentPitch.classList.add('hidden');

    // Activar el seleccionado
    if (tabName === 'stats') {
        btnStats.className = "flex-1 py-3 text-sm font-bold text-indigo-600 border-b-2 border-indigo-600 bg-indigo-50/50";
        contentStats.classList.remove('hidden');
    } else {
        btnPitch.className = "flex-1 py-3 text-sm font-bold text-emerald-600 border-b-2 border-emerald-600 bg-emerald-50/50";
        contentPitch.classList.remove('hidden');
    }
}
        
        function deleteMatch(matchId) {
            if (!confirm('¬øEst√°s seguro de eliminar este partido?')) return;
            
            let matches = getData('matches');
            const matchToDelete = matches.find(m => m.id === matchId);
            if (!matchToDelete) return;
            
            const compName = matchToDelete.competition;
            matches = matches.filter(m => m.id !== matchId);
            saveData('matches', matches);
            
            recalculateCompetitionState(compName);
            
            renderMatches();
            renderCalendar(); 
        }
        
            // --- 1. FUNCI√ìN EDITAR PARTIDO (CORRECCI√ìN CSV: SOBRANTES AL BANQUILLO) ---
// Variable global temporal para la edici√≥n
let editPitchPlayers = {}; 

function editMatch(matchId) {
    const matches = getData('matches');
    const match = matches.find(m => m.id === matchId);
    if (!match) return alert("Error: Partido no encontrado.");

    const modal = document.getElementById('edit-match-modal');
    const content = document.getElementById('edit-match-content');
    
    if (!modal || !content) return alert("Falta HTML del modal");

    document.body.appendChild(modal);
    modal.dataset.matchId = matchId; 

    // --- CARGAR JUGADORES Y FORMACI√ìN ---
    const players = getPlayers(); 
    currentPitchPlayers = {}; 
    currentSubstitutes = [];
    currentFormation = match.formation || "4-3-3"; 

    match.playerStats.forEach(ps => {
        const pInfo = players.find(pl => pl.id === ps.playerId);
        if (pInfo && pInfo.posicion === 'entrenador') return;
        if (ps.isStarter) {
            if (ps.pitchSlot !== null && ps.pitchSlot !== undefined) {
                currentPitchPlayers[`edit-slot-${ps.pitchSlot}`] = ps.playerId;
            } else {
                for(let i=0; i<11; i++) {
                    if(!currentPitchPlayers[`edit-slot-${i}`]){ currentPitchPlayers[`edit-slot-${i}`]=ps.playerId; break;}
                }
            }
        } else if (ps.played) currentSubstitutes.push(ps.playerId);
    });

    // ============================================================
    // üîç SECCI√ìN L√ìGICA DE RONDAS (CORREGIDA)
    // ============================================================
    
    let compData = null;
    
    if (typeof COMPETICIONES_ACTUALES !== 'undefined') {
        // 1. Buscar la competici√≥n (Exacta o Flexible)
        compData = COMPETICIONES_ACTUALES[match.competition];
        
        if (!compData) {
            const compKey = Object.keys(COMPETICIONES_ACTUALES).find(key => 
                key.trim().toLowerCase() === (match.competition || '').trim().toLowerCase()
            );
            if (compKey) compData = COMPETICIONES_ACTUALES[compKey];
        }
    }

    let roundOptionsHTML = "";
    let availableRounds = [];

    // 2. EXTRAER RONDAS (Aqu√≠ estaba el fallo anterior)
    if (compData) {
        if (compData.rondas && Array.isArray(compData.rondas)) {
            // Caso A: Rondas directas (Copa simple)
            availableRounds = compData.rondas;
        } else if (compData.fases && Array.isArray(compData.fases)) {
            // Caso B: Rondas dentro de Fases (TU CASO: Liga EA Sports)
            // Aplanamos todas las rondas de todas las fases
            availableRounds = compData.fases.flatMap(fase => fase.rondas || []);
        }
    }

    // 3. GENERAR HTML SI HAY RONDAS
    if (availableRounds.length > 0) {
        
        // Buscamos rondas ocupadas por OTROS partidos
        const otherMatches = matches.filter(m => 
            (m.competition || '').toLowerCase() === (match.competition || '').toLowerCase() && 
            m.id !== matchId
        );
        const takenRoundIds = otherMatches.map(m => m.roundId);

        roundOptionsHTML = availableRounds.map(r => {
            // A. Es la ronda actual?
            const isCurrent = (r.id === match.roundId) || (r.nombre === match.round);

            // B. Est√° ocupada?
            const isTaken = takenRoundIds.includes(r.id);

            // C. Estilos
            let icon = 'üü¢';
            let disabled = '';
            let style = '';

            if (isCurrent) {
                icon = 'üìç'; 
                style = 'font-weight: bold; color: black;'; 
            } else if (isTaken) {
                icon = '‚úÖ'; // Cambiado a Check si ya est√° jugada
                disabled = 'disabled';
                style = 'color: #9ca3af; background-color: #f3f4f6;';
            }

            return `<option value="${r.id}" ${isCurrent ? 'selected' : ''} ${disabled} style="${style}">
                ${icon} ${r.nombre}
            </option>`;
        }).join('');
        
    } else {
        // Fallback
        console.warn("‚ö†Ô∏è Estructura de rondas no reconocida o vac√≠a.");
        roundOptionsHTML = `<option value="${match.roundId || 'custom'}" selected>${match.round || 'Desconocida'}</option>`;
    }
    // ============================================================


    // --- HTML ---
    content.innerHTML = `
        <div class="h-full flex flex-col bg-gray-50">
            
            <div class="bg-white p-3 border-b border-gray-200 shadow-sm shrink-0 grid grid-cols-1 md:grid-cols-4 gap-3">
                 <input type="hidden" id="edit-match-id" value="${match.id}">
                 
                 <div>
                    <label class="text-[10px] font-bold text-gray-400">RESULTADO</label>
                    <input type="text" id="edit-result-val" value="${match.result}" class="w-full border rounded px-2 py-1 font-bold text-center">
                 </div>

                 <div class="md:col-span-3 flex items-end pb-1">
                    <div class="w-full bg-amber-50 border border-amber-200 text-amber-700 px-3 py-1 rounded text-xs font-bold flex justify-between items-center">
                        
                        <span>RIVAL: ${match.opponent} <span class="text-[10px] text-amber-500 font-normal">(${match.competition})</span></span>
                        
                        <div class="flex items-center gap-2">
                            <label for="edit-round-select" class="text-[10px] text-amber-600">RONDA:</label>
                            <select id="edit-round-select" 
                                   class="border border-amber-300 rounded px-2 py-0.5 text-xs font-bold text-amber-800 bg-white min-w-[140px] focus:outline-none focus:ring-1 focus:ring-amber-500 cursor-pointer">
                                ${roundOptionsHTML}
                            </select>
                        </div>

                    </div>
                 </div>
            </div>

            <div id="edit-step-lineup" class="flex flex-col flex-1 h-full p-2 overflow-hidden">
                <div class="mb-2 flex justify-between items-center bg-white p-2 rounded-xl border shadow-sm">
                    <div class="flex items-center gap-2">
                        <span class="text-xs font-bold text-gray-500">ESQUEMA:</span>
                        <select id="edit-formation-select" class="border rounded text-sm font-bold p-1 bg-gray-50" onchange="updatePitchFormation('edit-')">
                            <option value="4-3-3" ${currentFormation==='4-3-3'?'selected':''}>4-3-3</option>
                            <option value="4-4-2" ${currentFormation==='4-4-2'?'selected':''}>4-4-2</option>
                            <option value="4-2-3-1" ${currentFormation==='4-2-3-1'?'selected':''}>4-2-3-1</option>
                            <option value="3-5-2" ${currentFormation==='3-5-2'?'selected':''}>3-5-2</option>
                        </select>
                    </div>
                    <button onclick="goToEditStats()" class="bg-slate-800 hover:bg-slate-700 text-white font-bold py-1.5 px-4 rounded shadow text-xs flex items-center gap-1">
                        Siguiente: Stats ‚û°Ô∏è
                    </button>
                </div>

                <div class="flex flex-col md:flex-row gap-2 h-[550px] min-h-0">
                    <div class="flex-1 relative bg-emerald-800 rounded-xl border-4 border-white/20 overflow-hidden shadow-xl">
                        <div class="pitch-container w-full h-full" style="margin:0; border:none; border-radius:0;">
                            <div class="pitch-line-mid"></div><div class="pitch-circle"></div>
                            <div class="pitch-box-left" style="left:0; border-left:none;"></div>
                            <div class="pitch-box-right" style="right:0; border-right:none;"></div>
                            <div id="edit-pitch-players-layer"></div>
                        </div>
                    </div>

                    <div class="w-full md:w-64 flex flex-col gap-2 h-full">
                        <div class="flex-1 bg-white rounded-xl border border-gray-300 flex flex-col shadow-sm overflow-hidden">
                            <div class="bg-gray-100 p-1.5 border-b text-[10px] font-bold text-center text-gray-500 uppercase">Plantilla Disponible</div>
                            <div id="edit-bench-zone" class="flex-1 overflow-y-auto bg-gray-50" ondragover="allowDrop(event)" ondrop="dropToBench(event, 'edit-')"></div>
                        </div>
                        <div class="h-1/3 bg-blue-50 rounded-xl border-2 border-dashed border-blue-300 flex flex-col overflow-hidden">
                            <div class="bg-blue-100 p-1.5 border-b border-blue-200 text-[10px] font-bold text-center text-blue-600 uppercase">Suplentes (Jugaron)</div>
                            <div id="edit-subs-zone" class="flex-1 p-2 flex flex-wrap gap-2 content-start overflow-y-auto" ondragover="allowDrop(event)" ondrop="dropToSubs(event, 'edit-')"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="edit-step-stats" class="hidden flex-col flex-1 h-full p-4 overflow-hidden">
                <div id="edit-stats-list" class="flex-1 overflow-y-auto border rounded-xl p-4 bg-white space-y-2"></div>
                <div class="flex justify-end gap-3 pt-4 border-t mt-2">
                    <button onclick="backToEditLineup()" class="text-gray-500 font-bold px-4">‚¨ÖÔ∏è Volver a Pizarra</button>
                    <button onclick="handleEditMatchSubmit()" class="bg-emerald-600 text-white font-bold py-2 px-6 rounded shadow hover:bg-emerald-700">üíæ GUARDAR CAMBIOS</button>
                </div>
            </div>
        </div>
    `;

    renderTacticalBoard('edit-'); 
    renderBench('edit-');

    modal.classList.remove('hidden');
    modal.classList.add('flex');
    modal.style.display = 'flex';
    lockScroll();
}

function renderEditStatsList(match, allPlayers) {
    const statsList = document.getElementById('edit-stats-list');
    
    // Combinamos los jugadores del campo + banquillo actuales para asegurar consistencia
    // OJO: Usamos los datos guardados en 'match' como base, pero la lista debe reflejar todos
    
    let participants = match.playerStats.map(ps => {
        const pInfo = allPlayers.find(pl => pl.id === ps.playerId) || { apodo: '?', foto: '' };
        return { ...pInfo, ...ps };
    });
    
    participants.sort((a, b) => {
        if (a.isStarter && !b.isStarter) return -1;
        if (!a.isStarter && b.isStarter) return 1;
        if (a.isStarter && b.isStarter) {
             if (typeof a.pitchSlot === 'number' && typeof b.pitchSlot === 'number') {
                 return a.pitchSlot - b.pitchSlot;
             }
        }
        return 0;
    });

    statsList.innerHTML = participants.map(p => {
        const prefix = 'edit-'; 
        const goalId = `${prefix}goals-${p.playerId}`;
        const assistId = `${prefix}assists-${p.playerId}`;
        const yellowId = `${prefix}yellow-${p.playerId}`;
        const redId = `${prefix}red-${p.playerId}`;

        const isStarter = p.isStarter; // Esto se actualizar√° al guardar seg√∫n la pizarra
        let badgeHtml = isStarter 
            ? `<span class="bg-emerald-100 text-emerald-700 text-[10px] font-bold px-2 py-1 rounded border border-emerald-200 uppercase">TITULAR</span>`
            : '<span class="bg-blue-50 text-blue-600 text-[10px] font-bold px-2 py-1 rounded border border-blue-100 uppercase">SUPLENTE</span>';

        const btnClass = "w-full h-8 bg-white border border-gray-300 rounded text-xs font-bold hover:border-indigo-400 flex items-center justify-center";
        const getStyle = (c) => c > 0 ? "bg-indigo-100 text-indigo-700 border-indigo-300" : "text-gray-600";
        const getCardStyle = (c, color) => c > 0 ? `bg-${color}-100 text-${color}-700 border-${color}-300` : `bg-${color}-50 text-${color}-700/50 border-${color}-100`;

        return `
        <div class="bg-white rounded p-2 border border-gray-200 flex flex-col md:flex-row items-center gap-3 shadow-sm" 
             data-player-id="${p.playerId}"> 
             
            <div class="flex items-center gap-2 w-full md:w-1/3">
                <img src="${p.foto}" class="w-8 h-8 rounded-full border">
                <div class="min-w-0">
                    <div class="flex items-center gap-2">
                        <span class="font-bold text-gray-800 text-sm truncate">${p.apodo}</span>
                        ${badgeHtml}
                    </div>
                </div>
            </div>

            <div class="flex-1 grid grid-cols-5 gap-2 w-full">
                <div><label class="text-[8px] font-bold text-gray-400">NOTA</label>
                <input type="number" class="stat-rating w-full h-8 px-1 border rounded text-center text-sm font-bold" min="0" max="10" step="0.1" value="${p.rating || ''}"></div>

                <div><label class="text-[8px] font-bold text-gray-400">GOL</label>
                <input type="hidden" class="stat-goals-minutes" id="${goalId}" value="${p.detailGoals || ''}">
                <button onclick="openMinuteModal('${goalId}', 'Goles')" class="${btnClass} ${getStyle(p.goals)}">${p.goals}</button></div>

                <div><label class="text-[8px] font-bold text-gray-400">ASIS</label>
                <input type="hidden" class="stat-assists-minutes" id="${assistId}" value="${p.detailAssists || ''}">
                <button onclick="openMinuteModal('${assistId}', 'Asistencias')" class="${btnClass} ${getStyle(p.assists)}">${p.assists}</button></div>
                
                <div><label class="text-[8px] font-bold text-gray-400">MIN</label>
                <input type="number" class="stat-minutes w-full h-8 px-1 border rounded text-center text-sm font-mono" value="${p.minutes}"></div>

                <div class="flex gap-1">
                    <div class="flex-1"><label class="text-[8px] font-bold text-gray-400">AMA</label>
                    <input type="hidden" class="stat-yellow-minutes" id="${yellowId}" value="${p.detailYellow || ''}">
                    <button onclick="openMinuteModal('${yellowId}', 'Amarilla')" class="${btnClass} ${getCardStyle(p.yellowCards, 'yellow')}">${p.yellowCards}</button></div>
                    
                    <div class="flex-1"><label class="text-[8px] font-bold text-gray-400">ROJ</label>
                    <input type="hidden" class="stat-red-minutes" id="${redId}" value="${p.detailRed || ''}">
                    <button onclick="openMinuteModal('${redId}', 'Roja')" class="${btnClass} ${getCardStyle(p.redCards, 'red')}">${p.redCards}</button></div>
                </div>
            </div>
        </div>`;
    }).join('');
}

// --- FUNCI√ìN AUXILIAR PARA CAMBIAR PESTA√ëAS ---
function switchEditTab(tabName) {
    const tabLineup = document.getElementById('edit-tab-lineup');
    const tabStats = document.getElementById('edit-tab-stats');
    const btnLineup = document.getElementById('tab-btn-lineup');
    const btnStats = document.getElementById('tab-btn-stats');

    if (tabName === 'lineup') {
        tabLineup.classList.remove('hidden');
        tabStats.classList.add('hidden');
        // Estilos Botones
        btnLineup.classList.add('text-indigo-600', 'border-indigo-600');
        btnLineup.classList.remove('text-gray-500', 'border-transparent');
        btnStats.classList.remove('text-indigo-600', 'border-indigo-600');
        btnStats.classList.add('text-gray-500', 'border-transparent');
    } else {
        tabLineup.classList.add('hidden');
        tabStats.classList.remove('hidden');
        // Estilos Botones
        btnStats.classList.add('text-indigo-600', 'border-indigo-600');
        btnStats.classList.remove('text-gray-500', 'border-transparent');
        btnLineup.classList.remove('text-indigo-600', 'border-indigo-600');
        btnLineup.classList.add('text-gray-500', 'border-transparent');
    }
}

// --- FUNCI√ìN AUXILIAR PARA PINTAR LA PIZARRA DE EDICI√ìN ---
function renderEditPitchVisuals(allPlayers) {
    const container = document.getElementById('edit-pitch-container');
    container.innerHTML = ''; // Limpiar

    // Coordenadas fijas (basadas en 4-4-2 o lo que uses, simplificado)
    // Usamos porcentajes para que escale. [top%, left%]
    const formationSlots = [
        {t: 85, l: 45}, // 0: Portero
        {t: 65, l: 15}, {t: 65, l: 35}, {t: 65, l: 55}, {t: 65, l: 75}, // Defensas
        {t: 40, l: 15}, {t: 40, l: 35}, {t: 40, l: 55}, {t: 40, l: 75}, // Medios
        {t: 15, l: 35}, {t: 15, l: 55}  // Delanteros
    ];
    // NOTA: Si quieres usar tu formaci√≥n real (4-3-3, etc), tendr√≠as que importar tus coordenadas 'POSITIONS'. 
    // Por simplicidad, aqu√≠ pinto 11 huecos gen√©ricos, pero si tu 'renderMatches' usa coordenadas reales, c√≥pialas aqu√≠.

    // Recorremos los 11 slots posibles
    for (let i = 0; i < 11; i++) {
        const playerId = editPitchPlayers[`edit-slot-${i}`];
        if (playerId) {
            const player = allPlayers.find(p => p.id === playerId);
            if (player) {
                // Posici√≥n (Si tienes las coordenadas reales importadas, √∫salas. Si no, usa el array simple de arriba)
                // Si tu app ya tiene variable 'POSITIONS', usa: const pos = POSITIONS['4-3-3'][i];
                const pos = formationSlots[i] || {t: 50, l: 50}; 

                const el = document.createElement('div');
                el.className = "absolute flex flex-col items-center justify-center w-16 transform -translate-x-1/2 -translate-y-1/2 transition-all";
                el.style.top = pos.t + '%';
                el.style.left = pos.l + '%';
                
                el.innerHTML = `
                    <div class="w-10 h-10 rounded-full border-2 border-white shadow-lg overflow-hidden bg-white">
                        <img src="${player.foto}" class="w-full h-full object-cover">
                    </div>
                    <span class="mt-1 bg-black/70 text-white text-[9px] font-bold px-1.5 py-0.5 rounded shadow backdrop-blur-sm truncate max-w-full">
                        ${player.apodo}
                    </span>
                `;
                container.appendChild(el);
            }
        }
    }
}
function executeEditSave() {
    console.log("üíæ Ejecutando guardado...");

    // 1. RECUPERAR ID DEL TATUAJE
    const modal = document.getElementById('edit-match-modal');
    const matchId = modal.dataset.matchId;

    if (!matchId) {
        alert("‚ùå Error Cr√≠tico: El modal ha perdido el ID del partido.");
        return;
    }

    const matches = getData('matches');
    const matchIndex = matches.findIndex(m => m.id === matchId); // OJO: Si id es n√∫mero, usar ==, si es string ===
    
    if (matchIndex === -1) { 
        alert("‚ùå Error: No se encuentra el partido en la base de datos."); 
        return; 
    }
    
    const match = matches[matchIndex];
    const statsContainer = document.getElementById('edit-stats-list');
    const playerStats = [];
    
    // 2. LEER DATOS
    statsContainer.querySelectorAll('[data-player-id]').forEach(row => {
        const playerId = row.getAttribute('data-player-id');
        const specificPos = row.getAttribute('data-specific-pos');
        const isBadgeStarter = row.querySelector('.bg-emerald-100') !== null;
        
        // LEER INPUTS OCULTOS
        const goalsStr = row.querySelector('.stat-goals-minutes')?.value || "";
        const assistsStr = row.querySelector('.stat-assists-minutes')?.value || "";
        const yellowStr = row.querySelector('.stat-yellow-minutes')?.value || "";
        const redStr = row.querySelector('.stat-red-minutes')?.value || "";

        const countItems = (str) => (!str || str.trim() === "") ? 0 : str.split(',').filter(s => s.trim() !== '').length;

        const goals = countItems(goalsStr);
        const assists = countItems(assistsStr);
        const yellow = countItems(yellowStr);
        const red = countItems(redStr);

        const ratingVal = row.querySelector('.stat-rating')?.value;
        const rating = (ratingVal === "" || ratingVal === null) ? null : parseFloat(ratingVal);
        const minVal = row.querySelector('.stat-minutes')?.value;
        const minutes = (parseInt(minVal) || 0);

        playerStats.push({
            playerId: playerId,
            isStarter: isBadgeStarter,
            specificPosition: specificPos,
            rating: rating,
            goals: goals,
            assists: assists,
            minutes: minutes,
            yellowCards: yellow,
            redCards: red,
            played: minutes > 0,
            detailGoals: goalsStr,
            detailAssists: assistsStr,
            detailYellow: yellowStr,
            detailRed: redStr
        });
    });

    const result = document.getElementById('edit-result-val').value;
    const roundId = document.getElementById('edit-round-select').value;
    const outcome = calculateMatchOutcome(result, match.venue);

    // 3. GUARDAR
    matches[matchIndex] = {
        ...match,
        result: result,
        roundId: roundId,
        outcome: outcome,
        mvp: calculateAutoMVP(playerStats),
        playerStats: playerStats
    };
    
    saveData('matches', matches);
    
    // 4. CERRAR Y REFRESCAR
    closeEditMatchModal();
    renderMatches();
    
    if (typeof renderCompetitionStatus === 'function') renderCompetitionStatus();
    if (typeof renderPrincipal === 'function') renderPrincipal();
    
    console.log("‚úÖ Guardado con √©xito.");
}
function saveMatchChanges(matchId) {
    console.log("üíæ Guardando cambios para:", matchId);
    
    const matches = getData('matches');
    const matchIndex = matches.findIndex(m => m.id === matchId);
    if (matchIndex === -1) { alert("‚ùå Error al guardar: No encuentro el partido"); return; }
    
    const match = matches[matchIndex];
    const statsContainer = document.getElementById('edit-stats-list');
    const playerStats = [];
    
    // Recorrer filas
    statsContainer.querySelectorAll('[data-player-id]').forEach(row => {
        const playerId = row.getAttribute('data-player-id');
        const specificPos = row.getAttribute('data-specific-pos');
        
        // Detectar titularidad (si tiene badge verde)
        const isBadgeStarter = row.querySelector('.bg-emerald-100') !== null;
        const isStarter = isBadgeStarter;

        // LEER INPUTS OCULTOS
        const goalsStr = row.querySelector('.stat-goals-minutes')?.value || "";
        const assistsStr = row.querySelector('.stat-assists-minutes')?.value || "";
        const yellowStr = row.querySelector('.stat-yellow-minutes')?.value || "";
        const redStr = row.querySelector('.stat-red-minutes')?.value || "";

        // Funci√≥n contar
        const countItems = (str) => (!str || str.trim() === "") ? 0 : str.split(',').filter(s => s.trim() !== '').length;

        const goals = countItems(goalsStr);
        const assists = countItems(assistsStr);
        const yellow = countItems(yellowStr);
        const red = countItems(redStr);

        // Inputs normales
        const ratingVal = row.querySelector('.stat-rating')?.value;
        const rating = (ratingVal === "" || ratingVal === null) ? null : parseFloat(ratingVal);
        
        const minVal = row.querySelector('.stat-minutes')?.value;
        const minutes = (parseInt(minVal) || 0);

        playerStats.push({
            playerId: playerId,
            isStarter: isStarter,
            specificPosition: specificPos,
            rating: rating,
            goals: goals,
            assists: assists,
            minutes: minutes,
            yellowCards: yellow,
            redCards: red,
            played: minutes > 0,
            
            // GUARDAR DETALLES
            detailGoals: goalsStr,
            detailAssists: assistsStr,
            detailYellow: yellowStr,
            detailRed: redStr
        });
    });

    // Leer resultado general
    const result = document.getElementById('edit-result-val').value;
    const roundId = document.getElementById('edit-round-select').value;
    const outcome = calculateMatchOutcome(result, match.venue);

    // Actualizar objeto
    matches[matchIndex] = {
        ...match,
        result: result,
        roundId: roundId,
        outcome: outcome,
        mvp: calculateAutoMVP(playerStats),
        playerStats: playerStats
    };
    
    saveData('matches', matches);
    
    // Cerrar y refrescar
    closeEditMatchModal();
    
    renderMatches(); // Recargar lista visual
    
    // Opcional: Recalcular tablas
    if (typeof renderCompetitionStatus === 'function') renderCompetitionStatus();
    if (typeof renderPrincipal === 'function') renderPrincipal();
    
    alert('‚úÖ Cambios guardados correctamente.');
}

        
function closeEditMatchModal() {
    const modal = document.getElementById('edit-match-modal');
    
    if (modal) {
        // 1. A√±adir la clase de ocultar de Tailwind
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        
        // 2. IMPORTANTE: Sobrescribir el estilo en l√≠nea
        // Esto anula el 'display: flex' que pusimos al abrir
        modal.style.display = 'none'; 
        unlockScroll();
        
        console.log("üîí Modal cerrado correctamente.");
    }
}
        
        function closePlayerStatusModal() {
             document.getElementById('player-status-modal').classList.remove('active');
             unlockScroll();
        }
               
        function closeMatchDetailModal() {
             document.getElementById('match-detail-modal').classList.remove('active');
             unlockScroll();
        }
        
        function openPlayerStatusModal(playerId) {
            const players = getPlayers();
            const player = players.find(p => p.id === playerId);
            if (!player) return;
            
            const modal = document.getElementById('player-status-modal');
            const content = document.getElementById('player-status-content');
            
            content.innerHTML = `
                <div class="text-center mb-6">
                    <img src="${player.foto}" class="player-photo mx-auto mb-3 border-4 ${player.estado === 'Activo' ? 'border-amber-400' : 'border-gray-300'}">
                    <h4 class="font-bold text-lg">${player.nombre} ${player.apellido}</h4>
                    <p class="text-gray-500">Estado actual: <strong>${player.estado}</strong></p>
                </div>
                <div class="space-y-3">
                    <button onclick="changePlayerStatus('${player.id}', 'Activo')" class="w-full py-3 rounded-lg font-medium bg-green-500 text-white">‚úÖ Activo</button>
                    <button onclick="changePlayerStatus('${player.id}', 'Inactivo')" class="w-full py-3 rounded-lg font-medium bg-gray-500 text-white">‚ùå Inactivo</button>
                    <button onclick="changePlayerStatus('${player.id}', 'Cedido')" class="w-full py-3 rounded-lg font-medium bg-yellow-500 text-white">‚úàÔ∏è Cedido</button>
                    <button onclick="changePlayerStatus('${player.id}', 'Leyenda')" class="w-full py-3 rounded-lg font-medium bg-amber-500 text-white">üëë Leyenda</button>
                </div>
            `;
            modal.classList.add('active');
            lockScroll();
        }
        
        function changePlayerStatus(playerId, newStatus) {
            updatePlayerState(playerId, newStatus);
            closePlayerStatusModal();
            renderPlayers();
        }
        // ==========================================
        // EXTRA ROUND LOGIC (CHAMPIONS/UWCL)
        // ==========================================

        let pendingExtraRoundComp = null;

        function checkExtraRoundTrigger(match) {
            // Identificadores del "√öltimo partido de liga"
            const MEN_LAST_LEAGUE = 'fase-liga-8'; // Masculino
            const WOMEN_LAST_LEAGUE = 'grupos-6';  // Femenino
            
            if (match.roundId === MEN_LAST_LEAGUE || match.roundId === WOMEN_LAST_LEAGUE) {
                pendingExtraRoundComp = match.competition;
                
                // Mostrar Modal
                document.getElementById('extra-round-modal').classList.add('active');
                lockScroll();
                return true; // Indica que se ha disparado el trigger (pausando el cierre)
            }
            return false;
        }

function confirmExtraRound() {
    const playExtra = document.getElementById('chk-play-extra').checked;
    
    if (pendingExtraRoundComp) {
        const state = getCompetitionState();
        if (!state[pendingExtraRoundComp]) state[pendingExtraRoundComp] = {};
        
        // Guardamos en BD
        state[pendingExtraRoundComp].playsExtra = playExtra;
        saveCompetitionState(state);
        
        // --- AQU√ç EST√Å LA MAGIA ---
        // Forzamos la actualizaci√≥n de la configuraci√≥n en memoria
        syncExtraRounds(); 
        // --------------------------
    }
    
    document.getElementById('extra-round-modal').classList.remove('active');
    unlockScroll();
    
    // Refrescar la interfaz
    resetNewMatchForm();
    if (typeof renderCompetitionStatus === 'function') renderCompetitionStatus();
    
    // Al llamar a esto, ahora S√ç leer√° la ronda desbloqueada
    if (typeof populateCompetitionSelect === 'function') populateCompetitionSelect(); 
    
    alert('‚úÖ Configuraci√≥n actualizada.');
    if (typeof showTab === 'function') showTab('partidos');
}
// A√±ade esto al inicio de tu app para mantener las rondas desbloqueadas tras F5
function syncRoundsWithState() {
    const state = getCompetitionState();
    
    // Recorremos las competiciones guardadas
    Object.keys(state).forEach(compId => {
        const compState = state[compId];
        const compConfig = COMPETICIONES_ACTUALES[compId];

        // Si el usuario activ√≥ la ronda extra...
        if (compState && compState.playsExtra === true && compConfig) {
            // ...la desbloqueamos en la configuraci√≥n
            if (compConfig.fases) {
                compConfig.fases.forEach(fase => {
                    if (fase.rondas) {
                        fase.rondas.forEach(r => {
                            if (r.id.includes('playoff') || r.id.includes('dieciseis')) {
                                r.status = 'available';
                                r.oculto = false;
                            }
                        });
                    }
                });
            }
        }
    });
}

// LLAMAR AL INICIAR LA P√ÅGINA:
// syncRoundsWithState();

        // ==========================================
        // UTILS
        // ==========================================
        
        function formatDate(dateStr) {
            if (!dateStr) return '';
            // Detectar formato DD-MM-YYYY
            if (typeof dateStr === 'string' && /^\d{2}-\d{2}-\d{4}$/.test(dateStr)) {
                 const [day, month, year] = dateStr.split('-').map(Number);
                 return new Date(year, month - 1, day).toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' });
            }
            return new Date(dateStr).toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' });
        }
        
        function calculateAge(birthdate) {
            const today = new Date();
            const birth = new Date(birthdate);
            let age = today.getFullYear() - birth.getFullYear();
            const m = today.getMonth() - birth.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;
            return age;
        }
        
        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }
        function switchLineupMode(mode) {
            const listContainer = document.getElementById('mode-list-container');
            const pitchContainer = document.getElementById('mode-pitch-container');
            const btnList = document.getElementById('btn-mode-list');
            const btnPitch = document.getElementById('btn-mode-pitch');

            if (mode === 'list') {
                listContainer.classList.remove('hidden');
                pitchContainer.classList.add('hidden');
                
                btnList.classList.add('bg-white', 'shadow', 'text-gray-800', 'font-medium');
                btnList.classList.remove('text-gray-500');
                
                btnPitch.classList.remove('bg-white', 'shadow', 'text-gray-800', 'font-medium');
                btnPitch.classList.add('text-gray-500');
            } else {
                listContainer.classList.add('hidden');
                pitchContainer.classList.remove('hidden');
                
                btnPitch.classList.add('bg-white', 'shadow', 'text-gray-800', 'font-medium');
                btnPitch.classList.remove('text-gray-500');
                
                btnList.classList.remove('bg-white', 'shadow', 'text-gray-800', 'font-medium');
                btnList.classList.add('text-gray-500');
                
                // Aqu√≠ llamaremos a renderizar la pizarra en la Fase 2
                // renderTacticalBoard(); 
            }
        }
        // ==========================================
        // TACTICAL BOARD LOGIC (FASE 2)
        // ==========================================

        let currentPitchPlayers = {}; // Guardar√° { "slot-0": playerId, "slot-1": playerId... }
        let currentSubstitutes = [];
        let currentFormation = '4-3-3'; // Formaci√≥n por defecto

function updatePitchFormation(prefix = '') {
    // 1. Detectar el ID correcto del selector
    let selectId = 'formation-select'; // Default (Registrar Partido)
    
    if (prefix === 'edit-') selectId = 'edit-formation-select';
    else if (prefix === 'wizard-') selectId = 'new-formation';
    
    const select = document.getElementById(selectId);
    
    if (select) {
        currentFormation = select.value; // Actualizamos variable global
        // 2. Re-renderizar la pizarra correcta
        renderTacticalBoard(prefix);
    }
}

/* ========================================================= */
/* üé® RENDERIZADOR DE PIZARRA (BLINDADO Z-INDEX)             */
/* ========================================================= */

function renderTacticalBoard(prefix = 'wizard-') {
    const containerId = prefix + 'pitch-players-layer'; 
    const container = document.getElementById(containerId);
    
    if (!container) {
        const fallback = document.getElementById(prefix + 'pitch-formation');
        if(!fallback) return; 
    }

    if(container) {
        container.innerHTML = '';
        container.style.position = "absolute";
        container.style.inset = "0";
        container.style.zIndex = "50"; 
        container.style.pointerEvents = "none"; 
    }
    
    const allPlayers = getPlayers();
    const currentForm = (typeof currentFormation !== 'undefined') ? currentFormation : '4-3-3';
    
    const horizontalCoords = {
        "4-3-3": [{t:50,l:5}, {t:20,l:25},{t:40,l:25},{t:60,l:25},{t:80,l:25}, {t:30,l:50},{t:50,l:50},{t:70,l:50}, {t:20,l:75},{t:50,l:75},{t:80,l:75}],
        "4-4-2": [{t:50,l:5}, {t:15,l:25},{t:38,l:25},{t:62,l:25},{t:85,l:25}, {t:15,l:50},{t:38,l:50},{t:62,l:50},{t:85,l:50}, {t:35,l:75},{t:65,l:75}],
        "4-2-3-1": [{t:50,l:5}, {t:15,l:25},{t:38,l:25},{t:62,l:25},{t:85,l:25}, {t:35,l:45},{t:65,l:45}, {t:15,l:65},{t:50,l:65},{t:85,l:65}, {t:50,l:82}],
        "3-5-2": [{t:50,l:5}, {t:25,l:25},{t:50,l:25},{t:75,l:25}, {t:15,l:50},{t:35,l:50},{t:50,l:40},{t:65,l:50},{t:85,l:50}, {t:35,l:75},{t:65,l:75}]
    };
    
    const coords = horizontalCoords[currentForm] || horizontalCoords["4-3-3"];

    for (let i = 0; i < 11; i++) {
        const slotKey = `${prefix}slot-${i}`;
        const playerId = currentPitchPlayers[slotKey];
        
        const div = document.createElement('div');
        div.id = slotKey; 
        div.className = "absolute w-10 h-10 md:w-12 md:h-12 transform -translate-x-1/2 -translate-y-1/2 flex items-center justify-center group";
        div.style.zIndex = "100"; 
        div.style.pointerEvents = "auto"; 
        div.style.cursor = "pointer";

        // Eventos Drop
        div.setAttribute("ondragover", "allowDrop(event)");
        div.setAttribute("ondrop", "drop(event)");
        div.setAttribute('data-current-slot', slotKey); 
        div.setAttribute("onclick", `openPlayerSelector('${slotKey}')`);

        const pos = coords[i] || {t: 50, l: 50}; 
        div.style.top = pos.t + '%';
        div.style.left = pos.l + '%';

        if (playerId) {
            const p = allPlayers.find(pl => pl.id === playerId);
            if (p) {
                div.draggable = true;
                div.ondragstart = (e) => drag(e);
                div.setAttribute('data-player-id', playerId);
                div.style.cursor = "grab";

                div.innerHTML = `
                    <div class="w-full h-full rounded-full border-2 border-white shadow-md overflow-hidden bg-white hover:scale-110 transition-transform pointer-events-none relative z-10">
                        <img src="${p.foto}" class="w-full h-full object-cover">
                    </div>
                    <div class="absolute -bottom-3 left-1/2 transform -translate-x-1/2 bg-black/70 text-white text-[8px] px-1.5 rounded font-bold whitespace-nowrap pointer-events-none z-20">
                        ${p.apodo}
                    </div>
                    
                    <div onclick="event.stopPropagation(); removePlayerFromAllZones('${p.id}')" 
                         class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-4 h-4 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 cursor-pointer transition-opacity z-50 pointer-events-auto hover:scale-110 shadow-sm border border-white">
                         √ó
                    </div>
                `;
            }
        } else {
            div.draggable = false;
            div.innerHTML = `
                <div class="w-full h-full rounded-full border-2 border-dashed border-white/50 flex items-center justify-center group-hover:border-white transition-colors bg-white/10 pointer-events-none">
                    <span class="text-white/80 text-xs font-bold">${i + 1}</span>
                </div>
            `;
        }
        if(container) container.appendChild(div);
    }
}



// A√ëADIDO: Nuevo par√°metro 'delayIndex' al final (por defecto 0)
function renderPlayerOnPitch(player, slotId, container, delayIndex = 0) {
    const slotEl = document.getElementById(slotId);
    if (!slotEl) return;

    const div = document.createElement('div');
    
    // Clases de animaci√≥n y estilo
    div.className = 'player-token hover:scale-110 transition-transform cursor-pointer pointer-events-auto animate-drop'; 
    
    div.style.position = 'absolute';
    div.style.top = slotEl.style.top;
    div.style.left = slotEl.style.left;
    div.style.zIndex = '50'; 
    div.style.pointerEvents = 'auto';
    div.style.animationDelay = `${delayIndex * 0.05}s`;

    div.draggable = true;
    div.id = `token-${player.id}`;
    
    div.setAttribute('data-player-id', player.id);
    div.setAttribute('data-current-slot', slotId);
    
    div.ondragstart = drag;
    
    // --- NUEVO: CLIC DERECHO PARA CAPIT√ÅN ¬© ---
    div.oncontextmenu = (e) => {
        e.preventDefault();  // Evita que salga el men√∫ del navegador
        e.stopPropagation(); // Evita conflictos con el fondo
        toggleCaptain(player.id); // Llama a tu funci√≥n de capit√°n
    };

    // CLIC IZQUIERDO (NORMAL) PARA CAMBIAR JUGADOR
    div.onclick = (e) => {
        e.stopPropagation();
        openPlayerSelector(slotId);
    };
    
    div.ondragover = allowDrop;
    div.ondrop = drop;

    // FOTOS CON CROSSORIGIN
    div.innerHTML = `
        <img src="${player.foto}" 
             crossorigin="anonymous" 
             draggable="false" 
             style="pointer-events: none;" 
             onerror="this.src='https://via.placeholder.com/40x40?text=${player.dorsal}'">
        <div class="player-token-name" style="pointer-events: none;">${player.apodo || player.apellido}</div>
    `;
    
    // --- L√ìGICA DEL BRAZALETE ---
    // Se a√±ade DESPU√âS del innerHTML para que no se borre
    if (typeof currentCaptainId !== 'undefined' && currentCaptainId === player.id) {
        const badge = document.createElement('div');
        badge.className = 'captain-badge'; // Aseg√∫rate de tener el CSS que te pas√©
        badge.innerText = 'C';
        div.appendChild(badge);
    }

    container.appendChild(div);
}
function renderBench(prefix = 'wizard-') {
    const allPlayers = getPlayers();
    const activeIds = Object.values(currentPitchPlayers); // En campo
    const subIds = currentSubstitutes || []; // En zona azul

    // --- 1. ZONA SUPLENTES (CAJA AZUL) ---
    const subsContainer = document.getElementById(prefix + 'subs-zone');
    
    if (subsContainer) {
        subsContainer.innerHTML = '';
        
        // ¬°ESTO ES LO QUE FALTABA! ACTIVAR EL DROP
        subsContainer.setAttribute('ondragover', 'allowDrop(event)');
        subsContainer.setAttribute('ondrop', `dropToSubs(event, '${prefix}')`);
        
        // Pintar jugadores
        subIds.forEach(id => {
            const p = allPlayers.find(pl => pl.id === id);
            if (p && p.posicion !== 'entrenador') {
                const el = document.createElement('div');
                el.className = "relative w-10 h-10 cursor-move group m-1";
                el.draggable = true;
                el.ondragstart = (e) => drag(e);
                el.setAttribute('data-player-id', p.id);
                el.id = `${prefix}sub-${p.id}`;
                
                el.innerHTML = `
                    <div class="w-full h-full rounded-full border-2 border-blue-400 overflow-hidden bg-white hover:scale-110 transition-transform shadow-sm pointer-events-none">
                        <img src="${p.foto}" class="w-full h-full object-cover">
                    </div>
                    <div onclick="event.stopPropagation(); removeFromSubs('${p.id}'); renderAll('${prefix}');" class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-3.5 h-3.5 flex items-center justify-center text-[8px] opacity-0 group-hover:opacity-100 cursor-pointer shadow z-50 pointer-events-auto">√ó</div>
                `;
                subsContainer.appendChild(el);
            }
        });
    }

    // --- 2. ZONA PLANTILLA (CAJA BLANCA) ---
    const benchContainer = document.getElementById(prefix + 'bench-zone') || document.getElementById(prefix + 'bench-container');
    
    if (benchContainer) {
        benchContainer.innerHTML = '';
        
        // ¬°ESTO ES LO QUE FALTABA! ACTIVAR EL DROP PARA DEVOLVER JUGADORES
        benchContainer.setAttribute('ondragover', 'allowDrop(event)');
        benchContainer.setAttribute('ondrop', `dropToBench(event, '${prefix}')`);
        
        // Filtramos: Ni en campo, ni en caja azul, ni entrenadores
        const available = allPlayers.filter(p => 
            !activeIds.includes(p.id) && 
            !subIds.includes(p.id) && 
            p.posicion !== 'entrenador' &&
            p.estado === 'Activo'
        );

        // Estilo GRID
        benchContainer.className = "flex flex-wrap gap-2 content-start p-2 min-h-[100px]"; // Min-height para que siempre haya sitio para soltar

        available.forEach(p => {
            const el = document.createElement('div');
            el.className = "relative w-10 h-10 cursor-move opacity-90 hover:opacity-100 transition-opacity";
            el.draggable = true;
            el.ondragstart = (e) => drag(e);
            el.setAttribute('data-player-id', p.id);
            el.id = `${prefix}pool-${p.id}`;

            el.innerHTML = `
                <div class="w-full h-full rounded-full border border-gray-300 overflow-hidden bg-white shadow-sm hover:border-indigo-500 hover:ring-2 hover:ring-indigo-200 transition-all pointer-events-none">
                    <img src="${p.foto}" class="w-full h-full object-cover" title="${p.apodo}">
                </div>
            `;
            benchContainer.appendChild(el);
        });
    }
}

   /* ========================================================= */
/* üéÆ MOTOR T√ÅCTICO FINAL (Soporta IDs viejos y nuevos)      */
/* ========================================================= */

function allowDrop(ev) { ev.preventDefault(); }

function drag(ev) {
    const playerId = ev.target.getAttribute('data-player-id');
    ev.dataTransfer.setData("playerId", playerId);
    
    // Buscar origen
    let sourceSlotId = ev.target.getAttribute('data-current-slot');
    if (!sourceSlotId && ev.target.parentElement && ev.target.parentElement.id && ev.target.parentElement.id.includes('slot-')) {
        sourceSlotId = ev.target.parentElement.id;
    }
    ev.dataTransfer.setData("sourceSlot", sourceSlotId || "");
}

function drop(ev) {
    ev.preventDefault();
    ev.stopPropagation(); 

    const draggedPlayerId = ev.dataTransfer.getData("playerId");
    const sourceSlotId = ev.dataTransfer.getData("sourceSlot"); 
    if (!draggedPlayerId) return;

    let target = ev.target;
    // Subir hasta encontrar el slot
    while (target && (!target.id || !target.id.includes('slot-'))) {
        target = target.parentElement;
    }
    
    if (!target || !target.id) return;

    // DETECCI√ìN INTELIGENTE DE PREFIJO
    const isEditMode = target.id.startsWith('edit-');
    // Si no es edit, usamos '' (vac√≠o) para que coincida con tu HTML de registro
    const prefix = isEditMode ? 'edit-' : ''; 
    const targetSlotId = target.id;

    if (sourceSlotId === targetSlotId) return;

    const existingPlayerId = currentPitchPlayers[targetSlotId];

    // L√≥gica de movimiento
    if (!existingPlayerId) {
        currentPitchPlayers[targetSlotId] = draggedPlayerId;
        if (sourceSlotId) delete currentPitchPlayers[sourceSlotId];
        else removeFromSubs(draggedPlayerId);
    } else {
        if (sourceSlotId) {
            currentPitchPlayers[targetSlotId] = draggedPlayerId;
            currentPitchPlayers[sourceSlotId] = existingPlayerId;
        } else {
            currentPitchPlayers[targetSlotId] = draggedPlayerId;
            removeFromSubs(draggedPlayerId);
        }
    }
    renderAll(prefix);
}

function dropToSubs(ev, prefixInput) {
    ev.preventDefault();
    const playerId = ev.dataTransfer.getData("playerId");
    if(!playerId) return;

    // Detectar prefijo
    let prefix = prefixInput;
    if (typeof prefix === 'undefined') {
        prefix = document.getElementById('edit-match-modal')?.classList.contains('flex') ? 'edit-' : '';
    }

    const slotKey = Object.keys(currentPitchPlayers).find(key => currentPitchPlayers[key] === playerId);
    if (slotKey) delete currentPitchPlayers[slotKey];

    if (!currentSubstitutes.includes(playerId)) {
        currentSubstitutes.push(playerId);
    }
    renderAll(prefix);
}

function dropToBench(ev, prefixInput) {
    ev.preventDefault();
    const playerId = ev.dataTransfer.getData("playerId");
    if(!playerId) return;

    let prefix = prefixInput;
    if (typeof prefix === 'undefined') {
        prefix = document.getElementById('edit-match-modal')?.classList.contains('flex') ? 'edit-' : '';
    }

    removePlayerFromAllZones(playerId); // Esto lo manda al banquillo/disponibles
    renderAll(prefix);
}

function removePlayerFromAllZones(playerId) {
    const slotKey = Object.keys(currentPitchPlayers).find(key => currentPitchPlayers[key] === playerId);
    if (slotKey) delete currentPitchPlayers[slotKey];

    const subIndex = currentSubstitutes.indexOf(playerId);
    if (subIndex > -1) currentSubstitutes.splice(subIndex, 1);
    
    // Refrescar autom√°ticamente
    renderAll();
}

function removeFromSubs(playerId) {
    const idx = currentSubstitutes.indexOf(playerId);
    if (idx > -1) currentSubstitutes.splice(idx, 1);
}

function renderAll(prefixInput) {
    let prefix = prefixInput;
    // Si no nos dan prefijo, adivinamos mirando si el modal de editar est√° abierto
    if (typeof prefix === 'undefined') {
        const editModal = document.getElementById('edit-match-modal');
        const isEditing = editModal && (editModal.classList.contains('flex') || editModal.style.display === 'flex');
        prefix = isEditing ? 'edit-' : '';
    }
    
    if(typeof renderTacticalBoard === 'function') renderTacticalBoard(prefix);
    if(typeof renderBench === 'function') renderBench(prefix);
}

        // ==========================================
        // SELECTOR DE JUGADORES (MEJORADO)
        // ==========================================

        function openPlayerSelector(slotId) {
            currentSelectorSlot = slotId;
            const modal = document.getElementById('player-selector-modal');
            const list = document.getElementById('player-selector-list');
            const searchInput = document.getElementById('player-selector-search');
            
            searchInput.value = ''; 
            list.innerHTML = ''; 

            // 1. ORIGEN DE DATOS
            let sourcePlayers = [];
            if (editingMatchPlayersPool && editingMatchPlayersPool.length > 0) {
                const all = getPlayers();
                sourcePlayers = all.filter(p => editingMatchPlayersPool.includes(p.id) && p.posicion !== 'entrenador');
            } else {
                sourcePlayers = getActivePlayers().filter(p => p.posicion !== 'entrenador');
            }

            // 2. FILTRAR (Mostrar TODOS excepto el que ya est√° en ESTE slot exacto)
            const currentPlayerInThisSlot = slotId ? currentPitchPlayers[slotId] : null;

            // Ordenar por dorsal
            sourcePlayers.sort((a, b) => a.dorsal - b.dorsal);

            list.innerHTML = sourcePlayers.map(p => {
                // Ver si est√° seleccionado en ESTE slot
                const isSelectedHere = p.id === currentPlayerInThisSlot;
                
                // Ver si est√° en OTRO slot del campo
                const otherSlotKey = Object.keys(currentPitchPlayers).find(key => currentPitchPlayers[key] === p.id && key !== slotId);
                const isOnPitchElsewhere = !!otherSlotKey;
                
                // Estilos visuales
                let bgClass = 'bg-white hover:bg-gray-50';
                let statusIcon = '';
                let statusText = '';

                if (isSelectedHere) {
                    bgClass = 'bg-green-50 border-green-300';
                    statusIcon = '‚úÖ';
                } else if (isOnPitchElsewhere) {
                    bgClass = 'bg-blue-50 border-blue-200 opacity-90'; // Un poco distinto para indicar que se mover√°
                    statusText = '<span class="text-[10px] text-blue-600 font-bold ml-2">EN CAMPO (Mover)</span>';
                }

                return `
                <div data-player-id="${p.id}" onclick="selectPlayerForSlot('${p.id}')" class="selector-item cursor-pointer flex items-center gap-3 p-2 rounded-lg border border-gray-100 transition-all ${bgClass}">
                    <img src="${p.foto}" class="w-10 h-10 rounded-full object-cover object-top border border-gray-200" onerror="this.src='https://via.placeholder.com/40'">
                    <div class="flex-1">
                        <div class="flex items-center">
                            <p class="font-bold text-gray-800 text-sm">${p.apodo || p.apellido}</p>
                            ${statusText}
                        </div>
                        <p class="text-xs text-gray-500">${capitalizeFirst(p.posicion)} #${p.dorsal}</p>
                    </div>
                    ${statusIcon}
                </div>
                `;
            }).join('');

            modal.classList.add('active');
            lockScroll();
            setTimeout(() => searchInput.focus(), 100);
        }

        // ‚úÖ NUEVA FUNCI√ìN PARA LA TECLA ENTER
        function handleSelectorKey(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                // Buscar todos los elementos visibles (los que coinciden con la b√∫squeda)
                const visibleItems = Array.from(document.querySelectorAll('.selector-item:not(.hidden)'));

                if (visibleItems.length > 0) {
                    // Seleccionar el primero de la lista
                    const firstId = visibleItems[0].getAttribute('data-player-id');
                    if (firstId) {
                        selectPlayerForSlot(firstId);
                    }
                }
            }
        }

        function closePlayerSelector() {
            document.getElementById('player-selector-modal').classList.remove('active');
            currentSelectorSlot = null;
            unlockScroll();
        }

        function selectPlayerForSlot(playerId) {
            // Si es null, es la acci√≥n de "Dejar vac√≠o"
            if (!playerId) {
                if (currentSelectorSlot) delete currentPitchPlayers[currentSelectorSlot];
            } else {
                // 1. Quitar de suplentes si estaba
                removeFromSubs(playerId);

                // 2. MOVER: Si estaba en otro slot del campo, quitarlo de all√≠
                const oldSlot = Object.keys(currentPitchPlayers).find(key => currentPitchPlayers[key] === playerId);
                if (oldSlot) {
                    delete currentPitchPlayers[oldSlot];
                }

                // 3. Asignar al nuevo slot (si venimos de un slot del campo)
                if (currentSelectorSlot) {
                    currentPitchPlayers[currentSelectorSlot] = playerId;
                } else {
                    // Si currentSelectorSlot es null (click desde el banquillo), 
                    // significa que queremos a√±adirlo a suplentes
                     if (!currentSubstitutes.includes(playerId)) {
                        currentSubstitutes.push(playerId);
                     }
                }
            }

            renderAll();
            closePlayerSelector();
        }

        function filterSelectorList() {
            // Normalizar: Quitar tildes y pasar a min√∫sculas
            const normalize = (str) => str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
            
            const term = normalize(document.getElementById('player-selector-search').value);
            const items = document.querySelectorAll('.selector-item');
            
            items.forEach(item => {
                // Buscamos dentro del texto del elemento (nombre del jugador)
                const text = normalize(item.innerText);
                if (text.includes(term)) {
                    item.classList.remove('hidden');
                } else {
                    item.classList.add('hidden');
                }
            });
        }

        // FASE 3 (Adelanto): Sincronizar Pizarra -> Checkbox de la Lista
        // Esta funci√≥n marca los checkboxes ocultos bas√°ndose en qui√©n est√° en el campo
        function syncListWithBoard() {
            // 1. Limpiar todos los checkboxes
            document.querySelectorAll('.chk-starter').forEach(chk => {
                chk.checked = false;
                handleRoleCheck(chk, 'starter'); // Actualizar visuales
            });

            // 2. Marcar los que est√°n en currentPitchPlayers
            Object.values(currentPitchPlayers).forEach(playerId => {
                // Buscar el div del jugador en la lista oculta
                const playerRow = document.querySelector(`div[data-player-id="${playerId}"]`);
                if (playerRow) {
                    const starterChk = playerRow.querySelector('.chk-starter');
                    if (starterChk) {
                        starterChk.checked = true;
                        handleRoleCheck(starterChk, 'starter');
                    }
                }
            });
        }
        function getPositionName(formation, index) {
    const roles = FORMATION_ROLES[formation] || FORMATION_ROLES['default'];
    return roles[index] || 'Jugador de Campo';
}
function goToStep3() {
    const titularesIds = Object.values(currentPitchPlayers).filter(id => id);
    
    // Validaci√≥n
    if (titularesIds.length !== 11) {
        alert(`‚ö†Ô∏è Tienes ${titularesIds.length} jugadores en el campo. Deben ser exactamente 11.`);
        return;
    }
    
    // Preparar UI
    document.getElementById('wizard-step-2').classList.add('hidden');
    document.getElementById('wizard-step-3').classList.remove('hidden');

    const suplentesIds = currentSubstitutes || [];
    const allPlayers = getPlayers();
    let playersToRender = [];
    
    // 1. PROCESAR TITULARES Y SUS POSICIONES EXACTAS (Para las etiquetas verdes)
    titularesIds.forEach(id => {
        const p = allPlayers.find(pl => pl.id === id);
        if (p) {
            // Buscar en qu√© slot estaba este jugador para saber si es "Lateral" o "Central"
            const slotKey = Object.keys(currentPitchPlayers).find(key => currentPitchPlayers[key] === id);
            let specificPos = 'Titular'; 
            let pitchSlot = null;
            
            if (slotKey) {
                const indexMatch = slotKey.match(/-(\d+)$/);
                if (indexMatch) {
                    const idx = parseInt(indexMatch[1]);
                    // Usamos tu funci√≥n auxiliar para sacar el nombre bonito
                    specificPos = getPositionName(currentFormation, idx); 
                    pitchSlot = idx;
                }
            }
            playersToRender.push({ ...p, rol: 'Titular', specificPos: specificPos, isStarter: true, pitchSlot: pitchSlot });
        }
    });
    
    // 2. Procesar Suplentes
    suplentesIds.forEach(id => {
        const p = allPlayers.find(pl => pl.id === id);
        if(p) playersToRender.push({ ...p, rol: 'Suplente', specificPos: 'Suplente', isStarter: false });
    });
    
    // 3. Entrenador
    const coach = allPlayers.find(p => p.posicion === 'entrenador' && p.estado === 'Activo') || allPlayers.find(p => p.posicion === 'entrenador');
    if(coach) playersToRender.push({ ...coach, rol: 'Entrenador', specificPos: 'Entrenador', isStarter: false });

    // 4. LLAMAR A LA FUNCI√ìN DE PINTADO CON ESTOS DATOS ESPEC√çFICOS
    const currentComp = document.getElementById('new-competition').value;
    renderPlayerStatsForm('final-stats-container', currentComp, playersToRender, 'wizard-');
}

        // ==========================================
        // SISTEMA DE COPIA DE SEGURIDAD (CORREGIDO)
        // ==========================================

function backupData() {
    if (!currentTeam) {
        alert("‚ö†Ô∏è Error: No hay un equipo seleccionado.");
        return;
    }

    const matches = getData('matches');
    const players = getData('players') || []; // Necesitamos los jugadores para hacer los c√°lculos
    const competitionState = getData('competitionState') || {}; 
    const playerStates = getData('playerStates') || []; 

    // --- MAGIA: ENRIQUECER LOS PARTIDOS CON DATOS CALCULADOS ---
    // Recorremos cada partido y le "pegamos" el valor y la edad media del 11 titular
    const enrichedMatches = matches.map(match => {
        
        // 1. Filtrar titulares de este partido
        const starters = match.playerStats.filter(ps => ps.isStarter);
        
        let totalValue = 0;
        let totalYears = 0;
        let ageCount = 0;

        starters.forEach(ps => {
            // Buscamos al jugador real en la base de datos
            const realPlayer = players.find(p => p.id === ps.playerId);
            
            if (realPlayer) {
                // A) Sumar Valor de Mercado (Asumimos propiedad 'marketValue' o 'valor')
                // Se intenta leer el valor, quitando s√≠mbolos si los hubiera
                const val = parseFloat(realPlayer.marketValue || realPlayer.valor || 0);
                totalValue += isNaN(val) ? 0 : val;

                // B) Calcular Edad (basada en fecha de nacimiento)
                if (realPlayer.birthDate || realPlayer.fechaNacimiento) {
                    const dob = new Date(realPlayer.birthDate || realPlayer.fechaNacimiento);
                    const matchDate = match.date ? new Date(match.date) : new Date(); // Edad al momento del partido
                    
                    if (!isNaN(dob.getTime())) {
                        // C√°lculo preciso de edad en la fecha del partido
                        let age = matchDate.getFullYear() - dob.getFullYear();
                        const m = matchDate.getMonth() - dob.getMonth();
                        if (m < 0 || (m === 0 && matchDate.getDate() < dob.getDate())) {
                            age--;
                        }
                        totalYears += age;
                        ageCount++;
                    }
                }
            }
        });

        // Calculamos medias
        const avgAge = ageCount > 0 ? (totalYears / ageCount).toFixed(1) : "0.0";

        // Devolvemos el partido con los datos nuevos INCRUSTADOS
        return {
            ...match,
            // Estos campos ahora aparecer√°n en el JSON individualmente:
            _backup_team_value: totalValue,    // Valor total del 11
            _backup_avg_age: parseFloat(avgAge), // Edad media del 11
            _backup_starters_count: starters.length // Para control
        };
    });

    // Creamos el paquete final usando los partidos enriquecidos
    const data = {
        team: currentTeam, 
        matches: enrichedMatches, // <--- Usamos la versi√≥n con datos extra
        competitionState: competitionState,
        playerStates: playerStates,
        players: players, // Seguimos guardando los jugadores por si acaso
        timestamp: new Date().toISOString(),
        version: '1.3'
    };

    // Descargar
    const dataStr = JSON.stringify(data, null, 2);
    const blob = new Blob([dataStr], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    const date = new Date().toISOString().split('T')[0];
    a.download = `FullBackup_${currentTeam}_${date}.json`;
    a.href = url;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    alert(`‚úÖ Copia ENRIQUECIDA descargada.\nAhora cada partido incluye Valor y Edad Media en el JSON.`);
}
function restoreData(input) {
    const file = input.files[0];
    if (!file) return;

    const reader = new FileReader();
    
    reader.onload = function(e) {
        try {
            const content = e.target.result;
            const data = JSON.parse(content);
            
            // 1. Validaciones b√°sicas
            if (!data.matches || !data.team) {
                throw new Error("El archivo no es v√°lido (faltan datos o equipo).");
            }

            // 2. Validaci√≥n de Equipo Cruzado
            if (data.team !== currentTeam) {
                if (!confirm(`‚ö†Ô∏è ARCHIVO DE OTRO EQUIPO\n\nEl archivo es del: ${data.team.toUpperCase()}\nEst√°s en: ${currentTeam.toUpperCase()}\n\n¬øQuieres sobrescribir los datos de ${currentTeam.toUpperCase()} con los del archivo?`)) {
                    input.value = '';
                    return;
                }
            } else {
                if (!confirm(`‚ö†Ô∏è RESTAURAR COPIA\n\nSe van a cargar ${data.matches.length} partidos y datos de plantilla.\nLos datos actuales se perder√°n.\n¬øContinuar?`)) {
                    input.value = '';
                    return;
                }
            }

            // 3. Guardar Datos (Sobrescribir memoria)
            saveData('matches', data.matches);
            saveData('competitionState', data.competitionState || {});
            
            if (data.playerStates) {
                saveData('playerStates', data.playerStates);
            }

            // NUEVO: Restaurar Jugadores (Valores de mercado, etc.)
            if (data.players && Array.isArray(data.players) && data.players.length > 0) {
                saveData('players', data.players);
            }

            // 4. VERIFICACI√ìN
            const checkMatches = getData('matches');
            if (!checkMatches || checkMatches.length !== data.matches.length) {
                throw new Error("Error al escribir en la memoria del navegador.");
            }

            // 5. Refrescar TODO
            // Limpiamos variables globales cr√≠ticas si las usas en cach√©
            if (typeof calendarEvents !== 'undefined') calendarEvents = []; 
            
            // Recargamos funciones principales
            if (typeof loadCalendar === 'function') loadCalendar();
            if (typeof renderPlayers === 'function') renderPlayers();
            if (typeof renderCompetitionStatus === 'function') renderCompetitionStatus();
            if (typeof renderMatches === 'function') renderMatches();
            if (typeof renderStats === 'function') renderStats(); 
            if (typeof renderPrincipal === 'function') renderPrincipal();
            
            alert(`‚úÖ RESTAURACI√ìN EXITOSA:\n- ${checkMatches.length} partidos cargados.\n- Plantilla actualizada (Valores y Edades).\n- Competiciones sincronizadas.`);
            
            // Ir a la pesta√±a de partidos
            if (typeof showTab === 'function') showTab('partidos');

        } catch (err) {
            console.error(err);
            alert("‚ùå ERROR AL RESTAURAR: " + err.message);
        } finally {
            input.value = ''; 
        }
    };
    
    reader.readAsText(file);
}

        function hardReset() {
            if (!currentTeam) return;

            // Nombre para mostrar en la alerta
            const teamName = currentTeam === 'masculino' ? 'MASCULINO' : 'FEMENINO';

            if (confirm(`‚õî ¬øEST√ÅS SEGURO?\n\nVas a borrar TODOS los datos del REAL MADRID ${teamName}.\n\n‚úÖ El otro equipo NO se ver√° afectado.\n‚ö†Ô∏è Esta acci√≥n no se puede deshacer.`)) {
                
                // 1. Identificar qu√© claves pertenecen a ESTE equipo
                const keysToRemove = [];
                const prefix = `${currentTeam}_`; // ej: "femenino_"
                
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    // Si la clave empieza por "femenino_", a la lista de borrado
                    if (key && key.startsWith(prefix)) {
                        keysToRemove.push(key);
                    }
                }
                
                // 2. Borrar solo esas claves
                keysToRemove.forEach(key => localStorage.removeItem(key));
                
                alert(`üóëÔ∏è Datos del equipo ${teamName} borrados. Empezamos de cero.`);
                
                // 3. Recargar la p√°gina
                location.reload();
            }
        }
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            
            // Guardar preferencia
            localStorage.setItem('darkMode', isDark);
            
            // Actualizar bot√≥n
            updateDarkModeButton(isDark);
            
            // Actualizar gr√°ficos (si estamos en esa pesta√±a)
            updateChartsTheme(isDark);
        }

        function updateDarkModeButton(isDark) {
            const btn = document.getElementById('btn-dark-mode');
            if(btn) btn.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        }

        function updateChartsTheme(isDark) {
            // Cambiar colores globales de Chart.js
            Chart.defaults.color = isDark ? '#e2e8f0' : '#4b5563';
            Chart.defaults.borderColor = isDark ? '#334155' : '#e5e7eb';
            
            // Si los gr√°ficos existen, redibujarlos para aplicar nuevos colores
            // Simplemente llamamos a renderStats si la pesta√±a est√° activa
            if (!document.getElementById('section-stats').classList.contains('hidden')) {
                renderStats(); 
            }
        }

        function initDarkMode() {
            const savedMode = localStorage.getItem('darkMode') === 'true';
            if (savedMode) {
                document.body.classList.add('dark-mode');
                updateChartsTheme(true);
            }
            updateDarkModeButton(savedMode);
        }
        function applyMatchFilters() {
            const text = document.getElementById('filter-rival').value.toLowerCase();
            const comp = document.getElementById('filter-competition').value;
            const res = document.getElementById('filter-result').value;
            
            const matches = getData('matches');

            const filtered = matches.filter(m => {
                // 1. Filtro Texto (Rival)
                const matchText = m.opponent.toLowerCase();
                if (text && !matchText.includes(text)) return false;

                // 2. Filtro Competici√≥n
                if (comp !== 'all' && m.competition !== comp) return false;

                // 3. Filtro Resultado
                if (res !== 'all' && m.outcome !== res) return false;

                return true;
            });

            renderMatches(filtered); // Reutilizamos tu funci√≥n pas√°ndole la lista filtrada
        }
        // ==========================================
        // L√ìGICA COMPARADOR (RADAR CHART) - VERSI√ìN FINAL
        // ==========================================
        
        let radarChart = null;

        function populateComparatorSelects() {
            // Usamos los IDs de la SECCI√ìN (no del modal)
            const p1Select = document.getElementById('radar-p1');
            const p2Select = document.getElementById('radar-p2');
            
            if (!p1Select || !p2Select) return;

            // Limpiar opciones previas
            p1Select.innerHTML = '<option value="">Selecciona...</option>';
            p2Select.innerHTML = '<option value="">Selecciona...</option>';

            // Filtrar solo jugadores activos
            const players = getActivePlayers().filter(p => p.posicion !== 'entrenador').sort((a,b) => a.dorsal - b.dorsal);
            
            const options = players.map(p => `<option value="${p.id}">${p.nombre} ${p.apellido} (#${p.dorsal})</option>`).join('');
            
            p1Select.innerHTML += options;
            p2Select.innerHTML += options;

            // Pre-seleccionar para que no salga vac√≠o
            if (players.length >= 2) {
                p1Select.selectedIndex = 1;
                p2Select.selectedIndex = 2;
                updateComparatorChart(); // Dibujar inicial
            }
        }
let comparatorTimeouts = [];
function updateComparatorChart() {
    const id1 = document.getElementById('radar-p1').value;
    const id2 = document.getElementById('radar-p2').value;
    const tableContainer = document.getElementById('radar-stats-table');
    const ctxEl = document.getElementById('chart-radar-vs');
    
    // --- 1. GESTI√ìN DE TIMEOUTS ---
    // Limpiamos cualquier animaci√≥n pendiente si el usuario cambia r√°pido
    if (typeof comparatorTimeouts !== 'undefined') {
        comparatorTimeouts.forEach(t => clearTimeout(t));
        comparatorTimeouts = [];
    } else {
        // Si no has declarado la variable global, la creamos al vuelo para evitar errores
        window.comparatorTimeouts = []; 
    }

    // Limpieza visual inicial
    if(tableContainer) tableContainer.innerHTML = '';
    if(typeof radarChart !== 'undefined' && radarChart) {
        radarChart.destroy();
        radarChart = null;
    }

    if (!id1 || !id2) {
        if(tableContainer) tableContainer.innerHTML = '<p class="text-center text-gray-400 italic py-4">Selecciona dos jugadores.</p>';
        return;
    }

    const players = getPlayers();
    const matches = getData('matches');
    const p1 = players.find(p => p.id === id1);
    const p2 = players.find(p => p.id === id2);

    // ===============================================
    // ü•ä EFECTO VS (STREET FIGHTER)
    // ===============================================
    const parentContainer = ctxEl ? ctxEl.parentElement : null;

    if (parentContainer) {
        // Limpiar overlays viejos
        const oldOverlay = parentContainer.querySelector('.vs-overlay');
        if (oldOverlay) oldOverlay.remove();

        // Crear Overlay
        const overlay = document.createElement('div');
        overlay.className = 'vs-overlay';
        
        // Asegurar posici√≥n relativa
        if (getComputedStyle(parentContainer).position === 'static') {
            parentContainer.style.position = 'relative';
        }

        overlay.innerHTML = `
            <img src="${p1.foto}" class="vs-fighter anim-slide-left" style="left: 20%; z-index:1;" onerror="this.src='https://via.placeholder.com/100'">
            <div class="vs-text">VS</div>
            <img src="${p2.foto}" class="vs-fighter anim-slide-right" style="right: 20%; z-index:1;" onerror="this.src='https://via.placeholder.com/100'">
        `;

        parentContainer.appendChild(overlay);

        const vsText = overlay.querySelector('.vs-text');
        
        // Secuencia de animaci√≥n
        comparatorTimeouts.push(setTimeout(() => {
            overlay.classList.add('anim-rumble');
            vsText.classList.add('anim-pop');
        }, 400));

        comparatorTimeouts.push(setTimeout(() => {
            overlay.classList.add('anim-fade-out');
            // PINTAMOS LOS DATOS CUANDO EL TEL√ìN SE LEVANTA
            renderChartAndTable(); 
        }, 1600));

        comparatorTimeouts.push(setTimeout(() => {
            overlay.remove();
        }, 2200));

    } else {
        renderChartAndTable(); // Fallback si no hay contenedor gr√°fico
    }

    // ===============================================
    //  FUNCI√ìN INTERNA DE PINTADO (Closure)
    // ===============================================
    function renderChartAndTable() {
        const getStats = (pid) => {
            let g = 0, a = 0, mins = 0, mvp = 0, rateSum = 0, rateCount = 0, matchesCount = 0;
            matches.forEach(m => {
                const ps = m.playerStats.find(s => String(s.playerId) === String(pid));
                if (ps) {
                    g += ps.goals || 0; a += ps.assists || 0; mins += ps.minutes || 0;
                    matchesCount++;
                    if (ps.rating) { rateSum += parseFloat(ps.rating); rateCount++; }
                }
                if (String(m.mvp) === String(pid)) mvp++;
            });
            return { 
                goals: g, assists: a, minutes: mins, mvp: mvp, 
                avg: rateCount > 0 ? (rateSum / rateCount) : 0, matches: matchesCount
            };
        };

        const s1 = getStats(id1);
        const s2 = getStats(id2);

        const ceilings = { 
            goals: 15, assists: 10, minutes: (matches.length * 80) || 1000, 
            avg: 10, mvp: 5, matches: matches.length || 1 
        };

        const normalize = (val, max) => Math.min(100, Math.round((val / max) * 100));
        
        const data1 = [
            normalize(s1.goals, ceilings.goals), normalize(s1.assists, ceilings.assists),
            normalize(s1.avg, ceilings.avg), normalize(s1.minutes, ceilings.minutes),
            normalize(s1.mvp, ceilings.mvp)
        ];
        const data2 = [
            normalize(s2.goals, ceilings.goals), normalize(s2.assists, ceilings.assists),
            normalize(s2.avg, ceilings.avg), normalize(s2.minutes, ceilings.minutes),
            normalize(s2.mvp, ceilings.mvp)
        ];

        // --- CHART JS CON DELAY ---
        const isDark = document.body.classList.contains('dark-mode');
        const textColor = isDark ? '#e2e8f0' : '#4b5563';
        const gridColor = isDark ? '#334155' : '#e5e7eb';

        if (ctxEl) {
            radarChart = new Chart(ctxEl.getContext('2d'), {
                type: 'radar',
                data: {
                    labels: ['Goles', 'Asistencias', 'Nota Media', 'Minutos', 'MVPs'],
                    datasets: [
                        {
                            label: p1.apodo || p1.apellido, data: data1,
                            borderColor: 'rgba(59, 130, 246, 1)', backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            pointBackgroundColor: 'rgba(59, 130, 246, 1)', borderWidth: 2
                        },
                        {
                            label: p2.apodo || p2.apellido, data: data2,
                            borderColor: 'rgba(239, 68, 68, 1)', backgroundColor: 'rgba(239, 68, 68, 0.2)',
                            pointBackgroundColor: 'rgba(239, 68, 68, 1)', borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { 
                        duration: 1500, 
                        easing: 'easeOutQuart',
                        delay: 500 
                    },
                    scales: {
                        r: {
                            angleLines: { color: gridColor }, grid: { color: gridColor },
                            pointLabels: { font: { size: 12, weight: 'bold' }, color: textColor },
                            suggestedMin: 0, suggestedMax: 100, ticks: { display: false }
                        }
                    },
                    plugins: { legend: { labels: { color: textColor } } }
                }
            });
        }

        // --- TABLA HTML CON PLASMA ‚ö° Y DELAY ---
        const row = (label, v1, v2, maxVal, isFloat=false) => {
            const val1 = isFloat ? v1.toFixed(2) : v1;
            const val2 = isFloat ? v2.toFixed(2) : v2;
            
            // Colores de texto ajustados para verse bien con las barras de plasma
            const c1 = Number(val1) > Number(val2) ? 'text-blue-600 font-black' : (Number(val1) === Number(val2) ? 'text-gray-400' : 'text-gray-400');
            const c2 = Number(val2) > Number(val1) ? 'text-red-600 font-black' : (Number(val2) === Number(val1) ? 'text-gray-400' : 'text-gray-400');

            const pct1 = Math.min(100, Math.max(2, (v1 / maxVal) * 100));
            const pct2 = Math.min(100, Math.max(2, (v2 / maxVal) * 100));

            return `
            <div class="relative flex justify-between items-center py-2 mb-2 border-b border-gray-100 last:border-0 overflow-hidden">
                <div class="absolute left-0 top-0 bottom-0 bg-blue-500 plasma-bar animate-bar origin-left opacity-80 rounded-r-md" 
                     style="width: ${pct1}%; max-width: 48%; z-index:0; animation-delay: 0.5s;"></div>
                
                <div class="absolute right-0 top-0 bottom-0 bg-red-500 plasma-bar animate-bar origin-right opacity-80 rounded-l-md" 
                     style="width: ${pct2}%; max-width: 48%; z-index:0; animation-delay: 0.5s;"></div>

                <div class="z-10 w-full flex justify-between items-center px-2">
                    <span class="text-base ${c1} drop-shadow-sm mix-blend-multiply">${val1}</span>
                    <span class="text-xs text-slate-500 uppercase tracking-widest font-bold text-center bg-white/90 px-2 rounded backdrop-blur-sm shadow-sm">${label}</span>
                    <span class="text-base ${c2} drop-shadow-sm mix-blend-multiply">${val2}</span>
                </div>
            </div>`;
        };
        
        if(tableContainer) {
            tableContainer.innerHTML = `
                ${row('Nota Media', s1.avg, s2.avg, ceilings.avg, true)}
                ${row('Goles', s1.goals, s2.goals, ceilings.goals)}
                ${row('Asistencias', s1.assists, s2.assists, ceilings.assists)}
                ${row('MVPs', s1.mvp, s2.mvp, ceilings.mvp)}
                ${row('Minutos', s1.minutes, s2.minutes, ceilings.minutes)}
                ${row('Partidos', s1.matches, s2.matches, ceilings.matches)}
            `;
        }
    } // FIN de renderChartAndTable

} // FIN de updateComparatorChart (¬°Esta es la llave que faltaba!)

        // ==========================================
        // AI PREDICTION ENGINE
        // ==========================================

        function renderAIPrediction() {
            const container = document.getElementById('ai-prediction-card');
            const now = new Date();
            
            // 1. Buscar Pr√≥ximo Partido
            const upcomingEvents = calendarEvents
                .filter(e => e.start > now)
                .sort((a, b) => a.start - b.start);

            if (upcomingEvents.length === 0) {
                container.classList.add('hidden'); // Si no hay partido, ocultamos la IA
                return;
            }

            const nextMatch = upcomingEvents[0];
            container.classList.remove('hidden');

            // 2. Analizar Datos Hist√≥ricos (La "IA")
            const matches = getData('matches');
            const players = getPlayers();
            
            // Estad√≠sticas base
            let wins = 0, draws = 0, losses = 0, gf = 0, ga = 0;
            let formPoints = 0; // Puntos de forma (√∫ltimos 5)
            
            // Analizar √∫ltimos 5 partidos para "Racha"
            const last5 = [...matches].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
            last5.forEach(m => {
                if (m.outcome === 'victoria') formPoints += 3;
                else if (m.outcome === 'empate') formPoints += 1;
            });

            // Medias globales
            matches.forEach(m => {
                const parts = m.result.replace('*','').split('-').map(Number);
                const isHome = m.venue === 'local';
                if(isHome) { gf += parts[0]; ga += parts[1]; } 
                else { gf += parts[1]; ga += parts[0]; }
            });

            const avgGF = matches.length > 0 ? (gf / matches.length) : 2; // Default 2 goles
            const avgGA = matches.length > 0 ? (ga / matches.length) : 1; // Default 1 gol

            // 3. Calcular Probabilidades (Algoritmo Heur√≠stico)
            // Factor Base: Real Madrid siempre favorito (60%)
            let winProb = 60; 
            
            // Factor Forma: Si vienes ganando, sube. Si pierdes, baja.
            const formFactor = (formPoints / 15) * 20; // Hasta +20% extra si ganas todo
            winProb += formFactor;

            // Factor Casa/Fuera
            if (nextMatch.venue === 'local') winProb += 10;
            else winProb -= 5;

            // Factor Competici√≥n (Champions es m√°s dif√≠cil)
            if (nextMatch.competition && nextMatch.competition.includes('Champions')) winProb -= 10;

            // Ajustes finales (topes)
            if (winProb > 90) winProb = 90;
            if (winProb < 30) winProb = 30;

            const drawProb = Math.max(10, (100 - winProb) * 0.4); // El empate es un % del resto
            // const lossProb = 100 - winProb - drawProb; (impl√≠cito)

            // 4. Predicci√≥n de Resultado
            // Usamos la media de goles y redondeamos
            let predGF = Math.round(avgGF);
            let predGA = Math.round(avgGA);
            
            // Ajuste por local√≠a
            if (nextMatch.venue === 'local') predGF = Math.max(predGF, predGF + 1);
            
            // Si la probabilidad de victoria es muy alta, aseguramos que GF > GA
            if (winProb > 70 && predGF <= predGA) predGF = predGA + 1;

            // 5. Jugador a Seguir (El que mejor nota media tenga o m√°s goles)
            let playerToWatch = "Bellingham"; // Fallback
            let playerReason = "Lidera el equipo";
            
            // Buscar mejor jugador activo
            const activePlayers = players.filter(p => p.posicion !== 'entrenador' && p.estado === 'Activo');
            
            // Crear ranking simple
            const playerRanking = activePlayers.map(p => {
                let score = 0;
                let goals = 0;
                let rating = 0;
                let count = 0;
                
                matches.forEach(m => {
                    const ps = m.playerStats.find(s => s.playerId === p.id);
                    if (ps) {
                        goals += ps.goals || 0;
                        if(ps.rating) { rating += parseFloat(ps.rating); count++; }
                    }
                });
                
                const avg = count > 0 ? rating/count : 0;
                score = (goals * 2) + (avg * 1.5); // Goles valen doble
                return { name: p.apodo || p.apellido, score, goals, avg };
            }).sort((a,b) => b.score - a.score);

            if (playerRanking.length > 0) {
                const top = playerRanking[0];
                playerToWatch = top.name;
                playerReason = top.goals > 0 ? `M√°ximo peligro (${top.goals} goles)` : `Motor del equipo (${top.avg.toFixed(1)} nota)`;
            }


            // --- RENDERIZAR EN DOM ---
            document.getElementById('ai-match-label').textContent = `vs ${nextMatch.opponent} (${nextMatch.venue === 'local' ? 'Casa' : 'Fuera'})`;
            document.getElementById('ai-prediction-text').textContent = winProb >= 55 ? "Victoria Probable" : (winProb >= 40 ? "Partido Re√±ido" : "Partido Complicado");
            document.getElementById('ai-reasoning').textContent = `Basado en ${matches.length} partidos analizados y forma actual.`;
            
            document.getElementById('ai-win-prob').textContent = Math.round(winProb) + '%';
            document.getElementById('prob-bar-win').style.width = winProb + '%';
            document.getElementById('prob-bar-draw').style.width = drawProb + '%';
            
            document.getElementById('ai-score-prediction').textContent = `${predGF} - ${predGA}`;
            document.getElementById('ai-player-watch').textContent = playerToWatch;
            document.getElementById('ai-player-reason').textContent = playerReason;
        }
        // ==========================================
        // BEST XI (ONCE DE GALA) LOGIC
        // ==========================================

        function renderBestXI() {
            const container = document.getElementById('best-xi-container');
            if (!container) return;
            container.innerHTML = '';

            const players = getPlayers();
            const matches = getData('matches');

            // 1. Calcular notas medias
            const playerRatings = players.map(p => {
                if (p.posicion === 'entrenador') return null;
                
                let totalRating = 0;
                let count = 0;
                
                matches.forEach(m => {
                    const ps = m.playerStats.find(s => s.playerId === p.id);
                    if (ps && ps.rating) {
                        totalRating += parseFloat(ps.rating);
                        count++;
                    }
                });

                return {
                    ...p,
                    avg: count > 0 ? (totalRating / count) : 0,
                    matches: count
                };
            }).filter(p => p && p.matches >= 1); // Solo jugadores que hayan jugado

            // 2. Funci√≥n auxiliar para buscar por ROL ESPEC√çFICO
            const getBestByRole = (role, limit) => {
                return playerRatings
                    .filter(p => p.rol === role)
                    .sort((a, b) => b.avg - a.avg) // Ordenar por mejor nota
                    .slice(0, limit);
            };

            // 3. Selecci√≥n de Jugadores por Posici√≥n Real (4-3-3)
            const gk = getBestByRole('POR', 1);       // Portero
            
            const lb = getBestByRole('LI', 1);       // Lateral Izquierdo
            const cbs = getBestByRole('DFC', 2);      // Centrales (Top 2)
            const rb = getBestByRole('LD', 1);       // Lateral Derecho
            
            const cdm = getBestByRole('MCD', 1);     // Pivote
            const cms = getBestByRole('MC', 2);      // Interiores (Top 2)
            
            const lw = getBestByRole('EI', 1);       // Extremo Izquierdo
            const st = getBestByRole('DC', 1);       // Delantero Centro
            const rw = getBestByRole('ED', 1);       // Extremo Derecho

            // 4. Asignaci√≥n al Campo (Coordenadas T√°cticas)
            const positions = [
                { top: 85, left: 50, players: gk },       // Portero
                
                { top: 75, left: 15, players: lb },       // Lateral Izq
                { top: 75, left: 38, players: [cbs[0]] }, // Central 1
                { top: 75, left: 62, players: [cbs[1]] }, // Central 2
                { top: 75, left: 85, players: rb },       // Lateral Der

                { top: 60, left: 50, players: cdm },      // Pivote (MCD)
                { top: 45, left: 30, players: [cms[0]] }, // Interior Izq
                { top: 45, left: 70, players: [cms[1]] }, // Interior Der

                { top: 20, left: 20, players: lw },       // Extremo Izq (Vini)
                { top: 15, left: 50, players: st },       // Delantero (Mbapp√©)
                { top: 20, left: 80, players: rw }        // Extremo Der (Rodrygo)
            ];

            // 5. Renderizar Fichas
            positions.forEach(pos => {
                const p = pos.players && pos.players[0] ? pos.players[0] : null;
                
                if (p) {
                    const el = document.createElement('div');
                    el.className = 'player-card-pitch';
                    el.style.top = pos.top + '%';
                    el.style.left = pos.left + '%';
                    
                    // Avatar
                    let avatarContent = p.foto ? `<img src="${p.foto}" alt="${p.apellido}">` : p.dorsal;
                    
                    el.innerHTML = `
                        <div class="pitch-avatar">${avatarContent}</div>
                        <div class="pitch-rating">${p.avg.toFixed(2)}</div>
                        <div class="pitch-name">${p.apodo || p.apellido}</div>
                    `;
                    container.appendChild(el);
                }
            });
        }
        // ==========================================
        // SCATTER CHART (CORREGIDO)
        // ==========================================
        let scatterChart = null;

        function renderScatterChart() {
            const ctx = document.getElementById('chart-scatter-performance');
            if (!ctx) return;

            const players = getPlayers();
            const matches = getData('matches');

            // Preparar datos
            const dataPoints = players.map(p => {
                if (p.posicion === 'entrenador') return null;

                let totalMins = 0;
                let ratingSum = 0;
                let ratingCount = 0;

                matches.forEach(m => {
                    const ps = m.playerStats.find(s => s.playerId === p.id);
                    if (ps) {
                        totalMins += ps.minutes || 0;
                        if (ps.rating) {
                            ratingSum += parseFloat(ps.rating);
                            ratingCount++;
                        }
                    }
                });

                if (totalMins === 0 || ratingCount === 0) return null;

                const shortName = p.apodo || p.apellido;

                return {
                    x: totalMins,
                    y: (ratingSum / ratingCount).toFixed(2),
                    name: shortName,
                    pos: p.posicion
                };
            }).filter(item => item !== null);

            // Calcular medias para la cruz central
            const avgMins = dataPoints.reduce((acc, p) => acc + p.x, 0) / (dataPoints.length || 1);
            const avgRating = dataPoints.reduce((acc, p) => acc + parseFloat(p.y), 0) / (dataPoints.length || 1);

            if (scatterChart) scatterChart.destroy();

            const isDark = document.body.classList.contains('dark-mode');
            const gridColor = isDark ? '#334155' : '#e5e7eb';
            const textColor = isDark ? '#94a3b8' : '#4b5563';
            const axisColor = isDark ? '#f1f5f9' : '#1f2937';

            // ‚ö†Ô∏è IMPORTANTE: No usamos Chart.register aqu√≠ para no romper el gr√°fico de pastel.
            // Lo pasamos directamente en la configuraci√≥n 'plugins' de abajo.

            scatterChart = new Chart(ctx, {
                type: 'scatter',
                plugins: [ChartDataLabels], // <--- AQU√ç ACTIVAMOS EL PLUGIN SOLO PARA ESTE GR√ÅFICO
                data: {
                    datasets: [{
                        label: 'Jugadores',
                        data: dataPoints,
                        backgroundColor: (context) => {
                            const val = context.raw;
                            if(!val) return '#9ca3af';
                            if(val.x > avgMins && val.y > avgRating) return '#10b981'; // Verde
                            if(val.x < avgMins && val.y > avgRating) return '#f59e0b'; // Naranja
                            if(val.x > avgMins && val.y < avgRating) return '#ef4444'; // Rojo
                            return '#6b7280'; // Gris
                        },
                        pointRadius: 6,
                        pointHoverRadius: 9
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: { top: 20, right: 20, left: 10, bottom: 10 }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${ctx.raw.name}: ${ctx.raw.y} Nota / ${ctx.raw.x} Min`
                            }
                        },
                        // Configuraci√≥n de las etiquetas
                        datalabels: {
                            align: 'top',
                            anchor: 'center',
                            offset: 4,
                            color: textColor,
                            formatter: function(value) {
                                return value.name;
                            },
                            font: {
                                size: 10,
                                weight: 'bold',
                                family: 'sans-serif'
                            },
                            clip: false
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Minutos Jugados', color: axisColor, font: { weight: 'bold' } },
                            grid: { color: gridColor },
                            ticks: { color: textColor }
                        },
                        y: {
                            title: { display: true, text: 'Nota Media', color: axisColor, font: { weight: 'bold' } },
                            grid: { color: gridColor },
                            ticks: { color: textColor },
                            min: 0,
                            max: 10
                        }
                    }
                }
            });
        }
        // ==========================================
        // MVP GALLERY LOGIC
        // ==========================================

        function renderMVPGallery() {
            const container = document.getElementById('mvp-gallery-grid');
            const noData = document.getElementById('no-mvps-msg');
            const filterComp = document.getElementById('mvp-filter-comp');
            
            // 1. Obtener partidos con MVP
            let matches = getData('matches').filter(m => m.mvp && m.mvp !== '');
            const players = getPlayers();

            // Llenar filtro si est√° vac√≠o
            if (filterComp.options.length <= 1) {
                const comps = [...new Set(matches.map(m => m.competition))];
                comps.forEach(c => {
                    filterComp.innerHTML += `<option value="${c}">${c}</option>`;
                });
            }

            // Filtrar
            if (filterComp.value) {
                matches = matches.filter(m => m.competition === filterComp.value);
            }

            // Ordenar: M√°s recientes primero
            matches.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (matches.length === 0) {
                container.innerHTML = '';
                noData.classList.remove('hidden');
                return;
            }

            noData.classList.add('hidden');
            
            container.innerHTML = matches.map(m => {
                const p = players.find(pl => pl.id === m.mvp);
                if (!p) return ''; // Si el jugador fue borrado, saltamos

                // Datos del partido
                const date = new Date(m.date).toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
                const resultColor = m.outcome === 'victoria' ? 'text-green-600' : (m.outcome === 'empate' ? 'text-amber-600' : 'text-red-600');
                
                // Stats del jugador en ese partido
                const stats = m.playerStats.find(ps => ps.playerId === m.mvp);
                const rating = stats?.rating ? parseFloat(stats.rating).toFixed(2) : '-';
                const goals = stats?.goals || 0;
                const assists = stats?.assists || 0;

                // Crear etiquetas de hitos (Gol, Asistencia)
                let badges = [];
                if(goals > 0) badges.push(`<span class="bg-blue-100 text-blue-800 text-[10px] px-2 py-0.5 rounded-full font-bold">‚öΩ ${goals} Goles</span>`);
                if(assists > 0) badges.push(`<span class="bg-purple-100 text-purple-800 text-[10px] px-2 py-0.5 rounded-full font-bold">üëü ${assists} Asist</span>`);
                if(rating >= 9) badges.push(`<span class="bg-amber-100 text-amber-800 text-[10px] px-2 py-0.5 rounded-full font-bold">üî• Masterclass</span>`);

                return `
                <div class="mvp-card shadow-sm hover:shadow-xl group">
                    
                    <div class="px-4 py-3 bg-gray-50 border-b border-gray-100 flex justify-between items-center text-xs text-gray-500">
                        <span>${date} ¬∑ ${m.competition}</span>
                        <span class="font-bold ${resultColor} bg-white px-2 py-0.5 rounded border shadow-sm">${m.result}</span>
                    </div>

                    <div class="p-4 text-center">
                        <div class="mvp-photo-container">
                            <div class="mvp-crown">üëë</div>
                            <img src="${p.foto}" class="mvp-photo group-hover:scale-105 transition-transform duration-500" onerror="this.src='https://via.placeholder.com/120?text=${p.dorsal}'">
                        </div>
                        
                        <h4 class="text-lg font-black text-gray-800 leading-tight mb-1">${p.nombre}</h4>
                        <h5 class="text-sm font-bold text-gray-500 mb-3">${p.apellido}</h5>
                        
                        <div class="flex flex-wrap justify-center gap-2 mb-4 min-h-[20px]">
                            ${badges.join('')}
                        </div>

                        <div class="text-xs text-gray-400 font-medium uppercase tracking-wider mb-1">Contra</div>
                        <div class="font-bold text-gray-700 text-sm truncate" title="${m.opponent}">${m.opponent}</div>
                    </div>

                    <div class="bg-slate-800 p-3 flex justify-between items-center mt-auto">
                        <div class="text-white text-xs opacity-70 font-medium">Valoraci√≥n</div>
                        <div class="text-amber-400 font-black text-xl flex items-center gap-1">
                            ${rating} <span class="text-xs text-gray-400 font-normal">/10</span>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }
// ==========================================
// WIDGET: SEM√ÅFORO (ESTADO DE FORMA) - VERSI√ìN FULL WIDTH
// ==========================================
function renderTrafficLight() {
    const matches = getData('matches');
    const players = getPlayers();
    
    const container = document.getElementById('semaforo-content');
    const btnContainer = document.getElementById('semaforo-expand-btn-container'); 
    const btn = document.getElementById('btn-traffic-all'); 

    if (!container) return;

    // 1. L√ìGICA DE DATOS (Orden cronol√≥gico inverso)
    const sortedMatches = [...matches].sort((a, b) => new Date(b.date) - new Date(a.date));
    const playerRatingsMap = {};

    sortedMatches.forEach(m => {
        if (!m.playerStats) return;
        m.playerStats.forEach(ps => {
            const val = parseFloat(ps.rating);
            if (!isNaN(val) && val >= 0) {
                if (!playerRatingsMap[ps.playerId]) playerRatingsMap[ps.playerId] = [];
                // Solo las 3 notas m√°s recientes
                if (playerRatingsMap[ps.playerId].length < 3) playerRatingsMap[ps.playerId].push(val);
            }
        });
    });

    // Calcular medias
    const averages = [];
    Object.keys(playerRatingsMap).forEach(pId => {
        const ratings = playerRatingsMap[pId];
        const p = players.find(pl => pl.id === pId);
        if (p && p.estado === 'Activo' && ratings.length > 0) {
            const sum = ratings.reduce((a, b) => a + b, 0);
            const avg = (sum / ratings.length).toFixed(2);
            averages.push({ ...p, avg: avg, games: ratings.length });
        }
    });

    averages.sort((a, b) => parseFloat(b.avg) - parseFloat(a.avg));

    const green = averages.filter(p => parseFloat(p.avg) >= 7.5);
    const yellow = averages.filter(p => parseFloat(p.avg) >= 6.0 && parseFloat(p.avg) < 7.5);
    const red = averages.filter(p => parseFloat(p.avg) < 6.0);

    // 2. RENDERIZADO (Forzamos w-full y grid flexible)
    // Usamos 'gap-2' en lugar de 'gap-4' para ganar espacio si la pantalla es peque√±a
    container.innerHTML = `
        <div class="grid grid-cols-3 gap-2 w-full min-w-full">
            ${renderTrafficColumn('üî• En Racha (>7.5)', 'green', green)}
            ${renderTrafficColumn('‚öñÔ∏è Estables (6.0-7.5)', 'yellow', yellow)}
            ${renderTrafficColumn('‚ùÑÔ∏è Fr√≠os (<6.0)', 'red', red)}
        </div>
    `;

    // 3. GESTI√ìN DEL BOT√ìN GLOBAL
    const needsExpand = green.length > 3 || yellow.length > 3 || red.length > 3;

    if (btnContainer && btn) {
        if (needsExpand) {
            btnContainer.classList.remove('hidden');
            btn.innerHTML = 'Ver todos los jugadores ‚ñº';
            btn.setAttribute('data-expanded', 'false');
        } else {
            btnContainer.classList.add('hidden');
        }
    }
}

// --- HELPER: RENDERIZAR COLUMNA ---
function renderTrafficColumn(title, colorName, list) {
    const styles = {
        'green':  { header: 'bg-emerald-50 text-emerald-800 border-emerald-200', badge: 'bg-emerald-500' },
        'yellow': { header: 'bg-amber-50 text-amber-800 border-amber-200',    badge: 'bg-amber-500' },
        'red':    { header: 'bg-red-50 text-red-800 border-red-200',          badge: 'bg-red-500' }
    };
    const style = styles[colorName];

    // Calculamos altura para que las 3 columnas se vean igual de llenas
    let html = `
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden flex flex-col w-full h-full">
            <div class="p-2 md:p-3 ${style.header} font-bold text-center border-b uppercase text-[10px] md:text-xs tracking-wider truncate">
                ${title} <span class="opacity-70">(${list.length})</span>
            </div>
            <div class="p-1 md:p-2 flex flex-col gap-1 md:gap-2">
    `;

    if (list.length === 0) {
        html += `<div class="text-center text-gray-300 text-[10px] italic py-4">Vac√≠o</div>`;
    } else {
        list.forEach((p, index) => {
            const isHidden = index >= 3 ? 'hidden traffic-hidden-item' : '';
            
            // He ajustado el dise√±o de la tarjeta para que quepa mejor en espacios estrechos
            html += `
                <div class="${isHidden} flex items-center gap-2 p-1.5 md:p-2 rounded-lg bg-gray-50 border border-gray-100 relative group w-full">
                    <img src="${p.foto}" class="w-6 h-6 md:w-8 md:h-8 rounded-full object-cover object-top bg-white shrink-0 border border-gray-200">
                    
                    <div class="flex-1 min-w-0 flex flex-col justify-center">
                        <p class="text-[10px] md:text-xs font-bold truncate text-gray-700 leading-tight">
                            ${p.apodo || p.apellido}
                        </p>
                        <p class="text-[8px] md:text-[9px] text-gray-400 leading-tight truncate">
                            ${p.games} part.
                        </p>
                    </div>

                    <div class="${style.badge} text-white text-[10px] md:text-xs font-bold px-1.5 py-0.5 md:px-2 md:py-1 rounded-md shadow-sm shrink-0 whitespace-nowrap">
                        ${p.avg}
                    </div>
                </div>
            `;
        });
    }

    html += `</div></div>`;
    return html;
}

// (La funci√≥n window.toggleTrafficAll se mantiene igual que la anterior)
window.toggleTrafficAll = function() {
    const hiddenItems = document.querySelectorAll('.traffic-hidden-item');
    const btn = document.getElementById('btn-traffic-all');
    if (!btn) return;

    const isExpanded = btn.getAttribute('data-expanded') === 'true';

    if (!isExpanded) {
        hiddenItems.forEach(el => el.classList.remove('hidden'));
        btn.innerHTML = 'Ver menos ‚ñ≤';
        btn.setAttribute('data-expanded', 'true');
    } else {
        hiddenItems.forEach(el => el.classList.add('hidden'));
        btn.innerHTML = 'Ver todos los jugadores ‚ñº';
        btn.setAttribute('data-expanded', 'false');
    }
};

        // ==========================================
        // IMPORTADOR CSV (NOTAS DESDE EXCEL)
        // ==========================================

        function importFromCSV(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            
            reader.onload = function(e) {
                const text = e.target.result;
                processCSVData(text);
                input.value = ''; // Limpiar para poder repetir
            };
            
            reader.readAsText(file);
        }

        // ==========================================
        // IMPORTADOR CSV ESTRICTO (V5.0)
        // Solo importa si coincide con el Calendario Oficial
        // ==========================================
            // --- IMPORTADOR CSV BLINDADO (SIN DUPLICADOS) ---
// --- IMPORTADOR CSV BLINDADO (DOBLE VERIFICACI√ìN: ID + FECHA/RIVAL) ---
            function processCSVData(csvText) {
    const lines = csvText.split(/\r\n|\n/).filter(line => line.trim() !== '');
    if (lines.length < 2) {
        alert("‚ö†Ô∏è El archivo CSV parece estar vac√≠o.");
        return;
    }

    const separator = lines[0].indexOf(';') > -1 ? ';' : ',';
    
    // Parser de CSV
    const parseCSVRow = (rowText) => {
        const result = [];
        let current = '';
        let inQuotes = false;
        for (let i = 0; i < rowText.length; i++) {
            const char = rowText[i];
            if (char === '"') { inQuotes = !inQuotes; }
            else if (char === separator && !inQuotes) { result.push(current); current = ''; }
            else { current += char; }
        }
        result.push(current);
        return result.map(val => val.trim().replace(/^"|"$/g, '').replace(/""/g, '"'));
    };

    // 1. LEER CABECERAS
    const rivals = parseCSVRow(lines[0]).slice(1);

    // 2. DETECTAR FECHAS
    const row2 = parseCSVRow(lines[1]);
    const hasDateRow = row2.slice(1).some(cell => cell.includes('/') || cell.includes('-'));

    let startLine = 1;
    let csvDates = [];

    if (hasDateRow) {
        startLine = 2;
        csvDates = row2.slice(1);
    }

    const players = getPlayers();
    const matches = getData('matches');
    // Aseguramos que calendarEvents exista o sea array vac√≠o
    const officialEvents = (typeof calendarEvents !== 'undefined' && calendarEvents.length > 0) ? calendarEvents : [];

    // --- FILTROS DE SEGURIDAD (ANTI-DUPLICADOS) ---
    const registeredEventIds = new Set(matches.map(m => m.calendarEventId).filter(id => id));
    const sessionEventIds = new Set();

    const isMatchAlreadySaved = (evt) => {
        if (registeredEventIds.has(evt.id)) return true;
        const evtDate = evt.start.toISOString().split('T')[0];
        const evtRival = evt.opponent.toLowerCase().trim();
        return matches.some(m => {
            const mDate = m.date; 
            const mRival = m.opponent.toLowerCase().trim();
            return mDate === evtDate && (mRival.includes(evtRival) || evtRival.includes(mRival));
        });
    };

    let linkedCount = 0;
    let skippedCount = 0;
    let skippedLog = [];

    const newMatchesMap = {};
    
    // 3. PREPARAR PARTIDOS Y VINCULAR
    rivals.forEach((rivalName, index) => {
        if(rivalName) {
            let csvDateObj = new Date();
            let dateStringOriginal = csvDates[index] || "Sin fecha";
            let isValidDate = false;

            if (hasDateRow && csvDates[index]) {
                const dParts = csvDates[index].split(/[\/\-]/);
                if (dParts.length === 3) {
                    const day = parseInt(dParts[0]);
                    const month = parseInt(dParts[1]) - 1;
                    const year = parseInt(dParts[2]);
                    csvDateObj = new Date(year, month, day, 12, 0, 0);
                    isValidDate = true;
                }
            }

            let foundEvent = null;
            let skipReason = null;

            if (isValidDate && officialEvents.length > 0) {
                foundEvent = officialEvents.find(e => {
                    const nameMatch = e.opponent.toLowerCase().includes(rivalName.toLowerCase()) || 
                                      rivalName.toLowerCase().includes(e.opponent.toLowerCase());
                    const diffTime = Math.abs(e.start - csvDateObj);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                    return nameMatch && diffDays <= 2;
                });
            } else {
                skipReason = "No coincide con calendario (Fecha/Nombre)";
            }

            if (foundEvent) {
                if (isMatchAlreadySaved(foundEvent)) {
                    foundEvent = null;
                    skipReason = "Ya registrado en la base de datos (Manual o Importado)";
                } 
                else if (sessionEventIds.has(foundEvent.id)) {
                    foundEvent = null;
                    skipReason = "Duplicado en este archivo CSV";
                } else {
                    sessionEventIds.add(foundEvent.id);
                }
            } else if (!skipReason) {
                skipReason = "No encontrado en calendario";
            }

            newMatchesMap[index] = {
                opponent: rivalName,
                originalDate: dateStringOriginal,
                linkedEvent: foundEvent,
                skipReason: skipReason,
                playerStats: []
            };
        }
    });

    // 4. LEER NOTAS
    for (let i = startLine; i < lines.length; i++) {
        const row = parseCSVRow(lines[i]);
        const playerName = row[0];
        if (!playerName) continue;

        const player = players.find(p => {
            const name = p.nombre + " " + p.apellido + " " + (p.apodo || "");
            return name.toLowerCase().includes(playerName.toLowerCase());
        });

        if (player) {
            for (let col = 1; col < row.length; col++) {
                let noteStr = row[col];
                // Si la celda est√° vac√≠a, saltamos
                if (!noteStr || noteStr.trim() === '') continue;

                noteStr = noteStr.replace(',', '.').replace(/[^0-9.]/g, ''); 
                const rating = parseFloat(noteStr);

                // --- CORRECCI√ìN AQU√ç: Permitimos el 0 (rating >= 0) ---
                if (!isNaN(rating) && rating >= 0) {
                    if (newMatchesMap[col - 1]) {
                        newMatchesMap[col - 1].playerStats.push({
                            playerId: player.id,
                            isStarter: true,
                            minutes: 90,
                            rating: rating,
                            goals: 0, 
                            assists: 0, 
                            yellowCards: 0, 
                            redCards: 0,
                            played: true
                        });
                    }
                }
                // -----------------------------------------------------
            }
        }
    }

    // 5. PROCESAR Y GUARDAR
    Object.values(newMatchesMap).forEach(m => {
        if (m.playerStats.length > 0) {
            if (m.linkedEvent) {
                linkedCount++;
                const finalMatch = {
                    id: typeof generateId === 'function' ? generateId() : Date.now().toString() + Math.random(),
                    calendarEventId: m.linkedEvent.id,
                    competition: m.linkedEvent.competition || "Liga EA Sports",
                    roundId: `jornada-${m.linkedEvent.start.getTime()}`,
                    round: "Partido Oficial",
                    date: m.linkedEvent.start.toISOString().split('T')[0],
                    opponent: m.linkedEvent.opponent,
                    venue: m.linkedEvent.venue,
                    stadium: m.linkedEvent.location,
                    result: "0-0", 
                    outcome: "empate",
                    isImported: true,
                    mvp: typeof calculateAutoMVP === 'function' ? calculateAutoMVP(m.playerStats) : null,
                    playerStats: m.playerStats
                };
                matches.push(finalMatch);
            } else {
                skippedCount++;
                skippedLog.push(`- ${m.opponent} (${m.originalDate}): ${m.skipReason || "Error desconocido"}.`);
            }
        }
    });

    saveData('matches', matches);
    
    // Repintar UI
    if (typeof renderMatches === 'function') renderMatches();
    if (typeof renderStats === 'function') renderStats();
    if (typeof renderPrincipal === 'function') renderPrincipal();
    if (typeof renderTrafficLight === 'function') renderTrafficLight();
    
    let msg = `üìä Resultado de la Importaci√≥n:\n\n‚úÖ ${linkedCount} partidos importados correctamente.`;
    if (skippedCount > 0) {
        msg += `\n\n‚ö†Ô∏è ${skippedCount} partidos OMITIDOS:\n${skippedLog.join('\n')}`;
    }
    alert(msg);
}

        function toggleCSVInfo() {
            const modal = document.getElementById('csv-info-modal');
            modal.classList.toggle('hidden');
        }
        // ==========================================
        // GUERRA DE L√çNEAS (LINE WARS)
        // ==========================================
        
        let lineWarsChart = null;
/* ==========================================================================
   GR√ÅFICO LINE WARS (CON MEDIAS GLOBALES)
   ==========================================================================*/
function renderLineWarsChart() {
    const ctx = document.getElementById('chart-line-wars');
    if (!ctx) return;

    // 1. Filtrar solo partidos con fecha v√°lida y ordenarlos
    const matches = getData('matches')
        .filter(m => m.date && !isNaN(new Date(m.date).getTime()))
        .sort((a, b) => new Date(a.date) - new Date(b.date));
        
    const players = getPlayers();

    if (matches.length === 0) return;

    // Arrays de datos
    const labels = [];
    const dataDef = [];
    const dataMid = [];
    const dataFwd = [];

    // Acumuladores globales
    let totalSumDef = 0, totalCountDef = 0;
    let totalSumMid = 0, totalCountMid = 0;
    let totalSumFwd = 0, totalCountFwd = 0;

    matches.forEach(m => {
        // ‚ú® AQU√ç LLAMAMOS A cleanText ‚ú®
        // Limpiamos el nombre del rival, cortamos a 3 letras y may√∫sculas
        const rivalName = cleanText(m.opponent || 'Rival'); 
        labels.push(rivalName.substring(0, 3).toUpperCase());

        let sumDef = 0, countDef = 0;
        let sumMid = 0, countMid = 0;
        let sumFwd = 0, countFwd = 0;

        if (m.playerStats) {
            m.playerStats.forEach(ps => {
                const r = parseFloat(ps.rating);
                // Validamos que tenga nota num√©rica y minutos
                if (!isNaN(r) && r > 0 && ps.minutes > 0) {
                    const p = players.find(pl => pl.id === ps.playerId);
                    if (p) {
                        const pos = p.posicion.toLowerCase();
                        if (pos.includes('defens') || pos.includes('later') || pos.includes('carril')) {
                            sumDef += r; countDef++; totalSumDef += r; totalCountDef++;
                        } else if (pos.includes('medi') || pos.includes('centr')) {
                            sumMid += r; countMid++; totalSumMid += r; totalCountMid++;
                        } else if (pos.includes('delant') || pos.includes('extrem')) {
                            sumFwd += r; countFwd++; totalSumFwd += r; totalCountFwd++;
                        }
                    }
                }
            });
        }

        dataDef.push(countDef > 0 ? parseFloat((sumDef / countDef).toFixed(2)) : null);
        dataMid.push(countMid > 0 ? parseFloat((sumMid / countMid).toFixed(2)) : null);
        dataFwd.push(countFwd > 0 ? parseFloat((sumFwd / countFwd).toFixed(2)) : null);
    });

    // Medias globales
    const avgDef = totalCountDef > 0 ? (totalSumDef / totalCountDef).toFixed(2) : '-';
    const avgMid = totalCountMid > 0 ? (totalSumMid / totalCountMid).toFixed(2) : '-';
    const avgFwd = totalCountFwd > 0 ? (totalSumFwd / totalCountFwd).toFixed(2) : '-';

    // Actualizar Leyenda HTML
    const legendDef = document.getElementById('legend-def-val');
    const legendMid = document.getElementById('legend-mid-val');
    const legendFwd = document.getElementById('legend-fwd-val');

    if (legendDef) legendDef.textContent = `Defensa (${avgDef})`;
    if (legendMid) legendMid.textContent = `Medio (${avgMid})`;
    if (legendFwd) legendFwd.textContent = `Delantera (${avgFwd})`;

    // Destruir anterior si existe
    if (typeof lineWarsChart !== 'undefined' && lineWarsChart instanceof Chart) {
        lineWarsChart.destroy();
    }

    const isDark = document.body.classList.contains('dark-mode');
    const gridColor = isDark ? '#334155' : '#f3f4f6';
    const textColor = isDark ? '#94a3b8' : '#6b7280';

    // @ts-ignore
    lineWarsChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: `Defensa (Media: ${avgDef})`,
                    data: dataDef,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.3, pointRadius: 3, pointHoverRadius: 6, spanGaps: true
                },
                {
                    label: `Medio (Media: ${avgMid})`,
                    data: dataMid,
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.3, pointRadius: 3, pointHoverRadius: 6, spanGaps: true
                },
                {
                    label: `Delantera (Media: ${avgFwd})`,
                    data: dataFwd,
                    borderColor: '#f43f5e',
                    backgroundColor: 'rgba(244, 63, 94, 0.1)',
                    tension: 0.3, pointRadius: 3, pointHoverRadius: 6, spanGaps: true
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: { mode: 'index', intersect: false },
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        // ‚ú® AQU√ç TAMBI√âN LLAMAMOS A cleanText ‚ú®
                        title: (context) => {
                            const matchIndex = context[0].dataIndex;
                            return cleanText(matches[matchIndex].opponent);
                        }
                    }
                }
            },
            scales: {
                y: {
                    min: 0, max: 10, // Escala completa 0-10
                    grid: { color: gridColor },
                    ticks: { color: textColor, stepSize: 1 }
                },
                x: {
                    grid: { display: false },
                    ticks: { color: textColor, font: { size: 10 } }
                }
            }
        }
    });
}
        // ==========================================
        // ROSCO DE MINUTOS (ROTACIONES)
        // ==========================================
        
        let minutesChart = null;

        function renderMinutesChart() {
            const ctx = document.getElementById('chart-minutes-doughnut');
            if (!ctx) return;

            const matches = getData('matches');
            const players = getActivePlayers().filter(p => p.posicion !== 'entrenador'); // Solo jugadores de campo

            if (matches.length === 0) return;

            // 1. Calcular Minutos por Jugador
            let totalTeamMinutes = 0;
            const playerMinutes = players.map(p => {
                let mins = 0;
                matches.forEach(m => {
                    const ps = m.playerStats.find(s => s.playerId === p.id);
                    if (ps) mins += (ps.minutes || 0);
                });
                totalTeamMinutes += mins;
                return { 
                    name: p.apodo || p.apellido, 
                    minutes: mins,
                    id: p.id
                };
            });

            // 2. Ordenar: Los que m√°s juegan primero
            playerMinutes.sort((a, b) => b.minutes - a.minutes);

            // Filtrar los que tienen 0 minutos (para no ensuciar)
            const activeRotation = playerMinutes.filter(p => p.minutes > 0);

            // 3. Actualizar Datos Clave (Cajitas de al lado)
            if (activeRotation.length > 0) {
                document.getElementById('min-max-player').textContent = activeRotation[0].name;
                document.getElementById('min-max-value').textContent = activeRotation[0].minutes + "'";
                
                const last = activeRotation[activeRotation.length - 1];
                document.getElementById('min-min-player').textContent = last.name;
                document.getElementById('min-min-value').textContent = last.minutes + "'";
                
                document.getElementById('total-season-minutes').textContent = (totalTeamMinutes / 11).toFixed(0) + "'"; // Promedio por posici√≥n aprox
            }

            // 4. Configurar Colores (Escala de Azules/Verdes o Multicolor)
            // Usaremos una paleta din√°mica para que se distingan bien
            const colors = [
                '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', 
                '#ec4899', '#6366f1', '#14b8a6', '#f97316', '#84cc16',
                '#06b6d4', '#d946ef', '#eab308', '#64748b', '#a855f7'
            ];

            // Repetir colores si hay muchos jugadores
            const bgColors = activeRotation.map((_, i) => colors[i % colors.length]);

            // 5. Renderizar Gr√°fico
            if (minutesChart) minutesChart.destroy();

            const isDark = document.body.classList.contains('dark-mode');
            const textColor = isDark ? '#e2e8f0' : '#4b5563';

            minutesChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: activeRotation.map(p => p.name),
                    datasets: [{
                        data: activeRotation.map(p => p.minutes),
                        backgroundColor: bgColors,
                        borderWidth: 2,
                        borderColor: isDark ? '#1e293b' : '#ffffff',
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%', // Hace el agujero del donut m√°s grande
                    layout: { padding: 10 },
                    plugins: {
                        legend: { display: false }, // Ocultamos leyenda porque son muchos nombres
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const val = context.raw;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const pct = ((val / total) * 100).toFixed(1);
                                    return ` ${val} min (${pct}%)`;
                                }
                            }
                        },
                        // Plugin de etiquetas (Datallabels)
                        datalabels: {
                            color: isDark ? '#fff' : '#333',
                            font: { weight: 'bold', size: 9 },
                            formatter: (value, ctx) => {
                                // Solo mostrar nombre si el trozo es lo bastante grande (>4%)
                                const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                const pct = (value / total) * 100;
                                return pct > 4 ? ctx.chart.data.labels[ctx.dataIndex] : '';
                            },
                            anchor: 'center',
                            align: 'center',
                            offset: 0
                        }
                    }
                }
            });
        }
        // ==========================================
        // HELPER: Pizarra de Solo Lectura (Detalles)
        // ==========================================
        function renderReadOnlyPitch(containerId, pitchMap, formation) {
            const container = document.getElementById(containerId);
            if (!container) return;

            const coords = FORMACIONES[formation] || FORMACIONES['4-3-3'];

            let html = `
                <div class="pitch-container" style="height: 100%; width: 100%; cursor: default; position: relative;">
                    <div class="pitch-line-mid"></div>
                    <div class="pitch-circle"></div>
                    <div class="pitch-box-left"></div>
                    <div class="pitch-box-right"></div>
            `;

            coords.forEach((pos, index) => {
                // Buscamos directamente en el mapa por el √≠ndice del slot
                const player = pitchMap[index];
                
                if (player) {
                    html += `
                        <div class="player-token" style="top: ${pos.top}%; left: ${pos.left}%; transform: translate(-50%, -50%) scale(0.9); border-color: #fbbf24; position: absolute;">
                            <img src="${player.foto}" style="object-position: top !important;" onerror="this.src='https://via.placeholder.com/40'">
                            <div class="player-token-name bg-slate-800 text-white">${player.apodo || player.apellido}</div>
                            <div class="absolute -top-2 -right-2 bg-amber-500 text-white text-[9px] font-bold px-1 rounded-full border border-white">
                                ${player.rating || '-'}
                            </div>
                        </div>
                    `;
                }
            });

            html += '</div>';
            container.innerHTML = html;
        }

function handleEditMatchSubmit(e) {
    if(e) e.preventDefault();
    
    try {
        const matchId = document.getElementById('edit-match-id').value;
        const matches = getData('matches');
        const matchIndex = matches.findIndex(m => m.id === matchId);
        if (matchIndex === -1) throw new Error("Partido no encontrado");
        
        const matchToUpdate = matches[matchIndex];
        
        // 1. Datos B√°sicos
        matchToUpdate.result = document.getElementById('edit-result-val').value;
        matchToUpdate.formation = document.getElementById('edit-formation-select').value;
        
        // --- NUEVO: GUARDAR RONDA DESDE EL SELECT ---
        const roundSelect = document.getElementById('edit-round-select');
        if (roundSelect && roundSelect.selectedIndex >= 0) {
            // Guardamos el ID interno (value)
            matchToUpdate.roundId = roundSelect.value;
            // Guardamos el Nombre Visible (text)
            matchToUpdate.round = roundSelect.options[roundSelect.selectedIndex].text;
        }
        // ---------------------------------------------

        matchToUpdate.outcome = calculateMatchOutcome(matchToUpdate.result, matchToUpdate.venue);

        // 2. Jugadores (Reconstrucci√≥n stats)
        const statsContainer = document.getElementById('edit-stats-list');
        const newPlayerStats = []; 
        
        const pitchMap = {};
        if (typeof currentPitchPlayers !== 'undefined') {
            for (let i=0; i<11; i++) {
                const pid = currentPitchPlayers[`edit-slot-${i}`];
                if(pid) pitchMap[pid] = i;
            }
        }

        statsContainer.querySelectorAll('[data-player-id]').forEach(row => {
            const playerId = row.getAttribute('data-player-id');
            const rol = row.getAttribute('data-rol');
            const isStarter = rol === 'Titular';
            
            const goalsStr = row.querySelector('.stat-goals-minutes')?.value || "";
            const assistsStr = row.querySelector('.stat-assists-minutes')?.value || "";
            const yellowStr = row.querySelector('.stat-yellow-minutes')?.value || "";
            const redStr = row.querySelector('.stat-red-minutes')?.value || "";
            
            const count = (str) => (!str) ? 0 : str.split(',').filter(s => s.trim() !== '').length;
            const minsVal = parseInt(row.querySelector('.stat-minutes')?.value) || 0;
            const ratingVal = row.querySelector('.stat-rating')?.value;
            
            const typesInput = row.querySelector('.stat-goals-types');
            let goalTypes = [];
            if (typesInput && typesInput.value) {
                try {
                    goalTypes = JSON.parse(typesInput.value);
                } catch(e) { goalTypes = []; }
            }

            newPlayerStats.push({
                playerId,
                isStarter,
                pitchSlot: isStarter ? (pitchMap[playerId] !== undefined ? pitchMap[playerId] : null) : null,
                rating: ratingVal ? parseFloat(ratingVal) : null,
                minutes: minsVal,
                goals: count(goalsStr),
                assists: count(assistsStr),
                yellowCards: count(yellowStr),
                redCards: count(redStr),
                played: minsVal > 0,
                detailGoals: goalsStr,
                detailGoalTypes: goalTypes,
                detailAssists: assistsStr,
                detailYellow: yellowStr,
                detailRed: redStr
            });
        });

        matchToUpdate.playerStats = newPlayerStats;
        
        if (typeof calculateAutoMVP === 'function') {
            matchToUpdate.mvp = calculateAutoMVP(newPlayerStats);
        }

        saveData('matches', matches);
        
        if (typeof recalculateCompetitionState === "function") {
            recalculateCompetitionState(matchToUpdate.competition);
        }

        if (typeof closeEditMatchModal === 'function') closeEditMatchModal();
        else {
             const modal = document.getElementById('edit-match-modal');
             if(modal) modal.classList.add('hidden');
        }

        if(typeof renderMatches === 'function') renderMatches();
        if(typeof renderStats === 'function') renderStats(); 
        if(typeof renderPrincipal === 'function') renderPrincipal();
        
        // Recalcular gr√°ficos del dashboard
        if(typeof renderFormWaves === 'function') renderFormWaves();
        if(typeof renderProbableLineupWidget === 'function') renderProbableLineupWidget();

        alert("‚úÖ Partido actualizado con √©xito.");

    } catch (err) {
        console.error(err);
        alert("Error al guardar: " + err.message);
    }
}

function backToEditLineup() {
    document.getElementById('edit-step-stats').classList.add('hidden');
    document.getElementById('edit-step-stats').classList.remove('flex');
    document.getElementById('edit-step-lineup').classList.remove('hidden');
}

/* ========================================================= */
/* üõ†Ô∏è FUNCIONES DE ESTAD√çSTICAS Y MODALES DE MINUTOS/GOLES */
/* ========================================================= */

// --- 1. FUNCI√ìN PRINCIPAL: CARGAR FORMULARIO DE ESTAD√çSTICAS ---
function goToEditStats() {
    console.log("‚û°Ô∏è Pasando a Estad√≠sticas...");
    
    ensureGoalTagModal();

    // 1. Recoger datos
    const starterIds = Object.values(currentPitchPlayers).filter(id => id);
    const subIds = currentSubstitutes || []; 
    const players = getPlayers();
    
    const matchId = document.getElementById('edit-match-id').value;
    const matches = getData('matches');
    const match = matches.find(m => m.id === matchId);
    
    // Intentar recuperar el entrenador original del partido
    let coach = null;
    if (match.playerStats) {
        const coachStat = match.playerStats.find(ps => {
            const p = players.find(pl => pl.id === ps.playerId);
            return p && p.posicion === 'entrenador';
        });
        if (coachStat) coach = players.find(p => p.id === coachStat.playerId);
    }
    
    // Si no hay (partido nuevo/sin datos), usar el activo
    if (!coach) {
        coach = players.find(p => p.posicion === 'entrenador' && p.estado === 'Activo') || players.find(p => p.posicion === 'entrenador');
    }

    let roster = [];
    
    // Recorremos las entradas para capturar la posici√≥n (slot)
    Object.entries(currentPitchPlayers).forEach(([key, id]) => {
        if (!id) return;
        const p = players.find(pl => pl.id === id);
        if(p) {
            let pitchSlot = null;
            const match = key.match(/-(\d+)$/);
            if (match) pitchSlot = parseInt(match[1]);
            roster.push({ ...p, rol: 'Titular', isStarter: true, pitchSlot: pitchSlot });
        }
    });
    
    subIds.forEach(id => {
        const p = players.find(pl => pl.id === id);
        if(p && p.posicion !== 'entrenador' && !roster.find(r => r.id === p.id)) {
            roster.push({ ...p, rol: 'Suplente', isStarter: false });
        }
    });
    if(coach) roster.push({ ...coach, rol: 'Entrenador', isStarter: false });

    // Ordenar lista
    roster.sort((a, b) => {
        if (a.rol === 'Entrenador') return 1;
        if (b.rol === 'Entrenador') return -1;
        if (a.isStarter && !b.isStarter) return -1;
        if (!a.isStarter && b.isStarter) return 1;
        if (a.isStarter && b.isStarter && typeof a.pitchSlot === 'number' && typeof b.pitchSlot === 'number') {
            return a.pitchSlot - b.pitchSlot;
        }
        return 0;
    });

    // 2. Renderizar
    const container = document.getElementById('edit-stats-list');
    
    container.innerHTML = roster.map(p => {
        const prevStats = match.playerStats ? match.playerStats.find(ps => ps.playerId === p.id) : null;
        
        // Datos previos
        const goalsStr = prevStats?.detailGoals || "";
        const assistsStr = prevStats?.detailAssists || "";
        const yellowStr = prevStats?.detailYellow || "";
        const redStr = prevStats?.detailRed || "";
        const goalTypes = prevStats?.detailGoalTypes || []; 
        const ratingVal = prevStats?.rating || "";
        const minsVal = prevStats ? prevStats.minutes : (p.rol === 'Titular' ? 90 : 0);

        // Contadores
        const count = (str) => (!str) ? 0 : str.split(',').filter(s => s.trim() !== '').length;
        const gC = count(goalsStr) || (prevStats?.goals || 0);
        const aC = count(assistsStr) || (prevStats?.assists || 0);
        const yC = count(yellowStr) || (prevStats?.yellowCards || 0);
        const rC = count(redStr) || (prevStats?.redCards || 0);

        // Estilos
        const btnBase = "w-full h-9 border rounded text-sm font-bold flex items-center justify-center transition-all ";
        const btnStyle = (c, color='indigo') => c > 0 
            ? btnBase + `bg-${color}-100 text-${color}-700 border-${color}-300` 
            : btnBase + "bg-white text-gray-700 border-gray-300 hover:border-indigo-400";

        // IDs
        const prefix = 'edit-';
        const goalId = `${prefix}goals-${p.id}`;
        const assistId = `${prefix}assists-${p.id}`;
        const yellowId = `${prefix}yellow-${p.id}`;
        const redId = `${prefix}red-${p.id}`;
        
        const isCoach = p.rol === 'Entrenador';

        // Badge
        let badgeHtml = '';
        if (isCoach) badgeHtml = '<span class="bg-gray-200 text-gray-700 text-[10px] font-bold px-2 py-1 rounded">STAFF</span>';
        else if (p.rol === 'Titular') badgeHtml = '<span class="bg-emerald-100 text-emerald-700 text-[10px] font-bold px-2 py-1 rounded border border-emerald-200">TITULAR</span>';
        else badgeHtml = '<span class="bg-blue-50 text-blue-600 text-[10px] font-bold px-2 py-1 rounded border border-blue-100">SUPLENTE</span>';

        // --- HTML CONDICIONAL PARA ENTRENADOR ---
        // Si es entrenador, mostramos un guion gris en vez del input en Goles, Asistencias y Minutos.
        
        const goalsInputHtml = isCoach 
            ? `<div class="w-full h-9 flex items-center justify-center text-gray-300 text-lg select-none bg-gray-50 border border-gray-100 rounded">-</div>`
            : `<input type="hidden" class="stat-goals-minutes" id="${goalId}" value="${goalsStr}">
               <input type="hidden" class="stat-goals-types" id="${goalId}-types" value='${JSON.stringify(goalTypes)}'>
               <button type="button" id="btn-${goalId}" onclick="openMinuteModal('${goalId}', 'Goles ‚öΩ')" class="${btnStyle(gC)}">${gC}</button>`;

        const assistsInputHtml = isCoach
            ? `<div class="w-full h-9 flex items-center justify-center text-gray-300 text-lg select-none bg-gray-50 border border-gray-100 rounded">-</div>`
            : `<input type="hidden" class="stat-assists-minutes" id="${assistId}" value="${assistsStr}">
               <button type="button" id="btn-${assistId}" onclick="openMinuteModal('${assistId}', 'Asistencias üëü')" class="${btnStyle(aC)}">${aC}</button>`;

        const minsInputHtml = isCoach
            ? `<div class="w-full h-9 flex items-center justify-center text-gray-300 text-lg select-none bg-gray-50 border border-gray-100 rounded">-</div>`
            : `<input type="number" class="stat-minutes w-full h-9 px-2 border border-gray-300 rounded text-center text-gray-600 font-mono" value="${minsVal}">`;

        return `
        <div class="bg-white rounded-lg p-3 border border-gray-200 shadow-sm flex flex-col md:flex-row items-center gap-4" data-player-id="${p.id}" data-rol="${p.rol}">
             
             <div class="flex items-center gap-3 w-full md:w-1/3 min-w-[200px]">
                <img src="${p.foto}" class="w-10 h-10 rounded-full object-cover border border-gray-200" onerror="this.src='https://via.placeholder.com/40'">
                <div class="flex-1">
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-gray-800 text-sm truncate pr-2">${p.apodo || p.apellido}</span>
                        ${badgeHtml}
                    </div>
                    <span class="text-xs text-gray-400">#${p.dorsal} - ${p.posicion}</span>
                </div>
            </div>

            <div class="flex-1 grid grid-cols-5 gap-3 w-full">
                 
                 <div class="flex flex-col"><label class="text-[9px] uppercase font-bold text-gray-400 mb-1">Nota</label>
                 <input type="number" step="0.1" class="stat-rating w-full h-9 px-2 border border-gray-300 rounded text-center font-bold" value="${ratingVal}" placeholder="-"></div>

                 <div class="flex flex-col">
                    <label class="text-[9px] uppercase font-bold text-gray-400 mb-1">Gol</label>
                    ${goalsInputHtml}
                 </div>

                 <div class="flex flex-col"><label class="text-[9px] uppercase font-bold text-gray-400 mb-1">Asis</label>
                    ${assistsInputHtml}
                 </div>

                 <div class="flex flex-col"><label class="text-[9px] uppercase font-bold text-gray-400 mb-1">Min</label>
                    ${minsInputHtml}
                 </div>

                 <div class="flex flex-col items-center"><label class="text-[9px] uppercase font-bold text-gray-400 mb-1">Tarj</label>
                    <div class="flex gap-1 w-full">
                        <div class="flex-1">
                            <input type="hidden" class="stat-yellow-minutes" id="${yellowId}" value="${yellowStr}">
                            <button type="button" id="btn-${yellowId}" onclick="openMinuteModal('${yellowId}', 'Amarilla')" class="${btnStyle(yC, 'yellow')}">${yC}</button>
                        </div>
                        <div class="flex-1">
                            <input type="hidden" class="stat-red-minutes" id="${redId}" value="${redStr}">
                            <button type="button" id="btn-${redId}" onclick="openMinuteModal('${redId}', 'Roja')" class="${btnStyle(rC, 'red')}">${rC}</button>
                        </div>
                    </div>
                 </div>
            </div>
        </div>`;
    }).join('');

    // Cambiar vista
    document.getElementById('edit-step-lineup').classList.add('hidden');
    document.getElementById('edit-step-stats').classList.remove('hidden');
    document.getElementById('edit-step-stats').classList.add('flex');
}


        // --- AUTO-ROJA: Funci√≥n para detectar 2 amarillas ---
window.checkAutoRedCard = function(yellowInput) {
    // 1. Obtenemos el valor actual de amarillas
    const amarillas = parseInt(yellowInput.value) || 0;

    // 2. Si llega a 2 (o m√°s)
    if (amarillas >= 2) {
        // 3. Buscamos la fila del jugador (usando el atributo data-player-id como referencia)
        const row = yellowInput.closest('[data-player-id]'); 
        
        if (row) {
            // 4. Buscamos el input de rojas dentro de esa misma fila
            const redInput = row.querySelector('.stat-red');
            
            // 5. Si existe y actualmente es 0, le ponemos 1
            if (redInput) {
                redInput.value = 1;
                
                // (Opcional) Efecto visual r√°pido para indicar el cambio
                redInput.style.backgroundColor = '#fee2e2'; // Un rojo suave
                setTimeout(() => redInput.style.backgroundColor = '', 500);
            }
        }
    }
};
// =============================================================================
// 4. SISTEMA DE LOGROS (TROPHY ROOM)
// =============================================================================

const ACHIEVEMENTS_CONFIG = [
    {
        id: 'hat_trick',
        icon: 'üé©',
        title: 'Hat-Trick Hero',
        desc: 'Marcar 3 o m√°s goles en un solo partido.',
        check: (players, matches) => {
            const winners = [];
            matches.forEach(m => {
                m.playerStats.forEach(ps => {
                    if (ps.goals >= 3) {
                        const p = players.find(pl => pl.id === ps.playerId);
                        // Evitar duplicados si el mismo jugador lo hace varias veces, o mostrarlo varias veces (opcional)
                        // Aqu√≠ mostramos cada vez que ocurre con la fecha
                        if (p) winners.push({ p, detail: `vs ${m.opponent}` });
                    }
                });
            });
            return winners;
        }
    },
    {
        id: 'wall',
        icon: 'üß±',
        title: 'El Muro',
        desc: 'Portero que mantiene la porter√≠a a cero en un partido completo.',
        check: (players, matches) => {
            const winners = [];
            matches.forEach(m => {
                // 1. Ver si el equipo NO encaj√≥ goles
                let opponentGoals = 0;
                const parts = m.result.split('-');
                if (parts.length === 2) {
                    opponentGoals = m.venue === 'local' ? parseInt(parts[1]) : parseInt(parts[0]);
                }

                if (opponentGoals === 0) {
                    // 2. Buscar portero titular
                    m.playerStats.forEach(ps => {
                        const p = players.find(pl => pl.id === ps.playerId);
                        // Asumimos que si es portero y titular cuenta (simplificaci√≥n)
                        if (p && (p.posicion === 'portero' || p.posicion === 'portera') && ps.isStarter) {
                            winners.push({ p, detail: `vs ${m.opponent}` });
                        }
                    });
                }
            });
            return winners;
        }
    },
    {
        id: 'sniper',
        icon: 'üéØ',
        title: 'Francotirador',
        desc: 'Marcar gol en 3 partidos consecutivos.',
        check: (players, matches) => {
            const winners = [];
            // Ordenar cronol√≥gicamente
            const sortedMatches = [...matches].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            players.forEach(p => {
                let streak = 0;
                let maxStreak = 0;
                
                sortedMatches.forEach(m => {
                    const stats = m.playerStats.find(ps => ps.playerId === p.id);
                    if (stats && stats.goals > 0) {
                        streak++;
                    } else if (stats && stats.played) {
                        // Si jug√≥ y no marc√≥, se rompe la racha
                        streak = 0;
                    }
                    // Si no jug√≥, mantenemos la racha (opcional, o la rompemos)
                    if (streak > maxStreak) maxStreak = streak;
                });

                if (maxStreak >= 3) {
                    winners.push({ p, detail: `${maxStreak} seguidos` });
                }
            });
            return winners;
        }
    },
    {
        id: 'super_sub',
        icon: '‚ö°',
        title: 'Revulsivo de Oro',
        desc: 'Jugador con m√°s goles saliendo desde el banquillo (M√≠nimo 2).',
        check: (players, matches) => {
            const subGoals = {};
            matches.forEach(m => {
                m.playerStats.forEach(ps => {
                    if (!ps.isStarter && ps.goals > 0) {
                        subGoals[ps.playerId] = (subGoals[ps.playerId] || 0) + ps.goals;
                    }
                });
            });
            
            // Filtrar los que tengan >= 2
            const winners = [];
            Object.keys(subGoals).forEach(pid => {
                if (subGoals[pid] >= 2) {
                    const p = players.find(pl => pl.id === pid);
                    if (p) winners.push({ p, detail: `${subGoals[pid]} goles` });
                }
            });
            return winners.sort((a,b) => parseInt(b.detail) - parseInt(a.detail)); // Ordenar por cantidad
        }
    },
    {
        id: 'butcher',
        icon: 'üü®',
        title: 'El Carnicero',
        desc: 'Jugador que acumula m√°s tarjetas (Amarillas + Rojas) esta temporada.',
        check: (players, matches) => {
            const cards = {};
            matches.forEach(m => {
                m.playerStats.forEach(ps => {
                    const total = (ps.yellowCards || 0) + (ps.redCards || 0);
                    if (total > 0) cards[ps.playerId] = (cards[ps.playerId] || 0) + total;
                });
            });
            
            // Top 3 "carniceros" (m√≠nimo 3 tarjetas para salir)
            const winners = [];
            Object.keys(cards).forEach(pid => {
                if (cards[pid] >= 3) {
                    const p = players.find(pl => pl.id === pid);
                    if (p) winners.push({ p, detail: `${cards[pid]} üü®üü•` });
                }
            });
            return winners.sort((a,b) => parseInt(b.detail) - parseInt(a.detail)).slice(0, 3);
        }
    },
    {
        id: 'mvp_king',
        icon: 'üëë',
        title: 'MVP de la Temporada',
        desc: 'Jugador que ha ganado el premio MVP m√°s veces (M√≠nimo 3).',
        check: (players, matches) => {
            const mvps = {};
            matches.forEach(m => {
                if (m.mvp) {
                    mvps[m.mvp] = (mvps[m.mvp] || 0) + 1;
                }
            });
            
            const winners = [];
            Object.keys(mvps).forEach(pid => {
                if (mvps[pid] >= 3) {
                    const p = players.find(pl => pl.id === pid);
                    if (p) winners.push({ p, detail: `${mvps[pid]} veces` });
                }
            });
            return winners.sort((a,b) => parseInt(b.detail) - parseInt(a.detail));
        }
    }
];

function openTrophyRoom() {
    const modal = document.getElementById('trophy-modal');
    if (!modal) return; // Seguridad

    const container = document.getElementById('trophy-container');
    container.innerHTML = ''; // Limpiar

    const players = getPlayers();
    const matches = getData('matches');

    let totalUnlocked = 0;

    ACHIEVEMENTS_CONFIG.forEach(ach => {
        // Ejecutar la funci√≥n de chequeo de cada logro
        const winners = ach.check(players, matches);
        const isUnlocked = winners.length > 0;
        if (isUnlocked) totalUnlocked++;

        // Crear tarjeta HTML
        const card = document.createElement('div');
        card.className = `trophy-card ${isUnlocked ? 'trophy-unlocked trophy-rare' : 'trophy-locked'}`;
        
        let winnersHtml = '';
        if (isUnlocked) {
            winnersHtml = `<div class="trophy-winners">`;
            // Mostrar m√°ximo 5 ganadores para no saturar
            winners.slice(0, 5).forEach(w => {
                winnersHtml += `
                    <div class="winner-badge">
                        <img src="${w.p.foto}" class="w-4 h-4 rounded-full object-cover">
                        <span>${w.p.apodo || w.p.apellido}</span>
                        <span class="text-xs text-gray-500 font-normal">(${w.detail})</span>
                    </div>
                `;
            });
            if (winners.length > 5) {
                winnersHtml += `<span class="text-xs text-gray-400 flex items-center">+${winners.length - 5} m√°s</span>`;
            }
            winnersHtml += `</div>`;
        } else {
            winnersHtml = `<div class="mt-4 text-xs text-gray-400 italic">Nadie ha conseguido esto todav√≠a...</div>`;
        }

        card.innerHTML = `
            <span class="trophy-icon">${ach.icon}</span>
            <div class="trophy-title">${ach.title}</div>
            <div class="trophy-desc">${ach.desc}</div>
            ${winnersHtml}
        `;
        container.appendChild(card);
    });

    // Actualizar contador del t√≠tulo
    document.getElementById('trophy-count').textContent = `${totalUnlocked}/${ACHIEVEMENTS_CONFIG.length}`;

    modal.classList.add('active');
    lockScroll();
}

function closeTrophyRoom() {
    document.getElementById('trophy-modal').classList.remove('active');
    unlockScroll();
}
// ==========================================
// FUNCIONES AUXILIARES PARA LA FICHA DE JUGADOR
// (P√©galas al final de tu archivo JS)
// ==========================================

// 1. FUNCI√ìN PARA CAMBIAR DE PESTA√ëA
function switchPlayerTab(tabName) {
    // 1. Ocultar todos los contenidos y desactivar botones
    ['profile', 'season', 'history', 'career', 'fut'].forEach(t => {
        const content = document.getElementById(`tab-content-${t}`);
        const btn = document.getElementById(`tab-btn-${t}`);
        
        if(content) content.classList.add('hidden');
        if(btn) {
            // Estilo inactivo
            btn.className = "pb-3 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-gray-600 transition-colors flex items-center gap-2";
        }
    });

    // 2. Mostrar el seleccionado
    const activeContent = document.getElementById(`tab-content-${tabName}`);
    const activeBtn = document.getElementById(`tab-btn-${tabName}`);

    if (activeContent) activeContent.classList.remove('hidden');
    if (activeBtn) {
        // Estilo activo
        activeBtn.className = "pb-3 text-sm font-bold border-b-2 border-indigo-600 text-indigo-600 transition-colors flex items-center gap-2";
    }
}

// 3. GENERADOR DE LA PESTA√ëA HISTORIAL (TABLA)
function renderHistoryTab(player, matches) {
    const isCoach = player.posicion === 'entrenador';
    
    // Helpers seguros
    const safeDate = (d) => typeof formatDate === 'function' ? formatDate(d) : d;
    const safeColor = (r) => typeof getRatingColor === 'function' ? getRatingColor(r) : '';

    if (matches.length === 0) {
        return `<div class="text-center py-10 text-gray-400 italic">No hay partidos registrados.</div>`;
    }

    return `
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-50 text-gray-500 font-bold uppercase text-xs">
                        <tr>
                            <th class="px-4 py-3">Fecha / Rival</th>
                            <th class="px-4 py-3 text-center">Rol</th>
                            <th class="px-4 py-3 text-center">Nota</th>
                            <th class="px-4 py-3 text-center text-emerald-600">G</th>
                            <th class="px-4 py-3 text-center text-blue-600">A</th>
                            <th class="px-4 py-3 text-center">Min</th>
                            <th class="px-4 py-3 text-center">T</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        ${matches.map(m => `
                            <tr class="hover:bg-slate-50 transition-colors">
                                <td class="px-4 py-3">
                                    <div class="font-bold text-slate-700">${m.opponent}</div>
                                    <div class="text-xs text-gray-400">${safeDate(m.date)}</div>
                                </td>
                                <td class="px-4 py-3 text-center">
                                    ${(m.isStarter === true || m.isStarter === 'true') 
                                        ? '<span class="bg-green-100 text-green-700 px-2 py-0.5 rounded-full text-[10px] font-bold uppercase">Titular</span>' 
                                        : '<span class="bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full text-[10px] font-bold uppercase">Suplente</span>'}
                                </td>
                                <td class="px-4 py-3 text-center font-bold text-base ${safeColor(m.rating)}">
                                    ${m.rating || '-'}
                                </td>
                                <td class="px-4 py-3 text-center font-medium ${m.goals > 0 ? 'text-emerald-600 font-bold' : 'text-gray-300'}">
                                    ${isCoach ? '-' : (m.goals || '-')}
                                </td>
                                <td class="px-4 py-3 text-center font-medium ${m.assists > 0 ? 'text-blue-600 font-bold' : 'text-gray-300'}">
                                    ${isCoach ? '-' : (m.assists || '-')}
                                </td>
                                <td class="px-4 py-3 text-center text-gray-500">
                                    ${isCoach ? '-' : (m.minutes || 0)}'
                                </td>
                                <td class="px-4 py-3 text-center">
                                     ${m.redCards > 0 ? 'üü•' : (m.yellowCards > 0 ? 'üü®' : '')}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

function renderCareerTab(player) {
    if (!player.historialTemporadas || player.historialTemporadas.length === 0) {
        return `<div class="text-center py-10 text-gray-400 italic">No hay historial de temporadas anteriores.</div>`;
    }

    // Ordenar por temporada descendente
    const history = [...player.historialTemporadas].sort((a, b) => b.temporada.localeCompare(a.temporada));

    return `
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-50 text-gray-500 font-bold uppercase text-xs">
                        <tr>
                            <th class="px-4 py-3">Temporada</th>
                            <th class="px-4 py-3 text-center">PJ</th>
                            <th class="px-4 py-3 text-center text-emerald-600">Goles</th>
                            <th class="px-4 py-3 text-center text-blue-600">Asist</th>
                            <th class="px-4 py-3 text-center text-yellow-600">üü®</th>
                            <th class="px-4 py-3 text-center text-red-600">üü•</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        ${history.map(h => `
                            <tr class="hover:bg-slate-50 transition-colors">
                                <td class="px-4 py-3 font-bold text-slate-700">${h.temporada}</td>
                                <td class="px-4 py-3 text-center font-medium">${h.partidos}</td>
                                <td class="px-4 py-3 text-center font-bold text-emerald-600">${h.goles}</td>
                                <td class="px-4 py-3 text-center font-bold text-blue-600">${h.asistencias}</td>
                                <td class="px-4 py-3 text-center">${h.amarillas}</td>
                                <td class="px-4 py-3 text-center">${h.rojas}</td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

// =========================================================
// FUNCI√ìN PARA CERRAR EL MODAL
// =========================================================
function closePlayerDetailsModal() {
    const modal = document.getElementById('player-details-modal');
    if (!modal) return;

    // 1. Iniciamos la animaci√≥n de salida (Opacity)
    modal.classList.remove('opacity-100'); // Si usas esta clase para mostrar
    modal.classList.add('opacity-0');

    // 2. Esperamos a que termine la transici√≥n (300ms) para ocultarlo del todo
    setTimeout(() => {
        // Quitamos la clase .active que controla tu CSS
        modal.classList.remove('active'); 
        
        // Quitamos display flex y ponemos hidden
        modal.classList.remove('flex');
        modal.classList.add('hidden');

        // 3. Limpiamos el contenido para que no parpadee informaci√≥n vieja al volver a abrir
        const header = document.getElementById('player-modal-header-container');
        const content = document.getElementById('player-details-content');
        if(header) header.innerHTML = '';
        if(content) content.innerHTML = '';

        unlockScroll();
        currentPlayerDetailsId = null;
    }, 300);
}

// ==========================================
// 1. L√ìGICA DE AUTO-ALINEACI√ìN
// ==========================================

function loadLastLineup() {
    const matches = getData('matches');
    if (matches.length === 0) { alert("No hay partidos previos para copiar."); return; }

    // Intentamos buscar el √∫ltimo de la MISMA competici√≥n actual
    const currentComp = document.getElementById('new-competition').value;
    let lastMatch = matches.slice().reverse().find(m => m.competition === currentComp);
    
    // Si no hay de esta compe, cogemos el √∫ltimo absoluto
    if (!lastMatch) lastMatch = matches[matches.length - 1];

    if(confirm(`¬øCargar alineaci√≥n del partido contra ${lastMatch.opponent}?`)) {
        // Filtramos solo los que fueron titulares
        const starterIds = lastMatch.playerStats
            .filter(s => s.isStarter)
            .map(s => s.playerId);
            
        applyAutoLineup(starterIds);
    }
}

function loadBestXILineup() {
    const players = getPlayers();
    const matches = getData('matches');
    
    if (matches.length === 0) { alert("Necesitas jugar partidos para calcular el Once de Gala."); return; }

    // Calcular media de todos los jugadores activos
    const ratings = players
        .filter(p => p.posicion !== 'entrenador' && p.estado === 'Activo')
        .map(p => {
            let sum = 0, count = 0;
            matches.forEach(m => {
                const ps = m.playerStats.find(s => s.playerId === p.id);
                if (ps && ps.rating) { sum += parseFloat(ps.rating); count++; }
            });
            return { id: p.id, avg: count > 0 ? sum/count : 0, pos: p.posicion };
        })
        .sort((a, b) => b.avg - a.avg); // Ordenar por mejor nota

    // Funci√≥n auxiliar para coger los mejores por posici√≥n
    const getBest = (pos, limit, excludeIds = []) => {
        return ratings
            .filter(r => r.pos === pos && !excludeIds.includes(r.id))
            .slice(0, limit)
            .map(r => r.id);
    };
    
    // Construir un 4-3-3 gen√©rico (o ad√°ptalo si prefieres otra cosa)
    const gk = getBest('portero', 1);
    const defs = getBest('defensa', 4);
    const mids = getBest('centrocampista', 3);
    // Para delanteros unimos delanteros y extremos
    const fwds = ratings
        .filter(r => (r.pos === 'delantero' || r.pos === 'extremo') && !gk.includes(r.id) && !defs.includes(r.id) && !mids.includes(r.id))
        .sort((a, b) => b.avg - a.avg)
        .slice(0, 3)
        .map(r => r.id);

    const bestXI = [...gk, ...defs, ...mids, ...fwds];

    if(bestXI.length < 11) { 
        alert("No hay suficientes datos/jugadores para formar un once completo."); 
        return; 
    }
    
    if(confirm("¬øCargar el Once de Gala basado en nota media?")) {
        applyAutoLineup(bestXI);
    }
}

function applyAutoLineup(playerIds) {
    // 1. Limpiar pizarra actual
    currentPitchPlayers = {}; 
    currentSubstitutes = [];
    
    const players = getPlayers();
    
    // 2. Ordenar jugadores entrantes por l√≥gica posicional para que caigan en orden
    // (Portero -> Defensas -> Medios -> Delanteros)
    const posOrder = { 'portero': 0, 'defensa': 1, 'centrocampista': 2, 'extremo': 3, 'delantero': 4 };
    
    const sortedIds = playerIds.sort((a, b) => {
        const pA = players.find(p => p.id === a);
        const pB = players.find(p => p.id === b);
        const orderA = pA ? posOrder[pA.posicion] : 5;
        const orderB = pB ? posOrder[pB.posicion] : 5;
        return orderA - orderB;
    });

    // 3. Asignar a los slots (0 al 10)
    sortedIds.slice(0, 11).forEach((pid, index) => {
        currentPitchPlayers[`slot-${index}`] = pid;
    });

    // 4. Los que sobren (si enviaste m√°s de 11) o el resto de la plantilla van al banquillo
    // La funci√≥n renderBench se encarga de mostrar en el banquillo a quien no est√© en el campo
    
    // 5. Repintar
    renderAll(); 
}
// ==========================================
// 2. L√ìGICA HISTOGRAMA DE NOTAS
// ==========================================
let histogramChart = null;

function renderRatingHistogram() {
    const ctx = document.getElementById('chart-rating-histogram');
    if (!ctx) return;

    const matches = getData('matches');
    
    // Buckets: <5, 5-6, 6-7, 7-8, 8-9, 9-10
    const buckets = [0, 0, 0, 0, 0, 0]; 
    
    matches.forEach(m => {
        m.playerStats.forEach(ps => {
            if (ps.rating !== null && ps.rating !== "" && ps.rating !== undefined) {
                const r = parseFloat(ps.rating);
                if (r < 5) buckets[0]++;       // Suspenso
                else if (r < 6) buckets[1]++;  // Suficiente
                else if (r < 7) buckets[2]++;  // Bien
                else if (r < 8) buckets[3]++;  // Notable
                else if (r < 9) buckets[4]++;  // Notable Alto
                else buckets[5]++;             // Sobresaliente
            }
        });
    });

    if (histogramChart) histogramChart.destroy();

    const isDark = document.body.classList.contains('dark-mode');
    const textColor = isDark ? '#cbd5e1' : '#4b5563';

    histogramChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['< 5', '5 - 6', '6 - 7', '7 - 8', '8 - 9', '9 - 10'],
            datasets: [{
                label: 'Frecuencia',
                data: buckets,
                backgroundColor: [
                    '#ef4444', // Rojo (Suspenso)
                    '#f97316', // Naranja
                    '#eab308', // Amarillo
                    '#84cc16', // Lima
                    '#10b981', // Verde
                    '#3b82f6'  // Azul (Top)
                ],
                borderRadius: 6,
                borderSkipped: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
                legend: { display: false },
                datalabels: {
                    color: textColor,
                    anchor: 'end',
                    align: 'top',
                    font: { weight: 'bold' }
                }
            },
            scales: { 
                y: { beginAtZero: true, display: false },
                x: { 
                    grid: { display: false },
                    ticks: { color: textColor, font: {weight: 'bold'} }
                }
            }
        }
    });
}
// ==========================================
// 3. GENERADOR CARTA FUT (DATOS REALES)
// ==========================================
function renderFutTab(player, stats, avgRating) {
    const container = document.getElementById('tab-content-fut');
    if(!container) return;

    // --- 1. L√ìGICA DE POSICI√ìN ---
    let futPos = player.rol; 
    if (!futPos) {
        const posMap = {
            'portero': 'POR', 'defensa': 'DFC', 'centrocampista': 'MC', 
            'extremo': 'ED', 'delantero': 'DC', 'entrenador': 'ENT'
        };
        futPos = posMap[player.posicion] || 'JUG';
    }

    // --- 2. L√ìGICA DE PIE (NUEVO) ---
    // Si es "Izquierdo" (case insensitive) pone 'I', si no 'D'
    let pieLetra = 'D';
    if (player.piePreferido && player.piePreferido.toLowerCase() === 'izquierdo') {
        pieLetra = 'I';
    }
    
    // MEDIA FUT
    let futRating = parseFloat(avgRating);
    if(isNaN(futRating)) {
        futRating = "?";
    } else {
        futRating = Math.min(99, Math.round(futRating * 10) + 15); 
    }

    // L√≥gica Holo
    let cardHoloClass = '';
    if ((typeof futRating === 'number' && futRating >= 90) || player.estado === 'Leyenda') {
        cardHoloClass = 'holo-effect';
    }

    // Estad√≠sticas
    const v1 = stats.matchesPlayed || 0; const l1 = "PJ";
    const v2 = stats.goals || 0; const l2 = "GOL";
    const v3 = stats.assists || 0; const l3 = "ASI";
    const v4 = avgRating !== '-' ? avgRating : '-'; const l4 = "MED";
    const v5 = stats.starts || 0; const l5 = "TIT";
    const v6 = stats.wins || 0; const l6 = "VIC";

    const marketValue = player.valorMercado || 0; 
    const unitShort = player.unidad || 'M‚Ç¨'; 
    const unitLong = unitShort === 'K‚Ç¨' ? 'MIL ‚Ç¨' : 'MILLONES DE ‚Ç¨';

    container.innerHTML = `
        <div class="fut-card-wrapper animate-in zoom-in duration-300">
            
            <div class="fut-scene" onclick="this.classList.toggle('is-flipped')">
                <div class="fut-card-inner">
                    
                    <div class="fut-card fut-card-front ${cardHoloClass}">
                        <div style="display:flex; justify-content:center; align-items:center; gap:8px; margin-bottom:-10px; padding-left:10px;">
                            <div class="fut-rating counter-anim" data-target="${futRating}">0</div>
                            <div style="display:flex; flex-direction:column; align-items:start; line-height:1;">
                                <div class="fut-pos">${futPos}</div>
                                <div style="font-size:11px; font-weight:bold; margin-top:2px;" title="Pie ${player.piePreferido}">${pieLetra}</div>
                                <div style="font-size:10px; opacity:0.7; display:none;">RM</div> </div>
                        </div>
                        
                        <img src="${player.foto}" class="fut-img" onerror="this.src='https://via.placeholder.com/150'">
                        
                        <div class="fut-name">${player.apodo || player.apellido}</div>
                        
                        <div class="fut-stats">
                            <div title="Partidos Jugados"><span class="fut-stat-val text-green-400 counter-anim" data-target="${v1}">0</span><span class="fut-stat-label">${l1}</span></div>
                            <div title="Nota Media"><span class="fut-stat-val text-yellow-400 counter-anim" data-target="${v4}" data-float="true">0.00</span><span class="fut-stat-label">${l4}</span></div>
                            <div title="Goles"><span class="fut-stat-val text-blue-300 counter-anim" data-target="${v2}">0</span><span class="fut-stat-label">${l2}</span></div>
                            <div title="Titularidades"><span class="fut-stat-val text-gray-300 counter-anim" data-target="${v5}">0</span><span class="fut-stat-label">${l5}</span></div>
                            <div title="Asistencias"><span class="fut-stat-val text-purple-300 counter-anim" data-target="${v3}">0</span><span class="fut-stat-label">${l3}</span></div>
                            <div title="Victorias"><span class="fut-stat-val text-red-300 counter-anim" data-target="${v6}">0</span><span class="fut-stat-label">${l6}</span></div>
                        </div>
                    </div>

                    <div class="fut-card-back">
                        <div class="back-logo">‚öΩ</div>
                        <h3 class="text-xl font-bold mb-4 text-white">${player.apodo}</h3>
                        
                        <div class="back-row">
                            <span class="back-label">Nacionalidad</span>
                            <span class="back-val">${player.nacionalidad}</span>
                        </div>
                        <div class="back-row">
                            <span class="back-label">Edad</span>
                            <span class="back-val">${calculateAge(player.fechaNacimiento)} a√±os</span>
                        </div>
                        <div class="back-row">
                            <span class="back-label">Pie</span>
                            <span class="back-val">${player.piePreferido || '-'}</span>
                        </div>
                        <div class="back-row">
                            <span class="back-label">Estado</span>
                            <span class="back-val">${player.estado}</span>
                        </div>
                         <div class="back-row" style="border-bottom:none; margin-top:10px;">
                            <span class="back-label">Valor Mercado</span>
                            <span class="back-val text-2xl text-yellow-400 counter-anim" data-target="${marketValue}" data-float="${marketValue % 1 !== 0}">0</span>
                        </div>
                        <div class="text-xs text-yellow-600 font-bold mb-6">${unitLong}</div>

                        <div class="tap-hint">‚Üª Toca para girar</div>
                    </div>

                </div>
            </div>
            
            <p class="text-center text-xs text-gray-400 mt-6 italic opacity-50">
                Resumen de Temporada
            </p>

            <div class="flex justify-center gap-4 mt-4">
                <button onclick="downloadTotsCard('${player.id}')" class="bg-gradient-to-r from-blue-600 to-indigo-600 text-white font-bold py-2 px-6 rounded-full shadow-lg hover:shadow-xl transform hover:scale-105 transition-all flex items-center gap-2 border border-blue-400">
                    <span>üì∏</span> Descargar TOTS
                </button>
            </div>
        </div>
    `;
    
    setTimeout(runCounters, 50);
}

// Funci√≥n dummy por si haces click (puedes implementarla con html2canvas m√°s tarde)
function downloadFutCard() {
    alert("Para descargar la carta, haz una captura de pantalla.");
}

async function downloadTotsCard(playerId) {
    const players = getPlayers();
    const player = players.find(p => p.id === playerId);
    if (!player) return;

    // Recalcular estad√≠sticas para asegurar datos frescos
    const matches = getData('matches');
    let stats = { matches: 0, goals: 0, assists: 0, ratingSum: 0, ratingCount: 0, mvps: 0, minutes: 0 };
    
    matches.forEach(m => {
        const ps = m.playerStats.find(s => s.playerId === playerId);
        if (ps && (ps.played || ps.minutes > 0)) {
            stats.matches++;
            stats.goals += ps.goals || 0;
            stats.assists += ps.assists || 0;
            stats.minutes += ps.minutes || 0;
            if (ps.rating) {
                stats.ratingSum += parseFloat(ps.rating);
                stats.ratingCount++;
            }
        }
        if (m.mvp === playerId) stats.mvps++;
    });
    
    const avgRating = stats.ratingCount > 0 ? (stats.ratingSum / stats.ratingCount).toFixed(2) : '-';

    // Notificar al usuario
    const originalText = document.body.style.cursor;
    document.body.style.cursor = 'wait';
    if(typeof showToast === 'function') showToast("üé® Dise√±ando cromo TOTS...", "info");

    // --- SOLUCI√ìN AL ERROR: PROXY A BASE64 ---
    // Convertimos la imagen remota a local para evitar bloqueo de seguridad (Tainted Canvas)
    let imgUrl = player.foto;
    try {
        const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(player.foto)}`;
        const response = await fetch(proxyUrl);
        if (response.ok) {
            const blob = await response.blob();
            imgUrl = await new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.readAsDataURL(blob);
            });
        }
    } catch (e) {
        console.warn("Proxy fall√≥, intentando carga directa...", e);
    }

    // Crear contenedor temporal fuera de pantalla
    const container = document.createElement('div');
    container.id = "temp-tots-container";
    container.style.position = 'fixed';
    container.style.top = '0';
    container.style.left = '0';
    container.style.zIndex = '-50';
    container.style.width = '600px';
    container.style.height = '900px';
    container.style.overflow = 'hidden';
    document.body.appendChild(container);

    // Generar HTML del Cromo
    container.innerHTML = `
        <div id="tots-card-render" style="width: 600px; height: 900px; background: radial-gradient(circle at 50% 0%, #1e3a8a 0%, #0f172a 60%, #020617 100%); font-family: 'Inter', sans-serif; position: relative; display: flex; flex-direction: column; align-items: center; color: white; overflow: hidden;">
            
            <!-- Fondo Decorativo -->
            <div style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; background-image: url('https://www.transparenttextures.com/patterns/cubes.png'); opacity: 0.1;"></div>
            <div style="position: absolute; top: -100px; left: -100px; width: 400px; height: 400px; background: #3b82f6; filter: blur(150px); opacity: 0.4;"></div>
            <div style="position: absolute; bottom: -100px; right: -100px; width: 400px; height: 400px; background: #fbbf24; filter: blur(150px); opacity: 0.3;"></div>

            <!-- Header -->
            <div style="margin-top: 40px; text-align: center; z-index: 10;">
                <div style="font-size: 16px; letter-spacing: 4px; color: #fbbf24; font-weight: bold; text-transform: uppercase; margin-bottom: 5px;">Real Madrid CF</div>
                <div style="font-size: 42px; font-weight: 900; background: linear-gradient(to right, #fff, #93c5fd); -webkit-background-clip: text; -webkit-text-fill-color: transparent; text-transform: uppercase; line-height: 1;">TEAM OF THE SEASON</div>
            </div>

            <!-- Foto Jugador (Usando la URL Base64 segura) -->
            <div style="margin-top: 30px; width: 320px; height: 320px; border-radius: 50%; border: 8px solid #fbbf24; box-shadow: 0 0 50px rgba(251, 191, 36, 0.3); overflow: hidden; position: relative; z-index: 10; background: #000;">
                <img src="${imgUrl}" style="width: 100%; height: 100%; object-fit: cover; object-position: top;">
            </div>

            <!-- Nombre y Datos -->
            <div style="margin-top: 20px; text-align: center; z-index: 10;">
                <div style="font-size: 48px; font-weight: 900; text-transform: uppercase; text-shadow: 0 4px 10px rgba(0,0,0,0.5);">${player.apodo || player.apellido}</div>
                <div style="font-size: 24px; color: #94a3b8; font-weight: bold;">${player.posicion.toUpperCase()} <span style="color: #fbbf24;">‚Ä¢</span> #${player.dorsal}</div>
            </div>

            <!-- Stats Grid -->
            <div style="margin-top: 40px; display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 20px; width: 80%; z-index: 10;">
                ${[
                    { l: 'PARTIDOS', v: stats.matches }, { l: 'NOTA MEDIA', v: avgRating }, { l: 'MINUTOS', v: stats.minutes },
                    { l: 'GOLES', v: stats.goals }, { l: 'ASISTENCIAS', v: stats.assists }, { l: 'MVPs', v: stats.mvps }
                ].map(s => `
                    <div style="background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 12px; padding: 15px; text-align: center;">
                        <div style="font-size: 32px; font-weight: 900; color: #fbbf24; line-height: 1; margin-bottom: 5px;">${s.v}</div>
                        <div style="font-size: 10px; font-weight: bold; color: #94a3b8; letter-spacing: 1px;">${s.l}</div>
                    </div>
                `).join('')}
            </div>

            <!-- Footer -->
            <div style="margin-top: auto; margin-bottom: 30px; font-size: 12px; color: rgba(255,255,255,0.3); z-index: 10;">
                Generado por An√°lisis Real Madrid
            </div>
        </div>
    `;

    await new Promise(resolve => setTimeout(resolve, 800)); // Esperar carga de im√°genes

    try {
        // IMPORTANTE: allowTaint: false (default) y useCORS: true
        const canvas = await html2canvas(container.querySelector('#tots-card-render'), { 
            scale: 2, 
            backgroundColor: null, 
            useCORS: true, 
            logging: false,
            // Fix: Eliminar estilos de Tailwind (oklch) del clon para evitar error de parser
            onclone: (doc) => { doc.querySelectorAll('style').forEach(s => s.remove()); }
        });
        const link = document.createElement('a');
        link.download = `TOTS_${player.nombre}_${player.apellido}.png`;
        link.href = canvas.toDataURL("image/png");
        link.click();
        if(typeof showToast === 'function') showToast("‚úÖ Cromo guardado", "success");
    } catch (err) { console.error(err); alert("Error generando el cromo: " + err.message); } 
    finally { document.body.removeChild(container); document.body.style.cursor = originalText; }
}

function renderTierList() {
    // Solo jugadores Activos
    const players = getPlayers().filter(p => p.estado === 'Activo');
    const matches = getData('matches');
    const container = document.getElementById('tier-list-container');
    
    if (!container || matches.length === 0) return;

    // 1. Calcular medias de todos los jugadores
    const ratedPlayers = players.map(p => {
        let sum = 0, count = 0;
        matches.forEach(m => {
            const ps = m.playerStats.find(s => s.playerId === p.id);
            if (ps && ps.rating) { sum += parseFloat(ps.rating); count++; }
        });
        return { ...p, avg: count > 0 ? (sum/count) : 0 };
    }).filter(p => p.avg > 0); // Solo mostramos los que han jugado y tienen nota

    // 2. Definir los niveles (Tiers)
    const tiers = [
        { name: 'S', color: 'bg-purple-600', min: 8.5, players: [] },
        { name: 'A', color: 'bg-emerald-500', min: 7.0, players: [] },
        { name: 'B', color: 'bg-blue-500',    min: 6.0, players: [] },
        { name: 'C', color: 'bg-yellow-500',  min: 5.0, players: [] },
        { name: 'D', color: 'bg-red-500',     min: 0.0, players: [] }
    ];

    // 3. Clasificar jugadores en sus cajas
    ratedPlayers.forEach(p => {
        for (let tier of tiers) {
            if (p.avg >= tier.min) {
                tier.players.push(p);
                break; // Una vez entra en uno, deja de buscar
            }
        }
    });

    // --- NUEVO: Ordenar dentro de cada Tier (Mejor nota primero) ---
    tiers.forEach(tier => {
        tier.players.sort((a, b) => b.avg - a.avg);
    });

    // 4. Renderizar HTML
    container.innerHTML = tiers.map(tier => {
        if (tier.players.length === 0) return ''; // Ocultar tiers vac√≠os
        
        return `
            <div class="flex border border-gray-200 rounded-lg overflow-hidden mb-2 shadow-sm">
                <div class="${tier.color} w-14 flex items-center justify-center text-white font-black text-2xl shrink-0 shadow-inner">
                    ${tier.name}
                </div>
                
                <div class="flex-1 bg-gray-50 p-2 flex flex-wrap gap-3 items-center content-center">
                    ${tier.players.map(p => `
                        <div class="relative group cursor-pointer transition-transform hover:-translate-y-1" onclick="viewPlayerDetails('${p.id}')">
                            <img src="${p.foto}" 
                                 class="w-11 h-11 rounded-full border-2 border-white shadow-sm object-cover object-top" 
                                 title="${p.nombre} (${p.avg.toFixed(2)})"
                                 onerror="this.src='https://via.placeholder.com/40'">
                            
                            <span class="absolute -bottom-1.5 -right-1 bg-slate-800 text-white text-[9px] px-1.5 py-0.5 rounded-full font-bold border border-white shadow-sm z-10">
                                ${p.avg.toFixed(2)}
                            </span>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }).join('');
}
// ==========================================
// ANIMACI√ìN DE N√öMEROS (COUNTER UP)
// ==========================================
function runCounters() {
    const counters = document.querySelectorAll('.counter-anim');
    
    counters.forEach(counter => {
        // Leemos el valor final y si lleva decimales
        const target = parseFloat(counter.getAttribute('data-target'));
        const isFloat = counter.getAttribute('data-float') === 'true';
        
        if (isNaN(target)) return;
        
        // Configuraci√≥n
        const duration = 1200; // 1.2 segundos de animaci√≥n
        const start = 0;
        const startTime = performance.now();

        function update(currentTime) {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);
            
            // Efecto "Ease Out" (frena al final)
            const ease = 1 - Math.pow(1 - progress, 3);
            
            const current = start + (target - start) * ease;
            
            if (isFloat) {
                counter.innerText = current.toFixed(2);
            } else {
                counter.innerText = Math.round(current);
            }

            if (progress < 1) {
                requestAnimationFrame(update);
            } else {
                // Asegurar valor final exacto
                counter.innerText = isFloat ? target.toFixed(2) : Math.round(target);
                counter.classList.remove('counter-anim'); // Evitar re-animar
            }
        }
        
        requestAnimationFrame(update);
    });
}
function triggerConfetti() {
    const colors = ['#ef4444', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899'];
    const container = document.createElement('div');
    container.className = 'confetti-container';
    document.body.appendChild(container);

    // Crear 100 part√≠culas
    for (let i = 0; i < 100; i++) {
        const piece = document.createElement('div');
        piece.className = 'confetti-piece';
        
        // Propiedades aleatorias
        const bg = colors[Math.floor(Math.random() * colors.length)];
        const left = Math.random() * 100 + '%';
        const duration = Math.random() * 2 + 3; // Entre 3 y 5 segundos
        const delay = Math.random() * 2; // Retraso inicial
        const size = Math.random() * 10 + 5 + 'px';

        piece.style.backgroundColor = bg;
        piece.style.left = left;
        piece.style.width = size;
        piece.style.height = size;
        
        // Asignar animaciones
        piece.style.animation = `fall-y ${duration}s linear ${delay}s forwards, sway-x ${duration}s ease-in-out ${delay}s infinite`;
        
        container.appendChild(piece);
    }

    // Limpiar el DOM despu√©s de 6 segundos
    setTimeout(() => {
        container.remove();
    }, 6000);
}
// Funci√≥n para mostrar notificaciones elegantes
function showToast(message, type = 'success') {
    // Buscar o crear el contenedor
    let container = document.querySelector('.toast-container');
    if (!container) {
        container = document.createElement('div');
        container.className = 'toast-container';
        document.body.appendChild(container);
    }

    // Definir icono seg√∫n el tipo
    const icons = {
        success: '‚úÖ',
        error: '‚ùå',
        info: '‚ÑπÔ∏è'
    };

    // Crear el elemento Toast
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `
        <span class="toast-icon">${icons[type]}</span>
        <span>${message}</span>
    `;

    // A√±adir al contenedor
    container.appendChild(toast);

    // Eliminar autom√°ticamente a los 3 segundos
    setTimeout(() => {
        toast.classList.add('hide');
        // Esperar a que termine la animaci√≥n de salida para borrar del DOM
        toast.addEventListener('animationend', () => {
            toast.remove();
        });
    }, 3000);
}
async function exportLineupToImage() {
    const boardElement = document.getElementById('tactical-board-container'); 
    
    if (!boardElement) {
        console.error("No se encuentra el contenedor de la pizarra");
        return;
    }

    if(typeof showToast === 'function') showToast("üì∏ Capturando...", "info");

    // 1. Ocultar botones
    const uiElements = document.querySelectorAll('.no-capture, .player-remove-btn');
    uiElements.forEach(el => el.style.display = 'none');

    // --- CONGELADO SEGURO (SAFE FREEZE) ---
    const realTokens = boardElement.querySelectorAll('.player-token');
    
    realTokens.forEach(t => {
        // 1. Quitamos la clase que provoca el movimiento de ca√≠da
        t.classList.remove('animate-drop'); 
        
        // 2. Anulamos transiciones suaves (hover, efectos)
        t.style.setProperty('transition', 'none', 'important');
        
        // 3. CAMBIO IMPORTANTE: En vez de quitar el transform (que romp√≠a el centrado),
        // forzamos a que la animaci√≥n sea NULA.
        t.style.setProperty('animation', 'none', 'important');
        
        // 4. Aseguramos que se vean
        t.style.setProperty('opacity', '1', 'important');
    });

    try {
        // Esperamos un instante para que el navegador aplique el "frenazo"
        await new Promise(resolve => setTimeout(resolve, 150));

        const canvas = await html2canvas(boardElement, {
            useCORS: true,       
            allowTaint: true,    
            scale: 2,            
            backgroundColor: null, 
            logging: false
        });

        // Descargar
        const link = document.createElement('a');
        link.download = `Alineacion_${new Date().toISOString().slice(0,10)}.png`;
        link.href = canvas.toDataURL("image/png");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        if(typeof showToast === 'function') showToast("‚úÖ Foto guardada", "success");

    } catch (err) {
        console.error("Error al exportar:", err);
        if(typeof showToast === 'function') showToast("‚ö†Ô∏è Error al crear la imagen.", "error");
    } finally {
        // Restaurar botones
        uiElements.forEach(el => el.style.display = '');

        // Limpiar estilos forzados para que el usuario pueda seguir interactuando
        realTokens.forEach(t => {
            t.style.transition = '';
            t.style.animation = '';
            t.style.opacity = '';
        });
    }
}
function calculateSquadValue() {
    let startingValue = 0;
    let benchValue = 0;

    // 1. Obtenemos todos los jugadores disponibles
    // Si usas 'getActivePlayers()' √∫salo, si no, usa 'getPlayers()'
    const allPlayers = typeof getActivePlayers === 'function' ? getActivePlayers() : getPlayers();

    // 2. Identificamos qui√©nes est√°n en el campo ahora mismo
    // currentPitchPlayers es el objeto { "slot-0": "id_jugador", ... }
    const starterIds = Object.values(currentPitchPlayers);

    allPlayers.forEach(p => {
        // Convertimos el texto "18" o "18.5" a n√∫mero real. Si no tiene, es 0.
        const val = parseFloat(p.valorMercado || 0);
        
        // Si el ID del jugador est√° en la lista de titulares...
        if (starterIds.includes(p.id)) {
            startingValue += val;
        } else {
            // Si no est√° en el campo, asumimos que es suplente/no convocado
            benchValue += val;
        }
    });

    // Funci√≥n peque√±a para formatear bonito (ej: 150,5 M‚Ç¨)
    const formatMoney = (v) => v.toLocaleString('es-ES', { minimumFractionDigits: 0, maximumFractionDigits: 1 }) + ' M‚Ç¨';

    // 3. Crear el mensaje
    const message = `
üí∞ INFORME FINANCIERO

üî∑ Once Inicial:  ${formatMoney(startingValue)}
üî∏ Banquillo:     ${formatMoney(benchValue)}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üèÜ VALOR TOTAL:   ${formatMoney(startingValue + benchValue)}
    `;

    // 4. Mostrar alerta
    alert(message);
}
function updateSquadValueDisplay() {
    // 1. Verificar HTML (Ahora buscamos tambi√©n el de la edad)
    const startersLabel = document.getElementById('value-starters');
    const totalLabel = document.getElementById('value-total');
    const ageLabel = document.getElementById('value-age');
    
    if (!startersLabel || !totalLabel) return;

    // 2. Listas de IDs
    const starterIds = Object.values(currentPitchPlayers || {});
    
    // Suplentes (zona subs-zone)
    const subElements = document.querySelectorAll('#subs-zone [data-player-id]');
    const subIds = Array.from(subElements).map(el => el.getAttribute('data-player-id'));

    // 3. Variables para c√°lculo
    let startingValue = 0;
    let benchValue = 0;
    
    // Variables para Edad
    let totalAgeXI = 0;
    let countXI = 0;

    const allPlayers = getPlayers();

    allPlayers.forEach(p => {
        // --- CALCULO DINERO ---
        let valString = String(p.valorMercado || "0").replace(',', '.');
        let val = parseFloat(valString);
        if (isNaN(val)) val = 0;
        
        const pId = String(p.id);

        // Si es Titular
        if (starterIds.some(id => String(id) === pId)) {
            startingValue += val;
            
            // --- CALCULO EDAD (Solo titulares) ---
            if (p.fechaNacimiento) {
                const age = calculateAgeFromDate(p.fechaNacimiento);
                totalAgeXI += age;
                countXI++;
            }
        }
        // Si es Suplente
        else if (subIds.some(id => String(id) === pId)) {
            benchValue += val;
        }
    });

    // 4. Escribir resultados
    const formatMoney = (v) => v.toLocaleString('es-ES', { minimumFractionDigits: 0, maximumFractionDigits: 1 }) + ' M‚Ç¨';

    // Dinero
    startersLabel.innerText = formatMoney(startingValue);
    totalLabel.innerText = formatMoney(startingValue + benchValue);
    
    // Edad (Media aritm√©tica)
    if (ageLabel) {
        if (countXI > 0) {
            const avgAge = (totalAgeXI / countXI).toFixed(1); // Un decimal (ej: 26.5)
            ageLabel.innerText = avgAge + " a√±os";
        } else {
            ageLabel.innerText = "-";
        }
    }

    // Colores din√°micos
    startersLabel.className = startingValue > 0 ? "font-black text-emerald-600" : "font-black text-gray-400";
}

// Funci√≥n auxiliar para calcular edad exacta
function calculateAgeFromDate(dateString) {
    if (!dateString) return 0;
    const today = new Date();
    const birthDate = new Date(dateString);
    let age = today.getFullYear() - birthDate.getFullYear();
    const m = today.getMonth() - birthDate.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
        age--;
    }
    return age;
}
let currentCaptainId = null;

function toggleCaptain(playerId) {
    // 1. Si ya es capit√°n, se lo quitamos
    if (currentCaptainId === playerId) {
        currentCaptainId = null;
    } else {
        // 2. Si no, lo nombramos nuevo capit√°n
        currentCaptainId = playerId;
    }
    // 3. Repintamos para actualizar iconos
    renderAll(); 
}
function getSquadStats() {
    // 1. Obtener IDs
    const starterIds = Object.values(currentPitchPlayers || {});
    // Buscamos suplentes en la variable global (aseg√∫rate de que currentSubstitutes est√© actualizada)
    // Si no usas la variable global, usamos el DOM como plan B:
    let subIds = currentSubstitutes || [];
    if (subIds.length === 0) {
         const subElements = document.querySelectorAll('#subs-zone [data-player-id]');
         subIds = Array.from(subElements).map(el => el.getAttribute('data-player-id'));
    }

    let startingValue = 0;
    let benchValue = 0;
    let totalAgeXI = 0;
    let countXI = 0;

    const allPlayers = getPlayers();

    allPlayers.forEach(p => {
        let val = parseFloat(String(p.valorMercado || "0").replace(',', '.')) || 0;
        const pId = String(p.id);

        // Titulares
        if (starterIds.some(id => String(id) === pId)) {
            startingValue += val;
            if (p.fechaNacimiento) {
                totalAgeXI += calculateAgeFromDate(p.fechaNacimiento);
                countXI++;
            }
        }
        // Suplentes
        else if (subIds.some(id => String(id) === pId)) {
            benchValue += val;
        }
    });

    const avgAge = countXI > 0 ? (totalAgeXI / countXI).toFixed(1) : "0.0";
    const totalValue = (startingValue + benchValue).toFixed(1);

    // Devolvemos un objeto con los dos datos
    return {
        valorTotal: totalValue, // Ej: "150.5"
        edadMedia: avgAge       // Ej: "24.5"
    };
}
function updateFormationStats() {
    const selector = document.getElementById('formation-select');
    const display = document.getElementById('formation-stats-display');
    
    if (!selector || !display) return;

    const currentFormation = selector.value; // ej: "4-2-3-1"
    const matches = getData('matches') || [];

    // 1. Filtrar partidos jugados con ESTA formaci√≥n
    // (Nota: Los partidos antiguos que no tengan 'formation' guardada no contar√°n)
    const formationMatches = matches.filter(m => m.formation === currentFormation);
    const totalPlayed = formationMatches.length;

    if (totalPlayed === 0) {
        // Si no hay datos, ocultamos o mostramos gris
        display.innerHTML = `<span class="w-2 h-2 rounded-full bg-gray-300"></span><span class="text-gray-400">Sin datos registrados</span>`;
        display.classList.remove('hidden');
        return;
    }

    // 2. Calcular Victorias
    const wins = formationMatches.filter(m => m.outcome === 'victoria').length;
    const winRate = Math.round((wins / totalPlayed) * 100);

    // 3. Decidir color seg√∫n porcentaje
    let colorClass = 'bg-gray-400'; // Por defecto
    let textClass = 'text-gray-500';

    if (winRate >= 60) {
        colorClass = 'bg-emerald-500'; // Verde (Bueno)
        textClass = 'text-emerald-700 font-bold';
    } else if (winRate >= 35) {
        colorClass = 'bg-amber-500';   // Naranja (Regular)
        textClass = 'text-amber-700 font-bold';
    } else {
        colorClass = 'bg-red-500';     // Rojo (Malo)
        textClass = 'text-red-700 font-bold';
    }

    // 4. Mostrar Resultado
    display.classList.remove('hidden');
    display.innerHTML = `
        <span class="w-2 h-2 rounded-full ${colorClass}"></span>
        <span class="${textClass}">${winRate}% Victorias</span>
        <span class="text-gray-400 ml-1">(${wins}/${totalPlayed}P)</span>
    `;
}
function renderFormationStats() {
    const tbody = document.getElementById('formation-stats-body');
    const noData = document.getElementById('formation-no-data');
    
    if (!tbody) return;

    // 1. Obtener partidos
    const matches = getData('matches') || [];
    
    // Si no hay partidos, mostrar aviso
    if (matches.length === 0) {
        tbody.innerHTML = '';
        if(noData) noData.classList.remove('hidden');
        return;
    }
    if(noData) noData.classList.add('hidden');

    // 2. Agrupar datos
    const stats = {};

    matches.forEach(m => {
        // Si es un partido antiguo sin formaci√≥n guardada, lo llamamos 'Desconocido'
        const form = m.formation || 'Desconocido';
        
        if (!stats[form]) {
            stats[form] = { played: 0, win: 0, draw: 0, loss: 0 };
        }

        stats[form].played++;
        
        if (m.outcome === 'victoria') stats[form].win++;
        else if (m.outcome === 'empate') stats[form].draw++;
        else stats[form].loss++; // derrota
    });

    // 3. Convertir a array y ordenar por % de victoria (Win Rate)
    const statsArray = Object.keys(stats).map(key => {
        const s = stats[key];
        const winRate = s.played > 0 ? ((s.win / s.played) * 100) : 0;
        return {
            name: key,
            ...s,
            winRate: winRate
        };
    }).sort((a, b) => b.winRate - a.winRate); // Ordenar: Mejor % primero

    // 4. Generar HTML
    tbody.innerHTML = statsArray.map(item => {
        // Colores para la barra de porcentaje
        let colorClass = 'bg-gray-400';
        let textClass = 'text-gray-600';

        if (item.winRate >= 60) {
            colorClass = 'bg-emerald-500';
            textClass = 'text-emerald-700 font-bold';
        } else if (item.winRate >= 35) {
            colorClass = 'bg-amber-500';
            textClass = 'text-amber-700 font-bold';
        } else {
            colorClass = 'bg-red-500';
            textClass = 'text-red-700 font-bold';
        }

        return `
            <tr class="hover:bg-gray-50 transition-colors">
                <td class="px-4 py-3 font-bold text-gray-800">
                    ${item.name}
                </td>
                <td class="px-4 py-3 text-center font-mono text-gray-600">
                    ${item.played}
                </td>
                <td class="px-4 py-3 text-center font-mono text-emerald-600 bg-emerald-50 rounded-lg">
                    ${item.win}
                </td>
                <td class="px-4 py-3 text-center font-mono text-amber-600">
                    ${item.draw}
                </td>
                <td class="px-4 py-3 text-center font-mono text-red-600">
                    ${item.loss}
                </td>
                <td class="px-4 py-3 text-center">
                    <div class="flex items-center gap-2 justify-end">
                        <div class="w-16 h-1.5 bg-gray-200 rounded-full overflow-hidden">
                            <div class="h-full ${colorClass}" style="width: ${item.winRate}%"></div>
                        </div>
                        <span class="text-xs w-10 text-right ${textClass}">${Math.round(item.winRate)}%</span>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function openMinuteModal(targetId, title) {
    console.log("üîì Abriendo modal minutos para:", targetId);

    const input = document.getElementById(targetId);
    if(!input) return console.error("‚ùå No existe el input oculto con ID:", targetId);

    const modal = document.getElementById('minute-modal');
    if(!modal) return console.error("‚ùå Error: No encuentro el div 'minute-modal'");

    // TRUCO DE CAPAS
    document.body.appendChild(modal); 
    modal.style.zIndex = "99999999"; 

    // Guardamos a qui√©n pertenece este modal y el t√≠tulo
    modal.dataset.targetId = targetId; 
    modal.dataset.title = title; // <--- NUEVO

    // Rellenar datos
    const modalInput = document.getElementById('minute-input-field');
    modalInput.value = input.value;
    
    document.getElementById('minute-modal-title').innerText = title || "Minutos";
    
    // Mostrar
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    modal.style.display = 'flex';
    lockScroll();
    
    setTimeout(() => modalInput.focus(), 100);
}

// 2. FUNCI√ìN DE CIERRE
function closeMinuteModal() {
    const modal = document.getElementById('minute-modal');
    if(modal) {
        modal.classList.add('hidden');
        modal.style.display = 'none';
        unlockScroll();
    }
}

// 3. FUNCI√ìN DE GUARDADO (¬°AQU√ç EST√Å EL DISPARADOR DE ETIQUETAS!)
function saveMinutesFromModal() {
    const modal = document.getElementById('minute-modal');
    const targetId = modal.dataset.targetId; 
    const title = modal.dataset.title || ""; // <--- RECUPERAMOS T√çTULO
    
    if(!targetId) return closeMinuteModal();
    
    const val = document.getElementById('minute-input-field').value.trim();
    
    // 1. GUARDAR EN EL INPUT OCULTO
    const hiddenInput = document.getElementById(targetId);
    if(hiddenInput) hiddenInput.value = val;
    
    // 2. ACTUALIZAR BOT√ìN VISUAL
    const btn = document.getElementById('btn-' + targetId);
    if(btn) {
        const parts = val === '' ? [] : val.split(',').filter(s => s.trim() !== '');
        const count = parts.length;
        
        btn.innerText = count;
        
        // Estilos
        const baseClasses = "w-full h-9 border rounded text-sm font-bold flex items-center justify-center transition-colors ";
        const isRed = title.includes('Roja');
        const isYellow = title.includes('Amarilla');
        
        let colorClass = "bg-indigo-100 text-indigo-700 border-indigo-300 shadow-sm";
        if(isRed) colorClass = "bg-red-100 text-red-700 border-red-300 shadow-sm";
        else if(isYellow) colorClass = "bg-yellow-100 text-yellow-700 border-yellow-300 shadow-sm";

        if (count > 0) {
            btn.className = baseClasses + colorClass;
        } else {
            btn.className = baseClasses + "bg-white text-gray-400 border-gray-300 hover:border-indigo-300 hover:text-indigo-400";
        }

        // --- MAGIA: DISPARAR ETIQUETADO SI ES UN GOL ---
        if (title.includes('Goles') || title.includes('Gol')) {
            if (count > 0) {
                // Cerramos modal minutos y abrimos etiquetador
                closeMinuteModal();
                setTimeout(() => openGoalTagging(targetId, val), 200);
                return; // Salimos para no ejecutar closeMinuteModal dos veces
            } else {
                // Si borraron los goles, limpiar etiquetas
                const typeInput = document.getElementById(targetId + '-types');
                if(typeInput) typeInput.value = '[]';
            }
        }
    }

    closeMinuteModal();
}

// 4. BOTONES R√ÅPIDOS (+45, +90)
function addMinuteToInput(text) {
    const field = document.getElementById('minute-input-field');
    if(!field) return;
    
    const val = field.value.trim();
    if (val === "") {
        field.value = text;
    } else {
        if (!val.endsWith(',') && !val.endsWith(' ')) {
             if (text !== '+') field.value += ', ';
        }
        field.value += text;
    }
    field.focus();
}
/* ========================================================= */
/* üÜï VISUAL TIMELINE GENERATOR                              */
/* ========================================================= */
function renderMatchTimeline(match) {
    // 1. Recolectar Eventos
    let events = [];
    const players = getPlayers();

    match.playerStats.forEach(ps => {
        const p = players.find(pl => pl.id === ps.playerId) || { apodo: '?', apellido: '?' };
        const name = p.apodo || p.apellido;

        // Helper para parsear "15, 45+2"
        const parseEvents = (str, type, icon) => {
            if (!str) return;
            str.split(',').forEach(timeStr => {
                timeStr = timeStr.trim();
                if (!timeStr) return;
                
                // Extraer n√∫mero para la posici√≥n (ej: "45+2" -> 45)
                let minute = parseInt(timeStr);
                if (isNaN(minute)) return;
                
                // Ajuste visual para el tiempo extra
                let position = minute;
                if (minute > 90) position = 92; // Capar al final
                else if (minute > 45 && minute < 50 && timeStr.includes('+')) position = 46; // Descanso

                events.push({
                    minute: minute,
                    displayTime: timeStr,
                    type: type, // 'goal', 'yellow', 'red'
                    icon: icon,
                    player: name,
                    positionPercent: (position / 95) * 100 // Escala sobre 95 min aprox
                });
            });
        };

        parseEvents(ps.detailGoals, 'goal', '‚öΩ');
        parseEvents(ps.detailYellow, 'yellow', 'üü®');
        parseEvents(ps.detailRed, 'red', 'üü•');
    });

    // 2. Ordenar por minuto
    events.sort((a, b) => a.minute - b.minute);

    // 3. Generar HTML
    if (events.length === 0) {
        return `<div class="text-center text-xs text-gray-400 py-4 italic">Sin eventos registrados en la l√≠nea de tiempo.</div>`;
    }

    const markersHtml = events.map(ev => {
        // Estilos seg√∫n tipo para que no se solapen tanto visualmente
        let colorClass = "";
        let borderClass = "border-white";
        let zIndex = "z-10";
        
        if (ev.type === 'goal') { colorClass = "bg-white text-lg -mt-3"; zIndex = "z-20"; }
        else if (ev.type === 'yellow') { colorClass = "text-xs"; }
        else { colorClass = "text-xs"; }

        // Tooltip al hacer hover
        return `
            <div class="absolute transform -translate-x-1/2 flex flex-col items-center group cursor-pointer ${zIndex}" 
                 style="left: ${ev.positionPercent}%; top: -12px;">
                
                <div class="${colorClass} hover:scale-125 transition-transform shadow-sm rounded-full ${borderClass}">
                    ${ev.icon}
                </div>
                
                <div class="h-3 w-px bg-gray-300"></div>

                <div class="absolute bottom-8 opacity-0 group-hover:opacity-100 transition-opacity bg-slate-800 text-white text-[10px] px-2 py-1 rounded whitespace-nowrap z-50 pointer-events-none shadow-lg mb-1">
                    <span class="font-bold">${ev.displayTime}'</span> ${ev.player}
                    <div class="absolute -bottom-1 left-1/2 -translate-x-1/2 w-2 h-2 bg-slate-800 rotate-45"></div>
                </div>
            </div>
        `;
    }).join('');

    return `
        <div class="w-full px-4 py-6 select-none">
            <div class="relative w-full h-1 bg-gray-200 rounded flex items-center">
                <div class="absolute left-0 -ml-1 w-2 h-2 bg-gray-300 rounded-full"></div>
                <div class="absolute left-0 top-3 text-[9px] text-gray-400 font-mono">0'</div>

                <div class="absolute left-[47%] -ml-px w-px h-3 bg-gray-300 -top-1"></div>
                <div class="absolute left-[47%] top-3 -translate-x-1/2 text-[9px] text-gray-400 font-mono">HT</div>

                <div class="absolute right-0 -mr-1 w-2 h-2 bg-gray-300 rounded-full"></div>
                <div class="absolute right-0 top-3 text-[9px] text-gray-400 font-mono">90'</div>

                ${markersHtml}
            </div>
        </div>
    `;
}
/* --- HTML DEL MODAL DE ETIQUETAS --- */
function ensureGoalTagModal() {
    if (document.getElementById('goal-tag-modal')) return;

    const modal = document.createElement('div');
    modal.id = 'goal-tag-modal';
    modal.className = "fixed inset-0 bg-black/80 hidden z-[10000] items-center justify-center backdrop-blur-sm";
    modal.innerHTML = `
        <div class="bg-white rounded-xl w-full max-w-md shadow-2xl overflow-hidden m-4 flex flex-col max-h-[90vh]">
            <div class="bg-slate-900 text-white p-4 font-bold text-center border-b border-slate-700">
                üè∑Ô∏è ETIQUETAR GOLES
            </div>
            <div id="goal-tag-content" class="p-4 overflow-y-auto flex-1 space-y-4 bg-gray-50">
                </div>
            <div class="p-4 bg-white border-t border-gray-200 flex justify-end gap-3">
                <button onclick="closeGoalTagModal()" class="px-4 py-2 text-gray-500 font-bold hover:bg-gray-100 rounded-lg">Cancelar</button>
                <button onclick="saveGoalTags()" class="px-6 py-2 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-lg shadow-lg">GUARDAR ETIQUETAS</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}
// B. ABRIR ETIQUETADOR
let currentTaggingGoalId = null;

function openGoalTagging(goalInputId, minutesStr) {
    currentTaggingGoalId = goalInputId; 
    ensureGoalTagModal();

    const minutes = minutesStr.split(',').map(s => s.trim()).filter(s => s !== '');
    const container = document.getElementById('goal-tag-content');
    container.innerHTML = '';

    // Recuperar etiquetas existentes
    const typeInput = document.getElementById(goalInputId + '-types');
    let existingTags = [];
    try { existingTags = JSON.parse(typeInput.value) || []; } catch(e) {}

    // Generar Fichas
    minutes.forEach((min, index) => {
        const savedData = existingTags[index] || {};
        const selectedTags = savedData.tags || [];

        // --- LISTA DE ETIQUETAS ACTUALIZADA ---
        const tagsList = [
            'Pie derecho', 
            'Pie izquierdo', 
            'Cabeza', 
            'Chilena', 
            'Volea', 
            'Tac√≥n',           // <--- NUEVA
            'Exterior',
            'Vaselina',
            'Fuera del √°rea',  // <--- NUEVA
            'Bal√≥n parado', 
            'Ol√≠mpico', 
            'Corner', 
            'Falta directa', 
            'Penalti'
        ];
        
        const tagsHtml = tagsList.map(tag => {
            const isChecked = selectedTags.includes(tag) ? 'checked' : '';
            return `
                <label class="flex items-center space-x-3 bg-white border border-gray-200 p-3 rounded-lg hover:bg-indigo-50 hover:border-indigo-200 cursor-pointer transition-all shadow-sm">
                    <input type="checkbox" value="${tag}" ${isChecked} class="form-checkbox h-5 w-5 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500 goal-tag-check-${index}">
                    <span class="text-xs font-bold text-gray-700 uppercase tracking-wide">${tag}</span>
                </label>
            `;
        }).join('');

        const card = `
            <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-5 relative mt-4">
                <div class="absolute -top-3 left-4 bg-indigo-600 text-white text-xs font-black px-3 py-1 rounded-full shadow-md tracking-wider border-2 border-white">
                    GOL ${index + 1} ‚Ä¢ MINUTO ${min}'
                </div>
                <div class="mt-3 grid grid-cols-2 gap-3">
                    ${tagsHtml}
                </div>
            </div>
        `;
        container.innerHTML += card;
    });

    const modal = document.getElementById('goal-tag-modal');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    lockScroll();
}

// C. CERRAR
function closeGoalTagModal() {
    const modal = document.getElementById('goal-tag-modal');
    if(modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        unlockScroll();
    }
}

// D. GUARDAR JSON
function saveGoalTags() {
    if (!currentTaggingGoalId) return;

    const goalInput = document.getElementById(currentTaggingGoalId);
    const minutes = goalInput.value.split(',').map(s => s.trim()).filter(s => s !== '');
    
    const finalData = [];

    minutes.forEach((min, index) => {
        const checks = document.querySelectorAll(`.goal-tag-check-${index}:checked`);
        const tags = Array.from(checks).map(c => c.value);
        
        finalData.push({
            minute: min,
            tags: tags
        });
    });

    const typeInput = document.getElementById(currentTaggingGoalId + '-types');
    if (typeInput) {
        typeInput.value = JSON.stringify(finalData);
    }
    closeGoalTagModal();
}
/* ========================================================= */
/* üìä AN√ÅLISIS DE TIPOS DE GOL (M√ìDULO DE ESTAD√çSTICAS)      */
/* ========================================================= */
function renderGoalAnalysis() {
    const matches = getData('matches');
    
    // 1. AGREGAR DATOS
    let tagCounts = {};
    let totalTaggedGoals = 0;

    matches.forEach(m => {
        m.playerStats.forEach(ps => {
            // Verificamos si tiene etiquetas guardadas
            if (ps.detailGoalTypes && Array.isArray(ps.detailGoalTypes)) {
                ps.detailGoalTypes.forEach(evt => {
                    if (evt.tags && Array.isArray(evt.tags)) {
                        evt.tags.forEach(tag => {
                            tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                            totalTaggedGoals++;
                        });
                    }
                });
            }
        });
    });

    // 2. ORDENAR DE MAYOR A MENOR
    // Convertimos el objeto en array para ordenar
    const sortedTags = Object.entries(tagCounts)
        .sort(([, a], [, b]) => b - a); // Orden descendente

    // 3. GENERAR HTML
    if (sortedTags.length === 0) {
        return `
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 flex flex-col items-center justify-center text-center h-full">
                <div class="text-4xl mb-2">ü§∑‚Äç‚ôÇÔ∏è</div>
                <h3 class="font-bold text-gray-700">Sin datos de goles</h3>
                <p class="text-xs text-gray-400 mt-1">Etiqueta tus goles al editar partidos para ver el an√°lisis aqu√≠.</p>
            </div>
        `;
    }

    // Mapeamos iconos para darle un toque visual
    const icons = {
        'Pie derecho': 'ü¶∂üëâ', 'Pie izquierdo': 'üëàü¶∂', 'Cabeza': 'üë§', 
        'Chilena': 'ü§∏', 'Volea': 'üöÄ', 'Tac√≥n': 'üë†','Exterior': 'üëü‚Ü™Ô∏è',  
        'Vaselina': 'üåà','Fuera del √°rea': 'üéØ', 'Bal√≥n parado': '‚è≥', 'Ol√≠mpico': 'üö©', 
        'Corner': 'üìê', 'Falta directa': 'üß±', 'Penalti': 'ü•Ö'
    };

    const barsHtml = sortedTags.map(([tag, count]) => {
        // Calcular porcentaje respecto al total de etiquetas (para la barra)
        // Usamos Math.max(..., 5) para que siempre se vea un poquito de barra
        const percentage = Math.round((count / totalTaggedGoals) * 100);
        const icon = icons[tag] || '‚öΩ';
        
        // Color din√°mico seg√∫n porcentaje
        let barColor = 'bg-indigo-500';
        if (percentage > 40) barColor = 'bg-emerald-500';
        else if (percentage < 10) barColor = 'bg-gray-400';

        return `
            <div class="mb-3 last:mb-0">
                <div class="flex justify-between items-end mb-1">
                    <span class="text-sm font-bold text-gray-700 flex items-center gap-2">
                        <span class="text-base">${icon}</span> ${tag}
                    </span>
                    <div class="text-right">
                        <span class="text-sm font-black text-indigo-900">${count}</span>
                        <span class="text-[10px] text-gray-400 ml-1">(${percentage}%)</span>
                    </div>
                </div>
                <div class="w-full bg-gray-100 rounded-full h-2.5 overflow-hidden">
                    <div class="${barColor} h-2.5 rounded-full transition-all duration-1000" style="width: ${percentage}%"></div>
                </div>
            </div>
        `;
    }).join('');

    return `
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="bg-indigo-900 text-white px-4 py-3 border-b border-indigo-800 flex justify-between items-center">
                <h3 class="font-bold text-sm uppercase tracking-wider">üî¨ ADN Goleador</h3>
                <span class="bg-indigo-700 text-[10px] px-2 py-0.5 rounded-full">${totalTaggedGoals} Registros</span>
            </div>
            <div class="p-5">
                ${barsHtml}
            </div>
        </div>
    `;
}
/* ========================================================= */
/* üì∏ GENERADOR DE FICHA DE PARTIDO (CORREGIDO Y ROBUSTO)    */
/* ========================================================= */

async function downloadMatchCard(matchId) {
    const matches = getData('matches');
    const match = matches.find(m => m.id === matchId);
    if (!match) return;

    // Notificar al usuario que espere un momento
    const originalText = document.body.style.cursor;
    document.body.style.cursor = 'wait';

    // 1. Crear contenedor temporal (visible pero detr√°s de todo)
    // Esto evita errores de renderizado que ocurren cuando est√° fuera de pantalla (-9999px)
    const container = document.createElement('div');
    container.id = "temp-capture-container";
    container.style.position = 'fixed';
    container.style.top = '0';
    container.style.left = '0';
    container.style.zIndex = '-50'; // Detr√°s de todo
    container.style.width = '600px'; 
    container.style.height = '800px';
    container.style.overflow = 'hidden';
    document.body.appendChild(container);

    // 2. Generar HTML
    container.innerHTML = generateMatchCardHTML(match);

    // 3. Esperar un poco para asegurar que las im√°genes y fuentes carguen
    await new Promise(resolve => setTimeout(resolve, 500));

    try {
        // 4. Capturar
        const canvas = await html2canvas(container.querySelector('#match-share-card'), {
            scale: 2, 
            backgroundColor: '#0f172a',
            useCORS: true, // Intentar cargar im√°genes externas
            allowTaint: true,
            logging: false
        });

        // 5. Descargar
        const image = canvas.toDataURL("image/png");
        const link = document.createElement('a');
        link.download = `MatchReport_RealMadrid_vs_${match.opponent.replace(/\s+/g, '')}.png`;
        link.href = image;
        link.click();

    } catch (err) {
        console.error("Error generando imagen:", err);
        alert("No se pudo generar la imagen. Int√©ntalo de nuevo.");
    } finally {
        // 6. Limpieza
        document.body.removeChild(container);
        document.body.style.cursor = originalText;
    }
}

async function generateMatchdayPoster(eventId) {
    const event = calendarEvents.find(e => e.id === eventId);
    if (!event) return;

    // Buscar un jugador destacado (aleatorio de los activos)
    const players = getActivePlayers().filter(p => p.posicion !== 'entrenador');
    const featuredPlayer = players[Math.floor(Math.random() * players.length)];
    
    // Formatos de fecha
    const dateStr = event.start.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' }).toUpperCase();
    const timeStr = event.start.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });

    // Notificar
    const originalText = document.body.style.cursor;
    document.body.style.cursor = 'wait';
    if(typeof showToast === 'function') showToast("üé® Dise√±ando cartel...", "info");

    // Contenedor temporal
    const container = document.createElement('div');
    container.id = "temp-matchday-container";
    container.style.position = 'fixed';
    container.style.top = '0';
    container.style.left = '0';
    container.style.zIndex = '-50';
    container.style.width = '600px';
    container.style.height = '1066px'; // 9:16 ratio (Story)
    container.style.overflow = 'hidden';
    document.body.appendChild(container);

    // Proxy imagen jugador
    let imgUrl = featuredPlayer.foto;
    try {
        const proxyUrl = `https://api.allorigins.win/raw?url=${encodeURIComponent(featuredPlayer.foto)}`;
        const response = await fetch(proxyUrl);
        if (response.ok) {
            const blob = await response.blob();
            imgUrl = await new Promise((resolve) => {
                const reader = new FileReader();
                reader.onloadend = () => resolve(reader.result);
                reader.readAsDataURL(blob);
            });
        }
    } catch (e) { console.warn("Proxy fall√≥", e); }

    container.innerHTML = `
        <div id="matchday-poster" style="width: 600px; height: 1066px; background: #0f172a; position: relative; font-family: 'Inter', sans-serif; color: white; display: flex; flex-direction: column; overflow: hidden;">
            <!-- Fondo -->
            <div style="position: absolute; inset: 0; background: radial-gradient(circle at 100% 0%, #1e3a8a 0%, #0f172a 50%);"></div>
            <div style="position: absolute; top: -200px; left: -200px; width: 600px; height: 600px; background: #3b82f6; filter: blur(150px); opacity: 0.3;"></div>
            
            <!-- Texto MATCHDAY -->
            <div style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-90deg); font-size: 180px; font-weight: 900; color: rgba(255,255,255,0.03); white-space: nowrap; pointer-events: none;">MATCHDAY</div>

            <!-- Contenido -->
            <div style="z-index: 10; padding: 60px 40px; height: 100%; display: flex; flex-direction: column; justify-content: space-between;">
                
                <!-- Header -->
                <div style="border-left: 6px solid #fbbf24; padding-left: 20px;">
                    <div style="font-size: 24px; font-weight: bold; color: #fbbf24; text-transform: uppercase; letter-spacing: 2px;">${event.competition || 'Partido Oficial'}</div>
                    <div style="font-size: 16px; color: #94a3b8; margin-top: 5px;">${event.location || 'Estadio'}</div>
                </div>

                <!-- Jugador -->
                <div style="position: absolute; top: 20%; right: -50px; width: 500px; height: 500px; border-radius: 50%; border: 2px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center;">
                     <div style="width: 450px; height: 450px; border-radius: 50%; overflow: hidden; border: 10px solid #fbbf24; box-shadow: 0 0 50px rgba(251, 191, 36, 0.2); background: #000;">
                        <img src="${imgUrl}" style="width: 100%; height: 100%; object-fit: cover; object-position: top;">
                     </div>
                </div>

                <!-- Info Partido -->
                <div style="margin-top: auto;">
                    <div style="font-size: 20px; font-weight: bold; color: #94a3b8; margin-bottom: 10px;">PR√ìXIMO PARTIDO</div>
                    <div style="font-size: 60px; font-weight: 900; line-height: 1; margin-bottom: 20px; text-transform: uppercase;">
                        <span style="color: white;">REAL MADRID</span><br>
                        <span style="color: #fbbf24;">VS</span><br>
                        <span style="color: white;">${event.opponent}</span>
                    </div>
                    <div style="background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); padding: 20px; border-radius: 16px; display: inline-flex; gap: 30px; border: 1px solid rgba(255,255,255,0.1);">
                        <div>
                            <div style="font-size: 12px; color: #94a3b8; font-weight: bold; uppercase;">FECHA</div>
                            <div style="font-size: 18px; font-weight: bold;">${dateStr}</div>
                        </div>
                        <div style="width: 1px; background: rgba(255,255,255,0.2);"></div>
                        <div>
                            <div style="font-size: 12px; color: #94a3b8; font-weight: bold; uppercase;">HORA</div>
                            <div style="font-size: 18px; font-weight: bold;">${timeStr}</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;

    await new Promise(resolve => setTimeout(resolve, 800));

    try {
        const canvas = await html2canvas(container.querySelector('#matchday-poster'), { 
            scale: 2, 
            backgroundColor: null, 
            useCORS: true, 
            logging: false,
            onclone: (doc) => { doc.querySelectorAll('style').forEach(s => s.remove()); }
        });
        const link = document.createElement('a');
        link.download = `Matchday_${event.opponent.replace(/\s+/g, '')}.png`;
        link.href = canvas.toDataURL("image/png");
        link.click();
        if(typeof showToast === 'function') showToast("‚úÖ Cartel guardado", "success");
    } catch (err) { console.error(err); alert("Error generando cartel."); } 
    finally { document.body.removeChild(container); document.body.style.cursor = originalText; }
}

// Helper para obtener nombre del MVP
function getMvpName(playerId) {
    if(!playerId) return "N/A";
    const players = getPlayers();
    const p = players.find(pl => pl.id === playerId);
    return p ? (p.apodo || p.apellido) : "Desconocido";
}

// FUNCI√ìN DE DISE√ëO (Simplificada para compatibilidad)
function generateMatchCardHTML(match) {
    const players = getPlayers();
    const [homeGoals, awayGoals] = match.result.split('-').map(Number);
    const isWin = homeGoals > awayGoals;
    // Usamos colores hex directos para evitar problemas con clases de Tailwind no cargadas
    const resultColor = isWin ? '#34d399' : (homeGoals === awayGoals ? '#fbbf24' : '#f87171');

    // --- GENERAR LISTA DE JUGADORES CON NOTAS ---
    let playersHtml = '';
    if (match.playerStats) {
        // Filtramos los que jugaron o tienen nota
        const activeStats = match.playerStats.filter(ps => ps.played || ps.minutes > 0 || ps.rating);
        
        // Ordenamos: Titulares primero, luego por nota
        activeStats.sort((a, b) => {
            if (a.isStarter && !b.isStarter) return -1;
            if (!a.isStarter && b.isStarter) return 1;
            return (b.rating || 0) - (a.rating || 0);
        });

        // Limitamos para que quepa en la imagen si son muchos (ej: max 16)
        const displayStats = activeStats.slice(0, 16);

        playersHtml = displayStats.map(ps => {
            const p = players.find(pl => pl.id === ps.playerId);
            const name = p ? (p.apodo || p.apellido) : '???';
            const rating = ps.rating || '-';
            
            // Color de la nota
            let ratingColor = '#9ca3af'; // Gris
            if (rating >= 8) ratingColor = '#34d399'; // Verde
            else if (rating >= 6) ratingColor = '#60a5fa'; // Azul
            else if (rating >= 5) ratingColor = '#fbbf24'; // Amarillo
            else if (rating !== '-') ratingColor = '#f87171'; // Rojo

            // Iconos de rendimiento
            let icons = '';
            if (ps.goals > 0) icons += `‚öΩ${ps.goals > 1 ? 'x'+ps.goals : ''} `;
            if (ps.assists > 0) icons += `üëü${ps.assists > 1 ? 'x'+ps.assists : ''} `;
            if (ps.redCards > 0) icons += `üü• `;
            else if (ps.yellowCards > 0) icons += `üü® `;
            if (match.mvp === ps.playerId) icons += `üëë `;

            return `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 12px;">
                    <div style="display: flex; align-items: center; gap: 8px; overflow: hidden;">
                        <span style="color: ${ps.isStarter ? '#e2e8f0' : '#94a3b8'}; font-weight: ${ps.isStarter ? 'bold' : 'normal'}; white-space: nowrap;">${name}</span>
                        <span style="font-size: 10px;">${icons}</span>
                    </div>
                    <div style="font-weight: 900; color: ${ratingColor}; font-size: 14px;">${rating}</div>
                </div>
            `;
        }).join('');
    }

    // MVP Info
    const mvpName = getMvpName(match.mvp);
    const mvpPlayer = players.find(p => p.id === match.mvp);
    const mvpImg = mvpPlayer?.foto || 'https://via.placeholder.com/60';

    // HTML CON ESTILOS INLINE (M√ÅS SEGURO PARA HTML2CANVAS)
    return `
        <div id="match-share-card" style="width: 600px; height: 800px; background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%); font-family: sans-serif; position: relative; overflow: hidden; display: flex; flex-direction: column;">
            
            <div style="width: 100%; height: 8px; background: linear-gradient(90deg, #d97706, #fbbf24, #d97706);"></div>

            <div style="text-align: center; padding-top: 30px; margin-bottom: 10px;">
                <div style="color: #fbbf24; text-transform: uppercase; letter-spacing: 3px; font-weight: bold; font-size: 12px; margin-bottom: 4px;">${match.competition}</div>
                <div style="color: #94a3b8; font-size: 10px; text-transform: uppercase; letter-spacing: 1px;">${match.round}</div>
            </div>

            <div style="display: flex; justify-content: center; align-items: center; margin: 10px 0; padding: 0 20px;">
                <div style="width: 35%; text-align: center;">
                    <div style="font-size: 24px; font-weight: 900; color: white; text-shadow: 0 4px 6px rgba(0,0,0,0.3);">REAL MADRID</div>
                </div>
                <div style="width: 30%; text-align: center;">
                    <div style="background: rgba(30, 41, 59, 0.6); padding: 10px 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); display: inline-block;">
                        <div style="font-size: 48px; font-weight: 900; color: ${resultColor}; line-height: 1;">${match.result}</div>
                    </div>
                </div>
                <div style="width: 35%; text-align: center; opacity: 0.9;">
                    <div style="font-size: 18px; font-weight: bold; color: white;">${match.opponent}</div>
                </div>
            </div>

            <div style="margin: 10px 30px; background: rgba(30, 41, 59, 0.4); border-radius: 16px; padding: 20px; border: 1px solid rgba(255,255,255,0.05); flex: 1; display: flex; flex-direction: column;">
                <div style="text-align: center; color: rgba(251, 191, 36, 0.8); font-size: 11px; font-weight: bold; text-transform: uppercase; letter-spacing: 2px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px; margin-bottom: 8px;">
                    Notas del Partido
                </div>
                <div style="flex: 1; overflow: hidden;"> <!-- Evitar scrollbars en la imagen -->
                    ${playersHtml}
                </div>
            </div>

            ${match.mvp ? `
            <div style="margin: 0 30px 20px 30px; display: flex; align-items: center; background: linear-gradient(90deg, rgba(251, 191, 36, 0.1) 0%, transparent 100%); border-radius: 12px; padding: 10px; border-left: 3px solid #fbbf24;">
                <div style="margin-right: 15px; position: relative;">
                    <div style="width: 48px; height: 48px; border-radius: 50%; background: #fbbf24; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 2px solid #fbbf24;">
                        <img src="${mvpImg}" crossorigin="anonymous" style="width: 100%; height: 100%; object-fit: cover;">
                    </div>
                </div>
                <div>
                    <div style="color: #fbbf24; font-size: 9px; text-transform: uppercase; font-weight: bold; letter-spacing: 1px;">MVP del Partido</div>
                    <div style="font-size: 18px; font-weight: 900; color: white;">${mvpName}</div>
                </div>
            </div>
            ` : ''}

            <div style="text-align: center; padding-bottom: 15px; color: rgba(255,255,255,0.3); font-size: 9px; text-transform: uppercase; letter-spacing: 2px;">
                Reporte Oficial de Partido
            </div>
        </div>
    `;
}
/* ========================================================= */
/* üèÖ SISTEMA DE BADGES (LOGROS EVOLUTIVOS)                  */
/* ========================================================= */

function getPlayerBadgesHTML(playerId) {
    const matches = getData('matches');
    const players = getPlayers();
    const player = players.find(p => p.id === playerId);
    
    if (!player) return '';

    // 1. CALCULAR ESTAD√çSTICAS TOTALES
    let totalGoals = 0;
    let totalAssists = 0;
    let totalMatches = 0;
    let totalMvps = 0;
    let totalYellows = 0;

    matches.forEach(m => {
        const stats = m.playerStats.find(ps => ps.playerId === playerId);
        if (stats && (stats.minutes > 0 || stats.played)) {
            totalMatches++;
            totalGoals += (stats.goals || 0);
            totalAssists += (stats.assists || 0);
            totalYellows += (stats.yellowCards || 0);
        }
        if (m.mvp === playerId) totalMvps++;
    });

    // 2. DEFINIR REGLAS Y NIVELES
    // [Bronce, Plata, Oro, Diamante]
    const criteria = [
        {
            id: 'goals',
            name: 'Depredador',
            icon: '‚öΩ',
            count: totalGoals,
            levels: [5, 10, 20, 30], // Umbrales
            desc: 'Goles marcados'
        },
        {
            id: 'assists',
            name: 'El Mago',
            icon: 'üé©',
            count: totalAssists,
            levels: [5, 10, 15, 25],
            desc: 'Asistencias dadas'
        },
        {
            id: 'matches',
            name: 'Veterano',
            icon: 'üõ°Ô∏è',
            count: totalMatches,
            levels: [5, 10, 20, 30],
            desc: 'Partidos jugados'
        },
        {
            id: 'mvp',
            name: 'Gal√°ctico',
            icon: '‚≠ê',
            count: totalMvps,
            levels: [2, 5, 8, 12],
            desc: 'MVPs conseguidos'
        }
    ];

    // 3. GENERAR HTML DE LAS MEDALLAS
    let badgesHtml = '';

    criteria.forEach(c => {
        // Encontrar el nivel m√°s alto alcanzado
        let levelIdx = -1;
        c.levels.forEach((threshold, idx) => {
            if (c.count >= threshold) levelIdx = idx;
        });

        if (levelIdx >= 0) {
            // Configuraci√≥n visual seg√∫n nivel
            const configs = [
                { color: 'bg-orange-100 text-orange-800 border-orange-200', label: 'BRONCE' },
                { color: 'bg-slate-100 text-slate-600 border-slate-300', label: 'PLATA' },
                { color: 'bg-yellow-100 text-yellow-700 border-yellow-300', label: 'ORO' },
                { color: 'bg-cyan-50 text-cyan-700 border-cyan-300 shadow-[0_0_10px_rgba(34,211,238,0.4)]', label: 'DIAMANTE' }
            ];

            const style = configs[levelIdx];
            
            // Efecto especial para Diamante
            const diamondEffect = levelIdx === 3 ? 'background-image: linear-gradient(135deg, #ecfeff 0%, #cffafe 100%); border: 1px solid #67e8f9;' : '';

            badgesHtml += `
                <div class="flex flex-col items-center p-2 rounded-lg border ${style.color} transition-transform hover:scale-105" style="${diamondEffect}" title="${c.desc}: ${c.count}">
                    <div class="text-2xl mb-1 filter drop-shadow-sm">${c.icon}</div>
                    <div class="text-[10px] font-black uppercase tracking-widest opacity-70">${style.label}</div>
                    <div class="text-xs font-bold leading-tight">${c.name}</div>
                    <div class="text-[9px] mt-1 bg-white/50 px-1.5 rounded-full font-mono">${c.count}</div>
                </div>
            `;
        }
    });

    // BADGE ESPECIAL: FAIR PLAY (Si ha jugado mucho y pega poco)
    if (totalMatches >= 10 && totalYellows === 0) {
        badgesHtml += `
            <div class="flex flex-col items-center p-2 rounded-lg border bg-green-50 text-green-700 border-green-200 hover:scale-105">
                <div class="text-2xl mb-1">ü§ù</div>
                <div class="text-[10px] font-black uppercase tracking-widest opacity-70">HONOR</div>
                <div class="text-xs font-bold leading-tight">Fair Play</div>
                <div class="text-[9px] mt-1 bg-white/50 px-1.5 rounded-full font-mono">0 Tarj</div>
            </div>
        `;
    }

    if (badgesHtml === '') {
        return `<div class="col-span-full text-center text-xs text-gray-400 italic py-2">
            A√∫n no ha desbloqueado logros. ¬°A jugar!
        </div>`;
    }

    return `<div class="grid grid-cols-4 gap-2">${badgesHtml}</div>`;
}

// ==========================================
// 5. BUSCADOR AVANZADO (DATA MINING)
// ==========================================
function openAdvancedSearch() {
    const modal = document.getElementById('advanced-search-modal');
    const compSelect = document.getElementById('adv-search-comp');
    const playerSelect = document.getElementById('adv-search-player');
    
    // Populate Comps
    compSelect.innerHTML = '<option value="">Todas las competiciones</option>' + 
        Object.keys(COMPETICIONES_ACTUALES).map(c => `<option value="${c}">${c}</option>`).join('');
        
    // Populate Players
    const players = getPlayers().sort((a,b) => a.nombre.localeCompare(b.nombre));
    playerSelect.innerHTML = '<option value="">-- Seleccionar Jugador (Opcional) --</option>' + 
        players.map(p => `<option value="${p.id}">${p.nombre} ${p.apellido}</option>`).join('');

    modal.classList.remove('hidden');
    modal.classList.add('flex');
    modal.classList.add('active');
    lockScroll();
}

function closeAdvancedSearch() {
    const modal = document.getElementById('advanced-search-modal');
    modal.classList.remove('active');
    modal.classList.add('hidden');
    modal.classList.remove('flex');
    unlockScroll();
}

function executeAdvancedSearch() {
    const comp = document.getElementById('adv-search-comp').value;
    const rival = document.getElementById('adv-search-rival').value.toLowerCase();
    const playerId = document.getElementById('adv-search-player').value;
    const condition = document.getElementById('adv-search-condition').value;
    const outcome = document.getElementById('adv-search-outcome').value;
    const venue = document.getElementById('adv-search-venue').value;
    const cleanSheet = document.getElementById('adv-search-cleansheet').value;

    let matches = getData('matches');

    matches = matches.filter(m => {
        // Basic Filters
        if (comp && m.competition !== comp) return false;
        if (rival && !m.opponent.toLowerCase().includes(rival)) return false;
        if (outcome && m.outcome !== outcome) return false;
        if (venue && m.venue !== venue) return false;

        // Clean Sheet
        if (cleanSheet) {
            const parts = m.result.replace('*','').split('-').map(Number);
            const goalsAgainst = m.venue === 'local' ? parts[1] : parts[0];
            if (cleanSheet === 'yes' && goalsAgainst > 0) return false;
            if (cleanSheet === 'no' && goalsAgainst === 0) return false;
        }

        // Player Filters
        if (playerId) {
            const ps = m.playerStats.find(s => s.playerId === playerId);
            if (!ps) return false; // Player not in match data at all

            if (condition === 'played' && !ps.played && ps.minutes === 0) return false;
            if (condition === 'starter' && !ps.isStarter) return false;
            if (condition === 'sub' && ps.isStarter) return false; // Must be sub
            if (condition === 'sub' && (!ps.played && ps.minutes === 0)) return false; // Must have played
            if (condition === 'goal' && (!ps.goals || ps.goals === 0)) return false;
            if (condition === 'assist' && (!ps.assists || ps.assists === 0)) return false;
            if (condition === 'mvp' && m.mvp !== playerId) return false;
            if (condition === 'yellow' && (!ps.yellowCards || ps.yellowCards === 0)) return false;
            if (condition === 'red' && (!ps.redCards || ps.redCards === 0)) return false;
            if (condition === 'rating_8' && (!ps.rating || parseFloat(ps.rating) < 8)) return false;
            if (condition === 'rating_9' && (!ps.rating || parseFloat(ps.rating) < 9)) return false;
        }

        return true;
    });

    closeAdvancedSearch();
    renderMatches(matches); // Render filtered list
    
    if(typeof showToast === 'function') showToast(`üîç Encontrados ${matches.length} partidos`, 'info');
}

// ==========================================
// 6. BOLA DE CRISTAL (SIMULADOR)
// ==========================================
function showCrystalBall() {
    const matches = getData('matches');
    
    // Identify League
    let leagueName = null;
    let totalRounds = 38; // Default
    
    if (COMPETICIONES_ACTUALES['Liga EA Sports']) { leagueName = 'Liga EA Sports'; totalRounds = 38; }
    else if (COMPETICIONES_ACTUALES['Liga F']) { leagueName = 'Liga F'; totalRounds = 30; }
    
    if (!leagueName) return alert("No se detecta una liga activa para simular.");

    const leagueMatches = matches.filter(m => m.competition === leagueName);
    const played = leagueMatches.length;

    if (played === 0) return alert("Juega al menos un partido de liga para simular.");

    let points = 0;
    let gf = 0;
    let ga = 0;

    leagueMatches.forEach(m => {
        if (m.outcome === 'victoria') points += 3;
        else if (m.outcome === 'empate') points += 1;
        
        const parts = m.result.replace('*','').split('-').map(Number);
        if (m.venue === 'local') { gf += parts[0]; ga += parts[1]; }
        else { gf += parts[1]; ga += parts[0]; }
    });

    const ppg = points / played;
    const gfpg = gf / played;
    const gapg = ga / played;

    const projectedPoints = Math.round(points + (ppg * (totalRounds - played)));
    const projectedGF = Math.round(gf + (gfpg * (totalRounds - played)));
    const projectedGA = Math.round(ga + (gapg * (totalRounds - played)));

    // Create Modal HTML dynamically
    const modal = document.createElement('div');
    modal.className = "fixed inset-0 bg-black/80 z-[10000] flex items-center justify-center backdrop-blur-sm animate-in fade-in";
    modal.innerHTML = `
        <div class="bg-gradient-to-br from-indigo-900 to-purple-900 text-white rounded-2xl w-full max-w-md shadow-2xl overflow-hidden border border-purple-500/30 relative m-4">
            <div class="absolute top-0 left-0 w-full h-full overflow-hidden pointer-events-none">
                <div class="absolute top-[-50%] left-[-50%] w-[200%] h-[200%] bg-[radial-gradient(circle,rgba(255,255,255,0.1)_0%,transparent_60%)] animate-spin-slow"></div>
            </div>
            
            <div class="p-8 text-center relative z-10">
                <div class="text-6xl mb-4 animate-bounce">üîÆ</div>
                <h3 class="text-2xl font-bold mb-2 text-transparent bg-clip-text bg-gradient-to-r from-purple-200 to-pink-200">La Bola de Cristal</h3>
                <p class="text-purple-200 text-sm mb-6">Proyecci√≥n basada en ${played} partidos de ${leagueName}</p>
                
                <div class="grid grid-cols-3 gap-4 mb-6">
                    <div class="bg-white/10 rounded-xl p-3 border border-white/10">
                        <div class="text-xs text-purple-300 uppercase font-bold">Puntos</div>
                        <div class="text-3xl font-black text-white">${projectedPoints}</div>
                        <div class="text-[10px] text-purple-400">Actual: ${points}</div>
                    </div>
                    <div class="bg-white/10 rounded-xl p-3 border border-white/10">
                        <div class="text-xs text-purple-300 uppercase font-bold">Goles F.</div>
                        <div class="text-3xl font-black text-green-400">${projectedGF}</div>
                        <div class="text-[10px] text-purple-400">Media: ${gfpg.toFixed(1)}</div>
                    </div>
                    <div class="bg-white/10 rounded-xl p-3 border border-white/10">
                        <div class="text-xs text-purple-300 uppercase font-bold">Goles C.</div>
                        <div class="text-3xl font-black text-red-400">${projectedGA}</div>
                        <div class="text-[10px] text-purple-400">Media: ${gapg.toFixed(1)}</div>
                    </div>
                </div>

                <div class="bg-black/20 rounded-lg p-3 text-sm text-purple-100 italic border border-white/5">
                    "Al ritmo actual (${ppg.toFixed(2)} pts/partido), acabar√°s la temporada con <strong class="text-white">${projectedPoints} puntos</strong>."
                </div>
                
                <button onclick="unlockScroll(); this.closest('.fixed').remove()" class="mt-6 px-6 py-2 bg-white text-purple-900 font-bold rounded-full hover:bg-purple-100 transition shadow-lg">
                    Cerrar Predicci√≥n
                </button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
    lockScroll();
}
// =========================================
// TOUR GUIADO (SHEPHERD.JS)
// =========================================

function startTour() {
    const tour = new Shepherd.Tour({
        useModalOverlay: true,
        defaultStepOptions: {
            classes: 'shadow-2xl',
            scrollTo: { behavior: 'smooth', block: 'center' }
        }
    });

    // Pasos del tour
    tour.addStep({
        title: '¬°Bienvenido a tu App de Notas!',
        text: 'Este r√°pido tour te mostrar√° las funciones principales. Puedes saltarlo en cualquier momento.',
        attachTo: { element: '#header-subtitle', on: 'bottom' },
        buttons: [
            { text: 'Saltar', action: tour.cancel, classes: 'shepherd-button-secondary' },
            { text: 'Siguiente', action: tour.next }
        ]
    });
    tour.addStep({
        title: 'Tu Plantilla',
        text: 'Aqu√≠ gestionas el estado de tus jugadores: si est√°n activos, inactivos o cedidos.',
        attachTo: { element: '#tab-plantilla', on: 'bottom' },
        buttons: [{ text: 'Siguiente', action: tour.next }]
    });
    tour.addStep({
        title: 'Calendario y Partidos',
        text: 'Desde "Calendario" podr√°s ver los pr√≥ximos partidos. Haz clic en un partido pasado para registrarlo.',
        attachTo: { element: '#tab-calendario', on: 'bottom' },
        buttons: [{ text: 'Siguiente', action: tour.next }]
    });
     tour.addStep({
        title: 'Registrar un Partido',
        text: 'Una vez seleccionado un partido del calendario, aqu√≠ es donde introduces las estad√≠sticas y notas de cada jugador.',
        attachTo: { element: '#tab-nuevo', on: 'bottom' },
        buttons: [{ text: 'Siguiente', action: tour.next }]
    });
    tour.addStep({
        title: 'Modo Oscuro',
        text: '¬øPrefieres un tema oscuro? Puedes cambiarlo en cualquier momento con este bot√≥n.',
        attachTo: { element: '#btn-dark-mode', on: 'bottom' },
        buttons: [{ text: 'Siguiente', action: tour.next }]
    });
    tour.addStep({
        title: 'Modo Global (Nube)',
        text: 'Para guardar tus datos en la nube y acceder desde cualquier dispositivo, activa el modo global e inicia sesi√≥n.',
        attachTo: { element: '#btn-auth', on: 'left' },
        buttons: [
            { text: 'Finalizar', action: tour.complete }
        ]
    });

    // Marcar el tour como completado al finalizar
    tour.on('complete', () => {
        localStorage.setItem('realMadridNotesTourCompleted', 'true');
    });

    tour.start();
}

function checkAndStartTour() {
    // Solo empieza el tour si no se ha completado antes
    if (!localStorage.getItem('realMadridNotesTourCompleted')) {
        // Esperamos un poco para que la UI se pinte antes de empezar
        setTimeout(startTour, 1000); 
    }
}
// =========================================================
// üîó AN√ÅLISIS DE CONEXIONES (ASISTENTE -> GOLEADOR)
// =========================================================

/**
 * Procesa todos los partidos para encontrar conexiones entre asistentes y goleadores en el mismo minuto.
 * @returns {object} Un objeto que mapea ID de asistente a un objeto de goleadores y sus conteos.
 * ej: { "playerA_id": { "playerB_id": 3, "playerC_id": 1 } }
 */
function analyzeGoalConnections() {
    const matches = getData('matches');
    const connections = {};

    matches.forEach(match => {
        const goalsByMinute = {};
        const assistsByMinute = {};

        // 1. Mapear todos los goles y asistencias del partido por minuto
        match.playerStats.forEach(ps => {
            if (ps.detailGoals) {
                ps.detailGoals.split(',').forEach(minuteStr => {
                    const minute = minuteStr.trim();
                    if (minute) {
                        if (!goalsByMinute[minute]) goalsByMinute[minute] = [];
                        goalsByMinute[minute].push(ps.playerId);
                    }
                });
            }
            if (ps.detailAssists) {
                ps.detailAssists.split(',').forEach(minuteStr => {
                    const minute = minuteStr.trim();
                    if (minute) {
                        if (!assistsByMinute[minute]) assistsByMinute[minute] = [];
                        assistsByMinute[minute].push(ps.playerId);
                    }
                });
            }
        });

        // 2. Encontrar coincidencias y construir las conexiones
        for (const minute in assistsByMinute) {
            if (goalsByMinute[minute]) {
                const assisters = assistsByMinute[minute];
                const scorers = goalsByMinute[minute];

                assisters.forEach(assisterId => {
                    if (!connections[assisterId]) {
                        connections[assisterId] = {};
                    }
                    scorers.forEach(scorerId => {
                        // Un jugador no puede asistirse a s√≠ mismo
                        if (assisterId !== scorerId) {
                            connections[assisterId][scorerId] = (connections[assisterId][scorerId] || 0) + 1;
                        }
                    });
                });
            }
        }
    });

    return connections;
}

/**
 * Renderiza la secci√≥n de estad√≠sticas de conexiones en la UI.
 * VERSI√ìN ADAPTADA AL TOGGLE UNIVERSAL
 */
function renderGoalConnections() {
    const container = document.getElementById('goal-connections-container');
    if (!container) return;

    const players = getPlayers();
    
    // 1. OBTENER Y PROCESAR DATOS
    const connectionsData = analyzeGoalConnections();

    if (Object.keys(connectionsData).length === 0) {
        container.innerHTML = `
            <div class="text-center py-8 text-gray-400 italic">
                No hay datos de asistencias y goles en el mismo minuto para analizar conexiones.
            </div>`;
        return;
    }

    const sortedAssisters = Object.entries(connectionsData)
        .map(([assisterId, targets]) => {
            const totalAssists = Object.values(targets).reduce((sum, count) => sum + count, 0);
            return { assisterId, targets, totalAssists };
        })
        .sort((a, b) => b.totalAssists - a.totalAssists);

    // 2. SEPARAR VISIBLES Y OCULTOS
    const VISIBLE_LIMIT = 3; 
    const visibleItems = sortedAssisters.slice(0, VISIBLE_LIMIT);
    const hiddenItems = sortedAssisters.slice(VISIBLE_LIMIT);

    // Helper: Crear Tarjeta HTML (Igual que antes)
    const createConnectionCard = ({ assisterId, targets }) => {
        const assister = players.find(p => p.id === assisterId);
        if (!assister) return '';

        const totalAssists = Object.values(targets).reduce((sum, count) => sum + count, 0);
        const sortedTargets = Object.entries(targets).sort(([, a], [, b]) => b - a);

        let cardHtml = `
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden flex flex-col h-full">
                <div class="p-4 bg-slate-50 border-b border-gray-200 flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <img src="${assister.foto}" class="w-10 h-10 rounded-full object-cover border-2 border-white shadow-md">
                        <div>
                            <h4 class="font-bold text-gray-800">${assister.apodo || assister.apellido}</h4>
                            <p class="text-xs text-gray-500">Asistente Principal</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <div class="text-2xl font-black text-blue-600">${totalAssists}</div>
                        <div class="text-[10px] text-gray-400 uppercase font-bold">Asistencias</div>
                    </div>
                </div>
                <div class="p-4 space-y-3 flex-1">`; // flex-1 para que estire

        sortedTargets.forEach(([scorerId, count]) => {
            const scorer = players.find(p => p.id === scorerId);
            if (scorer) {
                cardHtml += `
                    <div class="flex items-center justify-between bg-gray-50 p-2 rounded-lg">
                        <div class="flex items-center gap-2">
                            <img src="${scorer.foto}" class="w-6 h-6 rounded-full object-cover">
                            <span class="text-sm font-medium text-gray-700">${scorer.apodo || scorer.apellido}</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-sm text-gray-800">${count}</span>
                            <span class="text-green-500">‚ûî</span>
                            <span class="font-bold text-xl text-green-600">‚öΩ</span>
                        </div>
                    </div>`;
            }
        });

        cardHtml += `</div></div>`;
        return cardHtml;
    };

    // 3. GENERAR HTML ESTRUCTURA
    // ID √∫nico para la secci√≥n oculta
    const uniqueHiddenId = 'goal-connections-hidden-list';

    // Grid de elementos visibles
    let finalHtml = `
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            ${visibleItems.map(createConnectionCard).join('')}
        </div>
    `;

    // Si hay elementos ocultos, a√±adimos el grid oculto y el bot√≥n universal
    if (hiddenItems.length > 0) {
        finalHtml += `
            <div id="${uniqueHiddenId}" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mt-6 transition-all">
                ${hiddenItems.map(createConnectionCard).join('')}
            </div>

            <div class="text-center mt-6">
                <button onclick="toggleWidgetSection('${uniqueHiddenId}', this)" 
                        data-more="Mostrar {n} m√°s ‚ñº" 
                        data-less="Mostrar menos ‚ñ≤"
                        class="px-6 py-2 bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold rounded-full text-sm transition-all shadow-sm border border-gray-200">
                    Mostrar ${hiddenItems.length} m√°s ‚ñº
                </button>
            </div>
        `;
    }

    container.innerHTML = finalHtml;
}

async function generateSeasonYearbook() {
    const { jsPDF } = window.jspdf;

    // --- FILTRO DE LIMPIEZA INTELIGENTE ---
    const cleanForPdf = (text) => {
        if (!text) return "";
        return text
            .replace(/\u0107/g, 'c') // ƒá -> c
            .replace(/\u0106/g, 'C') // ƒÜ -> C
            .replace(/\u010D/g, 'c') // ƒç -> c
            .replace(/\u010C/g, 'C') // ƒå -> C
            // Borrar Emojis
            .replace(/[\u{1F600}-\u{1F64F}]/gu, '') 
            .replace(/[\u{1F300}-\u{1F5FF}]/gu, '') 
            .replace(/[\u{1F680}-\u{1F6FF}]/gu, '') 
            .replace(/[\u{1F1E0}-\u{1F1FF}]/gu, '') 
            .replace(/[\u{2600}-\u{26FF}]/gu, '')   
            .replace(/[\u{2700}-\u{27BF}]/gu, '')   
            .trim(); 
    };

    // 1. Obtener datos
    const matchesList = getData('matches') || []; 
    const playersList = getPlayers() || [];

    if (!matchesList || matchesList.length === 0) {
        showToast("‚ùå No hay partidos registrados.", "error");
        return;
    }

    showToast("‚è≥ Generando PDF...", "info");

    const doc = new jsPDF();
    doc.setFont("helvetica"); 

    const width = doc.internal.pageSize.getWidth();
    const height = doc.internal.pageSize.getHeight();

    // --- C√ÅLCULOS ESTAD√çSTICOS ---
    const playerStatsMap = {};
    playersList.forEach(p => {
        playerStatsMap[p.id] = { goals: 0, assists: 0, matches: 0, ratingSum: 0, ratingCount: 0 };
    });

    matchesList.forEach(m => {
        if (m.playerStats && Array.isArray(m.playerStats)) {
            m.playerStats.forEach(stat => {
                if (playerStatsMap[stat.playerId]) {
                    playerStatsMap[stat.playerId].goals += (parseInt(stat.goals) || 0);
                    playerStatsMap[stat.playerId].assists += (parseInt(stat.assists) || 0);
                    playerStatsMap[stat.playerId].matches += 1;
                    if (stat.rating) {
                        playerStatsMap[stat.playerId].ratingSum += parseFloat(stat.rating);
                        playerStatsMap[stat.playerId].ratingCount += 1;
                    }
                }
            });
        }
    });

    // MVP (Excluyendo entrenador)
    let mvpPlayer = null;
    let maxGoals = -1;
    playersList.forEach(p => {
        if (p.posicion === 'entrenador') return; 
        const stats = playerStatsMap[p.id];
        if (stats && stats.goals > maxGoals) {
            maxGoals = stats.goals;
            mvpPlayer = p;
        }
    });
    const mvpStats = mvpPlayer ? playerStatsMap[mvpPlayer.id] : { goals:0, assists:0 };
    const mvpRating = (mvpStats && mvpStats.ratingCount > 0) ? (mvpStats.ratingSum / mvpStats.ratingCount).toFixed(2) : '-';

    // --- PORTADA ---
    doc.setFillColor(15, 23, 42);
    doc.rect(0, 0, width, height, 'F');
    doc.setTextColor(255, 255, 255);
    doc.setFontSize(60);
    doc.setFont("helvetica", "bold");
    doc.text("ANUARIO", width/2, 100, { align: "center" });
    
    doc.setTextColor(250, 204, 21);
    doc.setFontSize(30);
    doc.text("TEMPORADA 24/25", width/2, 120, { align: "center" });
    doc.setTextColor(200, 200, 200);
    doc.setFontSize(16);
    doc.text("INFORME T√âCNICO OFICIAL", width/2, height - 30, { align: "center" });

    // --- RESUMEN ---
    doc.addPage();
    doc.setTextColor(0,0,0);
    doc.setFontSize(22);
    doc.text("Resumen de la Temporada", 14, 20);
    
    const totalPartidos = matchesList.length;
    const ganados = matchesList.filter(m => m.result && parseInt(m.result.split('-')[0]) > parseInt(m.result.split('-')[1])).length;
    const golesFavor = matchesList.reduce((acc, m) => acc + (m.result ? parseInt(m.result.split('-')[0]) : 0), 0);
    const golesContra = matchesList.reduce((acc, m) => acc + (m.result ? parseInt(m.result.split('-')[1]) : 0), 0);

    const drawStatBox = (x, y, label, value, color) => {
        doc.setFillColor(color[0], color[1], color[2]);
        doc.roundedRect(x, y, 40, 30, 3, 3, 'F');
        doc.setTextColor(255, 255, 255);
        doc.setFontSize(10);
        doc.text(label, x + 20, y + 10, { align: "center" });
        doc.setFontSize(16);
        doc.setFont("helvetica", "bold");
        doc.text(String(value), x + 20, y + 22, { align: "center" });
    };
    drawStatBox(14, 30, "PARTIDOS", totalPartidos, [59, 130, 246]);
    drawStatBox(60, 30, "VICTORIAS", ganados, [34, 197, 94]);
    drawStatBox(106, 30, "GOLES A FAVOR", golesFavor, [234, 179, 8]);
    drawStatBox(152, 30, "GOLES CONTRA", golesContra, [239, 68, 68]);

    // MVP Section
    doc.setTextColor(0, 0, 0);
    doc.setFontSize(18);
    doc.text("MVP de la Temporada", 14, 80);
    doc.setDrawColor(200, 200, 200);
    doc.line(14, 85, 190, 85);
    if (mvpPlayer) {
        doc.setFontSize(14);
        doc.text(`Nombre: ${cleanForPdf(mvpPlayer.nombre + ' ' + mvpPlayer.apellido)}`, 14, 95);
        doc.text(`Posici√≥n: ${mvpPlayer.posicion.toUpperCase()}`, 14, 105);
        doc.text(`Goles: ${mvpStats.goals} | Asistencias: ${mvpStats.assists}`, 14, 115);
        doc.text(`Nota Media: ${mvpRating}`, 14, 125);
    }

    // --- TABLA JUGADORES ---
    doc.addPage();
    doc.setFontSize(20);
    doc.text("Estad√≠sticas de Plantilla", 14, 20);

    const playersTableData = playersList.map(p => {
        const stats = playerStatsMap[p.id];
        const avgRating = stats.ratingCount > 0 ? (stats.ratingSum / stats.ratingCount).toFixed(2) : '-';
        const isCoach = p.posicion === 'entrenador';

        return [
            p.dorsal || (isCoach ? 'DT' : '-'),
            cleanForPdf(`${p.nombre} ${p.apellido}`),
            p.posicion.substring(0, 3).toUpperCase(),
            isCoach ? '-' : stats.goals,   // Goles: Gui√≥n si es DT
            isCoach ? '-' : stats.assists, // Asistencias: Gui√≥n si es DT
            stats.matches,                 // Partidos: Se muestra para TODOS (incluido DT)
            avgRating                      // Nota: Se muestra para TODOS (incluido DT)
        ];
    });

    playersTableData.sort((a, b) => {
        const dorsalA = parseInt(a[0]);
        const dorsalB = parseInt(b[0]);
        if (isNaN(dorsalA)) return 1;
        if (isNaN(dorsalB)) return -1;
        return dorsalA - dorsalB;
    });

    doc.autoTable({
        startY: 30,
        head: [['#', 'Nombre', 'Pos.', 'Goles', 'Asist.', 'Part.', 'Nota']],
        body: playersTableData,
        theme: 'striped',
        styles: { fontSize: 10, cellPadding: 3 },
        headStyles: { fillColor: [30, 58, 138] }
    });

    // --- TABLA PARTIDOS ---
    doc.addPage();
    doc.setFontSize(20);
    doc.text("Historial de Partidos", 14, 20);
    
    matchesList.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    const matchesTableData = matchesList.map(m => [
        new Date(m.date).toLocaleDateString(),
        cleanForPdf(m.opponent || 'Desconocido'),
        m.competition, 
        m.result || '-', 
        m.venue || '-'
    ]);
    
    doc.autoTable({
        startY: 30,
        head: [['Fecha', 'Rival', 'Comp.', 'Res.', 'Lugar']],
        body: matchesTableData,
        theme: 'grid',
        styles: { fontSize: 9 },
        headStyles: { fillColor: [15, 23, 42] }
    });

    doc.save(`Anuario_RealMadrid_${new Date().getFullYear()}.pdf`);
    showToast("‚úÖ PDF generado correctamente", "success");
}

// ==========================================
// üóÇÔ∏è GESTI√ìN DE CATEGOR√çAS DE ESTAD√çSTICAS
// ==========================================

function showStatCategory(catName) {
    // 1. Ocultar todos los contenidos de submen√∫
     document.querySelectorAll('.category-content').forEach(el => {
        el.classList.add('hidden');
        el.style.display = 'none'; // Forzar ocultado para evitar conflictos
    });
    // 2. Desactivar todos los botones de categor√≠a
    document.querySelectorAll('.category-btn').forEach(btn => btn.classList.remove('active-category'));

    // 3. Mostrar el contenido seleccionado
    const content = document.getElementById(`cat-content-${catName}`);
     if (content) {
        content.classList.remove('hidden');
        content.style.display = 'flex'; // Forzar mostrado
    }

    // 4. Activar el bot√≥n seleccionado
    const btn = document.getElementById(`cat-btn-${catName}`);
    if (btn) btn.classList.add('active-category');

    // 5. (Opcional) Activar autom√°ticamente la primera pesta√±a de esa categor√≠a
    // Esto evita que te quedes viendo un contenido vac√≠o al cambiar de categor√≠a
    if (catName === 'team') switchStatsTab('general');
    if (catName === 'players') switchStatsTab('coaches'); // O la que prefieras por defecto
    if (catName === 'rivals') switchStatsTab('h2h');
    if (catName === 'history') switchStatsTab('mvp');
}
// ==========================================
// üè† FUNCI√ìN: RENDIMIENTO CASA VS FUERA
// ==========================================
function renderHomeAwayStats(matchesData) {
    console.log("üèÅ Intentando pintar Gr√°fico Casa vs Fuera...");
    
    const matches = matchesData || getData('matches');

    if (!matches || matches.length === 0) {
        console.error("‚ùå ERROR: getData('matches') est√° vac√≠o.");
        return;
    }
    
    let stats = {
        home: { p: 0, w: 0, d: 0, l: 0, gf: 0, ga: 0, pts: 0 },
        away: { p: 0, w: 0, d: 0, l: 0, gf: 0, ga: 0, pts: 0 }
    };

    matches.forEach(m => {
        // Intento adivinar el nombre del campo
        const venue = String(m.venue || m.location || m.condicion || '').toLowerCase().trim();
        
        let type = null;
        if (venue.includes('local') || venue.includes('casa') || venue === 'h') type = 'home';
        else if (venue.includes('visit') || venue.includes('fuera') || venue === 'a') type = 'away';

        if (!type) return; 

        // Intento adivinar los goles
        let gf = m.goalsFor ?? m.gf ?? m.localScore;
        let ga = m.goalsAgainst ?? m.ga ?? m.visitorScore;

        // Lectura de resultado "2-1"
        if ((gf == null || ga == null) && m.result && m.result.includes('-')) {
            const parts = m.result.split('-');
            if (type === 'home') { gf = parts[0]; ga = parts[1]; }
            else { gf = parts[1]; ga = parts[0]; }
        }

        gf = parseInt(gf);
        ga = parseInt(ga);

        if (isNaN(gf) || isNaN(ga)) return;

        stats[type].p++;
        stats[type].gf += gf;
        stats[type].ga += ga;
        
        if (gf > ga) { stats[type].w++; stats[type].pts += 3; }
        else if (gf === ga) { stats[type].d++; stats[type].pts += 1; }
        else { stats[type].l++; }
    });

    // Actualizar HTML
    try {
        const setVal = (id, val) => { const el = document.getElementById(id); if(el) el.textContent = val; };
        
        setVal('home-matches', stats.home.p);
        setVal('home-wins', stats.home.w);
        setVal('home-goals', stats.home.gf);
        setVal('home-points-display', `${stats.home.pts} Pts`);
        
        setVal('away-matches', stats.away.p);
        setVal('away-wins', stats.away.w);
        setVal('away-goals', stats.away.gf);
        setVal('away-points-display', `${stats.away.pts} Pts`);
    } catch(e){}

    // Gr√°fico
    const ctx = document.getElementById('chart-home-away');
    if (ctx) {
        if (window.homeAwayChart instanceof Chart) window.homeAwayChart.destroy();
        window.homeAwayChart = new Chart(ctx, {
            type: 'bar',
            data: {
                labels: ['Goles Favor', 'Goles Contra', 'Pts/Partido'],
                datasets: [
                    {
                        label: 'üè† Casa',
                        data: [
                            stats.home.p ? (stats.home.gf/stats.home.p).toFixed(2) : 0,
                            stats.home.p ? (stats.home.ga/stats.home.p).toFixed(2) : 0,
                            stats.home.p ? (stats.home.pts/stats.home.p).toFixed(2) : 0
                        ],
                        backgroundColor: '#1e3a8a', // AZUL OSCURO (Elegante)
                        borderRadius: 4
                    },
                    {
                        label: '‚úàÔ∏è Fuera',
                        data: [
                            stats.away.p ? (stats.away.gf/stats.away.p).toFixed(2) : 0,
                            stats.away.p ? (stats.away.ga/stats.away.p).toFixed(2) : 0,
                            stats.away.p ? (stats.away.pts/stats.away.p).toFixed(2) : 0
                        ],
                        backgroundColor: '#f59e0b', // DORADO/√ÅMBAR (Contraste alto)
                        borderRadius: 4
                    }
                ]
            },
            options: { 
                responsive: true, 
                maintainAspectRatio: false,
                scales: {
                    y: { beginAtZero: true }
                }
            }
        });
    }
}
// ==========================================
// ACTIVADOR EFECTO JELLY (GLOBAL)
// ==========================================
document.addEventListener('click', function(e) {
    // Detectamos si lo que se ha clicado es un bot√≥n (o est√° dentro de uno)
    // Buscamos etiquetas button, inputs tipo submit/button, o elementos con clase .btn
    const targetButton = e.target.closest('button, input[type="submit"], input[type="button"], .btn');

    if (targetButton) {
        // 1. Si ya se estaba moviendo, reiniciamos la animaci√≥n
        targetButton.classList.remove('jelly-active');
        
        // Truco para forzar al navegador a reiniciar la animaci√≥n (reflow)
        void targetButton.offsetWidth; 
        
        // 2. A√±adimos la clase que activa el baile
        targetButton.classList.add('jelly-active');

        // 3. Cuando termine el baile, quitamos la clase (limpieza)
        targetButton.addEventListener('animationend', () => {
            targetButton.classList.remove('jelly-active');
        }, { once: true });
    }
});

// --- BOT√ìN VOLVER ARRIBA ---
window.addEventListener('scroll', () => {
    const btn = document.getElementById('back-to-top');
    if (btn) {
        if (window.scrollY > 300) btn.classList.remove('hidden');
        else btn.classList.add('hidden');
    }
});
        // Global Modal Close Handler
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                    unlockScroll();
                }
            });
        });

// ==========================================
// INICIO DE LA APLICACI√ìN
// ==========================================
document.addEventListener('DOMContentLoaded', async () => {
    console.log('App ready');

    // 2. AHORA, ejecutamos el resto de inicializadores
    initDarkMode();
    preloadCalendars();
    syncExtraRounds();

    // Inicia en modo Global por defecto
    if (appMode === 'global') {
        if (initFirebase()) {
            document.getElementById('btn-mode-global').className = "px-4 py-2 rounded-md font-bold bg-blue-600 text-white shadow-sm transition-all text-sm";
            document.getElementById('btn-mode-local').className = "px-4 py-2 rounded-md font-bold text-white hover:bg-white/10 transition-all text-sm";
            setupRealtimeListener();
        } else {
            setStorageMode('local');
        }
    }

    // 3. A√ëADIMOS los listeners para los botones
    console.log("A√±adiendo listeners para el modal de login...");
    const loginButton = document.getElementById('btn-auth');
    const closeButton = document.getElementById('btn-close-login');
    const loginModalBackdrop = document.getElementById('login-modal');
    const tourButton = document.getElementById('btn-tour');

    if (tourButton) {
        tourButton.addEventListener('click', startTour);
    }

    if (loginButton) {
        loginButton.addEventListener('click', toggleLoginModal);
    }

    if (closeButton) {
        closeButton.addEventListener('click', toggleLoginModal);
    }

    if (loginModalBackdrop) {
        loginModalBackdrop.addEventListener('click', function(e) {
            if (e.target === loginModalBackdrop) {
                toggleLoginModal();
            }
        });
    }
});

// ==========================================
// SCROLL LOCK UTILS
// ==========================================
function lockScroll() { document.body.style.overflow = 'hidden'; }
function unlockScroll() { document.body.style.overflow = ''; }

function closeViewMatchModal() {
    const modal = document.getElementById('match-details-modal');
    if (modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        unlockScroll();
    }
}

        
        // ==========================================
        // 1. L√ìGICA TILT 3D (CARTAS)
        // ==========================================
        document.addEventListener('mousemove', (e) => {
            const card = e.target.closest('.tilt-card');
            if (!card) return;
            
            const rect = card.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            const centerX = rect.width / 2;
            const centerY = rect.height / 2;
            
            // Invertir ejes para efecto tilt correcto
            const rotateX = ((y - centerY) / centerY) * -8; 
            const rotateY = ((x - centerX) / centerX) * 8;

            card.style.transform = `perspective(1000px) rotateX(${rotateX}deg) rotateY(${rotateY}deg) scale(1.02)`;
        });

        document.addEventListener('mouseout', (e) => {
            if (e.target.closest('.tilt-card')) {
                const card = e.target.closest('.tilt-card');
                card.style.transform = ''; 
            }
        }, true);

        // ==========================================
        // 3. L√ìGICA LIGHTBOX (MODO CINE)
        // ==========================================
        function openLightbox(src, caption) {
            const modal = document.getElementById('lightbox-modal');
            const img = document.getElementById('lightbox-img');
            const cap = document.getElementById('lightbox-caption');
            
            img.src = src;
            cap.textContent = caption || '';
            
            modal.classList.remove('hidden');
            // Peque√±o delay para permitir la transici√≥n CSS
            setTimeout(() => {
                modal.classList.remove('opacity-0');
                modal.classList.add('active');
            }, 10);
            lockScroll();
        }

        function closeLightbox() {
            const modal = document.getElementById('lightbox-modal');
            modal.classList.remove('active');
            modal.classList.add('opacity-0');
            setTimeout(() => {
                modal.classList.add('hidden');
                unlockScroll();
            }, 300);
        }

        // ==========================================
        // 4. BARRA DE PROGRESO DE TEMPORADA
        // ==========================================
        function renderSeasonProgressBar() {
            const container = document.getElementById('season-progress-widget');
            if (!container) return;

            const matches = getData('matches');
            // Estimaci√≥n: Liga (38/30) + Champions (min 8) + Copa (min 1) + Supercopa (min 1)
            // Usamos 55 como un est√°ndar de temporada completa para el Madrid
            const totalEstimated = currentTeam === 'masculino' ? 60 : 45; 
            const played = matches.length;
            const percentage = Math.min(100, Math.round((played / totalEstimated) * 100));

            container.classList.remove('hidden');
            container.innerHTML = `
                <div class="flex justify-between items-end mb-2">
                    <div>
                        <h3 class="text-sm font-bold text-gray-700 uppercase tracking-wide">Progreso de Temporada</h3>
                        <p class="text-xs text-gray-500">Partidos jugados: <span class="font-bold text-slate-800">${played}</span> / ~${totalEstimated}</p>
                    </div>
                    <div class="text-2xl font-black text-indigo-600">${percentage}%</div>
                </div>
                <div class="w-full bg-gray-100 rounded-full h-3 overflow-hidden">
                    <div class="bg-gradient-to-r from-indigo-500 to-purple-500 h-full rounded-full transition-all duration-1000 ease-out" style="width: ${percentage}%"></div>
                </div>
            `;
        }
// ==========================================
// GR√ÅFICO DE RENDIMIENTO (VERSI√ìN DEFINITIVA: Usa el 'Outcome' directo)
// ==========================================

let competitionChartInstance = null;

function updateCompetitionChart() {
    console.log("üìä Generando gr√°fico usando el dato directo (Victoria/Derrota/Empate)...");

    // 1. OBTENER DATOS
    let matches = [];
    if (typeof getData === 'function') {
        matches = getData('matches') || [];
    } else {
        if (typeof window.matches !== 'undefined') matches = window.matches;
    }

    // 2. FILTRAR PARTIDOS V√ÅLIDOS
    // Buscamos partidos que tengan definido el resultado (outcome)
    // CAMBIA 'outcome' POR EL NOMBRE EXACTO DE TU PROPIEDAD SI ES OTRO (ej: match.resultType)
    const playedMatches = matches.filter(m => m.outcome && typeof m.outcome === 'string');

    if (playedMatches.length === 0) {
        console.log("‚ö†Ô∏è No hay partidos con 'outcome' registrado.");
        return;
    }

    // 3. PROCESAR DATOS
    const stats = {};

    playedMatches.forEach(match => {
        // A. Nombre de competici√≥n
        let compName = match.competition || 'Amistoso';
        if (typeof COMPETICIONES_ACTUALES !== 'undefined' && COMPETICIONES_ACTUALES[compName]) {
            compName = COMPETICIONES_ACTUALES[compName].nombre;
        }

        // B. Inicializar contadores
        if (!stats[compName]) {
            stats[compName] = { w: 0, d: 0, l: 0, total: 0 };
        }

        // C. LEER EL RESULTADO DIRECTO (LA L√ìGICA NUEVA) üíé
        // Convertimos a min√∫sculas y quitamos espacios por seguridad
        const resultado = match.outcome.toLowerCase().trim();

        if (resultado === 'victoria') {
            stats[compName].w++;
        } else if (resultado === 'derrota') {
            stats[compName].l++;
        } else if (resultado === 'empate') {
            stats[compName].d++;
        } else {
            // Si llega algo raro (ej: "suspendido"), no lo sumamos a W/D/L pero s√≠ al total?
            // De momento lo ignoramos para no romper la estad√≠stica
            return; 
        }

        stats[compName].total++;
    });

    // 4. PREPARAR DATOS (Porcentajes)
    const labels = Object.keys(stats);
    const dataWins = [];
    const dataDraws = [];
    const dataLosses = [];
    const rawCounts = [];

    labels.forEach(comp => {
        const s = stats[comp];
        const total = s.total;

        // Porcentajes (con 1 decimal)
        dataWins.push(((s.w / total) * 100).toFixed(1));
        dataDraws.push(((s.d / total) * 100).toFixed(1));
        dataLosses.push(((s.l / total) * 100).toFixed(1));

        rawCounts.push(s);
    });

    // 5. PINTAR EL GR√ÅFICO
    const canvas = document.getElementById('competitionChart');
    if (!canvas) return;

    const ctx = canvas.getContext('2d');

    if (competitionChartInstance) {
        competitionChartInstance.destroy();
    }

    competitionChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Victorias',
                    data: dataWins,
                    backgroundColor: '#22c55e', // Verde
                    barPercentage: 0.6,
                },
                {
                    label: 'Empates',
                    data: dataDraws,
                    backgroundColor: '#9ca3af', // Gris
                    barPercentage: 0.6,
                },
                {
                    label: 'Derrotas',
                    data: dataLosses,
                    backgroundColor: '#ef4444', // Rojo
                    barPercentage: 0.6,
                }
            ]
        },
        options: {
            indexAxis: 'y', // Barras horizontales
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const datasetIndex = context.datasetIndex; // 0:W, 1:D, 2:L
                            const dataIndex = context.dataIndex;
                            const pct = context.raw;
                            
                            const realStats = rawCounts[dataIndex];
                            let realNum = 0;
                            let labelStr = '';

                            if (datasetIndex === 0) { realNum = realStats.w; labelStr = 'Victorias'; }
                            else if (datasetIndex === 1) { realNum = realStats.d; labelStr = 'Empates'; }
                            else { realNum = realStats.l; labelStr = 'Derrotas'; }

                            return `${labelStr}: ${pct}% (${realNum} partidos)`;
                        },
                        footer: function(tooltipItems) {
                             const idx = tooltipItems[0].dataIndex;
                             return 'Total jugados: ' + rawCounts[idx].total;
                        }
                    }
                }
            },
            scales: {
                x: {
                    stacked: true,
                    max: 100,
                    grid: { display: false },
                    ticks: { callback: (v) => v + '%' }
                },
                y: {
                    stacked: true,
                    grid: { display: false }
                }
            }
        }
    });
}
// ==========================================
// GR√ÅFICO: ESTILO DE VICTORIA (Margen de Goles)
// ==========================================

let victoryStyleChartInstance = null;

function updateVictoryStyleChart() {
    console.log("‚ö° Calculando estilo de victorias...");

    // 1. OBTENER DATOS
    let matches = [];
    if (typeof getData === 'function') {
        matches = getData('matches') || [];
    } else {
        if (typeof window.matches !== 'undefined') matches = window.matches;
    }

    // 2. FILTRAR SOLO VICTORIAS CON RESULTADO
    const wins = matches.filter(m => 
        m.outcome && 
        m.outcome.toLowerCase().trim() === 'victoria' && 
        m.result && 
        m.result.includes('-')
    );

    if (wins.length === 0) {
        console.log("‚ö†Ô∏è No hay victorias registradas para analizar.");
        return;
    }

    // 3. CLASIFICAR POR DIFERENCIA DE GOLES
    let counts = {
        ajustada: 0, // Dif +1
        comoda: 0,   // Dif +2
        goleada: 0   // Dif +3 o m√°s
    };

    wins.forEach(match => {
        // Rompemos el resultado "3-1" o "1-2"
        const parts = match.result.split('-');
        const g1 = parseInt(parts[0]);
        const g2 = parseInt(parts[1]);
        
        // Calculamos la diferencia absoluta (da igual si es 3-1 o 1-3, la diferencia es 2)
        const diff = Math.abs(g1 - g2);

        if (diff === 1) {
            counts.ajustada++;
        } else if (diff === 2) {
            counts.comoda++;
        } else if (diff >= 3) {
            counts.goleada++;
        }
    });

    // 4. PREPARAR DATOS PARA EL GR√ÅFICO
    const labels = ['Ajustada (+1)', 'C√≥moda (+2)', 'Goleada (+3)'];
    const dataValues = [counts.ajustada, counts.comoda, counts.goleada];

    // 5. RENDERIZAR GR√ÅFICO
    const canvas = document.getElementById('victoryStyleChart');
    if (!canvas) return;

    const ctx = canvas.getContext('2d');

    if (victoryStyleChartInstance) {
        victoryStyleChartInstance.destroy();
    }

    victoryStyleChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [{
                label: 'Partidos',
                data: dataValues,
                backgroundColor: [
                    '#fbbf24', // Ajustada: √Åmbar (Sufrimiento/Alerta)
                    '#3b82f6', // C√≥moda: Azul (Control)
                    '#8b5cf6'  // Goleada: Violeta (Magia/√âpico)
                ],
                borderRadius: 6, // Bordes redondeados modernos
                barThickness: 40, // Grosor de la barra
            }]
        },
        options: {
            indexAxis: 'y', // <--- BARRAS HORIZONTALES
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }, // No hace falta leyenda, los colores lo dicen todo
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.raw} Partidos`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: { display: false },
                    ticks: { precision: 0 } // Solo n√∫meros enteros
                },
                y: {
                    grid: { display: false },
                    ticks: { 
                        font: { weight: 'bold', size: 12 } 
                    }
                }
            }
        }
    });
}
// ==========================================
// GR√ÅFICO: BALANCE GOLEADOR (CORREGIDO: Sin check de 'match.played')
// ==========================================

let goalsAssistsChartInstance = null;

function renderGoalsAssistsScatter() {
    console.log("‚öñÔ∏è Calculando Balance Goleador (Versi√≥n Corregida)...");

    // 1. OBTENER DATOS
    let basePlayers = [];
    // Usamos getPlayers() para tener la lista oficial con nombres y fotos
    if (typeof getPlayers === 'function') {
        basePlayers = getPlayers(); 
    } else if (typeof window.players !== 'undefined') {
        basePlayers = window.players;
    }

    const matches = getData('matches') || [];

    if (basePlayers.length === 0 || matches.length === 0) {
        return;
    }

    // 2. MAPA DE ACUMULACI√ìN
    const statsMap = {};

    // A. Inicializar mapa con nombres correctos
    basePlayers.forEach(p => {
        const displayName = p.apodo || p.nombre || 'Jugador';
        statsMap[p.id] = {
            id: p.id,
            name: displayName,
            goals: 0,
            assists: 0,
            minutes: 0
        };
    });

    // B. RECORRER PARTIDOS (AQU√ç ESTABA EL ERROR) üö®
    matches.forEach(match => {
        // CORRECCI√ìN: Eliminamos '!match.played'.
        // Solo verificamos si existen estad√≠sticas de jugadores guardadas.
        if (!match.playerStats || !Array.isArray(match.playerStats)) return;

        match.playerStats.forEach(stat => {
            // Verificamos si el jugador existe en nuestra DB actual
            if (statsMap[stat.playerId]) {
                const g = parseInt(stat.goals || 0);
                const a = parseInt(stat.assists || 0);
                const m = parseInt(stat.minutes || 0);

                statsMap[stat.playerId].goals += g;
                statsMap[stat.playerId].assists += a;
                statsMap[stat.playerId].minutes += m;
            }
        });
    });

    // 3. FILTRAR JUGADORES ACTIVOS
    const activePlayers = Object.values(statsMap).filter(p => 
        p.minutes > 0 || p.goals > 0 || p.assists > 0
    );

    if (activePlayers.length === 0) {
        console.log("‚ö†Ô∏è No hay jugadores con estad√≠sticas activas.");
        return;
    }

    // 4. CALCULAR M√ÅXIMOS
    const maxMinutes = Math.max(...activePlayers.map(p => p.minutes));
    const maxGoals = Math.max(...activePlayers.map(p => p.goals), 1);
    const maxAssists = Math.max(...activePlayers.map(p => p.assists), 1);

    const MIN_RADIUS = 5;
    const MAX_RADIUS = 25;

    // 5. PREPARAR DATASETS
    const chartData = activePlayers.map(p => {
        let color = '#94a3b8'; // Gris

        const isScorer = p.goals >= (maxGoals * 0.3) && p.goals > 0;
        const isPlaymaker = p.assists >= (maxAssists * 0.3) && p.assists > 0;

        if (isScorer && isPlaymaker) color = '#9333ea'; // Morado
        else if (isScorer) color = '#3b82f6'; // Azul
        else if (isPlaymaker) color = '#f59e0b'; // √Åmbar

        const radius = MIN_RADIUS + ((p.minutes / (maxMinutes || 1)) * (MAX_RADIUS - MIN_RADIUS));

        return {
            x: p.goals,
            y: p.assists,
            r: radius,
            player: p.name,
            minutes: p.minutes,
            rawColor: color
        };
    });

    // 6. RENDERIZAR GR√ÅFICO
    const ctx = document.getElementById('scatterGoalAssistChart');
    if (!ctx) return;

    if (goalsAssistsChartInstance) {
        goalsAssistsChartInstance.destroy();
    }

    goalsAssistsChartInstance = new Chart(ctx, {
        type: 'bubble',
        data: {
            datasets: [{
                label: 'Plantilla',
                data: chartData,
                backgroundColor: function(context) {
                    return context.raw ? context.raw.rawColor : '#94a3b8';
                },
                borderColor: '#ffffff',
                borderWidth: 1,
                hoverBorderColor: '#1e293b',
                hoverBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: { padding: 10 },
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(15, 23, 42, 0.95)',
                    callbacks: {
                        label: function(context) {
                            return context.raw.player;
                        },
                        afterLabel: function(context) {
                            const d = context.raw;
                            return `‚öΩ ${d.x} Goles | üëü ${d.y} Asist.\n‚è±Ô∏è ${d.minutes} mins`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    title: { display: true, text: 'Goles', font: {weight:'bold'} },
                    min: -0.5,
                    suggestedMax: maxGoals + 1,
                    ticks: { stepSize: 1 }
                },
                y: {
                    title: { display: true, text: 'Asistencias', font: {weight:'bold'} },
                    min: -0.5,
                    suggestedMax: maxAssists + 1,
                    ticks: { stepSize: 1 }
                }
            }
        },
        plugins: [{
            id: 'quadrantLabelsSimple',
            beforeDraw: (chart) => {
                const { ctx, chartArea: { top, bottom, left, right } } = chart;
                ctx.save();
                ctx.font = 'bold 10px sans-serif';
                ctx.fillStyle = 'rgba(150, 150, 150, 0.2)';
                ctx.textAlign = 'center';
                ctx.fillText('CRACK', right - 30, top + 20);
                ctx.fillText('GOL', right - 30, bottom - 20);
                ctx.fillText('ASIST', left + 30, top + 20);
                ctx.restore();
            }
        }]
    });
}
// ==========================================
// GR√ÅFICO: RACHA DE CONTRIBUCIONES (Goles + Asistencias)
// ==========================================

let streakChartInstance = null;

function renderStreakChart() {
    console.log("üî• Calculando Rachas de Goles + Asistencias...");

    // 1. OBTENER DATOS
    let basePlayers = [];
    if (typeof getPlayers === 'function') {
        basePlayers = getPlayers();
    } else if (typeof window.players !== 'undefined') {
        basePlayers = window.players;
    }

    // Obtenemos los partidos
    let matches = getData('matches') || [];

    if (basePlayers.length === 0 || matches.length === 0) return;

    // 2. ORDENAR PARTIDOS CRONOL√ìGICAMENTE (Vital para una racha)
    // Usamos match.date como confirmaste
    matches.sort((a, b) => new Date(a.date) - new Date(b.date));

    // 3. INICIALIZAR MAPA DE JUGADORES
    // Estructura: { id: { name: "Vini", current: 0, max: 0, active: false } }
    const streakMap = {};

    basePlayers.forEach(p => {
        const displayName = p.apodo || p.nombre || 'Jugador';
        streakMap[p.id] = {
            id: p.id,
            name: displayName,
            current: 0,      // Racha actual
            max: 0,          // R√©cord hist√≥rico
            hasPlayed: false // Para saber si ha debutado
        };
    });

    // 4. CALCULAR RACHAS
    matches.forEach(match => {
        // Solo analizamos partidos con estad√≠sticas registradas
        if (!match.playerStats || !Array.isArray(match.playerStats)) return;

        match.playerStats.forEach(stat => {
            const player = streakMap[stat.playerId];
            if (!player) return; // Si el jugador ya no est√° en la base de datos, ignorar

            // DATOS CONFIRMADOS:
            const minutes = parseInt(stat.minutes || 0);
            const goals = parseInt(stat.goals || 0);
            const assists = parseInt(stat.assists || 0);
            const contribution = goals + assists;

            // L√ìGICA DE RACHA:
            if (minutes > 0) {
                player.hasPlayed = true; // Ha jugado al menos una vez

                if (contribution > 0) {
                    // ¬°Hay contribuci√≥n! Aumentamos racha actual
                    player.current++;
                    
                    // Comprobamos si superamos el r√©cord personal
                    if (player.current > player.max) {
                        player.max = player.current;
                    }
                } else {
                    // Jug√≥ y NO contribuy√≥: La racha se rompe ‚ùå
                    player.current = 0;
                }
            }
            // Si minutes === 0, no hacemos nada. La racha se MANTIENE (Pausa por lesi√≥n/descanso).
        });
    });

    // 5. FILTRAR Y ORDENAR
    // Queremos ver a los que tienen alguna racha interesante.
    // Filtramos los que tengan un R√©cord > 1 o una Racha Actual > 0
    let chartData = Object.values(streakMap).filter(p => p.max > 1 || p.current > 0);

    // Ordenamos: Los que tienen la RACHA ACTUAL m√°s alta van primero (arriba)
    chartData.sort((a, b) => b.current - a.current);

    // Top 10 para que el gr√°fico no sea eterno
    chartData = chartData.slice(0, 10);

    if (chartData.length === 0) {
        console.log("‚ö†Ô∏è A√∫n no hay rachas significativas.");
        return;
    }

    // 6. PREPARAR ARRAYS PARA CHART.JS
    const labels = chartData.map(p => p.name);
    const dataCurrent = chartData.map(p => p.current);
    const dataMax = chartData.map(p => p.max); // El r√©cord (fondo)

    // 7. RENDERIZAR GR√ÅFICO
    const ctx = document.getElementById('streakChart');
    if (!ctx) return;

    if (streakChartInstance) {
        streakChartInstance.destroy();
    }

    streakChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: labels,
            datasets: [
                {
                    label: 'Racha Actual üî•',
                    data: dataCurrent,
                    backgroundColor: '#f97316', // Naranja Fuego (Orange-500)
                    borderRadius: 4,
                    barPercentage: 0.6,
                    categoryPercentage: 0.8,
                    order: 1 // Capa superior
                },
                {
                    label: 'R√©cord Personal üèÜ',
                    data: dataMax,
                    backgroundColor: '#e5e7eb', // Gris claro (Gray-200) - Efecto fantasma
                    borderRadius: 4,
                    barPercentage: 0.6,
                    categoryPercentage: 0.8,
                    order: 2 // Capa inferior (Fondo)
                }
            ]
        },
        options: {
            indexAxis: 'y', // Barras horizontales
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false }, // Usamos tu leyenda HTML personalizada
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            return `${context.dataset.label}: ${context.raw} partidos`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    grid: { display: false },
                    ticks: { stepSize: 1 }, // Solo enteros
                    beginAtZero: true
                },
                y: {
                    grid: { display: false },
                    ticks: { font: { weight: 'bold' } }
                }
            },
            // Animaci√≥n chula para las barras
            animation: {
                duration: 1500,
                easing: 'easeOutQuart'
            }
        }
    });
}
// ==========================================
// GR√ÅFICO: DEPENDENCIA DEL GOL (Donut Top 3 + Resto)
// ==========================================

let dependencyChartInstance = null;

function renderDependencyChart() {
    console.log("üéØ Calculando Dependencia del Gol...");

    // 1. OBTENER DATOS
    let basePlayers = [];
    if (typeof getPlayers === 'function') basePlayers = getPlayers();
    else if (typeof window.players !== 'undefined') basePlayers = window.players;

    const matches = getData('matches') || [];

    if (matches.length === 0) return;

    // 2. CALCULAR EL "TOTAL REAL" DEL CLUB (Fuente de verdad: Marcadores)
    let totalTeamGoals = 0;

    matches.forEach(m => {
        if (!m.result || !m.result.includes('-')) return;

        // Detectar si somos Local o Visitante
        const venue = String(m.venue || m.location || '').toLowerCase().trim();
        let isLocal = venue.includes('local') || venue.includes('casa') || venue === 'h';
        
        // Parsear resultado "3-1"
        const parts = m.result.split('-');
        const goalsLocal = parseInt(parts[0]) || 0;
        const goalsVisitor = parseInt(parts[1]) || 0;

        // Sumar NUESTROS goles
        if (isLocal) totalTeamGoals += goalsLocal;
        else totalTeamGoals += goalsVisitor;
    });

    if (totalTeamGoals === 0) {
        console.log("‚ö†Ô∏è A√∫n no hay goles registrados en marcadores.");
        return;
    }

    // 3. CALCULAR GOLES POR JUGADOR (PlayerStats)
    const playerGoalsMap = {};
    
    // Inicializar mapa
    basePlayers.forEach(p => {
        playerGoalsMap[p.id] = {
            name: p.apodo || p.nombre || 'Jugador',
            goals: 0
        };
    });

    // Sumar goles asignados
    matches.forEach(match => {
        if (!match.playerStats || !Array.isArray(match.playerStats)) return;
        match.playerStats.forEach(stat => {
            if (playerGoalsMap[stat.playerId]) {
                playerGoalsMap[stat.playerId].goals += parseInt(stat.goals || 0);
            }
        });
    });

    // 4. ORDENAR Y AGRUPAR (TOP 3 + RESTO)
    let allScorers = Object.values(playerGoalsMap).filter(p => p.goals > 0);
    allScorers.sort((a, b) => b.goals - a.goals); // Orden descendente

    // Preparar datos finales
    let chartLabels = [];
    let chartData = [];
    let chartColors = [];

    // Colores para el Top 3 (Oro, Plata, Bronce visuales)
    const topColors = ['#fbbf24', '#94a3b8', '#b45309']; // Amber-400, Slate-400, Amber-700
    
    // A. Procesar TOP 3
    let assignedGoals = 0;
    const top3 = allScorers.slice(0, 3);
    
    top3.forEach((p, index) => {
        chartLabels.push(p.name);
        chartData.push(p.goals);
        chartColors.push(topColors[index] || '#cbd5e1'); // Color fallback
        assignedGoals += p.goals;
    });

    // B. Procesar "RESTO DEL EQUIPO" (Jugadores fuera del Top 3)
    const restOfPlayers = allScorers.slice(3);
    let restGoals = restOfPlayers.reduce((sum, p) => sum + p.goals, 0);

    if (restGoals > 0) {
        chartLabels.push('Resto Equipo');
        chartData.push(restGoals);
        chartColors.push('#3b82f6'); // Azul (Trabajo en equipo)
        assignedGoals += restGoals;
    }

    // C. Procesar "AUTOGOLES / NO ASIGNADOS" (Diferencia con el Total Real)
    // Si el marcador dice 50 goles y los jugadores suman 48, faltan 2.
    let unassignedGoals = totalTeamGoals - assignedGoals;
    
    // Evitar negativos por si acaso hay error en datos manuales
    if (unassignedGoals < 0) unassignedGoals = 0; 

    if (unassignedGoals > 0) {
        chartLabels.push('Autogol/Otro');
        chartData.push(unassignedGoals);
        chartColors.push('#e2e8f0'); // Gris muy claro
    }

    // 5. DETECTAR DEPENDENCIA (ALERTA) üö®
    // Miramos si el Top 1 tiene m√°s del 40% del TOTAL DEL CLUB
    const top1Goals = top3.length > 0 ? top3[0].goals : 0;
    const dependencyRatio = (top1Goals / totalTeamGoals) * 100;
    const alertElement = document.getElementById('dependencyAlert');

    if (alertElement) {
        // Limpiar contenido previo
        alertElement.innerHTML = '';
        
        if (dependencyRatio >= 40) {
            // INYECTAR ALERTA VISUAL
            alertElement.innerHTML = `
                <div class="text-center animate-pulse">
                    <div class="text-3xl">‚ö†Ô∏è</div>
                    <div class="text-xs font-bold text-red-500 uppercase tracking-widest mt-1">Dependencia</div>
                    <div class="text-lg font-extrabold text-gray-800">${Math.round(dependencyRatio)}%</div>
                    <div class="text-[10px] text-gray-400">${top3[0].name}</div>
                </div>
            `;
        } else {
            // ESTADO NORMAL (Mostrar total goles)
            alertElement.innerHTML = `
                <div class="text-center">
                    <div class="text-3xl font-bold text-gray-700">${totalTeamGoals}</div>
                    <div class="text-[10px] uppercase text-gray-400 tracking-widest">Goles Totales</div>
                </div>
            `;
        }
    }

    // 6. RENDERIZAR GR√ÅFICO
    const ctx = document.getElementById('dependencyChart');
    if (!ctx) return;

    if (dependencyChartInstance) {
        dependencyChartInstance.destroy();
    }

    dependencyChartInstance = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: chartLabels,
            datasets: [{
                data: chartData,
                backgroundColor: chartColors,
                borderWidth: 2,
                borderColor: '#ffffff',
                hoverOffset: 4
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: '70%', // Tama√±o del agujero central
            plugins: {
                legend: {
                    position: 'bottom',
                    labels: { boxWidth: 10, font: { size: 10 } }
                },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const value = context.raw;
                            const percentage = ((value / totalTeamGoals) * 100).toFixed(1);
                            return `${context.label}: ${value} Goles (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
}
// ==========================================
// GR√ÅFICO: RANKING DE GARANT√çA (Opci√≥n C)
// ==========================================

let guaranteeChartInstance = null;

function renderGuaranteeChart() {
    console.log("üõ°Ô∏è Calculando Ranking de Garant√≠a (Top Minutos)...");

    // 1. OBTENER DATOS
    let basePlayers = [];
    if (typeof getPlayers === 'function') basePlayers = getPlayers();
    else if (typeof window.players !== 'undefined') basePlayers = window.players;

    const matches = getData('matches') || [];

    if (basePlayers.length === 0 || matches.length === 0) return;

    // 2. ACUMULAR DATOS (Minutos y Notas)
    const statsMap = {};

    // Inicializamos mapa con todos los jugadores
    basePlayers.forEach(p => {
        statsMap[p.id] = {
            id: p.id,
            name: p.apodo || p.nombre,
            ratings: [],
            totalMinutes: 0
        };
    });

    matches.forEach(match => {
        if (!match.playerStats || !Array.isArray(match.playerStats)) return;

        match.playerStats.forEach(stat => {
            // Minutos
            let mins = parseInt(stat.minutes || 0);
            if (mins > 0 && statsMap[stat.playerId]) {
                statsMap[stat.playerId].totalMinutes += mins;

                // Nota
                let rawRating = stat.rating;
                if (rawRating !== undefined && rawRating !== null && rawRating !== "") {
                    let rating = parseFloat(String(rawRating).replace(',', '.'));
                    if (!isNaN(rating) && rating > 0) {
                        statsMap[stat.playerId].ratings.push(rating);
                    }
                }
            }
        });
    });

    // 3. FILTRAR: SOLO EL "N√öCLEO DURO" (Top 12 por Minutos)
    let allPlayers = Object.values(statsMap);
    
    // Ordenamos por Minutos Jugados (Descendente)
    allPlayers.sort((a, b) => b.totalMinutes - a.totalMinutes);

    // Nos quedamos con los 12 que m√°s han jugado
    let coreTeam = allPlayers.slice(0, 12);

    // Si nadie ha jugado (principio de temporada), salimos
    if (coreTeam.length === 0 || coreTeam[0].totalMinutes === 0) {
        console.log("‚ö†Ô∏è A√∫n no hay minutos suficientes para el Ranking.");
        return;
    }

    // 4. CALCULAR M√âTRICAS (Media y Desviaci√≥n)
    let chartData = [];

    coreTeam.forEach(p => {
        // Si ha jugado muchos minutos pero no tiene notas, lo saltamos
        if (p.ratings.length === 0) return;

        // A. Media
        const sum = p.ratings.reduce((a, b) => a + b, 0);
        const mean = sum / p.ratings.length;

        // B. Desviaci√≥n Est√°ndar (Consistencia)
        let stdDev = 0;
        if (p.ratings.length > 1) {
            const squaredDiffs = p.ratings.map(r => Math.pow(r - mean, 2));
            const variance = squaredDiffs.reduce((a, b) => a + b, 0) / p.ratings.length;
            stdDev = Math.sqrt(variance);
        }

        // C. Color seg√∫n Consistencia
        let color = '#3b82f6'; // Azul (Normal)
        let status = 'Normal';

        if (stdDev < 0.5) {
            color = '#10b981'; // Verde (Muy Fiable)
            status = 'Roca üß±';
        } else if (stdDev > 1.2) {
            color = '#f43f5e'; // Rojo (Irregular)
            status = 'Monta√±a Rusa üé¢';
        }

        chartData.push({
            name: p.name,
            mean: parseFloat(mean.toFixed(2)),
            stdDev: parseFloat(stdDev.toFixed(2)),
            minutes: p.totalMinutes,
            color: color,
            status: status
        });
    });

    // 5. ORDENAR FINAL: Por NOTA MEDIA (Los mejores arriba)
    chartData.sort((a, b) => b.mean - a.mean);

    // 6. RENDERIZAR
    const ctx = document.getElementById('guaranteeChart');
    if (!ctx) return;

    if (guaranteeChartInstance) guaranteeChartInstance.destroy();

    guaranteeChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: chartData.map(d => d.name),
            datasets: [{
                label: 'Nota Media',
                data: chartData.map(d => d.mean),
                backgroundColor: chartData.map(d => d.color),
                borderRadius: 4,
                barPercentage: 0.7
            }]
        },
        options: {
            indexAxis: 'y', // Barras horizontales
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const d = chartData[context.dataIndex];
                            return `Nota Media: ${d.mean} (${d.status})`;
                        },
                        afterLabel: function(context) {
                            const d = chartData[context.dataIndex];
                            return `Minutos: ${d.minutes} | Variabilidad: ${d.stdDev}`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    min: 0,
                    max: 10, // Escala de nota 0-10
                    title: { display: true, text: 'Nota Media (Ranking Titulares)' },
                    grid: { color: '#f3f4f6' }
                },
                y: {
                    grid: { display: false },
                    ticks: { font: { weight: 'bold' } }
                }
            }
        }
    });
}
// ==========================================
// GR√ÅFICO: MAPA DE TALENTO (Opci√≥n B - Scatter)
// ==========================================

let qualityScatterChartInstance = null;

function renderQualityScatterChart() {
    console.log("üíé Generando Mapa de Talento (Quality vs Reliability)...");

    // 1. OBTENER DATOS
    let basePlayers = [];
    if (typeof getPlayers === 'function') basePlayers = getPlayers();
    else if (typeof window.players !== 'undefined') basePlayers = window.players;

    const matches = getData('matches') || [];

    if (basePlayers.length === 0 || matches.length === 0) return;

    // 2. PROCESAR NOTAS
    const statsMap = {};
    let maxMinutes = 0;

    matches.forEach(match => {
        if (!match.playerStats || !Array.isArray(match.playerStats)) return;

        match.playerStats.forEach(stat => {
            let rawRating = stat.rating;
            if (rawRating !== undefined && rawRating !== null && rawRating !== "") {
                let rating = parseFloat(String(rawRating).replace(',', '.'));
                let mins = parseInt(stat.minutes || 0);

                if (!isNaN(rating) && rating > 0 && mins > 0) {
                    if (!statsMap[stat.playerId]) {
                        statsMap[stat.playerId] = { 
                            name: '', // Lo rellenamos luego
                            ratings: [], 
                            totalMinutes: 0 
                        };
                    }
                    statsMap[stat.playerId].ratings.push(rating);
                    statsMap[stat.playerId].totalMinutes += mins;
                    
                    if (statsMap[stat.playerId].totalMinutes > maxMinutes) {
                        maxMinutes = statsMap[stat.playerId].totalMinutes;
                    }
                }
            }
        });
    });

    // 3. CALCULAR M√âTRICAS (Ejes X e Y)
    const chartData = [];
    const MIN_GAMES = 3; // M√≠nimo para ser estad√≠sticamente relevante

    basePlayers.forEach(p => {
        const data = statsMap[p.id];
        if (!data || data.ratings.length < MIN_GAMES) return;

        // A. Media (Eje X - Calidad)
        const sum = data.ratings.reduce((a, b) => a + b, 0);
        const mean = sum / data.ratings.length;

        // B. Desviaci√≥n Est√°ndar (Eje Y - Inestabilidad)
        const squaredDiffs = data.ratings.map(r => Math.pow(r - mean, 2));
        const variance = squaredDiffs.reduce((a, b) => a + b, 0) / data.ratings.length;
        const stdDev = Math.sqrt(variance);

        // C. Tama√±o Burbuja (Importancia)
        // Escalamos entre 5px y 25px
        const radius = 5 + ((data.totalMinutes / maxMinutes) * 20);

        // D. Color Inteligente
        let color = '#94a3b8'; // Gris (Normal)
        
        // ZONA MVP (Abajo Derecha): Nota alta (>7) y Muy Estable (<0.6)
        if (mean >= 7 && stdDev <= 0.6) color = '#10b981'; // Verde Esmeralda
        // ZONA PELIGRO (Arriba): Muy inestable (>1.2)
        else if (stdDev > 1.2) color = '#f43f5e'; // Rojo
        // ZONA CRACK (Derecha): Nota muy alta (>8) aunque sea algo inestable
        else if (mean >= 8) color = '#fbbf24'; // Dorado

        chartData.push({
            x: parseFloat(mean.toFixed(2)),   // Nota Media
            y: parseFloat(stdDev.toFixed(2)), // Inestabilidad
            r: radius,
            player: p.apodo || p.nombre,
            minutes: data.totalMinutes,
            rawColor: color
        });
    });

    if (chartData.length === 0) {
        console.log("‚ö†Ô∏è No hay suficientes datos para el mapa de talento.");
        return;
    }

    // 4. RENDERIZAR GR√ÅFICO
    const ctx = document.getElementById('qualityScatterChart');
    if (!ctx) return;

    if (qualityScatterChartInstance) qualityScatterChartInstance.destroy();

    qualityScatterChartInstance = new Chart(ctx, {
        type: 'bubble',
        data: {
            datasets: [{
                label: 'Jugadores',
                data: chartData,
                backgroundColor: function(context) {
                    return context.raw ? context.raw.rawColor : '#94a3b8';
                },
                borderColor: '#fff',
                borderWidth: 1,
                hoverBorderColor: '#1e293b',
                hoverBorderWidth: 2
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            layout: { padding: 20 },
            plugins: {
                legend: { display: false },
                tooltip: {
                    backgroundColor: 'rgba(15, 23, 42, 0.95)',
                    callbacks: {
                        label: function(context) {
                            return context.raw.player;
                        },
                        afterLabel: function(context) {
                            const d = context.raw;
                            return `‚≠ê Nota: ${d.x} | üìâ Var: ${d.y}\n‚è±Ô∏è ${d.minutes} mins`;
                        }
                    }
                },
                // Plugin simple para etiquetas de fondo
                quadrantLabels: true 
            },
            scales: {
                x: {
                    title: { display: true, text: 'Calidad (Nota Media) ‚û°Ô∏è', font: {weight:'bold'} },
                    min: 4,  // Empezamos en 4 para no desperdiciar espacio
                    max: 10, // Hasta 10
                    grid: { color: '#f1f5f9' }
                },
                y: {
                    title: { display: true, text: '‚¨áÔ∏è Estabilidad (Menos es mejor)', font: {weight:'bold'} },
                    min: 0,
                    // Invertimos visualmente el eje Y? No, mejor normal pero con etiqueta clara.
                    // Cuanto m√°s abajo (cerca de 0), mejor.
                    suggestedMax: 2.0,
                    grid: { color: '#f1f5f9' }
                }
            }
        },
        // PLUGIN: Etiquetas de Cuadrantes
        plugins: [{
            id: 'quadrantLabelsQuality',
            beforeDraw: (chart) => {
                const { ctx, chartArea: { top, bottom, left, right } } = chart;
                ctx.save();
                ctx.font = 'bold 11px sans-serif';
                ctx.fillStyle = 'rgba(148, 163, 184, 0.3)';
                ctx.textAlign = 'center';
                
                // Definimos zonas visuales
                // Abajo Derecha (MVP)
                ctx.fillText('MVP FIABLE', right - 40, bottom - 30);
                
                // Arriba Derecha (Genio Inestable)
                ctx.fillText('GENIO LOCO', right - 40, top + 30);
                
                // Abajo Izquierda (Cumplidor)
                ctx.fillText('CUMPLIDOR', left + 40, bottom - 30);
                
                ctx.restore();
            }
        }]
    });
}
window.switchConsistencyTab = function(tabName) {
    const btnRanking = document.getElementById('btn-ranking');
    const btnMapa = document.getElementById('btn-mapa');
    const viewRanking = document.getElementById('view-ranking');
    const viewMapa = document.getElementById('view-mapa');

    if (tabName === 'ranking') {
        // Activar Bot√≥n Ranking
        btnRanking.className = "px-3 py-1 text-xs font-bold rounded-md bg-white text-blue-600 shadow-sm transition-all";
        btnMapa.className = "px-3 py-1 text-xs font-bold rounded-md text-gray-500 hover:bg-gray-200 transition-all";
        
        // Mostrar Vista Ranking
        viewRanking.classList.remove('hidden');
        viewMapa.classList.add('hidden');
    } else {
        // Activar Bot√≥n Mapa
        btnMapa.className = "px-3 py-1 text-xs font-bold rounded-md bg-white text-blue-600 shadow-sm transition-all";
        btnRanking.className = "px-3 py-1 text-xs font-bold rounded-md text-gray-500 hover:bg-gray-200 transition-all";
        
        // Mostrar Vista Mapa
        viewMapa.classList.remove('hidden');
        viewRanking.classList.add('hidden');
    }
};
// ==========================================
// FUNCI√ìN MAESTRA DE RENDERIZADO
// ==========================================
function renderConsistencyWidget() {
    renderGuaranteeChart();     // Calcula y pinta el Ranking
    renderQualityScatterChart(); // Calcula y pinta el Mapa (aunque est√© oculto, se genera)
}
// ==========================================
// GR√ÅFICO: FACTOR X (Puntos Ganados)
// ==========================================

let factorXChartInstance = null;

function renderFactorXChart() {
    console.log("üé™ Calculando Factor X (Puntos Rescatados)...");

    // 1. OBTENER DATOS
    let basePlayers = [];
    if (typeof getPlayers === 'function') basePlayers = getPlayers();
    else if (typeof window.players !== 'undefined') basePlayers = window.players;

    const matches = getData('matches') || [];

    if (basePlayers.length === 0 || matches.length === 0) return;

    // 2. INICIALIZAR CONTADORES
    const pointsMap = {};
    basePlayers.forEach(p => {
        pointsMap[p.id] = {
            name: p.apodo || p.nombre,
            pointsWon: 0,
            decisiveGames: 0
        };
    });

    // 3. SIMULACI√ìN PARTIDO A PARTIDO
    matches.forEach(match => {
        // Validaciones b√°sicas
        if (!match.result || !match.result.includes('-')) return;
        if (!match.playerStats || !Array.isArray(match.playerStats)) return;

        // A. INTERPRETAR MARCADOR REAL (OPCI√ìN A: Local - Visitante)
        const parts = match.result.split('-');
        const scoreHome = parseInt(parts[0]);
        const scoreAway = parseInt(parts[1]);
        
        // Determinar qui√©n soy yo (Home o Away)
        // Buscamos 'Home' (o variantes) para saber si soy el local
        const loc = (match.location || '').toLowerCase();
        const isHome = loc === 'home' || loc === 'casa' || loc === 'local';

        const myRealGoals = isHome ? scoreHome : scoreAway;
        const oppRealGoals = isHome ? scoreAway : scoreHome;

        // Calcular Puntos Reales (3, 1, 0)
        let realPoints = 0;
        if (myRealGoals > oppRealGoals) realPoints = 3;
        else if (myRealGoals === oppRealGoals) realPoints = 1;

        // Si perdimos (0 puntos), ning√∫n jugador pudo "rescatar" nada (salvo evitar goleada, pero eso no da puntos)
        if (realPoints === 0) return;

        // B. SIMULAR AUSENCIA DE CADA JUGADOR
        match.playerStats.forEach(stat => {
            const pid = stat.playerId;
            if (!pointsMap[pid]) return;

            // Su contribuci√≥n en este partido
            const goals = parseInt(stat.goals || 0);
            const assists = parseInt(stat.assists || 0);
            const contribution = goals + assists;

            if (contribution > 0) {
                // RESTA MATEM√ÅTICA: ¬øQu√© pasa si quitamos sus goles/asistencias?
                // Nota: Restamos del marcador de MI equipo.
                let myHypoGoals = myRealGoals - contribution;
                
                // Seguridad: No podemos tener goles negativos
                if (myHypoGoals < 0) myHypoGoals = 0;

                // Calcular Puntos Hipot√©ticos
                let hypoPoints = 0;
                if (myHypoGoals > oppRealGoals) hypoPoints = 3;
                else if (myHypoGoals === oppRealGoals) hypoPoints = 1;

                // C. CALCULAR IMPACTO (Diferencia)
                const impact = realPoints - hypoPoints;

                if (impact > 0) {
                    pointsMap[pid].pointsWon += impact;
                    pointsMap[pid].decisiveGames += 1;
                }
            }
        });
    });

    // 4. FILTRAR Y ORDENAR
    let chartData = Object.values(pointsMap).filter(p => p.pointsWon > 0);

    // Ordenar de mayor a menor impacto
    chartData.sort((a, b) => b.pointsWon - a.pointsWon);

    // Top 10 para no saturar
    chartData = chartData.slice(0, 10);

    if (chartData.length === 0) {
        console.log("‚ö†Ô∏è Ning√∫n jugador ha cambiado el signo de un partido todav√≠a.");
        return;
    }

    // 5. RENDERIZAR GR√ÅFICO
    const ctx = document.getElementById('factorXChart');
    if (!ctx) return;

    if (factorXChartInstance) factorXChartInstance.destroy();

    // Crear degradado dorado para el MVP
    const gradientGold = ctx.getContext('2d').createLinearGradient(0, 0, 400, 0);
    gradientGold.addColorStop(0, '#f59e0b'); // Amber 500
    gradientGold.addColorStop(1, '#fbbf24'); // Amber 400

    factorXChartInstance = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: chartData.map(d => d.name),
            datasets: [{
                label: 'Puntos Ganados',
                data: chartData.map(d => d.pointsWon),
                backgroundColor: function(context) {
                    // El Top 1 va en Oro, el resto en azul o gris
                    const index = context.dataIndex;
                    if (index === 0) return gradientGold; // MVP
                    if (index === 1) return '#94a3b8'; // Plata (Gris)
                    if (index === 2) return '#b45309'; // Bronce
                    return '#3b82f6'; // Resto
                },
                borderRadius: 4,
                barPercentage: 0.7
            }]
        },
        options: {
            indexAxis: 'y', // Barras horizontales
            responsive: true,
            maintainAspectRatio: false,
            plugins: {
                legend: { display: false },
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            const d = chartData[context.dataIndex];
                            return `Impacto: +${d.pointsWon} Puntos`;
                        },
                        afterLabel: function(context) {
                            const d = chartData[context.dataIndex];
                            return `Decisivo en ${d.decisiveGames} partidos`;
                        }
                    }
                }
            },
            scales: {
                x: {
                    beginAtZero: true,
                    title: { display: true, text: 'Puntos directos a la clasificaci√≥n' },
                    grid: { borderDash: [2, 2] },
                    ticks: { stepSize: 1 }
                },
                y: {
                    grid: { display: false },
                    ticks: { font: { weight: 'bold' } }
                }
            }
        }
    });
}
// ==========================================
// GR√ÅFICO: DIANA DE GOLES (Corregido)
// ==========================================

let playerTargetChartInstance = null;

function renderPlayerTargetChart(playerId) {
    console.log(`üéØ Generando Diana de Goles para ${playerId}...`);

    const matches = getData('matches') || [];
    if (matches.length === 0) return;

    const stats = { right: 0, left: 0, head: 0, penalty: 0, other: 0 };
    let totalGoalsAnalyzed = 0;

    matches.forEach(match => {
        if (!match.playerStats) return;
        const pStat = match.playerStats.find(p => p.playerId === playerId);

        if (pStat && pStat.detailGoalTypes && Array.isArray(pStat.detailGoalTypes)) {
            pStat.detailGoalTypes.forEach(goal => {
                if (!goal.tags) return;
                const tags = goal.tags.map(t => t.toLowerCase());

                if (tags.some(t => t.includes('penal'))) stats.penalty++;
                else if (tags.some(t => t.includes('cabeza'))) stats.head++;
                else if (tags.some(t => t.includes('derecho'))) stats.right++;
                else if (tags.some(t => t.includes('izquierdo') || t.includes('zurda'))) stats.left++;
                else stats.other++;
                
                totalGoalsAnalyzed++;
            });
        }
    });

    if (totalGoalsAnalyzed === 0) {
        const legendDiv = document.getElementById('targetLegend');
        if (legendDiv) legendDiv.innerHTML = "<p class='text-xs text-gray-400'>Sin datos detallados</p>";
        return;
    }

    const chartData = {
        labels: ['Pie Derecho', 'Pie Izquierdo', 'Cabeza', 'Penalti', 'Otros'],
        data: [stats.right, stats.left, stats.head, stats.penalty, stats.other],
        colors: ['#3b82f6', '#f59e0b', '#10b981', '#ef4444', '#94a3b8']
    };

    const filteredLabels = [];
    const filteredData = [];
    const filteredColors = [];

    chartData.data.forEach((val, i) => {
        if (val > 0) {
            filteredLabels.push(chartData.labels[i]);
            filteredData.push(val);
            filteredColors.push(chartData.colors[i]);
        }
    });

    const ctx = document.getElementById('playerTargetChart');
    if (!ctx) return;
    if (playerTargetChartInstance) playerTargetChartInstance.destroy();

    playerTargetChartInstance = new Chart(ctx, {
        type: 'polarArea',
        data: {
            labels: filteredLabels,
            datasets: [{
                data: filteredData,
                backgroundColor: filteredColors,
                borderWidth: 2,
                borderColor: '#ffffff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
                r: {
                    ticks: { display: false },
                    grid: { color: '#f1f5f9' },
                    pointLabels: {
                        display: true,
                        centerPointLabels: true,
                        font: { size: 11, weight: 'bold' } // Etiquetas internas un poco m√°s grandes
                    }
                }
            },
            plugins: {
                // --- CAMBIO CLAVE: OCULTAMOS LA LEYENDA AUTOM√ÅTICA ---
                legend: { display: false }, 
                tooltip: {
                    callbacks: {
                        label: function(context) {
                            let val = context.raw;
                            let percentage = ((val / totalGoalsAnalyzed) * 100).toFixed(0);
                            return `${context.label}: ${val} (${percentage}%)`;
                        }
                    }
                }
            }
        }
    });
    
    // Rellenar Leyenda Manual (Debajo)
    const legendDiv = document.getElementById('targetLegend');
    if (legendDiv) {
        legendDiv.innerHTML = filteredLabels.map((label, i) => `
            <div class="flex items-center gap-2 bg-gray-50 px-3 py-1 rounded-full border">
                <span class="w-3 h-3 rounded-full" style="background-color: ${filteredColors[i]}"></span>
                <span class="font-bold">${filteredData[i]}</span> ${label}
            </div>
        `).join('');
    }
}
// ==========================================
// GR√ÅFICO: OLAS DE FORMA (Rondas Inteligentes)
// ==========================================

// Variable global para recordar pesta√±a activa
let currentWaveComp = 'Todas';

function renderFormWaves(targetComp = null) {
    console.log(`üåä Generando Olas de Forma... Filtro: ${targetComp || currentWaveComp}`);

    const container = document.getElementById('formHeatmapContainer');
    const tabsContainer = document.getElementById('wavesTabsContainer');
    
    if (!container || !tabsContainer) return;

    // 1. OBTENER DATOS
    let basePlayers = typeof getPlayers === 'function' ? getPlayers() : window.players;
    const matches = getData('matches') || [];

    if (!basePlayers || matches.length === 0) return;

    // 2. OBTENER SOLO PARTIDOS JUGADOS
    let playedMatches = matches
        .filter(m => m.outcome && m.outcome.trim() !== '')
        .sort((a, b) => new Date(a.date) - new Date(b.date));

    if (playedMatches.length === 0) {
        container.innerHTML = "<p class='text-center text-gray-400 py-4'>Sin partidos jugados.</p>";
        return;
    }

    // 3. GESTI√ìN DE PESTA√ëAS
    // Extraemos las competiciones disponibles
    const competitions = ['Todas', ...new Set(playedMatches.map(m => m.competition || 'Otras'))];

    if (targetComp) currentWaveComp = targetComp;

    // Renderizar Botones
    tabsContainer.innerHTML = competitions.map(comp => {
        const isActive = comp === currentWaveComp;
        const activeClass = "bg-slate-800 text-white shadow-md border-slate-800";
        const inactiveClass = "bg-white text-gray-500 hover:bg-gray-50 border-gray-200";
        
        return `
            <button onclick="renderFormWaves('${comp}')" 
                    class="px-3 py-1 text-xs font-bold rounded-full border transition-all whitespace-nowrap ${isActive ? activeClass : inactiveClass}">
                ${comp}
            </button>
        `;
    }).join('');

    // 4. FILTRAR PARTIDOS
    let matchesToShow = playedMatches;
    if (currentWaveComp !== 'Todas') {
        matchesToShow = playedMatches.filter(m => (m.competition || 'Otras') === currentWaveComp);
    }

    if (matchesToShow.length === 0) {
        container.innerHTML = "<p class='text-center text-gray-400 py-8'>No hay partidos en esta competici√≥n.</p>";
        return;
    }

    // 5. PREPARAR JUGADORES
    const playersWithMinutes = basePlayers.map(p => {
        let totalMins = 0;
        matchesToShow.forEach(m => {
            if (m.playerStats) {
                const stats = m.playerStats.find(s => s.playerId === p.id);
                if (stats) totalMins += parseInt(stats.minutes || 0);
            }
        });
        return { ...p, totalMinutes: totalMins };
    }).filter(p => p.totalMinutes > 30) // Umbral m√≠nimo minutos
      .sort((a, b) => b.totalMinutes - a.totalMinutes);

    // --- HELPER: GENERAR ETIQUETA DE COLUMNA ---
    const getRoundLabel = (match, index) => {
        const r = (match.round || '').toLowerCase();
        
        // 1. Si es Jornada (ej: "Jornada 14")
        if (r.includes('jornada')) {
            const num = r.match(/\d+/); // Busca el n√∫mero
            return num ? `J${num[0]}` : `J${index + 1}`;
        }
        
        // 2. Rondas de Copa/Champions
        if (r.includes('dieciseis')) return '16vos';
        if (r.includes('octavos')) return '8vos';
        if (r.includes('cuartos')) return '4tos';
        if (r.includes('semifinal') || r.includes('semi')) return 'Semi';
        if (r.includes('final')) return 'Final';
        if (r.includes('previa')) return 'Prev';
        if (r.includes('grupo')) return 'Grup';

        // 3. Fallback: Si no sabemos qu√© es, usamos contador secuencial
        return `J${index + 1}`;
    };

    // 6. CONSTRUIR HEADER (Aqu√≠ usamos la nueva l√≥gica)
    let html = `
        <table class="w-full border-collapse text-xs">
            <thead>
                <tr>
                    <th class="p-2 text-left bg-white sticky left-0 z-20 border-b border-gray-100 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)] min-w-[100px]">
                        Jugador
                    </th>
                    ${matchesToShow.map((m, i) => `
                        <th class="p-1 min-w-[45px] text-center text-gray-500 font-bold border-b border-gray-100" 
                            title="${m.round || 'Partido Oficial'} vs ${m.opponent} (${m.result})">
                            ${getRoundLabel(m, i)}
                        </th>
                    `).join('')}
                </tr>
            </thead>
            <tbody>
    `;

    // 7. GENERAR FILAS (Igual que antes)
    playersWithMinutes.forEach(p => {
        html += `
            <tr class="hover:bg-gray-50 transition-colors group">
                <td class="p-2 font-semibold text-gray-700 bg-white sticky left-0 z-10 border-r border-gray-100 shadow-[2px_0_5px_-2px_rgba(0,0,0,0.1)] whitespace-nowrap group-hover:bg-gray-50">
                    ${p.apodo || p.nombre}
                </td>
        `;

        matchesToShow.forEach(m => {
            const stats = m.playerStats ? m.playerStats.find(s => s.playerId === p.id) : null;
            
            let colorClass = 'bg-gray-100 text-gray-300';
            let textValue = '-';
            let tooltip = `vs ${m.opponent}: No jug√≥`;

            if (stats && parseInt(stats.minutes) > 0) {
                let rating = parseFloat(String(stats.rating || 0).replace(',', '.'));

                if (!isNaN(rating) && rating > 0) {
                    if (rating >= 9) colorClass = 'bg-emerald-600 text-white font-bold shadow-sm';
                    else if (rating >= 8) colorClass = 'bg-emerald-400 text-white font-bold';
                    else if (rating >= 7) colorClass = 'bg-blue-400 text-white';
                    else if (rating >= 6) colorClass = 'bg-yellow-300 text-slate-800';
                    else colorClass = 'bg-rose-400 text-white';

                    textValue = rating.toFixed(1);
                    tooltip = `${m.round || 'Partido'} vs ${m.opponent}\nNota: ${textValue}\nMinutos: ${stats.minutes}'`;
                } else {
                    textValue = 'SC';
                    colorClass = 'bg-gray-200 text-gray-500 text-[10px]';
                }
            }

            html += `
                <td class="p-1 border border-white">
                    <div class="w-10 h-8 mx-auto rounded flex items-center justify-center text-[10px] transition-transform hover:scale-110 cursor-help ${colorClass}" 
                         title="${tooltip}">
                        ${textValue}
                    </div>
                </td>
            `;
        });

        html += `</tr>`;
    });

    html += `</tbody></table>`;
    container.innerHTML = html;
}

function calcularProbabilidadTitularidad(jugador, numPartidos = 10) {
    const matches = getData('matches') || [];
    const partidosRecientes = matches.slice(-numPartidos);
    
    // 1. DATOS HIST√ìRICOS
    let titularidades = 0;
    let minutosTotales = 0;
    let minutosPosibles = 0;
    let rachaActual = 0; // partidos seguidos titular
    let rachaMaxima = 0;
    
    // Recorrer de m√°s antiguo a m√°s reciente para calcular rachas
    partidosRecientes.forEach((match, index) => {
        const stats = match.playerStats.find(ps => ps.playerId === jugador.id);
        
        if (stats) {
            const minutos = parseInt(stats.minutes) || 0;
            const esTitular = minutos >= 45; // Umbral: jug√≥ 1¬™ parte
            
            minutosTotales += minutos;
            minutosPosibles += 90;
            
            if (esTitular) {
                titularidades++;
                rachaActual++;
                rachaMaxima = Math.max(rachaMaxima, rachaActual);
            } else {
                rachaActual = 0;
            }
        } else {
            // No convocado = racha rota
            rachaActual = 0;
        }
    });
    
    // 2. FACTORES DE PESO
    
    // A. Frecuencia base (% de veces titular)
    const frecuenciaBase = (titularidades / partidosRecientes.length) * 100;
    
    // B. Peso por minutos (importancia real)
    const pesoMinutos = (minutosTotales / minutosPosibles) * 100;
    
    // C. Factor racha (momentum)
    // Si lleva 3+ seguidos, aumenta probabilidad
    let factorRacha = 0;
    if (rachaActual >= 5) factorRacha = 15;
    else if (rachaActual >= 3) factorRacha = 10;
    else if (rachaActual >= 1) factorRacha = 5;
    else if (rachaMaxima > 0) factorRacha = -10; // Rot√≥ recientemente
    
    // D. Factor estado f√≠sico (lesiones)
    const ultimoPartido = partidosRecientes[partidosRecientes.length - 1];
    const statsUltimo = ultimoPartido?.playerStats.find(ps => ps.playerId === jugador.id);
    const minutosUltimo = statsUltimo ? parseInt(statsUltimo.minutes) : 0;
    
    let factorFisico = 0;
    if (!statsUltimo) factorFisico = -20; // No convocado √∫ltimo = duda
    else if (minutosUltimo < 20) factorFisico = -10; // Entr√≥ al final = gesti√≥n
    
    // E. Factor posici√≥n (rotaci√≥n natural)
    // Algunas posiciones rotan m√°s
    const posicion = jugador.posicion;
    let factorPosicion = 0;
    if (posicion === 'portero') factorPosicion = 10; // Portero fijo
    else if (posicion === 'defensa') factorPosicion = 0;
    else if (posicion === 'centrocampista') factorPosicion = -5; // Mucha competencia
    else if (posicion === 'extremo' || posicion === 'delantero') factorPosicion = -5;
    
    // 3. C√ÅLCULO FINAL
    const probabilidadBruta = (
        (frecuenciaBase * 0.4) +      // 40% hist√≥rico
        (pesoMinutos * 0.3) +          // 30% minutos reales
        factorRacha +                  // 15% momentum
        factorFisico +                 // 10% estado
        factorPosicion                 // 5% posici√≥n
    );
    
    // Ajustar a rango 0-100
    const probabilidad = Math.max(0, Math.min(100, probabilidadBruta));
    
    // 4. CONFIDENZA DEL C√ÅLCULO
    let confianza;
    if (partidosRecientes.length >= 8) confianza = 'Alta';
    else if (partidosRecientes.length >= 5) confianza = 'Media';
    else confianza = 'Baja (pocos datos)';
    
    // 5. INTERPRETACI√ìN
    let categoria, color, emoji;
    if (probabilidad >= 85) {
        categoria = 'Titular casi seguro';
        color = 'emerald';
        emoji = 'üîí';
    } else if (probabilidad >= 60) {
        categoria = 'Favorito';
        color = 'blue';
        emoji = 'üëç';
    } else if (probabilidad >= 40) {
        categoria = 'Duda / Rotaci√≥n';
        color = 'yellow';
        emoji = 'ü§î';
    } else if (probabilidad >= 20) {
        categoria = 'Suplente probable';
        color = 'orange';
        emoji = 'ü™ë';
    } else {
        categoria = 'Descartado';
        color = 'red';
        emoji = '‚ùå';
    }
    
    return {
        nombre: jugador.apodo,
        probabilidad: Math.round(probabilidad),
        frecuenciaBase: Math.round(frecuenciaBase),
        pesoMinutos: Math.round(pesoMinutos),
        rachaActual,
        factorRacha,
        factorFisico,
        categoria,
        color,
        emoji,
        confianza,
        partidosAnalizados: partidosRecientes.length
    };
}
// ==========================================
// WIDGET DASHBOARD: EL 11 PROBABLE (CORREGIDO)
// ==========================================

function renderProbableLineupWidget() {
    console.log("üîÆ Generando el 11 m√°s probable (Correcci√≥n NaN)...");

    const container = document.getElementById('probableLineupContainer');
    if (!container) return;

    // 1. OBTENER DATOS
    let allPlayers = typeof getPlayers === 'function' ? getPlayers() : window.players;
    
    if (!allPlayers || allPlayers.length === 0) {
        container.innerHTML = "<div class='p-4 text-center text-gray-400 text-xs'>Sin jugadores disponibles</div>";
        return;
    }

    // 2. FILTRAR Y CALCULAR
    // Quitamos entrenadores
    const playersOnly = allPlayers.filter(p => p.dorsal !== 'DT' && p.posicion !== 'Entrenador');

    // Calculamos probabilidad y SANITIZAMOS (Corregimos el NaN)
    const squadProbs = playersOnly.map(p => {
        let prob = 0;
        
        if (typeof calcularProbabilidadTitularidad === 'function') {
            const calc = calcularProbabilidadTitularidad(p, 10);
            
            // --- AQU√ç EST√Å EL ARREGLO ---
            // Si devuelve NaN, null o undefined, forzamos a 0
            if (calc && !isNaN(calc.probabilidad) && calc.probabilidad !== null) {
                prob = calc.probabilidad;
            } else {
                prob = 0; 
            }
        }

        return { ...p, probabilidad: prob }; 
    });

    // 3. ORDENAR Y CORTAR (TOP 11)
    // Orden descendente estricto
    squadProbs.sort((a, b) => b.probabilidad - a.probabilidad);

    // Nos quedamos SOLO con los 11 mejores
    // (Ojo: si todos son 0, coger√° a los 11 primeros por orden de lista)
    const startingXI = squadProbs.slice(0, 11);

    // 4. GENERAR HTML
    let html = `
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-full flex flex-col">
            <div class="flex justify-between items-center mb-5 pb-2 border-b border-gray-100">
                <h3 class="font-bold text-gray-800 text-lg flex items-center gap-2">
                    üõ°Ô∏è Alineaci√≥n Probable
                </h3>
                <span class="text-[10px] bg-slate-100 text-slate-500 px-2 py-1 rounded-full font-bold uppercase tracking-wide">
                    Top 11
                </span>
            </div>

            <div class="space-y-3 overflow-y-auto pr-1 custom-scrollbar">
    `;

    if (startingXI.length === 0) {
        html += `<p class="text-center text-gray-400 text-sm py-4">Faltan datos de partidos.</p>`;
    } else {
        startingXI.forEach((p, index) => {
            // Colores din√°micos
            let barColor = 'bg-gray-300';
            let percentColor = 'text-gray-400';

            // L√≥gica de colores sem√°foro
            if (p.probabilidad >= 90) { barColor = 'bg-emerald-500'; percentColor = 'text-emerald-600 font-bold'; }
            else if (p.probabilidad >= 70) { barColor = 'bg-blue-500'; percentColor = 'text-blue-600 font-bold'; }
            else if (p.probabilidad >= 50) { barColor = 'bg-amber-400'; percentColor = 'text-amber-600'; }
            else if (p.probabilidad > 0) { barColor = 'bg-rose-400'; percentColor = 'text-rose-600'; }
            else { 
                // Si es 0% (El caso de Lunin ahora)
                barColor = 'bg-gray-200'; 
                percentColor = 'text-gray-300'; 
            }

            html += `
                <div class="flex items-center justify-between p-2 rounded-lg hover:bg-slate-50 transition-all group border border-transparent hover:border-slate-100">
                    
                    <div class="flex items-center gap-3">
                        <span class="text-xs font-mono font-bold text-slate-300 w-5 text-center group-hover:text-slate-500">
                            ${index + 1}
                        </span>

                        <div class="w-9 h-9 rounded-full bg-white border border-gray-200 overflow-hidden shadow-sm relative">
                            <img src="${p.foto}" 
                                 class="w-full h-full object-cover" 
                                 onerror="this.src='https://via.placeholder.com/150?text=Player'">
                        </div>

                        <div class="leading-tight">
                            <div class="font-bold text-gray-700 text-sm">
                                ${p.apodo || p.nombre}
                            </div>
                            <div class="text-[10px] text-gray-400 uppercase tracking-wide">
                                ${p.posicion || 'Jugador'}
                            </div>
                        </div>
                    </div>

                    <div class="flex flex-col items-end w-24">
                        <span class="text-xs ${percentColor}">${p.probabilidad}%</span>
                        <div class="w-full bg-gray-100 rounded-full h-1.5 mt-1 overflow-hidden">
                            <div class="${barColor} h-full rounded-full transition-all duration-1000" 
                                 style="width: ${p.probabilidad}%"></div>
                        </div>
                    </div>

                </div>
            `;
        });
    }

    html += `
            </div>
            
            <div class="mt-auto pt-3 text-center">
                <p class="text-[10px] text-gray-300">
                    Basado en minutos, racha y estado f√≠sico.
                </p>
            </div>
        </div>
    `;

    container.innerHTML = html;
}
// ==========================================
// SINCRONIZADOR DE RONDAS EXTRAS (PUENTE)
// ==========================================
function syncExtraRounds() {
    console.log("üîÑ Sincronizando rondas extras desde la base de datos...");

    // 1. OBTENER EL ESTADO GUARDADO (LocalStorage o Firebase)
    // Usamos tu funci√≥n existente que ya sabe si es masculino o femenino
    const state = typeof getCompetitionState === 'function' ? getCompetitionState() : {};

    if (!state) return;

    // 2. RECORRER COMPETICIONES EN LA CONFIGURACI√ìN
    // (Aseg√∫rate de que COMPETICIONES_ACTUALES es accesible globalmente)
    if (typeof COMPETICIONES_ACTUALES === 'undefined') return;

    Object.keys(COMPETICIONES_ACTUALES).forEach(compName => {
        const compConfig = COMPETICIONES_ACTUALES[compName];
        const savedState = state[compName]; // Ejemplo: { playsExtra: true }

        // Si existe un estado guardado y dice que S√ç se juega la extra...
        if (savedState && savedState.playsExtra === true) {
            
            // ...buscamos la ronda oculta dentro de la configuraci√≥n y la mostramos
            if (compConfig.fases) {
                compConfig.fases.forEach(fase => {
                    if (fase.rondas) {
                        fase.rondas.forEach(ronda => {
                            // SI LA RONDA EST√Å OCULTA, LA DESBLOQUEAMOS
                            if (ronda.oculto === true) {
                                console.log(`üîì Desbloqueando ronda extra: ${ronda.nombre} en ${compName}`);
                                ronda.oculto = false;       // Clave para que salga en el men√∫
                                ronda.status = 'available'; // Clave para el icono üü¢
                            }
                        });
                    }
                });
            }
        }
    });
}
// ==========================================
// WIDGET: ZONA DE CONFORT (POSICIONES)
// ==========================================
function getComfortZoneHTML(player, matches) {
    // 1. DEFINICI√ìN DE ROLES POR FORMACI√ìN (Tu mapa exacto convertido a siglas)
    const FORMATION_SLOTS = {
        '4-3-3': ['POR', 'LI', 'DFC', 'DFC', 'LD', 'MCD', 'MC', 'MC', 'EI', 'DC', 'ED'],
        '4-4-2': ['POR', 'LI', 'DFC', 'DFC', 'LD', 'EI', 'MC', 'MC', 'ED', 'DC', 'DC'],
        '4-2-3-1': ['POR', 'LI', 'DFC', 'DFC', 'LD', 'MCD', 'MCD', 'EI', 'MCO', 'ED', 'DC'],
        '3-5-2': ['POR', 'DFC', 'DFC', 'DFC', 'LI', 'MCD', 'LD', 'MC', 'MC', 'DC', 'DC']
    };

    // Colores para cada posici√≥n (Est√©tica)
    const POS_COLORS = {
        'POR': 'bg-gray-500',
        'LI': 'bg-blue-400', 'LD': 'bg-blue-400', 'DFC': 'bg-blue-600',
        'MCD': 'bg-amber-600', 'MC': 'bg-amber-400', 'MCO': 'bg-amber-300',
        'EI': 'bg-emerald-400', 'ED': 'bg-emerald-400', 'DC': 'bg-emerald-600'
    };

    // 2. PROCESAR DATOS
    let positionStats = {};
    let totalMinutesAnalyzed = 0;

    // Filtramos partidos jugados por el jugador
    matches.filter(m => m.outcome).forEach(m => {
        const stats = m.playerStats ? m.playerStats.find(s => s.playerId === player.id) : null;
        
        // Solo analizamos si jug√≥ y si tenemos datos de su posici√≥n (pitchSlot)
        // Nota: Los suplentes a veces no tienen pitchSlot si no se gestion√≥ en la pizarra.
        // Si stats.pitchSlot es null, no podemos adivinar d√≥nde jug√≥, as√≠ que lo ignoramos para este gr√°fico.
        if (stats && stats.minutes > 0 && stats.pitchSlot !== undefined && stats.pitchSlot !== null) {
            
            const formation = m.formation || '4-3-3';
            const schema = FORMATION_SLOTS[formation];
            
            if (schema && schema[stats.pitchSlot]) {
                const role = schema[stats.pitchSlot];
                const mins = parseInt(stats.minutes);

                if (!positionStats[role]) positionStats[role] = 0;
                positionStats[role] += mins;
                totalMinutesAnalyzed += mins;
            }
        }
    });

    if (totalMinutesAnalyzed === 0) return ''; // No hay datos suficientes

    // 3. ORDENAR Y CALCULAR PORCENTAJES
    // Convertimos el objeto a array para ordenar
    const sortedPositions = Object.entries(positionStats)
        .map(([role, mins]) => ({
            role,
            mins,
            percent: (mins / totalMinutesAnalyzed) * 100
        }))
        .sort((a, b) => b.mins - a.mins); // Ordenar de mayor a menor uso

    // Detectar Polivalencia
    const uniquePositions = sortedPositions.length;
    let polyLabel = '';
    if (uniquePositions >= 3) polyLabel = '<span class="text-[10px] bg-purple-100 text-purple-600 px-1.5 py-0.5 rounded border border-purple-200">Polivalente</span>';

    // 4. GENERAR HTML
    let barsHTML = '';
    let legendHTML = '';

    sortedPositions.forEach(pos => {
        const colorClass = POS_COLORS[pos.role] || 'bg-gray-400';
        const percentFixed = pos.percent.toFixed(1);
        
        // Barra segmentada (La parte visual "Scatter")
        barsHTML += `
            <div class="h-full ${colorClass} first:rounded-l-md last:rounded-r-md border-r border-white/20 relative group hover:opacity-90 transition-opacity" 
                 style="width: ${pos.percent}%"
                 title="${pos.role}: ${percentFixed}% (${pos.mins}')">
            </div>
        `;

        // Leyenda debajo
        legendHTML += `
            <div class="flex items-center gap-1.5 min-w-[30%] mb-1">
                <div class="w-2 h-2 rounded-full ${colorClass}"></div>
                <div class="text-xs text-gray-600 font-bold w-8">${pos.role}</div>
                <div class="text-xs text-gray-400">${Math.round(pos.percent)}%</div>
            </div>
        `;
    });

    return `
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mt-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-gray-800 text-lg flex items-center gap-2">
                    üéØ Zona de Confort
                </h3>
                ${polyLabel}
            </div>

            <div class="mb-3 text-xs text-gray-500">
                Posici√≥n Natural: <span class="font-bold text-gray-800">${player.posicion || 'N/A'}</span>
                ${sortedPositions[0].role !== player.posicion ? 
                    `vs Realidad: <strong class="text-emerald-600">${sortedPositions[0].role}</strong>` : 
                    '<span class="text-emerald-500">‚úî Coincide</span>'}
            </div>

            <div class="w-full h-6 flex rounded-md overflow-hidden bg-gray-100 mb-4 shadow-inner">
                ${barsHTML}
            </div>

            <div class="flex flex-wrap gap-x-4">
                ${legendHTML}
            </div>
            
            <div class="mt-2 text-[10px] text-gray-400 text-center">
                Basado en ${totalMinutesAnalyzed} minutos analizados en pizarra.
            </div>
        </div>
    `;
}
function getConnectionsData(matches) {
    const connections = {}; // Clave: "ID_Asistente|ID_Goleador", Valor: conteo
    const playerTotals = {}; // Para saber qui√©nes son los m√°s relevantes y pintarlos en el c√≠rculo

    matches.forEach(m => {
        if (!m.playerStats) return;

        // 1. Separar Goles y Asistencias del partido
        const goals = [];
        const assists = [];

        m.playerStats.forEach(ps => {
            // Extraer minutos de los goles
            if (ps.detailGoals) {
                const minutes = ps.detailGoals.split(',').map(t => parseInt(t.trim())).filter(n => !isNaN(n));
                minutes.forEach(min => goals.push({ playerId: ps.playerId, minute: min }));
            }
            // Extraer minutos de las asistencias
            if (ps.detailAssists) {
                const minutes = ps.detailAssists.split(',').map(t => parseInt(t.trim())).filter(n => !isNaN(n));
                minutes.forEach(min => assists.push({ playerId: ps.playerId, minute: min }));
            }
        });

        // 2. CRUZAR POR MINUTO (Margen de error +/- 1 minuto por si acaso)
        goals.forEach(g => {
            const assist = assists.find(a => Math.abs(a.minute - g.minute) <= 1 && a.playerId !== g.playerId);
            
            if (assist) {
                // ¬°CONEXI√ìN ENCONTRADA!
                const key = `${assist.playerId}|${g.playerId}`;
                if (!connections[key]) connections[key] = 0;
                connections[key]++;

                // Sumar relevancia para el ranking
                playerTotals[assist.playerId] = (playerTotals[assist.playerId] || 0) + 1;
                playerTotals[g.playerId] = (playerTotals[g.playerId] || 0) + 1;
            }
        });
    });

    return { connections, playerTotals };
}
function renderNetworkWidget() {
    console.log("üï∏Ô∏è Generando Mapa de Conexiones...");
    const container = document.getElementById('networkMapContainer');
    if (!container) return;

    const matches = getData('matches') || [];
    const allPlayers = getPlayers();
    const { connections, playerTotals } = getConnectionsData(matches);

    const topPlayerIds = Object.keys(playerTotals)
        .sort((a, b) => playerTotals[b] - playerTotals[a])
        .slice(0, 6);

    if (topPlayerIds.length < 2) {
        container.innerHTML = "<p class='text-gray-400 text-center py-10'>Faltan datos de asistencias por minuto.</p>";
        return;
    }

    const size = 450;
    const cx = size / 2;
    const cy = size / 2;
    const radius = 160;

    // Calcular posiciones
    const coords = {};
    topPlayerIds.forEach((pid, index) => {
        const angle = (index / topPlayerIds.length) * 2 * Math.PI - (Math.PI / 2);
        coords[pid] = {
            x: cx + radius * Math.cos(angle),
            y: cy + radius * Math.sin(angle),
            angle
        };
    });

    // Helper: punto en curva B√©zier
    function getQuadraticPoint(t, p0, p1, p2) {
        const x = (1-t)*(1-t)*p0.x + 2*(1-t)*t*p1.x + t*t*p2.x;
        const y = (1-t)*(1-t)*p0.y + 2*(1-t)*t*p1.y + t*t*p2.y;
        return {x, y};
    }

    // DEFS con flechas
    const defs = `
        <defs>
            <marker id="arrow-gray" markerWidth="12" markerHeight="12" 
                    refX="10" refY="6" orient="auto" markerUnits="strokeWidth">
                <path d="M0,0 L0,12 L12,6 z" fill="#94a3b8" />
            </marker>
            <marker id="arrow-blue" markerWidth="12" markerHeight="12" 
                    refX="10" refY="6" orient="auto" markerUnits="strokeWidth">
                <path d="M0,0 L0,12 L12,6 z" fill="#3b82f6" />
            </marker>
        </defs>
    `;

    // Generar conexiones con curvas y flechas
    let linesSVG = '';

    Object.entries(connections).forEach(([key, count]) => {
        const [fromId, toId] = key.split('|');
        
        if (!coords[fromId] || !coords[toId]) return;

        const start = coords[fromId];
        const end = coords[toId];
        
        // Detectar si hay conexi√≥n inversa (para separar arcos)
        const reverseKey = `${toId}|${fromId}`;
        const hasReverse = connections[reverseKey];
        
        let curvature = 0.3;
        if (hasReverse) {
            curvature = 0.5;
            if (fromId > toId) curvature = -0.5; // Arco opuesto
        }

        const midX = (start.x + end.x) / 2;
        const midY = (start.y + end.y) / 2;
        const dx = end.x - start.x;
        const dy = end.y - start.y;
        const controlX = midX - dy * curvature;
        const controlY = midY + dx * curvature;

        const strokeWidth = Math.min(2 + count * 0.8, 6);
        const isStrong = count >= 3;
        const color = isStrong ? '#3b82f6' : '#94a3b8';
        const opacity = isStrong ? 0.9 : 0.6;
        const markerId = isStrong ? 'url(#arrow-blue)' : 'url(#arrow-gray)';

        // Punto para etiqueta (60% del camino)
        const labelPos = getQuadraticPoint(0.6, start, {x: controlX, y: controlY}, end);

        // Ajustar punto final para que la flecha no tape la foto
        const angleEnd = Math.atan2(end.y - controlY, end.x - controlX);
        const endX = end.x - 36 * Math.cos(angleEnd);
        const endY = end.y - 36 * Math.sin(angleEnd);

        linesSVG += `
            <path d="M ${start.x} ${start.y} Q ${controlX} ${controlY} ${endX} ${endY}" 
                  stroke="${color}" 
                  stroke-width="${strokeWidth}" 
                  fill="none"
                  opacity="${opacity}"
                  stroke-linecap="round"
                  marker-end="${markerId}" />
            
            <!-- C√≠rculo blanco con n√∫mero -->
            <circle cx="${labelPos.x}" cy="${labelPos.y}" r="14" 
                    fill="white" stroke="${color}" stroke-width="2"/>
            <text x="${labelPos.x}" y="${labelPos.y + 4}" 
                  text-anchor="middle" font-size="12" font-weight="bold" 
                  fill="${color}">
                ${count}
            </text>
        `;
    });

    // Fondo decorativo
    const bgSVG = `
        <circle cx="${cx}" cy="${cy}" r="${radius}" 
                fill="none" stroke="#e2e8f0" stroke-width="1" stroke-dasharray="4,4"/>
        <circle cx="${cx}" cy="${cy}" r="${radius * 0.6}" 
                fill="#f8fafc" opacity="0.3"/>
    `;

    // Nodos (fotos)
    let nodesHTML = '';
    topPlayerIds.forEach(pid => {
        const p = allPlayers.find(pl => pl.id === pid);
        const { x, y } = coords[pid];
        const total = playerTotals[pid];
        
        nodesHTML += `
            <div class="absolute w-16 h-16 rounded-full border-4 border-white shadow-xl 
                        bg-gray-100 flex items-center justify-center z-20 
                        hover:scale-115 hover:z-30 transition-all duration-200 
                        group cursor-pointer" 
                 style="left: ${x - 32}px; top: ${y - 32}px;">
                
                <img src="${p.foto}" class="w-full h-full rounded-full object-cover">
                
                <div class="absolute -top-2 -right-2 min-w-[24px] h-6 px-1.5 
                            bg-gradient-to-br from-blue-500 to-blue-600 text-white 
                            text-xs font-bold rounded-full flex items-center justify-center
                            border-2 border-white shadow-md">
                    ${total}
                </div>
                
                <div class="absolute -bottom-8 opacity-0 group-hover:opacity-100 
                            transition-opacity bg-slate-800 text-white text-xs 
                            font-bold px-3 py-1.5 rounded-lg shadow-lg whitespace-nowrap
                            pointer-events-none">
                    ${p.apodo}
                    <div class="absolute -top-1 left-1/2 -translate-x-1/2 
                                w-2 h-2 bg-slate-800 rotate-45"></div>
                </div>
            </div>
        `;
    });

    const totalConnections = Object.values(connections).reduce((a,b) => a+b, 0);

    container.innerHTML = `
        <div class="bg-white p-6 rounded-2xl shadow-sm border border-gray-100">
            <div class="flex justify-between items-center mb-4">
                <h3 class="font-bold text-gray-800 text-lg flex items-center gap-2">
                    üï∏Ô∏è Mapa de Conexiones
                    <span class="text-xs font-normal text-gray-500 bg-gray-100 
                                 px-2.5 py-1 rounded-full">
                        Top ${topPlayerIds.length} Socios
                    </span>
                </h3>
                <span class="text-sm text-gray-400">${totalConnections} pases de gol</span>
            </div>
            
            <div class="relative mx-auto" style="width: ${size}px; height: ${size}px;">
                <svg width="${size}" height="${size}" class="absolute inset-0 z-0">
                    ${defs}
                    ${bgSVG}
                    ${linesSVG}
                </svg>
                ${nodesHTML}
            </div>

            <div class="mt-4 flex justify-center gap-6 text-xs">
                <div class="flex items-center gap-2">
                    <span class="w-6 h-1 bg-gray-400 rounded-full"></span>
                    <span class="text-gray-500">1-2 asistencias</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="w-6 h-2 bg-blue-500 rounded-full"></span>
                    <span class="text-gray-500">3+ asistencias</span>
                </div>
                <div class="flex items-center gap-2">
                    <span class="text-gray-500">‚Üí</span>
                    <span class="text-gray-500">direcci√≥n del pase</span>
                </div>
            </div>
            
            <p class="mt-3 text-[10px] text-gray-400 text-center">
                Conexi√≥n confirmada por coincidencia de minuto (Gol/Asistencia)
            </p>
        </div>
    `;
}
// Variable para recordar la pesta√±a activa
let activeConnectionTab = 'lista'; 

function renderUnifiedConnections() {
    const container = document.getElementById('unified-connections-wrapper');
    if (!container) return;

    const isList = activeConnectionTab === 'lista';
    // Estilos de botones
    const btnActive = "bg-slate-800 text-white shadow-md font-bold";
    const btnInactive = "text-gray-500 hover:text-gray-700 font-medium hover:bg-gray-100";

   container.innerHTML = `
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 flex flex-col h-auto min-h-[520px] transition-all duration-300">
            
            <div class="flex justify-between items-center mb-6 pb-4 border-b border-gray-50 shrink-0">
                <h3 class="font-bold text-gray-800 text-lg flex items-center gap-2">
                    üîó Conexiones <span class="text-xs font-normal text-gray-400 hidden sm:inline">(Asistente ‚ûî Goleador)</span>
                </h3>
                
                <div class="flex bg-gray-100 rounded-lg p-1 gap-1">
                    <button onclick="toggleConnectionTab('lista')" 
                            class="px-4 py-1.5 rounded-md text-xs transition-all ${isList ? btnActive : btnInactive}">
                        üìã Lista
                    </button>
                    <button onclick="toggleConnectionTab('mapa')" 
                            class="px-4 py-1.5 rounded-md text-xs transition-all ${!isList ? btnActive : btnInactive}">
                        üï∏Ô∏è Mapa
                    </button>
                </div>
            </div>

            <div id="connections-content-area" class="flex-1 w-full relative">
            </div>
            
            ${!isList ? '<div class="mt-4 text-[10px] text-gray-400 text-center italic shrink-0">* Grosor = Cantidad de asistencias</div>' : ''}
        </div>
    `;

    // 2. INYECTAR EL CONTENIDO
    const contentArea = document.getElementById('connections-content-area');
    
    if (activeConnectionTab === 'lista') {
        // --- VISTA LISTA ---
        // La lista ocupa todo el ancho y empieza arriba
        contentArea.innerHTML = '<div id="goal-connections-container" class="w-full h-full"></div>';
        
        if (typeof renderGoalConnections === 'function') {
            renderGoalConnections(); // Esta funci√≥n ya inyecta su propio bot√≥n toggle dentro
        } else {
            contentArea.innerHTML = "<p class='text-gray-400 text-xs'>Cargando lista...</p>";
        }

    } else {
        // --- VISTA MAPA ---
        // Al mapa S√ç le damos centrado vertical y horizontal expl√≠citamente aqu√≠
        contentArea.innerHTML = '<div id="networkMapContainer" class="w-full h-full flex justify-center items-center"></div>';
        
        if (typeof renderNetworkWidget === 'function') {
            renderNetworkWidget();
        } else {
            contentArea.innerHTML = "<p class='text-gray-400 text-xs'>Cargando mapa...</p>";
        }
    }
}

function toggleConnectionTab(tabName) {
    activeConnectionTab = tabName;
    renderUnifiedConnections();
}
// ==========================================
// WIDGET: RADAR DE POLIVALENCIA T√ÅCTICA (SVG)
// ==========================================
function getTacticalRadarHTML(player, matches) {
    // 1. DEFINICI√ìN DE ROLES (Reutilizamos la l√≥gica de Zona de Confort)
    const FORMATION_SLOTS = {
        '4-3-3': ['POR', 'LI', 'DFC', 'DFC', 'LD', 'MCD', 'MC', 'MC', 'EI', 'DC', 'ED'],
        '4-4-2': ['POR', 'LI', 'DFC', 'DFC', 'LD', 'EI', 'MC', 'MC', 'ED', 'DC', 'DC'],
        '4-2-3-1': ['POR', 'LI', 'DFC', 'DFC', 'LD', 'MCD', 'MCD', 'EI', 'MCO', 'ED', 'DC'],
        '3-5-2': ['POR', 'DFC', 'DFC', 'DFC', 'LI', 'MCD', 'LD', 'MC', 'MC', 'DC', 'DC']
    };

    // Orden l√≥gico para el radar (Sentido agujas del reloj: Portero -> Def -> Med -> Del)
    const ROLE_ORDER = ['POR', 'LD', 'DFC', 'LI', 'MCD', 'MC', 'MCO', 'ED', 'EI', 'DC'];

    // 2. PROCESAR DATOS: Calcular Nota Media por Posici√≥n
    let roleStats = {}; // { 'MC': { sumRating: 15, count: 2 }, ... }

    matches.filter(m => m.outcome).forEach(m => {
        const stats = m.playerStats ? m.playerStats.find(s => s.playerId === player.id) : null;
        
        // Solo contamos si jug√≥ y tiene valoraci√≥n (Rating)
        if (stats && stats.minutes > 0 && stats.rating && stats.pitchSlot !== undefined) {
            const formation = m.formation || '4-3-3';
            const schema = FORMATION_SLOTS[formation];
            
            if (schema && schema[stats.pitchSlot]) {
                const role = schema[stats.pitchSlot];
                const rating = parseFloat(stats.rating);

                if (!roleStats[role]) roleStats[role] = { sum: 0, count: 0 };
                roleStats[role].sum += rating;
                roleStats[role].count++;
            }
        }
    });

    // Convertir a array de datos finales
    let dataPoints = Object.keys(roleStats).map(role => {
        return {
            role: role,
            avg: (roleStats[role].sum / roleStats[role].count).toFixed(1),
            count: roleStats[role].count
        };
    });

    // Si no ha jugado, no mostramos nada
    if (dataPoints.length === 0) return '';

    // ORDENAR: Usamos ROLE_ORDER para que el gr√°fico tenga sentido t√°ctico
    // (Ej: Que LI y LD no est√©n opuestos si queremos ver defensa junta)
    dataPoints.sort((a, b) => ROLE_ORDER.indexOf(a.role) - ROLE_ORDER.indexOf(b.role));

    // Si solo tiene 1 o 2 posiciones, a√±adimos "dummies" transparentes para que el SVG no se rompa
    // y mantenga una forma est√©tica m√≠nima (tri√°ngulo)
    let isSpecialist = false;
    if (dataPoints.length < 3) {
        isSpecialist = true;
        // No a√±adimos dummies para no falsear, pero trataremos el SVG distinto
    }

    // 3. CONFIGURACI√ìN SVG
    const size = 280;
    const cx = size / 2;
    const cy = size / 2;
    const radius = 90; // Radio del gr√°fico
    const maxRating = 10; // Escala 0-10

    // Funci√≥n para calcular coordenadas (Polar -> Cartesiana)
    const getCoords = (value, index, total) => {
        const angle = (Math.PI * 2 * index) / total - (Math.PI / 2); // -PI/2 para empezar arriba a las 12
        const r = (value / maxRating) * radius;
        return {
            x: cx + r * Math.cos(angle),
            y: cy + r * Math.sin(angle),
            labelX: cx + (radius + 25) * Math.cos(angle), // Etiqueta m√°s lejos
            labelY: cy + (radius + 25) * Math.sin(angle)
        };
    };

    // 4. GENERAR EL GRID (LA TELARA√ëA DE FONDO)
    let gridSVG = '';
    const levels = 4; // C√≠rculos conc√©ntricos (2.5, 5.0, 7.5, 10.0)
    
    // Si hay menos de 3 puntos, el radar es feo, as√≠ que forzamos un m√≠nimo de 3 ejes visuales
    // duplicando el √∫ltimo punto solo para el grid (truco visual)
    const axisCount = Math.max(dataPoints.length, 3); 

    // Dibujar pol√≠gonos de fondo (niveles)
    for (let i = 1; i <= levels; i++) {
        let levelPoints = [];
        const levelRadius = (radius / levels) * i;
        for (let j = 0; j < axisCount; j++) {
            const angle = (Math.PI * 2 * j) / axisCount - (Math.PI / 2);
            levelPoints.push(`${cx + levelRadius * Math.cos(angle)},${cy + levelRadius * Math.sin(angle)}`);
        }
        gridSVG += `<polygon points="${levelPoints.join(' ')}" fill="none" stroke="#e2e8f0" stroke-width="1" />`;
    }

    // Dibujar ejes (l√≠neas desde el centro)
    let axesSVG = '';
    let labelsHTML = '';
    let shapePoints = [];
    let dotsSVG = '';

    // Si hay menos de 3 datos reales, usamos l√≥gica especial para dibujarlo
    // Pero para simplificar, si es < 3, simplemente mostramos los ejes que hay
    
    dataPoints.forEach((point, i) => {
        // Coordenadas del valor (Rating)
        const coords = getCoords(point.avg, i, dataPoints.length); // Usamos longitud real
        shapePoints.push(`${coords.x},${coords.y}`);

        // Coordenadas del extremo del eje (10)
        const maxCoords = getCoords(10, i, dataPoints.length);

        // L√≠nea del eje
        axesSVG += `<line x1="${cx}" y1="${cy}" x2="${maxCoords.x}" y2="${maxCoords.y}" stroke="#cbd5e1" stroke-dasharray="4" />`;

        // Punto de dato
        let colorDot = parseFloat(point.avg) >= 8 ? '#10b981' : (parseFloat(point.avg) >= 6 ? '#f59e0b' : '#ef4444');
        dotsSVG += `<circle cx="${coords.x}" cy="${coords.y}" r="4" fill="${colorDot}" stroke="white" stroke-width="2" />`;

        // Etiqueta HTML (Posicion absoluta sobre el SVG)
        // Ajustamos un poco para centrar el texto
        const alignStyle = `left: ${coords.labelX - 20}px; top: ${coords.labelY - 15}px;`;
        
        labelsHTML += `
            <div class="absolute w-10 text-center flex flex-col items-center" style="${alignStyle}">
                <span class="text-[10px] font-bold text-gray-700 bg-white/80 px-1 rounded">${point.role}</span>
                <span class="text-[9px] font-bold ${parseFloat(point.avg)>=7?'text-emerald-600':'text-gray-400'}">${point.avg}</span>
            </div>
        `;
    });

    // Construir el Pol√≠gono relleno
    let polygonSVG = '';
    if (dataPoints.length >= 3) {
        polygonSVG = `<polygon points="${shapePoints.join(' ')}" fill="rgba(16, 185, 129, 0.2)" stroke="#10b981" stroke-width="2" />`;
    } else if (dataPoints.length === 2) {
        // Si son 2 puntos, es una l√≠nea
        polygonSVG = `<line x1="${shapePoints[0].split(',')[0]}" y1="${shapePoints[0].split(',')[1]}" x2="${shapePoints[1].split(',')[0]}" y2="${shapePoints[1].split(',')[1]}" stroke="#10b981" stroke-width="2" />`;
    } else {
        // Si es 1 punto, ya se dibuja el c√≠rculo (dot)
    }

    // Etiqueta de Polivalencia
    const versatilityScore = dataPoints.length; 
    let badge = '';
    if (versatilityScore >= 4) badge = '<span class="bg-purple-100 text-purple-700 text-[10px] px-2 py-0.5 rounded-full border border-purple-200 font-bold">üíé Todoterreno</span>';
    else if (versatilityScore === 1) badge = '<span class="bg-blue-100 text-blue-700 text-[10px] px-2 py-0.5 rounded-full border border-blue-200 font-bold">üéØ Especialista</span>';

    return `
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mt-6 relative overflow-visible flex flex-col items-center">
            <div class="w-full flex justify-between items-center mb-2">
                <h3 class="font-bold text-gray-800 text-lg flex items-center gap-2">
                    üì° Radar T√°ctico
                </h3>
                ${badge}
            </div>
            
            <div class="relative w-[280px] h-[280px]">
                <svg width="280" height="280" class="absolute top-0 left-0">
                    <circle cx="${cx}" cy="${cy}" r="${radius}" fill="#f8fafc" opacity="0.5" />
                    
                    ${gridSVG}
                    ${axesSVG}
                    ${polygonSVG}
                    ${dotsSVG}
                </svg>
                
                ${labelsHTML}
            </div>

            <div class="text-[9px] text-gray-400 text-center mt-[-20px]">
                * Nota media (0-10) por demarcaci√≥n en el campo.
            </div>
        </div>
    `;
}
// ==========================================
// WIDGET: MAPA DE CALOR DE SUSTITUCIONES
// ==========================================
function getSubstitutionHeatmapHTML(matches) {
    // 1. DEFINIR LOS CUBOS DE TIEMPO (INTERVALOS)
    const buckets = {
        '0-45': { label: "1¬™ Parte / Descanso", count: 0, color: "bg-blue-400", icon: "‚è∏Ô∏è" },
        '46-60': { label: "Inicio 2¬™ Parte",    count: 0, color: "bg-indigo-400", icon: "‚ö°" },
        '61-70': { label: "Momento T√°ctico",    count: 0, color: "bg-amber-400", icon: "üß†" },
        '71-80': { label: "Revulsivos",         count: 0, color: "bg-orange-500", icon: "üî•" },
        '81-90': { label: "Cierre / Tiempo",    count: 0, color: "bg-red-500", icon: "üîí" }
    };

    let totalSubs = 0;

    // 2. PROCESAR DATOS
    matches.filter(m => m.outcome).forEach(m => {
        if (!m.playerStats) return;

        m.playerStats.forEach(ps => {
            // L√≥gica: Es suplente (no titular) Y jug√≥ alg√∫n minuto
            if (!ps.isStarter && ps.minutes > 0) {
                
                // C√ÅLCULO APROXIMADO DEL MINUTO DE ENTRADA
                // Asumimos que jug√≥ hasta el final del partido (90')
                let minuteIn = 91 - ps.minutes;
                
                // Correcci√≥n: Si jug√≥ 45 min o m√°s siendo suplente, asumimos que entr√≥ al descanso (46')
                // o en la primera parte.
                if (minuteIn < 46) minuteIn = 45; 

                // ASIGNAR AL CUBO CORRESPONDIENTE
                if (minuteIn <= 45) buckets['0-45'].count++;
                else if (minuteIn <= 60) buckets['46-60'].count++;
                else if (minuteIn <= 70) buckets['61-70'].count++;
                else if (minuteIn <= 80) buckets['71-80'].count++;
                else buckets['81-90'].count++;

                totalSubs++;
            }
        });
    });

    if (totalSubs === 0) return ''; // No hay datos

    // 3. ENCONTRAR EL M√ÅXIMO (Para escalar las barras al 100% del ancho disponible)
    let maxCount = 0;
    Object.values(buckets).forEach(b => {
        if (b.count > maxCount) maxCount = b.count;
    });

    // 4. GENERAR HTML
    let barsHTML = '';

    Object.entries(buckets).forEach(([range, data]) => {
        // Porcentaje de la barra (Visual)
        const widthPercent = (data.count / maxCount) * 100;
        // Porcentaje real (Dato)
        const realPercent = Math.round((data.count / totalSubs) * 100);
        
        // Opacidad baja si es 0
        const opacityClass = data.count === 0 ? 'opacity-30 grayscale' : '';

        barsHTML += `
            <div class="flex items-center gap-3 mb-3 ${opacityClass} group">
                <div class="w-12 text-right text-xs font-bold text-gray-500 font-mono pt-1">
                    ${range}'
                </div>

                <div class="flex-1">
                    <div class="h-8 w-full bg-gray-50 rounded-r-lg relative overflow-visible flex items-center">
                        <div class="h-full ${data.color} rounded-r-lg transition-all duration-500 relative flex items-center shadow-sm" 
                             style="width: ${Math.max(widthPercent, 2)}%"> <span class="absolute right-2 text-xs opacity-50 group-hover:opacity-100 transition-opacity">
                                ${widthPercent > 20 ? data.icon : ''} 
                             </span>
                        </div>
                        
                        <div class="absolute left-2 text-[10px] font-bold ${widthPercent > 40 ? 'text-white' : 'text-gray-600 ml-' + (widthPercent + 2)} flex gap-2 items-center z-10 whitespace-nowrap">
                            <span>${realPercent}%</span>
                            <span class="font-normal opacity-80 hidden sm:inline">(${data.count} cambios)</span>
                        </div>
                    </div>
                    <div class="text-[9px] text-gray-400 pl-1 mt-0.5 uppercase tracking-wider">
                        ${data.label}
                    </div>
                </div>
            </div>
        `;
    });

    return `
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mt-6">
            <div class="flex justify-between items-center mb-6">
                <h3 class="font-bold text-gray-800 text-lg flex items-center gap-2">
                    ‚è±Ô∏è Mapa de Sustituciones
                </h3>
                <span class="bg-gray-100 text-gray-500 text-[10px] px-2 py-1 rounded-full">
                    Total: ${totalSubs} cambios
                </span>
            </div>

            <div class="flex flex-col gap-1">
                ${barsHTML}
            </div>

            <div class="mt-4 text-[10px] text-gray-400 text-center italic border-t border-gray-50 pt-2">
                * Calculado seg√∫n los minutos jugados por los suplentes (90' - min. jugados).
            </div>
        </div>
    `;
}
// ==========================================
// WIDGET: RENDIMIENTO TITULAR VS SUPLENTE
// ==========================================
function getStarterVsSubHTML(player, matches) {
    // 1. ACUMULADORES
    const stats = {
        starter: { games: 0, mins: 0, goals: 0, ratingSum: 0, ratingCount: 0 },
        sub:     { games: 0, mins: 0, goals: 0, ratingSum: 0, ratingCount: 0 }
    };

    // 2. PROCESAR DATOS
    matches.filter(m => m.outcome).forEach(m => {
        const pStats = m.playerStats ? m.playerStats.find(s => s.playerId === player.id) : null;
        
        if (pStats && pStats.minutes > 0) {
            const type = pStats.isStarter ? 'starter' : 'sub';
            
            stats[type].games++;
            stats[type].mins += parseInt(pStats.minutes);
            stats[type].goals += parseInt(pStats.goals || 0);
            
            if (pStats.rating) {
                stats[type].ratingSum += parseFloat(pStats.rating);
                stats[type].ratingCount++;
            }
        }
    });

    // 3. VALIDACI√ìN: ¬øHa jugado en ambos roles?
    if (stats.starter.games === 0 || stats.sub.games === 0) return '';

    // 4. C√ÅLCULOS DE MEDIAS
    const calc = (s) => ({
        rating: s.ratingCount > 0 ? (s.ratingSum / s.ratingCount).toFixed(1) : 0,
        g90: s.mins > 0 ? ((s.goals / s.mins) * 90).toFixed(2) : 0,
        avgMins: Math.round(s.mins / s.games)
    });

    const startData = calc(stats.starter);
    const subData = calc(stats.sub);

    // 5. GENERAR FILAS DE COMPARACI√ìN
    const renderRow = (label, valStart, valSub, isBetterHigher = true, suffix = '') => {
        const diff = (valSub - valStart).toFixed(1);
        const numDiff = parseFloat(diff);
        
        let diffColor = 'text-gray-400';
        let diffIcon = '';

        if (numDiff > 0) {
            // Suplente es mayor
            diffColor = isBetterHigher ? 'text-emerald-600 font-bold' : 'text-gray-500';
            diffIcon = isBetterHigher ? 'üöÄ' : '+';
        } else if (numDiff < 0) {
            // Titular es mayor
            diffColor = isBetterHigher ? 'text-gray-400' : 'text-emerald-600 font-bold';
        }

        // Barras visuales (Max width relativo)
        const maxVal = Math.max(parseFloat(valStart), parseFloat(valSub), 0.1); // Evitar div by 0
        const wStart = (parseFloat(valStart) / maxVal) * 100;
        const wSub = (parseFloat(valSub) / maxVal) * 100;

        return `
            <div class="grid grid-cols-12 gap-2 items-center mb-3 text-xs">
                <div class="col-span-3 text-gray-500 font-bold uppercase tracking-wider text-[10px]">${label}</div>
                
                <div class="col-span-3 flex flex-col justify-center border-r border-gray-100 pr-2">
                    <div class="flex justify-between mb-0.5">
                        <span class="font-bold text-gray-700">${valStart}${suffix}</span>
                    </div>
                    <div class="w-full bg-gray-100 h-1.5 rounded-full overflow-hidden">
                        <div class="bg-blue-500 h-full rounded-full" style="width: ${wStart}%"></div>
                    </div>
                </div>

                <div class="col-span-3 flex flex-col justify-center pl-2">
                    <div class="flex justify-between mb-0.5">
                        <span class="font-bold text-gray-700">${valSub}${suffix}</span>
                    </div>
                    <div class="w-full bg-gray-100 h-1.5 rounded-full overflow-hidden">
                        <div class="bg-amber-500 h-full rounded-full" style="width: ${wSub}%"></div>
                    </div>
                </div>

                <div class="col-span-3 text-right ${diffColor} text-[10px]">
                    ${numDiff > 0 ? '+' : ''}${diff}${suffix} ${diffIcon}
                </div>
            </div>
        `;
    };

    // Detectar si es un "Super-Sub" (Mejor G90 o Nota como suplente)
    const isSuperSub = (parseFloat(subData.g90) > parseFloat(startData.g90)) || 
                       (parseFloat(subData.rating) > parseFloat(startData.rating) + 0.5);
    
    const badge = isSuperSub 
        ? '<span class="bg-amber-100 text-amber-700 text-[9px] px-2 py-0.5 rounded-full border border-amber-200 font-bold uppercase animate-pulse">üî• Super-Sub</span>' 
        : '';

    // 6. RENDER FINAL
    return `
        <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 mt-6">
            <div class="flex justify-between items-center mb-4 border-b border-gray-50 pb-2">
                <h3 class="font-bold text-gray-800 text-lg flex items-center gap-2">
                    üé≠ Roles
                </h3>
                ${badge}
            </div>
            
            <div class="grid grid-cols-12 gap-2 mb-2 text-[9px] text-gray-400 uppercase text-center">
                <div class="col-span-3 text-left">M√©trica</div>
                <div class="col-span-3 text-blue-500 font-bold">Titular (${stats.starter.games})</div>
                <div class="col-span-3 text-amber-600 font-bold">Suplente (${stats.sub.games})</div>
                <div class="col-span-3 text-right">Dif.</div>
            </div>

            ${renderRow('Nota Media', startData.rating, subData.rating)}
            ${renderRow('Goles / 90\'', startData.g90, subData.g90)}
            ${renderRow('Mins / Partido', startData.avgMins, subData.avgMins, false, "'")}
            
            <div class="mt-2 text-[9px] text-gray-400 text-center italic">
                * Comparativa de rendimiento medio en ambos roles.
            </div>
        </div>
    `;
}
// ==========================================
// WIDGET: TARJETAS POR TIPO DE PARTIDO (Corregido)
// ==========================================
function getDisciplineByOutcomeHTML(player, matches) {
    // 1. INICIALIZAR CONTADORES (Claves internas en ingl√©s para estilos)
    const stats = {
        win:  { label: 'Victorias', color: 'text-emerald-600', bg: 'bg-emerald-500', games: 0, yellow: 0, red: 0 },
        draw: { label: 'Empates',   color: 'text-blue-500',    bg: 'bg-blue-400',    games: 0, yellow: 0, red: 0 },
        loss: { label: 'Derrotas',  color: 'text-rose-600',    bg: 'bg-rose-500',    games: 0, yellow: 0, red: 0 }
    };

    // 2. PROCESAR PARTIDOS
    matches.filter(m => m.outcome).forEach(m => {
        const pStats = m.playerStats ? m.playerStats.find(s => s.playerId === player.id) : null;
        
        // Solo contamos si jug√≥
        if (pStats && pStats.minutes > 0) {
            
            // --- BLOQUE TRADUCTOR (AQU√ç ESTABA EL FALLO) ---
            let outcomeKey = '';
            
            // Normalizamos lo que venga de la BD a min√∫sculas y sin espacios
            const rawOutcome = (m.outcome || '').toLowerCase().trim();

            if (['victoria', 'win', 'ganado'].includes(rawOutcome)) {
                outcomeKey = 'win';
            } else if (['empate', 'draw', 'empatado'].includes(rawOutcome)) {
                outcomeKey = 'draw';
            } else if (['derrota', 'loss', 'perdido'].includes(rawOutcome)) {
                outcomeKey = 'loss';
            } else {
                // Fallback: Si no hay outcome textual, calculamos por goles
                const [goalsHome, goalsAway] = m.result.split('-').map(Number);
                // Asumimos que si venue no est√° definido, el primer n√∫mero es el nuestro (simplificaci√≥n)
                const isHome = (m.venue === 'local' || m.venue === 'home');
                
                // Si es campo neutral o no definido, esto podr√≠a variar, 
                // pero asumimos l√≥gica est√°ndar Local-Visitante
                const myGoals = isHome ? goalsHome : goalsAway;
                const oppGoals = isHome ? goalsAway : goalsHome;
                
                if (myGoals > oppGoals) outcomeKey = 'win';
                else if (myGoals < oppGoals) outcomeKey = 'loss';
                else outcomeKey = 'draw';
            }
            // ------------------------------------------------

            // Ahora s√≠, sumamos usando la clave correcta
            if (stats[outcomeKey]) {
                stats[outcomeKey].games++;
                
                // Funci√≥n auxiliar para contar tarjetas "1, 2" o num√©ricas
                const countCards = (val) => {
                    if (!val) return 0;
                    if (typeof val === 'number') return val;
                    return val.toString().split(',').filter(s => s.trim() !== '').length;
                };
                
                // Buscamos en todas las posibles propiedades donde se guardan las tarjetas
                const yellows = countCards(pStats.detailYellow) || countCards(pStats.yellowCards);
                const reds = countCards(pStats.detailRed) || countCards(pStats.redCards);

                stats[outcomeKey].yellow += yellows;
                stats[outcomeKey].red += reds;
            }
        }
    });

    // Validar si hay tarjetas en total
    const totalCards = Object.values(stats).reduce((acc, s) => acc + s.yellow + s.red, 0);
    if (totalCards === 0) return ''; // Si es un santo, no mostramos nada

    // 3. CALCULAR PROMEDIOS (INTENSIDAD)
    let maxScore = 0;
    
    Object.keys(stats).forEach(k => {
        const s = stats[k];
        // Evitar divisi√≥n por cero
        s.avgYellow = s.games > 0 ? (s.yellow / s.games) : 0;
        s.avgRed = s.games > 0 ? (s.red / s.games) : 0;
        
        // Puntuaci√≥n de "Agresividad" para escalar las barras visualmente
        // Una roja pesa x3 visualmente
        s.score = s.avgYellow + (s.avgRed * 3); 
        if (s.score > maxScore) maxScore = s.score;
    });

    // 4. DETECTAR TENDENCIA ("MAL PERDER")
    const lossScore = stats.loss.score;
    const winScore = stats.win.score;
    
    let badge = '';
    // Si pierde se calienta el doble que cuando gana...
    if (stats.loss.games > 0 && lossScore > (winScore * 2 + 0.1)) {
        badge = '<span class="bg-rose-100 text-rose-700 text-[9px] px-2 py-0.5 rounded-full border border-rose-200 font-bold uppercase animate-pulse">ü§¨ Frustraci√≥n</span>';
    } else if (totalCards > 0 && lossScore <= winScore) {
        badge = '<span class="bg-blue-100 text-blue-700 text-[9px] px-2 py-0.5 rounded-full border border-blue-200 font-bold uppercase">üßò Zen</span>';
    }

    // 5. GENERAR COLUMNAS HTML
    const renderColumn = (type) => {
        const s = stats[type];
        // Si nunca ha tenido ese resultado, columna vac√≠a pero ocupando espacio para mantener estructura
        if (s.games === 0) return `<div class="flex-1 opacity-20"></div>`;

        // Altura relativa al m√°ximo score encontrado (para que la barra m√°s alta toque el techo)
        // Usamos un m√≠nimo de seguridad (maxScore || 1)
        const totalHeightPercent = Math.min((s.score / (maxScore || 1)) * 100, 100);
        
        // Proporci√≥n interna: Qu√© parte de esa altura es Roja vs Amarilla
        // Si s.score es 0 (jug√≥ partidos pero sin tarjetas), altura m√≠nima 2%
        const finalHeight = totalHeightPercent < 5 && totalHeightPercent > 0 ? 5 : totalHeightPercent;
        
        // Desglose visual dentro de la barra
        const redRatio = s.score > 0 ? ((s.avgRed * 3) / s.score) * 100 : 0;
        const yellowRatio = 100 - redRatio;

        return `
            <div class="flex-1 flex flex-col items-center gap-2 group">
                <div class="text-[10px] uppercase font-bold text-gray-400 tracking-wider mb-1">${s.label}</div>
                
                <div class="w-full max-w-[50px] h-24 bg-gray-50 rounded-lg flex flex-col justify-end p-1 relative border border-gray-100 overflow-hidden">
                    
                    ${s.score > 0 ? `
                    <div class="w-full rounded-sm shadow-sm flex flex-col-reverse overflow-hidden transition-all duration-500 relative" 
                         style="height: ${finalHeight}%">
                        
                        <div class="w-full bg-amber-400 flex items-center justify-center text-[10px] text-amber-900 font-bold" 
                             style="height: ${yellowRatio}%">
                             ${s.yellow > 0 ? s.yellow : ''}
                        </div>
                        
                        <div class="w-full bg-rose-500 flex items-center justify-center text-[9px] text-white font-bold" 
                             style="height: ${redRatio}%">
                             ${s.red > 0 ? s.red : ''}
                        </div>
                    </div>
                    ` : `
                    <div class="w-full h-1 bg-gray-200 rounded-full mt-auto opacity-50"></div>
                    `}

                </div>

                <div class="text-[9px] text-gray-400 font-mono bg-gray-100 px-1.5 rounded">
                    ${s.games} part.
                </div>
            </div>
        `;
    };

    return `
        <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 mt-6">
            <div class="flex justify-between items-center mb-4 border-b border-gray-50 pb-2">
                <h3 class="font-bold text-gray-800 text-lg flex items-center gap-2">
                    ‚öñÔ∏è Disciplina
                </h3>
                ${badge}
            </div>

            <div class="flex justify-around items-end gap-2 h-32">
                ${renderColumn('win')}
                <div class="w-px h-20 bg-gray-100 self-center"></div>
                ${renderColumn('draw')}
                <div class="w-px h-20 bg-gray-100 self-center"></div>
                ${renderColumn('loss')}
            </div>
            
            <div class="mt-3 text-[9px] text-gray-400 text-center italic">
                * Altura basada en la intensidad de tarjetas (Amarilla=1, Roja=3).
            </div>
        </div>
    `;
}
// ==========================================
// WIDGET: GOLES POR POSICI√ìN T√ÅCTICA (CON TOGGLE)
// ==========================================
function getGoalsByPositionWidget() {
    const matches = getData('matches') || [];
    const allPlayers = typeof getPlayers === 'function' ? getPlayers() : [];

    // 1. DEFINIR ROLES
    const FORMATION_SLOTS = {
        '4-3-3': ['POR', 'LI', 'DFC', 'DFC', 'LD', 'MCD', 'MC', 'MC', 'EI', 'DC', 'ED'],
        '4-4-2': ['POR', 'LI', 'DFC', 'DFC', 'LD', 'EI', 'MC', 'MC', 'ED', 'DC', 'DC'],
        '4-2-3-1': ['POR', 'LI', 'DFC', 'DFC', 'LD', 'MCD', 'MCD', 'EI', 'MCO', 'ED', 'DC'],
        '3-5-2': ['POR', 'DFC', 'DFC', 'DFC', 'LI', 'MCD', 'LD', 'MC', 'MC', 'DC', 'DC']
    };

    const ROLE_STYLES = {
        'DC': { color: 'bg-emerald-500', label: 'Delantero Centro' },
        'EI': { color: 'bg-emerald-400', label: 'Extremo Izquierdo' },
        'ED': { color: 'bg-emerald-400', label: 'Extremo Derecho' },
        'MCO':{ color: 'bg-amber-400',   label: 'Mediapunta' },
        'MC': { color: 'bg-amber-500',   label: 'Mediocentro' },
        'MCD':{ color: 'bg-amber-600',   label: 'Pivote Defensivo' },
        'LI': { color: 'bg-blue-400',    label: 'Lateral Izquierdo' },
        'LD': { color: 'bg-blue-400',    label: 'Lateral Derecho' },
        'DFC':{ color: 'bg-blue-600',    label: 'Defensa Central' },
        'POR':{ color: 'bg-gray-500',    label: 'Portero' }
    };

    // 2. PROCESAR GOLES
    let positionStats = {};

    matches.filter(m => m.outcome).forEach(m => {
        if (!m.playerStats) return;
        const formation = m.formation || '4-3-3';
        const schema = FORMATION_SLOTS[formation];

        m.playerStats.forEach(ps => {
            const goals = parseInt(ps.goals || 0);
            if (goals > 0 && ps.pitchSlot !== undefined && ps.pitchSlot !== null && schema) {
                const role = schema[ps.pitchSlot];
                
                if (!positionStats[role]) positionStats[role] = { total: 0, players: {} };
                positionStats[role].total += goals;
                
                if (!positionStats[role].players[ps.playerId]) positionStats[role].players[ps.playerId] = 0;
                positionStats[role].players[ps.playerId] += goals;
            }
        });
    });

    if (Object.keys(positionStats).length === 0) return '';

    // 3. ORDENAR Y PREPARAR HTML
    const sortedRoles = Object.keys(positionStats).sort((a, b) => positionStats[b].total - positionStats[a].total);
    
    // --- L√ìGICA DE TOGGLE ---
    const LIMIT = 3; // Mostrar solo las 3 posiciones m√°s goleadoras al principio
    let visibleHTML = '';
    let hiddenHTML = '';

    sortedRoles.forEach((role, index) => {
        const data = positionStats[role];
        const style = ROLE_STYLES[role] || { color: 'bg-gray-400', label: role };
        
        // Ordenar jugadores
        const sortedPlayers = Object.entries(data.players).sort((a, b) => b[1] - a[1]);
        const maxGoalsInRole = sortedPlayers[0][1];

        // HTML JUGADORES
        let playersHTML = sortedPlayers.map(([pid, count]) => {
            const p = allPlayers.find(pl => pl.id === pid) || { apodo: '?', foto: '' };
            const percent = (count / maxGoalsInRole) * 100;
            
            return `
                <div class="flex items-center gap-3 mb-1.5 text-xs group">
                    <div class="w-24 flex items-center gap-2 shrink-0">
                        <img src="${p.foto}" class="w-5 h-5 rounded-full object-cover border border-gray-100 bg-white">
                        <span class="truncate font-medium text-gray-600">${p.apodo}</span>
                    </div>
                    <div class="flex-1 h-2 bg-gray-50 rounded-full overflow-hidden">
                        <div class="h-full ${style.color} rounded-full" style="width: ${percent}%"></div>
                    </div>
                    <div class="w-12 text-right font-bold text-gray-700">${count} ‚öΩ</div>
                </div>
            `;
        }).join('');

        // BLOQUE HTML DE LA POSICI√ìN COMPLETA
        const blockHTML = `
            <div class="mb-5 last:mb-0">
                <div class="flex justify-between items-end mb-2 border-b border-gray-100 pb-1">
                    <div class="flex items-center gap-2">
                        <span class="px-2 py-0.5 rounded text-[10px] font-bold text-white ${style.color} shadow-sm">
                            ${role}
                        </span>
                        <span class="text-xs font-bold text-gray-500 uppercase tracking-wide">
                            ${style.label}
                        </span>
                    </div>
                    <span class="text-sm font-bold text-gray-800">${data.total} <span class="text-xs font-normal text-gray-400">Total</span></span>
                </div>
                <div class="pl-2">
                    ${playersHTML}
                </div>
            </div>
        `;

        // Distribuir en visible u oculto
        if (index < LIMIT) {
            visibleHTML += blockHTML;
        } else {
            hiddenHTML += blockHTML;
        }
    });

    // ID √∫nico para este widget
    const uniqueId = 'goals-by-pos-hidden';

    // 4. RETURN FINAL
    // Nota: Uso h-auto para que crezca correctamente
    return `
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 h-auto transition-all duration-300">
            <h3 class="font-bold text-gray-800 text-lg mb-4 flex items-center gap-2">
                ü•Ö Goles por Demarcaci√≥n
            </h3>
            
            <div class="flex flex-col">
                ${visibleHTML}
            </div>

            ${hiddenHTML ? `
                <div id="${uniqueId}" class="flex flex-col hidden border-t border-dashed border-gray-100 mt-4 pt-4 transition-all">
                    ${hiddenHTML}
                </div>
                
                <div class="mt-4 text-center">
                    <button onclick="toggleWidgetSection('${uniqueId}', this)" 
                            data-more="Ver {n} demarcaciones m√°s ‚ñº" 
                            data-less="Ver menos ‚ñ≤"
                            class="px-4 py-1.5 bg-gray-50 hover:bg-gray-100 text-xs font-bold text-gray-500 hover:text-gray-700 rounded-full transition-colors border border-gray-200">
                        Ver ${sortedRoles.length - LIMIT} demarcaciones m√°s ‚ñº
                    </button>
                </div>
            ` : ''}

            <div class="mt-4 text-[10px] text-gray-400 text-center italic border-t border-gray-50 pt-2">
                * Goles asignados seg√∫n la posici√≥n ocupada en la pizarra del partido.
            </div>
        </div>
    `;
}
// ==========================================
// WIDGET: CURVA DE FORMA (SPARKLINE)
// ==========================================
function getFormSparklineHTML(player, matches) {
    // 1. OBTENER √öLTIMOS 5 PARTIDOS JUGADOS CON NOTA
    const ratings = [];
    
    // Filtramos partidos donde jug√≥ y tiene nota
    const playedMatches = matches
        .filter(m => m.outcome) // Solo terminados
        .sort((a, b) => new Date(a.date) - new Date(b.date)); // Orden cronol√≥gico (antiguo a nuevo)

    playedMatches.forEach(m => {
        if (!m.playerStats) return;
        const ps = m.playerStats.find(s => s.playerId === player.id);
        if (ps && ps.minutes > 0 && ps.rating) {
            ratings.push({
                rating: parseFloat(ps.rating),
                rival: m.opponent, // Para el tooltip
                result: m.result
            });
        }
    });

    // Nos quedamos con los √∫ltimos 5
    const last5 = ratings.slice(-5);

    if (last5.length < 2) return ''; // Necesitamos al menos 2 puntos para una l√≠nea

    // 2. CALCULAR TENDENCIA
    const first = last5[0].rating;
    const last = last5[last5.length - 1].rating;
    const max = Math.max(...last5.map(r => r.rating));
    const min = Math.min(...last5.map(r => r.rating));
    const diff = last - first;
    const volatility = max - min;

    let trend = { label: 'Irregular', color: 'text-amber-500', icon: 'üü°', stroke: '#f59e0b' };

    if (volatility <= 1.0) {
        trend = { label: 'Consistente', color: 'text-blue-500', icon: 'üîµ', stroke: '#3b82f6' };
    } else if (diff >= 0.5) {
        trend = { label: 'Subiendo', color: 'text-emerald-500', icon: 'üü¢', stroke: '#10b981' };
    } else if (diff <= -0.5) {
        trend = { label: 'Bajando', color: 'text-rose-500', icon: 'üî¥', stroke: '#f43f5e' };
    }

    // 3. GENERAR SVG (SPARKLINE)
    const width = 150;
    const height = 40;
    const padding = 5;
    
    // Escala Y: Mapeamos las notas (0-10) a la altura del SVG (height-0)
    // Truco: Usamos un rango din√°mico (min-max) para que la curva se note m√°s, 
    // pero con un suelo de 4.0 para no exagerar notas bajas.
    const getY = (val) => {
        const visualMin = 4; // Nota m√≠nima visual
        const visualMax = 10;
        const normalized = (val - visualMin) / (visualMax - visualMin);
        // Invertimos Y porque en SVG 0 es arriba
        return height - (Math.max(0, normalized) * height) + padding; 
    };

    const getX = (index) => (index / (last5.length - 1)) * width + padding;

    // Construir la l√≠nea (Polyline)
    const points = last5.map((r, i) => `${getX(i)},${getY(r.rating)}`).join(' ');

    // Construir los puntos (Circles)
    const dotsSVG = last5.map((r, i) => {
        return `<circle cx="${getX(i)}" cy="${getY(r.rating)}" r="3" fill="white" stroke="${trend.stroke}" stroke-width="2">
            <title>vs ${r.rival}: ${r.rating}</title>
        </circle>`;
    }).join('');

    // HTML de los n√∫meros debajo
    const numbersHTML = last5.map(r => {
        let colorClass = 'text-gray-400';
        if (r.rating >= 8) colorClass = 'text-emerald-600 font-bold';
        else if (r.rating < 6) colorClass = 'text-rose-500';
        
        return `<span class="text-[10px] ${colorClass}">${r.rating}</span>`;
    }).join('<span class="text-gray-300 mx-1">‚îÄ</span>');

    return `
        <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 mt-6 flex flex-col items-center">
            <div class="w-full flex justify-between items-center mb-2">
                <h3 class="font-bold text-gray-800 text-sm flex items-center gap-2">
                    üìà Forma (√öltimos 5)
                </h3>
                <span class="text-xs font-bold ${trend.color} bg-gray-50 px-2 py-0.5 rounded-full border border-gray-100">
                    ${trend.icon} ${trend.label}
                </span>
            </div>

            <div class="relative w-full h-16 flex justify-center items-center overflow-visible">
                <svg width="${width + 10}" height="${height + 15}" class="overflow-visible">
                    <polyline points="${points}" fill="none" stroke="${trend.stroke}" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                    ${dotsSVG}
                </svg>
            </div>

            <div class="flex items-center justify-between w-full max-w-[160px] mt-1">
                ${numbersHTML}
            </div>
        </div>
    `;
}

// ==========================================
// WIDGET: JERARQU√çA DE PLANTILLA (% TITULARIDAD) - CON TOGGLE
// ==========================================
function getSquadHierarchyWidget() {
    const matches = getData('matches') || [];
    const allPlayers = typeof getPlayers === 'function' ? getPlayers() : [];

    // 1. CALCULAR TOTAL
    const playedMatches = matches.filter(m => m.outcome);
    const totalTeamMatches = playedMatches.length;

    if (totalTeamMatches === 0) return '';

    // 2. CONTAR TITULARIDADES
    const playerStarts = {};
    playedMatches.forEach(m => {
        if (!m.playerStats) return;
        m.playerStats.forEach(ps => {
            if (ps.isStarter) {
                playerStarts[ps.playerId] = (playerStarts[ps.playerId] || 0) + 1;
            }
        });
    });

    // 3. CREAR ARRAY Y ORDENAR
    const hierarchyData = Object.keys(playerStarts)
        .map(pid => {
            const starts = playerStarts[pid];
            const percentage = Math.round((starts / totalTeamMatches) * 100);
            return { playerId: pid, starts: starts, percent: percentage };
        })
        .sort((a, b) => b.percent - a.percent);

    // 4. GENERAR HTML CON TOGGLE
    const LIMIT = 5; // Mostrar los 5 m√°s titulares
    let visibleHTML = '';
    let hiddenHTML = '';

    // ID √∫nico para este toggle
    const uniqueId = 'squad-hierarchy-hidden';

    hierarchyData.forEach((item, index) => {
        const p = allPlayers.find(pl => pl.id === item.playerId) || { apodo: '?', foto: '' };
        
        let status = { label: 'Residual', icon: 'üëª', color: 'bg-gray-400', text: 'text-gray-400' };
        if (item.percent >= 90) status = { label: 'Intocable', icon: 'üîí', color: 'bg-purple-600', text: 'text-purple-700' };
        else if (item.percent >= 70) status = { label: 'Clave', icon: 'üîë', color: 'bg-emerald-500', text: 'text-emerald-600' };
        else if (item.percent >= 40) status = { label: 'Rotaci√≥n', icon: 'üîÑ', color: 'bg-blue-500', text: 'text-blue-600' };
        else if (item.percent >= 15) status = { label: 'Revulsivo', icon: 'ü™ë', color: 'bg-amber-500', text: 'text-amber-600' };

        const rowHTML = `
            <div class="flex items-center gap-3 mb-3 last:mb-0 group">
                <div class="w-28 flex items-center gap-2 shrink-0">
                    <img src="${p.foto}" class="w-6 h-6 rounded-full object-cover border border-gray-100 bg-white shadow-sm">
                    <div class="flex flex-col overflow-hidden">
                        <span class="truncate text-xs font-bold text-gray-700">${p.apodo}</span>
                        <span class="text-[9px] text-gray-400">${item.starts}/${totalTeamMatches} inicios</span>
                    </div>
                </div>

                <div class="flex-1 h-2.5 bg-gray-100 rounded-full overflow-hidden relative">
                    <div class="h-full ${status.color} rounded-full transition-all duration-700 relative group-hover:opacity-80" 
                         style="width: ${item.percent}%">
                    </div>
                </div>

                <div class="w-10 text-right text-xs font-bold text-gray-700 font-mono">${item.percent}%</div>

                <div class="w-20 text-right">
                    <span class="text-[9px] font-bold ${status.text} bg-gray-50 px-1.5 py-0.5 rounded border border-gray-100 whitespace-nowrap">
                        ${status.icon} ${status.label}
                    </span>
                </div>
            </div>
        `;

        if (index < LIMIT) visibleHTML += rowHTML;
        else hiddenHTML += rowHTML;
    });

    return `
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mt-6 h-auto transition-all duration-300">
            <div class="flex justify-between items-center mb-4 border-b border-gray-50 pb-2">
                <h3 class="font-bold text-gray-800 text-lg flex items-center gap-2">
                    üèõÔ∏è Jerarqu√≠a de la Plantilla
                </h3>
                <span class="text-[10px] text-gray-400 bg-gray-100 px-2 py-0.5 rounded-full">
                    Base: ${totalTeamMatches} partidos
                </span>
            </div>
            
            <div class="flex flex-col">
                ${visibleHTML}
            </div>

            ${hiddenHTML ? `
                <div id="${uniqueId}" class="flex flex-col hidden mt-3 pt-3 border-t border-dashed border-gray-100 transition-all">
                    ${hiddenHTML}
                </div>

                <div class="mt-4 text-center">
                    <button onclick="toggleWidgetSection('${uniqueId}', this)" 
                            data-more="Ver {n} jugadores m√°s ‚ñº" 
                            data-less="Ver menos ‚ñ≤"
                            class="px-4 py-1.5 bg-gray-50 hover:bg-gray-100 text-xs font-bold text-gray-500 hover:text-gray-700 rounded-full transition-colors border border-gray-200">
                        Ver ${hierarchyData.length - LIMIT} jugadores m√°s ‚ñº
                    </button>
                </div>
            ` : ''}

            <div class="mt-4 flex flex-wrap justify-center gap-3 text-[9px] text-gray-400 border-t border-gray-50 pt-2">
                <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-purple-600"></span> >90% Intocable</span>
                <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-emerald-500"></span> >70% Clave</span>
                <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-blue-500"></span> >40% Rotaci√≥n</span>
                <span class="flex items-center gap-1"><span class="w-2 h-2 rounded-full bg-amber-500"></span> >15% Revulsivo</span>
            </div>
        </div>
    `;
}
// ==========================================
// WIDGET: PARTICIPACI√ìN OFENSIVA (CON TOGGLE)
// ==========================================
function getOffensiveParticipationWidget() {
    const matches = getData('matches') || [];
    const allPlayers = typeof getPlayers === 'function' ? getPlayers() : [];

    // 1. PROCESAR DATOS
    const stats = {};

    matches.filter(m => m.outcome).forEach(m => {
        if (!m.playerStats) return;
        m.playerStats.forEach(ps => {
            if (ps.minutes > 0) {
                if (!stats[ps.playerId]) stats[ps.playerId] = { played: 0, produced: 0 };
                stats[ps.playerId].played++;
                const goals = parseInt(ps.goals || 0);
                const assists = parseInt(ps.assists || 0);
                if (goals > 0 || assists > 0) {
                    stats[ps.playerId].produced++;
                }
            }
        });
    });

    // 2. FILTRAR Y ORDENAR
    const ranking = Object.keys(stats)
        .map(pid => {
            const s = stats[pid];
            const percent = s.played > 0 ? Math.round((s.produced / s.played) * 100) : 0;
            return {
                id: pid,
                played: s.played,
                produced: s.produced,
                percent: percent
            };
        })
        .filter(item => item.played >= 3)
        .sort((a, b) => b.percent - a.percent);

    if (ranking.length === 0) return '';

    // 3. GENERAR HTML CON TOGGLE
    const LIMIT = 5; // Mostrar 5 jugadores inicialmente
    let visibleHTML = '';
    let hiddenHTML = '';
    
    // ID √önico para el toggle
    const uniqueId = 'offensive-impact-hidden';

    ranking.forEach((item, index) => {
        const p = allPlayers.find(pl => pl.id === item.id) || { apodo: '?', foto: '' };
        
        let style = { label: 'Irrelevante', icon: 'üö®', color: 'bg-gray-400', text: 'text-gray-400' };
        if (item.percent >= 75) style = { label: 'Omnipresente', icon: 'üî•', color: 'bg-rose-500', text: 'text-rose-600' };
        else if (item.percent >= 50) style = { label: 'Decisivo', icon: '‚ö°', color: 'bg-emerald-500', text: 'text-emerald-600' };
        else if (item.percent >= 30) style = { label: 'Cumplidor', icon: '‚úÖ', color: 'bg-blue-500', text: 'text-blue-600' };
        else if (item.percent >= 10) style = { label: 'Fr√≠o', icon: '‚ùÑÔ∏è', color: 'bg-sky-300', text: 'text-sky-400' };

        const rowHTML = `
            <div class="flex items-center gap-3 mb-3 last:mb-0 group">
                <div class="w-28 flex items-center gap-2 shrink-0">
                    <img src="${p.foto}" class="w-6 h-6 rounded-full object-cover border border-gray-100 bg-white">
                    <div class="flex flex-col overflow-hidden">
                        <span class="truncate text-xs font-bold text-gray-700">${p.apodo}</span>
                        <span class="text-[9px] text-gray-400">${item.produced} de ${item.played} part.</span>
                    </div>
                </div>

                <div class="flex-1 h-2.5 bg-gray-100 rounded-full overflow-hidden relative">
                    <div class="h-full ${style.color} rounded-full transition-all duration-700 relative group-hover:opacity-80" 
                         style="width: ${item.percent}%">
                    </div>
                </div>

                <div class="w-10 text-right text-xs font-bold text-gray-700 font-mono">${item.percent}%</div>

                <div class="w-24 text-right">
                    <span class="text-[9px] font-bold ${style.text} bg-gray-50 px-1.5 py-0.5 rounded border border-gray-100 whitespace-nowrap">
                        ${style.icon} ${style.label}
                    </span>
                </div>
            </div>
        `;

        if (index < LIMIT) visibleHTML += rowHTML;
        else hiddenHTML += rowHTML;
    });

    return `
        <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-100 mt-6 h-auto transition-all duration-300">
            <div class="flex justify-between items-center mb-4 border-b border-gray-50 pb-2">
                <h3 class="font-bold text-gray-800 text-lg flex items-center gap-2">
                    üéØ Impacto Ofensivo
                </h3>
                <span class="text-[10px] text-gray-400 bg-gray-100 px-2 py-0.5 rounded-full">
                    % Partidos con Gol o Asistencia
                </span>
            </div>
            
            <div class="flex flex-col">
                ${visibleHTML}
            </div>

            ${hiddenHTML ? `
                <div id="${uniqueId}" class="flex flex-col hidden mt-3 pt-3 border-t border-dashed border-gray-100 transition-all">
                    ${hiddenHTML}
                </div>

                <div class="mt-4 text-center">
                    <button onclick="toggleWidgetSection('${uniqueId}', this)" 
                            data-more="Ver {n} jugadores m√°s ‚ñº" 
                            data-less="Ver menos ‚ñ≤"
                            class="px-4 py-1.5 bg-gray-50 hover:bg-gray-100 text-xs font-bold text-gray-500 hover:text-gray-700 rounded-full transition-colors border border-gray-200">
                        Ver ${ranking.length - LIMIT} jugadores m√°s ‚ñº
                    </button>
                </div>
            ` : ''}

            <div class="mt-4 text-[9px] text-gray-400 text-center italic border-t border-gray-50 pt-2">
                * Se requiere un m√≠nimo de 3 partidos jugados para aparecer.
            </div>
        </div>
    `;
}
// ==========================================
// FUNCI√ìN GLOBAL: EXPANDIR / CONTRAER LISTAS
// ==========================================
window.toggleWidgetSection = function(targetId, btn) {
    const container = document.getElementById(targetId);
    
    // Si no encuentra el contenedor, paramos para evitar errores
    if (!container) {
        console.error(`No se encontr√≥ el contenedor con ID: ${targetId}`);
        return;
    }

    // Detectar estado actual (si est√° oculto o no)
    const isHidden = container.classList.contains('hidden');
    
    // Leer textos configurados en el bot√≥n (o usar valores por defecto)
    // El atributo data-more suele ser "Ver {n} m√°s ‚ñº"
    const textMore = btn.dataset.more || 'Ver m√°s ‚ñº';
    const textLess = btn.dataset.less || 'Ver menos ‚ñ≤';

    if (isHidden) {
        // ACCI√ìN: MOSTRAR
        container.classList.remove('hidden');
        btn.innerHTML = textLess;
    } else {
        // ACCI√ìN: OCULTAR
        container.classList.add('hidden');
        
        // Contamos cu√°ntos elementos hijos hay para reemplazar el "{n}"
        const count = container.children.length;
        btn.innerHTML = textMore.replace('{n}', count);
    }
};
</script>
</body>
</html>    