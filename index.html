<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notas - Real Madrid CF</title>
    
    <link rel="manifest" href="./manifest.json">
    <link rel="icon" type="image/png" href="./favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="./favicon.svg" />
    <link rel="shortcut icon" href="./favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="https://upload.wikimedia.org/wikipedia/en/thumb/5/56/Real_Madrid_CF.svg/180px-Real_Madrid_CF.svg.png">

    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>    
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>

    <style>
        * { font-family: 'Inter', sans-serif; }
        .tab-active { border-bottom: 3px solid #fbbf24; color: #fbbf24; }
        .card { transition: all 0.3s ease; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
        
        /* Player Photos - Standardized Object Position */
        .player-photo { width: 80px; height: 80px; object-fit: cover; object-position: top !important; border-radius: 50%; }
        .player-photo-small { width: 40px; height: 40px; object-fit: cover; object-position: top !important; border-radius: 50%; }
        .player-photo-xs { width: 32px; height: 32px; object-fit: cover; object-position: top !important; border-radius: 50%; }
        .player-photo-lg { width: 120px; height: 120px; object-fit: cover; object-position: top !important; border-radius: 50%; }
        
        /* Top Form Specific Photo Style */
        .top-form-img { width: 24px; height: 24px; border-radius: 50%; object-fit: cover; object-position: top !important; }

        .modal { display: none; }
        .modal.active { display: flex; }
        .fade-in { animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .position-badge { padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        .pos-portero, .pos-portera { background: #fef3c7; color: #92400e; }
        .pos-defensa { background: #dbeafe; color: #1e40af; }
        .pos-centrocampista { background: #d1fae5; color: #065f46; }
        .pos-extremo { background: #ede9fe; color: #5b21b6; }
        .pos-delantero, .pos-delantera { background: #fee2e2; color: #991b1b; }
        .pos-entrenador { background: #1f2937; color: #fbbf24; border: 1px solid #fbbf24; }
        
        .status-active { background: #d1fae5; color: #065f46; }
        .status-inactive { background: #f3f4f6; color: #6b7280; }
        
        input[type="number"]::-webkit-inner-spin-button { opacity: 1; }
        .table-container { overflow-x: auto; }
        table { min-width: 1000px; }
        .sortable { cursor: pointer; user-select: none; }
        .sortable:hover { background: #374151; }
        .th-active { background-color: #4b5563 !important; color: #fbbf24 !important; }
        
        .result-win { background: #d1fae5; color: #065f46; }
        .result-draw { background: #fef3c7; color: #92400e; }
        .result-loss { background: #fee2e2; color: #991b1b; }
        
        /* Calendar Styles based on Competition Colors */
        .match-card { border-left: 4px solid #9ca3af; }
        .match-registered { opacity: 0.6; background-color: #f9fafb; border-color: #6b7280 !important; }
        
        /* Competition Colors for Calendar Borders */
        .border-comp-liga { border-left-color: #1e40af; }
        .border-comp-champions { border-left-color: #5b21b6; }
        .border-comp-copa { border-left-color: #065f46; }
        .border-comp-supercopa { border-left-color: #991b1b; }
        .border-comp-mundial { border-left-color: #92400e; }
        
        .comp-mundial { background: #fef3c7; color: #92400e; }
        .comp-liga { background: #dbeafe; color: #1e40af; }
        .comp-champions { background: #ede9fe; color: #5b21b6; }
        .comp-copa { background: #d1fae5; color: #065f46; }
        .comp-supercopa { background: #fee2e2; color: #991b1b; }
        .comp-unknown { background: #e5e7eb; color: #374151; }
        .comp-eliminated { background: #f3f4f6; color: #9ca3af; text-decoration: line-through; }
        
        /* Backgrounds */
        .welcome-bg {
            background: url("https://i.postimg.cc/HnXKzV3c/bernabeu2.jpg") center/cover no-repeat;
            min-height: 100vh;
        }
        
        @media (max-width: 768px) {
            .welcome-bg {
                background: url("https://i.postimg.cc/zXpprCLS/bernabeu-1-movil-wallpaper.jpg") center/cover no-repeat;
            }
        }

        .rm-header-gradient { background: linear-gradient(135deg, #1e3a5f 0%, #0a1628 100%); }

        .rm-gold { color: #fbbf24; }
        .calendar-loading { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        .player-inactive { opacity: 0.6; }
        .player-suspended { background-color: #fef2f2; opacity: 0.7; pointer-events: none; border: 1px solid #fecaca; }
        .round-badge { padding: 2px 8px; border-radius: 6px; font-size: 11px; font-weight: 500; }
        .round-available { background: #d1fae5; color: #065f46; border: 1px solid #10b981; }
        .round-completed { background: #e0e7ff; color: #3730a3; }
        .round-locked { background: #f3f4f6; color: #9ca3af; }
        .elimination-warning { background: #fef2f2; border: 1px solid #fecaca; color: #991b1b; }
        .global-result { background: #f0f9ff; border: 1px solid #bae6fd; }
        .calendar-select-hint { background: #ecfdf5; border: 1px solid #a7f3d0; color: #065f46; }
        .selected-fixture { background: #fef3c7; border: 2px solid #f59e0b; }
        .readonly-input { background-color: #f3f4f6; color: #6b7280; cursor: not-allowed; }
        .welcome-card { transition: all 0.3s; cursor: pointer; }
        .welcome-card:hover { transform: scale(1.02); }
        .starter-badge { background: #d1fae5; color: #065f46; border: 1px solid #34d399; font-size: 0.7rem; padding: 1px 4px; border-radius: 4px; }
        .sub-badge { background: #f3f4f6; color: #6b7280; border: 1px solid #d1d5db; font-size: 0.7rem; padding: 1px 4px; border-radius: 4px; }
        
        /* Monthly Calendar Styles */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #e5e7eb; border: 1px solid #e5e7eb; }
        .calendar-day-header { background: #f9fafb; padding: 8px; text-align: center; font-weight: 600; font-size: 0.85rem; color: #4b5563; }
        .calendar-day { background: white; min-height: 100px; padding: 4px; position: relative; }
        .calendar-day:hover { background: #f9fafb; }
        .calendar-day.other-month { background: #f3f4f6; color: #9ca3af; }
        .calendar-day.today { background: #eff6ff; }
        .day-number { font-size: 0.85rem; font-weight: 600; margin-bottom: 4px; display: block; }
        .cal-event-dot { font-size: 0.7rem; padding: 2px 4px; border-radius: 4px; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; display: block; }
        .cal-event-dot:hover { opacity: 0.8; }

        /* Comparator */
        .stat-better { background-color: #dcfce7; color: #166534; font-weight: bold; }
        .streak-dot { 
            width: 24px; 
            height: 24px; 
            border-radius: 50%; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 10px; 
            font-weight: bold; 
            color: white; 
            line-height: 1;
        }
        .streak-w { background-color: #22c55e; }
        .streak-d { background-color: #9ca3af; }
        .streak-l { background-color: #ef4444; }

        /* Heatmap Styles */
        .heatmap-pitch {
            background-color: #ecfdf5;
            border: 2px solid #10b981;
            border-radius: 8px;
            position: relative;
            height: 400px; /* Increased height for 4 zones */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 10px;
        }
        .heatmap-zone {
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            transition: all 0.3s;
            flex: 1;
            margin: 2px;
        }
        .heatmap-val { font-size: 1.5rem; font-weight: bold; }
        .heatmap-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; }

       /* Stats Sub-tabs - Estilo Limpio y Legible */
        .stats-subtab { @apply px-5 py-2 text-sm font-bold rounded-lg transition-all duration-200 flex items-center gap-2; }
        .stats-subtab.active { @apply bg-amber-500 text-white shadow-md transform scale-105; }
        .stats-subtab.inactive { @apply text-gray-600 bg-transparent hover:bg-gray-100 hover:text-gray-900; }
        /* Chart Styles */
        .chart-container {
            display: flex;
            align-items: flex-end;
            height: 150px;
            gap: 4px;
            padding-top: 20px;
            border-bottom: 1px solid #e5e7eb;
        }
        .chart-bar {
            flex: 1;
            background-color: #3b82f6;
            border-radius: 4px 4px 0 0;
            position: relative;
            min-width: 8px;
            transition: height 0.3s ease;
        }
        .chart-bar:hover { opacity: 0.8; }
        .chart-label {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            font-weight: bold;
            color: #374151;
        }
        /* --- ESTILOS PIZARRA T√ÅCTICA --- */
        .pitch-container {
            width: 100%;
            /* Relaci√≥n de aspecto horizontal (4:3 o 3:2 seg√∫n prefieras) */
            height: 100%; width: 100%;
            background-color: #2e7d32;
            background-image: 
                linear-gradient(rgba(255,255,255,0.2) 2px, transparent 2px),
                linear-gradient(90deg, rgba(255,255,255,0.2) 2px, transparent 2px);
            background-size: 50px 50px; /* Cuadr√≠cula m√°s peque√±a */
            position: relative;
            border: 4px solid white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.3);
            margin: 0 auto;
        }
        
        /* Ajustar l√≠neas para campo horizontal */
        .pitch-line-mid {
            width: 2px; /* Ahora es vertical */
            height: 100%;
            left: 50%;
            top: 0;
            background: rgba(255,255,255,0.6);
            position: absolute;
        }
        .pitch-circle {
            width: 15%; /* Ajustar tama√±o relativo */
            aspect-ratio: 1/1; /* Mantener c√≠rculo perfecto */
            height: auto;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            position: absolute;
            border: 2px solid rgba(255,255,255,0.6);
        }
        .pitch-box-left, .pitch-box-right {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 15%;
            height: 40%;
            border: 2px solid rgba(255,255,255,0.6);
        }
        .pitch-box-left { left: -2px; border-left: none; }
        .pitch-box-right { right: -2px; border-right: none; }

        /* Fichas de Jugadores */
        .player-token {
            width: 45px;
            height: 45px;
            position: absolute;
            transform: translate(-50%, -50%); /* Para centrar exacto en la coordenada */
            background: white;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            cursor: grab;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: all 0.2s ease;
        }
        .player-token:active { cursor: grabbing; transform: translate(-50%, -50%) scale(1.1); }
        .player-token img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: top center; /* <--- ESTO ES LA CLAVE */
            border-radius: 50%;
            pointer-events: none;
        }
        .player-token-name {
            position: absolute;
            bottom: -18px;
            background: rgba(0,0,0,0.7);
            color: white;
            font-size: 9px;
            padding: 2px 4px;
            border-radius: 4px;
            white-space: nowrap;
            pointer-events: none;
        }

        /* Zona de Banquillo (Drag Source) */
        .bench-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 10px;
            background: #f3f4f6;
            border-radius: 8px;
            min-height: 100px;
            align-content: flex-start;
        }
        .bench-slot {
            width: 50px;
            height: 50px;
            background: #e5e7eb;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 2px dashed #9ca3af;
        }

        /* huecos vac√≠os en el campo */
        .pitch-slot {
            width: 45px;
            height: 45px;
            position: absolute;
            transform: translate(-50%, -50%);
            border: 2px dashed rgba(255,255,255,0.5);
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            z-index: 5;
        }
        /* --- MODO OSCURO (DARK MODE) --- */
        body.dark-mode { background-color: #0f172a; color: #f1f5f9; }
        
        .dark-mode .bg-white { background-color: #1e293b !important; color: #f1f5f9; border-color: #334155; }
        .dark-mode .bg-gray-50, .dark-mode .bg-gray-100 { background-color: #0f172a !important; color: #cbd5e1; border-color: #334155; }
        .dark-mode .bg-gray-200 { background-color: #334155 !important; color: #e2e8f0; }
        
        .dark-mode .text-gray-800, .dark-mode .text-gray-700, .dark-mode .text-gray-600 { color: #f1f5f9 !important; }
        .dark-mode .text-gray-500 { color: #94a3b8 !important; }
        .dark-mode .text-slate-700, .dark-mode .text-slate-800 { color: #f8fafc !important; }
        
        .dark-mode .border-gray-200, .dark-mode .border-gray-300, .dark-mode .border-gray-100 { border-color: #334155 !important; }
        
        .dark-mode input, .dark-mode select { 
            background-color: #1e293b; 
            border-color: #475569; 
            color: #f1f5f9; 
        }
        .dark-mode input:focus, .dark-mode select:focus { border-color: #fbbf24; }
        .dark-mode .card:hover { background-color: #334155; }
        
        /* Ajustes Espec√≠ficos */
        .dark-mode .modal .bg-white { background-color: #1e293b !important; }
        .dark-mode th { background-color: #0f172a; color: #fbbf24; }
        .dark-mode .calendar-day { background-color: #1e293b; border-color: #334155; }
        .dark-mode .calendar-day:hover { background-color: #334155; }
        .dark-mode .calendar-day.other-month { background-color: #0f172a; opacity: 0.5; }
        
        /* Ajuste de Pizarra */
        .dark-mode .pitch-container { border-color: #334155; }
        .dark-mode .bench-container { background-color: #0f172a; border-color: #334155; }
        .dark-mode .player-token { border-color: #334155; background-color: #1e293b; color: white; }
        /* Estilos del Best XI */
        .player-card-pitch {
            position: absolute;
            transform: translate(-50%, -50%);
            display: flex;
            flex-col: column;
            align-items: center;
            width: 80px;
            text-align: center;
            transition: all 0.3s ease;
        }
        .player-card-pitch:hover { transform: translate(-50%, -60%) scale(1.1); z-index: 20; }
        
        .pitch-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background-color: white;
            border: 3px solid #fbbf24; /* Amber border */
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            color: #1f2937;
            font-size: 18px;
            margin-bottom: 4px;
            overflow: hidden;
        }
        /* ‚úÖ A√ëADIDO object-position: top !important */
        .pitch-avatar img { width: 100%; height: 100%; object-fit: cover; object-position: top center !important; }
        .pitch-name {
            background-color: rgba(31, 41, 55, 0.9);
            color: white;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: bold;
            white-space: nowrap;
            box-shadow: 0 2px 4px rgba(0,0,0,0.2);
        }
        .pitch-rating {
            background-color: #fbbf24;
            color: #1f2937;
            font-size: 10px;
            font-weight: 800;
            padding: 1px 6px;
            border-radius: 8px;
            margin-top: -8px;
            z-index: 10;
            border: 1px solid white;
        }
        /* ESTILOS MVP CARD */
        .mvp-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            border: 1px solid #e5e7eb;
            position: relative;
        }
        .mvp-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            border-color: #fbbf24;
        }
        .mvp-card::before {
            content: '';
            position: absolute;
            top: 0; left: 0; right: 0; height: 6px;
            background: linear-gradient(90deg, #fbbf24, #d97706);
        }
        .mvp-photo-container {
            width: 120px;
            height: 120px;
            margin: 20px auto 10px;
            position: relative;
        }
        .mvp-photo {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
            object-position: top;
            border: 4px solid #fff;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .mvp-crown {
            position: absolute;
            top: -15px;
            right: -10px;
            font-size: 24px;
            filter: drop-shadow(0 2px 2px rgba(0,0,0,0.2));
            animation: bounce 2s infinite;
        }

        /* ESTILOS CARTA FUT */
.fut-card-wrapper {
    perspective: 1000px;
    width: 220px;
    height: 320px;
    margin: 0 auto;
}
.fut-card {
    width: 100%; height: 100%;
    background: linear-gradient(135deg, #18181b 0%, #27272a 100%);
    border: 2px solid #fbbf24;
    border-radius: 18px;
    color: #fbbf24;
    position: relative;
    font-family: 'Inter', sans-serif;
    box-shadow: 0 0 25px rgba(251, 191, 36, 0.2), inset 0 0 20px rgba(0,0,0,0.5);
    text-align: center;
    padding-top: 25px;
    overflow: hidden;
    transition: transform 0.5s;
    user-select: none;
}
.fut-card:hover { transform: rotateY(10deg) rotateX(5deg) scale(1.05); z-index: 50; }
.fut-card::before {
    content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
    pointer-events: none;
}
.fut-rating { font-size: 3.5rem; font-weight: 900; line-height: 0.9; text-shadow: 2px 2px 0px #000; }
.fut-pos { font-size: 1.2rem; font-weight: bold; opacity: 0.9; text-transform: uppercase; margin-bottom: 5px; }
.fut-img { 
    width: 130px; height: 130px; 
    object-fit: cover; object-position: top; 
    margin: 5px auto; 
    border-radius: 50%; 
    border: 3px solid #fbbf24; 
    box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    background-color: #000;
}
.fut-name { 
    font-size: 1.3rem; font-weight: 800; text-transform: uppercase; 
    margin-bottom: 12px; border-bottom: 1px solid rgba(251,191,36,0.3); 
    padding-bottom: 5px; margin-left: 15px; margin-right: 15px;
    text-shadow: 1px 1px 0px #000;
    white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
}
.fut-stats { display: grid; grid-template-columns: 1fr 1fr; gap: 4px 15px; font-size: 0.85rem; padding: 0 25px; text-align: left; }
.fut-stat-val { font-weight: 900; margin-right: 3px; color: #fff; }
.fut-stat-label { font-weight: 500; font-size: 0.75rem; opacity: 0.8; }
/* Estilo para jugadores Inactivos (Leyendas) */
.player-card.legend-style {
    filter: sepia(0.6) contrast(1.1); /* Efecto foto antigua */
    border-color: #78350f; /* Borde color bronce/cuero */
    background: #fffbf0;
}
.player-card.legend-style img {
    filter: grayscale(100%); /* Foto en blanco y negro */
    opacity: 0.9;
}
.player-card.legend-style .font-bold {
    color: #78350f !important;
    font-family: 'Georgia', serif; /* Fuente m√°s cl√°sica */
}
/* Peque√±a etiqueta "LEYENDA" */
.player-card.legend-style::after {
    content: 'LEYENDA';
    position: absolute;
    top: 10px; right: 10px;
    font-size: 8px; font-weight: bold;
    background: #78350f; color: #fff;
    padding: 2px 4px; border-radius: 4px;
}
/* --- ESTILOS DE ESTADO (ACTUALIZADO) --- */

/* 1. INACTIVO (Gris y apagado) */
.player-card.status-inactivo {
    background-color: #f3f4f6;
    border-color: #e5e7eb;
    opacity: 0.75;
}
.player-card.status-inactivo img {
    filter: grayscale(100%);
    opacity: 0.8;
}

/* 2. LEYENDA (Blanco y Negro con Tono Dorado) */
.player-card.status-leyenda {
    background: linear-gradient(135deg, #fffbeb 0%, #fff7ed 100%);
    border: 2px solid #d97706; /* Borde √Åmbar Oscuro */
    box-shadow: 0 4px 15px rgba(217, 119, 6, 0.15);
    position: relative;
    overflow: hidden;
}

/* EFECTO FOTO LEYENDA: Blanco y Negro + Toque Sepia/Dorado */
.player-card.status-leyenda img {
    /* Esto hace la magia: quita el color y a√±ade tono antiguo */
    filter: grayscale(100%) sepia(50%) hue-rotate(5deg); 
    opacity: 0.95;
    border-color: #fbbf24 !important; /* El borde sigue siendo dorado brillante */
}

/* Etiqueta LEYENDA en la esquina */
.player-card.status-leyenda::after {
    content: 'üëë LEYENDA';
    position: absolute;
    top: 0; right: 0;
    background: #d97706;
    color: white;
    font-size: 9px;
    font-weight: bold;
    padding: 2px 6px;
    border-bottom-left-radius: 8px;
    z-index: 10;
}

/* Textos en color dorado/bronce para que combinen */
.player-card.status-leyenda h3 { color: #92400e !important; }
.player-card.status-leyenda .text-slate-700 { color: #b45309 !important; }
        /* --- SALA DE TROFEOS --- */
.trophy-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 15px;
    padding: 10px;
}
.trophy-card {
    background: white;
    border-radius: 12px;
    padding: 15px;
    border: 1px solid #e5e7eb;
    position: relative;
    overflow: hidden;
    transition: transform 0.3s ease;
}
.trophy-card:hover { transform: translateY(-3px); box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); }

/* Fondo dorado suave para trofeos desbloqueados */
.trophy-unlocked { border-color: #fbbf24; background: linear-gradient(to bottom right, #fffbeb, #fff); }
/* Gris para bloqueados */
.trophy-locked { opacity: 0.6; filter: grayscale(1); background: #f9fafb; border-style: dashed; }

.trophy-icon { font-size: 2.5rem; margin-bottom: 10px; display: block; }
.trophy-title { font-weight: 800; color: #1f2937; font-size: 1.1rem; margin-bottom: 4px; }
.trophy-desc { font-size: 0.8rem; color: #6b7280; margin-bottom: 12px; line-height: 1.4; }

/* Lista de ganadores dentro de la tarjeta */
.trophy-winners {
    border-top: 1px solid #f3f4f6;
    padding-top: 10px;
    margin-top: 10px;
    display: flex;
    flex-wrap: wrap;
    gap: 5px;
}
.winner-badge {
    display: flex;
    align-items: center;
    gap: 5px;
    background: #fff;
    border: 1px solid #e5e7eb;
    padding: 3px 8px;
    border-radius: 20px;
    font-size: 0.75rem;
    font-weight: 600;
    box-shadow: 0 1px 2px rgba(0,0,0,0.05);
}
.player-card img,                  /* Si tus cartas tienen esta clase */
#player-modal-header-container img, /* La foto grande del modal */
.card img {                        /* Cartas gen√©ricas */
    object-fit: cover;
    object-position: top center !important;
}
/* Efecto de brillo para trofeos muy raros */
.trophy-rare::after {
    content: ''; position: absolute; top: -50%; left: -50%; width: 200%; height: 200%;
    background: linear-gradient(45deg, transparent, rgba(251, 191, 36, 0.1), transparent);
    transform: rotate(45deg); pointer-events: none;
}
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-3px); }
        }
        /* --- EFECTO ON FIRE (RACHA) --- */

/* Animaci√≥n de brillo naranja pulsante */
@keyframes fire-pulse {
    0% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.7); border-color: #f97316; }
    70% { box-shadow: 0 0 0 6px rgba(249, 115, 22, 0); border-color: #fb923c; }
    100% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0); border-color: #f97316; }
}

/* Animaci√≥n para el icono de la llama */
@keyframes flame-bounce {
    0%, 100% { transform: translateY(0) scale(1); filter: drop-shadow(0 0 2px orange); }
    50% { transform: translateY(-3px) scale(1.1); filter: drop-shadow(0 0 5px red); }
}

/* Clase que aplicaremos a la carta */
.player-card.status-on-fire {
    animation: fadeInUp 0.5s ease-out forwards, fire-pulse 2s infinite;
    z-index: 10; /* Que sobresalga un poco */
}

/* El icono de fuego flotante */
.fire-badge-icon {
    position: absolute;
    top: -10px;
    left: -10px;
    font-size: 24px;
    z-index: 20;
    animation: flame-bounce 1.5s infinite ease-in-out;
    background: white;
    border-radius: 50%;
    width: 30px; 
    height: 30px;
    display: flex; 
    align-items: center; 
    justify-content: center;
    box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    border: 1px solid #ffedd5;
}
/* --- EFECTO HOLO / SHINE (CARTA BRILLANTE) --- */

/* Clase base para el brillo */
.holo-effect {
    position: relative;
    overflow: hidden; /* Importante: para que el brillo no se salga de la carta */
}

/* El haz de luz */
.holo-effect::after {
    content: "";
    position: absolute;
    top: 0;
    left: -200%; /* Empieza fuera a la izquierda */
    width: 200%;
    height: 100%;
    background: linear-gradient(
        115deg,
        transparent 30%,
        rgba(255, 255, 255, 0.4) 45%, /* Brillo blanco central */
        rgba(255, 255, 255, 0.2) 50%,
        transparent 60%
    );
    transform: skewX(-20deg);
    animation: holo-shine 5s infinite ease-in-out; /* Se repite cada 5s */
    pointer-events: none; /* Permite hacer clic a trav√©s del brillo */
    z-index: 20;
}

/* Animaci√≥n del movimiento */
@keyframes holo-shine {
    0% { left: -200%; opacity: 0; }
    10% { opacity: 1; }
    30% { left: 200%; opacity: 0; } /* Cruza r√°pido */
    100% { left: 200%; opacity: 0; } /* Espera */
}

/* Efecto extra al pasar el rat√≥n (Brillo m√°s intenso) */
.holo-effect:hover::after {
    animation: none; /* Paramos la autom√°tica */
    left: -50%;
    transition: left 0.5s; /* Se mueve con el rat√≥n (simulado) */
    background: linear-gradient(
        115deg,
        transparent 0%,
        rgba(255, 255, 255, 0.6) 50%,
        transparent 100%
    );
}
/* --- EFECTO WATERFALL (Entrada en Cascada) --- */

/* Animaci√≥n de entrada */
@keyframes fadeInUp {
    from {
        opacity: 0;
        transform: translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

/* Clase que aplicaremos a cada carta */
.card-animate-enter {
    opacity: 0; /* Empieza invisible */
    animation: fadeInUp 0.5s ease-out forwards; /* forwards mantiene el estado final */
}
/* --- CORRECCI√ìN ANIMACI√ìN FUEGO --- */
@keyframes fire-border-pulse {
    0% { box-shadow: inset 0 0 0 1px #f97316, 0 0 0 0 rgba(249, 115, 22, 0.7); }
    50% { box-shadow: inset 0 0 0 2px #fb923c, 0 0 0 4px rgba(249, 115, 22, 0); }
    100% { box-shadow: inset 0 0 0 1px #f97316, 0 0 0 0 rgba(249, 115, 22, 0); }
}

/* --- EFECTO FROZEN (MALA RACHA) --- */

/* Animaci√≥n de temblor (fr√≠o) */
@keyframes shiver {
    0% { transform: translate(0px, 0px) rotate(0deg); }
    25% { transform: translate(1px, 1px) rotate(1deg); }
    50% { transform: translate(-1px, -1px) rotate(-1deg); }
    75% { transform: translate(0px, 1px) rotate(0deg); }
    100% { transform: translate(0px, 0px) rotate(0deg); }
}

/* Clase base para fondo g√©lido */
.status-frozen {
    background: linear-gradient(to bottom right, #f0f9ff, #e0f2fe) !important;
    border-color: #93c5fd !important; /* Borde azul suave */
}

/* El overlay azulado (borde interior) */
.frozen-overlay {
    position: absolute;
    inset: 0;
    border-radius: 0.75rem;
    z-index: 10;
    pointer-events: none;
    box-shadow: inset 0 0 0 1px #60a5fa, inset 0 0 15px rgba(59, 130, 246, 0.2);
}

/* Al pasar el rat√≥n, el jugador "tiembla" de fr√≠o */
.status-frozen:hover {
    animation: shiver 0.3s infinite ease-in-out;
    opacity: 1 !important; /* <--- ESTO SOLUCIONA QUE DESAPAREZCA */
    z-index: 20; /* Para que vibre por encima de las otras */
}
/* --- EFECTO CONFETI (VICTORIA) --- */
.confetti-container {
    position: fixed;
    top: 0; left: 0; width: 100%; height: 100%;
    pointer-events: none; /* Click a trav√©s */
    z-index: 9999;
    overflow: hidden;
}
.confetti-piece {
    position: absolute;
    width: 10px; height: 10px;
    top: -20px;
    opacity: 0.8;
}
@keyframes fall-y {
    0% { top: -20px; opacity: 1; }
    100% { top: 110vh; opacity: 0; }
}
@keyframes sway-x {
    0% { transform: translateX(0px) rotate(0deg); }
    25% { transform: translateX(20px) rotate(90deg); }
    50% { transform: translateX(-20px) rotate(180deg); }
    75% { transform: translateX(20px) rotate(270deg); }
    100% { transform: translateX(0px) rotate(360deg); }
}
/* --- FLIP CARD 3D --- */
.fut-scene {
    width: 300px; /* Ancho aproximado de tu carta */
    height: 480px; /* Alto aproximado */
    perspective: 1000px; /* Da la profundidad 3D */
    cursor: pointer;
    margin: 0 auto;
}

.fut-card-inner {
    position: relative;
    width: 100%;
    height: 100%;
    text-align: center;
    transition: transform 0.8s cubic-bezier(0.175, 0.885, 0.32, 1.275); /* Efecto rebote suave */
    transform-style: preserve-3d;
}

/* Esta clase se a√±ade con JS al hacer click */
.fut-scene.is-flipped .fut-card-inner {
    transform: rotateY(180deg);
}

/* Configuraci√≥n com√∫n para ambas caras */
.fut-card-front, .fut-card-back {
    position: absolute;
    width: 100%;
    height: 100%;
    -webkit-backface-visibility: hidden;
    backface-visibility: hidden;
    border-radius: 18px; /* Mismo radio que tu carta original */
    top: 0; left: 0;
}

/* La cara frontal es tu carta actual (.fut-card) */
.fut-card-front {
    z-index: 2;
    transform: rotateY(0deg);
}

/* ESTILO DE LA CARA TRASERA */
.fut-card-back {
    transform: rotateY(180deg);
    background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
    border: 2px solid #fbbf24; /* Borde dorado */
    color: white;
    display: flex;
    flex-direction: column;
    justify-content: center;
    align-items: center;
    padding: 20px;
    box-shadow: 0 10px 30px -5px rgba(0, 0, 0, 0.5);
}

/* Elementos decorativos de la parte trasera */
.back-logo { font-size: 60px; opacity: 0.1; margin-bottom: 20px; }
.back-row { display: flex; justify-content: space-between; width: 100%; border-bottom: 1px solid rgba(255,255,255,0.1); padding: 10px 0; font-size: 14px; }
.back-label { color: #9ca3af; }
.back-val { font-weight: bold; color: #fbbf24; }
.tap-hint { position: absolute; bottom: 15px; font-size: 10px; color: #6b7280; animation: pulse 2s infinite; }
/* --- NOTIFICACIONES TOAST --- */
.toast-container {
    position: fixed;
    top: 20px;
    right: 20px;
    z-index: 10000; /* Por encima de todo, incluso del confeti */
    display: flex;
    flex-direction: column;
    gap: 10px;
}

.toast {
    min-width: 250px;
    padding: 16px 20px;
    border-radius: 12px;
    background: white;
    box-shadow: 0 10px 30px rgba(0,0,0,0.15);
    display: flex;
    align-items: center;
    gap: 12px;
    font-size: 14px;
    font-weight: 600;
    color: #1f2937;
    animation: slideInRight 0.3s ease-out forwards;
    border-left: 5px solid;
    overflow: hidden;
}

.toast.success { border-left-color: #10b981; } /* Verde */
.toast.error { border-left-color: #ef4444; }   /* Rojo */
.toast.info { border-left-color: #3b82f6; }    /* Azul */

.toast-icon { font-size: 18px; }

/* Animaci√≥n de entrada */
@keyframes slideInRight {
    from { transform: translateX(100%); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
}

/* Animaci√≥n de salida (se a√±ade con JS) */
.toast.hide {
    animation: fadeOutRight 0.3s ease-in forwards;
}
@keyframes fadeOutRight {
    to { transform: translateX(100%); opacity: 0; }
}
   /* --- EFECTO JELLY (BOTONES GOMINOLA) üçÆ --- */

@keyframes jelly-pop {
    0% { transform: scale(1, 1); }
    30% { transform: scale(1.15, 0.75); } /* Se aplasta (ancho y bajo) */
    40% { transform: scale(0.75, 1.25); } /* Se estira (alto y fino) */
    50% { transform: scale(1.15, 0.85); } /* Se aplasta un poco */
    65% { transform: scale(0.95, 1.05); } /* Se estira un poco */
    75% { transform: scale(1.05, 0.95); } /* Rebote final */
    100% { transform: scale(1, 1); }      /* Vuelta a la normalidad */
}

/* Esta clase la inyectaremos con JS al hacer clic */
.jelly-active {
    animation: jelly-pop 0.6s ease-out; /* Dura 0.6 segundos */
}

/* Opcional: Para que todos los botones tengan una transici√≥n suave por defecto */
button, .btn, input[type="submit"], input[type="button"] {
    transition: all 0.2s ease;
}

/* Efecto visual extra al presionar (antes de soltar) */
button:active, .btn:active {
    transform: scale(0.95); /* Se encoge un poquito al mantener pulsado */
}

/* --- CORRECCI√ìN DE CAPAS DE LA PIZARRA --- */

/* 1. Aseguramos que el contenedor principal de la pizarra sea la referencia */
/* Busca la clase o ID del div que envuelve todo el campo de f√∫tbol */
.tactical-board-container, /* Sustituye por la clase real de tu contenedor del campo */
#tactical-pitch {          /* O el ID si usas uno */
    position: relative !important;
    /* overflow: hidden;  <-- Descomenta esto si las fichas se salen del campo al caer */
}

/* 2. Forzamos a que las DOS capas (huecos y jugadores) sean id√©nticas y se superpongan */
/* Usamos un selector de atributo para que pille cualquier ID que termine en estos nombres */
[id$="pitch-slots-layer"],
[id$="pitch-players-layer"] {
    position: absolute !important;
    top: 0 !important;
    left: 0 !important;
    width: 100% !important;
    height: 100% !important;
    pointer-events: none; /* Lo dejas pasar, ya lo gestionan los hijos */
}

/* El de los jugadores debe estar por encima */
[id$="pitch-players-layer"] {
    z-index: 10;
}
/* --- EFECTO CA√çDA CON REBOTE (CORREGIDO) --- */
@keyframes drop-bounce {
    0% { 
        /* Empieza centrado en X, pero muy arriba en Y */
        transform: translate(-50%, -400px); 
        opacity: 0; 
    }
    40% { 
        opacity: 1; 
    }
    70% { 
        /* Rebote hacia abajo: Mantenemos X en -50%, Y baja un poco m√°s del centro (-50% + 20px) */
        transform: translate(-50%, calc(-50% + 20px)); 
    }
    85% { 
        /* Rebote hacia arriba: X en -50%, Y sube un poco (-50% - 10px) */
        transform: translate(-50%, calc(-50% - 10px)); 
    }
    100% { 
        /* ESTADO FINAL: Perfectamente centrado */
        transform: translate(-50%, -50%); 
        opacity: 1; 
    }
}

.animate-drop {
    /* Mantenemos la configuraci√≥n de tiempo */
    animation: drop-bounce 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) forwards;
    /* Importante: para que el elemento acepte el transform, debe ser block o inline-block */
    display: block; 
    opacity: 0; 
    /* Aseguramos que el origen de la transformaci√≥n sea el centro */
    transform-origin: center center;
}

/* =========================================
   1. ANIMACIONES GENERALES (Gr√°ficos y Barras)
   ========================================= */

/* Crecer hacia arriba (para el gr√°fico de historial) */
@keyframes grow-up {
    from { transform: scaleY(0); }
    to { transform: scaleY(1); }
}

.animate-bar-up {
    transform-origin: bottom;
    animation: grow-up 1s cubic-bezier(0.34, 1.56, 0.64, 1) forwards;
    transform: scaleY(0);
}

/* Crecer hacia la derecha (barras de progreso normales) */
@keyframes grow-right {
    from { transform: scaleX(0); }
    to { transform: scaleX(1); }
}

.animate-bar-right {
    transform-origin: left;
    animation: grow-right 1.2s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    transform: scaleX(0);
}

/* =========================================
   2. ANIMACI√ìN COMPARADOR (LA SOLUCI√ìN üõ†Ô∏è)
   ========================================= */

@keyframes grow-scale-x {
    0% { transform: scaleX(0); }
    100% { transform: scaleX(1); }
}

.animate-bar {
    /* --- EL FIX IMPORTANTE --- */
    /* !important obliga a que empiece invisible s√≠ o s√≠ */
    transform: scaleX(0) !important; 
    
    /* Animaci√≥n de 1.5s suave */
    animation: grow-scale-x 1.5s cubic-bezier(0.16, 1, 0.3, 1) forwards;
    
    /* Optimizaci√≥n para el navegador */
    will-change: transform;
}


/* Or√≠genes de crecimiento (con !important para asegurar prioridad) */
.origin-left { transform-origin: left !important; }
.origin-right { transform-origin: right !important; }


/* =========================================
   3. EFECTO VS (STREET FIGHTER)
   ========================================= */

.vs-overlay {
    position: absolute;
    top: 0; left: 0; width: 100%; height: 100%;
    background: #0f172a; /* Fondo oscuro */
    z-index: 50;
    display: flex;
    justify-content: center;
    align-items: center;
    border-radius: 12px;
    overflow: hidden;
}

.vs-fighter {
    width: 120px; 
    height: 120px;
    border-radius: 50%;
    border: 4px solid #fbbf24; /* Borde dorado */
    box-shadow: 0 0 30px rgba(251, 191, 36, 0.4);
    
    /* Ajuste perfecto de la foto */
    object-fit: cover;        
    object-position: top center; 
    background-color: #333;   
    
    position: absolute;
}

.vs-text {
    font-size: 80px; 
    font-weight: 900;
    color: #ef4444; 
    text-shadow: 
        0 0 10px rgba(0,0,0,0.8),
        4px 4px 0 #7f1d1d;
    z-index: 55;
    opacity: 0;
    transform: scale(0);
    font-family: 'Arial Black', sans-serif;
    font-style: italic;
}

/* --- KEYFRAMES DEL VS --- */

@keyframes slide-crash-left {
    0% { transform: translateX(-400%) scale(0.5); opacity: 0; }
    60% { transform: translateX(30%) scale(1.2); opacity: 1; } 
    100% { transform: translateX(-15%) scale(1); }
}

@keyframes slide-crash-right {
    0% { transform: translateX(400%) scale(0.5); opacity: 0; }
    60% { transform: translateX(-30%) scale(1.2); opacity: 1; }
    100% { transform: translateX(15%) scale(1); }
}

@keyframes rumble {
    0% { transform: translate(0, 0) rotate(0deg); }
    20% { transform: translate(-10px, 10px) rotate(-5deg); }
    40% { transform: translate(10px, -10px) rotate(5deg); }
    60% { transform: translate(-5px, -5px) rotate(-3deg); }
    80% { transform: translate(5px, 5px) rotate(3deg); }
    100% { transform: translate(0, 0) rotate(0deg); }
}

@keyframes pop-in {
    0% { transform: scale(0) rotate(-45deg); opacity: 0; }
    50% { transform: scale(1.5) rotate(0deg); opacity: 1; }
    70% { transform: scale(0.9); }
    100% { transform: scale(1); opacity: 1; }
}

@keyframes fade-out-overlay {
    to { opacity: 0; visibility: hidden; }
}

/* Clases de utilidad para activar animaciones JS */
.anim-slide-left { animation: slide-crash-left 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
.anim-slide-right { animation: slide-crash-right 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }
.anim-rumble { animation: rumble 0.4s ease-in-out; }
.anim-pop { animation: pop-in 0.4s cubic-bezier(0.68, -0.55, 0.265, 1.55) forwards; }
.anim-fade-out { animation: fade-out-overlay 0.6s ease forwards; }
/* --- BARRAS DE PLASMA (FLOWING ENERGY) --- */

@keyframes plasma-flow {
    0% { background-position: 0 0; }
    100% { background-position: 50px 50px; } /* Mueve la textura */
}

.plasma-bar {
    /* Creamos un patr√≥n rayado sutil sobre el color base */
    background-image: linear-gradient(
        45deg, 
        rgba(255, 255, 255, 0.15) 25%, 
        transparent 25%, 
        transparent 50%, 
        rgba(255, 255, 255, 0.15) 50%, 
        rgba(255, 255, 255, 0.15) 75%, 
        transparent 75%, 
        transparent
    );
    background-size: 20px 20px; /* Tama√±o del patr√≥n */
    animation: plasma-flow 1s linear infinite; /* Animaci√≥n continua y suave */
}

/* Opcional: Un brillo interno para que parezca cristal/gel */
.plasma-glow {
    box-shadow: inset 0 0 10px rgba(255,255,255,0.3);
}

/* --- ESTADO ON FIRE (L√≥gica id√©ntica al Hielo) --- */

/* Clase base para fondo c√°lido */
.status-on-fire {
    /* Degradado naranja muy suave, igual que el azul suave del hielo */
    background: linear-gradient(to bottom right, #fff7ed, #ffedd5) !important;
    border-color: #fb923c !important; /* Borde naranja */
}

/* El overlay naranja (borde interior) */
.fire-overlay {
    position: absolute;
    inset: 0;
    border-radius: 0.75rem;
    z-index: 10;
    pointer-events: none;
    /* Box-shadow naranja, igual que el azul del hielo */
    box-shadow: inset 0 0 0 1px #f97316, inset 0 0 15px rgba(249, 115, 22, 0.2);
}

/* Al pasar el rat√≥n, el jugador "vibra" de energ√≠a */
.status-on-fire:hover {
    /* Reutilizamos la animaci√≥n de temblor o creamos una de pulso */
    animation: shiver 0.3s infinite ease-in-out; 
    opacity: 1 !important; /* CLAVE PARA QUE NO DESAPAREZCA */
    z-index: 20;
}
/* Brazalete de Capit√°n */
.captain-badge {
    position: absolute;
    top: -5px;
    right: -5px;
    width: 18px;
    height: 18px;
    background-color: #fbbf24; /* Amarillo */
    color: #000;
    border: 2px solid white;
    border-radius: 50%;
    font-size: 10px;
    font-weight: bold;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 60;
    box-shadow: 0 2px 4px rgba(0,0,0,0.3);
}
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>    
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.2.0"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>

</head>
<body class="bg-gray-100 min-h-screen">

    <!-- WELCOME SCREEN -->
    <section id="section-welcome" class="welcome-bg min-h-screen flex flex-col items-center justify-center p-4 text-white">
        <div class="text-center mb-10">
            <img src="https://upload.wikimedia.org/wikipedia/en/thumb/5/56/Real_Madrid_CF.svg/1200px-Real_Madrid_CF.svg.png" 
                 alt="Real Madrid" class="w-24 h-24 object-contain mx-auto mb-4 drop-shadow-2xl">
            <h1 class="text-3xl md:text-5xl font-bold mb-2 drop-shadow-md">Notas Real Madrid</h1>
            <p class="text-blue-100 font-medium text-lg drop-shadow-md">Temporada 2025/2026</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-4xl">
            <!-- MASCULINO -->
            <div onclick="selectTeam('masculino')" class="welcome-card bg-white/10 backdrop-blur-sm text-white rounded-2xl p-8 text-center shadow-2xl border-b-8 border-blue-600 hover:bg-white/20 transition-all">
                <h2 class="text-2xl font-bold mb-2">Real Madrid Masculino</h2>
                <p class="text-black-200 font-semibold">Temporada 2025/2026</p>
                <p class="text-sm text-black-300 mt-2">La Liga, Champions, Copa del Rey...</p>
            </div>

            <!-- FEMENINO -->
            <div onclick="selectTeam('femenino')" class="welcome-card bg-white/10 backdrop-blur-sm text-white rounded-2xl p-8 text-center shadow-2xl border-b-8 border-purple-500 hover:bg-white/20 transition-all">
                <h2 class="text-2xl font-bold mb-2">Real Madrid Femenino</h2>
                <p class="text-black-200 font-semibold">Temporada 2025/2026</p>
                <p class="text-sm text-black-300 mt-2">Liga F, UWCL, Copa de la Reina...</p>
            </div>
        </div>
    </section>
    <!-- APP CONTAINER (Hidden initially) -->
    <div id="app-container" class="hidden bg-gray-100">
        <!-- Header Real Madrid -->
        <header class="rm-header-gradient text-white shadow-lg">
            <div class="container mx-auto px-4 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3 cursor-pointer hover:opacity-80 transition" onclick="returnToWelcome()" title="Volver a selecci√≥n de equipo">
                        <img src="https://upload.wikimedia.org/wikipedia/en/thumb/5/56/Real_Madrid_CF.svg/1200px-Real_Madrid_CF.svg.png" 
                             alt="Real Madrid" class="w-12 h-12 object-contain">
                        <div>
                            <h1 class="text-2xl font-bold">An√°lisis Real Madrid</h1>
                            <p id="header-subtitle" class="text-blue-200 text-sm">Real Madrid CF</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3 cursor-pointer hover:opacity-80 transition" onclick="returnToWelcome()" ...>
                        </div>

                    <button onclick="toggleDarkMode()" id="btn-dark-mode" class="p-2 rounded-full bg-white/10 hover:bg-white/20 transition backdrop-blur-sm" title="Cambiar Tema">
                        üåô
                    </button>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="bg-slate-800 shadow-sm sticky top-0 z-40">
            <div class="container mx-auto px-4">
                <div class="flex gap-1 overflow-x-auto">
                    <button onclick="showTab('principal')" id="tab-principal" class="tab-btn px-4 py-3 font-medium text-gray-300 hover:text-amber-400 whitespace-nowrap">
                        üè† Principal
                    </button>
                    <button onclick="showTab('plantilla')" id="tab-plantilla" class="tab-btn px-4 py-3 font-medium text-gray-300 hover:text-amber-400 whitespace-nowrap tab-active">
                        üë• Plantilla
                    </button>
                    <button onclick="showTab('calendario')" id="tab-calendario" class="tab-btn px-4 py-3 font-medium text-gray-300 hover:text-amber-400 whitespace-nowrap">
                        üìÖ Calendario
                    </button>
                    <button onclick="showTab('nuevo')" id="tab-nuevo" class="tab-btn px-4 py-3 font-medium text-gray-300 hover:text-amber-400 whitespace-nowrap">
                        ‚ûï Registrar Partido
                    </button>
                    <button onclick="showTab('partidos')" id="tab-partidos" class="tab-btn px-4 py-3 font-medium text-gray-300 hover:text-amber-400 whitespace-nowrap">
                        ‚öΩ Partidos
                    </button>
                    <button onclick="showTab('stats')" id="tab-stats" class="tab-btn px-4 py-3 font-medium text-gray-300 hover:text-amber-400 whitespace-nowrap">
                        üìä Estad√≠sticas
                    </button>
                    <button onclick="showTab('comparador')" id="tab-comparador" class="tab-btn px-4 py-3 font-medium text-gray-300 hover:text-amber-400 whitespace-nowrap">
                        üÜö Comparador
                    </button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="container mx-auto px-4 py-6">
            <!--Men√∫ principal-->
            <section id="section-principal" class="hidden fade-in">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Panel General</h2>
                    <p class="text-gray-500 text-sm">Resumen de la temporada actual</p>
                </div>
                <div id="competition-status" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                    
                    <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 border-slate-800 relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-4 opacity-10 text-slate-800 text-6xl">üìÖ</div>
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Pr√≥ximo Partido</h3>
                        <div id="dashboard-next-match">
                            <p class="text-gray-500 text-sm">Cargando...</p>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 border-amber-400 relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-4 opacity-10 text-amber-500 text-6xl">üî•</div>
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Estado de Forma (√öltimos 5)</h3>
                        <div id="dashboard-form" class="flex items-center gap-2 mt-2">
                            <span class="text-gray-500 text-sm">Sin datos</span>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 border-blue-600 relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-4 opacity-10 text-blue-600 text-6xl">üìä</div>
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Resumen Temporada</h3>
                        <div id="dashboard-summary" class="flex justify-between items-end mt-2">
                             <div class="text-center">
                                <span class="block text-2xl font-bold text-green-600" id="dash-wins">0</span>
                                <span class="text-xs text-gray-500">Vic</span>
                             </div>
                             <div class="text-center">
                                <span class="block text-2xl font-bold text-amber-600" id="dash-draws">0</span>
                                <span class="text-xs text-gray-500">Emp</span>
                             </div>
                             <div class="text-center">
                                <span class="block text-2xl font-bold text-red-600" id="dash-losses">0</span>
                                <span class="text-xs text-gray-500">Der</span>
                             </div>
                             <div class="w-px h-8 bg-gray-200 mx-1"></div>
                             <div class="text-center">
                                <span class="block text-xl font-bold text-slate-700" id="dash-gf">0</span>
                                <span class="text-xs text-gray-500">GF</span>
                             </div>
                             <div class="text-center">
                                <span class="block text-xl font-bold text-slate-700" id="dash-ga">0</span>
                                <span class="text-xs text-gray-500">GC</span>
                             </div>
                        </div>
                    </div>
                </div>
                  <div id="ai-prediction-card" class="hidden mb-8 bg-gradient-to-r from-violet-600 to-indigo-600 rounded-xl shadow-lg p-1 text-white relative overflow-hidden">
                    <div class="absolute top-0 right-0 p-8 opacity-10 text-9xl">ü§ñ</div>
                    
                    <div class="bg-slate-900/40 backdrop-blur-md rounded-lg p-5">
                        <div class="flex flex-col md:flex-row justify-between items-start md:items-center gap-6">
                            
                            <div class="flex-1">
                                <div class="flex items-center gap-2 mb-2">
                                    <span class="bg-violet-500 text-white text-[10px] font-bold px-2 py-1 rounded uppercase tracking-wider shadow-sm border border-violet-400">AI Analysis</span>
                                    <span class="text-violet-200 text-xs font-mono" id="ai-match-label">Analizando datos...</span>
                                </div>
                                <h3 class="text-2xl font-bold text-white mb-1 flex items-center gap-2">
                                    <span id="ai-prediction-text">Calculando probabilidades...</span>
                                </h3>
                                <p class="text-indigo-200 text-sm" id="ai-reasoning">Procesando racha y estad√≠sticas...</p>
                            </div>

                            <div class="w-full md:w-auto flex flex-col gap-2 min-w-[200px]">
                                <div class="flex justify-between text-xs font-bold text-indigo-100 uppercase tracking-widest">
                                    <span>Probabilidad de Victoria</span>
                                    <span id="ai-win-prob">--%</span>
                                </div>
                                <div class="w-full h-3 bg-slate-700/50 rounded-full overflow-hidden flex">
                                    <div id="prob-bar-win" class="h-full bg-green-400 shadow-[0_0_10px_rgba(74,222,128,0.5)] transition-all duration-1000" style="width: 0%"></div>
                                    <div id="prob-bar-draw" class="h-full bg-yellow-400 opacity-80 transition-all duration-1000" style="width: 0%"></div>
                                </div>
                                <div class="flex justify-between text-[10px] text-gray-300 mt-1">
                                    <span class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-green-400"></div> Victoria</span>
                                    <span class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-yellow-400"></div> Empate</span>
                                    <span class="flex items-center gap-1"><div class="w-2 h-2 rounded-full bg-slate-600"></div> Derrota</span>
                                </div>
                            </div>

                        </div>

                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-6 border-t border-white/10 pt-4">
                            <div class="flex items-center gap-3">
                                <div class="text-3xl">üîÆ</div>
                                <div>
                                    <p class="text-[10px] uppercase text-indigo-300 font-bold">Marcador Probable</p>
                                    <p class="text-xl font-bold text-white" id="ai-score-prediction">-</p>
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-3">
                                <div class="text-3xl">üî•</div>
                                <div>
                                    <p class="text-[10px] uppercase text-indigo-300 font-bold">Jugador a Seguir</p>
                                    <p class="text-sm font-bold text-white" id="ai-player-watch">-</p>
                                    <p class="text-[10px] text-indigo-200" id="ai-player-reason">-</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
              <div class="mb-8">
                <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                      üö¶ Sem√°foro de Forma <span class="text-xs font-normal text-gray-500 bg-gray-100 px-2 py-1 rounded">√öltimos 3 partidos</span>
              </h3>

               <div id="semaforo-content" class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
            <p class="text-center text-gray-400 py-4 col-span-3">Cargando datos...</p>
            </div>

          <div id="semaforo-expand-btn-container" class="hidden text-center">
            <button onclick="toggleTrafficAll()" id="btn-traffic-all" 
                class="px-6 py-2 bg-gray-100 hover:bg-gray-200 text-gray-600 font-bold rounded-full text-sm transition-all shadow-sm border border-gray-200">
               Ver todos los jugadores ‚ñº
                       </button>
                        </div>
            </div>
            <div id="top-performances-container" class="mt-6 mb-8 animate-fade-in hidden">
    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
        <span>üåü</span> Actuaciones Legendarias (Top 5)
    </h3>
    <div id="top-performances-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4">
        </div>
</div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="px-5 py-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                             <h3 class="font-bold text-gray-700">√öltimos Resultados</h3>
                             <button onclick="showTab('partidos')" class="text-xs text-blue-600 hover:underline">Ver todos</button>
                        </div>
                        <div id="dashboard-last-results" class="divide-y divide-gray-100">
                             </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="px-5 py-4 border-b border-gray-100 bg-gray-50">
                             <h3 class="font-bold text-gray-700">L√≠deres</h3>
                        </div>
                        <div id="dashboard-leaders" class="p-4 space-y-4">
                             </div>
                    </div>

                </div>
                <div class="mt-8 bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                        üíæ Gesti√≥n de Datos
                    </h3>
                    <p class="text-sm text-gray-500 mb-4">
                        Guarda una copia de seguridad de toda tu temporada o restaura un archivo guardado anteriormente. 
                        <span class="text-amber-600 font-bold">¬°Haz esto frecuentemente para no perder datos!</span>
                    </p>
                    
                   <div class="flex flex-col sm:flex-row gap-4">
                        <button onclick="backupData()" class="flex-1 bg-green-50 hover:bg-green-100 text-green-700 border border-green-200 px-4 py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition-all">
                            ‚¨áÔ∏è Descargar Copia
                        </button>

                        <div class="flex-1 relative">
                            <input type="file" id="import-file" accept=".json" class="hidden" onchange="restoreData(this)">
                            <button onclick="document.getElementById('import-file').click()" class="w-full bg-blue-50 hover:bg-blue-100 text-blue-700 border border-blue-200 px-4 py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition-all">
                                ‚¨ÜÔ∏è Restaurar Datos
                            </button>
                        </div>

                       <div class="flex-1 relative flex gap-2">
                            <input type="file" id="import-csv" accept=".csv" class="hidden" onchange="importFromCSV(this)">
                            
                            <button onclick="document.getElementById('import-csv').click()" class="flex-1 bg-orange-50 hover:bg-orange-100 text-orange-700 border border-orange-200 px-4 py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition-all">
                                üìä Importar Excel (CSV)
                            </button>

                            <button onclick="toggleCSVInfo()" class="w-12 flex items-center justify-center bg-white border border-gray-200 rounded-xl hover:bg-gray-50 transition-all shadow-sm" title="Ver formato requerido">
                                <img src="https://cdn-icons-png.flaticon.com/512/8/8201.png" alt="Info" class="w-6 h-6 opacity-70">
                            </button>

                            <div id="csv-info-modal" class="hidden absolute bottom-full right-0 mb-2 w-80 md:w-96 bg-white rounded-xl shadow-2xl border border-gray-200 z-50 p-0 overflow-hidden animate-in fade-in zoom-in duration-200">
                                <div class="bg-slate-800 text-white p-3 flex justify-between items-center">
                                    <h4 class="font-bold text-sm">üìÑ Formato Requerido para Excel</h4>
                                    <button onclick="toggleCSVInfo()" class="text-gray-400 hover:text-white">‚úï</button>
                                </div>
                                <div class="p-4 text-sm text-gray-600">
                                    <p class="mb-3">Para que la importaci√≥n funcione correctamente y detecte las fechas, usa esta estructura:</p>
                                    
                                    <div class="border border-gray-300 rounded overflow-hidden mb-3">
                                        <table class="w-full text-xs text-center">
                                            <tr class="bg-gray-100 font-bold border-b border-gray-300">
                                                <td class="p-1 border-r"></td>
                                                <td class="p-1 border-r text-blue-600">Rival A</td>
                                                <td class="p-1 text-blue-600">Rival B</td>
                                            </tr>
                                            <tr class="bg-yellow-50 border-b border-gray-300 font-mono text-[10px]">
                                                <td class="p-1 border-r font-bold text-gray-400">FECHA -></td>
                                                <td class="p-1 border-r text-orange-600 font-bold">26/10/2024</td>
                                                <td class="p-1 text-orange-600 font-bold">03/11/2024</td>
                                            </tr>
                                            <tr class="border-b border-gray-100">
                                                <td class="p-1 border-r font-bold text-left pl-2">Mbapp√©</td>
                                                <td class="p-1 border-r">8,5</td>
                                                <td class="p-1">7</td>
                                            </tr>
                                            <tr>
                                                <td class="p-1 border-r font-bold text-left pl-2">Vini Jr</td>
                                                <td class="p-1 border-r">9</td>
                                                <td class="p-1">6,5</td>
                                            </tr>
                                        </table>
                                    </div>

                                    <ul class="list-disc list-inside text-xs space-y-1 text-gray-500">
                                        <li><b>Fila 1:</b> Nombres de los Rivales.</li>
                                        <li><b>Fila 2:</b> Fechas (DD/MM/AAAA) <span class="text-orange-600 font-bold">*Importante</span>.</li>
                                        <li><b>Columna A:</b> Nombres de los Jugadores.</li>
                                        <li>Guarda el archivo como <b>CSV (delimitado por comas o punto y coma)</b>.</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4 pt-4 border-t border-gray-100 text-right">
                        <button onclick="hardReset()" class="text-xs text-red-400 hover:text-red-600 underline">
                            Borrar todo y empezar de cero
                        </button>
                    </div>
                </div>
            </section>
            
            <!-- PLANTILLA SECTION -->
            <section id="section-plantilla" class="fade-in">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Plantilla</h2>
                        <p class="text-gray-500 text-sm">Gesti√≥n de estado de jugadores</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="filterPlayers('all')" id="filter-all" class="px-3 py-1.5 text-sm bg-slate-800 text-white rounded-lg">
                            Todos
                        </button>
                        <button onclick="filterPlayers('active')" id="filter-active" class="px-3 py-1.5 text-sm bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                            Activos
                        </button>
                        <button onclick="filterPlayers('inactive')" id="filter-inactive" class="px-3 py-1.5 text-sm bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                            Inactivos
                        </button>
                    </div>
                </div>
                <div class="mb-4 relative">
    <input type="text" id="player-search" placeholder="üîç Buscar jugador por nombre o dorsal..." 
           class="w-full pl-10 pr-4 py-3 rounded-xl border border-gray-200 focus:border-indigo-500 focus:ring-2 focus:ring-indigo-200 outline-none transition-all"
           onkeyup="renderPlayers()">
    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
        <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
    </div>
</div>
                <!-- Filter by Position -->
                <div class="bg-white rounded-xl shadow-sm p-4 mb-4">
                    <div class="flex flex-wrap gap-2">
                        <button onclick="filterByPosition('')" class="pos-filter px-3 py-1 text-sm rounded-full bg-slate-800 text-white">Todas</button>
                        <button onclick="filterByPosition('entrenador')" class="pos-filter px-3 py-1 text-sm rounded-full bg-gray-200 hover:bg-slate-300 font-bold border border-slate-400">Entrenador</button>
                        <button onclick="filterByPosition('portero')" class="pos-filter px-3 py-1 text-sm rounded-full bg-gray-200 hover:bg-amber-100">Porter√≠a</button>
                        <button onclick="filterByPosition('defensa')" class="pos-filter px-3 py-1 text-sm rounded-full bg-gray-200 hover:bg-blue-100">Defensa</button>
                        <button onclick="filterByPosition('centrocampista')" class="pos-filter px-3 py-1 text-sm rounded-full bg-gray-200 hover:bg-green-100">Medio</button>
                        <button onclick="filterByPosition('extremo')" class="pos-filter px-3 py-1 text-sm rounded-full bg-gray-200 hover:bg-purple-100">Extremo</button>
                        <button onclick="filterByPosition('delantero')" class="pos-filter px-3 py-1 text-sm rounded-full bg-gray-200 hover:bg-red-100">Delantera</button>
                    </div>
                </div>
                
                <div id="players-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                </div>
            </section>

            <!-- CALENDARIO SECTION -->
            <section id="section-calendario" class="hidden fade-in">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Calendario Oficial</h2>
                        <p class="text-gray-500 text-sm">Haz clic en partidos pasados para registrar estad√≠sticas</p>
                    </div>
                    <div class="flex gap-2">
                        <div class="bg-white rounded-lg p-1 border flex">
                            <button onclick="switchCalendarView('list')" id="cal-view-list" class="px-3 py-1.5 text-sm rounded-md font-medium transition text-gray-600 hover:bg-gray-100">
                                üìÉ Lista
                            </button>
                            <button onclick="switchCalendarView('month')" id="cal-view-month" class="px-3 py-1.5 text-sm rounded-md font-medium transition bg-slate-800 text-white">
                                üóìÔ∏è Mes
                            </button>
                        </div>
                        <button onclick="loadCalendar()" class="bg-slate-800 hover:bg-slate-700 text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2">
                            üîÑ Actualizar
                        </button>
                    </div>
                </div>

                <!-- Calendar Select Hint -->
                <div class="calendar-select-hint rounded-xl p-4 mb-4 flex justify-between items-center">
                    <p class="text-sm">
                        <strong>üí° Consejo:</strong> Los partidos marcados en gris ya han sido registrados.
                    </p>
                    <label class="flex items-center gap-2 text-sm font-medium cursor-pointer">
                        <input type="checkbox" id="hide-registered-matches" onchange="renderCalendar()" class="w-4 h-4 text-slate-800">
                        Ocultar registrados
                    </label>
                </div>
                
                <!-- Competition Filters -->
                <div class="bg-white rounded-xl shadow-sm p-4 mb-4">
                    <div id="calendar-filters-container" class="flex flex-wrap gap-2">
                        <!-- Filters populated dynamically -->
                    </div>
                </div>

                <!-- Time Filter (Only for list view) -->
                <div id="cal-time-filters" class="hidden bg-white rounded-xl shadow-sm p-4 mb-4">
                    <div class="flex flex-wrap gap-2">
                        <button onclick="filterCalendarTime('all')" class="time-filter px-3 py-1 text-sm rounded-full bg-slate-800 text-white">Todos</button>
                        <button onclick="filterCalendarTime('past')" class="time-filter px-3 py-1 text-sm rounded-full bg-gray-200 text-gray-700">Pasados</button>
                        <button onclick="filterCalendarTime('future')" class="time-filter px-3 py-1 text-sm rounded-full bg-gray-200 text-gray-700">Pr√≥ximos</button>
                    </div>
                </div>
                
                <!-- Month Navigation (Only for month view) -->
                <div id="cal-month-nav" class="bg-white rounded-xl shadow-sm p-4 mb-4 flex justify-between items-center">
                    <button onclick="changeCalendarMonth(-1)" class="p-2 hover:bg-gray-100 rounded-full">‚¨ÖÔ∏è Anterior</button>
                    <h3 id="current-month-display" class="text-lg font-bold text-slate-800"></h3>
                    <button onclick="changeCalendarMonth(1)" class="p-2 hover:bg-gray-100 rounded-full">Siguiente ‚û°Ô∏è</button>
                </div>
                
                <div id="calendar-container" class="space-y-3">
                    <div class="calendar-loading text-center py-12">
                        <div class="text-4xl mb-4">‚è≥</div>
                        <p class="text-gray-600">Cargando calendario...</p>
                    </div>
                </div>
            </section>

            <!-- NUEVO PARTIDO SECTION -->
            <section id="section-nuevo" class="hidden fade-in">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Registrar Nuevo Partido</h2>
                    <p class="text-gray-500 text-sm">Registro en 2 pasos: Datos y Jugadores</p>
                </div>
                
                <!-- Prompt to select from Calendar -->
                <div id="select-match-prompt" class="text-center py-12 bg-white rounded-xl shadow-sm">
                    <div class="text-6xl mb-4">üìÖ</div>
                    <h3 class="text-xl font-medium text-gray-800 mb-2">Selecciona un partido del calendario</h3>
                    <p class="text-gray-500 mb-6 max-w-md mx-auto">Para garantizar la integridad de los datos, todos los partidos deben ser seleccionados primero desde la secci√≥n de Calendario.</p>
                    <button onclick="showTab('calendario')" class="bg-slate-800 hover:bg-slate-700 text-white px-6 py-3 rounded-lg font-medium transition">
                        Ir al Calendario
                    </button>
                </div>

                <div id="new-match-form-container" class="hidden">
                    <!-- Selected Fixture Info -->
                    <div id="selected-fixture-info" class="bg-amber-50 border-2 border-amber-400 rounded-xl p-4 mb-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-amber-800 font-medium">üìÖ Partido seleccionado del calendario:</p>
                                <p id="selected-fixture-details" class="text-amber-900 font-semibold"></p>
                            </div>
                            <button onclick="clearSelectedFixture()" class="text-amber-600 hover:text-amber-800 text-sm font-medium">
                                ‚úï Cancelar selecci√≥n
                            </button>
                        </div>
                    </div>

                    <!-- New Match Form -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <form id="new-match-form" class="space-y-6">
                            <input type="hidden" id="calendar-event-id" value="">
                            
                            <div id="wizard-step-1">
                                <h3 class="text-lg font-bold text-gray-800 mb-4 pb-2 border-b">Paso 1: Datos del Partido</h3>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Competici√≥n *</label>
                                        <select id="new-competition" required onchange="updateRoundOptions()" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500 bg-white">
                                            <option value="">Seleccionar competici√≥n...</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Jornada / Ronda *</label>
                                        <select id="new-round" required onchange="handleRoundChange()" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500 bg-white">
                                            <option value="">Primero selecciona competici√≥n...</option>
                                        </select>
                                        <p id="round-info" class="text-xs text-gray-500 mt-1"></p>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Rival *</label>
                                        <input type="text" id="new-opponent" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500 bg-gray-100" readonly>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Fecha *</label>
                                        <input type="date" id="new-date" required class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500">
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div id="stadium-container">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Estadio / Condici√≥n</label>
                                        <div class="flex gap-2">
                                            <select id="new-venue" class="w-1/3 px-2 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500 bg-white" onchange="updateStadiumField()">
                                                <option value="local">üè† Local</option>
                                                <option value="visitante">‚úàÔ∏è Visitante</option>
                                                <option value="neutral">‚öñÔ∏è Neutral</option>
                                            </select>
                                            <input type="text" id="new-stadium" class="w-2/3 px-3 py-2 border rounded-lg bg-gray-100" value="Santiago Bernab√©u" readonly>
                                        </div>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Resultado (Goles) *</label>
                                        <input type="text" id="new-result" required oninput="updateOvertimeOptions()" placeholder="Ej: 2-1" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500 font-bold text-lg text-center tracking-widest" pattern="^\d+-\d+$">
                                        <p class="text-xs text-gray-500 mt-1 text-center">Formato: local-visitante (ej: 3-1)</p>
                                    </div>
                                </div>
                                
                                <div id="overtime-controls" class="hidden mt-4 p-4 bg-orange-50 border border-orange-200 rounded-lg">
                                    <h4 class="font-bold text-orange-800 mb-2 text-sm">Desenlace Eliminatoria</h4>
                                    
                                    <div id="extra-time-option" class="mb-2 hidden">
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" id="chk-extra-time" class="w-4 h-4 text-orange-600">
                                            <span class="text-sm font-medium text-gray-700">Pr√≥rroga jugada</span>
                                        </label>
                                    </div>
                                    
                                    <div id="penalties-option" class="hidden">
                                        <label class="flex items-center gap-2 cursor-pointer mb-2">
                                            <input type="checkbox" id="chk-penalties" class="w-4 h-4 text-orange-600" onchange="togglePenaltyWinner()">
                                            <span class="text-sm font-medium text-gray-700">Tanda de Penaltis</span>
                                        </label>
                                        <div id="penalty-winner-select" class="hidden ml-6">
                                            <p class="text-xs text-gray-500 mb-1">Resultado de la tanda:</p>
                                            <div class="flex gap-4">
                                                <label class="flex items-center gap-1 cursor-pointer">
                                                    <input type="radio" name="penalties-outcome" value="win" class="text-green-600">
                                                    <span class="text-sm text-green-700 font-bold">Victoria</span>
                                                </label>
                                                <label class="flex items-center gap-1 cursor-pointer">
                                                    <input type="radio" name="penalties-outcome" value="loss" class="text-red-600">
                                                    <span class="text-sm text-red-700 font-bold">Derrota</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <div id="leg-indicator" class="hidden p-4 global-result rounded-lg mb-4 mt-4">
                                    <p id="leg-info" class="text-sm text-blue-800"></p>
                                </div>

                                <div id="venue-alternation-warning" class="hidden p-4 bg-amber-50 border border-amber-200 rounded-lg mb-4">
                                    <p id="venue-alternation-info" class="text-sm text-amber-800"></p>
                                </div>
                                
                                <div class="flex justify-end pt-4 border-t">
                                    <button type="button" onclick="goToStep2()" class="px-6 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-700 font-medium shadow-lg transform active:scale-95 transition-all">
                                        Siguiente: Jugadores ‚û°Ô∏è
                                    </button>
                                </div>
                            </div>

                            <!-- STEP 2: JUGADORES -->
                            <div id="wizard-step-2" class="hidden h-full">
                                <div class="flex flex-col sm:flex-row justify-between items-center mb-2 pb-2 border-b gap-3">
                                    <h3 class="text-lg font-bold text-gray-800">Paso 2: Alineaci√≥n</h3>
                                    
                                    <div class="flex items-center gap-3">
                                        <div class="bg-gray-100 p-1 rounded-lg flex text-sm">
                                            <button type="button" id="btn-mode-list" class="px-3 py-1 text-gray-500 hover:text-gray-700 transition-all" onclick="switchLineupMode('list')">Lista</button>
                                            <button type="button" id="btn-mode-pitch" class="px-3 py-1 bg-white shadow rounded text-gray-800 font-medium transition-all" onclick="switchLineupMode('pitch')">Pizarra</button>
                                        </div>
                                        <button type="button" onclick="goToStep1()" class="text-sm text-blue-600 hover:underline">‚¨ÖÔ∏è Volver</button>
                                    </div>
                                </div>
                                <div class="flex justify-center gap-3 mb-3 mt-1 animate-in fade-in slide-in-from-top-2 no-capture">
    
                                <button type="button" onclick="loadLastLineup()" class="flex items-center gap-1 text-xs font-bold bg-white text-slate-700 px-3 py-1.5 rounded-full border border-slate-200 hover:bg-slate-50 hover:border-slate-300 transition shadow-sm">
                                ‚Ü∫ Repetir √öltimo Once
                                </button>

                                <button type="button" onclick="loadBestXILineup()" class="flex items-center gap-1 text-xs font-bold bg-amber-50 text-amber-700 px-3 py-1.5 rounded-full border border-amber-200 hover:bg-amber-100 hover:border-amber-300 transition shadow-sm">
                                ‚≠ê Cargar Once de Gala
                                </button>

                                <button type="button" onclick="exportLineupToImage()" class="flex items-center gap-1 text-xs font-bold bg-blue-50 text-blue-700 px-3 py-1.5 rounded-full border border-blue-200 hover:bg-blue-100 hover:border-blue-300 transition shadow-sm">
                                üì∏ Foto
                                </button>

                                </div>

                                <div id="mode-list-container" class="hidden">
                                    <div class="mb-2 text-sm text-amber-700 bg-amber-50 p-2 rounded">‚ö†Ô∏è Selecciona "Titular" o "Suplente".</div>
                                    <div id="new-match-players-stats" class="space-y-3 h-[60vh] overflow-y-auto border border-gray-200 rounded-xl p-4 bg-gray-50"></div>
                                </div>

                                <div id="mode-pitch-container" class="flex flex-col h-full">

    <div class="mb-3 flex flex-col md:flex-row items-center justify-between gap-3 bg-white p-2 rounded-xl border border-gray-200 shadow-sm mx-1">
        
        <div class="flex items-center gap-2">
            <label class="text-xs font-bold text-gray-500 uppercase tracking-wider">Esquema</label>
            <select id="formation-select" class="border-gray-300 rounded text-sm font-bold text-slate-700 focus:ring-indigo-500 focus:border-indigo-500 py-1 cursor-pointer bg-gray-50" onchange="updatePitchFormation()">
                 <option value="4-3-3">4-3-3</option>
                 <option value="4-4-2">4-4-2</option>
                 <option value="4-2-3-1" selected>4-2-3-1</option> 
                 <option value="3-5-2">3-5-2</option>
            </select>
        </div>
    
<div class="flex items-center gap-3 text-sm">
    
    <div class="flex flex-col items-end leading-tight">
        <span class="text-[10px] text-gray-400 font-bold uppercase">Once Inicial</span>
        <span id="value-starters" class="font-black text-emerald-600">0 M‚Ç¨</span>
    </div>

    <div class="w-px h-6 bg-gray-200"></div> <div class="flex flex-col items-end leading-tight">
        <span class="text-[10px] text-gray-400 font-bold uppercase">Convocatoria</span>
        <span id="value-total" class="font-black text-slate-700">0 M‚Ç¨</span>
    </div>

    <div class="w-px h-6 bg-gray-200"></div> <div class="flex flex-col items-end leading-tight">
        <span class="text-[10px] text-gray-400 font-bold uppercase">Edad Media (XI)</span>
        <span id="value-age" class="font-black text-blue-600">0.0 a√±os</span>
    </div>

</div>
    
    </div>

    <div id="tactical-board-container" class="flex flex-col md:flex-row gap-4 h-[550px]">

        <div class="flex-1 relative bg-gray-800 rounded-xl border-4 border-gray-800 overflow-hidden shadow-xl">
            <div class="pitch-container w-full h-full" id="tactical-pitch" style="margin: 0; border: none; border-radius: 0;">
                <div class="pitch-line-mid"></div>
                <div class="pitch-circle"></div>
                <div class="pitch-box-left" style="left:0; border-left:none;"></div>
                <div class="pitch-box-right" style="right:0; border-right:none;"></div>
                
                <div id="pitch-slots-layer"></div>
                <div id="pitch-players-layer"></div>
            </div>
        </div>

        <div class="w-full md:w-72 flex flex-col gap-2 h-full">
            
            <div class="flex-1 bg-white rounded-xl border border-gray-300 flex flex-col shadow-sm overflow-hidden">
                <div class="bg-gray-100 p-2 border-b border-gray-200">
                    <h5 class="text-xs font-bold text-gray-600 uppercase text-center">Plantilla Disponible</h5>
                </div>
                <div id="bench-zone" class="bench-container flex-1 overflow-y-auto p-2 bg-gray-50 content-start">
                    </div>
            </div>
            
            <div class="h-32 bg-blue-50 rounded-xl border-2 border-dashed border-blue-300 flex flex-col overflow-hidden">
                <div class="bg-blue-100 p-1 border-b border-blue-200">
                    <h5 class="text-[10px] font-bold text-blue-600 uppercase text-center">Suplentes Convocados</h5>
                </div>
                <div id="subs-zone" class="flex-1 p-2 overflow-y-auto flex flex-wrap gap-2 content-start">
                    </div>
            </div>

        </div>
    </div>
</div>

                                <div class="flex gap-3 pt-4 border-t mt-4">
                                    <button type="button" onclick="goToStep1()" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 font-medium">Atr√°s</button>
                                    <button type="button" onclick="goToStep3()" class="flex-1 px-4 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-700 font-bold text-lg shadow-lg flex items-center justify-center gap-2 transform hover:scale-[1.01] transition-all">
                                        CONFIRMAR ALINEACI√ìN ‚û°Ô∏è
                                    </button>
                                </div>
                            </div>
                            <div id="wizard-step-3" class="hidden">
                                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 pb-2 border-b gap-3">
                                    <h3 class="text-lg font-bold text-gray-800">Paso 3: Rendimiento</h3>
                                    <button type="button" onclick="goToStep2()" class="text-sm text-blue-600 hover:underline">‚¨ÖÔ∏è Volver a Pizarra</button>
                                </div>

                                <div class="mb-2 text-sm text-green-700 bg-green-50 p-2 rounded">‚úÖ Alineaci√≥n confirmada. Introduce las estad√≠sticas del partido.</div>
                                
                                <div id="final-stats-container" class="space-y-3 h-[60vh] overflow-y-auto border border-gray-200 rounded-xl p-4 bg-gray-50"></div>

                                <div class="flex gap-3 pt-4 border-t mt-4">
                                    <button type="button" onclick="resetNewMatchForm()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Cancelar</button>
                                    <button type="submit" class="flex-1 px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 font-medium font-bold text-lg shadow-md hover:shadow-lg transition-all transform hover:-translate-y-0.5">üíæ GUARDAR PARTIDO</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </section>

            <!-- PARTIDOS REGISTRADOS SECTION -->
            <section id="section-partidos" class="hidden fade-in">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Partidos Registrados</h2>
                        <p class="text-gray-500 text-sm">Historial de partidos con estad√≠sticas</p>
                    </div>
                </div>

                <!-- Match Filters -->
                <div class="bg-white rounded-xl shadow-sm p-4 mb-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Competici√≥n</label>
                            <select id="filter-competition" onchange="renderMatches()" class="w-full px-3 py-2 border rounded-lg">
                                <option value="">Todas las competiciones</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Condici√≥n</label>
                            <select id="filter-venue" onchange="renderMatches()" class="w-full px-3 py-2 border rounded-lg">
                                <option value="">Todos</option>
                                <option value="local">Local</option>
                                <option value="visitante">Visitante</option>
                                <option value="neutral">Campo Neutral</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Resultado</label>
                            <select id="filter-result" onchange="renderMatches()" class="w-full px-3 py-2 border rounded-lg">
                                <option value="">Todos</option>
                                <option value="victoria">Victorias</option>
                                <option value="empate">Empates</option>
                                <option value="derrota">Derrotas</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-100 p-3 rounded-lg mb-4 flex flex-col md:flex-row gap-3 items-center border border-gray-200">
                                    <div class="flex-1 w-full">
                                        <input type="text" id="filter-rival" placeholder="üîç Buscar rival (ej: Bar√ßa)" 
                                               class="w-full px-3 py-2 rounded border border-gray-300 text-sm focus:ring-2 focus:ring-blue-500"
                                               onkeyup="applyMatchFilters()">
                                    </div>
                                    <div class="w-full md:w-auto">
                                        <select id="filter-competition" class="w-full px-3 py-2 rounded border border-gray-300 text-sm" onchange="applyMatchFilters()">
                                            <option value="all">Todas las Competiciones</option>
                                            <option value="Liga">Liga</option>
                                            <option value="Champions">Champions League</option>
                                            <option value="Copa">Copa del Rey</option>
                                            <option value="Supercopa">Supercopa</option>
                                        </select>
                                    </div>
                                    <div class="w-full md:w-auto">
                                        <select id="filter-result" class="w-full px-3 py-2 rounded border border-gray-300 text-sm" onchange="applyMatchFilters()">
                                            <option value="all">Todos los resultados</option>
                                            <option value="victoria">‚úÖ Victorias</option>
                                            <option value="empate">‚ûñ Empates</option>
                                            <option value="derrota">‚ùå Derrotas</option>
                                        </select>
                                    </div>
                                </div>
                <div id="matches-list" class="space-y-4"></div>
                <div id="no-matches" class="hidden text-center py-12">
                    <div class="text-6xl mb-4">üìÖ</div>
                    <h3 class="text-xl font-medium text-gray-600">No hay partidos registrados</h3>
                    <p class="text-gray-500">Ve a "üìÖ Calendario" y haz clic en un partido pasado para registrarlo</p>
                </div>
            </section>

            <!-- COMPARATOR SECTION -->
            <section id="section-comparador" class="hidden fade-in">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">‚öîÔ∏è Duelo de Estad√≠sticas</h2>
                    <p class="text-gray-500 text-sm">Compara el rendimiento detallado de dos jugadores</p>
                </div>

                <div class="bg-white rounded-xl shadow-lg p-6 border border-gray-200">
                    
                    <div class="flex flex-col md:flex-row justify-between items-center gap-6 mb-8 bg-gray-50 p-4 rounded-xl border border-gray-100">
                        <div class="w-full md:w-1/3">
                            <label class="block text-xs font-bold text-blue-800 uppercase mb-2 tracking-wider">Jugador 1</label>
                            <select id="radar-p1" onchange="updateComparatorChart()" class="w-full p-3 border-2 border-blue-200 rounded-xl font-bold text-gray-700 focus:border-blue-500 focus:ring-4 focus:ring-blue-100 bg-white transition-all"></select>
                        </div>
                        
                        <div class="flex flex-col items-center justify-center">
                            <span class="text-3xl font-black text-slate-200">VS</span>
                        </div>

                        <div class="w-full md:w-1/3">
                            <label class="block text-xs font-bold text-red-800 uppercase mb-2 tracking-wider">Jugador 2</label>
                            <select id="radar-p2" onchange="updateComparatorChart()" class="w-full p-3 border-2 border-red-200 rounded-xl font-bold text-gray-700 focus:border-red-500 focus:ring-4 focus:ring-red-100 bg-white transition-all"></select>
                        </div>
                    </div>

                    <div class="flex flex-col lg:flex-row gap-8 items-center">
                        
                        <div class="flex-1 w-full relative h-[400px] flex items-center justify-center p-4">
                            <canvas id="chart-radar-vs"></canvas>
                        </div>

                        <div class="w-full lg:w-1/3 bg-slate-50 p-6 rounded-2xl border border-slate-200 shadow-inner">
                            <h4 class="text-xs font-bold text-slate-500 uppercase mb-6 text-center tracking-widest border-b border-slate-200 pb-2">Comparativa Directa</h4>
                            <div id="radar-stats-table" class="space-y-4 text-sm">
                                <p class="text-center text-gray-400 italic">Selecciona dos jugadores para comparar</p>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- STATS SECTION -->
            <section id="section-stats" class="hidden fade-in">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">Estad√≠sticas</h2>
                    
                    <div class="flex p-1.5 bg-white border border-gray-200 rounded-xl shadow-sm">
                         <button onclick="switchStatsTab('general')" id="btn-stats-general" class="stats-subtab active">
                            üìä General
                         </button>
                         <button onclick="switchStatsTab('advanced')" id="btn-stats-advanced" class="stats-subtab inactive">
                              üìà Avanzado
                         </button>
                         <button onclick="switchStatsTab('h2h')" id="btn-stats-h2h" class="stats-subtab inactive">
                             ‚öîÔ∏è H2H (Rival)
                         </button>
                         <button onclick="switchStatsTab('mvp')" id="btn-stats-mvp" class="stats-subtab inactive">
                             üèÜ Muro de la Fama
                         </button>
                        <button onclick="openTrophyRoom()" class="bg-gradient-to-r from-amber-400 to-amber-500 hover:from-amber-500 hover:to-amber-600 text-white font-bold py-2 px-4 rounded-lg shadow-md flex items-center gap-2 transition-all transform hover:scale-105">
                        <span>üèÜ</span> Trofeos
                    </button>
                    </div>
                </div>
                
                
                
                <!-- SUB-SECTION: GENERAL -->
                     <div id="stats-general" class="fade-in bg-white rounded-xl shadow-lg border-t-4 border-indigo-500 p-6">
                        <div class="flex justify-between items-center mb-6 pb-4 border-b">
                         <h3 class="text-lg font-bold text-gray-800">Estad√≠sticas Generales</h3>

                    <div class="flex gap-2">
                  <button onclick="exportStats()" ...>
                            üì• Exportar CSV
                         </button>

                        <button onclick="showTab('comparador')" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 shadow transition transform hover:scale-105">
                              üÜö Comparador VS
                        </button>
                         </div> </div>

                    <!-- Summary Cards -->
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-4 xl:grid-cols-8 gap-4 mb-8">
                        <div class="bg-gradient-to-br from-slate-700 to-slate-800 rounded-xl p-4 text-white">
                            <p class="text-slate-300 text-sm">Partidos</p>
                            <p id="stat-total-matches" class="text-3xl font-bold">0</p>
                        </div>
                        <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl p-4 text-white">
                            <p class="text-green-100 text-sm">Victorias</p>
                            <p id="stat-wins" class="text-3xl font-bold">0</p>
                        </div>
                        <div class="bg-gradient-to-br from-amber-500 to-amber-600 rounded-xl p-4 text-white">
                            <p class="text-amber-100 text-sm">Empates</p>
                            <p id="stat-draws" class="text-3xl font-bold">0</p>
                        </div>
                        <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-xl p-4 text-white">
                            <p class="text-red-100 text-sm">Derrotas</p>
                            <p id="stat-losses" class="text-3xl font-bold">0</p>
                        </div>
                        <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-xl p-4 text-white">
                            <p class="text-emerald-100 text-sm">Goles Favor</p>
                            <p id="stat-total-goals" class="text-3xl font-bold">0</p>
                        </div>
                        <div class="bg-gradient-to-br from-rose-500 to-rose-600 rounded-xl p-4 text-white">
                            <p class="text-rose-100 text-sm">Goles Contra</p>
                            <p id="stat-total-goals-against" class="text-3xl font-bold">0</p>
                        </div>
                        <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl p-4 text-white">
                            <p class="text-purple-100 text-sm">Asistencias</p>
                            <p id="stat-total-assists" class="text-3xl font-bold">0</p>
                        </div>
                        <div class="bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-xl p-4 text-white">
                            <p class="text-indigo-100 text-sm">Jugadores</p>
                            <p id="stat-total-players" class="text-3xl font-bold">0</p>
                        </div>
                    </div>
                    <div class="mb-8">
                        <h4 class="font-bold text-gray-700 text-xl mb-4 flex items-center gap-2">
                            üåü El Once de Gala <span class="text-xs font-normal text-gray-500 bg-gray-100 px-2 py-1 rounded">Basado en Nota Media</span>
                        </h4>
                        
                        <div class="bg-emerald-600 rounded-xl shadow-lg border-4 border-emerald-700 p-4 relative h-[600px] w-full max-w-3xl mx-auto overflow-hidden">
                            
                            <div class="absolute inset-0 opacity-20 pointer-events-none">
                                <div class="w-full h-full bg-[linear-gradient(to_bottom,transparent_50%,rgba(0,0,0,0.1)_50%),linear-gradient(to_right,rgba(0,0,0,0.05)_50%,transparent_50%)] bg-[length:100%_100px,100px_100%]"></div>
                                <div class="absolute top-0 left-1/2 -translate-x-1/2 w-3/5 h-1/6 border-2 border-white bg-transparent"></div>
                                <div class="absolute top-0 left-1/2 -translate-x-1/2 w-2/5 h-[6%] border-2 border-white bg-transparent"></div>
                                <div class="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-32 h-32 border-2 border-white rounded-full"></div>
                                <div class="absolute top-1/2 left-0 w-full h-0.5 bg-white/50"></div>
                                <div class="absolute bottom-0 left-1/2 -translate-x-1/2 w-3/5 h-1/6 border-2 border-white bg-transparent"></div>
                                <div class="absolute bottom-0 left-1/2 -translate-x-1/2 w-2/5 h-[6%] border-2 border-white bg-transparent"></div>
                            </div>

                            <div id="best-xi-container" class="relative w-full h-full z-10">
                                </div>

                        </div>
                    </div>
                   
                    <div class="mb-8 bg-white rounded-xl shadow-sm border border-gray-200 p-6">
                        <h4 class="font-bold text-gray-700 text-xl mb-2">üìä Cuadrante de Rendimiento</h4>
                        <p class="text-xs text-gray-500 mb-6">Relaci√≥n entre Cantidad de Minutos y Calidad de Juego</p>
                        
                        <div class="w-full h-[400px]">
                            <canvas id="chart-scatter-performance"></canvas>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-2 mt-4 text-xs text-center opacity-70">
                            <div class="p-2 bg-yellow-50 text-yellow-700 rounded border border-yellow-100">üíé Juegan poco / Rinden mucho</div>
                            <div class="p-2 bg-green-50 text-green-700 rounded border border-green-100">üåü Estrellas (Juegan mucho / Rinden bien)</div>
                            <div class="p-2 bg-gray-50 text-gray-600 rounded border border-gray-100">üìâ Necesitan mejorar</div>
                            <div class="p-2 bg-red-50 text-red-600 rounded border border-red-100">‚ö†Ô∏è Fatiga (Juegan mucho / Rinden bajo)</div>
                        </div>
                    </div>
                    <div class="flex gap-4 text-xs font-medium text-gray-500">
    <div class="flex items-center gap-1">
        <span class="w-2 h-2 rounded-full bg-blue-500"></span>
        <span id="legend-def-val">Defensa</span> </div>
    <div class="flex items-center gap-1">
        <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
        <span id="legend-mid-val">Medio</span> </div>
    <div class="flex items-center gap-1">
        <span class="w-2 h-2 rounded-full bg-rose-500"></span>
        <span id="legend-fwd-val">Delantera</span> </div>
</div>

                    <!-- Stats Filters -->
                    <div class="bg-gray-50 rounded-xl p-4 mb-6 border border-gray-100">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Competici√≥n</label>
                                <select id="stats-filter-competition" onchange="renderStats()" class="w-full px-3 py-2 border rounded-lg bg-white">
                                    <option value="">Todas las competiciones</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Estado del Jugador</label>
                                <select id="stats-filter-status" onchange="renderStats()" class="w-full px-3 py-2 border rounded-lg bg-white">
                                    <option value="">Todos</option>
                                    <option value="Activo">Solo Activos</option>
                                    <option value="Inactivo">Solo Inactivos</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Stats Table -->
                    <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                        <div class="p-4 border-b bg-gray-50">
                            <h3 class="font-semibold text-gray-800">Rendimiento Individual</h3>
                            <p class="text-xs text-gray-500 mt-1">Haz clic en los encabezados para ordenar.</p>
                        </div>
                        <div class="table-container">
                            <table class="w-full">
                            <thead class="text-xs text-gray-700 uppercase bg-gray-50 border-b select-none sticky top-0 z-10">
    <tr>
        <th class="px-4 py-3 text-left text-xs font-semibold uppercase sortable" onclick="handleSort('name')" id="th-name">Jugador</th>
        
        <th id="th-matchesPlayed" class="px-4 py-3 text-center text-xs font-semibold uppercase sortable" onclick="handleSort('matchesPlayed')" title="Partidos Jugados">PJ</th>
        
        <th id="th-starts" class="px-4 py-3 text-center text-xs font-semibold uppercase sortable text-indigo-600" onclick="handleSort('starts')" title="Partidos como Titular">TIT</th>

        <th id="th-avgRating" class="px-4 py-3 text-center text-xs font-semibold uppercase sortable" onclick="handleSort('avgRating')" title="Nota Media">Nota</th>
        <th id="th-goals" class="px-4 py-3 text-center text-xs font-semibold uppercase sortable text-emerald-600" onclick="handleSort('goals')" title="Goles Totales">Gol</th>
        <th id="th-gPer90" class="px-2 py-3 text-center text-xs font-semibold uppercase sortable text-blue-500" onclick="handleSort('gPer90')" title="Goles cada 90 min">G/90'</th>
        <th id="th-assists" class="px-4 py-3 text-center text-xs font-semibold uppercase sortable" onclick="handleSort('assists')" title="Asistencias Totales">Asis</th>
        <th id="th-aPer90" class="px-2 py-3 text-center text-xs font-semibold uppercase sortable text-blue-500" onclick="handleSort('aPer90')" title="Asistencias cada 90 min">A/90'</th>
        <th id="th-ga" class="px-4 py-3 text-center text-xs font-semibold uppercase sortable" onclick="handleSort('ga')" title="Goles + Asistencias">G+A</th>
        <th id="th-gaPer90" class="px-2 py-3 text-center text-xs font-semibold uppercase sortable text-purple-600" onclick="handleSort('gaPer90')" title="Producci√≥n (G+A) cada 90 min">P/90'</th>
        <th id="th-minutes" class="px-4 py-3 text-center text-xs font-semibold uppercase sortable text-gray-600" onclick="handleSort('minutes')" title="Minutos Totales">Min</th>
        <th id="th-minPerMatch" class="px-2 py-3 text-center text-xs font-semibold uppercase sortable text-gray-500" onclick="handleSort('minPerMatch')" title="Promedio Minutos por Partido">Min/P</th>
        <th id="th-mvpCount" class="px-4 py-3 text-center text-xs font-semibold uppercase sortable" onclick="handleSort('mvpCount')" title="MVPs Ganados">MVP</th>
        <th id="th-wins" class="px-4 py-3 text-center text-xs font-semibold uppercase sortable text-green-600" onclick="handleSort('wins')" title="Victorias">V</th>
        <th id="th-draws" class="px-4 py-3 text-center text-xs font-semibold uppercase sortable text-amber-600" onclick="handleSort('draws')" title="Empates">E</th>
        <th id="th-losses" class="px-4 py-3 text-center text-xs font-semibold uppercase sortable text-red-600" onclick="handleSort('losses')" title="Derrotas">D</th>
        <th id="th-yellowCards" class="px-4 py-3 text-center text-xs font-semibold uppercase sortable" onclick="handleSort('yellowCards')" title="Amarillas">üü®</th>
        <th id="th-redCards" class="px-4 py-3 text-center text-xs font-semibold uppercase sortable" onclick="handleSort('redCards')" title="Rojas">üü•</th>
    </tr>
</thead>
                                <tbody id="stats-table-body"></tbody>
                            </table>
                        </div>
                        <div id="no-stats" class="hidden text-center py-8 text-gray-500">
                            No hay estad√≠sticas disponibles.
                        </div>
                    </div>
                </div>

                <!-- SUB-SECTION: ADVANCED -->
                <div id="stats-advanced" class="hidden fade-in space-y-6 bg-white rounded-xl shadow-lg border-t-4 border-emerald-500 p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-6 pb-2 border-b">Estad√≠sticas Avanzadas</h3>
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-8">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                            <div>
                                <h4 class="font-bold text-gray-800 text-lg">‚öîÔ∏è Guerra de L√≠neas</h4>
                                <p class="text-xs text-gray-500">Evoluci√≥n del rendimiento: Defensa vs Medio vs Delantera</p>
                            </div>
                           <div class="flex gap-4 text-xs font-medium text-gray-500">
    <div class="flex items-center gap-1">
        <span class="w-2 h-2 rounded-full bg-blue-500"></span>
        <span id="legend-def-val">Defensa</span> </div>
    <div class="flex items-center gap-1">
        <span class="w-2 h-2 rounded-full bg-emerald-500"></span>
        <span id="legend-mid-val">Medio</span> </div>
    <div class="flex items-center gap-1">
        <span class="w-2 h-2 rounded-full bg-rose-500"></span>
        <span id="legend-fwd-val">Delantera</span> </div>
</div>
                        </div>
                        <div class="w-full h-[350px] relative">
                            <canvas id="chart-line-wars"></canvas>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-8">
    <h4 class="font-bold text-gray-800 text-lg mb-4 flex items-center gap-2">
        üìä Histograma de Rigurosidad 
        <span class="text-xs font-normal text-gray-500 bg-gray-100 px-2 py-1 rounded">Distribuci√≥n de tus notas</span>
    </h4>
    <div class="h-[250px] w-full relative">
        <canvas id="chart-rating-histogram"></canvas>
    </div>
    <p class="text-xs text-center text-gray-400 mt-2">Muestra cu√°ntas veces has puesto cada rango de nota.</p>
</div>
 <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-8">
    <h4 class="font-bold text-gray-800 text-lg mb-4">üèÜ Tier List de la Temporada</h4>
    <div id="tier-list-container" class="space-y-2"></div>
</div>
                    <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 mb-8">
                        <div class="flex flex-col md:flex-row justify-between items-center mb-4">
                            <div>
                                <h4 class="font-bold text-gray-800 text-lg">üç© El Rosco de la Carga</h4>
                                <p class="text-xs text-gray-500">Distribuci√≥n de minutos jugados (¬øQui√©n est√° "quemado"?)</p>
                            </div>
                        </div>
                        <div class="flex flex-col md:flex-row items-center gap-8">
                            <div class="w-full md:w-1/2 h-[300px] relative">
                                <canvas id="chart-minutes-doughnut"></canvas>
                                <div class="absolute inset-0 flex flex-col items-center justify-center pointer-events-none">
                                    <span class="text-xs text-gray-400 uppercase font-bold">Total Equipo</span>
                                    <span id="total-season-minutes" class="text-2xl font-black text-slate-700">0'</span>
                                </div>
                            </div>
                            
                            <div class="w-full md:w-1/2 grid grid-cols-2 gap-4">
                                <div class="bg-red-50 p-3 rounded-lg border border-red-100">
                                    <p class="text-xs text-red-500 uppercase font-bold mb-1">üî• El "Quemado"</p>
                                    <p id="min-max-player" class="font-bold text-gray-800 text-sm">-</p>
                                    <p id="min-max-value" class="text-xs text-gray-500">- min</p>
                                </div>
                                <div class="bg-blue-50 p-3 rounded-lg border border-blue-100">
                                    <p class="text-xs text-blue-500 uppercase font-bold mb-1">‚ùÑÔ∏è El "Olvidado"</p>
                                    <p id="min-min-player" class="font-bold text-gray-800 text-sm">-</p>
                                    <p id="min-min-value" class="text-xs text-gray-500">- min</p>
                                </div>
                                <div class="col-span-2 bg-gray-50 p-3 rounded-lg text-xs text-gray-500 border border-gray-100">
                                    <p><strong>üí° An√°lisis:</strong> Si un trozo ocupa m√°s del 10% del gr√°fico, ese jugador es indispensable. Si no aparece o es una l√≠nea fina, necesita m√°s oportunidades.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- Home vs Away Comparison -->
                    <div class="mb-8">
                        <h4 class="font-bold text-gray-700 mb-4">Rendimiento: Casa vs Fuera</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="home-away-stats-container">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <!-- Heatmap by Position -->
                    <div class="mb-8">
                        <h4 class="font-bold text-gray-700 mb-4">Mapa de Rendimiento (Nota Media por Posici√≥n)</h4>
                        <div class="heatmap-pitch" id="heatmap-container">
                             <!-- Populated by JS -->
                        </div>
                    </div>

                    <!-- Monthly Report -->
                    <div class="mb-8">
                        <h4 class="font-bold text-gray-700 mb-4">Reporte Mensual</h4>
                        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                             <table class="w-full text-sm">
                                <thead class="bg-slate-800 text-white">
                                    <tr>
                                        <th class="px-4 py-2 text-left">Mes</th>
                                        <th class="px-4 py-2 text-center">Partidos</th>
                                        <th class="px-4 py-2 text-center">V-E-D</th>
                                        <th class="px-4 py-2 text-center">GF / GC</th>
                                        <th class="px-4 py-2 text-center">Nota Media Equipo</th>
                                    </tr>
                                </thead>
                                <tbody id="monthly-report-body">
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div id="stats-visual-section" class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-8 mb-12 hidden">
    
    <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-gray-200 p-4 min-h-[300px]">
        <h3 class="font-bold text-gray-700 mb-4 px-2 border-l-4 border-indigo-500">üìà An√°lisis de Temporada</h3>
        <div id="stats-charts-wrapper"></div> 
    </div>

    <div class="lg:col-span-1" id="stats-goal-analysis-container">
        </div>

</div>
                    <div class="mt-6 mb-8">
    <h3 class="text-lg font-bold text-gray-700 mb-3 border-l-4 border-indigo-500 pl-3">
        üß© Rendimiento por Esquema
    </h3>
    <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="w-full text-sm text-left">
                <thead class="bg-gray-50 text-gray-500 font-bold uppercase text-xs">
                    <tr>
                        <th class="px-4 py-3">Esquema</th>
                        <th class="px-4 py-3 text-center">PJ</th>
                        <th class="px-4 py-3 text-center text-emerald-600">V</th>
                        <th class="px-4 py-3 text-center text-amber-600">E</th>
                        <th class="px-4 py-3 text-center text-red-600">D</th>
                        <th class="px-4 py-3 text-center">Efectividad</th>
                    </tr>
                </thead>
                <tbody id="formation-stats-body" class="divide-y divide-gray-100">
                    </tbody>
            </table>
        </div>
        <div id="formation-no-data" class="hidden p-8 text-center text-gray-400 text-sm">
            No hay datos suficientes para generar estad√≠sticas t√°cticas.
        </div>
    </div>
</div>
                </div>

                <!-- SUB-SECTION: H2H -->
                <div id="stats-h2h" class="hidden fade-in bg-white rounded-xl shadow-lg border-t-4 border-pink-500 p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-6 pb-2 border-b">Historial contra Rival (Head to Head)</h3>
                    <div class="bg-gray-50 rounded-xl p-4 mb-6 border border-gray-100">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Selecciona un rival hist√≥rico</label>
                        <select id="h2h-opponent-select" onchange="renderH2H()" class="w-full px-3 py-2 border rounded-lg bg-white">
                            <option value="">Selecciona rival...</option>
                        </select>
                    </div>
                    <div id="h2h-content" class="hidden space-y-6">
                        <!-- Populated by JS -->
                    </div>
                </div>
                <div id="stats-mvp" class="hidden fade-in space-y-6">
                    <div class="bg-gradient-to-r from-amber-500 to-orange-600 rounded-xl shadow-lg p-8 text-white text-center mb-8 relative overflow-hidden">
                        <div class="absolute inset-0 opacity-10 bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]"></div>
                        <h3 class="text-3xl font-black mb-2 relative z-10">üèÜ EL MURO DE LA FAMA</h3>
                        <p class="text-amber-100 text-lg relative z-10">Los h√©roes de cada jornada</p>
                    </div>

                    <div class="flex justify-end mb-4">
                        <select id="mvp-filter-comp" onchange="renderMVPGallery()" class="px-4 py-2 border border-gray-200 rounded-lg bg-white text-sm shadow-sm focus:ring-2 focus:ring-amber-500 outline-none">
                            <option value="">Todas las competiciones</option>
                            </select>
                    </div>

                    <div id="mvp-gallery-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        </div>
                    
                    <div id="no-mvps-msg" class="hidden text-center py-12 text-gray-500">
                        <div class="text-6xl mb-4">üï∏Ô∏è</div>
                        <p>A√∫n no hay MVPs registrados. Juega partidos y elige al mejor jugador.</p>
                    </div>
                </div>

            </section>
        </main>
    </div>

    <!-- PLAYER DETAILS & STATS MODAL -->

<div id="player-details-modal" class="modal fixed inset-0 bg-black/80 backdrop-blur-sm flex items-center justify-center z-[100] hidden opacity-0 transition-opacity duration-300">
    <div class="bg-white rounded-2xl w-full max-w-5xl max-h-[90vh] overflow-hidden flex flex-col shadow-2xl m-4">
        
        <div id="player-modal-header-container" class="bg-white border-b border-gray-100 z-10 flex-none"></div>

        <div id="player-details-content" class="flex-1 overflow-y-auto bg-slate-50 p-4 md:p-6 relative"></div>
    </div>
</div>

    <!-- MATCH DETAIL MODAL -->
    <div id="match-detail-modal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b sticky top-0 bg-slate-800 text-white rounded-t-2xl">
                <div class="flex justify-between items-center">
                    <h3 id="match-detail-title" class="text-xl font-bold">Detalles del Partido</h3>
                    <button onclick="closeMatchDetailModal()" class="text-slate-300 hover:text-white cursor-pointer z-50 p-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div id="match-detail-content" class="p-6"></div>
        </div>
    </div>
    <div id="edit-match-modal" class="fixed inset-0 bg-black/80 hidden z-[9999] items-center justify-center backdrop-blur-sm">
    <div id="edit-match-content" class="bg-white rounded-xl w-full max-w-6xl h-[95vh] shadow-2xl overflow-hidden relative flex flex-col">
        </div>
</div>

    <!-- PLAYER STATUS MODAL -->
   <div id="player-status-modal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-md">
            <div class="p-6 border-b bg-slate-800 text-white rounded-t-2xl">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold">Cambiar Estado</h3>
                    <button onclick="closePlayerStatusModal()" class="text-slate-300 hover:text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div id="player-status-content" class="p-6"></div>
        </div>
    </div>

    <div id="extra-round-modal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-md">
            <div class="p-6 border-b bg-slate-800 text-white rounded-t-2xl">
                <h3 class="text-xl font-bold">Ronda Adicional</h3>
            </div>
            <div class="p-6">
                <p class="text-gray-700 mb-4">Se ha terminado la fase regular. Seg√∫n tu posici√≥n en la tabla:</p>
                <p class="font-bold text-lg text-slate-800 mb-6">¬øDebe jugarse la ronda extra (Play-offs / Eliminatoria previa)?</p>
                
                <div class="bg-amber-50 border border-amber-200 rounded-lg p-3 mb-6 flex items-start gap-3">
                    <input type="checkbox" id="chk-play-extra" class="w-5 h-5 text-amber-600 mt-0.5">
                    <div>
                        <label for="chk-play-extra" class="font-bold text-amber-800 cursor-pointer">S√≠, jugar ronda extra</label>
                        <p class="text-xs text-amber-700">Marca esto si has quedado entre la posici√≥n 9 y 24 (Masculino) o necesitas jugar ronda previa (Femenino).</p>
                    </div>
                </div>

                <div class="flex gap-3">
                    <button onclick="confirmExtraRound()" class="flex-1 px-4 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-700 font-medium">
                        Confirmar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div id="player-selector-modal" class="modal fixed inset-0 bg-black/80 items-center justify-center p-4 backdrop-blur-sm" style="z-index: 9999 !important;">
        <div class="bg-white rounded-xl w-full max-w-md shadow-2xl overflow-hidden flex flex-col max-h-[80vh] relative z-[10000]">
            <div class="p-4 border-b bg-slate-900 text-white flex justify-between items-center">
                <h3 class="font-bold">Seleccionar Jugador</h3>
                <button onclick="closePlayerSelector()" class="text-gray-400 hover:text-white text-xl font-bold">‚úï</button>
            </div>
            
            <div class="p-3 bg-gray-50 border-b">
                <input type="text" id="player-selector-search" 
                       onkeyup="filterSelectorList()" 
                       onkeydown="handleSelectorKey(event)"
                       placeholder="üîç Buscar jugador (ej: Roc√≠o, Vini...)" 
                       class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-blue-500 outline-none text-gray-800">
            </div>

            <div id="player-selector-list" class="overflow-y-auto p-2 space-y-1 flex-1 bg-white">
                </div>
            
            <div class="p-3 border-t bg-gray-50 text-center">
                <button onclick="selectPlayerForSlot(null)" class="text-red-500 text-sm font-bold hover:underline py-2 w-full border border-red-100 rounded hover:bg-red-50">
                    üóëÔ∏è Dejar posici√≥n vac√≠a
                </button>
            </div>
        </div>
    </div>

    <div id="trophy-modal" class="modal fixed inset-0 z-50 flex items-center justify-center bg-black/80 backdrop-blur-sm hidden">
        <div class="bg-white w-full max-w-5xl h-[90vh] rounded-xl shadow-2xl overflow-hidden flex flex-col m-4">
            <div class="p-5 border-b border-gray-100 flex justify-between items-center bg-gradient-to-r from-amber-50 to-white">
                <div class="flex items-center gap-3">
                    <span class="text-3xl">üèÜ</span>
                    <div>
                        <h2 class="text-xl font-bold text-gray-800">Sala de Trofeos</h2>
                        <p class="text-xs text-gray-500 font-medium">Logros desbloqueados: <span id="trophy-count" class="text-amber-600 font-bold">0/0</span></p>
                    </div>
                </div>
                <button onclick="closeTrophyRoom()" class="text-gray-400 hover:text-gray-600 p-2 hover:bg-gray-100 rounded-full transition-colors">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            
            <div class="flex-1 overflow-y-auto bg-slate-50 p-4">
                <div id="trophy-container" class="trophy-grid"></div>
            </div>
        </div>
    </div>

        <div id="minute-modal" class="modal fixed inset-0 z-[99999] hidden flex items-center justify-center" style="z-index: 99999 !important;">
    <div class="absolute inset-0 bg-black bg-opacity-60 transition-opacity backdrop-blur-sm" onclick="closeMinuteModal()"></div>
    
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-sm m-4 relative z-[100000] overflow-hidden border border-gray-200 h-auto">
        <div class="bg-slate-800 px-4 py-3 border-b border-slate-700 flex justify-between items-center">
            <h3 class="font-bold text-white flex items-center gap-2">
                <span>‚è±Ô∏è</span> 
                <span id="minute-modal-title">Registrar Minutos</span>
            </h3>
            <button onclick="closeMinuteModal()" class="text-gray-400 hover:text-white font-bold text-xl">&times;</button>
        </div>
        <div class="p-5">
            <p class="text-xs text-gray-500 mb-4 font-medium">
                Introduce los minutos separados por comas.
            </p>
            <input type="text" id="minute-input-field" 
                   class="w-full border-2 border-gray-200 rounded-lg px-3 py-3 text-xl font-mono text-center font-bold text-slate-700 focus:border-indigo-500 focus:ring-4 focus:ring-indigo-50 outline-none transition-all placeholder-gray-300" 
                   placeholder="Ej: 15, 67" autocomplete="off">
            <div class="flex gap-2 mt-4 justify-center">
                <button onclick="addMinuteToInput('45')" class="px-3 py-1.5 bg-gray-100 rounded hover:bg-gray-200 text-xs font-bold text-gray-600">45'</button>
                <button onclick="addMinuteToInput('90')" class="px-3 py-1.5 bg-gray-100 rounded hover:bg-gray-200 text-xs font-bold text-gray-600">90'</button>
                <button onclick="addMinuteToInput('120')" class="px-3 py-1.5 bg-gray-100 rounded hover:bg-gray-200 text-xs font-bold text-gray-600">120'</button>
                <button onclick="addMinuteToInput('+')" class="px-3 py-1.5 bg-indigo-50 text-indigo-600 rounded hover:bg-indigo-100 text-xs font-bold">+</button>
            </div>
        </div>
        <div class="bg-gray-50 px-4 py-3 border-t border-gray-100 flex justify-end gap-2">
            <button onclick="closeMinuteModal()" class="px-4 py-2 text-sm text-gray-600 font-bold hover:bg-gray-200 rounded">Cancelar</button>
            <button onclick="saveMinutesFromModal()" class="px-4 py-2 text-sm bg-indigo-600 text-white rounded font-bold hover:bg-indigo-700 shadow-lg transform active:scale-95 transition-all">‚úÖ Guardar</button>
        </div>
    </div>
</div>

</div> </div> 

<script>

// Variables de Estado de la Aplicaci√≥n
let editingMatchPlayersPool = null; // <--- ESTA ERA LA QUE FALTABA



//RESTO DE FUNCIONES (switchAppMode, getData, saveData...) 
// (Mantenlas igual que en el paso anterior, ya funcionan con este nuevo CLOUD_API)
        // ==========================================
        // DATA & CONSTANTS
        // ==========================================
        
        let currentTeam = null; 
        let PLANTILLA_ACTUAL = [];
        let COMPETICIONES_ACTUALES = {};
        
        // Custom order for registration as requested
        const CUSTOM_ORDER_MASCULINO = [
            'dt1', 'p1', 'p13', 'p12', 'p2', 'p24', 'p17b', 'p22', 'p3', 'p4', 'p18', 'p20', 'p23', 
            'p14', 'p6', 'p8', 'p19', 'p5', 'p15', 'p7', 'p11', 'p21', 'p10', 'p16', 'p9', 'p30', 
            'p10b', 'p17', 'p44', 'p31','p40','p35','p28'
        ];
        const CUSTOM_ORDER_FEMENINO = [
            'dt_fem', 'pf1', 'pf13', 'pf15', 'pf2', 'pf23', 'pf14', 'pf4','pf22' ,'pf21', 'pf12', 'pf3', 'pf6', 'pf16', 
            'pf17', 'pf10', 'pf8', 'pf18', 'pf7', 'pf19', 'pf5', 'pf20', 'pf9', 'pf11', 'pf24', 'pf28', 'pf29', 
            'pf33', 'pf43', 'pf27','pf38'
        ];
        const PLANTILLA_MASCULINO = [
            // CUERPO T√âCNICO
            { id: "dt1", nombre: "Xabi", apellido: "Alonso", apodo: "Xabi Alonso", posicion: "entrenador", rol: "ENT", dorsal: "DT", nacionalidad: "Espa√±a", fechaNacimiento: "1981-11-25", categoria: "Primer Equipo", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20XABI_CARITA_380x501%20%E2%80%93%202?$Desktop$&fit=wrap&wid=288&hei=384" },

            // PORTEROS
            { id: "p1", nombre: "Thibaut", apellido: "Courtois", apodo: "Courtois", posicion: "portero", rol: "POR", dorsal: 1, piePreferido:'Izquierdo', nacionalidad: "B√©lgica", fechaNacimiento: "1992-05-11", categoria: "Primer Equipo", estado: "Activo", valorMercado: "18", unidad:"M‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20COURTOIS_EQUIPO_CARITA_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "p13", nombre: "Andriy", apellido: "Lunin", apodo: "Lunin", posicion: "portero", rol: "POR", dorsal: 13, piePreferido:'Derecho', nacionalidad: "Ucrania", fechaNacimiento: "1999-02-11", categoria: "Primer Equipo", estado: "Activo", valorMercado: "15", unidad:"M‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20LUNIN_EQUIPO_CARITA_380x501?Desktop&fit=wrap&wid=288&hei=384" },

            // DEFENSAS
            { id: "p2", nombre: "Dani", apellido: "Carvajal", apodo: "Carvajal", posicion: "defensa", rol: "LD", dorsal: 2, piePreferido:'Derecho', nacionalidad: "Espa√±a", fechaNacimiento: "1992-01-11", categoria: "Primer Equipo", estado: "Activo", valorMercado: "7", unidad:"M‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20CARVAJAL_EQUIPO_CARITA_380x501%20%E2%80%93%206?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "p3", nombre: "√âder", apellido: "Milit√£o", apodo: "Milit√£o", posicion: "defensa", rol: "DFC", dorsal: 3, piePreferido:'Derecho', nacionalidad: "Brasil", fechaNacimiento: "1998-01-18", categoria: "Primer Equipo", estado: "Activo", valorMercado: "30", unidad:"M‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20MILITAO_EQUIPO_CARITA_380x501%20%E2%80%93%2013?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "p4", nombre: "David", apellido: "Alaba", apodo: "Alaba", posicion: "defensa", rol: "DFC", dorsal: 4, piePreferido:'Izquierdo', nacionalidad: "Austria", fechaNacimiento: "1992-06-24", categoria: "Primer Equipo", estado: "Activo", valorMercado: "4", unidad:"M‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20ALABA_EQUIPO_CARITA_380x501%20%E2%80%93%201?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "p12", nombre: "Trent", apellido: "Alexander-Arnold", apodo: "Alexander-Arnold", posicion: "defensa", rol: "LD", dorsal: 12, piePreferido:'Derecho', nacionalidad: "Inglaterra", fechaNacimiento: "1998-10-07", categoria: "Primer Equipo", estado: "Activo", valorMercado: "70", unidad:"M‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20TRENT_EQUIPO_CARITA_380x501%20v2?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "p17", nombre: "Lucas", apellido: "V√°zquez", apodo: "Lucas V√°zquez", posicion: "defensa", rol: "LD", dorsal: 17, piePreferido:'Derecho', nacionalidad: "Espa√±a", fechaNacimiento: "1991-07-01", categoria: "Primer Equipo", estado: "Leyenda", valorMercado: "-", unidad:"M‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/LUCAS_VAZQUEZ_EQUIPO_CARITA_550X650+%E2%80%93+1-1" },
            { id: "p17b", nombre: "Ra√∫l", apellido: "Asencio", apodo: "Asencio", posicion: "defensa", rol: "DFC", dorsal: 17, piePreferido:'Derecho', nacionalidad: "Espa√±a", fechaNacimiento: "2003-03-13", categoria: "Primer Equipo", estado: "Activo", valorMercado: "30", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20ASENCIO_EQUIPO_CARITA_380x501%20%E2%80%93%203?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "p18", nombre: "√Ålvaro", apellido: "Carreras", apodo: "Carreras", posicion: "defensa", rol: "LI", dorsal: 18, piePreferido:'Izquierdo', nacionalidad: "Espa√±a", fechaNacimiento: "2003-03-23", categoria: "Primer Equipo", estado: "Activo", valorMercado: "60", unidad:"M‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20CARRERAS_EQUIPO_CARITA_380x501%20%E2%80%93%202?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "p20", nombre: "Fran", apellido: "Garc√≠a", apodo: "Fran Garc√≠a", posicion: "defensa", rol: "LI", dorsal: 20, piePreferido:'Izquierdo', nacionalidad: "Espa√±a", fechaNacimiento: "1999-08-14", categoria: "Primer Equipo", estado: "Activo", valorMercado: "15", unidad:"M‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20FRAN_GARCIA_EQUIPO_CARITA_380x501%20%E2%80%93%201?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "p22", nombre: "Antonio", apellido: "R√ºdiger", apodo: "R√ºdiger", posicion: "defensa", rol: "DFC", dorsal: 22,piePreferido:'Derecho', nacionalidad: "Alemania", fechaNacimiento: "1993-03-03", categoria: "Primer Equipo", estado: "Activo", valorMercado: "12", unidad:"M‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20RUDIGUER_EQUIPO_CARITA_380x501%20%E2%80%93%202?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "p23", nombre: "Ferland", apellido: "Mendy", apodo: "Mendy", posicion: "defensa", rol: "LI", dorsal: 23,piePreferido:'Izquierdo', nacionalidad: "Francia", fechaNacimiento: "1995-06-08", categoria: "Primer Equipo", estado: "Activo", valorMercado: "8", unidad:"M‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20MENDY_EQUIPO_CARITA_380x501%20%E2%80%93%201" },
            { id: "p24", nombre: "Dean", apellido: "Huijsen", apodo: "Huijsen", posicion: "defensa", rol: "DFC", dorsal: 24,piePreferido:'Derecho', nacionalidad: "Espa√±a", fechaNacimiento: "2005-04-14", categoria: "Primer Equipo", estado: "Activo", valorMercado: "70", unidad:"M‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20HUIJSEN_EQUIPO_CARITA_380x501%20%E2%80%93%201" },
            { id: "p31", nombre: "Jacobo", apellido: "Ram√≥n", apodo: "Jacobo Ram√≥n", posicion: "defensa", rol: "DFC", dorsal: 31,piePreferido:'Derecho', nacionalidad: "Espa√±a", fechaNacimiento: "2005-01-06", categoria: "Cantera", estado: "Inactivo", valorMercado: "-", unidad:"M‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/JACOBO-RAMON-MONTAJE_JT18489" },
            { id: "p35", nombre: "David", apellido: "Jim√©nez", apodo: "David Jim√©nez", posicion: "defensa", rol: "LD", dorsal: 35,piePreferido:'Derecho', nacionalidad: "Espa√±a", fechaNacimiento: "2004-03-14", categoria: "Cantera", estado: "Activo", valorMercado: "4", unidad:"K‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/DAVID_JIMENEZ_550x650?$Desktop$&fit=wrap&wid=420" },
            { id: "p40", nombre: "Victor", apellido: "Valdepe√±as", apodo: "Valdepe√±as", posicion: "defensa", rol: "LI", dorsal: 40,piePreferido:'Izquierdo',nacionalidad: "Espa√±a", fechaNacimiento: "2006-10-20", categoria: "Cantera", estado: "Activo", valorMercado: "5", unidad:"K‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/VICTOR_VALDEPE%C3%91AS_550x650?$Desktop$&fit=wrap&wid=420" },

            // CENTROCAMPISTAS
            { id: "p5", nombre: "Jude", apellido: "Bellingham", apodo: "Bellingham", posicion: "centrocampista", rol: "MCO", dorsal: 5,piePreferido:'Derecho', nacionalidad: "Inglaterra", fechaNacimiento: "2003-06-29", categoria: "Primer Equipo", estado: "Activo", valorMercado: "160", unidad:"M‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20BELLINGHAM_EQUIPO_CARITA_380x501%20%E2%80%93%201?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "p6", nombre: "Eduardo", apellido: "Camavinga", apodo: "Camavinga", posicion: "centrocampista", rol: "MC", dorsal: 6,piePreferido:'Izquierdo', nacionalidad: "Francia", fechaNacimiento: "2002-11-10", categoria: "Primer Equipo", estado: "Activo", valorMercado: "50", unidad:"M‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20CAMAVINGA_EQUIPO_CARITA_380x501%20%E2%80%93%201?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "p8", nombre: "Federico", apellido: "Valverde", apodo: "Valverde", posicion: "centrocampista", rol: "MC", dorsal: 8,piePreferido:'Derecho', nacionalidad: "Uruguay", fechaNacimiento: "1998-07-22", categoria: "Primer Equipo", estado: "Activo", valorMercado: "150", unidad:"M‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20VALVERDE_EQUIPO_CARITA_380x501%20%E2%80%93%201?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "p10b", nombre: "Luka", apellido: "Modriƒá", apodo: "Modriƒá", posicion: "centrocampista", rol: "MC", dorsal: 10,piePreferido:'Derecho', nacionalidad: "Croacia", fechaNacimiento: "1985-09-09", categoria: "Primer Equipo", estado: "Leyenda", valorMercado: "-", unidad:"M‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/MODRIC_EQUIPO_CARITA_550X650+%E2%80%93+1" },
            { id: "p14", nombre: "Aur√©lien", apellido: "Tchouam√©ni", apodo: "Tchouam√©ni", posicion: "centrocampista", rol: "MCD", dorsal: 14,piePreferido:'Derecho', nacionalidad: "Francia", fechaNacimiento: "2000-01-27", categoria: "Primer Equipo", estado: "Activo", valorMercado: "75", unidad:"M‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20TCHOUAMENI_EQUIPO_CARITA_380x501%20%E2%80%93%201?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "p15", nombre: "Arda", apellido: "G√ºler", apodo: "Arda G√ºler", posicion: "centrocampista", rol: "MCO", dorsal: 15,piePreferido:'Izquierdo', nacionalidad: "Turqu√≠a", fechaNacimiento: "2005-02-25", categoria: "Primer Equipo", estado: "Activo", valorMercado: "90", unidad:"M‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20ARDA_EQUIPO_CARITA_380x501%20%E2%80%93%202?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "p19", nombre: "Dani", apellido: "Ceballos", apodo: "Ceballos", posicion: "centrocampista", rol: "MC", dorsal: 19,piePreferido:'Derecho', nacionalidad: "Espa√±a", fechaNacimiento: "1996-08-07", categoria: "Primer Equipo", estado: "Activo", valorMercado: "8", unidad:"M‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20CEBALLOS_EQUIPO_CARITA_380x501%20%E2%80%93%201?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "p28", nombre: "Jorge", apellido: "Cestero", apodo: "Cestero", posicion: "centrocampista", rol: "MC", dorsal: 28,piePreferido:'Derecho', nacionalidad: "Espa√±a", fechaNacimiento: "2006-03-24", categoria: "Cantera", estado: "Activo", valorMercado: "3", unidad:"M‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/JORGE_CESTERO_550x650?$Desktop$&fit=wrap&wid=420" },

            // DELANTEROS Y EXTREMOS
            { id: "p7", nombre: "Vin√≠cius", apellido: "J√∫nior", apodo: "Vini Jr.", posicion: "extremo", rol: "EI", dorsal: 7,piePreferido:'Derecho', nacionalidad: "Brasil", fechaNacimiento: "2000-07-12", categoria: "Primer Equipo", estado: "Activo", valorMercado: "150", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20VINI_EQUIPO_CARITA_380x501%20%E2%80%93%201?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "p9", nombre: "Endrick", apellido: "Felipe", apodo: "Endrick", posicion: "delantero", rol: "DC", dorsal: 9,piePreferido:'Izquierdo', nacionalidad: "Brasil", fechaNacimiento: "2006-07-21", categoria: "Primer Equipo", estado: "Inactivo", valorMercado: "25", unidad:"M‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20ENDRICK_EQUIPO_CARITA_380x501%20%E2%80%93%208?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "p10", nombre: "Kylian", apellido: "Mbapp√©", apodo: "Mbapp√©", posicion: "delantero", rol: "DC", dorsal: 10,piePreferido:'Derecho', nacionalidad: "Francia", fechaNacimiento: "1998-12-20", categoria: "Primer Equipo", estado: "Activo", valorMercado: "200", unidad:"M‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20MBAPPE_EQUIPO_CARITA_380x501%20%E2%80%93%201?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "p11", nombre: "Rodrygo", apellido: "Goes", apodo: "Rodrygo", posicion: "extremo", rol: "ED", dorsal: 11,piePreferido:'Derecho', nacionalidad: "Brasil", fechaNacimiento: "2001-01-09", categoria: "Primer Equipo", estado: "Activo", valorMercado: "60", unidad:"M‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20RODRYGO_EQUIPO_CARITA_380x501%20%E2%80%93%201?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "p16", nombre: "Gonzalo", apellido: "Garc√≠a", apodo: "Gonzalo", posicion: "delantero", rol: "DC", dorsal: 16,piePreferido:'Derecho', nacionalidad: "Espa√±a", fechaNacimiento: "2004-03-24", categoria: "Cantera", estado: "Activo", valorMercado: "15", unidad:"M‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20GONZALO_EQUIPO_CARITA_380x501%20%E2%80%93%202?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "p21", nombre: "Brahim", apellido: "D√≠az", apodo: "Brahim", posicion: "extremo", rol: "ED", dorsal: 21,piePreferido:'Derecho', nacionalidad: "Marruecos", fechaNacimiento: "1999-08-03", categoria: "Primer Equipo", estado: "Activo", valorMercado: "35", unidad:"M‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20BRAHIM_EQUIPO_CARITA_380x501%20%E2%80%93%201?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "p30", nombre: "Franco", apellido: "Mastantuono", apodo: "Mastantuono", posicion: "extremo", rol: "ED", dorsal: 30,piePreferido:'Izquierdo', nacionalidad: "Argentina", fechaNacimiento: "2007-08-14", categoria: "Primer Equipo", estado: "Activo", valorMercado: "50", unidad:"M‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20Mastantuono_EQUIPO_CARITA_380x501%20%E2%80%93%202%20v2?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "p44", nombre: "V√≠ctor", apellido: "Mu√±oz", apodo: "V√≠ctor M√∫√±oz", posicion: "extremo", rol: "EI", dorsal: 44,piePreferido:'Derecho', nacionalidad: "Espa√±a", fechaNacimiento: "2003-07-13", categoria: "Cantera", estado: "Inactivo", valorMercado: "-", unidad:"M‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/VICTOR_MU%C3%91OZ" }
        ];


        const PLANTILLA_FEMENINO = [
            // CUERPO T√âCNICO
            { id: "dt_fem", nombre: "Pau", apellido: "Quesada", apodo: "Pau Quesada", posicion: "entrenador", rol: "ENT", dorsal: "DT", nacionalidad: "Espa√±a", fechaNacimiento: "1992-10-31", categoria: "Primer Equipo", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/PAU_QUESADA_CT_AV39125_380x501?$Desktop$&fit=wrap&wid=288&hei=384" },

            // PORTERAS
            { id: "pf1", nombre: "Misa", apellido: "Rodr√≠guez", apodo: "Misa", posicion: "portero", rol: "POR", dorsal: 1,piePreferido:'Izquierdo', nacionalidad: "Espa√±a", fechaNacimiento: "1999-07-22", categoria: "Primer Equipo", estado: "Activo", valorMercado: "150", unidad:"K‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/MISA_AV38131_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf13", nombre: "Merle", apellido: "Frohms", apodo: "Frohms", posicion: "portero", rol: "POR", dorsal: 13,piePreferido:'Izquierdo', nacionalidad: "Alemania", fechaNacimiento: "1995-01-28", categoria: "Primer Equipo", estado: "Activo", valorMercado: "135", unidad:"K‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/FROHMS_SG11686_380x501?Desktop&fit=wrap&wid=288&hei=384" },

            // DEFENSAS
            { id: "pf2", nombre: "Ant√¥nia", apellido: "Silva", apodo: "Ant√¥nia Silva", posicion: "defensa", rol: "LD", dorsal: 2,piePreferido:'Izquierdo', nacionalidad: "Brasil", fechaNacimiento: "1994-04-26", categoria: "Primer Equipo", estado: "Activo", valorMercado: "190", unidad:"K‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/ANTONIA_AV38661_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf4", nombre: "Roc√≠o", apellido: "G√°lvez", apodo: "Roc√≠o", posicion: "defensa", rol: "DFC", dorsal: 4,piePreferido:'Izquierdo', nacionalidad: "Espa√±a", fechaNacimiento: "1997-04-15", categoria: "Primer Equipo", estado: "Activo", valorMercado: "175", unidad:"K‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/ROCIO_SG11273_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf12", nombre: "Yasmim", apellido: "Ribeiro", apodo: "Yasmim", posicion: "defensa", rol: "LI", dorsal: 12,piePreferido:'Izquierdo', nacionalidad: "Brasil", fechaNacimiento: "1996-10-28", categoria: "Primer Equipo", estado: "Activo", valorMercado: "160", unidad:"K‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/YASMIM_AV38779_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf14", nombre: "Mar√≠a", apellido: "M√©ndez", apodo: "Mar√≠a M√©ndez", posicion: "defensa", rol: "DFC", dorsal: 14,piePreferido:'Izquierdo', nacionalidad: "Espa√±a", fechaNacimiento: "2001-04-10", categoria: "Primer Equipo", estado: "Activo", valorMercado: "450", unidad:"K‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/MENDEZ_AV39701_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf15", nombre: "Sheila", apellido: "Garc√≠a", apodo: "Sheila", posicion: "defensa", rol: "LD", dorsal: 15,piePreferido:'Izquierdo', nacionalidad: "Espa√±a", fechaNacimiento: "1997-03-15", categoria: "Primer Equipo", estado: "Activo", valorMercado: "280", unidad:"K‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/SHEI_AV38558_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf21", nombre: "Sara", apellido: "Holmgaard", apodo: "Holmgaard", posicion: "defensa", rol: "LI", dorsal: 21,piePreferido:'Izquierdo', nacionalidad: "Dinamarca", fechaNacimiento: "1999-01-28", categoria: "Primer Equipo", estado: "Activo", valorMercado: "110", unidad:"K‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/HOLMGAARD_SG11429_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf22", nombre: "Bella", apellido: "Andersson", apodo: "Bella Andersson", posicion: "defensa", rol: "DFC", dorsal: 22,piePreferido:'Izquierdo', nacionalidad: "Suecia", fechaNacimiento: "2006-07-12", categoria: "Primer Equipo", estado: "Activo", valorMercado: "125", unidad:"K‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/ANDERSSON_SG11562_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf23", nombre: "Ma√´lle", apellido: "Lakrar", apodo: "Lakrar", posicion: "defensa", rol: "DFC", dorsal: 23,piePreferido:'Izquierdo', nacionalidad: "Francia", fechaNacimiento: "2000-05-27", categoria: "Primer Equipo", estado: "Activo", valorMercado: "380", unidad:"K‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/LAKRAR_SG12372_380x501?$Desktop$&fit=wrap&wid=288&hei=384" },
            { id: "pf27", nombre: "Noem√≠", apellido: "Bejarano", apodo: "Noe", posicion: "defensa", rol: "LD", dorsal: 27,piePreferido:'Izquierdo', nacionalidad: "Espa√±a", fechaNacimiento: "2006-06-27", categoria: "Cantera", estado: "Activo", valorMercado: "40", unidad:"K‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/NOE_BEJARANO_JT11209_550x650?$Desktop$&fit=wrap&wid=420" },
            { id: "pf29", nombre: "Silvia", apellido: "Cristobal", apodo: "Silvi", posicion: "defensa", rol: "DFC", dorsal: 29,piePreferido:'Izquierdo', nacionalidad: "Espa√±a", fechaNacimiento: "2008-05-01", categoria: "Cantera", estado: "Activo", valorMercado: "80", unidad:"K‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/SILVIA_CRISTOBAL_JT11245_550x650?$Desktop$&fit=wrap&wid=288&hei=384" },

            // CENTROCAMPISTAS
            { id: "pf3", nombre: "Teresa", apellido: "Abelleira", apodo: "Tere", posicion: "centrocampista", rol: "MCD", dorsal: 3,piePreferido:'Izquierdo', nacionalidad: "Espa√±a", fechaNacimiento: "2000-01-09", categoria: "Primer Equipo", estado: "Activo", valorMercado: "390", unidad:"K‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/TERESA_AV38432_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf6", nombre: "Sandie", apellido: "Toletti", apodo: "Toletti", posicion: "centrocampista", rol: "MCD", dorsal: 6,piePreferido:'Izquierdo', nacionalidad: "Francia", fechaNacimiento: "1995-07-13", categoria: "Primer Equipo", estado: "Activo", valorMercado: "365", unidad:"K‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/TOLETTI__AV39153_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf8", nombre: "Sara", apellido: "D√§britz", apodo: "D√§britz", posicion: "centrocampista", rol: "MCO", dorsal: 8,piePreferido:'Izquierdo', nacionalidad: "Alemania", fechaNacimiento: "1995-02-15", categoria: "Primer Equipo", estado: "Activo", valorMercado: "400", unidad:"K‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/DABRITZ_AV38874_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf10", nombre: "Caroline", apellido: "Weir", apodo: "Weir", posicion: "centrocampista", rol: "MCO", dorsal: 10,piePreferido:'Izquierdo', nacionalidad: "Escocia", fechaNacimiento: "1995-06-20", categoria: "Primer Equipo", estado: "Activo", valorMercado: "800", unidad:"K‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/WEIR_AV39819_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf16", nombre: "Filippa", apellido: "Angeldahl", apodo: "Angeldahl", posicion: "centrocampista", rol: "MC", dorsal: 16,piePreferido:'Izquierdo', nacionalidad: "Suecia", fechaNacimiento: "1997-07-14", categoria: "Primer Equipo", estado: "Activo", valorMercado: "575", unidad:"K‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/ANGELDAHL_SG11965_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf17", nombre: "Hanna", apellido: "Bennison", apodo: "Hanna Bennison", posicion: "centrocampista", rol: "MC", dorsal: 17,piePreferido:'Izquierdo', nacionalidad: "Suecia", fechaNacimiento: "2002-10-16", categoria: "Primer Equipo", estado: "Activo", valorMercado: "260", unidad:"K‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/BENNISON_AV39265_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf28", nombre: "Irune", apellido: "Dorado", apodo: "Irune", posicion: "centrocampista", rol: "MCD", dorsal: 28,piePreferido:'Izquierdo', nacionalidad: "Espa√±a", fechaNacimiento: "2008-03-22", categoria: "Cantera", estado: "Activo", valorMercado: "70", unidad:"K‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/IRUNE_DORADO_JT11218_550x650?$Desktop$&fit=wrap&wid=288&hei=384" },
            { id: "pf33", nombre: "Adriana", apellido: "Folgado", apodo: "Adri Folgado", posicion: "centrocampista", rol: "MCD", dorsal: 33,piePreferido:'Izquierdo', nacionalidad: "Espa√±a", fechaNacimiento: "2007-04-10", categoria: "Cantera", estado: "Activo", valorMercado: "30", unidad:"K‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/ADRIANA_FOLGADO_JT11189_550x650?$Desktop$&fit=wrap&wid=288&hei=384" },

            // DELANTERAS Y EXTREMOS
            { id: "pf5", nombre: "Paula", apellido: "Comendador", apodo: "Pau Comendador", posicion: "delantero", rol: "ED", dorsal: 5,piePreferido:'Izquierdo', nacionalidad: "Espa√±a", fechaNacimiento: "2007-06-18", categoria: "Cantera", estado: "Activo", valorMercado: "70", unidad:"K‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/PAU_AV38975_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf7", nombre: "Athenea", apellido: "del Castillo", apodo: "Athenea", posicion: "extremo", rol: "ED", dorsal: 7,piePreferido:'Izquierdo', nacionalidad: "Espa√±a", fechaNacimiento: "2000-10-24", categoria: "Primer Equipo", estado: "Activo", valorMercado: "650", unidad:"K‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/ATHENEA_AV38283_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf9", nombre: "Signe", apellido: "Bruun", apodo: "Bruun", posicion: "delantero", rol: "DC", dorsal: 9,piePreferido:'Izquierdo', nacionalidad: "Dinamarca", fechaNacimiento: "1998-04-02", categoria: "Primer Equipo", estado: "Activo", valorMercado: "325", unidad:"K‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/BRUUN_SG12081_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf11", nombre: "Alba", apellido: "Redondo", apodo: "Alba Redondo", posicion: "delantero", rol: "DC", dorsal: 11,piePreferido:'Izquierdo', nacionalidad: "Espa√±a", fechaNacimiento: "1996-08-27", categoria: "Primer Equipo", estado: "Activo", valorMercado: "480", unidad:"K‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/REDONDO_SG11818_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf18", nombre: "Linda", apellido: "Caicedo", apodo: "Linda Caicedo", posicion: "extremo", rol: "EI", dorsal: 18,piePreferido:'Izquierdo', nacionalidad: "Colombia", fechaNacimiento: "2005-02-22", categoria: "Primer Equipo", estado: "Activo", valorMercado: "1", unidad:"M‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/LINDA_AV39478_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf19", nombre: "Eva", apellido: "Navarro", apodo: "Eva Navarro", posicion: "extremo", rol: "ED", dorsal: 19,piePreferido:'Izquierdo', nacionalidad: "Espa√±a", fechaNacimiento: "2001-01-27", categoria: "Primer Equipo", estado: "Activo", valorMercado: "200", unidad:"K‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/EVA_NAVARRO_AV39366_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf20", nombre: "Naomie", apellido: "Feller", apodo: "Feller", posicion: "extremo", rol: "ED", dorsal: 20,piePreferido:'Izquierdo', nacionalidad: "Francia", fechaNacimiento: "2001-11-06", categoria: "Primer Equipo", estado: "Activo", valorMercado: "275", unidad:"K‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/FELLER_AV39583_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf24", nombre: "Lotte", apellido: "Keukelaar", apodo: "Keukelaar", posicion: "extremo", rol: "ED", dorsal: 24,piePreferido:'Izquierdo', nacionalidad: "Pa√≠ses Bajos", fechaNacimiento: "2005-09-25", categoria: "Primer Equipo", estado: "Activo", valorMercado: "175", unidad:"K‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/KEUKELAAR_380x501?$Desktop$&fit=wrap&wid=288&hei=384" },
            { id: "pf38", nombre: "Naiara", apellido: "Sanmart√≠n", apodo: "Naiara", posicion: "extremo", rol: "EI", dorsal: 38,piePreferido:'Izquierdo', nacionalidad: "Espa√±a", fechaNacimiento: "2006-01-23", categoria: "Cantera", estado: "Activo", valorMercado: "40", unidad:"K‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/NAIARA_SAN_MARTIN_JT11237_550x650?$Desktop$&fit=wrap&wid=420" },
            { id: "pf43", nombre: "Iris", apellido: "Ashley", apodo: "Iris Ashley", posicion: "delantero", rol: "DC", dorsal: 43,piePreferido:'Izquierdo', nacionalidad: "Espa√±a", fechaNacimiento: "2007-11-09", categoria: "Cantera", estado: "Activo", valorMercado: "30", unidad:"K‚Ç¨", foto: "https://assets.realmadrid.com/is/image/realmadrid/IRIS_JT11144_550x650?$Desktop$&fit=wrap&wid=420" }
            ];
        // Coordenadas para la Pizarra T√°ctica (top%, left%)
        // El portero siempre es el √≠ndice 0.
        // Coordenadas Horizontal: Portero a la Izquierda (Left ~5%)
        const FORMACIONES = {
            '4-4-2': [
                { left: 5, top: 50 }, // PT
                { left: 25, top: 15 }, { left: 25, top: 38 }, { left: 25, top: 62 }, { left: 25, top: 85 }, // Defensas
                { left: 50, top: 15 }, { left: 50, top: 38 }, { left: 50, top: 62 }, { left: 50, top: 85 }, // Medios
                { left: 80, top: 35 }, { left: 80, top: 65 }  // Delanteros
            ],
            '4-3-3': [
                { left: 5, top: 50 }, // PT
                { left: 25, top: 10 }, { left: 25, top: 35 }, { left: 25, top: 65 }, { left: 25, top: 90 }, // Defensas
                { left: 45, top: 50 }, { left: 60, top: 25 }, { left: 60, top: 75 }, // Medios (Pivote + 2 Interiores)
                { left: 85, top: 15 }, { left: 85, top: 50 }, { left: 85, top: 85 }  // Delanteros
            ],
            '4-2-3-1': [
                { left: 5, top: 50 }, // PT
                { left: 22, top: 10 }, { left: 22, top: 35 }, { left: 22, top: 65 }, { left: 22, top: 90 }, // Defensas
                { left: 42, top: 35 }, { left: 42, top: 65 }, // Doble Pivote
                { left: 65, top: 15 }, { left: 65, top: 50 }, { left: 65, top: 85 }, // Mediapuntas
                { left: 85, top: 50 }  // Punta
            ],
            '3-5-2': [
                { left: 5, top: 50 }, // PT
                { left: 22, top: 30 }, { left: 22, top: 50 }, { left: 22, top: 70 }, // 3 Centrales
                { left: 45, top: 10 }, { left: 45, top: 90 }, // Carrileros
                { left: 45, top: 50 }, { left: 60, top: 35 }, { left: 60, top: 65 }, // Medios
                { left: 80, top: 35 }, { left: 80, top: 65 }  // Delanteros
            ]
        };
        const COMPETICIONES_MASCULINO = {
            'Liga EA Sports': {
                id: 'liga',
                nombre: 'Liga EA Sports',
                color: 'comp-liga',
                borderColor: 'border-comp-liga',
                tipo: 'liga',
                ordenLibre: true,
                fases: [{ tipo: 'liga', rondas: Array.from({length: 38}, (_, i) => ({ id: `jornada-${i+1}`, nombre: `Jornada ${i+1}`, orden: i+1 })) }]
            },
            'Mundial de Clubes': {
                id: 'mundial',
                nombre: 'Mundial de Clubes',
                color: 'comp-mundial',
                borderColor: 'border-comp-mundial',
                tipo: 'copa',
                campoNeutral: true,
                fases: [
                    { tipo: 'grupos', nombre: 'Fase de Grupos', rondas: [
                        { id: 'grupos-1', nombre: 'Fase de Grupos - Jornada 1', orden: 1 },
                        { id: 'grupos-2', nombre: 'Fase de Grupos - Jornada 2', orden: 2 },
                        { id: 'grupos-3', nombre: 'Fase de Grupos - Jornada 3', orden: 3 }
                    ]},
                    { tipo: 'eliminatoria', nombre: 'Eliminatorias', rondas: [
                        { id: 'octavos', nombre: 'Octavos de Final', orden: 4, eliminatoria: true, partidoUnico: true },
                        { id: 'cuartos', nombre: 'Cuartos de Final', orden: 5, eliminatoria: true, partidoUnico: true },
                        { id: 'semifinal', nombre: 'Semifinal', orden: 6, eliminatoria: true, partidoUnico: true },
                        { id: 'final', nombre: 'Final', orden: 7, eliminatoria: true, partidoUnico: true }
                    ]}
                ]
            },
            'Champions League': {
                id: 'champions',
                nombre: 'Champions League',
                color: 'comp-champions',
                borderColor: 'border-comp-champions',
                tipo: 'copa',
                fases: [
                    { tipo: 'liga', nombre: 'Fase de Liga', ordenLibre: true, rondas: Array.from({length: 8}, (_, i) => ({ id: `fase-liga-${i+1}`, nombre: `Fase de Liga - Jornada ${i+1}`, orden: i+1 })) },
                    { tipo: 'eliminatoria', nombre: 'Eliminatorias', rondas: [
                        { id: 'dieciseisavos-ida', nombre: 'Play-offs - Ida', orden: 8.1, eliminatoria: true, idaVuelta: 'ida', pareja: 'dieciseisavos-vuelta', rondaExtra: true },
                        { id: 'dieciseisavos-vuelta', nombre: 'Play-offs - Vuelta', orden: 8.2, eliminatoria: true, idaVuelta: 'vuelta', pareja: 'dieciseisavos-ida', rondaExtra: true },
                        { id: 'octavos-ida', nombre: 'Octavos de Final - Ida', orden: 9, eliminatoria: true, idaVuelta: 'ida', pareja: 'octavos-vuelta' },
                        { id: 'octavos-vuelta', nombre: 'Octavos de Final - Vuelta', orden: 10, eliminatoria: true, idaVuelta: 'vuelta', pareja: 'octavos-ida' },
                        { id: 'cuartos-ida', nombre: 'Cuartos de Final - Ida', orden: 11, eliminatoria: true, idaVuelta: 'ida', pareja: 'cuartos-vuelta' },
                        { id: 'cuartos-vuelta', nombre: 'Cuartos de Final - Vuelta', orden: 12, eliminatoria: true, idaVuelta: 'vuelta', pareja: 'cuartos-ida' },
                        { id: 'semifinal-ida', nombre: 'Semifinal - Ida', orden: 13, eliminatoria: true, idaVuelta: 'ida', pareja: 'semifinal-vuelta' },
                        { id: 'semifinal-vuelta', nombre: 'Semifinal - Vuelta', orden: 14, eliminatoria: true, idaVuelta: 'vuelta', pareja: 'semifinal-ida' },
                        { id: 'final', nombre: 'Final', orden: 15, eliminatoria: true, partidoUnico: true }
                    ]}
                ]
            },
            'Copa del Rey': {
                id: 'copa',
                nombre: 'Copa del Rey',
                color: 'comp-copa',
                borderColor: 'border-comp-copa',
                tipo: 'copa',
                fases: [
                    { tipo: 'eliminatoria', nombre: 'Eliminatorias', rondas: [
                        { id: 'dieciseisavos', nombre: 'Dieciseisavos de Final', orden: 1, eliminatoria: true, partidoUnico: true },
                        { id: 'octavos', nombre: 'Octavos de Final', orden: 2, eliminatoria: true, partidoUnico: true },
                        { id: 'cuartos', nombre: 'Cuartos de Final', orden: 3, eliminatoria: true, partidoUnico: true },
                        { id: 'semifinal-ida', nombre: 'Semifinal - Ida', orden: 4, eliminatoria: true, idaVuelta: 'ida', pareja: 'semifinal-vuelta' },
                        { id: 'semifinal-vuelta', nombre: 'Semifinal - Vuelta', orden: 5, eliminatoria: true, idaVuelta: 'vuelta', pareja: 'semifinal-ida' },
                        { id: 'final', nombre: 'Final', orden: 6, eliminatoria: true, partidoUnico: true }
                    ]}
                ]
            },
            'Supercopa de Espa√±a': {
                id: 'supercopa',
                nombre: 'Supercopa de Espa√±a',
                color: 'comp-supercopa',
                borderColor: 'border-comp-supercopa',
                tipo: 'copa',
                fases: [
                    { tipo: 'eliminatoria', nombre: 'Eliminatorias', rondas: [
                        { id: 'semifinal', nombre: 'Semifinal', orden: 1, eliminatoria: true, partidoUnico: true },
                        { id: 'final', nombre: 'Final', orden: 2, eliminatoria: true, partidoUnico: true }
                    ]}
                ]
            }
        };

        const COMPETICIONES_FEMENINO = {
             'Liga F': {
                id: 'liga-f',
                nombre: 'Liga F',
                color: 'comp-liga',
                borderColor: 'border-comp-liga',
                tipo: 'liga',
                ordenLibre: true,
                fases: [{ tipo: 'liga', rondas: Array.from({length: 30}, (_, i) => ({ id: `jornada-${i+1}`, nombre: `Jornada ${i+1}`, orden: i+1 })) }]
            },
            'UWCL': {
                id: 'uwcl',
                nombre: 'UWCL',
                color: 'comp-champions',
                borderColor: 'border-comp-champions',
                tipo: 'copa',
                fases: [
                    // 1. Fase Previa (2 partidos) - Orden 1 y 2
                    { tipo: 'eliminatoria', nombre: 'Fase Previa', rondas: [
                        { id: 'fase-previa-ida', nombre: 'Fase Previa - Ida', orden: 1, eliminatoria: true, idaVuelta: 'ida', pareja: 'fase-previa-vuelta' },
                        { id: 'fase-previa-vuelta', nombre: 'Fase Previa - Vuelta', orden: 2, eliminatoria: true, idaVuelta: 'vuelta', pareja: 'fase-previa-ida' }
                    ]},
                    // 2. Fase de Grupos (6 partidos) - Orden del 3 al 8
                    // AQU√ç EST√Å EL CAMBIO CLAVE: length: 6
                    { tipo: 'grupos', nombre: 'Fase de Grupos', rondas: Array.from({length: 6}, (_, i) => ({ id: `grupos-${i+1}`, nombre: `Fase Grupos - J${i+1}`, orden: i+3 })) },
                    
                    // 3. Eliminatorias
                    { tipo: 'eliminatoria', nombre: 'Eliminatorias', rondas: [
                        // Ronda Extra (Play-offs) - Orden 8.1 y 8.2 (Justo despu√©s de la jornada 6 que tiene orden 8)
                        { id: 'octavos-ida', nombre: 'Octavos de Final - Ida', orden: 8.1, eliminatoria: true, idaVuelta: 'ida', pareja: 'octavos-vuelta', rondaExtra: true },
                        { id: 'octavos-vuelta', nombre: 'Octavos de Final - Vuelta', orden: 8.2, eliminatoria: true, idaVuelta: 'vuelta', pareja: 'octavos-ida', rondaExtra: true },
                        
                        // Resto de fases
                        { id: 'cuartos-ida', nombre: 'Cuartos de Final - Ida', orden: 9, eliminatoria: true, idaVuelta: 'ida', pareja: 'cuartos-vuelta' },
                        { id: 'cuartos-vuelta', nombre: 'Cuartos de Final - Vuelta', orden: 10, eliminatoria: true, idaVuelta: 'vuelta', pareja: 'cuartos-ida' },
                        { id: 'semifinal-ida', nombre: 'Semifinal - Ida', orden: 11, eliminatoria: true, idaVuelta: 'ida', pareja: 'semifinal-vuelta' },
                        { id: 'semifinal-vuelta', nombre: 'Semifinal - Vuelta', orden: 12, eliminatoria: true, idaVuelta: 'vuelta', pareja: 'semifinal-ida' },
                        { id: 'final', nombre: 'Final', orden: 13, eliminatoria: true, partidoUnico: true }
                    ]}
                ]
            },
             'Copa de la Reina': {
                id: 'copa-reina',
                nombre: 'Copa de la Reina',
                color: 'comp-copa',
                borderColor: 'border-comp-copa',
                tipo: 'copa',
                fases: [
                    { tipo: 'eliminatoria', nombre: 'Eliminatorias', rondas: [
                        { id: 'octavos', nombre: 'Octavos de Final', orden: 1, eliminatoria: true, partidoUnico: true },
                        { id: 'cuartos', nombre: 'Cuartos de Final', orden: 2, eliminatoria: true, partidoUnico: true },
                        { id: 'semifinal-ida', nombre: 'Semifinal - Ida', orden: 3, eliminatoria: true, idaVuelta: 'ida', pareja: 'semifinal-vuelta' },
                        { id: 'semifinal-vuelta', nombre: 'Semifinal - Vuelta', orden: 4, eliminatoria: true, idaVuelta: 'vuelta', pareja: 'semifinal-ida' },
                        { id: 'final', nombre: 'Final', orden: 5, eliminatoria: true, partidoUnico: true }
                    ]}
                ]
            },
            'Supercopa Femenina': {
                id: 'supercopa-fem',
                nombre: 'Supercopa Femenina',
                color: 'comp-supercopa',
                borderColor: 'border-comp-supercopa',
                tipo: 'copa',
                fases: [
                    { tipo: 'eliminatoria', nombre: 'Eliminatorias', rondas: [
                        { id: 'semifinal', nombre: 'Semifinal', orden: 1, eliminatoria: true, partidoUnico: true },
                        { id: 'final', nombre: 'Final', orden: 2, eliminatoria: true, partidoUnico: true }
                    ]}
                ]
            }
        };

        const TEAMS_CONFIG = {
            masculino: {
                icalUrl: 'https://publish.realmadrid.com/content/sling/app-servlets/realmadrid/ical.3kq9cckrnlogidldtdie2fkbl.es-es.ics',
                plantilla: PLANTILLA_MASCULINO,
                competiciones: COMPETICIONES_MASCULINO,
                title: 'Real Madrid Masculino',
                manualJuneMatches: true
            },
            femenino: {
                icalUrl: 'https://publish.realmadrid.com/content/sling/app-servlets/realmadrid/ical.vaikl8nl7hdr4y9jj4jyb9ey.es-es.ics',
                plantilla: PLANTILLA_FEMENINO,
                competiciones: COMPETICIONES_FEMENINO,
                title: 'Real Madrid Femenino',
                manualJuneMatches: false
            }
        };
        // Nombres de posiciones por √≠ndice de hueco (0 es Portero, 1-10 Jugadores de campo)
const FORMATION_ROLES = {
    '4-3-3': ['Portero', 'Lateral Izq', 'Central', 'Central', 'Lateral Der', 'Pivote', 'Interior', 'Interior', 'Extremo Izq', 'Delantero Centro', 'Extremo Der'],
    '4-4-2': ['Portero', 'Lateral Izq', 'Central', 'Central', 'Lateral Der', 'Extremo Izq', 'Medio Centro', 'Medio Centro', 'Extremo Der', 'Delantero', 'Delantero'],
    '4-2-3-1': ['Portero', 'Lateral Izq', 'Central', 'Central', 'Lateral Der', 'Pivote', 'Pivote', 'Extremo Izq', 'Mediapunta','Extremo Der','Delantero'],
    '3-5-2': ['Portero', 'Central', 'Central', 'Central', 'Carrilero Izq', 'Pivote', 'Carrilero Der', 'Interior', 'Interior', 'Delantero', 'Delantero'],
    // Fallback gen√©rico
    'default': ['Portero', 'Defensa', 'Defensa', 'Defensa', 'Defensa', 'Centrocampista', 'Centrocampista', 'Centrocampista', 'Delantero', 'Delantero', 'Delantero']
};

function getPositionName(formation, index) {
    const roles = FORMATION_ROLES[formation] || FORMATION_ROLES['default'];
    return roles[index] || 'Jugador de Campo';
}

        // Variables globales
        let calendarEvents = [];
        let currentPlayerFilter = 'all';
        let currentPositionFilter = '';
        let currentCalendarFilter = '';
        let currentTimeFilter = 'all';
        let hideRegisteredMatches = false;
        let selectedCalendarFixture = null;
        let calendarViewMode = 'month'; // 'list' or 'month' - Default to month
        let currentCalendarDate = new Date(); // Tracks the month shown in calendar view
        
        // Sorting State
        let currentSortColumn = 'matchesPlayed';
        let currentSortOrder = 'desc'; // 'asc' or 'desc'

        // ==========================================
        // TEAM SELECTION & INIT
        // ==========================================

        function selectTeam(team) {
            currentTeam = team;
            // IMPORTANT: Clear calendar events to avoid mixing teams
            calendarEvents = [];
            
            const config = TEAMS_CONFIG[team];
            PLANTILLA_ACTUAL = config.plantilla;
            COMPETICIONES_ACTUALES = config.competiciones;

            document.getElementById('header-subtitle').textContent = config.title;
            document.getElementById('section-welcome').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');

            currentPlayerFilter = 'all';
            currentPositionFilter = '';
            
            // RESET FILTERS
            currentTimeFilter = 'all';
            currentCalendarFilter = '';
            hideRegisteredMatches = false;
            document.getElementById('hide-registered-matches').checked = false;
            calendarViewMode = 'month'; // Ensure default is month
            currentCalendarDate = new Date();
            
            renderPlayers();
            populateComparatorSelects();
            populateCompetitionSelect();
            populateH2HOpponents();
            showTab('principal');

            // Force load calendar immediately after setup
            loadCalendar();
        }

        function returnToWelcome() {
            document.getElementById('app-container').classList.add('hidden');
            document.getElementById('section-welcome').classList.remove('hidden');
            currentTeam = null;
            PLANTILLA_ACTUAL = [];
            COMPETICIONES_ACTUALES = {};
            calendarEvents = [];
        }

        // ==========================================
        // DATA MANAGEMENT (TEAM SCOPED)
        // ==========================================
        
             function getData(key) {

            if (!currentTeam) return [];

            const scopedKey = `${currentTeam}_${key}`;

            const data = localStorage.getItem(scopedKey);

            return data ? JSON.parse(data) : [];

        }



        function saveData(key, data) {

            if (!currentTeam) return;

            const scopedKey = `${currentTeam}_${key}`;

            localStorage.setItem(scopedKey, JSON.stringify(data));

        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function getPlayers() {
            if (!currentTeam) return [];
            const customStates = getData('playerStates');
            return PLANTILLA_ACTUAL.map(p => {
                const customState = customStates.find(cs => cs.id === p.id);
                return customState ? { ...p, estado: customState.estado } : p;
            });
        }

        function getActivePlayers() {
            return getPlayers().filter(p => p.estado === 'Activo');
        }

        function updatePlayerState(playerId, newState) {
            let customStates = getData('playerStates');
            const existingIndex = customStates.findIndex(cs => cs.id === playerId);
            if (existingIndex !== -1) {
                customStates[existingIndex].estado = newState;
            } else {
                customStates.push({ id: playerId, estado: newState });
            }
            saveData('playerStates', customStates);
        }

        // ==========================================
        // COMPETITION STATE MANAGEMENT
        // ==========================================
        
        function getCompetitionState() {
            return getData('competitionState') || {};
        }

        function saveCompetitionState(state) {
            saveData('competitionState', state);
        }

        function getAvailableRounds(compName) {
            const comp = COMPETICIONES_ACTUALES[compName];
            if (!comp) return [];
            
            const matches = getData('matches').filter(m => m.competition === compName);
            const state = getCompetitionState();
            
            // Datos del estado guardado
            const eliminatedAt = state[compName]?.eliminatedAt;
            const extraRoundState = state[compName]?.playsExtra;
            
            let allRounds = [];
            // Aplanar estructura
            comp.fases.forEach(fase => {
                fase.rondas.forEach(ronda => {
                    allRounds.push({ ...ronda, faseTipo: fase.tipo, faseNombre: fase.nombre, faseOrdenLibre: fase.ordenLibre });
                });
            });

            // Filtrar ronda extra si el usuario dijo que NO se juega
            if (extraRoundState === false) {
                allRounds = allRounds.filter(r => !r.rondaExtra);
            }

            // Ordenar por orden num√©rico
            allRounds.sort((a, b) => a.orden - b.orden);
            
            const completedRoundIds = matches.map(m => m.roundId);
            const result = [];
            const isLeagueFormat = comp.ordenLibre || comp.tipo === 'liga';
            
            let eliminationTriggered = false; // Flag maestro de bloqueo

            for (let i = 0; i < allRounds.length; i++) {
                const ronda = allRounds[i];
                const isCompleted = completedRoundIds.includes(ronda.id);
                
                // Si ya pasamos la ronda de eliminaci√≥n en una iteraci√≥n anterior, bloqueamos todo lo que queda
                if (eliminationTriggered) {
                    result.push({ ...ronda, status: 'locked' });
                    continue;
                }

                let isAvailable = false;
                
                if (ronda.faseTipo === 'liga' || ronda.faseOrdenLibre || isLeagueFormat) {
                    isAvailable = !isCompleted;
                } else {
                    // L√≥gica secuencial: Si la anterior est√° completa, esta est√° disponible
                    if (i === 0) {
                        isAvailable = !isCompleted; 
                    } else {
                        const prevRound = allRounds[i - 1];
                        // La anterior cuenta como completada si se jug√≥ O si era de tipo liga (que no bloquea)
                        const isPrevCompleted = completedRoundIds.includes(prevRound.id) || prevRound.faseTipo === 'liga' || prevRound.faseOrdenLibre;
                        isAvailable = !isCompleted && isPrevCompleted;
                    }
                }
                
                // DETECCI√ìN DE ELIMINACI√ìN
                // Si esta ronda es donde nos eliminaron, activamos el flag para bloquear las siguientes
                if (eliminatedAt === ronda.id) {
                    eliminationTriggered = true;
                }
                
                result.push({
                    ...ronda,
                    status: isCompleted ? 'completed' : (isAvailable ? 'available' : 'locked')
                });
            }
            return result;
        }

        function checkEliminationAfterMatch(match) {
            const comp = COMPETICIONES_ACTUALES[match.competition];
            if (!comp) return;
            
            let roundInfo = null;
            // Buscar la ronda en todas las fases
            comp.fases.forEach(fase => {
                const found = fase.rondas.find(r => r.id === match.roundId);
                if (found) roundInfo = { ...found, faseTipo: fase.tipo };
            });
            
            // Si no es eliminatoria o es liga, no hacemos nada
            if (!roundInfo || !roundInfo.eliminatoria || roundInfo.faseTipo === 'liga') return;
            
            let isEliminated = false;

            // 1. Eliminaci√≥n forzada manual
            if (match.forceElimination) {
                isEliminated = true;
            }
            // 2. Partido √önico (Copa, Supercopa, Finales)
            else if (roundInfo.partidoUnico) {
                isEliminated = match.outcome === 'derrota';
            } 
            // 3. Partido de Vuelta (Champions, UWCL)
            else if (roundInfo.idaVuelta === 'vuelta') {
                const matches = getData('matches').filter(m => m.competition === match.competition);
                const idaMatch = matches.find(m => m.roundId === roundInfo.pareja);
                
                if (idaMatch) {
                    const globalResult = calculateGlobalResult(idaMatch, match);
                    isEliminated = globalResult.outcome === 'derrota';
                }
            }
            
            // SI ESTAMOS ELIMINADOS, GUARDAMOS EL ESTADO
            if (isEliminated) {
                console.log(`‚ùå Eliminado de ${match.competition} en ${match.roundId}`);
                const state = getCompetitionState();
                
                // Aseguramos que existe el objeto para esa compe
                if (!state[match.competition]) state[match.competition] = {};
                
                // Actualizamos flags sin borrar lo que hubiera (ej: playsExtra)
                state[match.competition].eliminated = true;
                state[match.competition].eliminatedAt = match.roundId;
                
                saveCompetitionState(state);
            }
        }

        function calculateGlobalResult(idaMatch, vueltaMatch) {
            const getGoals = (m) => {
                const parts = m.result.replace('*','').split('-').map(Number);
                if (m.venue === 'local') return { us: parts[0], them: parts[1] };
                if (m.venue === 'visitante') return { us: parts[1], them: parts[0] };
                return { us: parts[0], them: parts[1] }; 
            };

            const ida = getGoals(idaMatch);
            const vuelta = getGoals(vueltaMatch);

            const totalUs = ida.us + vuelta.us;
            const totalThem = ida.them + vuelta.them;

            let outcome;
            if (totalUs > totalThem) outcome = 'victoria';
            else if (totalUs < totalThem) outcome = 'derrota';
            else {
                const awayGoalsUs = (idaMatch.venue === 'visitante' ? ida.us : 0) + (vueltaMatch.venue === 'visitante' ? vuelta.us : 0);
                const awayGoalsThem = (idaMatch.venue === 'local' ? ida.them : 0) + (vueltaMatch.venue === 'local' ? vuelta.them : 0);

                if (awayGoalsUs > awayGoalsThem) outcome = 'victoria';
                else if (awayGoalsUs < awayGoalsThem) outcome = 'derrota';
                else outcome = 'empate'; 
            }
            
            return { totalFavor: totalUs, totalContra: totalThem, outcome };
        }
        
       function recalculateCompetitionState(compName) {
            console.log(`Recalculando estado para: ${compName}`);
            
            // 1. Obtener estado actual
            let state = getCompetitionState();
            
            // 2. Limpiar SOLO los flags de eliminaci√≥n (respetando playsExtra si existe)
            if (state[compName]) {
                delete state[compName].eliminated;
                delete state[compName].eliminatedAt;
            } else {
                state[compName] = {};
            }
            saveCompetitionState(state);
            
            // 3. Obtener partidos y re-evaluar cronol√≥gicamente
            const matches = getData('matches')
                .filter(m => m.competition === compName)
                .sort((a, b) => new Date(a.date) - new Date(b.date));
                
            matches.forEach(match => {
                checkEliminationAfterMatch(match);
            });
            
            // Log para verificar
            const newState = getCompetitionState();
            console.log("Estado final:", newState[compName]);
       }

        // ==========================================
        // STATISTICS
        // ==========================================

        function switchStatsTab(tab) {
            document.querySelectorAll('.stats-subtab').forEach(el => {
                el.classList.remove('active');
                el.classList.add('inactive');
            });
            document.getElementById(`btn-stats-${tab}`).classList.add('active');
            document.getElementById(`btn-stats-${tab}`).classList.remove('inactive');

            document.getElementById('stats-general').classList.add('hidden');
            document.getElementById('stats-advanced').classList.add('hidden');
            document.getElementById('stats-h2h').classList.add('hidden');
            document.getElementById('stats-mvp').classList.add('hidden'); // <-- A√ëADIR ESTA L√çNEA

            document.getElementById(`stats-${tab}`).classList.remove('hidden');

            if (tab === 'advanced') {
                renderAdvancedStats();
            } else if (tab === 'h2h') {
                populateH2HOpponents();
            }else if (tab === 'mvp') { // <-- A√ëADIR ESTE BLOQUE
                renderMVPGallery();
            }
        }
  

// --- FUNCI√ìN DE ORDENACI√ìN (HANDLE SORT) ---
function handleSort(column) {
    // Si pulsamos la misma columna, invertimos el orden
    if (currentSortColumn === column) {
        currentSortOrder = currentSortOrder === 'desc' ? 'asc' : 'desc';
    } else {
        // Si es nueva columna, empezamos en descendente (lo m√°s alto arriba)
        currentSortColumn = column;
        currentSortOrder = 'desc';
        
        // Excepci√≥n: Si ordenamos por Nombre, mejor empezar Ascendente (A-Z)
        if (column === 'name') currentSortOrder = 'asc';
    }
    
    // IMPORTANTE: Repintar la tabla
    renderStats();
}
function renderTopPerformances() {
    const container = document.getElementById('top-performances-container');
    const listContainer = document.getElementById('top-performances-list');
    
    if (!container || !listContainer) return;

    const matches = getData('matches');
    const players = getPlayers();
    
    // 1. Recopilar TODAS las actuaciones individuales
    let allPerformances = [];

    matches.forEach(match => {
        match.playerStats.forEach(ps => {
            // Filtros: Que tenga nota, que no sea 0 (opcional), y que NO sea el entrenador
            if (ps.rating !== null && ps.rating !== undefined && ps.rating !== "") {
                const ratingVal = parseFloat(ps.rating);
                const player = players.find(p => p.id === ps.playerId);
                
                // Excluir entrenador y asegurar que el jugador existe
                if (player && player.posicion !== 'entrenador' && player.dorsal !== 'DT') {
                    allPerformances.push({
                        rating: ratingVal,
                        player: player,
                        match: match,
                        stats: ps
                    });
                }
            }
        });
    });

    // 2. Ordenar por Nota (Descendente)
    // Si hay empate de nota, desempata por goles, luego asistencias, luego fecha m√°s reciente
    allPerformances.sort((a, b) => {
        if (b.rating !== a.rating) return b.rating - a.rating;
        if ((b.stats.goals || 0) !== (a.stats.goals || 0)) return (b.stats.goals || 0) - (a.stats.goals || 0);
        return new Date(b.match.date) - new Date(a.match.date);
    });

    // 3. Coger el Top 5
    const top5 = allPerformances.slice(0, 5);

    if (top5.length === 0) {
        container.classList.add('hidden');
        return;
    }

    container.classList.remove('hidden');

    // 4. Renderizar HTML
    listContainer.innerHTML = top5.map((perf, index) => {
        const isNumberOne = index === 0;
        const p = perf.player;
        const m = perf.match;
        const s = perf.stats;

        // Estilos especiales para el n√∫mero 1
        const cardBorder = isNumberOne ? 'border-amber-400 ring-1 ring-amber-100' : 'border-gray-200';
        const ratingBg = isNumberOne ? 'bg-amber-500 text-white' : 'bg-gray-100 text-gray-800';

        return `
            <div class="bg-white rounded-xl shadow-sm border ${cardBorder} p-3 flex flex-col relative overflow-hidden transition-transform hover:scale-105">
                ${isNumberOne ? '<div class="absolute top-0 right-0 bg-amber-400 text-white text-[9px] font-bold px-2 py-0.5 rounded-bl-lg z-10">MVP TOTAL</div>' : ''}
                
                <div class="flex justify-between items-start mb-2">
                    <div class="flex items-center gap-2">
                        <img src="${p.foto}" class="w-10 h-10 rounded-full object-cover border border-gray-100">
                        <div class="min-w-0">
                            <p class="text-xs font-bold text-gray-800 truncate leading-tight">${p.apodo || p.apellido}</p>
                            <p class="text-[10px] text-gray-500">vs ${m.opponent}</p>
                        </div>
                    </div>
                    <div class="${ratingBg} font-bold text-lg px-2 rounded-lg shadow-sm">
                        ${perf.rating}
                    </div>
                </div>

                <div class="mt-auto pt-2 border-t border-gray-50">
                    <div class="flex justify-between items-center text-[10px] text-gray-500 mb-1">
                        <span class="truncate max-w-[80px]">${m.competition}</span>
                        <span>${m.result}</span>
                    </div>
                    
                    <div class="grid grid-cols-3 gap-1 text-center bg-gray-50 rounded-lg py-1">
                        <div class="flex flex-col">
                            <span class="text-[9px] text-gray-400 uppercase">Gol</span>
                            <span class="font-bold text-emerald-600 text-xs">${s.goals || 0}</span>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-[9px] text-gray-400 uppercase">Asist</span>
                            <span class="font-bold text-blue-600 text-xs">${s.assists || 0}</span>
                        </div>
                        <div class="flex flex-col">
                            <span class="text-[9px] text-gray-400 uppercase">Min</span>
                            <span class="font-bold text-gray-600 text-xs">${s.minutes}'</span>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

/* ========================================================= */
/* üìä RENDERIZAR ESTAD√çSTICAS (TABLA + GR√ÅFICOS)             */
/* ========================================================= */

function renderStats() {
    const matches = getData('matches');
    const players = getPlayers();
    
    const competitionFilter = document.getElementById('stats-filter-competition').value;
    const statusFilter = document.getElementById('stats-filter-status').value;
    
    // 1. ACTUALIZAR CABECERAS
    document.querySelectorAll('th.sortable').forEach(th => {
        th.classList.remove('th-active');
        th.innerHTML = th.innerText.replace(' ‚ñ≤', '').replace(' ‚ñº', '');
    });
    const activeTh = document.getElementById(`th-${currentSortColumn}`);
    if (activeTh) {
        activeTh.classList.add('th-active');
        activeTh.innerHTML += currentSortOrder === 'asc' ? ' ‚ñ≤' : ' ‚ñº';
    }

    // 2. FILTRAR PARTIDOS
    let filteredMatches = matches;
    if (competitionFilter) {
        filteredMatches = filteredMatches.filter(m => m.competition === competitionFilter);
    }

    // L√≥gica de Rachas
    const streakContainer = document.getElementById('team-streak');
    const last5Matches = [...matches].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
    if (last5Matches.length > 0 && streakContainer) {
        streakContainer.innerHTML = last5Matches.map(m => {
            let outcomeClass = 'streak-d'; let letter = 'E';
            if (m.outcome === 'victoria') { outcomeClass = 'streak-w'; letter = 'V'; }
            else if (m.outcome === 'derrota') { outcomeClass = 'streak-l'; letter = 'D'; }
            return `<span class="streak-dot ${outcomeClass}" title="${m.opponent} (${m.result})">${letter}</span>`;
        }).join('');
    } else if (streakContainer) {
        streakContainer.innerHTML = '<span class="text-gray-500 text-sm">Sin partidos jugados</span>';
    }

    // TOTALES GLOBALES
    let totalWins = 0, totalDraws = 0, totalLosses = 0;
    let totalGoalsFor = 0, totalGoalsAgainst = 0;
    let totalAssists = 0;
    
    filteredMatches.forEach(m => {
        if (m.outcome === 'victoria') totalWins++;
        else if (m.outcome === 'empate') totalDraws++;
        else if (m.outcome === 'derrota') totalLosses++;

        if (m.result && m.result.includes('-')) {
            const parts = m.result.replace('*','').split('-').map(Number);
            if (m.venue === 'local') { totalGoalsFor += parts[0]; totalGoalsAgainst += parts[1]; }
            else if (m.venue === 'visitante') { totalGoalsFor += parts[1]; totalGoalsAgainst += parts[0]; }
            else { totalGoalsFor += parts[0]; totalGoalsAgainst += parts[1]; }
        }
    });
    
    if(document.getElementById('stat-total-matches')) document.getElementById('stat-total-matches').textContent = filteredMatches.length;
    if(document.getElementById('stat-wins')) document.getElementById('stat-wins').textContent = totalWins;
    if(document.getElementById('stat-draws')) document.getElementById('stat-draws').textContent = totalDraws;
    if(document.getElementById('stat-losses')) document.getElementById('stat-losses').textContent = totalLosses;
    if(document.getElementById('stat-total-goals')) document.getElementById('stat-total-goals').textContent = totalGoalsFor;
    if(document.getElementById('stat-total-goals-against')) document.getElementById('stat-total-goals-against').textContent = totalGoalsAgainst;

    let filteredPlayers = [...players];
    if (statusFilter) {
        filteredPlayers = filteredPlayers.filter(p => p.estado === statusFilter);
    }
    
    const playerOnlyCount = filteredPlayers.filter(p => p.posicion !== 'entrenador').length;
    if(document.getElementById('stat-total-players')) document.getElementById('stat-total-players').textContent = playerOnlyCount;

    // 3. MAPEAR DATOS
    const playerStats = filteredPlayers.map(player => {
        const stats = {
            id: player.id,
            name: player.apodo || `${player.nombre} ${player.apellido}`,
            number: player.dorsal,
            foto: player.foto,
            posicion: player.posicion,
            estado: player.estado,
            matchesPlayed: 0,
            starts: 0, 
            totalRating: 0,
            ratingCount: 0,
            goals: 0,
            assists: 0,
            ga: 0,
            minutes: 0,
            mvpCount: 0,
            wins: 0, draws: 0, losses: 0,
            yellowCards: 0, redCards: 0,
            last5Ratings: [],
            positionsPlayed: {},
            minPerMatch: 0, gPer90: 0, aPer90: 0, gaPer90: 0, avgRating: '-'
        };
        
        filteredMatches.forEach(match => {
            const ps = match.playerStats?.find(s => String(s.playerId) === String(player.id));
            if (ps) {
                if (ps.minutes > 0 || ps.played) {
                    stats.matchesPlayed++;
                    if (ps.isStarter) stats.starts++;
                    const posName = ps.specificPosition || (ps.isStarter ? 'Titular' : 'Suplente');
                    stats.positionsPlayed[posName] = (stats.positionsPlayed[posName] || 0) + 1;
                }
                stats.goals += (ps.goals || 0);
                stats.assists += (ps.assists || 0);
                stats.minutes += (ps.minutes || 0);
                stats.yellowCards += (ps.yellowCards || 0);
                stats.redCards += (ps.redCards || 0);
                
                if (ps.rating !== null && ps.rating !== "" && ps.rating !== undefined) {
                    stats.totalRating += parseFloat(ps.rating);
                    stats.ratingCount++;
                    stats.last5Ratings.push(parseFloat(ps.rating));
                }
                
                if (match.outcome === 'victoria') stats.wins++;
                else if (match.outcome === 'empate') stats.draws++;
                else if (match.outcome === 'derrota') stats.losses++;
            }
            if (String(match.mvp) === String(player.id)) stats.mvpCount++;
        });
        
        stats.avgRating = stats.ratingCount > 0 ? (stats.totalRating / stats.ratingCount).toFixed(2) : '-';
        stats.ga = stats.goals + stats.assists;
        stats.minPerMatch = stats.matchesPlayed > 0 ? (stats.minutes / stats.matchesPlayed).toFixed(0) : '-';
        
        const factor = stats.minutes > 0 ? (90 / stats.minutes) : 0;
        stats.gPer90 = (stats.goals * factor).toFixed(2);
        stats.aPer90 = (stats.assists * factor).toFixed(2);
        stats.gaPer90 = (stats.ga * factor).toFixed(2);

        totalAssists += stats.assists;
        return stats;
    });

    if(document.getElementById('stat-total-assists')) document.getElementById('stat-total-assists').textContent = totalAssists;

    // 4. ORDENAR
    playerStats.sort((a, b) => {
        if (a.estado === 'Inactivo' && b.estado !== 'Inactivo') return 1;
        if (a.estado !== 'Inactivo' && b.estado === 'Inactivo') return -1;

        let valA = a[currentSortColumn];
        let valB = b[currentSortColumn];

        if (currentSortColumn === 'name') return currentSortOrder === 'asc' ? valA.localeCompare(valB) : valB.localeCompare(valA);
        if (currentSortColumn === 'avgRating') {
            valA = (valA === '-' || valA === null) ? -1 : parseFloat(valA);
            valB = (valB === '-' || valB === null) ? -1 : parseFloat(valB);
        }
        else if (currentSortColumn === 'number') {
            if (valA === 'DT') valA = -1; else valA = parseInt(valA) || 0;
            if (valB === 'DT') valB = -1; else valB = parseInt(valB) || 0;
        }
        else {
            valA = parseFloat(valA) || 0;
            valB = parseFloat(valB) || 0;
        }
        return currentSortOrder === 'asc' ? valA - valB : valB - valA;
    });

    // 5. PINTAR TABLA
    const tableBody = document.getElementById('stats-table-body');
    const noStats = document.getElementById('no-stats');
    
    if (playerStats.length === 0) {
        tableBody.innerHTML = '';
        noStats.classList.remove('hidden');
    } else {
        noStats.classList.add('hidden');
        tableBody.innerHTML = playerStats.map(stats => {
            const isCoach = stats.number === 'DT' || stats.posicion === 'entrenador';
            
            return `
            <tr class="border-t hover:bg-gray-50 cursor-pointer ${stats.estado === 'Inactivo' ? 'opacity-60 bg-gray-50' : ''}" onclick="viewPlayerDetails('${stats.id}')">
                <td class="px-4 py-3">
                    <div class="flex items-center gap-3">
                        <img src="${stats.foto}" class="player-photo-small" onerror="this.src='https://via.placeholder.com/40x40?text=${stats.number}'">
                        <div>
                            <span class="font-medium text-gray-800">${stats.name}</span>
                            <span class="text-gray-500 text-sm ml-1">${stats.number === 'DT' ? 'DT' : '#' + stats.number}</span>
                            ${stats.estado === 'Inactivo' ? '<span class="text-xs text-red-500 font-bold ml-1">(Inactivo)</span>' : ''}
                        </div>
                    </div>
                </td>
                <td class="px-4 py-3 text-center font-medium">${stats.matchesPlayed}</td>
                <td class="px-4 py-3 text-center font-semibold text-indigo-600">${stats.starts}</td>
                <td class="px-4 py-3 text-center font-semibold ${getRatingColor(stats.avgRating)}">${stats.avgRating}</td>
                <td class="px-4 py-3 text-center font-medium text-emerald-600">${isCoach ? '-' : stats.goals}</td>
                <td class="px-2 py-3 text-center text-xs text-blue-500 font-mono">${isCoach ? '-' : stats.gPer90}</td>
                <td class="px-4 py-3 text-center">${isCoach ? '-' : stats.assists}</td>
                <td class="px-2 py-3 text-center text-xs text-blue-500 font-mono">${isCoach ? '-' : stats.aPer90}</td>
                <td class="px-4 py-3 text-center font-bold">${isCoach ? '-' : stats.ga}</td>
                <td class="px-2 py-3 text-center text-xs text-purple-600 font-bold font-mono">${isCoach ? '-' : stats.gaPer90}</td>
                <td class="px-4 py-3 text-center text-gray-600">${isCoach ? '-' : stats.minutes + "'"}</td>
                <td class="px-2 py-3 text-center text-xs text-gray-500 italic">${isCoach ? '-' : stats.minPerMatch + "'"}</td>
                <td class="px-4 py-3 text-center">
                    ${stats.mvpCount > 0 ? `<span class="bg-amber-100 text-amber-700 px-2 py-0.5 rounded-full text-sm font-medium">${stats.mvpCount}</span>` : '-'}
                </td>
                <td class="px-4 py-3 text-center text-green-600 font-medium">${stats.wins}</td>
                <td class="px-4 py-3 text-center text-amber-600">${stats.draws}</td>
                <td class="px-4 py-3 text-center text-red-600">${stats.losses}</td>
                <td class="px-4 py-3 text-center">${stats.yellowCards > 0 ? stats.yellowCards : '-'}</td>
                <td class="px-4 py-3 text-center">${stats.redCards > 0 ? `<span class="text-red-600 font-medium">${stats.redCards}</span>` : '-'}</td>
            </tr>
            `}).join('');
    }

    // ... (Todo el c√≥digo anterior de la tabla sigue igual) ...

    // =========================================================
    // 6. RENDERIZAR GR√ÅFICOS Y AN√ÅLISIS VISUAL
    // =========================================================
    
    // 1. Mostrar la secci√≥n visual (por si estaba oculta)
    const visualSection = document.getElementById('stats-visual-section');
    if (visualSection) {
        visualSection.classList.remove('hidden');
    }

    // 2. Inyectar el An√°lisis de Goles en su hueco espec√≠fico
    const goalContainer = document.getElementById('stats-goal-analysis-container');
    if (goalContainer) {
        // Llamamos a la funci√≥n que crea las barras y lo metemos en el DIV
        goalContainer.innerHTML = (typeof renderGoalAnalysis === 'function') 
            ? renderGoalAnalysis() 
            : '';
    }

    // 3. Renderizar el resto de gr√°ficos existentes
    // Nota: Aseg√∫rate de que 'renderCharts' pinte dentro de 'stats-charts-wrapper' 
    // o el ID que tengas configurado para ello.
    if(typeof renderCharts === 'function') renderCharts(filteredMatches);
    if(typeof renderBestXI === 'function') renderBestXI();
    if(typeof renderScatterChart === 'function') renderScatterChart();
    if(typeof renderRegularityAnalysis === 'function') renderRegularityAnalysis();
    if(typeof renderTopPerformances === 'function') renderTopPerformances();
    if(typeof renderFormationStats === 'function') renderFormationStats();
}
        /* ========================================================= */
/* üìà RENDERIZAR GR√ÅFICOS (EVOLUCI√ìN Y GOLES)                */
/* ========================================================= */
let evolutionChart = null;
let goalsChart = null;

function renderCharts(filteredMatches) {
    // 1. PREPARAR EL TERRENO (HTML)
    const wrapper = document.getElementById('stats-charts-wrapper');
    if (!wrapper) return;

    // Inyectamos los canvas si no existen
    // Creamos dos huecos: Arriba la evoluci√≥n (ancho), Abajo el donut (centrado)
    wrapper.innerHTML = `
        <div class="relative h-60 w-full mb-6">
            <canvas id="chart-season-evolution"></canvas>
        </div>
        
        <div class="border-t border-gray-100 pt-4">
            <h4 class="text-xs font-bold text-gray-400 uppercase mb-2 text-center">Distribuci√≥n de Goles</h4>
            <div class="relative h-48 w-full flex justify-center">
                <canvas id="chart-goals-distribution"></canvas>
            </div>
        </div>
    `;

    const players = getPlayers();

    // --- 2. GR√ÅFICO DE GOLES (DONUT) ---
    const goalsByPos = { 'delantero': 0, 'centrocampista': 0, 'defensa': 0 };
    
    filteredMatches.forEach(m => {
        if(m.playerStats) {
            m.playerStats.forEach(ps => {
                const p = players.find(pl => pl.id === ps.playerId);
                if (p && ps.goals > 0) {
                    let pos = p.posicion;
                    if (pos === 'extremo') pos = 'delantero';
                    if (pos === 'carrilero') pos = 'defensa'; // Normalizamos
                    
                    if (goalsByPos[pos] !== undefined) {
                        goalsByPos[pos] += ps.goals;
                    }
                }
            });
        }
    });

    const ctxGoals = document.getElementById('chart-goals-distribution');
    if (ctxGoals) {
        if (goalsChart) goalsChart.destroy();

        goalsChart = new Chart(ctxGoals.getContext('2d'), {
            type: 'doughnut',
            data: {
                labels: ['Delanteros', 'Medios', 'Defensas'],
                datasets: [{
                    data: [goalsByPos['delantero'], goalsByPos['centrocampista'], goalsByPos['defensa']],
                    backgroundColor: ['#ef4444', '#10b981', '#3b82f6'],
                    hoverOffset: 4,
                    borderWidth: 0
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false, // Importante para que no crezca infinito
                plugins: {
                    legend: { position: 'right', labels: { font: { size: 10 }, boxWidth: 10 } },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                const value = context.raw;
                                const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                const percentage = total > 0 ? Math.round((value / total) * 100) + '%' : '0%';
                                return ` ${value} Goles (${percentage})`;
                            }
                        }
                    }
                }
            }
        });
    }

    // --- 3. GR√ÅFICO DE EVOLUCI√ìN (L√çNEA) ---
    const sortedMatches = [...filteredMatches].sort((a, b) => new Date(a.date) - new Date(b.date));
    
    const labels = sortedMatches.map(m => {
        // Mostrar solo el nombre del rival
        return m.opponent;
    });

    const ratings = sortedMatches.map(m => {
        let total = 0, count = 0;
        if(m.playerStats) {
            m.playerStats.forEach(ps => {
                if (ps.rating) {
                    total += parseFloat(ps.rating);
                    count++;
                }
            });
        }
        return count > 0 ? (total / count).toFixed(2) : null;
    });

    const ctxEvo = document.getElementById('chart-season-evolution');
    if (ctxEvo) {
        if (evolutionChart) evolutionChart.destroy();

        evolutionChart = new Chart(ctxEvo.getContext('2d'), {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Nota Media Equipo',
                    data: ratings,
                    borderColor: '#6366f1', // Indigo m√°s bonito
                    backgroundColor: (context) => {
                        const ctx = context.chart.ctx;
                        const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                        gradient.addColorStop(0, 'rgba(99, 102, 241, 0.4)');
                        gradient.addColorStop(1, 'rgba(99, 102, 241, 0.0)');
                        return gradient;
                    },
                    tension: 0.4, // M√°s curvo y suave
                    fill: true,
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#6366f1',
                    pointRadius: 4,
                    pointHoverRadius: 6
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false, // CLAVE: Se adapta al div contenedor (h-60)
                interaction: { mode: 'index', intersect: false },
                scales: {
                    y: { 
                        min: 0, max: 10, 
                        grid: { color: '#f3f4f6' }, 
                        border: { display: false },
                        ticks: { stepSize: 1 } 
                    },
                    x: { 
                        display: true, // Mostramos eje X
                        grid: { display: false },
                        ticks: { 
                            maxTicksLimit: 5, // Evita que se amontonen las etiquetas
                            font: { size: 9 }
                        }
                    }
                },
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        backgroundColor: 'rgba(255, 255, 255, 0.95)',
                        titleColor: '#1f2937',
                        bodyColor: '#1f2937',
                        borderColor: '#e5e7eb',
                        borderWidth: 1,
                        displayColors: false,
                        callbacks: { 
                            label: (context) => `Nota Media: ${context.raw}` 
                        }
                    }
                }
            }
        });
    }
}

// --- FUNCI√ìN AUXILIAR PARA DIBUJAR LA MATRIZ ---
        // --- FUNCI√ìN AUXILIAR PARA DIBUJAR LA MATRIZ (CON NOTA MEDIA DE TEMPORADA) ---
function renderPerformanceMatrix(matches) {
    // 1. Buscar o Crear el contenedor
    let container = document.getElementById('performance-matrix-container');
    if (!container) {
        const chartsSection = document.getElementById('chart-season-evolution')?.closest('.bg-white') || document.getElementById('charts-view');
        if (chartsSection && chartsSection.parentNode) {
            container = document.createElement('div');
            container.id = 'performance-matrix-container';
            container.className = 'mt-6 bg-white p-4 rounded-xl shadow-sm border border-gray-200';
            chartsSection.parentNode.insertBefore(container, chartsSection.nextSibling);
        } else {
            return; 
        }
    }

    // 2. Agrupar partidos y CALCULAR MEDIA GLOBAL
    const matchesByComp = {};
    let globalSum = 0;
    let globalCount = 0;

    matches.forEach(m => {
        // --- C√°lculo de media para este partido ---
        let matchTotal = 0, matchPCount = 0;
        m.playerStats.forEach(ps => {
            if (ps.rating) {
                matchTotal += parseFloat(ps.rating);
                matchPCount++;
            }
        });
        
        if (matchPCount > 0) {
            const matchAvg = matchTotal / matchPCount;
            globalSum += matchAvg;
            globalCount++;
        }
        // -----------------------------------------

        let compName = m.competition;
        if (typeof COMPETICIONES_ACTUALES !== 'undefined') {
            const key = Object.keys(COMPETICIONES_ACTUALES).find(k => 
                k === m.competition || COMPETICIONES_ACTUALES[k].nombre === m.competition
            );
            if (key) compName = COMPETICIONES_ACTUALES[key].nombre; 
        }
        
        if (!matchesByComp[compName]) matchesByComp[compName] = [];
        matchesByComp[compName].push(m);
    });

    // Calcular nota final de temporada
    const seasonAvg = globalCount > 0 ? (globalSum / globalCount).toFixed(2) : '-';
    const seasonColor = getTeamRatingColor(seasonAvg);

    // 3. Generar HTML
    // He modificado el header para incluir la nota media
    let html = `
        <div class="mb-4 flex flex-wrap items-center justify-between gap-2">
            <div class="flex items-center gap-3">
                <h3 class="font-bold text-gray-700 text-sm uppercase tracking-wide">üìä Matriz de Rendimiento</h3>
                
                <div class="px-3 py-1 rounded-lg text-white font-bold text-sm shadow-sm flex items-center gap-2" 
                     style="background-color: ${seasonColor}">
                    <span>Nota Temp:</span>
                    <span class="text-lg">${seasonAvg}</span>
                </div>
            </div>

            <div class="flex gap-1 text-[10px] text-gray-400">
                <span class="px-1 rounded bg-[#dc0c00] text-white">Bad</span>
                <span class="px-1 rounded bg-[#d9af00] text-white">Avg</span>
                <span class="px-1 rounded bg-[#00c424] text-white">Good</span>
                <span class="px-1 rounded bg-[#00adc4] text-white">Top</span>
            </div>
        </div>
        <div class="space-y-3 overflow-x-auto">
    `;

    Object.keys(matchesByComp).forEach(comp => {
        const compMatches = matchesByComp[comp];
        
        html += `
            <div class="flex flex-col md:flex-row md:items-center gap-2">
                <div class="w-full md:w-32 shrink-0">
                    <span class="text-xs font-bold text-gray-600 truncate block" title="${comp}">${comp}</span>
                </div>
                <div class="flex-1 flex flex-wrap gap-1">
        `;

        compMatches.forEach(m => {
            let total = 0, count = 0;
            m.playerStats.forEach(ps => {
                if (ps.rating) {
                    total += parseFloat(ps.rating);
                    count++;
                }
            });
            
            const avgRating = count > 0 ? (total / count).toFixed(1) : '-';
            const color = getTeamRatingColor(avgRating);
            const isWin = m.outcome === 'victoria';
            const isLoss = m.outcome === 'derrota';
            const borderColor = isWin ? 'border-amber-400' : (isLoss ? 'border-red-200' : 'border-gray-200');

            html += `
                <div onclick="viewMatchDetails('${m.id}')" 
                     class="w-8 h-8 rounded flex items-center justify-center cursor-pointer transition-transform hover:scale-110 hover:z-10 border ${borderColor}"
                     style="background-color: ${color}; color: white;"
                     title="${m.date} vs ${m.opponent}\nNota Equipo: ${avgRating}\nResultado: ${m.result}">
                    <span class="text-[10px] font-bold">${avgRating}</span>
                </div>
            `;
        });

        html += `
                </div>
            </div>
        `;
    });

    html += `</div>`;
    container.innerHTML = html;
}

        // ==========================================
        // ADVANCED STATISTICS
        // ==========================================

        function renderAdvancedStats() {
            renderLineWarsChart();
            renderMinutesChart();
            renderTierList();
            const matches = getData('matches');
            const players = getPlayers();

            // 1. Home vs Away
            let homeStats = { wins: 0, draws: 0, losses: 0, gf: 0, ga: 0, count: 0 };
            let awayStats = { wins: 0, draws: 0, losses: 0, gf: 0, ga: 0, count: 0 };

            matches.forEach(m => {
                const parts = m.result.replace('*','').split('-').map(Number);
                const isHome = m.venue === 'local';
                const stats = isHome ? homeStats : awayStats;
                
                // Treat neutral as away for simplicity or ignore? Let's treat as away for now or ignore.
                if (m.venue === 'neutral') return;

                stats.count++;
                if (m.outcome === 'victoria') stats.wins++;
                else if (m.outcome === 'empate') stats.draws++;
                else stats.losses++;

                if (isHome) { stats.gf += parts[0]; stats.ga += parts[1]; }
                else { stats.gf += parts[1]; stats.ga += parts[0]; }
            });

            document.getElementById('home-away-stats-container').innerHTML = `
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 shadow-sm">
                    <h4 class="font-bold text-blue-800 mb-2">üè† En Casa</h4>
                    <div class="grid grid-cols-3 gap-2 text-center text-sm">
                        <div><p class="text-gray-500">PJ</p><p class="font-bold">${homeStats.count}</p></div>
                        <div><p class="text-gray-500">V-E-D</p><p class="font-bold">${homeStats.wins}-${homeStats.draws}-${homeStats.losses}</p></div>
                        <div><p class="text-gray-500">GF/GC</p><p class="font-bold">${homeStats.gf}/${homeStats.ga}</p></div>
                    </div>
                </div>
                <div class="bg-purple-50 p-4 rounded-xl border border-purple-100 shadow-sm">
                    <h4 class="font-bold text-purple-800 mb-2">‚úàÔ∏è Fuera de Casa</h4>
                    <div class="grid grid-cols-3 gap-2 text-center text-sm">
                        <div><p class="text-gray-500">PJ</p><p class="font-bold">${awayStats.count}</p></div>
                        <div><p class="text-gray-500">V-E-D</p><p class="font-bold">${awayStats.wins}-${awayStats.draws}-${awayStats.losses}</p></div>
                        <div><p class="text-gray-500">GF/GC</p><p class="font-bold">${awayStats.gf}/${awayStats.ga}</p></div>
                    </div>
                </div>
            `;

            // 2. Heatmap
            const zones = {
                'delantero': { total: 0, count: 0, label: 'Delantera', color: 'bg-red-500' },
                'centrocampista': { total: 0, count: 0, label: 'Medio', color: 'bg-green-500' },
                'defensa': { total: 0, count: 0, label: 'Defensa', color: 'bg-blue-500' },
                'portero': { total: 0, count: 0, label: 'Porter√≠a', color: 'bg-amber-400' }
            };

            matches.forEach(m => {
                m.playerStats.forEach(ps => {
                    const p = players.find(pl => pl.id === ps.playerId);
                    if (p && zones[p.posicion] && ps.rating) {
                        zones[p.posicion].total += parseFloat(ps.rating);
                        zones[p.posicion].count++;
                    }
                });
            });

            const getHeatColor = (avg) => {
                if (avg >= 8) return 'bg-emerald-600';
                if (avg >= 7) return 'bg-emerald-500';
                if (avg >= 6) return 'bg-yellow-500';
                return 'bg-red-500';
            };

            let heatmapHtml = '';
            // Order: Portero at bottom? No, typically pitch: Forward -> Mid -> Def -> GK
            ['delantero', 'centrocampista', 'defensa', 'portero'].forEach(pos => {
                const z = zones[pos];
                const avg = z.count > 0 ? (z.total / z.count).toFixed(2) : '-';
                const colorClass = z.count > 0 ? getHeatColor(parseFloat(avg)) : 'bg-gray-300';
                heatmapHtml += `
                    <div class="heatmap-zone ${colorClass}">
                        <span class="heatmap-val">${avg}</span>
                        <span class="heatmap-label">${z.label}</span>
                    </div>
                `;
            });
            document.getElementById('heatmap-container').innerHTML = heatmapHtml;

            // 3. Monthly Report
            const monthlyData = {};
            matches.forEach(m => {
                const date = new Date(m.date);
                const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                if (!monthlyData[key]) monthlyData[key] = { matches: [], wins: 0, draws: 0, losses: 0, gf: 0, ga: 0, totalRating: 0, ratingCount: 0 };
                
                const md = monthlyData[key];
                md.matches.push(m);
                if (m.outcome === 'victoria') md.wins++;
                else if (m.outcome === 'empate') md.draws++;
                else md.losses++;

                const parts = m.result.replace('*','').split('-').map(Number);
                if(m.venue === 'local') { md.gf += parts[0]; md.ga += parts[1]; }
                else if(m.venue === 'visitante') { md.gf += parts[1]; md.ga += parts[0]; }
                else { md.gf += parts[0]; md.ga += parts[1]; }

                m.playerStats.forEach(ps => {
                    if (ps.rating) { md.totalRating += parseFloat(ps.rating); md.ratingCount++; }
                });
            });

            const sortedMonths = Object.keys(monthlyData).sort().reverse();
            document.getElementById('monthly-report-body').innerHTML = sortedMonths.map(key => {
                const d = monthlyData[key];
                const monthName = new Date(key + '-01').toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
                const avg = d.ratingCount > 0 ? (d.totalRating / d.ratingCount).toFixed(2) : '-';
                return `
                    <tr class="border-t hover:bg-slate-50">
                        <td class="px-4 py-2 capitalize font-medium text-gray-700">${monthName}</td>
                        <td class="px-4 py-2 text-center text-gray-600">${d.matches.length}</td>
                        <td class="px-4 py-2 text-center text-gray-600 font-mono">${d.wins}-${d.draws}-${d.losses}</td>
                        <td class="px-4 py-2 text-center text-gray-600 font-mono">${d.gf} / ${d.ga}</td>
                        <td class="px-4 py-2 text-center font-bold ${getRatingColor(avg)}">${avg}</td>
                    </tr>
                `;
            }).join('');
            renderRatingHistogram();
        }

        // ==========================================
        // H2H STATISTICS
        // ==========================================

        function populateH2HOpponents() {
            const matches = getData('matches');
            const opponents = [...new Set(matches.map(m => m.opponent))].sort();
            const select = document.getElementById('h2h-opponent-select');
            select.innerHTML = '<option value="">Selecciona rival...</option>' + 
                opponents.map(op => `<option value="${op}">${op}</option>`).join('');
        }

        function renderH2H() {
            const opponent = document.getElementById('h2h-opponent-select').value;
            const container = document.getElementById('h2h-content');
            
            if (!opponent) {
                container.classList.add('hidden');
                return;
            }

            const matches = getData('matches').filter(m => m.opponent === opponent);
            const players = getPlayers();

            let wins = 0, draws = 0, losses = 0, gf = 0, ga = 0;
            const playerPerfs = {};

            matches.forEach(m => {
                if (m.outcome === 'victoria') wins++;
                else if (m.outcome === 'empate') draws++;
                else losses++;

                const parts = m.result.replace('*','').split('-').map(Number);
                if (m.venue === 'local') { gf += parts[0]; ga += parts[1]; }
                else if (m.venue === 'visitante') { gf += parts[1]; ga += parts[0]; }
                else { gf += parts[0]; ga += parts[1]; }

                m.playerStats.forEach(ps => {
                    if (!playerPerfs[ps.playerId]) playerPerfs[ps.playerId] = { goals: 0, rating: 0, count: 0, name: '' };
                    const pp = playerPerfs[ps.playerId];
                    pp.goals += ps.goals || 0;
                    if (ps.rating) { pp.rating += parseFloat(ps.rating); pp.count++; }
                });
            });

            // Find top scorer & best rating against this opponent
            let topScorer = { id: null, val: -1 };
            let bestRated = { id: null, val: -1 };

            Object.entries(playerPerfs).forEach(([pid, data]) => {
                if (data.goals > topScorer.val) topScorer = { id: pid, val: data.goals };
                const avg = data.count > 0 ? data.rating / data.count : 0;
                if (avg > bestRated.val && data.count > 0) bestRated = { id: pid, val: avg };
            });

            const scorerP = topScorer.id ? players.find(p => p.id === topScorer.id) : null;
            const ratedP = bestRated.id ? players.find(p => p.id === bestRated.id) : null;

            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-slate-800 text-white p-4 rounded-xl text-center shadow-md">
                        <p class="text-slate-400 text-sm">Balance</p>
                        <p class="text-2xl font-bold">${wins}V - ${draws}E - ${losses}D</p>
                        <p class="text-xs text-slate-400 mt-1">${gf} Goles Favor - ${ga} Contra</p>
                    </div>
                    ${scorerP ? `
                    <div class="bg-white border border-gray-200 p-4 rounded-xl flex items-center gap-3 shadow-sm">
                        <img src="${scorerP.foto}" class="w-12 h-12 rounded-full object-top">
                        <div>
                            <p class="text-xs text-gray-500 uppercase font-bold">Goleador</p>
                            <p class="font-bold text-gray-800">${scorerP.nombre}</p>
                            <p class="text-sm text-green-600 font-bold">${topScorer.val} Goles</p>
                        </div>
                    </div>` : ''}
                    ${ratedP ? `
                    <div class="bg-white border border-gray-200 p-4 rounded-xl flex items-center gap-3 shadow-sm">
                        <img src="${ratedP.foto}" class="w-12 h-12 rounded-full object-top">
                        <div>
                            <p class="text-xs text-gray-500 uppercase font-bold">Mejor Valoraci√≥n</p>
                            <p class="font-bold text-gray-800">${ratedP.nombre}</p>
                            <p class="text-sm text-blue-600 font-bold">${bestRated.val.toFixed(2)} Nota Media</p>
                        </div>
                    </div>` : ''}
                </div>
                
                <h4 class="font-bold text-gray-800 mt-4">Partidos jugados</h4>
                <div class="space-y-2">
                    ${matches.map(m => `
                        <div class="bg-gray-50 p-3 rounded-lg flex justify-between items-center text-sm border border-gray-100">
                            <span>${formatDate(m.date)} (${m.competition})</span>
                            <span class="font-bold ${getResultClass(m.outcome).replace('bg-', 'text-')}">${m.venue === 'local' ? 'Local' : 'Visitante'}: ${m.result}</span>
                        </div>
                    `).join('')}
                </div>
            `;
            container.classList.remove('hidden');
        }
        
        function exportStats() {
            const matches = getData('matches');
            const players = getPlayers();
            
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "ID,Nombre,Dorsal,Posicion,Estado,Partidos Jugados,Minutos,Goles,Asistencias,G/A,Nota Media,Tarjetas Amarillas,Tarjetas Rojas,MVPs,Victorias,Empates,Derrotas\n";

            players.forEach(player => {
                const stats = { matchesPlayed: 0, minutes: 0, goals: 0, assists: 0, totalRating: 0, ratingCount: 0, yellow: 0, red: 0, mvp: 0, wins: 0, draws: 0, losses: 0 };
                matches.forEach(m => {
                    const ps = m.playerStats?.find(s => String(s.playerId) === String(player.id));
                    if (ps) {
                        stats.matchesPlayed++;
                        stats.minutes += ps.minutes || 0;
                        stats.goals += ps.goals || 0;
                        stats.assists += ps.assists || 0;
                        stats.yellow += ps.yellowCards || 0;
                        stats.red += ps.redCards || 0;
                        // FIX: Ensure 0 is counted
                        if (ps.rating !== null && ps.rating !== "" && ps.rating !== undefined) { stats.totalRating += ps.rating; stats.ratingCount++; }
                        if (m.outcome === 'victoria') stats.wins++;
                        else if (m.outcome === 'empate') stats.draws++;
                        else if (m.outcome === 'derrota') stats.losses++;
                    }
                    if (String(m.mvp) === String(player.id)) stats.mvp++;
                });

                const avgRating = stats.ratingCount > 0 ? (stats.totalRating / stats.ratingCount).toFixed(2) : '0';
                const ga = stats.goals + stats.assists;
                const row = [player.id, `${player.nombre} ${player.apellido}`, player.dorsal, player.posicion, player.estado, stats.matchesPlayed, stats.minutes, stats.goals, stats.assists, ga, avgRating, stats.yellow, stats.red, stats.mvp, stats.wins, stats.draws, stats.losses].join(",");
                csvContent += row + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `real_madrid_${currentTeam}_stats.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        // ==========================================
        // PRINCIPAL / DASHBOARD LOGIC
        // ==========================================

        function renderPrincipal() {
            const matches = getData('matches');
            const players = getPlayers();
            const now = new Date();

            // 1. PR√ìXIMO RIVAL (Desde Calendario)
            // Filtramos eventos futuros y ordenamos por fecha
           // ... (dentro de renderPrincipal) ...

            // 1. PR√ìXIMO RIVAL
            const futureEvents = calendarEvents
                .filter(e => e.start > now)
                .sort((a, b) => a.start - b.start);
            
            const nextMatchContainer = document.getElementById('dashboard-next-match');
            const aiCard = document.getElementById('ai-prediction-card'); // Referencia a la tarjeta IA
            
            if (futureEvents.length > 0) {
                // --- HAY DATOS: MOSTRAR TODO ---
                const next = futureEvents[0];
                const dateStr = next.start.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
                const timeStr = next.start.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                const compName = next.possibleCompetition || 'Partido Oficial';
                
                nextMatchContainer.innerHTML = `
                    <div class="flex flex-col animate-in fade-in zoom-in duration-300">
                        <span class="text-2xl font-bold text-slate-800 truncate" title="${next.opponent}">${next.opponent}</span>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="text-xs font-semibold bg-amber-100 text-amber-800 px-2 py-0.5 rounded">${compName}</span>
                            <span class="text-xs text-gray-500">${next.venue === 'local' ? 'üè† Casa' : '‚úàÔ∏è Fuera'}</span>
                        </div>
                        <div class="mt-3 flex items-center gap-2 text-sm font-medium text-slate-600">
                            <span>üïí ${dateStr} - ${timeStr}</span>
                        </div>
                        <p class="text-xs text-gray-400 mt-1 truncate">üèüÔ∏è ${next.location || 'Estadio'}</p>
                    </div>
                `;
                
                // Mostrar y calcular IA ahora que tenemos datos
                renderAIPrediction(); 

            } else {
                // --- NO HAY DATOS A√öN: MOSTRAR CARGANDO ---
                // Si la lista est√° vac√≠a, asumimos que est√° cargando
                if (calendarEvents.length === 0) {
                    nextMatchContainer.innerHTML = `
                        <div class="py-4 text-center calendar-loading">
                            <div class="text-2xl mb-2">‚è≥</div>
                            <p class="text-slate-500 font-medium text-sm">Cargando calendario...</p>
                        </div>`;
                    aiCard.classList.add('hidden'); // Ocultar IA mientras carga
                } else {
                    // Si la lista NO est√° vac√≠a pero no hay futuros, es fin de temporada
                    nextMatchContainer.innerHTML = `
                        <div class="py-2">
                            <p class="text-slate-600 font-medium">No hay partidos pr√≥ximos.</p>
                            <p class="text-xs text-gray-400">Fin de temporada o par√≥n.</p>
                        </div>`;
                    aiCard.classList.add('hidden');
                }
            }

            // 2. FORMA DEL EQUIPO (L√≥gica copiada y adaptada)
            const last5Matches = [...matches].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5).reverse(); // Orden cronol√≥gico para la racha
            const formContainer = document.getElementById('dashboard-form');
            
            if (last5Matches.length > 0) {
                formContainer.innerHTML = last5Matches.map(m => {
                    let color = 'bg-gray-400';
                    let letter = 'E';
                    if (m.outcome === 'victoria') { color = 'bg-green-500'; letter = 'V'; }
                    else if (m.outcome === 'derrota') { color = 'bg-red-500'; letter = 'D'; }
                    
                    return `<div class="${color} text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm shadow-sm" title="${m.opponent} (${m.result})">${letter}</div>`;
                }).join('');
            } else {
                formContainer.innerHTML = '<span class="text-gray-400 text-sm italic">Sin partidos jugados</span>';
            }

            // 3. RESUMEN TEMPORADA
            let wins = 0, draws = 0, losses = 0, gf = 0, ga = 0;
            matches.forEach(m => {
                if (m.outcome === 'victoria') wins++;
                else if (m.outcome === 'empate') draws++;
                else losses++;
                
                if (m.result && m.result.includes('-')) {
                    const parts = m.result.replace('*','').split('-').map(Number);
                    if (m.venue === 'local') { gf += parts[0]; ga += parts[1]; }
                    else if (m.venue === 'visitante') { gf += parts[1]; ga += parts[0]; }
                    else { gf += parts[0]; ga += parts[1]; }
                }
            });
            document.getElementById('dash-wins').textContent = wins;
            document.getElementById('dash-draws').textContent = draws;
            document.getElementById('dash-losses').textContent = losses;
            document.getElementById('dash-gf').textContent = gf;
            document.getElementById('dash-ga').textContent = ga;

            // 4. √öLTIMOS 3 RESULTADOS
            const last3 = [...matches].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 3);
            const resultsContainer = document.getElementById('dashboard-last-results');
            
            if (last3.length > 0) {
                resultsContainer.innerHTML = last3.map(m => {
                    const outcomeColor = m.outcome === 'victoria' ? 'text-green-600' : (m.outcome === 'derrota' ? 'text-red-600' : 'text-amber-600');
                    return `
                    <div class="px-5 py-3 hover:bg-gray-50 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-1 h-8 rounded-full ${m.outcome === 'victoria' ? 'bg-green-500' : (m.outcome === 'derrota' ? 'bg-red-500' : 'bg-amber-500')}"></div>
                            <div>
                                <p class="font-bold text-gray-800 text-sm">${m.opponent}</p>
                                <p class="text-xs text-gray-500">${m.competition}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="font-bold text-lg ${outcomeColor}">${m.result}</span>
                            <p class="text-xs text-gray-400">${formatDate(m.date)}</p>
                        </div>
                    </div>`;
                }).join('');
            } else {
                resultsContainer.innerHTML = '<div class="p-5 text-gray-500 text-sm text-center">No hay partidos registrados a√∫n.</div>';
            }

            // 5. L√çDERES (Calculados al vuelo)
            // Estructura para contadores
            const stats = {};
            players.forEach(p => stats[p.id] = { 
                name: p.apodo || p.apellido,
                img: p.foto,
                goals: 0, 
                assists: 0, 
                mvps: 0,
                totalRating: 0,
                ratingCount: 0
            });

            matches.forEach(m => {
                if (stats[m.mvp]) stats[m.mvp].mvps++;
                m.playerStats.forEach(ps => {
                    if (stats[ps.playerId]) {
                        stats[ps.playerId].goals += (ps.goals || 0);
                        stats[ps.playerId].assists += (ps.assists || 0);
                        if (ps.rating) {
                            stats[ps.playerId].totalRating += parseFloat(ps.rating);
                            stats[ps.playerId].ratingCount++;
                        }
                    }
                });
            });

            // Encontrar m√°ximos
            let topG = { id: null, val: -1 }, topA = { id: null, val: -1 }, topM = { id: null, val: -1 }, topR = { id: null, val: -1 };

            Object.entries(stats).forEach(([id, s]) => {
                const avg = s.ratingCount > 0 ? (s.totalRating / s.ratingCount) : 0;
                
                if (s.goals > topG.val) topG = { id, val: s.goals, ...s };
                if (s.assists > topA.val) topA = { id, val: s.assists, ...s };
                if (s.mvps > topM.val) topM = { id, val: s.mvps, ...s };
                if (avg > topR.val && s.ratingCount >= 2) topR = { id, val: avg, ...s }; // M√≠nimo 2 partidos para nota media
            });

            // Renderizar L√≠deres
            const renderLeaderRow = (label, icon, data, isRating = false) => {
                if (!data.id || data.val <= 0) return '';
                const valDisplay = isRating ? data.val.toFixed(2) : data.val;
                return `
                <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg border border-gray-100">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center text-lg shadow-sm border border-gray-100">${icon}</div>
                        <div>
                            <p class="text-xs font-bold text-gray-500 uppercase">${label}</p>
                            <p class="text-sm font-bold text-slate-800">${data.name}</p>
                        </div>
                    </div>
                    <span class="text-lg font-bold text-amber-600">${valDisplay}</span>
                </div>`;
            };

            const leadersHtml = `
                ${renderLeaderRow('Goleador', '‚öΩ', topG)}
                ${renderLeaderRow('Asistente', 'üëü', topA)}
                ${renderLeaderRow('Mejor Nota', '‚≠ê', topR, true)}
                ${renderLeaderRow('M√°s MVPs', 'üèÜ', topM)}
            `;

            document.getElementById('dashboard-leaders').innerHTML = leadersHtml || '<p class="text-gray-500 text-sm text-center">Faltan datos para calcular l√≠deres.</p>';
            renderAIPrediction();
            renderTrafficLight();
        }

        // ==========================================
        // TAB NAVIGATION
        // ==========================================
        
        function showTab(tabName) {
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('tab-active'));
            
            document.getElementById(`section-${tabName}`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).classList.add('tab-active');
            if (tabName === 'principal') renderPrincipal();
            renderCompetitionStatus();
            if (calendarEvents.length === 0) loadCalendar();
            if (tabName === 'plantilla') renderPlayers();
            if (tabName === 'calendario') renderCalendar();
            if (tabName === 'nuevo') initNewMatchForm();
            if (tabName === 'partidos') renderMatches();
            if (tabName === 'stats') renderStats();
            if (tabName === 'comparador') { populateComparatorSelects(); /* updateComparatorChart se llama solo dentro de populate si hay jugadores */ }
            if (tabName === 'calendario') renderCalendar();
        }

        // ==========================================
        // PLAYERS RENDERING
        // ==========================================
        
        function filterPlayers(filter) {
            currentPlayerFilter = filter;
            document.querySelectorAll('#section-plantilla > div:first-of-type button').forEach(btn => {
                btn.classList.remove('bg-slate-800', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            document.getElementById(`filter-${filter}`).classList.remove('bg-gray-200', 'text-gray-700');
            document.getElementById(`filter-${filter}`).classList.add('bg-slate-800', 'text-white');
            renderPlayers();
        }

        function filterByPosition(position) {
            currentPositionFilter = position;
            document.querySelectorAll('.pos-filter').forEach(btn => {
                btn.classList.remove('bg-slate-800', 'text-white');
                btn.classList.add('bg-gray-200');
                if (btn.textContent.includes('Entrenador')) btn.classList.remove('bg-gray-200');
            });
            event.target.classList.remove('bg-gray-200');
            event.target.classList.add('bg-slate-800', 'text-white');
            renderPlayers();
        }
function renderPlayers() {
    let players = getPlayers();
    const matches = getData('matches'); 
    
    // --- Filtros ---
    const searchTerm = document.getElementById('player-search')?.value.toLowerCase() || '';

    if (currentPlayerFilter === 'active') {
        players = players.filter(p => p.estado === 'Activo');
    } else if (currentPlayerFilter === 'inactive') {
        players = players.filter(p => p.estado === 'Inactivo' || p.estado === 'Leyenda');
    }
    
    if (currentPositionFilter) players = players.filter(p => p.posicion === currentPositionFilter);

    if (searchTerm) {
        players = players.filter(p => 
            p.nombre.toLowerCase().includes(searchTerm) || 
            p.apellido.toLowerCase().includes(searchTerm) || 
            String(p.dorsal).includes(searchTerm) ||
            (p.apodo && p.apodo.toLowerCase().includes(searchTerm))
        );
    }
    
    // --- Ordenaci√≥n ---
    players.sort((a, b) => {
        if (a.posicion === 'entrenador') return -1;
        if (b.posicion === 'entrenador') return 1;
        return (parseInt(a.dorsal) || 999) - (parseInt(b.dorsal) || 999);
    });
    
    const container = document.getElementById('players-list');
    
    container.innerHTML = players.map((player, index) => {
        const delay = index < 20 ? index * 50 : 0; 
        const styleDelay = `style="animation-delay: ${delay}ms"`;

        let statusClass = '';
        let badgeClass = '';
        let photoBorderClass = '';
        let fireIconHTML = '';      
        let fireOverlayHTML = '';   
        let holoClass = '';         

        if (player.estado === 'Leyenda') {
            statusClass = 'status-leyenda';
            badgeClass = 'bg-amber-100 text-amber-800 border-amber-200';
            photoBorderClass = 'border-amber-400';
            holoClass = 'holo-effect'; 
        } else if (player.estado === 'Inactivo' || player.estado === 'Retirado') {
            statusClass = 'status-inactivo';
            badgeClass = 'bg-gray-100 text-gray-500 border-gray-200';
            photoBorderClass = 'border-gray-300';
        } else {
            statusClass = 'status-activo';
            badgeClass = 'status-active';
            photoBorderClass = 'border-amber-400';

            const pMatches = matches
                .filter(m => m.playerStats && m.playerStats.some(s => s.playerId === player.id && s.rating))
                .sort((a, b) => new Date(b.date) - new Date(a.date))
                .slice(0, 3);

            if (pMatches.length >= 2) {
                let sum = 0;
                pMatches.forEach(m => {
                    const s = m.playerStats.find(st => st.playerId === player.id);
                    sum += parseFloat(s.rating);
                });
                const avg = sum / pMatches.length;

                if (avg >= 9.0) {
                    holoClass = 'holo-effect'; 
                    fireOverlayHTML = `<div class="fire-overlay" style="border-color: #8b5cf6; box-shadow: inset 0 0 0 1px #8b5cf6;"></div>`;
                    fireIconHTML = `<div class="fire-badge-icon" style="background:#8b5cf6; border-color:#fff; color:white;" title="TIER S: ${avg.toFixed(1)}">üíé</div>`;
                } 
                else if (avg >= 8.0) {
                    statusClass += ' status-on-fire'; 
                    fireOverlayHTML = `<div class="fire-overlay"></div>`;
                    fireIconHTML = `<div class="fire-badge-icon" title="Racha: ${avg.toFixed(1)}">üî•</div>`;
                }
                else if (avg < 6.0) {
                    statusClass += ' status-frozen'; 
                    fireOverlayHTML = `<div class="frozen-overlay"></div>`;
                    fireIconHTML = `<div class="fire-badge-icon" style="background:#eff6ff; border-color:#93c5fd; color:#2563eb;" title="Mala Racha: ${avg.toFixed(1)}">‚ùÑÔ∏è</div>`;
                }
            }
        }

        return `
            <div class="card player-card bg-white rounded-xl shadow-sm p-4 ${statusClass} ${holoClass} card-animate-enter cursor-pointer relative transition-transform hover:-translate-y-1" 
                 ${styleDelay} 
                 onclick="viewPlayerDetails('${player.id}')">
                
                ${fireOverlayHTML}
                ${fireIconHTML}

                <div class="flex items-start gap-4 relative z-10">
                    <img src="${player.foto}" 
                         class="player-photo border-4 ${photoBorderClass} rounded-full w-20 h-20 object-cover object-top" 
                         onerror="this.src='https://via.placeholder.com/80x80?text=${player.dorsal}'"
                         alt="${player.nombre}">
                         
                    <div class="flex-1 min-w-0">
                        <div class="flex items-center gap-2 mb-1">
                            <span class="text-2xl font-bold text-slate-700">${player.dorsal === "DT" ? "DT" : "#" + player.dorsal}</span>
                        </div>
                        
                        <h3 class="font-semibold text-gray-800 truncate text-lg leading-tight">${player.nombre} ${player.apellido}</h3>
                        
                        <div class="flex flex-wrap gap-1 mt-2">
                            <span class="position-badge pos-${player.posicion}">${capitalizeFirst(player.posicion)}</span>
                            
                            <button onclick="event.stopPropagation(); openPlayerStatusModal('${player.id}')" 
                                    class="text-[10px] font-bold uppercase px-2 py-0.5 rounded border ${badgeClass} hover:opacity-80 transition">
                                ${player.estado} ‚úèÔ∏è
                            </button>
                        </div>
                        
                        <div class="mt-2 text-sm text-gray-500 flex flex-col gap-0.5">
                            <p class="flex items-center gap-1">üéÇ ${calculateAge(player.fechaNacimiento)} a√±os</p>
                            <p class="flex items-center gap-1">üåç ${player.nacionalidad}</p>
                        </div>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}

// ==========================================
// FUNCI√ìN PRINCIPAL: VER FICHA JUGADOR (CON DATOS POR COMPETICI√ìN)
// ==========================================

let currentPlayerDetailsId = null;

// =========================================================
// 1. FUNCI√ìN PRINCIPAL (Recopila datos y calcula MINUTOS por comp)
// =========================================================
function viewPlayerDetails(playerId) {
    const players = getPlayers();
    const player = players.find(p => p.id === playerId);
    if (!player) return;

    currentPlayerDetailsId = playerId;

    const modal = document.getElementById('player-details-modal');
    const headerContainer = document.getElementById('player-modal-header-container');
    const contentContainer = document.getElementById('player-details-content');

    if (!modal || !headerContainer || !contentContainer) return;

    // --- PROCESAMIENTO DE DATOS ---
    const matches = getData('matches');
    const playerMatches = [];
    
    const stats = { matchesPlayed: 0, goals: 0, assists: 0, minutes: 0, totalRating: 0, ratingCount: 0, wins: 0, starts: 0 };
    const ratingsHistory = [];
    const statsByComp = {}; 

    matches.forEach(m => {
        const ps = m.playerStats ? m.playerStats.find(s => String(s.playerId) === String(playerId)) : null;
        
        if (ps && (ps.played || ps.minutes > 0)) {
            playerMatches.push({ ...m, ...ps });

            const isStarter = (ps.isStarter === true || ps.isStarter === 'true' || m.isStarter === true || m.isStarter === 'true');
            
            // Totales
            stats.matchesPlayed++;
            stats.goals += (Number(ps.goals) || 0);
            stats.assists += (Number(ps.assists) || 0);
            stats.minutes += (Number(ps.minutes) || 0);
            if (isStarter) stats.starts++;
            
            if (ps.rating) {
                const r = parseFloat(ps.rating);
                if (!isNaN(r)) {
                    stats.totalRating += r;
                    stats.ratingCount++;
                    ratingsHistory.push({ rating: r, opponent: m.opponent });
                }
            }
            if (m.outcome === 'victoria') stats.wins++;

            // Por Competici√≥n
            const compName = m.competition || "Otras"; 
            if (!statsByComp[compName]) {
                statsByComp[compName] = { pj: 0, g: 0, a: 0, min: 0, pi: 0, ta: 0, tr: 0, sumRating: 0, countRating: 0 };
            }
            const c = statsByComp[compName];
            c.pj++;
            c.g += (Number(ps.goals) || 0);
            c.a += (Number(ps.assists) || 0);
            c.min += (Number(ps.minutes) || 0);
            c.ta += (Number(ps.yellowCards) || 0);
            c.tr += (Number(ps.redCards) || 0);
            if (isStarter) c.pi++;
            if (ps.rating && !isNaN(parseFloat(ps.rating))) {
                c.sumRating += parseFloat(ps.rating);
                c.countRating++;
            }
        }
    });

    playerMatches.sort((a, b) => new Date(b.date) - new Date(a.date));
    const avgRating = stats.ratingCount > 0 ? (stats.totalRating / stats.ratingCount).toFixed(2) : '-';
    const safeAge = (d) => typeof calculateAge === 'function' ? calculateAge(d) : '';

    // --- RENDER HEADER (MODIFICADO CON PIE) ---
    headerContainer.innerHTML = `
        <div class="px-6 pt-6 pb-2">
            <div class="flex justify-between items-start">
                <div class="flex items-center gap-5">
                    <div class="relative">
                        <img src="${player.foto}" class="w-20 h-20 rounded-full border-4 ${player.estado === 'Activo' ? 'border-amber-400' : 'border-gray-200'} object-cover shadow-md" onerror="this.src='https://via.placeholder.com/150'">
                        <div class="absolute -bottom-2 -right-2 bg-slate-800 text-white text-xs font-bold px-2 py-0.5 rounded-full border-2 border-white">
                            ${player.dorsal === 'DT' ? 'DT' : '#' + player.dorsal}
                        </div>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold text-slate-800 leading-tight">${player.nombre} ${player.apellido}</h2>
                        <div class="flex items-center flex-wrap gap-2 mt-1 text-sm text-gray-500">
                            <span class="bg-gray-100 px-2 py-0.5 rounded text-xs font-bold uppercase tracking-wider text-gray-600">${player.posicion}</span>
                            <span>‚Ä¢</span>
                            <span>${player.nacionalidad || '-'}</span>
                            <span>‚Ä¢</span>
                            <span>${safeAge(player.fechaNacimiento)} a√±os</span>
                            
                            ${player.piePreferido ? `
                                <span>‚Ä¢</span>
                                <span class="text-gray-600 font-medium">Pie: ${player.piePreferido}</span>
                            ` : ''}

                             <button onclick="openPlayerStatusModal('${player.id}')" class="ml-2 text-xs bg-slate-100 hover:bg-slate-200 px-2 py-1 rounded border transition-colors">
                                ${player.estado === 'Activo' ? '‚úÖ' : '‚ùå'}
                            </button>
                        </div>
                    </div>
                </div>
                <button onclick="closePlayerDetailsModal()" class="p-2 bg-gray-100 hover:bg-gray-200 rounded-full text-gray-500 transition-colors">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/></svg>
                </button>
            </div>

            <div class="flex gap-6 mt-6 border-b border-gray-200">
                <button onclick="switchPlayerTab('visual')" id="tab-btn-visual" class="pb-3 text-sm font-bold border-b-2 border-indigo-600 text-indigo-600 transition-colors flex items-center gap-2">
                    <span>üî•</span> Resumen
                </button>
                <button onclick="switchPlayerTab('history')" id="tab-btn-history" class="pb-3 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-gray-600 transition-colors flex items-center gap-2">
                    <span>üìã</span> Historial
                </button>
                <button onclick="switchPlayerTab('fut')" id="tab-btn-fut" class="pb-3 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-gray-600 transition-colors flex items-center gap-2">
                    <span>üé¥</span> Carta FUT
                </button>
            </div>
        </div>
    `;

    const visualHTML = renderVisualTab(player, stats, avgRating, playerMatches, ratingsHistory, statsByComp);
    const historyHTML = typeof renderHistoryTab === 'function' ? renderHistoryTab(player, playerMatches) : '';

    contentContainer.innerHTML = `
        <div id="tab-content-visual" class="animate-fade-in block space-y-6">${visualHTML}</div>
        <div id="tab-content-history" class="animate-fade-in hidden">${historyHTML}</div>
        <div id="tab-content-fut" class="animate-fade-in hidden flex justify-center py-10"></div>
    `;

    renderFutTab(player, stats, avgRating);

    modal.classList.remove('hidden');
    modal.classList.add('flex');
    modal.classList.add('active');
    
    setTimeout(() => { 
        modal.classList.remove('opacity-0'); 
        runCounters(); 
    }, 50);
}

// =========================================================
// 2. FUNCI√ìN VISUAL (LA QUE PINTA LA TABLA)
// =========================================================
function renderVisualTab(player, stats, avgRating, matches, ratingsHistory, statsByComp) {
    const isCoach = player.posicion === 'entrenador';
    
    // --- 1. TARJETAS DE RESUMEN ---
    const colorRating = typeof getRatingColor === 'function' ? getRatingColor(avgRating) : 'text-gray-800';
    
    // He vuelto a poner grid-cols-4 para que quede sim√©trico sin la tarjeta del pie
    const summaryCardsHTML = `
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center">
                <span class="text-3xl font-black text-slate-800 counter-anim" data-target="${stats.matchesPlayed}">0</span>
                <span class="text-xs font-bold text-gray-400 uppercase tracking-wider mt-1">Partidos</span>
            </div>
            <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center">
                <span class="text-3xl font-black ${colorRating} counter-anim" data-target="${avgRating !== '-' ? avgRating : 0}" data-float="true">0.00</span>
                <span class="text-xs font-bold text-gray-400 uppercase tracking-wider mt-1">Nota Media</span>
            </div>
            ${!isCoach ? `
            <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center">
                <span class="text-3xl font-black text-emerald-600 counter-anim" data-target="${stats.goals}">0</span>
                <span class="text-xs font-bold text-gray-400 uppercase tracking-wider mt-1">Goles</span>
            </div>
            <div class="bg-white p-5 rounded-xl shadow-sm border border-gray-100 flex flex-col items-center justify-center">
                <span class="text-3xl font-black text-blue-600 counter-anim" data-target="${stats.assists}">0</span>
                <span class="text-xs font-bold text-gray-400 uppercase tracking-wider mt-1">Asistencias</span>
            </div>
            ` : ''}
        </div>`;

    // --- 2. TABLA DARK (MANTENIDA) ---
    const compData = statsByComp || {};
    let tableDarkHTML = '';

    if (Object.keys(compData).length > 0) {
        let tPJ=0, tG=0, tA=0, tMIN=0, tTIT=0, tTA=0, tTR=0, sMed=0, cMed=0;

        const rows = Object.entries(compData).map(([compName, d]) => {
            tPJ += d.pj; tG += d.g; tA += d.a; tMIN += (d.min || 0); tTIT += (d.pi || d.tit || 0);
            tTA += d.ta; tTR += d.tr; sMed += d.sumRating; cMed += d.countRating;
            const med = d.countRating > 0 ? (d.sumRating / d.countRating).toFixed(2) : '-';

            return `
            <tr class="border-b border-gray-700/50 hover:bg-white/5 transition-colors text-sm">
                <td class="py-3 text-left pl-4 text-white font-medium truncate">${compName}</td>
                <td class="py-3 text-center text-gray-300">${d.pj}</td>
                <td class="py-3 text-center text-green-400 font-bold">${d.g}</td>
                <td class="py-3 text-center text-blue-300 font-bold">${d.a}</td>
                <td class="py-3 text-center text-gray-400 text-xs">${d.min}'</td>
                <td class="py-3 text-center text-gray-300">${d.pi || 0}</td>
                <td class="py-3 text-center text-yellow-400 font-bold">${d.ta}</td>
                <td class="py-3 text-center text-red-500 font-bold">${d.tr}</td>
                <td class="py-3 text-center font-bold text-white">${med}</td>
            </tr>`;
        }).join('');

        const totalMedia = cMed > 0 ? (sMed / cMed).toFixed(2) : '-';

        tableDarkHTML = `
        <div class="w-full bg-[#120f28] text-gray-300 rounded-xl overflow-hidden shadow-lg font-sans mb-6">
            <div class="overflow-x-auto">
                <table class="w-full border-collapse min-w-[600px]">
                    <thead>
                        <tr class="text-[11px] md:text-xs uppercase tracking-wider text-gray-400 border-b border-gray-700/50 bg-[#1a1635]">
                            <th class="py-3 text-left pl-4 font-semibold w-1/3">Competici√≥n</th>
                            <th class="py-3 text-center font-semibold">PJ</th>
                            <th class="py-3 text-center font-semibold">G</th>
                            <th class="py-3 text-center font-semibold">A</th>
                            <th class="py-3 text-center font-semibold">MIN</th>
                            <th class="py-3 text-center font-semibold" title="Titularidades">TIT</th>
                            <th class="py-3 text-center font-semibold text-base" title="Amarillas">üü®</th>
                            <th class="py-3 text-center font-semibold text-base" title="Rojas">üü•</th>
                            <th class="py-3 text-center font-semibold">MED</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                    <tfoot>
                        <tr class="text-sm font-bold text-white bg-[#1a1635] border-t border-gray-600">
                            <td class="py-3 text-left pl-4 opacity-90">Totales</td>
                            <td class="py-3 text-center">${tPJ}</td>
                            <td class="py-3 text-center">${tG}</td>
                            <td class="py-3 text-center">${tA}</td>
                            <td class="py-3 text-center text-xs text-gray-400">${tMIN}'</td>
                            <td class="py-3 text-center">${tTIT}</td>
                            <td class="py-3 text-center text-yellow-500">${tTA}</td>
                            <td class="py-3 text-center text-red-500">${tTR}</td>
                            <td class="py-3 text-center text-blue-300">${totalMedia}</td>
                        </tr>
                    </tfoot>
                </table>
            </div>
        </div>`;
    }

    // --- 3. GR√ÅFICO (MANTENIDO) ---
    const chartData = [...ratingsHistory].reverse().slice(-10);
    let chartHTML = '';
    if(chartData.length > 0) {
        chartHTML = `<div class="bg-white p-4 rounded-xl shadow-sm border border-gray-100 h-32 flex items-end justify-between gap-1 mt-4">` +
        chartData.map((d, i) => {
             const color = d.rating >= 8 ? 'bg-emerald-400' : (d.rating >= 6 ? 'bg-blue-400' : 'bg-red-400');
             const delay = i * 100; 
             return `<div class="${color} w-full rounded-t relative group animate-bar-up" style="height:${Math.min(d.rating*10, 100)}%; animation-delay:${delay}ms">
                <div class="absolute -top-6 left-1/2 -translate-x-1/2 bg-gray-800 text-white text-[9px] px-1 rounded opacity-0 group-hover:opacity-100 transition-opacity whitespace-nowrap">${d.rating}</div>
             </div>`;
        }).join('') +
        `</div>`;
    }

    // --- 4. TOP ACTUACIONES (MANTENIDO) ---
    let topPerfHTML = '';
    if (!isCoach) {
        let topPerformances = [...matches]
        .filter(m => m.rating).map(m => ({...m, rating: parseFloat(m.rating)}))
        .sort((a,b) => b.rating - a.rating).slice(0,5);

        if(topPerformances.length > 0) {
            topPerfHTML = `<div class="mt-6"><h3 class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-3">üíé Top 5 Actuaciones</h3><div class="grid grid-cols-5 gap-2">` + 
            topPerformances.map(m => `
                <div class="bg-white border border-gray-100 p-2 rounded shadow-sm text-center overflow-hidden">
                    <div class="text-[10px] text-gray-400 truncate">vs ${m.opponent}</div>
                    <div class="font-black text-lg text-slate-800">${m.rating}</div>
                </div>`).join('') + 
            `</div></div>`;
        }
    }
    
    setTimeout(runCounters, 50);

    return `${summaryCardsHTML}${tableDarkHTML}${chartHTML}${topPerfHTML}`;
}

function renderPlayerHistoryTab(player, matches) {
    const isCoach = player.posicion === 'entrenador';
    
    if (matches.length === 0) {
        return `<div class="text-center py-10 text-gray-400 italic">No hay partidos registrados.</div>`;
    }

    return `
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-50 text-gray-500 font-bold uppercase text-xs">
                        <tr>
                            <th class="px-4 py-3">Fecha / Rival</th>
                            <th class="px-4 py-3 text-center">Rol</th>
                            <th class="px-4 py-3 text-center">Nota</th>
                            <th class="px-4 py-3 text-center text-emerald-600">G</th>
                            <th class="px-4 py-3 text-center text-blue-600">A</th>
                            <th class="px-4 py-3 text-center">Min</th>
                            <th class="px-4 py-3 text-center">T</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        ${matches.map(m => `
                            <tr class="hover:bg-slate-50 transition-colors">
                                <td class="px-4 py-3">
                                    <div class="font-bold text-slate-700">${m.opponent}</div>
                                    <div class="text-xs text-gray-400">${formatDate(m.date)}</div>
                                </td>
                                <td class="px-4 py-3 text-center">
                                    ${(m.isStarter === true || m.isStarter === 'true') 
                                        ? '<span class="bg-green-100 text-green-700 px-2 py-0.5 rounded-full text-[10px] font-bold uppercase">Titular</span>' 
                                        : '<span class="bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full text-[10px] font-bold uppercase">Suplente</span>'}
                                </td>
                                <td class="px-4 py-3 text-center font-bold text-base ${typeof getRatingColor === 'function' ? getRatingColor(m.rating) : ''}">
                                    ${m.rating || '-'}
                                </td>
                                <td class="px-4 py-3 text-center font-medium ${m.goals > 0 ? 'text-emerald-600 font-bold' : 'text-gray-300'}">
                                    ${isCoach ? '-' : (m.goals || '-')}
                                </td>
                                <td class="px-4 py-3 text-center font-medium ${m.assists > 0 ? 'text-blue-600 font-bold' : 'text-gray-300'}">
                                    ${isCoach ? '-' : (m.assists || '-')}
                                </td>
                                <td class="px-4 py-3 text-center text-gray-500">
                                    ${isCoach ? '-' : (m.minutes || 0)}'
                                </td>
                                <td class="px-4 py-3 text-center">
                                     ${m.redCards > 0 ? 'üü•' : (m.yellowCards > 0 ? 'üü®' : '')}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}

        // ==========================================
        // CALENDAR FIXTURE SELECTION & DISPLAY
        // ==========================================
        
        function selectCalendarFixture(fixtureId) {
            const fixture = calendarEvents.find(e => e.id === fixtureId);
            if (!fixture) return;

            const matches = getData('matches');
            const isRegistered = matches.some(m => m.calendarEventId === fixtureId);
            if (isRegistered) {
                alert('‚ö†Ô∏è Este partido ya ha sido registrado.');
                return;
            }
            
            // Precise Date Validation
            const now = new Date();
            if (fixture.start > now) {
                alert('‚ö†Ô∏è No puedes registrar un partido antes de que comience.');
                return;
            }
            
            selectedCalendarFixture = fixture;
            
            // Switch tab and Show Form
            showTab('nuevo');
            document.getElementById('select-match-prompt').classList.add('hidden');
            document.getElementById('new-match-form-container').classList.remove('hidden');
            
            // Show Step 1, Hide Step 2
            document.getElementById('wizard-step-1').classList.remove('hidden');
            document.getElementById('wizard-step-2').classList.add('hidden');
            
            populateFormFromFixture(fixture);
        }

        function populateFormFromFixture(fixture) {
            document.getElementById('selected-fixture-info').classList.remove('hidden');
            
            const compLabel = fixture.competition ? ` - ${fixture.competition}` : '';
            document.getElementById('selected-fixture-details').textContent = 
                `${fixture.opponent}${compLabel} - ${fixture.start.toLocaleDateString('es-ES')} - ${fixture.location || 'Estadio'}`;
            
            // ‚úÖ BLOQUEO DE FECHA A√ëADIDO
            const dateInput = document.getElementById('new-date');
            dateInput.value = fixture.start.toISOString().split('T')[0];
            dateInput.readOnly = true;
            dateInput.classList.add('bg-gray-100', 'cursor-not-allowed');

            document.getElementById('new-opponent').value = fixture.opponent || '';
            document.getElementById('calendar-event-id').value = fixture.id;

            // --- L√ìGICA ROBUSTA PARA EL SELECTOR ---
            const compSelect = document.getElementById('new-competition');
            let foundCompKey = null;

            if (fixture.competition) {
                foundCompKey = Object.keys(COMPETICIONES_ACTUALES).find(k => 
                    k.toLowerCase().trim() === fixture.competition.toLowerCase().trim()
                );
            }

            if (foundCompKey) {
                compSelect.value = foundCompKey;
                compSelect.disabled = true; 
                compSelect.classList.add('readonly-input', 'bg-gray-100', 'text-gray-600'); 
                updateRoundOptions();
            } else {
                compSelect.value = "";
                compSelect.disabled = false;
                compSelect.classList.remove('readonly-input', 'bg-gray-100', 'text-gray-600');
            }

            const venueSelect = document.getElementById('new-venue');
            venueSelect.value = fixture.venue || '';
            if (fixture.venue) {
                venueSelect.classList.add('readonly-input');
                venueSelect.disabled = true; 
            }
            updateStadiumField();
            
            const stadiumInput = document.getElementById('new-stadium');
            if (fixture.location) {
                stadiumInput.value = fixture.location;
                stadiumInput.readOnly = true;
                stadiumInput.classList.add('readonly-input');
            }
        }

        function clearSelectedFixture() {
            selectedCalendarFixture = null;
            resetNewMatchForm();
        }

        // ==========================================
        // NEW MATCH FORM & WIZARD
        // ==========================================
        
        function initNewMatchForm() {
            populateCompetitionSelect();
            // renderPlayerStatsForm is called when entering Step 2
            
            if (!selectedCalendarFixture) {
                document.getElementById('select-match-prompt').classList.remove('hidden');
                document.getElementById('new-match-form-container').classList.add('hidden');
            } else {
                document.getElementById('select-match-prompt').classList.add('hidden');
                document.getElementById('new-match-form-container').classList.remove('hidden');
                document.getElementById('wizard-step-1').classList.remove('hidden');
                document.getElementById('wizard-step-2').classList.add('hidden');
            }
        }
        
function goToStep2() {
    // Validate Step 1
    const comp = document.getElementById('new-competition').value;
    const round = document.getElementById('new-round').value;
    const result = document.getElementById('new-result').value;
    
    if (!comp || !round || !result) {
        alert("Por favor, completa todos los campos obligatorios del Paso 1.");
        return;
    }
    if (!/^\d+-\d+$/.test(result)) {
        alert("El formato del resultado debe ser goles_local-goles_visitante (ej: 2-1)");
        return;
    }

    // Render players with suspension logic
    renderPlayerStatsForm('new-match-players-stats', comp);

    document.getElementById('wizard-step-1').classList.add('hidden');
    document.getElementById('wizard-step-2').classList.remove('hidden');
    document.getElementById('wizard-step-3').classList.add('hidden');

    currentPitchPlayers = {}; // Reseteamos alineaci√≥n
    currentSubstitutes = [];
    editingMatchPlayersPool = null;
    
    // --- CAMBIO CLAVE: Usamos comillas vac√≠as '' para usar los IDs originales ---
    renderBench('');
    updatePitchFormation(''); 
}

        function goToStep1() {
            document.getElementById('wizard-step-2').classList.add('hidden');
            document.getElementById('wizard-step-1').classList.remove('hidden');
        }

       function renderCompetitionStatus() {
            const container = document.getElementById('competition-status');
            const state = getCompetitionState();
            
            container.innerHTML = Object.entries(COMPETICIONES_ACTUALES).map(([name, comp]) => {
                const isEliminated = state[name]?.eliminated;
                const eliminatedAtId = state[name]?.eliminatedAt;
                
                // L√≥gica para encontrar el nombre exacto de la ronda de eliminaci√≥n
                let eliminatedText = 'ELIMINADO DE LA COMPETICI√ìN';
                if (isEliminated && eliminatedAtId) {
                    comp.fases.forEach(fase => {
                        const r = fase.rondas.find(round => round.id === eliminatedAtId);
                        if (r) eliminatedText = `Eliminado en ${r.nombre}`;
                    });
                }

                const availableRounds = getAvailableRounds(name);
                const nextRound = availableRounds.find(r => r.status === 'available');
                const matches = getData('matches').filter(m => m.competition === name);
                
                return `
                    <div class="bg-white rounded-xl shadow-sm p-4 ${isEliminated ? 'opacity-60' : ''}">
                        <div class="flex items-center gap-3 mb-3">
                            <span class="${comp.color} px-3 py-1 rounded-full text-sm font-medium ${isEliminated ? 'comp-eliminated' : ''}">${name}</span>
                            ${isEliminated ? '<span class="text-red-500 text-sm">‚ùå Eliminados</span>' : ''}
                        </div>
                        <div class="text-sm text-gray-600">
                            <p>üìä Partidos jugados: <strong>${matches.length}</strong></p>
                            ${nextRound ? `<p>‚û°Ô∏è Disponible: <strong>${nextRound.nombre}</strong></p>` : 
                              (isEliminated ? `<p class="text-red-600 font-bold">‚õî ${eliminatedText}</p>` : '<p class="text-green-500">‚úÖ Competici√≥n completada</p>')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function populateCompetitionSelect() {
            const select = document.getElementById('new-competition');
            const state = getCompetitionState();
            
            select.innerHTML = '<option value="">Seleccionar competici√≥n...</option>' +
                Object.entries(COMPETICIONES_ACTUALES)
                    .map(([name, comp]) => {
                        const eliminated = state[name]?.eliminated;
                        const label = eliminated ? `${name} (Eliminado)` : name;
                        const disabled = eliminated ? 'disabled' : '';
                        return `<option value="${name}" ${disabled} class="${eliminated ? 'text-red-500' : ''}">${label}</option>`;
                    })
                    .join('');
            
            const filterSelect = document.getElementById('filter-competition');
            const statsFilterSelect = document.getElementById('stats-filter-competition');
            const compOptions = '<option value="">Todas las competiciones</option>' + Object.keys(COMPETICIONES_ACTUALES).map(name => `<option value="${name}">${name}</option>`).join('');
            
            filterSelect.innerHTML = compOptions;
            statsFilterSelect.innerHTML = compOptions;
            
             const calFilterContainer = document.getElementById('calendar-filters-container');
             calFilterContainer.innerHTML = '<button onclick="filterCalendar(\'\')" class="cal-filter px-3 py-1 text-sm rounded-full bg-slate-800 text-white">Todas</button>';
             Object.values(COMPETICIONES_ACTUALES).forEach(comp => {
                 calFilterContainer.innerHTML += `<button onclick="filterCalendar('${comp.id}')" class="cal-filter px-3 py-1 text-sm rounded-full ${comp.color}">${comp.nombre}</button>`;
             });
        }
        
        function updateRoundOptions() {
            const compName = document.getElementById('new-competition').value;
            const roundSelect = document.getElementById('new-round');
            const roundInfo = document.getElementById('round-info');
            const venueSelect = document.getElementById('new-venue');
            
            if (!compName) {
                roundSelect.innerHTML = '<option value="">Primero selecciona competici√≥n...</option>';
                roundInfo.textContent = '';
                return;
            }
            
            const comp = COMPETICIONES_ACTUALES[compName];
            const availableRounds = getAvailableRounds(compName);
            
            if (availableRounds.length === 0) {
                roundSelect.innerHTML = '<option value="">No hay rondas disponibles</option>';
                roundInfo.textContent = 'Esta competici√≥n est√° completada o eliminada.';
                return;
            }
            
            roundSelect.innerHTML = '<option value="">Seleccionar ronda...</option>' +
                availableRounds.map(r => {
                    const statusIcon = r.status === 'completed' ? '‚úÖ' : (r.status === 'available' ? 'üü¢' : 'üîí');
                    const disabled = r.status !== 'available' ? 'disabled' : '';
                    return `<option value="${r.id}" ${disabled} data-orden="${r.orden}">${statusIcon} ${r.nombre}</option>`;
                }).join('');
            
            if (comp.campoNeutral) {
                venueSelect.value = 'neutral';
                updateStadiumField();
                venueSelect.disabled = true;
                roundInfo.textContent = '‚ö†Ô∏è Esta competici√≥n se juega en campo neutral.';
            } else {
                roundInfo.textContent = comp.ordenLibre || comp.tipo === 'liga' ? 
                    'üìã Liga: puedes registrar jornadas en cualquier orden.' :
                    'üü¢ = Disponible, üîí = Ronda anterior pendiente, ‚úÖ = Completada';
            }
            updateOvertimeOptions();
        }

        // Logic for Extra Time and Penalties Controls
        function updateOvertimeOptions() {
            const compName = document.getElementById('new-competition').value;
            const roundId = document.getElementById('new-round').value;
            const result = document.getElementById('new-result').value;
            const container = document.getElementById('overtime-controls');
            const etOption = document.getElementById('extra-time-option');
            const penOption = document.getElementById('penalties-option');
            
            if (!compName || !roundId || !result || !/^\d+-\d+$/.test(result)) {
                container.classList.add('hidden');
                return;
            }

            const comp = COMPETICIONES_ACTUALES[compName];
            let roundInfo = null;
            comp.fases.forEach(fase => {
                const found = fase.rondas.find(r => r.id === roundId);
                if (found) roundInfo = { ...found, faseTipo: fase.tipo };
            });

            if (!roundInfo || !roundInfo.eliminatoria || roundInfo.faseTipo === 'liga') {
                container.classList.add('hidden');
                return;
            }

            let showET = false;
            let showPen = false;
            const currentResultParts = result.split('-').map(Number);
            const currentUs = currentResultParts[0]; // Assuming local input perspective roughly
            const currentThem = currentResultParts[1];

            // 1. Return Leg Logic
            if (roundInfo.idaVuelta === 'vuelta') {
                const matches = getData('matches').filter(m => m.competition === compName);
                const idaMatch = matches.find(m => m.roundId === roundInfo.pareja);

                if (idaMatch) {
                    // Calculate Global
                    // This is complex because we don't know venue yet perfectly from inputs, 
                    // but we can infer from `new-venue` which is likely disabled/set by `handleRoundChange`.
                    // Assume inputs are set correctly.
                    const venue = document.getElementById('new-venue').value;
                    const mockMatch = { result: result, venue: venue };
                    const globalRes = calculateGlobalResult(idaMatch, mockMatch);
                    
                    if (globalRes.outcome === 'empate') {
                         showET = true;
                         showPen = true;
                    }
                }
            }
            // 2. Single Leg Logic
            else if (roundInfo.partidoUnico) {
                if (currentUs === currentThem) {
                    showPen = true;
                }
            }

            if (showET || showPen) {
                container.classList.remove('hidden');
                if (showET) etOption.classList.remove('hidden');
                else etOption.classList.add('hidden');
                
                if (showPen) penOption.classList.remove('hidden');
                else penOption.classList.add('hidden');
            } else {
                container.classList.add('hidden');
            }
        }
        
        function togglePenaltyWinner() {
            const chk = document.getElementById('chk-penalties');
            const winnerSelect = document.getElementById('penalty-winner-select');
            if (chk.checked) winnerSelect.classList.remove('hidden');
            else winnerSelect.classList.add('hidden');
        }
        
        function handleRoundChange() {
            const compName = document.getElementById('new-competition').value;
            const roundId = document.getElementById('new-round').value;
            
            if (!compName || !roundId) return;
            
            const comp = COMPETICIONES_ACTUALES[compName];
            let roundInfo = null;
            
            comp.fases.forEach(fase => {
                const found = fase.rondas.find(r => r.id === roundId);
                if (found) roundInfo = { ...found, faseTipo: fase.tipo };
            });
            
            if (!roundInfo) return;
            
            // Handle two-leg ties
            if (roundInfo.idaVuelta === 'vuelta') {
                const matches = getData('matches').filter(m => m.competition === compName);
                const idaMatch = matches.find(m => m.roundId === roundInfo.pareja);
                
                if (idaMatch) {
                    const legIndicator = document.getElementById('leg-indicator');
                    const legInfo = document.getElementById('leg-info');
                    legIndicator.classList.remove('hidden');
                    legInfo.innerHTML = `<strong>üìä Partido de ida:</strong> vs ${idaMatch.opponent} - Resultado: ${idaMatch.result} (${idaMatch.venue === 'local' ? 'Local' : 'Visitante'})`;
                    
                    document.getElementById('new-opponent').value = idaMatch.opponent;
                    
                    const venueSelect = document.getElementById('new-venue');
                    const alternateVenue = idaMatch.venue === 'local' ? 'visitante' : 'local';
                    venueSelect.value = alternateVenue;
                    venueSelect.disabled = true;
                    
                    const venueWarning = document.getElementById('venue-alternation-warning');
                    const venueInfo = document.getElementById('venue-alternation-info');
                    venueWarning.classList.remove('hidden');
                    venueInfo.innerHTML = `<strong>üîÑ Alternancia autom√°tica:</strong> La ida fue ${idaMatch.venue === 'local' ? 'en casa' : 'fuera'}, la vuelta debe ser ${alternateVenue === 'local' ? 'en casa' : 'fuera'}.`;
                    
                    updateStadiumField();
                }
            } else {
                document.getElementById('leg-indicator').classList.add('hidden');
                document.getElementById('venue-alternation-warning').classList.add('hidden');
            }
            updateOvertimeOptions();
        }
        
        function updateStadiumField() {
            const venue = document.getElementById('new-venue').value;
            const stadiumInput = document.getElementById('new-stadium');
            const compName = document.getElementById('new-competition').value;
            const comp = COMPETICIONES_ACTUALES[compName];
            
            if (venue === 'local') {
                stadiumInput.value = 'Santiago Bernab√©u';
                stadiumInput.readOnly = true;
                stadiumInput.classList.add('bg-gray-100');
            } else if (venue === 'neutral' && comp?.campoNeutral) {
                if (!selectedCalendarFixture?.location) stadiumInput.value = '';
                else stadiumInput.value = selectedCalendarFixture.location;
                
                stadiumInput.readOnly = false;
                stadiumInput.classList.remove('bg-gray-100');
                stadiumInput.placeholder = 'Estadio del partido (campo neutral)';
            } else {
                if (!selectedCalendarFixture?.location) stadiumInput.value = '';
                else stadiumInput.value = selectedCalendarFixture.location;
                
                stadiumInput.readOnly = false;
                stadiumInput.classList.remove('bg-gray-100');
                stadiumInput.placeholder = 'Estadio del rival';
            }
        }

// A√ëADIDO PAR√ÅMETRO 'idPrefix' AL FINAL
function renderPlayerStatsForm(containerId, currentCompetition, preSelectedPlayers = null, idPrefix = '') {
    const container = document.getElementById(containerId);
    
    let players = preSelectedPlayers || getActivePlayers().map(p => ({...p, rol: 'Jugador', specificPos: p.posicion, isStarter: false}));

    // L√≥gica de Sanciones
    const matches = getData('matches').filter(m => m.competition === currentCompetition);
    const lastMatch = matches.sort((a, b) => new Date(b.date) - new Date(a.date))[0];
    const suspendedPlayers = [];
    if (lastMatch) {
        lastMatch.playerStats.forEach(ps => { if (ps.redCards > 0) suspendedPlayers.push(ps.playerId); });
    }

    players.sort((a, b) => {
        if (a.rol === 'Entrenador') return 1; 
        if (b.rol === 'Entrenador') return -1;
        if (a.isStarter && !b.isStarter) return -1;
        if (!a.isStarter && b.isStarter) return 1;
        
        // Ordenar titulares por posici√≥n en el campo (pitchSlot)
        if (a.isStarter && b.isStarter) {
            if (typeof a.pitchSlot === 'number' && typeof b.pitchSlot === 'number') {
                return a.pitchSlot - b.pitchSlot;
            }
        }
        return 0;
    });

    container.innerHTML = players.map(p => {
        const isCoach = p.rol === 'Entrenador';
        const isSuspended = suspendedPlayers.includes(p.id) && !isCoach;
        
        // --- AQU√ç EST√Å EL CAMBIO IMPORTANTE ---
        // Concatenamos el prefijo (ej: "wizard-") al ID para hacerlo √∫nico
        const goalId = `${idPrefix}goals-${p.id}`;
        const assistId = `${idPrefix}assists-${p.id}`;
        const yellowId = `${idPrefix}yellow-${p.id}`;
        const redId = `${idPrefix}red-${p.id}`;

        let badgeHtml = '';
        if (isCoach) {
            badgeHtml = '<span class="bg-gray-200 text-gray-700 text-[10px] font-bold px-2 py-1 rounded uppercase">STAFF</span>';
        } else if (p.isStarter) {
            badgeHtml = `<span class="bg-emerald-100 text-emerald-700 text-[10px] font-bold px-2 py-1 rounded border border-emerald-200 uppercase">${p.specificPos || 'TITULAR'}</span>`;
        } else {
            badgeHtml = '<span class="bg-blue-50 text-blue-600 text-[10px] font-bold px-2 py-1 rounded border border-blue-100 uppercase">SUPLENTE</span>';
        }

        const btnClass = "w-full h-9 bg-white border border-gray-300 rounded text-sm text-gray-700 font-bold hover:border-indigo-400 hover:text-indigo-600 transition-colors flex items-center justify-center";

        // --- L√ìGICA CONDICIONAL PARA ENTRENADOR ---
        const goalsInput = isCoach 
            ? `<div class="w-full h-9 flex items-center justify-center text-gray-300 select-none">-</div>`
            : `<input type="hidden" class="stat-goals-minutes" id="${goalId}" value="">
               <button type="button" id="btn-${goalId}" onclick="openMinuteModal('${goalId}', 'Goles ‚öΩ')" class="${btnClass}">0</button>`;

        const assistsInput = isCoach
            ? `<div class="w-full h-9 flex items-center justify-center text-gray-300 select-none">-</div>`
            : `<input type="hidden" class="stat-assists-minutes" id="${assistId}" value="">
               <button type="button" id="btn-${assistId}" onclick="openMinuteModal('${assistId}', 'Asistencias üëü')" class="${btnClass}">0</button>`;

        const minsInput = isCoach
            ? `<div class="w-full h-9 flex items-center justify-center text-gray-300 select-none">-</div>`
            : `<input type="number" class="stat-minutes w-full h-9 px-2 border border-gray-300 rounded text-sm text-center font-mono text-gray-600 focus:ring-2 focus:ring-indigo-500 outline-none" min="0" max="120" value="${p.isStarter ? 90 : 0}">`;

        return `
        <div class="bg-white rounded-lg p-3 border border-gray-200 shadow-sm flex flex-col md:flex-row items-center gap-4 mb-2 ${isSuspended ? 'opacity-70 bg-gray-50' : ''}" 
             data-player-id="${p.id}" 
             data-rol="${p.rol}"
             data-specific-pos="${p.specificPos}"> 
             
            <div class="flex items-center gap-3 w-full md:w-1/3 min-w-[200px]">
                <div class="relative">
                    <img src="${p.foto}" class="w-10 h-10 rounded-full object-cover border border-gray-200" onerror="this.src='https://via.placeholder.com/40x40'">
                    ${isSuspended ? '<div class="absolute -top-1 -right-1 bg-red-500 text-white text-[8px] px-1 rounded-full font-bold">EXP</div>' : ''}
                </div>
                <div class="flex-1">
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-gray-800 text-sm truncate pr-2">${p.apodo || p.apellido}</span>
                        ${badgeHtml}
                    </div>
                    <span class="text-xs text-gray-400">#${p.dorsal} - ${p.posicion}</span>
                </div>
            </div>

            <div class="flex-1 grid grid-cols-5 gap-3 w-full">
                
                <div class="flex flex-col">
                    <label class="text-[9px] uppercase font-bold text-gray-400 mb-1 tracking-wider">Nota</label>
                    <input type="number" class="stat-rating w-full h-9 px-2 border border-gray-300 rounded text-sm text-center font-bold focus:ring-2 focus:ring-indigo-500 outline-none" min="0" max="10" step="0.25" placeholder="-">
                </div>

                <div class="flex flex-col">
                    <label class="text-[9px] uppercase font-bold text-gray-400 mb-1 tracking-wider">Gol</label>
                    ${goalsInput}
                </div>

                <div class="flex flex-col">
                    <label class="text-[9px] uppercase font-bold text-gray-400 mb-1 tracking-wider">Asis</label>
                    ${assistsInput}
                </div>

                <div class="flex flex-col">
                    <label class="text-[9px] uppercase font-bold text-gray-400 mb-1 tracking-wider">Min</label>
                    ${minsInput}
                </div>

                <div class="flex flex-col items-center">
                    <label class="text-[9px] uppercase font-bold text-gray-400 mb-1 tracking-wider">Tarj</label>
                    <div class="flex gap-1 w-full">
                        <div class="flex-1">
                            <input type="hidden" class="stat-yellow-minutes" id="${yellowId}" value="">
                            <button type="button" id="btn-${yellowId}" onclick="openMinuteModal('${yellowId}', 'Amarilla üü®')" 
                                    class="w-full h-9 bg-yellow-50 border border-yellow-200 rounded text-xs text-yellow-700 font-bold hover:bg-yellow-100 flex items-center justify-center">0</button>
                        </div>
                        <div class="flex-1">
                            <input type="hidden" class="stat-red-minutes" id="${redId}" value="">
                            <button type="button" id="btn-${redId}" onclick="openMinuteModal('${redId}', 'Roja üü•')" 
                                    class="w-full h-9 bg-red-50 border border-red-200 rounded text-xs text-red-700 font-bold hover:bg-red-100 flex items-center justify-center">0</button>
                        </div>
                    </div>
                </div>

            </div>
        </div>
        `;
    }).join('');
}
        
        // Handles mutual exclusion for Starter/Sub checkboxes
        function handleRoleCheck(checkbox, role) {
            const container = checkbox.closest('[data-player-id]');
            const starterChk = container.querySelector('.chk-starter');
            const subChk = container.querySelector('.chk-sub');
            const inputs = container.querySelector('.player-performance-inputs');
            
            if (role === 'starter' && checkbox.checked) {
                subChk.checked = false;
            } else if (role === 'sub' && checkbox.checked) {
                starterChk.checked = false;
            }
            
            // Show inputs if either is checked
            inputs.style.display = (starterChk.checked || subChk.checked) ? 'grid' : 'none';
        }

       function resetNewMatchForm() {
            document.getElementById('new-match-form').reset();
            document.getElementById('new-round').innerHTML = '<option value="">Primero selecciona competici√≥n...</option>';
            document.getElementById('round-info').textContent = '';
            document.getElementById('leg-indicator').classList.add('hidden');
            document.getElementById('venue-alternation-warning').classList.add('hidden');
            
            // ‚úÖ DESBLOQUEAR FECHA
            const dateInput = document.getElementById('new-date');
            dateInput.readOnly = false;
            dateInput.classList.remove('bg-gray-100', 'cursor-not-allowed');

            // Resetear select de competici√≥n
            const compSelect = document.getElementById('new-competition');
            compSelect.disabled = false;
            compSelect.classList.remove('readonly-input', 'bg-gray-100', 'text-gray-600');
            
            document.getElementById('new-venue').disabled = false;
            document.getElementById('new-venue').classList.remove('readonly-input');
            document.getElementById('new-stadium').readOnly = true;
            document.getElementById('new-stadium').classList.add('readonly-input');
            document.getElementById('overtime-controls').classList.add('hidden');
            
            selectedCalendarFixture = null;
            document.getElementById('selected-fixture-info').classList.add('hidden');
            document.getElementById('new-match-form-container').classList.add('hidden');
            document.getElementById('select-match-prompt').classList.remove('hidden');
            
            // Reset Wizard
            document.getElementById('wizard-step-1').classList.remove('hidden');
            document.getElementById('wizard-step-2').classList.add('hidden');
            document.getElementById('wizard-step-3').classList.add('hidden');

            document.getElementById('new-match-players-stats').innerHTML = '';
        }
        
document.getElementById('new-match-form').addEventListener('submit', function(e) {
    e.preventDefault();
    
    const calendarEventId = document.getElementById('calendar-event-id').value;
    if (!calendarEventId) {
        alert('Error: No se ha seleccionado un partido del calendario.');
        return;
    }

    const compName = document.getElementById('new-competition').value;
    const roundId = document.getElementById('new-round').value;
    const date = document.getElementById('new-date').value;
    const opponent = document.getElementById('new-opponent').value;
    const venue = document.getElementById('new-venue').value;
    const stadium = document.getElementById('new-stadium').value;
    let result = document.getElementById('new-result').value.trim();
    
    // L√≥gica de Penaltis
    const chkPenalties = document.getElementById('chk-penalties');
    if (chkPenalties && chkPenalties.checked) {
        const outcomeRadio = document.querySelector('input[name="penalties-outcome"]:checked');
        if (outcomeRadio) {
            const isWin = outcomeRadio.value === 'win';
            const parts = result.split('-').map(Number);
            let usIndex = (venue === 'visitante') ? 1 : 0;
            
            if (isWin) parts[usIndex]++;
            else parts[usIndex === 0 ? 1 : 0]++;
            
            result = `${parts[0]}-${parts[1]}*`;
        }
    }

    const comp = COMPETICIONES_ACTUALES[compName];
    let roundInfo = { nombre: roundId }; // Fallback
    if (comp) {
        comp.fases.forEach(fase => {
            const found = fase.rondas.find(r => r.id === roundId);
            if (found) roundInfo = { ...found, faseTipo: fase.tipo };
        });
    }
    
    const outcome = calculateMatchOutcome(result, venue);
    
    // --- RECOGIDA DE DATOS ---    
    const statsContainer = document.getElementById('final-stats-container');
    const playerStats = [];
    
    // --- DENTRO DEL LISTENER DE 'new-match-form' ---
    // (Sustituye el bloque donde rellenas playerStats)

    statsContainer.querySelectorAll('[data-player-id]').forEach(row => {
        const playerId = row.getAttribute('data-player-id');
        const specificPos = row.getAttribute('data-specific-pos');
        const isBadgeStarter = row.querySelector('.bg-emerald-100') !== null;
        
        // Inputs Ocultos (Minutos/Goles)
        const goalsStr = row.querySelector('.stat-goals-minutes')?.value || "";
        const assistsStr = row.querySelector('.stat-assists-minutes')?.value || "";
        const yellowStr = row.querySelector('.stat-yellow-minutes')?.value || "";
        const redStr = row.querySelector('.stat-red-minutes')?.value || "";

        const countItems = (str) => (!str || str.trim() === "") ? 0 : str.split(',').filter(s => s.trim() !== '').length;

        const goals = countItems(goalsStr);
        const assists = countItems(assistsStr);
        const yellow = countItems(yellowStr);
        const red = countItems(redStr);

        const ratingVal = row.querySelector('.stat-rating')?.value;
        const rating = (ratingVal === "" || ratingVal === null) ? null : parseFloat(ratingVal);
        const minVal = row.querySelector('.stat-minutes')?.value;
        const minutes = (parseInt(minVal) || 0);

        // =======================================================
        // NUEVO: DETECTAR POSICI√ìN EXACTA EN LA PIZARRA
        // =======================================================
        let savedSlot = null;
        // Buscamos si este jugador est√° en alguna casilla de la pizarra actual
        // currentPitchPlayers suele ser {"wizard-slot-0": "idJugador", ...}
        if (typeof currentPitchPlayers !== 'undefined') {
            const slotKey = Object.keys(currentPitchPlayers).find(key => currentPitchPlayers[key] === playerId);
            if (slotKey) {
                // Extraemos solo el n√∫mero (ej: de "wizard-slot-5" sacamos "5")
                const match = slotKey.match(/(\d+)$/); 
                if (match) savedSlot = parseInt(match[1]);
            }
        }
        // =======================================================

        playerStats.push({
            playerId: playerId,
            isStarter: isBadgeStarter,
            pitchSlot: savedSlot, // <--- AQU√ç GUARDAMOS LA COORDENADA
            specificPosition: specificPos,
            rating: rating,
            goals: goals,
            assists: assists,
            minutes: minutes,
            yellowCards: yellow,
            redCards: red,
            played: minutes > 0,
            detailGoals: goalsStr,
            detailAssists: assistsStr,
            detailYellow: yellowStr,
            detailRed: redStr
        });
    });
    
    const mvp = calculateAutoMVP(playerStats);
    
    // Calcular Finanzas y Edad (si tienes la funci√≥n)
    let squadStats = { valorTotal: 0, edadMedia: 0 };
    if (typeof getSquadStats === 'function') {
        squadStats = getSquadStats();
    }

    const matchData = {
        id: generateId(),
        calendarEventId: calendarEventId,
        // Aseg√∫rate de que este ID existe en tu HTML
        formation: document.getElementById('formation-select') ? document.getElementById('formation-select').value : '4-3-3',
        competition: compName,
        roundId: roundId,
        round: roundInfo.nombre,
        date: date,
        opponent: opponent,
        venue: venue,
        stadium: stadium,
        result: result,
        outcome: outcome,
        mvp: mvp,
        valorPlantilla: squadStats.valorTotal,
        edadMedia: squadStats.edadMedia,
        playerStats: playerStats
    };
    
    const matches = getData('matches');
    matches.push(matchData);
    saveData('matches', matches);
    
    if (typeof checkEliminationAfterMatch === 'function') checkEliminationAfterMatch(matchData);

    const triggered = (typeof checkExtraRoundTrigger === 'function') ? checkExtraRoundTrigger(matchData) : false;
    
    if (!triggered) {
        const hasPerfectRating = playerStats.some(p => p.rating === 10);
        if ((outcome === 'victoria' || hasPerfectRating) && typeof triggerConfetti === 'function') {
            triggerConfetti(); 
        }

        if (typeof resetNewMatchForm === 'function') resetNewMatchForm();
        if (typeof renderCompetitionStatus === 'function') renderCompetitionStatus();
        if (typeof populateCompetitionSelect === 'function') populateCompetitionSelect();
        
        if (typeof showToast === 'function') showToast('Partido registrado correctamente', 'success');
        if (typeof showTab === 'function') showTab('partidos');
    }
});
        
        // ==========================================
        // CALENDAR
        // ==========================================
        // ==========================================
        // SISTEMA DE PRECARGA DE CALENDARIO
        // ==========================================
        
        // Memoria para guardar los calendarios y no tener que recargarlos
        const CALENDAR_CACHE = { masculino: null, femenino: null };

        async function getCalendarEvents(team) {
            // 1. Si ya lo tenemos en memoria, lo devolvemos al instante (¬°Velocidad pura!)
            if (CALENDAR_CACHE[team]) return CALENDAR_CACHE[team];

            const config = TEAMS_CONFIG[team];
            if (!config) return [];

            const icalUrl = config.icalUrl;
            
            // Lista de proxies para saltar el bloqueo CORS
            const proxies = [
                (url) => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
                (url) => `https://corsproxy.io/?${encodeURIComponent(url)}`,
                (url) => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`
            ];

            let icalData = null;

            // Intentamos descargar con cada proxy
            for (const proxyFn of proxies) {
                try {
                    const proxyUrl = proxyFn(icalUrl);
                    const response = await fetch(proxyUrl, { method: 'GET' });
                    if (response.ok) {
                        const text = await response.text();
                        if (text.includes('BEGIN:VCALENDAR') || text.includes('BEGIN:VEVENT')) {
                            icalData = text;
                            break;
                        }
                    }
                } catch (error) {
                    console.warn('Proxy failed');
                }
            }

            let events = [];
            if (icalData) {
                // Pasamos 'team' expl√≠citamente para no depender de 'currentTeam'
                events = parseICalData(icalData, team);
            }

            // A√±adir partidos manuales (Mundial de Clubes) si corresponde
            if (config.manualJuneMatches) {
                const manualMatches = [
                    { id: 'jun-1', start: new Date('2025-06-18T21:00:00'), summary: 'Real Madrid vs Al-Hilal', opponent: 'Al-Hilal', competition: 'Mundial de Clubes', venue: 'neutral', location: 'Hard Rock Stadium' },
                    { id: 'jun-2', start: new Date('2025-06-22T21:00:00'), summary: 'Real Madrid vs Pachuca', opponent: 'Pachuca', competition: 'Mundial de Clubes', venue: 'neutral', location: 'Bank of America Stadium' },
                    { id: 'jun-3', start: new Date('2025-06-27T03:00:00'), summary: 'Salzburgo vs Real Madrid', opponent: 'Salzburgo', competition: 'Mundial de Clubes', venue: 'neutral', location: 'Lincoln Financial Field' }
                ];
                events = [...manualMatches, ...events];
                events.sort((a, b) => a.start - b.start);
            }
            
            // Guardamos en cach√© para el futuro
            CALENDAR_CACHE[team] = events;
            return events;
        }

        function preloadCalendars() {
            console.log("üöÄ Iniciando precarga inteligente de calendarios...");
            getCalendarEvents('masculino');
            getCalendarEvents('femenino');
        }


      async function loadCalendar() {
            if (!currentTeam) return;
            
            // Avisar visualmente en el calendario si est√° vac√≠o
            const container = document.getElementById('calendar-container');
            if (!CALENDAR_CACHE[currentTeam] && container) {
                container.innerHTML = `
                    <div class="calendar-loading text-center py-12">
                        <div class="text-4xl mb-4">‚è≥</div>
                        <p class="text-gray-600">Conectando con LaLiga...</p>
                    </div>
                `;
            }

            // Descargar datos (Esperamos aqu√≠)
            calendarEvents = await getCalendarEvents(currentTeam);
            
            // 1. Si estamos en la pesta√±a Calendario -> Pintar calendario
            if (!document.getElementById('section-calendario').classList.contains('hidden')) {
                renderCalendar();
            }

            // 2. Si estamos en la pesta√±a Principal -> Pintar Principal (Pr√≥ximo partido + IA)
            if (!document.getElementById('section-principal').classList.contains('hidden')) {
                renderPrincipal();
            }
        }

        // Mapa de traducci√≥n: Nombre en Calendario (.ics) -> Nombre en tu Web
        function mapIcsCompetition(icsDescription) {
            if (!icsDescription) return null;
            
            // 1. Convertimos todo a min√∫sculas para evitar errores de may√∫sculas
            const desc = icsDescription.toLowerCase().trim(); 

            // --- MASCULINO ---
            if (desc.includes('la liga') || desc.includes('laliga')) return 'Liga EA Sports';
            if (desc.includes('champions league')) return 'Champions League';
            if (desc.includes('fifa club world cup') || desc.includes('mundial de clubes') || desc.includes('intercontinental')) return 'Mundial de Clubes';
            if (desc.includes('supercopa de espa√±a')) return 'Supercopa de Espa√±a';
            if (desc.includes('copa del rey')) return 'Copa del Rey';
            
            // --- FEMENINO ---
            // Detecta "Primera Divisi√≥n" aunque venga con may√∫sculas
            if (desc.includes('primera divisi√≥n') || desc.includes('primera division') || desc.includes('liga f')) return 'Liga F';
            
            // Detecta Champions Femenina
            if ((desc.includes('women') && desc.includes('champions')) || desc.includes('uwcl')) return 'UWCL';
            
            // Copas
            if (desc.includes('copa de la reina')) return 'Copa de la Reina';
            if (desc.includes('supercopa') && (desc.includes('femenina') || desc.includes('women'))) return 'Supercopa Femenina';

            // --- OTROS ---
            if (desc.includes('amistoso')) return 'Amistoso';

            return null;
        }
       // AHORA ACEPTA 'teamContext' PARA SABER QU√â EQUIPO ES DURANTE LA PRECARGA
        function parseICalData(icalData, teamContext = currentTeam) {
            const events = [];
            const normalizedData = icalData.replace(/\r\n /g, '').replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            const lines = normalizedData.split('\n');
            
            let currentEvent = null;
            
            for (let i = 0; i < lines.length; i++) {
                let line = lines[i];
                while (i + 1 < lines.length && (lines[i + 1].startsWith(' ') || lines[i + 1].startsWith('\t'))) {
                    i++;
                    line += lines[i].substring(1);
                }
                line = line.trim();
                if (!line) continue;
                
                if (line === 'BEGIN:VEVENT') {
                    currentEvent = {};
                } else if (line === 'END:VEVENT' && currentEvent) {
                    // Generar ID Determinista (UID o Hash) para persistencia
                    if (!currentEvent.id) {
                        if (currentEvent.uid) {
                            currentEvent.id = currentEvent.uid;
                        } else if (currentEvent.start && currentEvent.summary) {
                            const dateStr = currentEvent.start.toISOString();
                            let hash = 0;
                            const str = currentEvent.summary;
                            for (let j = 0; j < str.length; j++) {
                                hash = ((hash << 5) - hash) + str.charCodeAt(j);
                                hash |= 0;
                            }
                            currentEvent.id = `evt-${dateStr}-${Math.abs(hash)}`;
                        } else {
                            currentEvent.id = generateId();
                        }
                    }

                    if (currentEvent.summary && currentEvent.start) {
                        currentEvent.opponent = extractOpponent(currentEvent.summary);
                        currentEvent.venue = detectVenue(currentEvent.summary, currentEvent.location);
                        
                        // 1. Detecci√≥n por Descripci√≥n (Plan A)
                        let realComp = mapIcsCompetition(currentEvent.description);
                        
                        // CORRECCI√ìN AUTOM√ÅTICA USANDO teamContext
                        if (teamContext === 'femenino' && realComp) {
                            if (realComp === 'Champions League') realComp = 'UWCL';
                            if (realComp === 'Liga EA Sports') realComp = 'Liga F';
                            if (realComp === 'Copa del Rey') realComp = 'Copa de la Reina';
                            if (realComp === 'Supercopa de Espa√±a') realComp = 'Supercopa Femenina';
                        }
                        
                        if (realComp) {
                            currentEvent.competition = realComp; 
                            currentEvent.possibleCompetition = realComp;
                        } else {
                            // 2. Detecci√≥n por T√≠tulo (Plan B)
                            const summaryLower = currentEvent.summary.toLowerCase();
                            let detectedComp = null;
                            
                             if (summaryLower.includes('champions') || summaryLower.includes('uwcl')) {
                                 detectedComp = teamContext === 'femenino' ? 'UWCL' : 'Champions League';
                             }
                             else if (summaryLower.includes('copa')) {
                                 detectedComp = teamContext === 'femenino' ? 'Copa de la Reina' : 'Copa del Rey';
                             }
                             else if (summaryLower.includes('liga')) {
                                 detectedComp = teamContext === 'femenino' ? 'Liga F' : 'Liga EA Sports';
                             }
                             else if (summaryLower.includes('supercopa')) {
                                 detectedComp = teamContext === 'femenino' ? 'Supercopa Femenina' : 'Supercopa de Espa√±a';
                             }
                             
                             // Fallback por defecto
                             if (!detectedComp && teamContext === 'femenino') {
                                 detectedComp = 'Liga F';
                             }
                             
                             if (detectedComp) {
                                 currentEvent.competition = detectedComp;
                             }
                             
                             currentEvent.possibleCompetition = detectedComp || 'Partido Oficial';
                        }
                        
                        events.push(currentEvent);
                    }
                    currentEvent = null;
                } else if (currentEvent) {
                    const colonIndex = line.indexOf(':');
                    if (colonIndex > 0) {
                        let key = line.substring(0, colonIndex);
                        let value = line.substring(colonIndex + 1);
                        if (key.includes(';')) key = key.split(';')[0];
                        
                        if (key === 'SUMMARY') currentEvent.summary = value.replace(/\\,/g, ',').replace(/\\;/g, ';').replace(/\\n/g, ' ');
                        else if (key === 'DTSTART') currentEvent.start = parseICalDate(value);
                        else if (key === 'UID') currentEvent.uid = value.trim();
                        else if (key === 'LOCATION') currentEvent.location = value.replace(/\\,/g, ',').replace(/\\;/g, ';');
                        else if (key === 'DESCRIPTION') currentEvent.description = value.replace(/\\,/g, ',').replace(/\\;/g, ';').replace(/\\n/g, ' ');
                    }
                }
            }
            return events.filter(e => e.start).sort((a, b) => a.start - b.start);
        }
        
        function parseICalDate(dateStr) {
            if (!dateStr) return null;
            dateStr = dateStr.trim();
            try {
                const year = parseInt(dateStr.substring(0, 4));
                const month = parseInt(dateStr.substring(4, 6)) - 1;
                const day = parseInt(dateStr.substring(6, 8));
                if (dateStr.includes('T')) {
                    const hour = parseInt(dateStr.substring(9, 11)) || 0;
                    const minute = parseInt(dateStr.substring(11, 13)) || 0;
                    if (dateStr.endsWith('Z')) return new Date(Date.UTC(year, month, day, hour, minute));
                    return new Date(year, month, day, hour, minute);
                }
                return new Date(year, month, day, 21, 0);
            } catch (e) { return null; }
        }
        
        function extractOpponent(summary) {
            if (!summary) return 'Rival';
            let opponent = summary
                .replace(/real madrid c\.?f\.?/gi, '')
                .replace(/real madrid/gi, '')
                .replace(/vs\.?/gi, '')
                .replace(/\s*-\s*/g, ' ')
                .trim();
            const words = opponent.split(/\s+/).filter(w => w.length > 1);
            return words.length > 4 ? words.slice(0, 3).join(' ') : words.join(' ');
        }
        
        function detectVenue(summary, location) {
            const s = ((summary || '') + ' ' + (location || '')).toLowerCase();
            if (s.includes('bernab√©u') || s.includes('di st√©fano') || s.includes('valdebebas')) return 'local';
            if (summary && summary.toLowerCase().trim().startsWith('real madrid')) return 'local';
            return 'visitante';
        }
        
        function switchCalendarView(mode) {
            calendarViewMode = mode;
            document.getElementById('cal-view-list').className = mode === 'list' ? 
                'px-3 py-1.5 text-sm rounded-md font-medium transition bg-slate-800 text-white' : 
                'px-3 py-1.5 text-sm rounded-md font-medium transition text-gray-600 hover:bg-gray-100';
            document.getElementById('cal-view-month').className = mode === 'month' ? 
                'px-3 py-1.5 text-sm rounded-md font-medium transition bg-slate-800 text-white' : 
                'px-3 py-1.5 text-sm rounded-md font-medium transition text-gray-600 hover:bg-gray-100';
            
            const timeFilters = document.getElementById('cal-time-filters');
            const monthNav = document.getElementById('cal-month-nav');
            
            if (mode === 'list') {
                timeFilters.classList.remove('hidden');
                monthNav.classList.add('hidden');
            } else {
                timeFilters.classList.add('hidden');
                monthNav.classList.remove('hidden');
            }
            
            renderCalendar();
        }
        
        function changeCalendarMonth(delta) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
            renderCalendar();
        }

        function filterCalendar(comp) {
            currentCalendarFilter = comp;
            document.querySelectorAll('.cal-filter').forEach(btn => btn.classList.remove('bg-slate-800', 'text-white'));
            event.target.classList.add('bg-slate-800', 'text-white');
            renderCalendar();
        }
        
        function filterCalendarTime(time) {
            currentTimeFilter = time;
            document.querySelectorAll('.time-filter').forEach(btn => {
                btn.classList.remove('bg-slate-800', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            event.target.classList.remove('bg-gray-200', 'text-gray-700');
            event.target.classList.add('bg-slate-800', 'text-white');
            renderCalendar();
        }
        
        function renderCalendar() {
            hideRegisteredMatches = document.getElementById('hide-registered-matches').checked;
            if (calendarViewMode === 'list') {
                renderCalendarList();
            } else {
                renderCalendarMonth();
            }
        }
        
        function renderCalendarList() {
            const container = document.getElementById('calendar-container');
            const now = new Date();
            now.setHours(23, 59, 59, 999);
            
            const matches = getData('matches');
            const registeredEventIds = matches.map(m => m.calendarEventId);
            
            let events = [...calendarEvents];
            
            if (hideRegisteredMatches) {
                events = events.filter(e => !registeredEventIds.includes(e.id));
            }

            if (currentCalendarFilter) {
                 events = events.filter(e => {
                     const isReg = registeredEventIds.includes(e.id);
                     if (isReg) {
                         const m = matches.find(m => m.calendarEventId === e.id);
                         return m.competition === currentCalendarFilter;
                     } else {
                         return false; // Don't show unregistered matches when filtering by specific comp
                     }
                 });
            }
            
            if (currentTimeFilter === 'past') events = events.filter(e => e.start <= now);
            else if (currentTimeFilter === 'future') events = events.filter(e => e.start > now);
            
            if (events.length === 0) {
                container.innerHTML = '<div class="text-center py-12 text-gray-500">No hay partidos.</div>';
                return;
            }
            
            container.innerHTML = events.map(event => {
                const isPast = event.start <= now;
                let isRegistered = registeredEventIds.includes(event.id);
                let registeredMatch = isRegistered ? matches.find(m => m.calendarEventId === event.id) : null;
                
                // Fallback: Verificar por Fecha y Rival si falla el ID (para CSV/JSON antiguos)
                if (!isRegistered) {
                    const evtDate = event.start.toISOString().split('T')[0];
                    registeredMatch = matches.find(m => {
                        if (m.date !== evtDate) return false;
                        const mOpp = m.opponent.toLowerCase().trim();
                        const eOpp = event.opponent.toLowerCase().trim();
                        return mOpp.includes(eOpp) || eOpp.includes(mOpp);
                    });
                    if (registeredMatch) isRegistered = true;
                }
                
                const dateStr = event.start.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
                const timeStr = event.start.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                
                // Logic: Only show real competition name and color if registered. Otherwise default/grey.
               // L√≥gica NUEVA: Mostrar competici√≥n si est√° registrada O si la hemos detectado en el calendario
                let compName = event.competition || 'Pendiente de registro'; // Aqu√≠ est√° la clave: usa la del evento si existe
                let compColorClass = 'bg-gray-200 text-gray-600';
                let borderColorClass = 'border-gray-300';

                // Si ya lo registraste, priorizamos lo que t√∫ guardaste
                if (isRegistered) {
                    compName = registeredMatch.competition;
                }

                // Buscamos los colores para esa competici√≥n (sea detectada o registrada)
                const compObj = Object.values(COMPETICIONES_ACTUALES).find(c => c.nombre === compName);
                if (compObj) {
                    compColorClass = compObj.color;
                    borderColorClass = compObj.borderColor;
                } else if (compName === 'Amistoso') {
                    // Un colorcito especial para amistosos
                    compColorClass = 'bg-yellow-100 text-yellow-800 border border-yellow-200';
                }

                const venueText = isRegistered ? (registeredMatch.venue === 'local' ? 'üè† Local' : (registeredMatch.venue === 'neutral' ? 'üèüÔ∏è Neutral' : '‚úàÔ∏è Visitante')) 
                                               : (event.venue === 'local' ? 'üè† Local' : (event.venue === 'neutral' ? 'üèüÔ∏è Neutral' : '‚úàÔ∏è Visitante'));
                
                return `
                    <div class="bg-white rounded-xl shadow-sm p-4 match-card ${borderColorClass} ${isRegistered ? 'match-registered' : ''}" 
                         ${isPast && !isRegistered ? `onclick="selectCalendarFixture('${event.id}')"` : ''} 
                         style="cursor: ${isPast && !isRegistered ? 'pointer' : 'default'}">
                        <div class="flex flex-col md:flex-row md:items-center gap-3">
                            <div class="flex-1">
                                <div class="flex flex-wrap items-center gap-2 mb-2">
                                    <span class="${compColorClass} px-2 py-0.5 rounded text-xs font-medium">${compName}</span>
                                    <span class="text-xs text-gray-500">${venueText}</span>
                                    ${isRegistered ? '<span class="text-xs bg-gray-200 text-gray-700 px-2 py-0.5 rounded">‚úÖ Registrado</span>' : 
                                      (isPast ? '<span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded">üìù Clic para registrar</span>' : '')}
                                </div>
                                <h4 class="font-semibold text-gray-800">${event.opponent}</h4>
                                <p class="text-sm text-gray-500">üèüÔ∏è ${event.location || 'Estadio'}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-medium text-gray-800">${dateStr}</p>
                                <p class="text-amber-600 font-semibold">${timeStr}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderCalendarMonth() {
            const container = document.getElementById('calendar-container');
            const matches = getData('matches');
            const registeredEventIds = matches.map(m => m.calendarEventId);
            
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            document.getElementById('current-month-display').textContent = new Date(year, month).toLocaleDateString('es-ES', { month: 'long', year: 'numeric' }).toUpperCase();
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            // Start on Monday (adjust so Sunday is 6, Monday is 0)
            let startDayOfWeek = firstDay.getDay() - 1;
            if (startDayOfWeek < 0) startDayOfWeek = 6;
            
            const totalDays = lastDay.getDate();
            
            let gridHtml = `
                <div class="calendar-grid bg-white rounded-xl overflow-hidden shadow-sm">
                    <div class="calendar-day-header">LUN</div>
                    <div class="calendar-day-header">MAR</div>
                    <div class="calendar-day-header">MIE</div>
                    <div class="calendar-day-header">JUE</div>
                    <div class="calendar-day-header">VIE</div>
                    <div class="calendar-day-header">SAB</div>
                    <div class="calendar-day-header">DOM</div>
            `;
            
            // Empty cells for days before start
            for (let i = 0; i < startDayOfWeek; i++) {
                gridHtml += `<div class="calendar-day other-month"></div>`;
            }
            
            const now = new Date();
            now.setHours(0, 0, 0, 0);

            for (let day = 1; day <= totalDays; day++) {
                const currentDate = new Date(year, month, day);
                currentDate.setHours(0, 0, 0, 0);
                
                const isToday = currentDate.getTime() === now.getTime();
                
                // Find events for this day
                const daysEvents = calendarEvents.filter(e => {
                    const eDate = new Date(e.start);
                    return eDate.getDate() === day && eDate.getMonth() === month && eDate.getFullYear() === year;
                });
                
                let eventsHtml = '';
                daysEvents.forEach(e => {
                    let isRegistered = registeredEventIds.includes(e.id);
                    
                    // Fallback: Verificar por Fecha y Rival
                    if (!isRegistered) {
                        const evtDate = e.start.toISOString().split('T')[0];
                        const matchFound = matches.find(m => {
                            if (m.date !== evtDate) return false;
                            const mOpp = m.opponent.toLowerCase().trim();
                            const eOpp = e.opponent.toLowerCase().trim();
                            return mOpp.includes(eOpp) || eOpp.includes(mOpp);
                        });
                        if (matchFound) isRegistered = true;
                    }

                    if (hideRegisteredMatches && isRegistered) return;

                    const isPast = e.start <= new Date();
                    
                    // 1. Estilo Base (Neutro)
                    let style = 'background-color: #e5e7eb; color: #374151;'; 
                    let title = e.opponent;

                    // 2. Determinar Competici√≥n (Registrada > Detectada > Nada)
                    let compName = e.competition; 
                    if (isRegistered) {
                        const m = matches.find(m => m.calendarEventId === e.id) || matches.find(m => {
                            // B√∫squeda fallback para obtener el nombre de la compe
                            if (m.date !== e.start.toISOString().split('T')[0]) return false;
                            const mOpp = m.opponent.toLowerCase().trim();
                            const eOpp = e.opponent.toLowerCase().trim();
                            return mOpp.includes(eOpp) || eOpp.includes(mOpp);
                        });
                        if (m) compName = m.competition;
                    }

                    // 3. Aplicar Colores (Mismos HEX que en CSS)
                    if (compName) {
                         const compObj = Object.values(COMPETICIONES_ACTUALES).find(c => c.nombre === compName);
                         
                         if (compObj) {
                             // L√≥gica para asignar colores seg√∫n el tipo de competici√≥n
                             const id = compObj.id;
                             if (id.includes('liga') || id === 'liga-f') style = 'background-color: #dbeafe; color: #1e40af;';
                             else if (id.includes('champions') || id === 'uwcl') style = 'background-color: #ede9fe; color: #5b21b6;';
                             else if (id.includes('copa')) style = 'background-color: #d1fae5; color: #065f46;';
                             else if (id.includes('mundial')) style = 'background-color: #fef3c7; color: #92400e;';
                             else if (id.includes('supercopa')) style = 'background-color: #fee2e2; color: #991b1b;';
                         } 
                         else if (compName === 'Amistoso') {
                             style = 'background-color: #fef9c3; color: #854d0e;'; // Amarillo suave para amistosos
                         }
                    }

                    // 4. Si est√° registrado, a√±adir tachado y opacidad (pero manteniendo el color de fondo)
                    if (isRegistered) {
                         style += ' text-decoration: line-through; opacity: 0.7; border: 1px solid rgba(0,0,0,0.1);';
                    }

                    const action = (isPast && !isRegistered) ? `onclick="selectCalendarFixture('${e.id}')"` : '';
                    
                    eventsHtml += `<div class="cal-event-dot" style="${style}" ${action} title="${title}">
                        ${e.start.getHours()}:${e.start.getMinutes().toString().padStart(2,'0')} ${e.opponent}
                    </div>`;
                });
                
                gridHtml += `
                    <div class="calendar-day ${isToday ? 'today' : ''}">
                        <span class="day-number">${day}</span>
                        ${eventsHtml}
                    </div>
                `;
            }
            
            gridHtml += '</div>';
            container.innerHTML = gridHtml;
        }

        // ==========================================
        // MATCH HELPERS
        // ==========================================
        
        function calculateMatchOutcome(result, venue) {
            if (!result || !result.includes('-')) return null;
            const parts = result.replace('*','').split('-');
            const homeGoals = parseInt(parts[0]);
            const awayGoals = parseInt(parts[1]);
            if (isNaN(homeGoals) || isNaN(awayGoals)) return null;
            
            if (homeGoals === awayGoals) return 'empate';
            
            if (venue === 'local') return homeGoals > awayGoals ? 'victoria' : 'derrota';
            if (venue === 'visitante') return awayGoals > homeGoals ? 'victoria' : 'derrota';
            
            return homeGoals > awayGoals ? 'victoria' : 'derrota';
        }

        function calculateAutoMVP(playerStats) {
            if (!playerStats || playerStats.length === 0) return '';
            let bestPlayer = null;
            let highestRating = -1;
            playerStats.forEach(ps => {
                if (ps.rating !== null && ps.rating !== "" && ps.rating > highestRating) {
                    highestRating = ps.rating;
                    bestPlayer = ps.playerId;
                }
            });
            return bestPlayer || '';
        }

        function getResultClass(outcome) {
            if (outcome === 'victoria') return 'result-win';
            if (outcome === 'empate') return 'result-draw';
            if (outcome === 'derrota') return 'result-loss';
            return 'bg-gray-100';
        }

        function getRatingColor(rating) {
            if (rating === '-' || rating === null) return 'text-gray-400';
            const num = parseFloat(rating);
            if (num >= 8) return 'text-emerald-600';
            if (num >= 6) return 'text-blue-600';
            if (num >= 5) return 'text-amber-600';
            return 'text-red-600';
        }

        // ==========================================
        // MATCH DISPLAY & ACTIONS
        // ==========================================
        // Funci√≥n para obtener el color exacto seg√∫n la escala solicitada
        function getTeamRatingColor(rating) {
            if (rating === '-' || !rating) return '#6b7280'; // Gris por defecto
            const num = parseFloat(rating);
            
            if (num < 5) return '#dc0c00';      // Rojo
            if (num >= 5 && num < 6) return '#ed7e07'; // Naranja
            if (num >= 6 && num < 7) return '#d9af00'; // Amarillo
            if (num >= 7 && num < 8) return '#00c424'; // Verde
            if (num >= 8) return '#00adc4';     // Azul
            
            return '#6b7280';
        }
function renderMatches(matchesData = null) {
    let matches = matchesData || getData('matches');
    const players = getPlayers();
    const container = document.getElementById('matches-list');
    const noMatches = document.getElementById('no-matches');
    
    const competitionFilter = document.getElementById('filter-competition').value;
    const venueFilter = document.getElementById('filter-venue').value;
    const resultFilter = document.getElementById('filter-result').value;
    
    if (competitionFilter) matches = matches.filter(m => m.competition === competitionFilter);
    if (venueFilter) matches = matches.filter(m => m.venue === venueFilter);
    if (resultFilter) matches = matches.filter(m => m.outcome === resultFilter);
    
    if (!matches || matches.length === 0) {
        container.innerHTML = '';
        if(noMatches) noMatches.classList.remove('hidden');
        return;
    }
    
    if(noMatches) noMatches.classList.add('hidden');
    
    // Ordenar por fecha descendente
    matches.sort((a, b) => new Date(b.date) - new Date(a.date));
    
    container.innerHTML = matches.map(match => {
        const mvpPlayer = players.find(p => p.id === match.mvp);
        const totalGoals = match.playerStats ? match.playerStats.reduce((sum, ps) => sum + (ps.goals || 0), 0) : 0;
        const outcomeClass = getResultClass(match.outcome);
        const compColor = COMPETICIONES_ACTUALES[match.competition]?.color || 'bg-gray-200';
        
        // C√°lculo de nota media
        let totalRating = 0;
        let ratedCount = 0;
        if (match.playerStats) {
            match.playerStats.forEach(ps => {
                if (ps.rating !== null && ps.rating !== "" && ps.rating !== undefined) {
                    totalRating += parseFloat(ps.rating);
                    ratedCount++;
                }
            });
        }
        const teamAvg = ratedCount > 0 ? (totalRating / ratedCount).toFixed(2) : '-';
        const ratingColor = getTeamRatingColor(teamAvg);

        // --- VALORES NUEVOS (Con protecci√≥n para partidos antiguos) ---
        const squadValue = match.valorPlantilla || 0;
        const squadAge = match.edadMedia || '-';

        return `
            <div class="card bg-white rounded-xl shadow-sm p-4 mb-3 border border-gray-100">
                <div class="flex flex-col sm:flex-row sm:items-center gap-4">
                    
                    <div class="flex-1">
                        <div class="flex flex-wrap items-center gap-2 mb-2">
                            <span class="text-gray-500 text-xs font-mono">${formatDate(match.date)}</span>
                            <span class="${compColor} px-2 py-0.5 rounded text-[10px] font-bold uppercase tracking-wide">${match.competition}</span>
                            <span class="text-xs text-gray-400">üìç ${match.venue}</span>
                            ${match.round ? `<span class="text-xs text-gray-400">‚Ä¢ ${match.round}</span>` : ''}
                            ${match.result ? `<span class="${outcomeClass} px-2 py-0.5 rounded text-xs font-bold ml-auto sm:ml-2">${match.result}</span>` : ''}
                        </div>

                        <h3 class="text-xl font-black text-gray-800 tracking-tight leading-none mb-3">
                            <span class="text-gray-400 font-normal text-base">vs</span> ${match.opponent}
                        </h3>
                        
                        <div class="flex flex-wrap gap-3 text-xs text-gray-600 items-center bg-gray-50 p-2 rounded-lg border border-gray-100">
                            
                            <span class="font-bold flex items-center gap-1">
                                ‚öΩ ${totalGoals}
                            </span>
                            
                            <span class="border-l border-gray-300 pl-3 font-bold flex items-center gap-1" style="color: ${ratingColor}">
                                üìä ${teamAvg}
                            </span>

                            <span class="border-l border-gray-300 pl-3 flex items-center gap-1 text-emerald-700" title="Valor Convocatoria">
                                üí∞ <span class="font-bold">${squadValue} M‚Ç¨</span>
                            </span>

                            <span class="border-l border-gray-300 pl-3 flex items-center gap-1 text-blue-700" title="Edad Media XI Inicial">
                                üéÇ <span class="font-bold">${squadAge} a√±os</span>
                            </span>
                            
                            ${mvpPlayer ? `
                                <span class="text-amber-600 border-l border-gray-300 pl-3 flex items-center gap-1 font-bold">
                                    üèÜ ${mvpPlayer.apodo || mvpPlayer.nombre}
                                </span>` : ''}
                        </div>

                    </div>

                    <div class="flex sm:flex-col gap-2 border-t sm:border-t-0 sm:border-l border-gray-100 pt-3 sm:pt-0 sm:pl-3 justify-end">
                        <button onclick="viewMatchDetails('${match.id}')" class="flex-1 px-3 py-1.5 text-xs font-bold bg-slate-100 text-slate-600 rounded hover:bg-slate-200 transition text-center">
                            üëÅÔ∏è VER
                        </button>
                        <button onclick="editMatch('${match.id}')" class="flex-1 px-3 py-1.5 text-xs font-bold bg-blue-50 text-blue-600 rounded hover:bg-blue-100 transition text-center">
                            ‚úèÔ∏è EDIT
                        </button>
                        <button onclick="deleteMatch('${match.id}')" class="px-3 py-1.5 text-xs font-bold bg-red-50 text-red-600 rounded hover:bg-red-100 transition text-center" title="Eliminar">
                            üóëÔ∏è
                        </button>
                    </div>
                </div>
            </div>
        `;
    }).join('');
}
        
function viewMatchDetails(matchId) {
    const matches = getData('matches');
    const match = matches.find(m => m.id === matchId);
    if (!match) return;

    // 1. Crear Modal
    let modal = document.getElementById('match-details-modal');
    if (!modal) {
        modal = document.createElement('div');
        modal.id = 'match-details-modal';
        modal.className = "fixed inset-0 bg-black/80 hidden z-[9999] items-center justify-center backdrop-blur-sm";
        // Aumentamos altura m√°xima para que quepa bien el campo grande
        modal.innerHTML = `<div id="match-details-content" class="bg-white rounded-xl w-full max-w-4xl h-[95vh] shadow-2xl overflow-hidden relative flex flex-col m-4"></div>`;
        document.body.appendChild(modal);
    }
    
    const content = document.getElementById('match-details-content');

    // 2. Timeline
    const timelineHtml = (typeof renderMatchTimeline === 'function') 
        ? renderMatchTimeline(match) 
        : '<div class="p-4 text-center text-gray-400">Timeline no disponible</div>';

    // 3. Generar Lista de Jugadores (Ahora m√°s ancha)
    const players = getPlayers();
    
    // Ordenar stats para visualizaci√≥n
    const sortedStats = [...match.playerStats].sort((a, b) => {
        if (a.isStarter && !b.isStarter) return -1;
        if (!a.isStarter && b.isStarter) return 1;
        if (a.isStarter && b.isStarter) {
             if (typeof a.pitchSlot === 'number' && typeof b.pitchSlot === 'number') {
                 return a.pitchSlot - b.pitchSlot;
             }
        }
        return 0;
    });

    const statsHtml = sortedStats.map(ps => {
        const p = players.find(pl => pl.id === ps.playerId) || { apodo: '?', apellido: '?' };
        if (!ps.played && !ps.isStarter && !ps.goals && !ps.yellowCards && !ps.redCards) return '';

        let metas = [];
        if (ps.goals > 0) metas.push(`<span class="bg-indigo-100 text-indigo-700 px-2 py-0.5 rounded text-xs font-bold">‚öΩ ${ps.detailGoals || ps.goals}</span>`);
        if (ps.assists > 0) metas.push(`<span class="bg-blue-50 text-blue-600 px-2 py-0.5 rounded text-xs">üëü ${ps.assists}</span>`);
        if (ps.yellowCards > 0) metas.push(`<span class="bg-yellow-100 text-yellow-700 px-1.5 py-0.5 rounded text-xs">üü®</span>`);
        if (ps.redCards > 0) metas.push(`<span class="bg-red-100 text-red-700 px-1.5 py-0.5 rounded text-xs">üü•</span>`);

        return `
            <div class="flex justify-between items-center py-3 border-b border-gray-100 last:border-0 hover:bg-gray-50 px-4 transition-colors">
                <div class="flex items-center gap-4">
                    <div class="w-8 text-center text-sm font-bold text-gray-400 bg-gray-100 rounded">${p.dorsal || '-'}</div>
                    <img src="${p.foto}" class="w-10 h-10 rounded-full object-cover border border-gray-200">
                    <div>
                        <div class="text-sm font-bold text-gray-800">${p.apodo}</div>
                        ${ps.isStarter ? '<span class="text-[10px] uppercase font-bold text-green-600">Titular</span>' : '<span class="text-[10px] uppercase font-bold text-gray-400">Suplente</span>'}
                    </div>
                </div>
                <div class="flex items-center gap-4">
                    <div class="flex gap-2">${metas.join('')}</div>
                    <div class="text-xs font-mono text-gray-500 bg-gray-100 px-2 py-1 rounded">Min ${ps.minutes}'</div>
                    <div class="w-10 h-10 flex items-center justify-center font-black text-lg rounded-lg ${getRatingColor ? getRatingColor(ps.rating) : 'bg-gray-200 text-gray-600'}">
                        ${ps.rating || '-'}
                    </div>
                </div>
            </div>
        `;
    }).join('');

    // 4. Inyectar HTML con PESTA√ëAS (Y BOT√ìN DE FOTO)
    content.innerHTML = `
        <div class="bg-slate-900 text-white p-4 shrink-0 relative overflow-hidden shadow-lg z-10 print:hidden">
            
            <div class="absolute top-4 right-4 flex gap-2 z-50">
                <button onclick="downloadMatchCard('${match.id}')" title="Descargar Ficha" 
                        class="text-white/50 hover:text-yellow-400 hover:bg-white/10 rounded-full w-8 h-8 flex items-center justify-center transition cursor-pointer">
                    üì∑
                </button>
                
                <button onclick="document.getElementById('match-details-modal').classList.add('hidden'); document.getElementById('match-details-modal').classList.remove('flex');" 
                        class="text-white/50 hover:text-white hover:bg-white/10 rounded-full w-8 h-8 flex items-center justify-center transition cursor-pointer">
                    ‚úï
                </button>
            </div>
            
            <div class="flex justify-between items-center relative z-10 max-w-3xl mx-auto">
                <div class="text-center w-1/3">
                    <div class="text-3xl font-bold tracking-tighter text-yellow-400 filter drop-shadow-lg">REAL MADRID</div>
                </div>
                <div class="text-center w-1/3">
                    <div class="text-5xl font-black mb-1">${match.result}</div>
                    <div class="text-xs uppercase tracking-widest text-white/60 bg-white/10 px-2 py-1 rounded-full inline-block">${match.opponent}</div>
                </div>
                <div class="text-center w-1/3 opacity-90">
                    <div class="text-2xl font-bold truncate">${match.opponent}</div>
                </div>
            </div>
        </div>

        <div class="bg-white border-b border-gray-200 shadow-sm z-0">
            ${timelineHtml}
        </div>

        <div class="flex border-b border-gray-200 bg-white shrink-0">
            <button id="btn-tab-stats" onclick="switchViewTab('stats')" class="flex-1 py-3 text-sm font-bold text-indigo-600 border-b-2 border-indigo-600 bg-indigo-50/50 transition">
                üìä Estad√≠sticas y Notas
            </button>
            <button id="btn-tab-pitch" onclick="switchViewTab('pitch')" class="flex-1 py-3 text-sm font-bold text-gray-400 border-b-2 border-transparent hover:text-gray-600 transition">
                üèüÔ∏è Esquema Inicial
            </button>
        </div>

        <div class="flex-1 overflow-hidden bg-gray-50 relative">
            
            <div id="view-tab-stats" class="absolute inset-0 overflow-y-auto p-4 animate-in fade-in duration-300">
                <div class="max-w-3xl mx-auto bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    ${statsHtml || '<div class="p-8 text-center text-gray-400">Sin datos registrados</div>'}
                </div>
            </div>

            <div id="view-tab-pitch" class="absolute inset-0 hidden p-4 animate-in fade-in duration-300 flex items-center justify-center">
                <div class="w-full max-w-4xl h-full max-h-[600px] bg-emerald-800 rounded-xl shadow-2xl border-4 border-white/20 overflow-hidden relative">
                     <div class="pitch-container w-full h-full" style="margin:0; border:none; border-radius:0; pointer-events: none;">
                        <div class="pitch-line-mid"></div><div class="pitch-circle"></div>
                        <div class="pitch-box-left" style="left:0; border-left:none;"></div>
                        <div class="pitch-box-right" style="right:0; border-right:none;"></div>
                        
                        <div id="readonly-pitch-players-layer"></div>
                     </div>
                     
                     <div class="absolute top-4 right-4 bg-black/50 text-white px-3 py-1 rounded-full text-xs font-bold backdrop-blur-sm border border-white/20">
                        ${match.formation || '4-3-3'}
                     </div>
                </div>
            </div>

        </div>
    `;

    // 5. RENDERIZAR PIZARRA (TRUCO GLOBAL)
    const savedPitch = { ...currentPitchPlayers };
    const savedForm = currentFormation;
    const savedSubs = [...currentSubstitutes];

    const tempPitch = {};
    match.playerStats.forEach(ps => {
        if (ps.isStarter && ps.pitchSlot !== undefined && ps.pitchSlot !== null) {
            tempPitch[`readonly-slot-${ps.pitchSlot}`] = ps.playerId;
        }
    });

    currentPitchPlayers = tempPitch;
    currentFormation = match.formation || "4-3-3";
    currentSubstitutes = [];

    if (typeof renderTacticalBoard === 'function') {
        renderTacticalBoard('readonly-');
    }

    currentPitchPlayers = savedPitch;
    currentFormation = savedForm;
    currentSubstitutes = savedSubs;

    // 6. MOSTRAR
    modal.classList.remove('hidden');
    modal.classList.add('flex');
}
/* ========================================================= */
/* üîÑ CAMBIAR PESTA√ëAS EN "VER DETALLES"                     */
/* ========================================================= */
function switchViewTab(tabName) {
    // Botones
    const btnStats = document.getElementById('btn-tab-stats');
    const btnPitch = document.getElementById('btn-tab-pitch');
    
    // Contenedores
    const contentStats = document.getElementById('view-tab-stats');
    const contentPitch = document.getElementById('view-tab-pitch');

    // Resetear estilos
    btnStats.className = "flex-1 py-3 text-sm font-bold text-gray-400 border-b-2 border-transparent hover:text-gray-600 transition";
    btnPitch.className = "flex-1 py-3 text-sm font-bold text-gray-400 border-b-2 border-transparent hover:text-gray-600 transition";
    
    contentStats.classList.add('hidden');
    contentPitch.classList.add('hidden');

    // Activar el seleccionado
    if (tabName === 'stats') {
        btnStats.className = "flex-1 py-3 text-sm font-bold text-indigo-600 border-b-2 border-indigo-600 bg-indigo-50/50";
        contentStats.classList.remove('hidden');
    } else {
        btnPitch.className = "flex-1 py-3 text-sm font-bold text-emerald-600 border-b-2 border-emerald-600 bg-emerald-50/50";
        contentPitch.classList.remove('hidden');
    }
}
        
        function deleteMatch(matchId) {
            if (!confirm('¬øEst√°s seguro de eliminar este partido?')) return;
            
            let matches = getData('matches');
            const matchToDelete = matches.find(m => m.id === matchId);
            if (!matchToDelete) return;
            
            const compName = matchToDelete.competition;
            matches = matches.filter(m => m.id !== matchId);
            saveData('matches', matches);
            
            recalculateCompetitionState(compName);
            
            renderMatches();
            renderCalendar(); 
        }
        
            // --- 1. FUNCI√ìN EDITAR PARTIDO (CORRECCI√ìN CSV: SOBRANTES AL BANQUILLO) ---
// Variable global temporal para la edici√≥n
let editPitchPlayers = {}; 

// Aseg√∫rate de tener estas variables globales accesibles o usa las que ya tengas en tu sistema
// Si tu sistema usa 'currentPitchPlayers' para todo, las usaremos, pero cuidado de no borrar un partido a medias en el wizard.
// Lo ideal es reutilizar las mismas variables pero limpi√°ndolas antes.

function editMatch(matchId) {
    const matches = getData('matches');
    const match = matches.find(m => m.id === matchId);
    if (!match) return alert("Error: Partido no encontrado.");

    const modal = document.getElementById('edit-match-modal');
    const content = document.getElementById('edit-match-content');
    
    if (!modal || !content) return alert("Falta HTML del modal");

    // Z-Index fix
    document.body.appendChild(modal);
    modal.dataset.matchId = matchId; 

    // --- CARGAR DATOS ---
    const players = getPlayers(); // Traemos a TODOS para rellenar la plantilla disponible
    currentPitchPlayers = {}; 
    currentSubstitutes = [];
    currentFormation = match.formation || "4-3-3"; 

    // 1. Rellenar Pizarra (Titulares)
    match.playerStats.forEach(ps => {
        // Ignorar entrenadores siempre
        const pInfo = players.find(pl => pl.id === ps.playerId);
        if (pInfo && pInfo.posicion === 'entrenador') return;

        if (ps.isStarter) {
            if (ps.pitchSlot !== null && ps.pitchSlot !== undefined) {
                currentPitchPlayers[`edit-slot-${ps.pitchSlot}`] = ps.playerId;
            } else {
                // Fallback
                for(let i=0; i<11; i++) {
                    if(!currentPitchPlayers[`edit-slot-${i}`]){ currentPitchPlayers[`edit-slot-${i}`]=ps.playerId; break;}
                }
            }
        } else if (ps.played) {
            // 2. Rellenar Caja Azul (Suplentes que jugaron)
            currentSubstitutes.push(ps.playerId);
        }
    });

    // --- HTML ESTRUCTURA HORIZONTAL ---
    content.innerHTML = `
        <div class="h-full flex flex-col bg-gray-50">
            
            <div class="bg-white p-3 border-b border-gray-200 shadow-sm shrink-0 grid grid-cols-1 md:grid-cols-4 gap-3">
                 <input type="hidden" id="edit-match-id" value="${match.id}">
                 <div>
                    <label class="text-[10px] font-bold text-gray-400">RESULTADO</label>
                    <input type="text" id="edit-result-val" value="${match.result}" class="w-full border rounded px-2 py-1 font-bold text-center">
                 </div>
                 <div class="md:col-span-3 flex items-end pb-1">
                    <div class="w-full bg-amber-50 border border-amber-200 text-amber-700 px-3 py-1 rounded text-xs font-bold flex justify-between">
                        <span>RIVAL: ${match.opponent}</span>
                        <span>RONDA: ${match.round}</span>
                    </div>
                 </div>
            </div>

            <div id="edit-step-lineup" class="flex flex-col flex-1 h-full p-2 overflow-hidden">
                
                <div class="mb-2 flex justify-between items-center bg-white p-2 rounded-xl border shadow-sm">
                    <div class="flex items-center gap-2">
                        <span class="text-xs font-bold text-gray-500">ESQUEMA:</span>
                        <select id="edit-formation-select" class="border rounded text-sm font-bold p-1 bg-gray-50" onchange="updatePitchFormation('edit-')">
                            <option value="4-3-3" ${currentFormation==='4-3-3'?'selected':''}>4-3-3</option>
                            <option value="4-4-2" ${currentFormation==='4-4-2'?'selected':''}>4-4-2</option>
                            <option value="4-2-3-1" ${currentFormation==='4-2-3-1'?'selected':''}>4-2-3-1</option>
                            <option value="3-5-2" ${currentFormation==='3-5-2'?'selected':''}>3-5-2</option>
                        </select>
                    </div>
                    <button onclick="goToEditStats()" class="bg-slate-800 hover:bg-slate-700 text-white font-bold py-1.5 px-4 rounded shadow text-xs flex items-center gap-1">
                        Siguiente: Stats ‚û°Ô∏è
                    </button>
                </div>

                <div class="flex flex-col md:flex-row gap-2 h-[550px] min-h-0">
                    
                    <div class="flex-1 relative bg-emerald-800 rounded-xl border-4 border-white/20 overflow-hidden shadow-xl">
                        <div class="pitch-container w-full h-full" style="margin:0; border:none; border-radius:0;">
                            <div class="pitch-line-mid"></div><div class="pitch-circle"></div>
                            <div class="pitch-box-left" style="left:0; border-left:none;"></div>
                            <div class="pitch-box-right" style="right:0; border-right:none;"></div>
                            
                            <div id="edit-pitch-players-layer"></div>
                        </div>
                    </div>

                    <div class="w-full md:w-64 flex flex-col gap-2 h-full">
                        
                        <div class="flex-1 bg-white rounded-xl border border-gray-300 flex flex-col shadow-sm overflow-hidden">
                            <div class="bg-gray-100 p-1.5 border-b text-[10px] font-bold text-center text-gray-500 uppercase">Plantilla Disponible</div>
                            <div id="edit-bench-zone" class="flex-1 overflow-y-auto bg-gray-50" ondragover="allowDrop(event)" ondrop="dropToBench(event, 'edit-')"></div>
                        </div>

                        <div class="h-1/3 bg-blue-50 rounded-xl border-2 border-dashed border-blue-300 flex flex-col overflow-hidden">
                            <div class="bg-blue-100 p-1.5 border-b border-blue-200 text-[10px] font-bold text-center text-blue-600 uppercase">Suplentes (Jugaron)</div>
                            <div id="edit-subs-zone" class="flex-1 p-2 flex flex-wrap gap-2 content-start overflow-y-auto" ondragover="allowDrop(event)" ondrop="dropToSubs(event, 'edit-')"></div>
                        </div>

                    </div>
                </div>
            </div>

            <div id="edit-step-stats" class="hidden flex-col flex-1 h-full p-4 overflow-hidden">
                <div id="edit-stats-list" class="flex-1 overflow-y-auto border rounded-xl p-4 bg-white space-y-2"></div>
                <div class="flex justify-end gap-3 pt-4 border-t mt-2">
                    <button onclick="backToEditLineup()" class="text-gray-500 font-bold px-4">‚¨ÖÔ∏è Volver a Pizarra</button>
                    <button onclick="handleEditMatchSubmit()" class="bg-emerald-600 text-white font-bold py-2 px-6 rounded shadow hover:bg-emerald-700">üíæ GUARDAR CAMBIOS</button>
                </div>
            </div>
        </div>
    `;

    // 4. RENDERIZAR
    renderTacticalBoard('edit-'); 
    renderBench('edit-');

    modal.classList.remove('hidden');
    modal.classList.add('flex');
    modal.style.display = 'flex';
}

function renderEditStatsList(match, allPlayers) {
    const statsList = document.getElementById('edit-stats-list');
    
    // Combinamos los jugadores del campo + banquillo actuales para asegurar consistencia
    // OJO: Usamos los datos guardados en 'match' como base, pero la lista debe reflejar todos
    
    let participants = match.playerStats.map(ps => {
        const pInfo = allPlayers.find(pl => pl.id === ps.playerId) || { apodo: '?', foto: '' };
        return { ...pInfo, ...ps };
    });
    
    participants.sort((a, b) => {
        if (a.isStarter && !b.isStarter) return -1;
        if (!a.isStarter && b.isStarter) return 1;
        if (a.isStarter && b.isStarter) {
             if (typeof a.pitchSlot === 'number' && typeof b.pitchSlot === 'number') {
                 return a.pitchSlot - b.pitchSlot;
             }
        }
        return 0;
    });

    statsList.innerHTML = participants.map(p => {
        const prefix = 'edit-'; 
        const goalId = `${prefix}goals-${p.playerId}`;
        const assistId = `${prefix}assists-${p.playerId}`;
        const yellowId = `${prefix}yellow-${p.playerId}`;
        const redId = `${prefix}red-${p.playerId}`;

        const isStarter = p.isStarter; // Esto se actualizar√° al guardar seg√∫n la pizarra
        let badgeHtml = isStarter 
            ? `<span class="bg-emerald-100 text-emerald-700 text-[10px] font-bold px-2 py-1 rounded border border-emerald-200 uppercase">TITULAR</span>`
            : '<span class="bg-blue-50 text-blue-600 text-[10px] font-bold px-2 py-1 rounded border border-blue-100 uppercase">SUPLENTE</span>';

        const btnClass = "w-full h-8 bg-white border border-gray-300 rounded text-xs font-bold hover:border-indigo-400 flex items-center justify-center";
        const getStyle = (c) => c > 0 ? "bg-indigo-100 text-indigo-700 border-indigo-300" : "text-gray-600";
        const getCardStyle = (c, color) => c > 0 ? `bg-${color}-100 text-${color}-700 border-${color}-300` : `bg-${color}-50 text-${color}-700/50 border-${color}-100`;

        return `
        <div class="bg-white rounded p-2 border border-gray-200 flex flex-col md:flex-row items-center gap-3 shadow-sm" 
             data-player-id="${p.playerId}"> 
             
            <div class="flex items-center gap-2 w-full md:w-1/3">
                <img src="${p.foto}" class="w-8 h-8 rounded-full border">
                <div class="min-w-0">
                    <div class="flex items-center gap-2">
                        <span class="font-bold text-gray-800 text-sm truncate">${p.apodo}</span>
                        ${badgeHtml}
                    </div>
                </div>
            </div>

            <div class="flex-1 grid grid-cols-5 gap-2 w-full">
                <div><label class="text-[8px] font-bold text-gray-400">NOTA</label>
                <input type="number" class="stat-rating w-full h-8 px-1 border rounded text-center text-sm font-bold" min="0" max="10" step="0.1" value="${p.rating || ''}"></div>

                <div><label class="text-[8px] font-bold text-gray-400">GOL</label>
                <input type="hidden" class="stat-goals-minutes" id="${goalId}" value="${p.detailGoals || ''}">
                <button onclick="openMinuteModal('${goalId}', 'Goles')" class="${btnClass} ${getStyle(p.goals)}">${p.goals}</button></div>

                <div><label class="text-[8px] font-bold text-gray-400">ASIS</label>
                <input type="hidden" class="stat-assists-minutes" id="${assistId}" value="${p.detailAssists || ''}">
                <button onclick="openMinuteModal('${assistId}', 'Asistencias')" class="${btnClass} ${getStyle(p.assists)}">${p.assists}</button></div>
                
                <div><label class="text-[8px] font-bold text-gray-400">MIN</label>
                <input type="number" class="stat-minutes w-full h-8 px-1 border rounded text-center text-sm font-mono" value="${p.minutes}"></div>

                <div class="flex gap-1">
                    <div class="flex-1"><label class="text-[8px] font-bold text-gray-400">AMA</label>
                    <input type="hidden" class="stat-yellow-minutes" id="${yellowId}" value="${p.detailYellow || ''}">
                    <button onclick="openMinuteModal('${yellowId}', 'Amarilla')" class="${btnClass} ${getCardStyle(p.yellowCards, 'yellow')}">${p.yellowCards}</button></div>
                    
                    <div class="flex-1"><label class="text-[8px] font-bold text-gray-400">ROJ</label>
                    <input type="hidden" class="stat-red-minutes" id="${redId}" value="${p.detailRed || ''}">
                    <button onclick="openMinuteModal('${redId}', 'Roja')" class="${btnClass} ${getCardStyle(p.redCards, 'red')}">${p.redCards}</button></div>
                </div>
            </div>
        </div>`;
    }).join('');
}

// --- FUNCI√ìN AUXILIAR PARA CAMBIAR PESTA√ëAS ---
function switchEditTab(tabName) {
    const tabLineup = document.getElementById('edit-tab-lineup');
    const tabStats = document.getElementById('edit-tab-stats');
    const btnLineup = document.getElementById('tab-btn-lineup');
    const btnStats = document.getElementById('tab-btn-stats');

    if (tabName === 'lineup') {
        tabLineup.classList.remove('hidden');
        tabStats.classList.add('hidden');
        // Estilos Botones
        btnLineup.classList.add('text-indigo-600', 'border-indigo-600');
        btnLineup.classList.remove('text-gray-500', 'border-transparent');
        btnStats.classList.remove('text-indigo-600', 'border-indigo-600');
        btnStats.classList.add('text-gray-500', 'border-transparent');
    } else {
        tabLineup.classList.add('hidden');
        tabStats.classList.remove('hidden');
        // Estilos Botones
        btnStats.classList.add('text-indigo-600', 'border-indigo-600');
        btnStats.classList.remove('text-gray-500', 'border-transparent');
        btnLineup.classList.remove('text-indigo-600', 'border-indigo-600');
        btnLineup.classList.add('text-gray-500', 'border-transparent');
    }
}

// --- FUNCI√ìN AUXILIAR PARA PINTAR LA PIZARRA DE EDICI√ìN ---
function renderEditPitchVisuals(allPlayers) {
    const container = document.getElementById('edit-pitch-container');
    container.innerHTML = ''; // Limpiar

    // Coordenadas fijas (basadas en 4-4-2 o lo que uses, simplificado)
    // Usamos porcentajes para que escale. [top%, left%]
    const formationSlots = [
        {t: 85, l: 45}, // 0: Portero
        {t: 65, l: 15}, {t: 65, l: 35}, {t: 65, l: 55}, {t: 65, l: 75}, // Defensas
        {t: 40, l: 15}, {t: 40, l: 35}, {t: 40, l: 55}, {t: 40, l: 75}, // Medios
        {t: 15, l: 35}, {t: 15, l: 55}  // Delanteros
    ];
    // NOTA: Si quieres usar tu formaci√≥n real (4-3-3, etc), tendr√≠as que importar tus coordenadas 'POSITIONS'. 
    // Por simplicidad, aqu√≠ pinto 11 huecos gen√©ricos, pero si tu 'renderMatches' usa coordenadas reales, c√≥pialas aqu√≠.

    // Recorremos los 11 slots posibles
    for (let i = 0; i < 11; i++) {
        const playerId = editPitchPlayers[`edit-slot-${i}`];
        if (playerId) {
            const player = allPlayers.find(p => p.id === playerId);
            if (player) {
                // Posici√≥n (Si tienes las coordenadas reales importadas, √∫salas. Si no, usa el array simple de arriba)
                // Si tu app ya tiene variable 'POSITIONS', usa: const pos = POSITIONS['4-3-3'][i];
                const pos = formationSlots[i] || {t: 50, l: 50}; 

                const el = document.createElement('div');
                el.className = "absolute flex flex-col items-center justify-center w-16 transform -translate-x-1/2 -translate-y-1/2 transition-all";
                el.style.top = pos.t + '%';
                el.style.left = pos.l + '%';
                
                el.innerHTML = `
                    <div class="w-10 h-10 rounded-full border-2 border-white shadow-lg overflow-hidden bg-white">
                        <img src="${player.foto}" class="w-full h-full object-cover">
                    </div>
                    <span class="mt-1 bg-black/70 text-white text-[9px] font-bold px-1.5 py-0.5 rounded shadow backdrop-blur-sm truncate max-w-full">
                        ${player.apodo}
                    </span>
                `;
                container.appendChild(el);
            }
        }
    }
}
function executeEditSave() {
    console.log("üíæ Ejecutando guardado...");

    // 1. RECUPERAR ID DEL TATUAJE
    const modal = document.getElementById('edit-match-modal');
    const matchId = modal.dataset.matchId;

    if (!matchId) {
        alert("‚ùå Error Cr√≠tico: El modal ha perdido el ID del partido.");
        return;
    }

    const matches = getData('matches');
    const matchIndex = matches.findIndex(m => m.id === matchId); // OJO: Si id es n√∫mero, usar ==, si es string ===
    
    if (matchIndex === -1) { 
        alert("‚ùå Error: No se encuentra el partido en la base de datos."); 
        return; 
    }
    
    const match = matches[matchIndex];
    const statsContainer = document.getElementById('edit-stats-list');
    const playerStats = [];
    
    // 2. LEER DATOS
    statsContainer.querySelectorAll('[data-player-id]').forEach(row => {
        const playerId = row.getAttribute('data-player-id');
        const specificPos = row.getAttribute('data-specific-pos');
        const isBadgeStarter = row.querySelector('.bg-emerald-100') !== null;
        
        // LEER INPUTS OCULTOS
        const goalsStr = row.querySelector('.stat-goals-minutes')?.value || "";
        const assistsStr = row.querySelector('.stat-assists-minutes')?.value || "";
        const yellowStr = row.querySelector('.stat-yellow-minutes')?.value || "";
        const redStr = row.querySelector('.stat-red-minutes')?.value || "";

        const countItems = (str) => (!str || str.trim() === "") ? 0 : str.split(',').filter(s => s.trim() !== '').length;

        const goals = countItems(goalsStr);
        const assists = countItems(assistsStr);
        const yellow = countItems(yellowStr);
        const red = countItems(redStr);

        const ratingVal = row.querySelector('.stat-rating')?.value;
        const rating = (ratingVal === "" || ratingVal === null) ? null : parseFloat(ratingVal);
        const minVal = row.querySelector('.stat-minutes')?.value;
        const minutes = (parseInt(minVal) || 0);

        playerStats.push({
            playerId: playerId,
            isStarter: isBadgeStarter,
            specificPosition: specificPos,
            rating: rating,
            goals: goals,
            assists: assists,
            minutes: minutes,
            yellowCards: yellow,
            redCards: red,
            played: minutes > 0,
            detailGoals: goalsStr,
            detailAssists: assistsStr,
            detailYellow: yellowStr,
            detailRed: redStr
        });
    });

    const result = document.getElementById('edit-result-val').value;
    const roundId = document.getElementById('edit-round-select').value;
    const outcome = calculateMatchOutcome(result, match.venue);

    // 3. GUARDAR
    matches[matchIndex] = {
        ...match,
        result: result,
        roundId: roundId,
        outcome: outcome,
        mvp: calculateAutoMVP(playerStats),
        playerStats: playerStats
    };
    
    saveData('matches', matches);
    
    // 4. CERRAR Y REFRESCAR
    closeEditMatchModal();
    renderMatches();
    
    if (typeof renderCompetitionStatus === 'function') renderCompetitionStatus();
    if (typeof renderPrincipal === 'function') renderPrincipal();
    
    console.log("‚úÖ Guardado con √©xito.");
}
function saveMatchChanges(matchId) {
    console.log("üíæ Guardando cambios para:", matchId);
    
    const matches = getData('matches');
    const matchIndex = matches.findIndex(m => m.id === matchId);
    if (matchIndex === -1) { alert("‚ùå Error al guardar: No encuentro el partido"); return; }
    
    const match = matches[matchIndex];
    const statsContainer = document.getElementById('edit-stats-list');
    const playerStats = [];
    
    // Recorrer filas
    statsContainer.querySelectorAll('[data-player-id]').forEach(row => {
        const playerId = row.getAttribute('data-player-id');
        const specificPos = row.getAttribute('data-specific-pos');
        
        // Detectar titularidad (si tiene badge verde)
        const isBadgeStarter = row.querySelector('.bg-emerald-100') !== null;
        const isStarter = isBadgeStarter;

        // LEER INPUTS OCULTOS
        const goalsStr = row.querySelector('.stat-goals-minutes')?.value || "";
        const assistsStr = row.querySelector('.stat-assists-minutes')?.value || "";
        const yellowStr = row.querySelector('.stat-yellow-minutes')?.value || "";
        const redStr = row.querySelector('.stat-red-minutes')?.value || "";

        // Funci√≥n contar
        const countItems = (str) => (!str || str.trim() === "") ? 0 : str.split(',').filter(s => s.trim() !== '').length;

        const goals = countItems(goalsStr);
        const assists = countItems(assistsStr);
        const yellow = countItems(yellowStr);
        const red = countItems(redStr);

        // Inputs normales
        const ratingVal = row.querySelector('.stat-rating')?.value;
        const rating = (ratingVal === "" || ratingVal === null) ? null : parseFloat(ratingVal);
        
        const minVal = row.querySelector('.stat-minutes')?.value;
        const minutes = (parseInt(minVal) || 0);

        playerStats.push({
            playerId: playerId,
            isStarter: isStarter,
            specificPosition: specificPos,
            rating: rating,
            goals: goals,
            assists: assists,
            minutes: minutes,
            yellowCards: yellow,
            redCards: red,
            played: minutes > 0,
            
            // GUARDAR DETALLES
            detailGoals: goalsStr,
            detailAssists: assistsStr,
            detailYellow: yellowStr,
            detailRed: redStr
        });
    });

    // Leer resultado general
    const result = document.getElementById('edit-result-val').value;
    const roundId = document.getElementById('edit-round-select').value;
    const outcome = calculateMatchOutcome(result, match.venue);

    // Actualizar objeto
    matches[matchIndex] = {
        ...match,
        result: result,
        roundId: roundId,
        outcome: outcome,
        mvp: calculateAutoMVP(playerStats),
        playerStats: playerStats
    };
    
    saveData('matches', matches);
    
    // Cerrar y refrescar
    closeEditMatchModal();
    
    renderMatches(); // Recargar lista visual
    
    // Opcional: Recalcular tablas
    if (typeof renderCompetitionStatus === 'function') renderCompetitionStatus();
    if (typeof renderPrincipal === 'function') renderPrincipal();
    
    alert('‚úÖ Cambios guardados correctamente.');
}

        
function closeEditMatchModal() {
    const modal = document.getElementById('edit-match-modal');
    
    if (modal) {
        // 1. A√±adir la clase de ocultar de Tailwind
        modal.classList.add('hidden');
        modal.classList.remove('flex');
        
        // 2. IMPORTANTE: Sobrescribir el estilo en l√≠nea
        // Esto anula el 'display: flex' que pusimos al abrir
        modal.style.display = 'none'; 
        
        console.log("üîí Modal cerrado correctamente.");
    }
}
        
        function closePlayerStatusModal() {
             document.getElementById('player-status-modal').classList.remove('active');
        }
               
        function closeMatchDetailModal() {
             document.getElementById('match-detail-modal').classList.remove('active');
        }
        
        function openPlayerStatusModal(playerId) {
            const players = getPlayers();
            const player = players.find(p => p.id === playerId);
            if (!player) return;
            
            const modal = document.getElementById('player-status-modal');
            const content = document.getElementById('player-status-content');
            
            content.innerHTML = `
                <div class="text-center mb-6">
                    <img src="${player.foto}" class="player-photo mx-auto mb-3 border-4 ${player.estado === 'Activo' ? 'border-amber-400' : 'border-gray-300'}">
                    <h4 class="font-bold text-lg">${player.nombre} ${player.apellido}</h4>
                    <p class="text-gray-500">Estado actual: <strong>${player.estado}</strong></p>
                </div>
                <div class="space-y-3">
                    <button onclick="changePlayerStatus('${player.id}', 'Activo')" class="w-full py-3 rounded-lg font-medium bg-green-500 text-white">‚úÖ Activo</button>
                    <button onclick="changePlayerStatus('${player.id}', 'Inactivo')" class="w-full py-3 rounded-lg font-medium bg-gray-500 text-white">‚ùå Inactivo</button>
                </div>
            `;
            modal.classList.add('active');
        }
        
        function changePlayerStatus(playerId, newStatus) {
            updatePlayerState(playerId, newStatus);
            closePlayerStatusModal();
            renderPlayers();
        }
        // ==========================================
        // EXTRA ROUND LOGIC (CHAMPIONS/UWCL)
        // ==========================================

        let pendingExtraRoundComp = null;

        function checkExtraRoundTrigger(match) {
            // Identificadores del "√öltimo partido de liga"
            const MEN_LAST_LEAGUE = 'fase-liga-8'; // Masculino
            const WOMEN_LAST_LEAGUE = 'grupos-6';  // Femenino
            
            if (match.roundId === MEN_LAST_LEAGUE || match.roundId === WOMEN_LAST_LEAGUE) {
                pendingExtraRoundComp = match.competition;
                
                // Mostrar Modal
                document.getElementById('extra-round-modal').classList.add('active');
                return true; // Indica que se ha disparado el trigger (pausando el cierre)
            }
            return false;
        }

        function confirmExtraRound() {
            const playExtra = document.getElementById('chk-play-extra').checked;
            
            if (pendingExtraRoundComp) {
                const state = getCompetitionState();
                if (!state[pendingExtraRoundComp]) state[pendingExtraRoundComp] = {};
                
                // Guardamos la decisi√≥n: TRUE (juega) o FALSE (salta directo a octavos/cuartos)
                state[pendingExtraRoundComp].playsExtra = playExtra;
                saveCompetitionState(state);
            }
            
            document.getElementById('extra-round-modal').classList.remove('active');
            
            // Refrescar y salir como si hubiera terminado el registro normal
            resetNewMatchForm();
            renderCompetitionStatus();
            populateCompetitionSelect();
            alert('‚úÖ Partido registrado y configuraci√≥n de fase final actualizada.');
            showTab('partidos');
        }

        // ==========================================
        // UTILS
        // ==========================================
        
        function formatDate(dateStr) {
            return new Date(dateStr).toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' });
        }
        
        function calculateAge(birthdate) {
            const today = new Date();
            const birth = new Date(birthdate);
            let age = today.getFullYear() - birth.getFullYear();
            const m = today.getMonth() - birth.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;
            return age;
        }
        
        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }
        function switchLineupMode(mode) {
            const listContainer = document.getElementById('mode-list-container');
            const pitchContainer = document.getElementById('mode-pitch-container');
            const btnList = document.getElementById('btn-mode-list');
            const btnPitch = document.getElementById('btn-mode-pitch');

            if (mode === 'list') {
                listContainer.classList.remove('hidden');
                pitchContainer.classList.add('hidden');
                
                btnList.classList.add('bg-white', 'shadow', 'text-gray-800', 'font-medium');
                btnList.classList.remove('text-gray-500');
                
                btnPitch.classList.remove('bg-white', 'shadow', 'text-gray-800', 'font-medium');
                btnPitch.classList.add('text-gray-500');
            } else {
                listContainer.classList.add('hidden');
                pitchContainer.classList.remove('hidden');
                
                btnPitch.classList.add('bg-white', 'shadow', 'text-gray-800', 'font-medium');
                btnPitch.classList.remove('text-gray-500');
                
                btnList.classList.remove('bg-white', 'shadow', 'text-gray-800', 'font-medium');
                btnList.classList.add('text-gray-500');
                
                // Aqu√≠ llamaremos a renderizar la pizarra en la Fase 2
                // renderTacticalBoard(); 
            }
        }
        // ==========================================
        // TACTICAL BOARD LOGIC (FASE 2)
        // ==========================================

        let currentPitchPlayers = {}; // Guardar√° { "slot-0": playerId, "slot-1": playerId... }
        let currentSubstitutes = [];
        let currentFormation = '4-3-3'; // Formaci√≥n por defecto

function updatePitchFormation(prefix = '') {
    // 1. Detectar el ID correcto del selector
    let selectId = 'formation-select'; // Default (Registrar Partido)
    
    if (prefix === 'edit-') selectId = 'edit-formation-select';
    else if (prefix === 'wizard-') selectId = 'new-formation';
    
    const select = document.getElementById(selectId);
    
    if (select) {
        currentFormation = select.value; // Actualizamos variable global
        // 2. Re-renderizar la pizarra correcta
        renderTacticalBoard(prefix);
    }
}

/* ========================================================= */
/* üé® RENDERIZADOR DE PIZARRA (BLINDADO Z-INDEX)             */
/* ========================================================= */

function renderTacticalBoard(prefix = 'wizard-') {
    const containerId = prefix + 'pitch-players-layer'; 
    const container = document.getElementById(containerId);
    
    if (!container) {
        const fallback = document.getElementById(prefix + 'pitch-formation');
        if(!fallback) return; 
    }

    if(container) {
        container.innerHTML = '';
        container.style.position = "absolute";
        container.style.inset = "0";
        container.style.zIndex = "50"; 
        container.style.pointerEvents = "none"; 
    }
    
    const allPlayers = getPlayers();
    const currentForm = (typeof currentFormation !== 'undefined') ? currentFormation : '4-3-3';
    
    const horizontalCoords = {
        "4-3-3": [{t:50,l:5}, {t:20,l:25},{t:40,l:25},{t:60,l:25},{t:80,l:25}, {t:30,l:50},{t:50,l:50},{t:70,l:50}, {t:20,l:75},{t:50,l:75},{t:80,l:75}],
        "4-4-2": [{t:50,l:5}, {t:15,l:25},{t:38,l:25},{t:62,l:25},{t:85,l:25}, {t:15,l:50},{t:38,l:50},{t:62,l:50},{t:85,l:50}, {t:35,l:75},{t:65,l:75}],
        "4-2-3-1": [{t:50,l:5}, {t:15,l:25},{t:38,l:25},{t:62,l:25},{t:85,l:25}, {t:35,l:45},{t:65,l:45}, {t:15,l:65},{t:50,l:65},{t:85,l:65}, {t:50,l:82}],
        "3-5-2": [{t:50,l:5}, {t:25,l:25},{t:50,l:25},{t:75,l:25}, {t:15,l:50},{t:35,l:50},{t:50,l:40},{t:65,l:50},{t:85,l:50}, {t:35,l:75},{t:65,l:75}]
    };
    
    const coords = horizontalCoords[currentForm] || horizontalCoords["4-3-3"];

    for (let i = 0; i < 11; i++) {
        const slotKey = `${prefix}slot-${i}`;
        const playerId = currentPitchPlayers[slotKey];
        
        const div = document.createElement('div');
        div.id = slotKey; 
        div.className = "absolute w-10 h-10 md:w-12 md:h-12 transform -translate-x-1/2 -translate-y-1/2 flex items-center justify-center group";
        div.style.zIndex = "100"; 
        div.style.pointerEvents = "auto"; 
        div.style.cursor = "pointer";

        // Eventos Drop
        div.setAttribute("ondragover", "allowDrop(event)");
        div.setAttribute("ondrop", "drop(event)");
        div.setAttribute('data-current-slot', slotKey); 
        div.setAttribute("onclick", `openPlayerSelector('${slotKey}')`);

        const pos = coords[i] || {t: 50, l: 50}; 
        div.style.top = pos.t + '%';
        div.style.left = pos.l + '%';

        if (playerId) {
            const p = allPlayers.find(pl => pl.id === playerId);
            if (p) {
                div.draggable = true;
                div.ondragstart = (e) => drag(e);
                div.setAttribute('data-player-id', playerId);
                div.style.cursor = "grab";

                div.innerHTML = `
                    <div class="w-full h-full rounded-full border-2 border-white shadow-md overflow-hidden bg-white hover:scale-110 transition-transform pointer-events-none relative z-10">
                        <img src="${p.foto}" class="w-full h-full object-cover">
                    </div>
                    <div class="absolute -bottom-3 left-1/2 transform -translate-x-1/2 bg-black/70 text-white text-[8px] px-1.5 rounded font-bold whitespace-nowrap pointer-events-none z-20">
                        ${p.apodo}
                    </div>
                    
                    <div onclick="event.stopPropagation(); removePlayerFromAllZones('${p.id}')" 
                         class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-4 h-4 flex items-center justify-center text-xs opacity-0 group-hover:opacity-100 cursor-pointer transition-opacity z-50 pointer-events-auto hover:scale-110 shadow-sm border border-white">
                         √ó
                    </div>
                `;
            }
        } else {
            div.draggable = false;
            div.innerHTML = `
                <div class="w-full h-full rounded-full border-2 border-dashed border-white/50 flex items-center justify-center group-hover:border-white transition-colors bg-white/10 pointer-events-none">
                    <span class="text-white/80 text-xs font-bold">${i + 1}</span>
                </div>
            `;
        }
        if(container) container.appendChild(div);
    }
}



// A√ëADIDO: Nuevo par√°metro 'delayIndex' al final (por defecto 0)
function renderPlayerOnPitch(player, slotId, container, delayIndex = 0) {
    const slotEl = document.getElementById(slotId);
    if (!slotEl) return;

    const div = document.createElement('div');
    
    // Clases de animaci√≥n y estilo
    div.className = 'player-token hover:scale-110 transition-transform cursor-pointer pointer-events-auto animate-drop'; 
    
    div.style.position = 'absolute';
    div.style.top = slotEl.style.top;
    div.style.left = slotEl.style.left;
    div.style.zIndex = '50'; 
    div.style.pointerEvents = 'auto';
    div.style.animationDelay = `${delayIndex * 0.05}s`;

    div.draggable = true;
    div.id = `token-${player.id}`;
    
    div.setAttribute('data-player-id', player.id);
    div.setAttribute('data-current-slot', slotId);
    
    div.ondragstart = drag;
    
    // --- NUEVO: CLIC DERECHO PARA CAPIT√ÅN ¬© ---
    div.oncontextmenu = (e) => {
        e.preventDefault();  // Evita que salga el men√∫ del navegador
        e.stopPropagation(); // Evita conflictos con el fondo
        toggleCaptain(player.id); // Llama a tu funci√≥n de capit√°n
    };

    // CLIC IZQUIERDO (NORMAL) PARA CAMBIAR JUGADOR
    div.onclick = (e) => {
        e.stopPropagation();
        openPlayerSelector(slotId);
    };
    
    div.ondragover = allowDrop;
    div.ondrop = drop;

    // FOTOS CON CROSSORIGIN
    div.innerHTML = `
        <img src="${player.foto}" 
             crossorigin="anonymous" 
             draggable="false" 
             style="pointer-events: none;" 
             onerror="this.src='https://via.placeholder.com/40x40?text=${player.dorsal}'">
        <div class="player-token-name" style="pointer-events: none;">${player.apodo || player.apellido}</div>
    `;
    
    // --- L√ìGICA DEL BRAZALETE ---
    // Se a√±ade DESPU√âS del innerHTML para que no se borre
    if (typeof currentCaptainId !== 'undefined' && currentCaptainId === player.id) {
        const badge = document.createElement('div');
        badge.className = 'captain-badge'; // Aseg√∫rate de tener el CSS que te pas√©
        badge.innerText = 'C';
        div.appendChild(badge);
    }

    container.appendChild(div);
}
function renderBench(prefix = 'wizard-') {
    const allPlayers = getPlayers();
    const activeIds = Object.values(currentPitchPlayers); // En campo
    const subIds = currentSubstitutes || []; // En zona azul

    // --- 1. ZONA SUPLENTES (CAJA AZUL) ---
    const subsContainer = document.getElementById(prefix + 'subs-zone');
    
    if (subsContainer) {
        subsContainer.innerHTML = '';
        
        // ¬°ESTO ES LO QUE FALTABA! ACTIVAR EL DROP
        subsContainer.setAttribute('ondragover', 'allowDrop(event)');
        subsContainer.setAttribute('ondrop', `dropToSubs(event, '${prefix}')`);
        
        // Pintar jugadores
        subIds.forEach(id => {
            const p = allPlayers.find(pl => pl.id === id);
            if (p && p.posicion !== 'entrenador') {
                const el = document.createElement('div');
                el.className = "relative w-10 h-10 cursor-move group m-1";
                el.draggable = true;
                el.ondragstart = (e) => drag(e);
                el.setAttribute('data-player-id', p.id);
                el.id = `${prefix}sub-${p.id}`;
                
                el.innerHTML = `
                    <div class="w-full h-full rounded-full border-2 border-blue-400 overflow-hidden bg-white hover:scale-110 transition-transform shadow-sm pointer-events-none">
                        <img src="${p.foto}" class="w-full h-full object-cover">
                    </div>
                    <div onclick="event.stopPropagation(); removeFromSubs('${p.id}'); renderAll('${prefix}');" class="absolute -top-1 -right-1 bg-red-500 text-white rounded-full w-3.5 h-3.5 flex items-center justify-center text-[8px] opacity-0 group-hover:opacity-100 cursor-pointer shadow z-50 pointer-events-auto">√ó</div>
                `;
                subsContainer.appendChild(el);
            }
        });
    }

    // --- 2. ZONA PLANTILLA (CAJA BLANCA) ---
    const benchContainer = document.getElementById(prefix + 'bench-zone') || document.getElementById(prefix + 'bench-container');
    
    if (benchContainer) {
        benchContainer.innerHTML = '';
        
        // ¬°ESTO ES LO QUE FALTABA! ACTIVAR EL DROP PARA DEVOLVER JUGADORES
        benchContainer.setAttribute('ondragover', 'allowDrop(event)');
        benchContainer.setAttribute('ondrop', `dropToBench(event, '${prefix}')`);
        
        // Filtramos: Ni en campo, ni en caja azul, ni entrenadores
        const available = allPlayers.filter(p => 
            !activeIds.includes(p.id) && 
            !subIds.includes(p.id) && 
            p.posicion !== 'entrenador'
        );

        // Estilo GRID
        benchContainer.className = "flex flex-wrap gap-2 content-start p-2 min-h-[100px]"; // Min-height para que siempre haya sitio para soltar

        available.forEach(p => {
            const el = document.createElement('div');
            el.className = "relative w-10 h-10 cursor-move opacity-90 hover:opacity-100 transition-opacity";
            el.draggable = true;
            el.ondragstart = (e) => drag(e);
            el.setAttribute('data-player-id', p.id);
            el.id = `${prefix}pool-${p.id}`;

            el.innerHTML = `
                <div class="w-full h-full rounded-full border border-gray-300 overflow-hidden bg-white shadow-sm hover:border-indigo-500 hover:ring-2 hover:ring-indigo-200 transition-all pointer-events-none">
                    <img src="${p.foto}" class="w-full h-full object-cover" title="${p.apodo}">
                </div>
            `;
            benchContainer.appendChild(el);
        });
    }
}

   /* ========================================================= */
/* üéÆ MOTOR T√ÅCTICO FINAL (Soporta IDs viejos y nuevos)      */
/* ========================================================= */

function allowDrop(ev) { ev.preventDefault(); }

function drag(ev) {
    const playerId = ev.target.getAttribute('data-player-id');
    ev.dataTransfer.setData("playerId", playerId);
    
    // Buscar origen
    let sourceSlotId = ev.target.getAttribute('data-current-slot');
    if (!sourceSlotId && ev.target.parentElement && ev.target.parentElement.id && ev.target.parentElement.id.includes('slot-')) {
        sourceSlotId = ev.target.parentElement.id;
    }
    ev.dataTransfer.setData("sourceSlot", sourceSlotId || "");
}

function drop(ev) {
    ev.preventDefault();
    ev.stopPropagation(); 

    const draggedPlayerId = ev.dataTransfer.getData("playerId");
    const sourceSlotId = ev.dataTransfer.getData("sourceSlot"); 
    if (!draggedPlayerId) return;

    let target = ev.target;
    // Subir hasta encontrar el slot
    while (target && (!target.id || !target.id.includes('slot-'))) {
        target = target.parentElement;
    }
    
    if (!target || !target.id) return;

    // DETECCI√ìN INTELIGENTE DE PREFIJO
    const isEditMode = target.id.startsWith('edit-');
    // Si no es edit, usamos '' (vac√≠o) para que coincida con tu HTML de registro
    const prefix = isEditMode ? 'edit-' : ''; 
    const targetSlotId = target.id;

    if (sourceSlotId === targetSlotId) return;

    const existingPlayerId = currentPitchPlayers[targetSlotId];

    // L√≥gica de movimiento
    if (!existingPlayerId) {
        currentPitchPlayers[targetSlotId] = draggedPlayerId;
        if (sourceSlotId) delete currentPitchPlayers[sourceSlotId];
        else removeFromSubs(draggedPlayerId);
    } else {
        if (sourceSlotId) {
            currentPitchPlayers[targetSlotId] = draggedPlayerId;
            currentPitchPlayers[sourceSlotId] = existingPlayerId;
        } else {
            currentPitchPlayers[targetSlotId] = draggedPlayerId;
            removeFromSubs(draggedPlayerId);
        }
    }
    renderAll(prefix);
}

function dropToSubs(ev, prefixInput) {
    ev.preventDefault();
    const playerId = ev.dataTransfer.getData("playerId");
    if(!playerId) return;

    // Detectar prefijo
    let prefix = prefixInput;
    if (typeof prefix === 'undefined') {
        prefix = document.getElementById('edit-match-modal')?.classList.contains('flex') ? 'edit-' : '';
    }

    const slotKey = Object.keys(currentPitchPlayers).find(key => currentPitchPlayers[key] === playerId);
    if (slotKey) delete currentPitchPlayers[slotKey];

    if (!currentSubstitutes.includes(playerId)) {
        currentSubstitutes.push(playerId);
    }
    renderAll(prefix);
}

function dropToBench(ev, prefixInput) {
    ev.preventDefault();
    const playerId = ev.dataTransfer.getData("playerId");
    if(!playerId) return;

    let prefix = prefixInput;
    if (typeof prefix === 'undefined') {
        prefix = document.getElementById('edit-match-modal')?.classList.contains('flex') ? 'edit-' : '';
    }

    removePlayerFromAllZones(playerId); // Esto lo manda al banquillo/disponibles
    renderAll(prefix);
}

function removePlayerFromAllZones(playerId) {
    const slotKey = Object.keys(currentPitchPlayers).find(key => currentPitchPlayers[key] === playerId);
    if (slotKey) delete currentPitchPlayers[slotKey];

    const subIndex = currentSubstitutes.indexOf(playerId);
    if (subIndex > -1) currentSubstitutes.splice(subIndex, 1);
    
    // Refrescar autom√°ticamente
    renderAll();
}

function removeFromSubs(playerId) {
    const idx = currentSubstitutes.indexOf(playerId);
    if (idx > -1) currentSubstitutes.splice(idx, 1);
}

function renderAll(prefixInput) {
    let prefix = prefixInput;
    // Si no nos dan prefijo, adivinamos mirando si el modal de editar est√° abierto
    if (typeof prefix === 'undefined') {
        const editModal = document.getElementById('edit-match-modal');
        const isEditing = editModal && (editModal.classList.contains('flex') || editModal.style.display === 'flex');
        prefix = isEditing ? 'edit-' : '';
    }
    
    if(typeof renderTacticalBoard === 'function') renderTacticalBoard(prefix);
    if(typeof renderBench === 'function') renderBench(prefix);
}

        // ==========================================
        // SELECTOR DE JUGADORES (MEJORADO)
        // ==========================================

        function openPlayerSelector(slotId) {
            currentSelectorSlot = slotId;
            const modal = document.getElementById('player-selector-modal');
            const list = document.getElementById('player-selector-list');
            const searchInput = document.getElementById('player-selector-search');
            
            searchInput.value = ''; 
            list.innerHTML = ''; 

            // 1. ORIGEN DE DATOS
            let sourcePlayers = [];
            if (editingMatchPlayersPool && editingMatchPlayersPool.length > 0) {
                const all = getPlayers();
                sourcePlayers = all.filter(p => editingMatchPlayersPool.includes(p.id) && p.posicion !== 'entrenador');
            } else {
                sourcePlayers = getActivePlayers().filter(p => p.posicion !== 'entrenador');
            }

            // 2. FILTRAR (Mostrar TODOS excepto el que ya est√° en ESTE slot exacto)
            const currentPlayerInThisSlot = slotId ? currentPitchPlayers[slotId] : null;

            // Ordenar por dorsal
            sourcePlayers.sort((a, b) => a.dorsal - b.dorsal);

            list.innerHTML = sourcePlayers.map(p => {
                // Ver si est√° seleccionado en ESTE slot
                const isSelectedHere = p.id === currentPlayerInThisSlot;
                
                // Ver si est√° en OTRO slot del campo
                const otherSlotKey = Object.keys(currentPitchPlayers).find(key => currentPitchPlayers[key] === p.id && key !== slotId);
                const isOnPitchElsewhere = !!otherSlotKey;
                
                // Estilos visuales
                let bgClass = 'bg-white hover:bg-gray-50';
                let statusIcon = '';
                let statusText = '';

                if (isSelectedHere) {
                    bgClass = 'bg-green-50 border-green-300';
                    statusIcon = '‚úÖ';
                } else if (isOnPitchElsewhere) {
                    bgClass = 'bg-blue-50 border-blue-200 opacity-90'; // Un poco distinto para indicar que se mover√°
                    statusText = '<span class="text-[10px] text-blue-600 font-bold ml-2">EN CAMPO (Mover)</span>';
                }

                return `
                <div data-player-id="${p.id}" onclick="selectPlayerForSlot('${p.id}')" class="selector-item cursor-pointer flex items-center gap-3 p-2 rounded-lg border border-gray-100 transition-all ${bgClass}">
                    <img src="${p.foto}" class="w-10 h-10 rounded-full object-cover object-top border border-gray-200" onerror="this.src='https://via.placeholder.com/40'">
                    <div class="flex-1">
                        <div class="flex items-center">
                            <p class="font-bold text-gray-800 text-sm">${p.apodo || p.apellido}</p>
                            ${statusText}
                        </div>
                        <p class="text-xs text-gray-500">${capitalizeFirst(p.posicion)} #${p.dorsal}</p>
                    </div>
                    ${statusIcon}
                </div>
                `;
            }).join('');

            modal.classList.add('active');
            setTimeout(() => searchInput.focus(), 100);
        }

        // ‚úÖ NUEVA FUNCI√ìN PARA LA TECLA ENTER
        function handleSelectorKey(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                // Buscar todos los elementos visibles (los que coinciden con la b√∫squeda)
                const visibleItems = Array.from(document.querySelectorAll('.selector-item:not(.hidden)'));

                if (visibleItems.length > 0) {
                    // Seleccionar el primero de la lista
                    const firstId = visibleItems[0].getAttribute('data-player-id');
                    if (firstId) {
                        selectPlayerForSlot(firstId);
                    }
                }
            }
        }

        function closePlayerSelector() {
            document.getElementById('player-selector-modal').classList.remove('active');
            currentSelectorSlot = null;
        }

        function selectPlayerForSlot(playerId) {
            // Si es null, es la acci√≥n de "Dejar vac√≠o"
            if (!playerId) {
                if (currentSelectorSlot) delete currentPitchPlayers[currentSelectorSlot];
            } else {
                // 1. Quitar de suplentes si estaba
                removeFromSubs(playerId);

                // 2. MOVER: Si estaba en otro slot del campo, quitarlo de all√≠
                const oldSlot = Object.keys(currentPitchPlayers).find(key => currentPitchPlayers[key] === playerId);
                if (oldSlot) {
                    delete currentPitchPlayers[oldSlot];
                }

                // 3. Asignar al nuevo slot (si venimos de un slot del campo)
                if (currentSelectorSlot) {
                    currentPitchPlayers[currentSelectorSlot] = playerId;
                } else {
                    // Si currentSelectorSlot es null (click desde el banquillo), 
                    // significa que queremos a√±adirlo a suplentes
                     if (!currentSubstitutes.includes(playerId)) {
                        currentSubstitutes.push(playerId);
                     }
                }
            }

            renderAll();
            closePlayerSelector();
        }

        function filterSelectorList() {
            // Normalizar: Quitar tildes y pasar a min√∫sculas
            const normalize = (str) => str.normalize("NFD").replace(/[\u0300-\u036f]/g, "").toLowerCase();
            
            const term = normalize(document.getElementById('player-selector-search').value);
            const items = document.querySelectorAll('.selector-item');
            
            items.forEach(item => {
                // Buscamos dentro del texto del elemento (nombre del jugador)
                const text = normalize(item.innerText);
                if (text.includes(term)) {
                    item.classList.remove('hidden');
                } else {
                    item.classList.add('hidden');
                }
            });
        }

        // FASE 3 (Adelanto): Sincronizar Pizarra -> Checkbox de la Lista
        // Esta funci√≥n marca los checkboxes ocultos bas√°ndose en qui√©n est√° en el campo
        function syncListWithBoard() {
            // 1. Limpiar todos los checkboxes
            document.querySelectorAll('.chk-starter').forEach(chk => {
                chk.checked = false;
                handleRoleCheck(chk, 'starter'); // Actualizar visuales
            });

            // 2. Marcar los que est√°n en currentPitchPlayers
            Object.values(currentPitchPlayers).forEach(playerId => {
                // Buscar el div del jugador en la lista oculta
                const playerRow = document.querySelector(`div[data-player-id="${playerId}"]`);
                if (playerRow) {
                    const starterChk = playerRow.querySelector('.chk-starter');
                    if (starterChk) {
                        starterChk.checked = true;
                        handleRoleCheck(starterChk, 'starter');
                    }
                }
            });
        }
function goToStep3() {
    const titularesIds = Object.values(currentPitchPlayers).filter(id => id);
    
    // Validaci√≥n
    if (titularesIds.length !== 11) {
        alert(`‚ö†Ô∏è Tienes ${titularesIds.length} jugadores en el campo. Deben ser exactamente 11.`);
        return;
    }
    
    // Preparar UI
    document.getElementById('wizard-step-2').classList.add('hidden');
    document.getElementById('wizard-step-3').classList.remove('hidden');

    const suplentesIds = currentSubstitutes || [];
    const allPlayers = getPlayers();
    let playersToRender = [];
    
    // 1. PROCESAR TITULARES Y SUS POSICIONES EXACTAS (Para las etiquetas verdes)
    titularesIds.forEach(id => {
        const p = allPlayers.find(pl => pl.id === id);
        if (p) {
            // Buscar en qu√© slot estaba este jugador para saber si es "Lateral" o "Central"
            const slotKey = Object.keys(currentPitchPlayers).find(key => currentPitchPlayers[key] === id);
            let specificPos = 'Titular'; 
            let pitchSlot = null;
            
            if (slotKey) {
                const indexMatch = slotKey.match(/-(\d+)$/);
                if (indexMatch) {
                    const idx = parseInt(indexMatch[1]);
                    // Usamos tu funci√≥n auxiliar para sacar el nombre bonito
                    specificPos = getPositionName(currentFormation, idx); 
                    pitchSlot = idx;
                }
            }
            playersToRender.push({ ...p, rol: 'Titular', specificPos: specificPos, isStarter: true, pitchSlot: pitchSlot });
        }
    });
    
    // 2. Procesar Suplentes
    suplentesIds.forEach(id => {
        const p = allPlayers.find(pl => pl.id === id);
        if(p) playersToRender.push({ ...p, rol: 'Suplente', specificPos: 'Suplente', isStarter: false });
    });
    
    // 3. Entrenador
    const coach = allPlayers.find(p => p.posicion === 'entrenador');
    if(coach) playersToRender.push({ ...coach, rol: 'Entrenador', specificPos: 'Entrenador', isStarter: false });

    // 4. LLAMAR A LA FUNCI√ìN DE PINTADO CON ESTOS DATOS ESPEC√çFICOS
    const currentComp = document.getElementById('new-competition').value;
    renderPlayerStatsForm('final-stats-container', currentComp, playersToRender, 'wizard-');
}

        // ==========================================
        // SISTEMA DE COPIA DE SEGURIDAD (CORREGIDO)
        // ==========================================

function backupData() {
    if (!currentTeam) {
        alert("‚ö†Ô∏è Error: No hay un equipo seleccionado.");
        return;
    }

    const matches = getData('matches');
    const players = getData('players') || []; // Necesitamos los jugadores para hacer los c√°lculos
    const competitionState = getData('competitionState') || {}; 
    const playerStates = getData('playerStates') || []; 

    // --- MAGIA: ENRIQUECER LOS PARTIDOS CON DATOS CALCULADOS ---
    // Recorremos cada partido y le "pegamos" el valor y la edad media del 11 titular
    const enrichedMatches = matches.map(match => {
        
        // 1. Filtrar titulares de este partido
        const starters = match.playerStats.filter(ps => ps.isStarter);
        
        let totalValue = 0;
        let totalYears = 0;
        let ageCount = 0;

        starters.forEach(ps => {
            // Buscamos al jugador real en la base de datos
            const realPlayer = players.find(p => p.id === ps.playerId);
            
            if (realPlayer) {
                // A) Sumar Valor de Mercado (Asumimos propiedad 'marketValue' o 'valor')
                // Se intenta leer el valor, quitando s√≠mbolos si los hubiera
                const val = parseFloat(realPlayer.marketValue || realPlayer.valor || 0);
                totalValue += isNaN(val) ? 0 : val;

                // B) Calcular Edad (basada en fecha de nacimiento)
                if (realPlayer.birthDate || realPlayer.fechaNacimiento) {
                    const dob = new Date(realPlayer.birthDate || realPlayer.fechaNacimiento);
                    const matchDate = match.date ? new Date(match.date) : new Date(); // Edad al momento del partido
                    
                    if (!isNaN(dob.getTime())) {
                        // C√°lculo preciso de edad en la fecha del partido
                        let age = matchDate.getFullYear() - dob.getFullYear();
                        const m = matchDate.getMonth() - dob.getMonth();
                        if (m < 0 || (m === 0 && matchDate.getDate() < dob.getDate())) {
                            age--;
                        }
                        totalYears += age;
                        ageCount++;
                    }
                }
            }
        });

        // Calculamos medias
        const avgAge = ageCount > 0 ? (totalYears / ageCount).toFixed(1) : "0.0";

        // Devolvemos el partido con los datos nuevos INCRUSTADOS
        return {
            ...match,
            // Estos campos ahora aparecer√°n en el JSON individualmente:
            _backup_team_value: totalValue,    // Valor total del 11
            _backup_avg_age: parseFloat(avgAge), // Edad media del 11
            _backup_starters_count: starters.length // Para control
        };
    });

    // Creamos el paquete final usando los partidos enriquecidos
    const data = {
        team: currentTeam, 
        matches: enrichedMatches, // <--- Usamos la versi√≥n con datos extra
        competitionState: competitionState,
        playerStates: playerStates,
        players: players, // Seguimos guardando los jugadores por si acaso
        timestamp: new Date().toISOString(),
        version: '1.3'
    };

    // Descargar
    const dataStr = JSON.stringify(data, null, 2);
    const blob = new Blob([dataStr], { type: "application/json" });
    const url = URL.createObjectURL(blob);
    
    const a = document.createElement('a');
    const date = new Date().toISOString().split('T')[0];
    a.download = `FullBackup_${currentTeam}_${date}.json`;
    a.href = url;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    
    alert(`‚úÖ Copia ENRIQUECIDA descargada.\nAhora cada partido incluye Valor y Edad Media en el JSON.`);
}
function restoreData(input) {
    const file = input.files[0];
    if (!file) return;

    const reader = new FileReader();
    
    reader.onload = function(e) {
        try {
            const content = e.target.result;
            const data = JSON.parse(content);
            
            // 1. Validaciones b√°sicas
            if (!data.matches || !data.team) {
                throw new Error("El archivo no es v√°lido (faltan datos o equipo).");
            }

            // 2. Validaci√≥n de Equipo Cruzado
            if (data.team !== currentTeam) {
                if (!confirm(`‚ö†Ô∏è ARCHIVO DE OTRO EQUIPO\n\nEl archivo es del: ${data.team.toUpperCase()}\nEst√°s en: ${currentTeam.toUpperCase()}\n\n¬øQuieres sobrescribir los datos de ${currentTeam.toUpperCase()} con los del archivo?`)) {
                    input.value = '';
                    return;
                }
            } else {
                if (!confirm(`‚ö†Ô∏è RESTAURAR COPIA\n\nSe van a cargar ${data.matches.length} partidos y datos de plantilla.\nLos datos actuales se perder√°n.\n¬øContinuar?`)) {
                    input.value = '';
                    return;
                }
            }

            // 3. Guardar Datos (Sobrescribir memoria)
            saveData('matches', data.matches);
            saveData('competitionState', data.competitionState || {});
            
            if (data.playerStates) {
                saveData('playerStates', data.playerStates);
            }

            // NUEVO: Restaurar Jugadores (Valores de mercado, etc.)
            if (data.players && Array.isArray(data.players) && data.players.length > 0) {
                saveData('players', data.players);
            }

            // 4. VERIFICACI√ìN
            const checkMatches = getData('matches');
            if (!checkMatches || checkMatches.length !== data.matches.length) {
                throw new Error("Error al escribir en la memoria del navegador.");
            }

            // 5. Refrescar TODO
            // Limpiamos variables globales cr√≠ticas si las usas en cach√©
            if (typeof calendarEvents !== 'undefined') calendarEvents = []; 
            
            // Recargamos funciones principales
            if (typeof loadCalendar === 'function') loadCalendar();
            if (typeof renderPlayers === 'function') renderPlayers();
            if (typeof renderCompetitionStatus === 'function') renderCompetitionStatus();
            if (typeof renderMatches === 'function') renderMatches();
            if (typeof renderStats === 'function') renderStats(); 
            if (typeof renderPrincipal === 'function') renderPrincipal();
            
            alert(`‚úÖ RESTAURACI√ìN EXITOSA:\n- ${checkMatches.length} partidos cargados.\n- Plantilla actualizada (Valores y Edades).\n- Competiciones sincronizadas.`);
            
            // Ir a la pesta√±a de partidos
            if (typeof showTab === 'function') showTab('partidos');

        } catch (err) {
            console.error(err);
            alert("‚ùå ERROR AL RESTAURAR: " + err.message);
        } finally {
            input.value = ''; 
        }
    };
    
    reader.readAsText(file);
}

        function hardReset() {
            if (!currentTeam) return;

            // Nombre para mostrar en la alerta
            const teamName = currentTeam === 'masculino' ? 'MASCULINO' : 'FEMENINO';

            if (confirm(`‚õî ¬øEST√ÅS SEGURO?\n\nVas a borrar TODOS los datos del REAL MADRID ${teamName}.\n\n‚úÖ El otro equipo NO se ver√° afectado.\n‚ö†Ô∏è Esta acci√≥n no se puede deshacer.`)) {
                
                // 1. Identificar qu√© claves pertenecen a ESTE equipo
                const keysToRemove = [];
                const prefix = `${currentTeam}_`; // ej: "femenino_"
                
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    // Si la clave empieza por "femenino_", a la lista de borrado
                    if (key && key.startsWith(prefix)) {
                        keysToRemove.push(key);
                    }
                }
                
                // 2. Borrar solo esas claves
                keysToRemove.forEach(key => localStorage.removeItem(key));
                
                alert(`üóëÔ∏è Datos del equipo ${teamName} borrados. Empezamos de cero.`);
                
                // 3. Recargar la p√°gina
                location.reload();
            }
        }
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            
            // Guardar preferencia
            localStorage.setItem('darkMode', isDark);
            
            // Actualizar bot√≥n
            updateDarkModeButton(isDark);
            
            // Actualizar gr√°ficos (si estamos en esa pesta√±a)
            updateChartsTheme(isDark);
        }

        function updateDarkModeButton(isDark) {
            const btn = document.getElementById('btn-dark-mode');
            if(btn) btn.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        }

        function updateChartsTheme(isDark) {
            // Cambiar colores globales de Chart.js
            Chart.defaults.color = isDark ? '#e2e8f0' : '#4b5563';
            Chart.defaults.borderColor = isDark ? '#334155' : '#e5e7eb';
            
            // Si los gr√°ficos existen, redibujarlos para aplicar nuevos colores
            // Simplemente llamamos a renderStats si la pesta√±a est√° activa
            if (!document.getElementById('section-stats').classList.contains('hidden')) {
                renderStats(); 
            }
        }

        function initDarkMode() {
            const savedMode = localStorage.getItem('darkMode') === 'true';
            if (savedMode) {
                document.body.classList.add('dark-mode');
                updateChartsTheme(true);
            }
            updateDarkModeButton(savedMode);
        }
        function applyMatchFilters() {
            const text = document.getElementById('filter-rival').value.toLowerCase();
            const comp = document.getElementById('filter-competition').value;
            const res = document.getElementById('filter-result').value;
            
            const matches = getData('matches');

            const filtered = matches.filter(m => {
                // 1. Filtro Texto (Rival)
                const matchText = m.opponent.toLowerCase();
                if (text && !matchText.includes(text)) return false;

                // 2. Filtro Competici√≥n
                if (comp !== 'all' && m.competition !== comp) return false;

                // 3. Filtro Resultado
                if (res !== 'all' && m.outcome !== res) return false;

                return true;
            });

            renderMatches(filtered); // Reutilizamos tu funci√≥n pas√°ndole la lista filtrada
        }
        // ==========================================
        // L√ìGICA COMPARADOR (RADAR CHART) - VERSI√ìN FINAL
        // ==========================================
        
        let radarChart = null;

        function populateComparatorSelects() {
            // Usamos los IDs de la SECCI√ìN (no del modal)
            const p1Select = document.getElementById('radar-p1');
            const p2Select = document.getElementById('radar-p2');
            
            if (!p1Select || !p2Select) return;

            // Limpiar opciones previas
            p1Select.innerHTML = '<option value="">Selecciona...</option>';
            p2Select.innerHTML = '<option value="">Selecciona...</option>';

            // Filtrar solo jugadores activos
            const players = getPlayers().filter(p => p.posicion !== 'entrenador').sort((a,b) => a.dorsal - b.dorsal);
            
            const options = players.map(p => `<option value="${p.id}">${p.nombre} ${p.apellido} (#${p.dorsal})</option>`).join('');
            
            p1Select.innerHTML += options;
            p2Select.innerHTML += options;

            // Pre-seleccionar para que no salga vac√≠o
            if (players.length >= 2) {
                p1Select.selectedIndex = 1;
                p2Select.selectedIndex = 2;
                updateComparatorChart(); // Dibujar inicial
            }
        }
let comparatorTimeouts = [];
function updateComparatorChart() {
    const id1 = document.getElementById('radar-p1').value;
    const id2 = document.getElementById('radar-p2').value;
    const tableContainer = document.getElementById('radar-stats-table');
    const ctxEl = document.getElementById('chart-radar-vs');
    
    // --- 1. GESTI√ìN DE TIMEOUTS ---
    // Limpiamos cualquier animaci√≥n pendiente si el usuario cambia r√°pido
    if (typeof comparatorTimeouts !== 'undefined') {
        comparatorTimeouts.forEach(t => clearTimeout(t));
        comparatorTimeouts = [];
    } else {
        // Si no has declarado la variable global, la creamos al vuelo para evitar errores
        window.comparatorTimeouts = []; 
    }

    // Limpieza visual inicial
    if(tableContainer) tableContainer.innerHTML = '';
    if(typeof radarChart !== 'undefined' && radarChart) {
        radarChart.destroy();
        radarChart = null;
    }

    if (!id1 || !id2) {
        if(tableContainer) tableContainer.innerHTML = '<p class="text-center text-gray-400 italic py-4">Selecciona dos jugadores.</p>';
        return;
    }

    const players = getPlayers();
    const matches = getData('matches');
    const p1 = players.find(p => p.id === id1);
    const p2 = players.find(p => p.id === id2);

    // ===============================================
    // ü•ä EFECTO VS (STREET FIGHTER)
    // ===============================================
    const parentContainer = ctxEl ? ctxEl.parentElement : null;

    if (parentContainer) {
        // Limpiar overlays viejos
        const oldOverlay = parentContainer.querySelector('.vs-overlay');
        if (oldOverlay) oldOverlay.remove();

        // Crear Overlay
        const overlay = document.createElement('div');
        overlay.className = 'vs-overlay';
        
        // Asegurar posici√≥n relativa
        if (getComputedStyle(parentContainer).position === 'static') {
            parentContainer.style.position = 'relative';
        }

        overlay.innerHTML = `
            <img src="${p1.foto}" class="vs-fighter anim-slide-left" style="left: 20%; z-index:1;" onerror="this.src='https://via.placeholder.com/100'">
            <div class="vs-text">VS</div>
            <img src="${p2.foto}" class="vs-fighter anim-slide-right" style="right: 20%; z-index:1;" onerror="this.src='https://via.placeholder.com/100'">
        `;

        parentContainer.appendChild(overlay);

        const vsText = overlay.querySelector('.vs-text');
        
        // Secuencia de animaci√≥n
        comparatorTimeouts.push(setTimeout(() => {
            overlay.classList.add('anim-rumble');
            vsText.classList.add('anim-pop');
        }, 400));

        comparatorTimeouts.push(setTimeout(() => {
            overlay.classList.add('anim-fade-out');
            // PINTAMOS LOS DATOS CUANDO EL TEL√ìN SE LEVANTA
            renderChartAndTable(); 
        }, 1600));

        comparatorTimeouts.push(setTimeout(() => {
            overlay.remove();
        }, 2200));

    } else {
        renderChartAndTable(); // Fallback si no hay contenedor gr√°fico
    }

    // ===============================================
    //  FUNCI√ìN INTERNA DE PINTADO (Closure)
    // ===============================================
    function renderChartAndTable() {
        const getStats = (pid) => {
            let g = 0, a = 0, mins = 0, mvp = 0, rateSum = 0, rateCount = 0, matchesCount = 0;
            matches.forEach(m => {
                const ps = m.playerStats.find(s => String(s.playerId) === String(pid));
                if (ps) {
                    g += ps.goals || 0; a += ps.assists || 0; mins += ps.minutes || 0;
                    matchesCount++;
                    if (ps.rating) { rateSum += parseFloat(ps.rating); rateCount++; }
                }
                if (String(m.mvp) === String(pid)) mvp++;
            });
            return { 
                goals: g, assists: a, minutes: mins, mvp: mvp, 
                avg: rateCount > 0 ? (rateSum / rateCount) : 0, matches: matchesCount
            };
        };

        const s1 = getStats(id1);
        const s2 = getStats(id2);

        const ceilings = { 
            goals: 15, assists: 10, minutes: (matches.length * 80) || 1000, 
            avg: 10, mvp: 5, matches: matches.length || 1 
        };

        const normalize = (val, max) => Math.min(100, Math.round((val / max) * 100));
        
        const data1 = [
            normalize(s1.goals, ceilings.goals), normalize(s1.assists, ceilings.assists),
            normalize(s1.avg, ceilings.avg), normalize(s1.minutes, ceilings.minutes),
            normalize(s1.mvp, ceilings.mvp)
        ];
        const data2 = [
            normalize(s2.goals, ceilings.goals), normalize(s2.assists, ceilings.assists),
            normalize(s2.avg, ceilings.avg), normalize(s2.minutes, ceilings.minutes),
            normalize(s2.mvp, ceilings.mvp)
        ];

        // --- CHART JS CON DELAY ---
        const isDark = document.body.classList.contains('dark-mode');
        const textColor = isDark ? '#e2e8f0' : '#4b5563';
        const gridColor = isDark ? '#334155' : '#e5e7eb';

        if (ctxEl) {
            radarChart = new Chart(ctxEl.getContext('2d'), {
                type: 'radar',
                data: {
                    labels: ['Goles', 'Asistencias', 'Nota Media', 'Minutos', 'MVPs'],
                    datasets: [
                        {
                            label: p1.apodo || p1.apellido, data: data1,
                            borderColor: 'rgba(59, 130, 246, 1)', backgroundColor: 'rgba(59, 130, 246, 0.2)',
                            pointBackgroundColor: 'rgba(59, 130, 246, 1)', borderWidth: 2
                        },
                        {
                            label: p2.apodo || p2.apellido, data: data2,
                            borderColor: 'rgba(239, 68, 68, 1)', backgroundColor: 'rgba(239, 68, 68, 0.2)',
                            pointBackgroundColor: 'rgba(239, 68, 68, 1)', borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    animation: { 
                        duration: 1500, 
                        easing: 'easeOutQuart',
                        delay: 500 
                    },
                    scales: {
                        r: {
                            angleLines: { color: gridColor }, grid: { color: gridColor },
                            pointLabels: { font: { size: 12, weight: 'bold' }, color: textColor },
                            suggestedMin: 0, suggestedMax: 100, ticks: { display: false }
                        }
                    },
                    plugins: { legend: { labels: { color: textColor } } }
                }
            });
        }

        // --- TABLA HTML CON PLASMA ‚ö° Y DELAY ---
        const row = (label, v1, v2, maxVal, isFloat=false) => {
            const val1 = isFloat ? v1.toFixed(2) : v1;
            const val2 = isFloat ? v2.toFixed(2) : v2;
            
            // Colores de texto ajustados para verse bien con las barras de plasma
            const c1 = Number(val1) > Number(val2) ? 'text-blue-600 font-black' : (Number(val1) === Number(val2) ? 'text-gray-400' : 'text-gray-400');
            const c2 = Number(val2) > Number(val1) ? 'text-red-600 font-black' : (Number(val2) === Number(val1) ? 'text-gray-400' : 'text-gray-400');

            const pct1 = Math.min(100, Math.max(2, (v1 / maxVal) * 100));
            const pct2 = Math.min(100, Math.max(2, (v2 / maxVal) * 100));

            return `
            <div class="relative flex justify-between items-center py-2 mb-2 border-b border-gray-100 last:border-0 overflow-hidden">
                <div class="absolute left-0 top-0 bottom-0 bg-blue-500 plasma-bar animate-bar origin-left opacity-80 rounded-r-md" 
                     style="width: ${pct1}%; max-width: 48%; z-index:0; animation-delay: 0.5s;"></div>
                
                <div class="absolute right-0 top-0 bottom-0 bg-red-500 plasma-bar animate-bar origin-right opacity-80 rounded-l-md" 
                     style="width: ${pct2}%; max-width: 48%; z-index:0; animation-delay: 0.5s;"></div>

                <div class="z-10 w-full flex justify-between items-center px-2">
                    <span class="text-base ${c1} drop-shadow-sm mix-blend-multiply">${val1}</span>
                    <span class="text-xs text-slate-500 uppercase tracking-widest font-bold text-center bg-white/90 px-2 rounded backdrop-blur-sm shadow-sm">${label}</span>
                    <span class="text-base ${c2} drop-shadow-sm mix-blend-multiply">${val2}</span>
                </div>
            </div>`;
        };
        
        if(tableContainer) {
            tableContainer.innerHTML = `
                ${row('Nota Media', s1.avg, s2.avg, ceilings.avg, true)}
                ${row('Goles', s1.goals, s2.goals, ceilings.goals)}
                ${row('Asistencias', s1.assists, s2.assists, ceilings.assists)}
                ${row('MVPs', s1.mvp, s2.mvp, ceilings.mvp)}
                ${row('Minutos', s1.minutes, s2.minutes, ceilings.minutes)}
                ${row('Partidos', s1.matches, s2.matches, ceilings.matches)}
            `;
        }
    } // FIN de renderChartAndTable

} // FIN de updateComparatorChart (¬°Esta es la llave que faltaba!)

        // ==========================================
        // AI PREDICTION ENGINE
        // ==========================================

        function renderAIPrediction() {
            const container = document.getElementById('ai-prediction-card');
            const now = new Date();
            
            // 1. Buscar Pr√≥ximo Partido
            const upcomingEvents = calendarEvents
                .filter(e => e.start > now)
                .sort((a, b) => a.start - b.start);

            if (upcomingEvents.length === 0) {
                container.classList.add('hidden'); // Si no hay partido, ocultamos la IA
                return;
            }

            const nextMatch = upcomingEvents[0];
            container.classList.remove('hidden');

            // 2. Analizar Datos Hist√≥ricos (La "IA")
            const matches = getData('matches');
            const players = getPlayers();
            
            // Estad√≠sticas base
            let wins = 0, draws = 0, losses = 0, gf = 0, ga = 0;
            let formPoints = 0; // Puntos de forma (√∫ltimos 5)
            
            // Analizar √∫ltimos 5 partidos para "Racha"
            const last5 = [...matches].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
            last5.forEach(m => {
                if (m.outcome === 'victoria') formPoints += 3;
                else if (m.outcome === 'empate') formPoints += 1;
            });

            // Medias globales
            matches.forEach(m => {
                const parts = m.result.replace('*','').split('-').map(Number);
                const isHome = m.venue === 'local';
                if(isHome) { gf += parts[0]; ga += parts[1]; } 
                else { gf += parts[1]; ga += parts[0]; }
            });

            const avgGF = matches.length > 0 ? (gf / matches.length) : 2; // Default 2 goles
            const avgGA = matches.length > 0 ? (ga / matches.length) : 1; // Default 1 gol

            // 3. Calcular Probabilidades (Algoritmo Heur√≠stico)
            // Factor Base: Real Madrid siempre favorito (60%)
            let winProb = 60; 
            
            // Factor Forma: Si vienes ganando, sube. Si pierdes, baja.
            const formFactor = (formPoints / 15) * 20; // Hasta +20% extra si ganas todo
            winProb += formFactor;

            // Factor Casa/Fuera
            if (nextMatch.venue === 'local') winProb += 10;
            else winProb -= 5;

            // Factor Competici√≥n (Champions es m√°s dif√≠cil)
            if (nextMatch.competition && nextMatch.competition.includes('Champions')) winProb -= 10;

            // Ajustes finales (topes)
            if (winProb > 90) winProb = 90;
            if (winProb < 30) winProb = 30;

            const drawProb = Math.max(10, (100 - winProb) * 0.4); // El empate es un % del resto
            // const lossProb = 100 - winProb - drawProb; (impl√≠cito)

            // 4. Predicci√≥n de Resultado
            // Usamos la media de goles y redondeamos
            let predGF = Math.round(avgGF);
            let predGA = Math.round(avgGA);
            
            // Ajuste por local√≠a
            if (nextMatch.venue === 'local') predGF = Math.max(predGF, predGF + 1);
            
            // Si la probabilidad de victoria es muy alta, aseguramos que GF > GA
            if (winProb > 70 && predGF <= predGA) predGF = predGA + 1;

            // 5. Jugador a Seguir (El que mejor nota media tenga o m√°s goles)
            let playerToWatch = "Bellingham"; // Fallback
            let playerReason = "Lidera el equipo";
            
            // Buscar mejor jugador activo
            const activePlayers = players.filter(p => p.posicion !== 'entrenador' && p.estado === 'Activo');
            
            // Crear ranking simple
            const playerRanking = activePlayers.map(p => {
                let score = 0;
                let goals = 0;
                let rating = 0;
                let count = 0;
                
                matches.forEach(m => {
                    const ps = m.playerStats.find(s => s.playerId === p.id);
                    if (ps) {
                        goals += ps.goals || 0;
                        if(ps.rating) { rating += parseFloat(ps.rating); count++; }
                    }
                });
                
                const avg = count > 0 ? rating/count : 0;
                score = (goals * 2) + (avg * 1.5); // Goles valen doble
                return { name: p.apodo || p.apellido, score, goals, avg };
            }).sort((a,b) => b.score - a.score);

            if (playerRanking.length > 0) {
                const top = playerRanking[0];
                playerToWatch = top.name;
                playerReason = top.goals > 0 ? `M√°ximo peligro (${top.goals} goles)` : `Motor del equipo (${top.avg.toFixed(1)} nota)`;
            }


            // --- RENDERIZAR EN DOM ---
            document.getElementById('ai-match-label').textContent = `vs ${nextMatch.opponent} (${nextMatch.venue === 'local' ? 'Casa' : 'Fuera'})`;
            document.getElementById('ai-prediction-text').textContent = winProb >= 55 ? "Victoria Probable" : (winProb >= 40 ? "Partido Re√±ido" : "Partido Complicado");
            document.getElementById('ai-reasoning').textContent = `Basado en ${matches.length} partidos analizados y forma actual.`;
            
            document.getElementById('ai-win-prob').textContent = Math.round(winProb) + '%';
            document.getElementById('prob-bar-win').style.width = winProb + '%';
            document.getElementById('prob-bar-draw').style.width = drawProb + '%';
            
            document.getElementById('ai-score-prediction').textContent = `${predGF} - ${predGA}`;
            document.getElementById('ai-player-watch').textContent = playerToWatch;
            document.getElementById('ai-player-reason').textContent = playerReason;
        }
        // ==========================================
        // BEST XI (ONCE DE GALA) LOGIC
        // ==========================================

        function renderBestXI() {
            const container = document.getElementById('best-xi-container');
            if (!container) return;
            container.innerHTML = '';

            const players = getPlayers();
            const matches = getData('matches');

            // 1. Calcular notas medias
            const playerRatings = players.map(p => {
                if (p.posicion === 'entrenador') return null;
                
                let totalRating = 0;
                let count = 0;
                
                matches.forEach(m => {
                    const ps = m.playerStats.find(s => s.playerId === p.id);
                    if (ps && ps.rating) {
                        totalRating += parseFloat(ps.rating);
                        count++;
                    }
                });

                return {
                    ...p,
                    avg: count > 0 ? (totalRating / count) : 0,
                    matches: count
                };
            }).filter(p => p && p.matches >= 1); // Solo jugadores que hayan jugado

            // 2. Funci√≥n auxiliar para buscar por ROL ESPEC√çFICO
            const getBestByRole = (role, limit) => {
                return playerRatings
                    .filter(p => p.rol === role)
                    .sort((a, b) => b.avg - a.avg) // Ordenar por mejor nota
                    .slice(0, limit);
            };

            // 3. Selecci√≥n de Jugadores por Posici√≥n Real (4-3-3)
            const gk = getBestByRole('PT', 1);       // Portero
            
            const lb = getBestByRole('LI', 1);       // Lateral Izquierdo
            const cbs = getBestByRole('CT', 2);      // Centrales (Top 2)
            const rb = getBestByRole('LD', 1);       // Lateral Derecho
            
            const cdm = getBestByRole('MCD', 1);     // Pivote
            const cms = getBestByRole('MC', 2);      // Interiores (Top 2)
            
            const lw = getBestByRole('EI', 1);       // Extremo Izquierdo
            const st = getBestByRole('DC', 1);       // Delantero Centro
            const rw = getBestByRole('ED', 1);       // Extremo Derecho

            // 4. Asignaci√≥n al Campo (Coordenadas T√°cticas)
            const positions = [
                { top: 90, left: 50, players: gk },       // Portero
                
                { top: 75, left: 15, players: lb },       // Lateral Izq
                { top: 80, left: 38, players: [cbs[0]] }, // Central 1
                { top: 80, left: 62, players: [cbs[1]] }, // Central 2
                { top: 75, left: 85, players: rb },       // Lateral Der

                { top: 60, left: 50, players: cdm },      // Pivote (MCD)
                { top: 45, left: 30, players: [cms[0]] }, // Interior Izq
                { top: 45, left: 70, players: [cms[1]] }, // Interior Der

                { top: 20, left: 20, players: lw },       // Extremo Izq (Vini)
                { top: 15, left: 50, players: st },       // Delantero (Mbapp√©)
                { top: 20, left: 80, players: rw }        // Extremo Der (Rodrygo)
            ];

            // 5. Renderizar Fichas
            positions.forEach(pos => {
                const p = pos.players && pos.players[0] ? pos.players[0] : null;
                
                if (p) {
                    const el = document.createElement('div');
                    el.className = 'player-card-pitch';
                    el.style.top = pos.top + '%';
                    el.style.left = pos.left + '%';
                    
                    // Avatar
                    let avatarContent = p.foto ? `<img src="${p.foto}" alt="${p.apellido}">` : p.dorsal;
                    
                    el.innerHTML = `
                        <div class="pitch-avatar">${avatarContent}</div>
                        <div class="pitch-rating">${p.avg.toFixed(2)}</div>
                        <div class="pitch-name">${p.apodo || p.apellido}</div>
                    `;
                    container.appendChild(el);
                }
            });
        }
        // ==========================================
        // SCATTER CHART (CORREGIDO)
        // ==========================================
        let scatterChart = null;

        function renderScatterChart() {
            const ctx = document.getElementById('chart-scatter-performance');
            if (!ctx) return;

            const players = getPlayers();
            const matches = getData('matches');

            // Preparar datos
            const dataPoints = players.map(p => {
                if (p.posicion === 'entrenador') return null;

                let totalMins = 0;
                let ratingSum = 0;
                let ratingCount = 0;

                matches.forEach(m => {
                    const ps = m.playerStats.find(s => s.playerId === p.id);
                    if (ps) {
                        totalMins += ps.minutes || 0;
                        if (ps.rating) {
                            ratingSum += parseFloat(ps.rating);
                            ratingCount++;
                        }
                    }
                });

                if (totalMins === 0 || ratingCount === 0) return null;

                const shortName = p.apodo || p.apellido;

                return {
                    x: totalMins,
                    y: (ratingSum / ratingCount).toFixed(2),
                    name: shortName,
                    pos: p.posicion
                };
            }).filter(item => item !== null);

            // Calcular medias para la cruz central
            const avgMins = dataPoints.reduce((acc, p) => acc + p.x, 0) / (dataPoints.length || 1);
            const avgRating = dataPoints.reduce((acc, p) => acc + parseFloat(p.y), 0) / (dataPoints.length || 1);

            if (scatterChart) scatterChart.destroy();

            const isDark = document.body.classList.contains('dark-mode');
            const gridColor = isDark ? '#334155' : '#e5e7eb';
            const textColor = isDark ? '#94a3b8' : '#4b5563';
            const axisColor = isDark ? '#f1f5f9' : '#1f2937';

            // ‚ö†Ô∏è IMPORTANTE: No usamos Chart.register aqu√≠ para no romper el gr√°fico de pastel.
            // Lo pasamos directamente en la configuraci√≥n 'plugins' de abajo.

            scatterChart = new Chart(ctx, {
                type: 'scatter',
                plugins: [ChartDataLabels], // <--- AQU√ç ACTIVAMOS EL PLUGIN SOLO PARA ESTE GR√ÅFICO
                data: {
                    datasets: [{
                        label: 'Jugadores',
                        data: dataPoints,
                        backgroundColor: (context) => {
                            const val = context.raw;
                            if(!val) return '#9ca3af';
                            if(val.x > avgMins && val.y > avgRating) return '#10b981'; // Verde
                            if(val.x < avgMins && val.y > avgRating) return '#f59e0b'; // Naranja
                            if(val.x > avgMins && val.y < avgRating) return '#ef4444'; // Rojo
                            return '#6b7280'; // Gris
                        },
                        pointRadius: 6,
                        pointHoverRadius: 9
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    layout: {
                        padding: { top: 20, right: 20, left: 10, bottom: 10 }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (ctx) => `${ctx.raw.name}: ${ctx.raw.y} Nota / ${ctx.raw.x} Min`
                            }
                        },
                        // Configuraci√≥n de las etiquetas
                        datalabels: {
                            align: 'top',
                            anchor: 'center',
                            offset: 4,
                            color: textColor,
                            formatter: function(value) {
                                return value.name;
                            },
                            font: {
                                size: 10,
                                weight: 'bold',
                                family: 'sans-serif'
                            },
                            clip: false
                        }
                    },
                    scales: {
                        x: {
                            title: { display: true, text: 'Minutos Jugados', color: axisColor, font: { weight: 'bold' } },
                            grid: { color: gridColor },
                            ticks: { color: textColor }
                        },
                        y: {
                            title: { display: true, text: 'Nota Media', color: axisColor, font: { weight: 'bold' } },
                            grid: { color: gridColor },
                            ticks: { color: textColor },
                            min: 0,
                            max: 10
                        }
                    }
                }
            });
        }
        // ==========================================
        // MVP GALLERY LOGIC
        // ==========================================

        function renderMVPGallery() {
            const container = document.getElementById('mvp-gallery-grid');
            const noData = document.getElementById('no-mvps-msg');
            const filterComp = document.getElementById('mvp-filter-comp');
            
            // 1. Obtener partidos con MVP
            let matches = getData('matches').filter(m => m.mvp && m.mvp !== '');
            const players = getPlayers();

            // Llenar filtro si est√° vac√≠o
            if (filterComp.options.length <= 1) {
                const comps = [...new Set(matches.map(m => m.competition))];
                comps.forEach(c => {
                    filterComp.innerHTML += `<option value="${c}">${c}</option>`;
                });
            }

            // Filtrar
            if (filterComp.value) {
                matches = matches.filter(m => m.competition === filterComp.value);
            }

            // Ordenar: M√°s recientes primero
            matches.sort((a, b) => new Date(b.date) - new Date(a.date));

            if (matches.length === 0) {
                container.innerHTML = '';
                noData.classList.remove('hidden');
                return;
            }

            noData.classList.add('hidden');
            
            container.innerHTML = matches.map(m => {
                const p = players.find(pl => pl.id === m.mvp);
                if (!p) return ''; // Si el jugador fue borrado, saltamos

                // Datos del partido
                const date = new Date(m.date).toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
                const resultColor = m.outcome === 'victoria' ? 'text-green-600' : (m.outcome === 'empate' ? 'text-amber-600' : 'text-red-600');
                
                // Stats del jugador en ese partido
                const stats = m.playerStats.find(ps => ps.playerId === m.mvp);
                const rating = stats?.rating ? parseFloat(stats.rating).toFixed(2) : '-';
                const goals = stats?.goals || 0;
                const assists = stats?.assists || 0;

                // Crear etiquetas de hitos (Gol, Asistencia)
                let badges = [];
                if(goals > 0) badges.push(`<span class="bg-blue-100 text-blue-800 text-[10px] px-2 py-0.5 rounded-full font-bold">‚öΩ ${goals} Goles</span>`);
                if(assists > 0) badges.push(`<span class="bg-purple-100 text-purple-800 text-[10px] px-2 py-0.5 rounded-full font-bold">üëü ${assists} Asist</span>`);
                if(rating >= 9) badges.push(`<span class="bg-amber-100 text-amber-800 text-[10px] px-2 py-0.5 rounded-full font-bold">üî• Masterclass</span>`);

                return `
                <div class="mvp-card shadow-sm hover:shadow-xl group">
                    
                    <div class="px-4 py-3 bg-gray-50 border-b border-gray-100 flex justify-between items-center text-xs text-gray-500">
                        <span>${date} ¬∑ ${m.competition}</span>
                        <span class="font-bold ${resultColor} bg-white px-2 py-0.5 rounded border shadow-sm">${m.result}</span>
                    </div>

                    <div class="p-4 text-center">
                        <div class="mvp-photo-container">
                            <div class="mvp-crown">üëë</div>
                            <img src="${p.foto}" class="mvp-photo group-hover:scale-105 transition-transform duration-500" onerror="this.src='https://via.placeholder.com/120?text=${p.dorsal}'">
                        </div>
                        
                        <h4 class="text-lg font-black text-gray-800 leading-tight mb-1">${p.nombre}</h4>
                        <h5 class="text-sm font-bold text-gray-500 mb-3">${p.apellido}</h5>
                        
                        <div class="flex flex-wrap justify-center gap-2 mb-4 min-h-[20px]">
                            ${badges.join('')}
                        </div>

                        <div class="text-xs text-gray-400 font-medium uppercase tracking-wider mb-1">Contra</div>
                        <div class="font-bold text-gray-700 text-sm truncate" title="${m.opponent}">${m.opponent}</div>
                    </div>

                    <div class="bg-slate-800 p-3 flex justify-between items-center mt-auto">
                        <div class="text-white text-xs opacity-70 font-medium">Valoraci√≥n</div>
                        <div class="text-amber-400 font-black text-xl flex items-center gap-1">
                            ${rating} <span class="text-xs text-gray-400 font-normal">/10</span>
                        </div>
                    </div>
                </div>
                `;
            }).join('');
        }
function renderTrafficLight() {
    const matches = getData('matches');
    const players = getPlayers();
    const container = document.getElementById('semaforo-content');
    const btnContainer = document.getElementById('semaforo-expand-btn-container');
    
    if (!container) return;

    // 1. OBTENER √öLTIMOS 3 PARTIDOS (CORREGIDO)
    // En lugar de reverse(), ordenamos por FECHA REAL (Descendente: m√°s nuevo primero)
    const sortedMatches = [...matches].sort((a, b) => new Date(b.date) - new Date(a.date));

    const playerRatingsMap = {};

    // Recorremos partidos desde el m√°s reciente hacia atr√°s
    sortedMatches.forEach(m => {
        m.playerStats.forEach(ps => {
            // Validar que la nota existe
            if (ps.rating !== null && ps.rating !== undefined && ps.rating !== "") {
                const val = parseFloat(ps.rating);
                
                // CORRECCI√ìN: Aceptamos 0 como nota v√°lida (val >= 0)
                if (!isNaN(val) && val >= 0) {
                    if (!playerRatingsMap[ps.playerId]) playerRatingsMap[ps.playerId] = [];
                    
                    // Solo guardamos las 3 primeras notas que encontremos (que ser√°n las m√°s recientes)
                    if (playerRatingsMap[ps.playerId].length < 3) {
                        playerRatingsMap[ps.playerId].push(val);
                    }
                }
            }
        });
    });

    // 2. CALCULAR MEDIAS
    const averages = [];
    Object.keys(playerRatingsMap).forEach(pId => {
        const ratings = playerRatingsMap[pId];
        const p = players.find(pl => pl.id === pId);
        
        // Solo si el jugador existe, est√° activo y ha jugado al menos 1 de los √∫ltimos partidos
        if (p && p.estado === 'Activo' && ratings.length > 0) {
            const sum = ratings.reduce((a, b) => a + b, 0);
            const avg = (sum / ratings.length).toFixed(2);
            averages.push({ ...p, avg: avg, games: ratings.length });
        }
    });

    // Ordenar por nota media (Mejor nota arriba)
    averages.sort((a, b) => parseFloat(b.avg) - parseFloat(a.avg));

    // Clasificar en grupos
    const green = averages.filter(p => parseFloat(p.avg) >= 7.5);
    const yellow = averages.filter(p => parseFloat(p.avg) >= 6.0 && parseFloat(p.avg) < 7.5);
    const red = averages.filter(p => parseFloat(p.avg) < 6.0);

    // 3. RENDERIZAR
    const needsExpand = green.length > 3 || yellow.length > 3 || red.length > 3;

    container.innerHTML = `
        ${renderTrafficListSimple('üî• En Racha (>7.5)', 'green', green)}
        ${renderTrafficListSimple('‚öñÔ∏è Estables (6.0-7.5)', 'yellow', yellow)}
        ${renderTrafficListSimple('‚ùÑÔ∏è Fr√≠os (<6.0)', 'red', red)}
    `;

    // Mostrar u ocultar el bot√≥n global de "Ver todos"
    if (needsExpand) {
        btnContainer.classList.remove('hidden');
        if(document.getElementById('btn-traffic-all')) {
            document.getElementById('btn-traffic-all').innerHTML = 'Ver todos los jugadores ‚ñº';
        }
    } else {
        btnContainer.classList.add('hidden');
    }
}

        // Funci√≥n auxiliar simplificada (sin bot√≥n individual)
        function renderTrafficListSimple(title, colorName, list) {
            const colors = {
                'green': 'bg-emerald-50 text-emerald-800 border-emerald-200',
                'yellow': 'bg-amber-50 text-amber-800 border-amber-200',
                'red': 'bg-red-50 text-red-800 border-red-200'
            };
            const badgeColor = {
                'green': 'bg-emerald-500',
                'yellow': 'bg-amber-500',
                'red': 'bg-red-500'
            };

            let html = `
                <div class="bg-white rounded-xl shadow-sm border overflow-hidden flex flex-col h-full">
                    <div class="p-3 ${colors[colorName]} font-bold text-center border-b uppercase text-xs tracking-wider">
                        ${title}
                    </div>
                    <div class="p-2 space-y-2">
            `;

            if (list.length === 0) {
                html += `<div class="text-center text-gray-400 text-xs italic py-4">Vac√≠o</div>`;
            } else {
                list.forEach((p, index) => {
                    // Si el √≠ndice es mayor a 2 (es el 4¬∫ elemento o m√°s), lo ocultamos por defecto
                    const isHidden = index >= 3 ? 'hidden traffic-hidden-item' : '';
                    
                    html += `
                        <div class="${isHidden} flex items-center gap-3 p-2 rounded-lg bg-gray-50 border border-gray-100 transition-all">
                            <img src="${p.foto}" class="w-8 h-8 rounded-full object-cover object-top">
                            <div class="flex-1 min-w-0">
                                <p class="text-xs font-bold truncate text-gray-800">${p.apodo || p.apellido}</p>
                                <p class="text-[9px] text-gray-400">${p.games} part.</p>
                            </div>
                            <div class="${badgeColor[colorName]} text-white text-xs font-bold px-2 py-1 rounded-full shadow-sm">
                                ${p.avg}
                            </div>
                        </div>
                    `;
                });
            }
            html += `</div></div>`;
            return html;
        }

        // 4. FUNCI√ìN GLOBAL TOGGLE
        window.toggleTrafficAll = function() {
            const hiddenItems = document.querySelectorAll('.traffic-hidden-item');
            const btn = document.getElementById('btn-traffic-all');
            
            // Comprobamos si hay alguno oculto actualmente (es decir, estamos en estado "contra√≠do")
            // Nota: .hidden es la clase de Tailwind display:none
            const isCollapsed = hiddenItems.length > 0 && hiddenItems[0].classList.contains('hidden');

            if (isCollapsed) {
                // EXPANDIR: Quitamos la clase 'hidden' a todos
                hiddenItems.forEach(el => el.classList.remove('hidden'));
                btn.innerHTML = 'Ver menos ‚ñ≤';
            } else {
                // CONTRAER: Ponemos la clase 'hidden' a todos
                hiddenItems.forEach(el => el.classList.add('hidden'));
                btn.innerHTML = 'Ver todos los jugadores ‚ñº';
            }
        };

        // --- Funci√≥n Auxiliar para ocultar/mostrar ---
        function renderTrafficList(title, colorName, list) {
            // Colores de encabezado
            const colors = {
                'green': 'bg-green-100 text-green-800 border-green-200',
                'yellow': 'bg-yellow-100 text-yellow-800 border-yellow-200',
                'red': 'bg-red-100 text-red-800 border-red-200'
            };
            const badgeColor = {
                'green': 'bg-green-500',
                'yellow': 'bg-yellow-500',
                'red': 'bg-red-500'
            };

            // Separar visibles (Top 3) y ocultos
            const visible = list.slice(0, 3);
            const hidden = list.slice(3);

            let html = `
                <div class="bg-white rounded-xl shadow-sm border overflow-hidden flex flex-col h-full">
                    <div class="p-3 ${colors[colorName]} font-bold text-center border-b uppercase text-xs tracking-wider">
                        ${title} (${list.length})
                    </div>
                    <div class="p-2 space-y-2">
            `;

            // Renderizar los primeros 3
            if (visible.length === 0) {
                html += `<div class="text-center text-gray-400 text-xs italic py-4">Sin jugadores</div>`;
            } else {
                html += visible.map(p => createTrafficCard(p, badgeColor[colorName])).join('');
            }

            // Si hay ocultos, a√±adir bot√≥n y contenedor oculto
            if (hidden.length > 0) {
                html += `
                    <div id="more-${colorName}" class="hidden space-y-2 mt-2 pt-2 border-t border-dashed border-gray-200">
                        ${hidden.map(p => createTrafficCard(p, badgeColor[colorName])).join('')}
                    </div>
                    <button onclick="toggleTrafficSection('${colorName}')" id="btn-${colorName}" 
                        class="w-full mt-2 py-1 text-[10px] font-bold text-gray-500 hover:text-gray-800 hover:bg-gray-50 rounded uppercase transition-colors flex items-center justify-center gap-1">
                        <span>Ver ${hidden.length} m√°s</span> ‚ñº
                    </button>
                `;
            }

            html += `</div></div>`;
            return html;
        }

        function createTrafficCard(p, colorClass) {
            return `
                <div class="flex items-center gap-3 p-2 rounded-lg bg-gray-50 border border-gray-100">
                    <img src="${p.foto}" class="w-8 h-8 rounded-full object-cover object-top">
                    <div class="flex-1 min-w-0">
                        <p class="text-xs font-bold truncate text-gray-800">${p.apodo || p.apellido}</p>
                    </div>
                    <div class="${colorClass} text-white text-xs font-bold px-2 py-1 rounded-full shadow-sm">
                        ${p.avg}
                    </div>
                </div>
            `;
        }

        // Funci√≥n para abrir/cerrar
        window.toggleTrafficSection = function(colorName) {
            const content = document.getElementById(`more-${colorName}`);
            const btn = document.getElementById(`btn-${colorName}`);
            
            if (content.classList.contains('hidden')) {
                // Abrir
                content.classList.remove('hidden');
                btn.innerHTML = `<span>Ver menos</span> ‚ñ≤`;
            } else {
                // Cerrar
                content.classList.add('hidden');
                // Recalcular cu√°ntos quedan ocultos para el texto
                // (Truco: contamos los hijos del div oculto)
                const count = content.children.length;
                btn.innerHTML = `<span>Ver ${count} m√°s</span> ‚ñº`;
            }
        };
        // ==========================================
        // IMPORTADOR CSV (NOTAS DESDE EXCEL)
        // ==========================================

        function importFromCSV(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            
            reader.onload = function(e) {
                const text = e.target.result;
                processCSVData(text);
                input.value = ''; // Limpiar para poder repetir
            };
            
            reader.readAsText(file);
        }

        // ==========================================
        // IMPORTADOR CSV ESTRICTO (V5.0)
        // Solo importa si coincide con el Calendario Oficial
        // ==========================================
            // --- IMPORTADOR CSV BLINDADO (SIN DUPLICADOS) ---
// --- IMPORTADOR CSV BLINDADO (DOBLE VERIFICACI√ìN: ID + FECHA/RIVAL) ---
            function processCSVData(csvText) {
    const lines = csvText.split(/\r\n|\n/).filter(line => line.trim() !== '');
    if (lines.length < 2) {
        alert("‚ö†Ô∏è El archivo CSV parece estar vac√≠o.");
        return;
    }

    const separator = lines[0].indexOf(';') > -1 ? ';' : ',';
    
    // Parser de CSV
    const parseCSVRow = (rowText) => {
        const result = [];
        let current = '';
        let inQuotes = false;
        for (let i = 0; i < rowText.length; i++) {
            const char = rowText[i];
            if (char === '"') { inQuotes = !inQuotes; }
            else if (char === separator && !inQuotes) { result.push(current); current = ''; }
            else { current += char; }
        }
        result.push(current);
        return result.map(val => val.trim().replace(/^"|"$/g, '').replace(/""/g, '"'));
    };

    // 1. LEER CABECERAS
    const rivals = parseCSVRow(lines[0]).slice(1);

    // 2. DETECTAR FECHAS
    const row2 = parseCSVRow(lines[1]);
    const hasDateRow = row2.slice(1).some(cell => cell.includes('/') || cell.includes('-'));

    let startLine = 1;
    let csvDates = [];

    if (hasDateRow) {
        startLine = 2;
        csvDates = row2.slice(1);
    }

    const players = getPlayers();
    const matches = getData('matches');
    // Aseguramos que calendarEvents exista o sea array vac√≠o
    const officialEvents = (typeof calendarEvents !== 'undefined' && calendarEvents.length > 0) ? calendarEvents : [];

    // --- FILTROS DE SEGURIDAD (ANTI-DUPLICADOS) ---
    const registeredEventIds = new Set(matches.map(m => m.calendarEventId).filter(id => id));
    const sessionEventIds = new Set();

    const isMatchAlreadySaved = (evt) => {
        if (registeredEventIds.has(evt.id)) return true;
        const evtDate = evt.start.toISOString().split('T')[0];
        const evtRival = evt.opponent.toLowerCase().trim();
        return matches.some(m => {
            const mDate = m.date; 
            const mRival = m.opponent.toLowerCase().trim();
            return mDate === evtDate && (mRival.includes(evtRival) || evtRival.includes(mRival));
        });
    };

    let linkedCount = 0;
    let skippedCount = 0;
    let skippedLog = [];

    const newMatchesMap = {};
    
    // 3. PREPARAR PARTIDOS Y VINCULAR
    rivals.forEach((rivalName, index) => {
        if(rivalName) {
            let csvDateObj = new Date();
            let dateStringOriginal = csvDates[index] || "Sin fecha";
            let isValidDate = false;

            if (hasDateRow && csvDates[index]) {
                const dParts = csvDates[index].split(/[\/\-]/);
                if (dParts.length === 3) {
                    const day = parseInt(dParts[0]);
                    const month = parseInt(dParts[1]) - 1;
                    const year = parseInt(dParts[2]);
                    csvDateObj = new Date(year, month, day, 12, 0, 0);
                    isValidDate = true;
                }
            }

            let foundEvent = null;
            let skipReason = null;

            if (isValidDate && officialEvents.length > 0) {
                foundEvent = officialEvents.find(e => {
                    const nameMatch = e.opponent.toLowerCase().includes(rivalName.toLowerCase()) || 
                                      rivalName.toLowerCase().includes(e.opponent.toLowerCase());
                    const diffTime = Math.abs(e.start - csvDateObj);
                    const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24)); 
                    return nameMatch && diffDays <= 2;
                });
            } else {
                skipReason = "No coincide con calendario (Fecha/Nombre)";
            }

            if (foundEvent) {
                if (isMatchAlreadySaved(foundEvent)) {
                    foundEvent = null;
                    skipReason = "Ya registrado en la base de datos (Manual o Importado)";
                } 
                else if (sessionEventIds.has(foundEvent.id)) {
                    foundEvent = null;
                    skipReason = "Duplicado en este archivo CSV";
                } else {
                    sessionEventIds.add(foundEvent.id);
                }
            } else if (!skipReason) {
                skipReason = "No encontrado en calendario";
            }

            newMatchesMap[index] = {
                opponent: rivalName,
                originalDate: dateStringOriginal,
                linkedEvent: foundEvent,
                skipReason: skipReason,
                playerStats: []
            };
        }
    });

    // 4. LEER NOTAS
    for (let i = startLine; i < lines.length; i++) {
        const row = parseCSVRow(lines[i]);
        const playerName = row[0];
        if (!playerName) continue;

        const player = players.find(p => {
            const name = p.nombre + " " + p.apellido + " " + (p.apodo || "");
            return name.toLowerCase().includes(playerName.toLowerCase());
        });

        if (player) {
            for (let col = 1; col < row.length; col++) {
                let noteStr = row[col];
                // Si la celda est√° vac√≠a, saltamos
                if (!noteStr || noteStr.trim() === '') continue;

                noteStr = noteStr.replace(',', '.').replace(/[^0-9.]/g, ''); 
                const rating = parseFloat(noteStr);

                // --- CORRECCI√ìN AQU√ç: Permitimos el 0 (rating >= 0) ---
                if (!isNaN(rating) && rating >= 0) {
                    if (newMatchesMap[col - 1]) {
                        newMatchesMap[col - 1].playerStats.push({
                            playerId: player.id,
                            isStarter: true,
                            minutes: 90,
                            rating: rating,
                            goals: 0, 
                            assists: 0, 
                            yellowCards: 0, 
                            redCards: 0,
                            played: true
                        });
                    }
                }
                // -----------------------------------------------------
            }
        }
    }

    // 5. PROCESAR Y GUARDAR
    Object.values(newMatchesMap).forEach(m => {
        if (m.playerStats.length > 0) {
            if (m.linkedEvent) {
                linkedCount++;
                const finalMatch = {
                    id: typeof generateId === 'function' ? generateId() : Date.now().toString() + Math.random(),
                    calendarEventId: m.linkedEvent.id,
                    competition: m.linkedEvent.competition || "Liga EA Sports",
                    roundId: `jornada-${m.linkedEvent.start.getTime()}`,
                    round: "Partido Oficial",
                    date: m.linkedEvent.start.toISOString().split('T')[0],
                    opponent: m.linkedEvent.opponent,
                    venue: m.linkedEvent.venue,
                    stadium: m.linkedEvent.location,
                    result: "0-0", 
                    outcome: "empate",
                    isImported: true,
                    mvp: typeof calculateAutoMVP === 'function' ? calculateAutoMVP(m.playerStats) : null,
                    playerStats: m.playerStats
                };
                matches.push(finalMatch);
            } else {
                skippedCount++;
                skippedLog.push(`- ${m.opponent} (${m.originalDate}): ${m.skipReason || "Error desconocido"}.`);
            }
        }
    });

    saveData('matches', matches);
    
    // Repintar UI
    if (typeof renderMatches === 'function') renderMatches();
    if (typeof renderStats === 'function') renderStats();
    if (typeof renderPrincipal === 'function') renderPrincipal();
    if (typeof renderTrafficLight === 'function') renderTrafficLight();
    
    let msg = `üìä Resultado de la Importaci√≥n:\n\n‚úÖ ${linkedCount} partidos importados correctamente.`;
    if (skippedCount > 0) {
        msg += `\n\n‚ö†Ô∏è ${skippedCount} partidos OMITIDOS:\n${skippedLog.join('\n')}`;
    }
    alert(msg);
}

        function toggleCSVInfo() {
            const modal = document.getElementById('csv-info-modal');
            modal.classList.toggle('hidden');
        }
        // ==========================================
        // GUERRA DE L√çNEAS (LINE WARS)
        // ==========================================
        
        let lineWarsChart = null;

       /* ==========================================================================
   GR√ÅFICO LINE WARS (CON MEDIAS GLOBALES)
   ========================================================================== */
/* ==========================================================================
   GR√ÅFICO LINE WARS (CON MEDIAS GLOBALES)
   ========================================================================== */
function renderLineWarsChart() {
    const ctx = document.getElementById('chart-line-wars');
    if (!ctx) return;

    const matches = getData('matches').sort((a, b) => new Date(a.date) - new Date(b.date));
    const players = getPlayers();

    if (matches.length === 0) return;

    // Arrays de datos para el gr√°fico
    const labels = [];
    const dataDef = [];
    const dataMid = [];
    const dataFwd = [];

    // Acumuladores globales para medias totales
    let totalSumDef = 0, totalCountDef = 0;
    let totalSumMid = 0, totalCountMid = 0;
    let totalSumFwd = 0, totalCountFwd = 0;

    matches.forEach(m => {
        // Etiqueta del eje X (Rival)
        labels.push(m.opponent.substring(0, 3).toUpperCase());

        // Acumuladores para este partido
        let sumDef = 0, countDef = 0;
        let sumMid = 0, countMid = 0;
        let sumFwd = 0, countFwd = 0;

        m.playerStats.forEach(ps => {
            // Solo si jug√≥ y tiene nota v√°lida (> 0)
            if ((ps.rating || ps.rating === 0) && ps.minutes > 0 && parseFloat(ps.rating) > 0) {
                const p = players.find(pl => pl.id === ps.playerId);
                if (p) {
                    const nota = parseFloat(ps.rating);
                    
                    if (p.posicion === 'defensa') {
                        sumDef += nota; countDef++;
                        totalSumDef += nota; totalCountDef++;
                    } else if (p.posicion === 'centrocampista') {
                        sumMid += nota; countMid++;
                        totalSumMid += nota; totalCountMid++;
                    } else if (p.posicion === 'delantero' || p.posicion === 'extremo') {
                        sumFwd += nota; countFwd++;
                        totalSumFwd += nota; totalCountFwd++;
                    }
                }
            }
        });

        // Calcular medias del partido (null si no hay datos para romper la l√≠nea)
        dataDef.push(countDef > 0 ? (sumDef / countDef).toFixed(2) : null);
        dataMid.push(countMid > 0 ? (sumMid / countMid).toFixed(2) : null);
        dataFwd.push(countFwd > 0 ? (sumFwd / countFwd).toFixed(2) : null);
    });

    // --- ACTUALIZAR LEYENDA CON MEDIAS GLOBALES ---
    const avgDef = totalCountDef > 0 ? (totalSumDef / totalCountDef).toFixed(2) : '-';
    const avgMid = totalCountMid > 0 ? (totalSumMid / totalCountMid).toFixed(2) : '-';
    const avgFwd = totalCountFwd > 0 ? (totalSumFwd / totalCountFwd).toFixed(2) : '-';

    // Buscamos los contenedores de la leyenda (Asumiendo que tienes spans o divs con estos IDs o clases)
    // Si no tienes IDs, a√±ade id="legend-def", "legend-mid", "legend-fwd" a los textos de la leyenda en tu HTML
    const legendDef = document.getElementById('legend-def-val') || document.querySelector('.legend-def span');
    const legendMid = document.getElementById('legend-mid-val') || document.querySelector('.legend-mid span');
    const legendFwd = document.getElementById('legend-fwd-val') || document.querySelector('.legend-fwd span');

    // Si existen, actualizamos el texto
    if (legendDef) legendDef.textContent = `Defensa (${avgDef})`;
    if (legendMid) legendMid.textContent = `Medio (${avgMid})`;
    if (legendFwd) legendFwd.textContent = `Delantera (${avgFwd})`;

    // Destruir gr√°fico anterior
    if (typeof lineWarsChart !== 'undefined' && lineWarsChart) {
        lineWarsChart.destroy();
    }

    const isDark = document.body.classList.contains('dark-mode');
    const gridColor = isDark ? '#334155' : '#f3f4f6';
    const textColor = isDark ? '#94a3b8' : '#6b7280';

    // Crear Gr√°fico
    // @ts-ignore (Si usas TS)
    lineWarsChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: labels,
            datasets: [
                {
                    label: `Defensa (Media: ${avgDef})`, // Tooltip mostrar√° la media
                    data: dataDef,
                    borderColor: '#3b82f6',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.3,
                    pointRadius: 3,
                    pointHoverRadius: 6
                },
                {
                    label: `Medio (Media: ${avgMid})`,
                    data: dataMid,
                    borderColor: '#10b981',
                    backgroundColor: 'rgba(16, 185, 129, 0.1)',
                    tension: 0.3,
                    pointRadius: 3,
                    pointHoverRadius: 6
                },
                {
                    label: `Delantera (Media: ${avgFwd})`,
                    data: dataFwd,
                    borderColor: '#f43f5e',
                    backgroundColor: 'rgba(244, 63, 94, 0.1)',
                    tension: 0.3,
                    pointRadius: 3,
                    pointHoverRadius: 6
                }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            interaction: {
                mode: 'index',
                intersect: false,
            },
            plugins: {
                legend: { display: false }, // Mantenemos leyenda oculta porque usamos la HTML
                tooltip: {
                    callbacks: {
                        title: (context) => matches[context[0].dataIndex].opponent
                    }
                }
            },
            scales: {
                y: {
                    min: 4,
                    max: 10,
                    grid: { color: gridColor },
                    ticks: { color: textColor }
                },
                x: {
                    grid: { display: false },
                    ticks: { color: textColor, font: { size: 10 } }
                }
            }
        }
    });
}
        // ==========================================
        // ROSCO DE MINUTOS (ROTACIONES)
        // ==========================================
        
        let minutesChart = null;

        function renderMinutesChart() {
            const ctx = document.getElementById('chart-minutes-doughnut');
            if (!ctx) return;

            const matches = getData('matches');
            const players = getActivePlayers().filter(p => p.posicion !== 'entrenador'); // Solo jugadores de campo

            if (matches.length === 0) return;

            // 1. Calcular Minutos por Jugador
            let totalTeamMinutes = 0;
            const playerMinutes = players.map(p => {
                let mins = 0;
                matches.forEach(m => {
                    const ps = m.playerStats.find(s => s.playerId === p.id);
                    if (ps) mins += (ps.minutes || 0);
                });
                totalTeamMinutes += mins;
                return { 
                    name: p.apodo || p.apellido, 
                    minutes: mins,
                    id: p.id
                };
            });

            // 2. Ordenar: Los que m√°s juegan primero
            playerMinutes.sort((a, b) => b.minutes - a.minutes);

            // Filtrar los que tienen 0 minutos (para no ensuciar)
            const activeRotation = playerMinutes.filter(p => p.minutes > 0);

            // 3. Actualizar Datos Clave (Cajitas de al lado)
            if (activeRotation.length > 0) {
                document.getElementById('min-max-player').textContent = activeRotation[0].name;
                document.getElementById('min-max-value').textContent = activeRotation[0].minutes + "'";
                
                const last = activeRotation[activeRotation.length - 1];
                document.getElementById('min-min-player').textContent = last.name;
                document.getElementById('min-min-value').textContent = last.minutes + "'";
                
                document.getElementById('total-season-minutes').textContent = (totalTeamMinutes / 11).toFixed(0) + "'"; // Promedio por posici√≥n aprox
            }

            // 4. Configurar Colores (Escala de Azules/Verdes o Multicolor)
            // Usaremos una paleta din√°mica para que se distingan bien
            const colors = [
                '#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', 
                '#ec4899', '#6366f1', '#14b8a6', '#f97316', '#84cc16',
                '#06b6d4', '#d946ef', '#eab308', '#64748b', '#a855f7'
            ];

            // Repetir colores si hay muchos jugadores
            const bgColors = activeRotation.map((_, i) => colors[i % colors.length]);

            // 5. Renderizar Gr√°fico
            if (minutesChart) minutesChart.destroy();

            const isDark = document.body.classList.contains('dark-mode');
            const textColor = isDark ? '#e2e8f0' : '#4b5563';

            minutesChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: activeRotation.map(p => p.name),
                    datasets: [{
                        data: activeRotation.map(p => p.minutes),
                        backgroundColor: bgColors,
                        borderWidth: 2,
                        borderColor: isDark ? '#1e293b' : '#ffffff',
                        hoverOffset: 10
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%', // Hace el agujero del donut m√°s grande
                    layout: { padding: 10 },
                    plugins: {
                        legend: { display: false }, // Ocultamos leyenda porque son muchos nombres
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const val = context.raw;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const pct = ((val / total) * 100).toFixed(1);
                                    return ` ${val} min (${pct}%)`;
                                }
                            }
                        },
                        // Plugin de etiquetas (Datallabels)
                        datalabels: {
                            color: isDark ? '#fff' : '#333',
                            font: { weight: 'bold', size: 9 },
                            formatter: (value, ctx) => {
                                // Solo mostrar nombre si el trozo es lo bastante grande (>4%)
                                const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
                                const pct = (value / total) * 100;
                                return pct > 4 ? ctx.chart.data.labels[ctx.dataIndex] : '';
                            },
                            anchor: 'center',
                            align: 'center',
                            offset: 0
                        }
                    }
                }
            });
        }
        // ==========================================
        // HELPER: Pizarra de Solo Lectura (Detalles)
        // ==========================================
        function renderReadOnlyPitch(containerId, pitchMap, formation) {
            const container = document.getElementById(containerId);
            if (!container) return;

            const coords = FORMACIONES[formation] || FORMACIONES['4-3-3'];

            let html = `
                <div class="pitch-container" style="height: 100%; width: 100%; cursor: default; position: relative;">
                    <div class="pitch-line-mid"></div>
                    <div class="pitch-circle"></div>
                    <div class="pitch-box-left"></div>
                    <div class="pitch-box-right"></div>
            `;

            coords.forEach((pos, index) => {
                // Buscamos directamente en el mapa por el √≠ndice del slot
                const player = pitchMap[index];
                
                if (player) {
                    html += `
                        <div class="player-token" style="top: ${pos.top}%; left: ${pos.left}%; transform: translate(-50%, -50%) scale(0.9); border-color: #fbbf24; position: absolute;">
                            <img src="${player.foto}" style="object-position: top !important;" onerror="this.src='https://via.placeholder.com/40'">
                            <div class="player-token-name bg-slate-800 text-white">${player.apodo || player.apellido}</div>
                            <div class="absolute -top-2 -right-2 bg-amber-500 text-white text-[9px] font-bold px-1 rounded-full border border-white">
                                ${player.rating || '-'}
                            </div>
                        </div>
                    `;
                }
            });

            html += '</div>';
            container.innerHTML = html;
        }

function handleEditMatchSubmit(e) {
    if(e) e.preventDefault();
    
    try {
        const matchId = document.getElementById('edit-match-id').value;
        const matches = getData('matches');
        const matchIndex = matches.findIndex(m => m.id === matchId);
        if (matchIndex === -1) throw new Error("Partido no encontrado");
        
        const matchToUpdate = matches[matchIndex];
        
        // 1. Datos B√°sicos
        matchToUpdate.result = document.getElementById('edit-result-val').value;
        matchToUpdate.formation = document.getElementById('edit-formation-select').value;
        matchToUpdate.outcome = calculateMatchOutcome(matchToUpdate.result, matchToUpdate.venue);

        // 2. Jugadores
        const statsContainer = document.getElementById('edit-stats-list');
        const newPlayerStats = [];
        
        // Mapa de la pizarra para guardar el slot exacto
        const pitchMap = {};
        for (let i=0; i<11; i++) {
            const pid = currentPitchPlayers[`edit-slot-${i}`];
            if(pid) pitchMap[pid] = i;
        }

        statsContainer.querySelectorAll('[data-player-id]').forEach(row => {
            const playerId = row.getAttribute('data-player-id');
            const rol = row.getAttribute('data-rol');
            const isStarter = rol === 'Titular';
            
            // Leer inputs (Strings con comas)
            const goalsStr = row.querySelector('.stat-goals-minutes')?.value || "";
            const assistsStr = row.querySelector('.stat-assists-minutes')?.value || "";
            const yellowStr = row.querySelector('.stat-yellow-minutes')?.value || "";
            const redStr = row.querySelector('.stat-red-minutes')?.value || "";
            
            const count = (str) => (!str) ? 0 : str.split(',').filter(s => s.trim() !== '').length;
            const minsVal = parseInt(row.querySelector('.stat-minutes')?.value) || 0;
            const ratingVal = row.querySelector('.stat-rating')?.value;
            const typesInput = row.querySelector('.stat-goals-types');
            let goalTypes = [];
            if (typesInput && typesInput.value) {
                try {
                    goalTypes = JSON.parse(typesInput.value);
                } catch(e) { goalTypes = []; }
            }
            newPlayerStats.push({
                playerId,
                isStarter,
                pitchSlot: isStarter ? pitchMap[playerId] : null,
                rating: ratingVal ? parseFloat(ratingVal) : null,
                minutes: minsVal,
                goals: count(goalsStr),
                assists: count(assistsStr),
                yellowCards: count(yellowStr),
                redCards: count(redStr),
                played: minsVal > 0,
                detailGoals: goalsStr,
                detailGoalTypes: goalTypes,
                detailAssists: assistsStr,
                detailYellow: yellowStr,
                detailRed: redStr
            });
        });

        matchToUpdate.playerStats = newPlayerStats;
        matchToUpdate.mvp = calculateAutoMVP(newPlayerStats);

        saveData('matches', matches);
        
        if (typeof recalculateCompetitionState === "function") recalculateCompetitionState(matchToUpdate.competition);

        closeEditMatchModal();
        renderMatches();
        if(typeof renderStats === 'function') renderStats(); 
        if(typeof renderPrincipal === 'function') renderPrincipal();

        alert("‚úÖ Partido actualizado con √©xito.");

    } catch (err) {
        console.error(err);
        alert("Error al guardar: " + err.message);
    }
}

function backToEditLineup() {
    document.getElementById('edit-step-stats').classList.add('hidden');
    document.getElementById('edit-step-stats').classList.remove('flex');
    document.getElementById('edit-step-lineup').classList.remove('hidden');
}

/* ========================================================= */
/* üõ†Ô∏è FUNCIONES DE ESTAD√çSTICAS Y MODALES DE MINUTOS/GOLES */
/* ========================================================= */

// --- 1. FUNCI√ìN PRINCIPAL: CARGAR FORMULARIO DE ESTAD√çSTICAS ---
function goToEditStats() {
    console.log("‚û°Ô∏è Pasando a Estad√≠sticas...");
    
    ensureGoalTagModal();

    // 1. Recoger datos
    const starterIds = Object.values(currentPitchPlayers).filter(id => id);
    const subIds = currentSubstitutes || []; 
    const players = getPlayers();
    
    const matchId = document.getElementById('edit-match-id').value;
    const matches = getData('matches');
    const match = matches.find(m => m.id === matchId);
    
    const coach = players.find(p => p.posicion === 'entrenador');

    let roster = [];
    
    // Recorremos las entradas para capturar la posici√≥n (slot)
    Object.entries(currentPitchPlayers).forEach(([key, id]) => {
        if (!id) return;
        const p = players.find(pl => pl.id === id);
        if(p) {
            let pitchSlot = null;
            const match = key.match(/-(\d+)$/);
            if (match) pitchSlot = parseInt(match[1]);
            roster.push({ ...p, rol: 'Titular', isStarter: true, pitchSlot: pitchSlot });
        }
    });
    
    subIds.forEach(id => {
        const p = players.find(pl => pl.id === id);
        if(p && p.posicion !== 'entrenador' && !roster.find(r => r.id === p.id)) {
            roster.push({ ...p, rol: 'Suplente', isStarter: false });
        }
    });
    if(coach) roster.push({ ...coach, rol: 'Entrenador', isStarter: false });

    // Ordenar lista
    roster.sort((a, b) => {
        if (a.rol === 'Entrenador') return 1;
        if (b.rol === 'Entrenador') return -1;
        if (a.isStarter && !b.isStarter) return -1;
        if (!a.isStarter && b.isStarter) return 1;
        if (a.isStarter && b.isStarter && typeof a.pitchSlot === 'number' && typeof b.pitchSlot === 'number') {
            return a.pitchSlot - b.pitchSlot;
        }
        return 0;
    });

    // 2. Renderizar
    const container = document.getElementById('edit-stats-list');
    
    container.innerHTML = roster.map(p => {
        const prevStats = match.playerStats ? match.playerStats.find(ps => ps.playerId === p.id) : null;
        
        // Datos previos
        const goalsStr = prevStats?.detailGoals || "";
        const assistsStr = prevStats?.detailAssists || "";
        const yellowStr = prevStats?.detailYellow || "";
        const redStr = prevStats?.detailRed || "";
        const goalTypes = prevStats?.detailGoalTypes || []; 
        const ratingVal = prevStats?.rating || "";
        const minsVal = prevStats ? prevStats.minutes : (p.rol === 'Titular' ? 90 : 0);

        // Contadores
        const count = (str) => (!str) ? 0 : str.split(',').filter(s => s.trim() !== '').length;
        const gC = count(goalsStr) || (prevStats?.goals || 0);
        const aC = count(assistsStr) || (prevStats?.assists || 0);
        const yC = count(yellowStr) || (prevStats?.yellowCards || 0);
        const rC = count(redStr) || (prevStats?.redCards || 0);

        // Estilos
        const btnBase = "w-full h-9 border rounded text-sm font-bold flex items-center justify-center transition-all ";
        const btnStyle = (c, color='indigo') => c > 0 
            ? btnBase + `bg-${color}-100 text-${color}-700 border-${color}-300` 
            : btnBase + "bg-white text-gray-700 border-gray-300 hover:border-indigo-400";

        // IDs
        const prefix = 'edit-';
        const goalId = `${prefix}goals-${p.id}`;
        const assistId = `${prefix}assists-${p.id}`;
        const yellowId = `${prefix}yellow-${p.id}`;
        const redId = `${prefix}red-${p.id}`;
        
        const isCoach = p.rol === 'Entrenador';

        // Badge
        let badgeHtml = '';
        if (isCoach) badgeHtml = '<span class="bg-gray-200 text-gray-700 text-[10px] font-bold px-2 py-1 rounded">STAFF</span>';
        else if (p.rol === 'Titular') badgeHtml = '<span class="bg-emerald-100 text-emerald-700 text-[10px] font-bold px-2 py-1 rounded border border-emerald-200">TITULAR</span>';
        else badgeHtml = '<span class="bg-blue-50 text-blue-600 text-[10px] font-bold px-2 py-1 rounded border border-blue-100">SUPLENTE</span>';

        // --- HTML CONDICIONAL PARA ENTRENADOR ---
        // Si es entrenador, mostramos un guion gris en vez del input en Goles, Asistencias y Minutos.
        
        const goalsInputHtml = isCoach 
            ? `<div class="w-full h-9 flex items-center justify-center text-gray-300 text-lg select-none bg-gray-50 border border-gray-100 rounded">-</div>`
            : `<input type="hidden" class="stat-goals-minutes" id="${goalId}" value="${goalsStr}">
               <input type="hidden" class="stat-goals-types" id="${goalId}-types" value='${JSON.stringify(goalTypes)}'>
               <button type="button" id="btn-${goalId}" onclick="openMinuteModal('${goalId}', 'Goles ‚öΩ')" class="${btnStyle(gC)}">${gC}</button>`;

        const assistsInputHtml = isCoach
            ? `<div class="w-full h-9 flex items-center justify-center text-gray-300 text-lg select-none bg-gray-50 border border-gray-100 rounded">-</div>`
            : `<input type="hidden" class="stat-assists-minutes" id="${assistId}" value="${assistsStr}">
               <button type="button" id="btn-${assistId}" onclick="openMinuteModal('${assistId}', 'Asistencias üëü')" class="${btnStyle(aC)}">${aC}</button>`;

        const minsInputHtml = isCoach
            ? `<div class="w-full h-9 flex items-center justify-center text-gray-300 text-lg select-none bg-gray-50 border border-gray-100 rounded">-</div>`
            : `<input type="number" class="stat-minutes w-full h-9 px-2 border border-gray-300 rounded text-center text-gray-600 font-mono" value="${minsVal}">`;

        return `
        <div class="bg-white rounded-lg p-3 border border-gray-200 shadow-sm flex flex-col md:flex-row items-center gap-4" data-player-id="${p.id}" data-rol="${p.rol}">
             
             <div class="flex items-center gap-3 w-full md:w-1/3 min-w-[200px]">
                <img src="${p.foto}" class="w-10 h-10 rounded-full object-cover border border-gray-200" onerror="this.src='https://via.placeholder.com/40'">
                <div class="flex-1">
                    <div class="flex justify-between items-center">
                        <span class="font-bold text-gray-800 text-sm truncate pr-2">${p.apodo || p.apellido}</span>
                        ${badgeHtml}
                    </div>
                    <span class="text-xs text-gray-400">#${p.dorsal} - ${p.posicion}</span>
                </div>
            </div>

            <div class="flex-1 grid grid-cols-5 gap-3 w-full">
                 
                 <div class="flex flex-col"><label class="text-[9px] uppercase font-bold text-gray-400 mb-1">Nota</label>
                 <input type="number" step="0.1" class="stat-rating w-full h-9 px-2 border border-gray-300 rounded text-center font-bold" value="${ratingVal}" placeholder="-"></div>

                 <div class="flex flex-col">
                    <label class="text-[9px] uppercase font-bold text-gray-400 mb-1">Gol</label>
                    ${goalsInputHtml}
                 </div>

                 <div class="flex flex-col"><label class="text-[9px] uppercase font-bold text-gray-400 mb-1">Asis</label>
                    ${assistsInputHtml}
                 </div>

                 <div class="flex flex-col"><label class="text-[9px] uppercase font-bold text-gray-400 mb-1">Min</label>
                    ${minsInputHtml}
                 </div>

                 <div class="flex flex-col items-center"><label class="text-[9px] uppercase font-bold text-gray-400 mb-1">Tarj</label>
                    <div class="flex gap-1 w-full">
                        <div class="flex-1">
                            <input type="hidden" class="stat-yellow-minutes" id="${yellowId}" value="${yellowStr}">
                            <button type="button" id="btn-${yellowId}" onclick="openMinuteModal('${yellowId}', 'Amarilla')" class="${btnStyle(yC, 'yellow')}">${yC}</button>
                        </div>
                        <div class="flex-1">
                            <input type="hidden" class="stat-red-minutes" id="${redId}" value="${redStr}">
                            <button type="button" id="btn-${redId}" onclick="openMinuteModal('${redId}', 'Roja')" class="${btnStyle(rC, 'red')}">${rC}</button>
                        </div>
                    </div>
                 </div>
            </div>
        </div>`;
    }).join('');

    // Cambiar vista
    document.getElementById('edit-step-lineup').classList.add('hidden');
    document.getElementById('edit-step-stats').classList.remove('hidden');
    document.getElementById('edit-step-stats').classList.add('flex');
}


        // --- AUTO-ROJA: Funci√≥n para detectar 2 amarillas ---
window.checkAutoRedCard = function(yellowInput) {
    // 1. Obtenemos el valor actual de amarillas
    const amarillas = parseInt(yellowInput.value) || 0;

    // 2. Si llega a 2 (o m√°s)
    if (amarillas >= 2) {
        // 3. Buscamos la fila del jugador (usando el atributo data-player-id como referencia)
        const row = yellowInput.closest('[data-player-id]'); 
        
        if (row) {
            // 4. Buscamos el input de rojas dentro de esa misma fila
            const redInput = row.querySelector('.stat-red');
            
            // 5. Si existe y actualmente es 0, le ponemos 1
            if (redInput) {
                redInput.value = 1;
                
                // (Opcional) Efecto visual r√°pido para indicar el cambio
                redInput.style.backgroundColor = '#fee2e2'; // Un rojo suave
                setTimeout(() => redInput.style.backgroundColor = '', 500);
            }
        }
    }
};
// =============================================================================
// 4. SISTEMA DE LOGROS (TROPHY ROOM)
// =============================================================================

const ACHIEVEMENTS_CONFIG = [
    {
        id: 'hat_trick',
        icon: 'üé©',
        title: 'Hat-Trick Hero',
        desc: 'Marcar 3 o m√°s goles en un solo partido.',
        check: (players, matches) => {
            const winners = [];
            matches.forEach(m => {
                m.playerStats.forEach(ps => {
                    if (ps.goals >= 3) {
                        const p = players.find(pl => pl.id === ps.playerId);
                        // Evitar duplicados si el mismo jugador lo hace varias veces, o mostrarlo varias veces (opcional)
                        // Aqu√≠ mostramos cada vez que ocurre con la fecha
                        if (p) winners.push({ p, detail: `vs ${m.opponent}` });
                    }
                });
            });
            return winners;
        }
    },
    {
        id: 'wall',
        icon: 'üß±',
        title: 'El Muro',
        desc: 'Portero que mantiene la porter√≠a a cero en un partido completo.',
        check: (players, matches) => {
            const winners = [];
            matches.forEach(m => {
                // 1. Ver si el equipo NO encaj√≥ goles
                let opponentGoals = 0;
                const parts = m.result.split('-');
                if (parts.length === 2) {
                    opponentGoals = m.venue === 'local' ? parseInt(parts[1]) : parseInt(parts[0]);
                }

                if (opponentGoals === 0) {
                    // 2. Buscar portero titular
                    m.playerStats.forEach(ps => {
                        const p = players.find(pl => pl.id === ps.playerId);
                        // Asumimos que si es portero y titular cuenta (simplificaci√≥n)
                        if (p && (p.posicion === 'portero' || p.posicion === 'portera') && ps.isStarter) {
                            winners.push({ p, detail: `vs ${m.opponent}` });
                        }
                    });
                }
            });
            return winners;
        }
    },
    {
        id: 'sniper',
        icon: 'üéØ',
        title: 'Francotirador',
        desc: 'Marcar gol en 3 partidos consecutivos.',
        check: (players, matches) => {
            const winners = [];
            // Ordenar cronol√≥gicamente
            const sortedMatches = [...matches].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            players.forEach(p => {
                let streak = 0;
                let maxStreak = 0;
                
                sortedMatches.forEach(m => {
                    const stats = m.playerStats.find(ps => ps.playerId === p.id);
                    if (stats && stats.goals > 0) {
                        streak++;
                    } else if (stats && stats.played) {
                        // Si jug√≥ y no marc√≥, se rompe la racha
                        streak = 0;
                    }
                    // Si no jug√≥, mantenemos la racha (opcional, o la rompemos)
                    if (streak > maxStreak) maxStreak = streak;
                });

                if (maxStreak >= 3) {
                    winners.push({ p, detail: `${maxStreak} seguidos` });
                }
            });
            return winners;
        }
    },
    {
        id: 'super_sub',
        icon: '‚ö°',
        title: 'Revulsivo de Oro',
        desc: 'Jugador con m√°s goles saliendo desde el banquillo (M√≠nimo 2).',
        check: (players, matches) => {
            const subGoals = {};
            matches.forEach(m => {
                m.playerStats.forEach(ps => {
                    if (!ps.isStarter && ps.goals > 0) {
                        subGoals[ps.playerId] = (subGoals[ps.playerId] || 0) + ps.goals;
                    }
                });
            });
            
            // Filtrar los que tengan >= 2
            const winners = [];
            Object.keys(subGoals).forEach(pid => {
                if (subGoals[pid] >= 2) {
                    const p = players.find(pl => pl.id === pid);
                    if (p) winners.push({ p, detail: `${subGoals[pid]} goles` });
                }
            });
            return winners.sort((a,b) => parseInt(b.detail) - parseInt(a.detail)); // Ordenar por cantidad
        }
    },
    {
        id: 'butcher',
        icon: 'üü®',
        title: 'El Carnicero',
        desc: 'Jugador que acumula m√°s tarjetas (Amarillas + Rojas) esta temporada.',
        check: (players, matches) => {
            const cards = {};
            matches.forEach(m => {
                m.playerStats.forEach(ps => {
                    const total = (ps.yellowCards || 0) + (ps.redCards || 0);
                    if (total > 0) cards[ps.playerId] = (cards[ps.playerId] || 0) + total;
                });
            });
            
            // Top 3 "carniceros" (m√≠nimo 3 tarjetas para salir)
            const winners = [];
            Object.keys(cards).forEach(pid => {
                if (cards[pid] >= 3) {
                    const p = players.find(pl => pl.id === pid);
                    if (p) winners.push({ p, detail: `${cards[pid]} üü®üü•` });
                }
            });
            return winners.sort((a,b) => parseInt(b.detail) - parseInt(a.detail)).slice(0, 3);
        }
    },
    {
        id: 'mvp_king',
        icon: 'üëë',
        title: 'MVP de la Temporada',
        desc: 'Jugador que ha ganado el premio MVP m√°s veces (M√≠nimo 3).',
        check: (players, matches) => {
            const mvps = {};
            matches.forEach(m => {
                if (m.mvp) {
                    mvps[m.mvp] = (mvps[m.mvp] || 0) + 1;
                }
            });
            
            const winners = [];
            Object.keys(mvps).forEach(pid => {
                if (mvps[pid] >= 3) {
                    const p = players.find(pl => pl.id === pid);
                    if (p) winners.push({ p, detail: `${mvps[pid]} veces` });
                }
            });
            return winners.sort((a,b) => parseInt(b.detail) - parseInt(a.detail));
        }
    }
];

function openTrophyRoom() {
    const modal = document.getElementById('trophy-modal');
    if (!modal) return; // Seguridad

    const container = document.getElementById('trophy-container');
    container.innerHTML = ''; // Limpiar

    const players = getPlayers();
    const matches = getData('matches');

    let totalUnlocked = 0;

    ACHIEVEMENTS_CONFIG.forEach(ach => {
        // Ejecutar la funci√≥n de chequeo de cada logro
        const winners = ach.check(players, matches);
        const isUnlocked = winners.length > 0;
        if (isUnlocked) totalUnlocked++;

        // Crear tarjeta HTML
        const card = document.createElement('div');
        card.className = `trophy-card ${isUnlocked ? 'trophy-unlocked trophy-rare' : 'trophy-locked'}`;
        
        let winnersHtml = '';
        if (isUnlocked) {
            winnersHtml = `<div class="trophy-winners">`;
            // Mostrar m√°ximo 5 ganadores para no saturar
            winners.slice(0, 5).forEach(w => {
                winnersHtml += `
                    <div class="winner-badge">
                        <img src="${w.p.foto}" class="w-4 h-4 rounded-full object-cover">
                        <span>${w.p.apodo || w.p.apellido}</span>
                        <span class="text-xs text-gray-500 font-normal">(${w.detail})</span>
                    </div>
                `;
            });
            if (winners.length > 5) {
                winnersHtml += `<span class="text-xs text-gray-400 flex items-center">+${winners.length - 5} m√°s</span>`;
            }
            winnersHtml += `</div>`;
        } else {
            winnersHtml = `<div class="mt-4 text-xs text-gray-400 italic">Nadie ha conseguido esto todav√≠a...</div>`;
        }

        card.innerHTML = `
            <span class="trophy-icon">${ach.icon}</span>
            <div class="trophy-title">${ach.title}</div>
            <div class="trophy-desc">${ach.desc}</div>
            ${winnersHtml}
        `;
        container.appendChild(card);
    });

    // Actualizar contador del t√≠tulo
    document.getElementById('trophy-count').textContent = `${totalUnlocked}/${ACHIEVEMENTS_CONFIG.length}`;

    modal.classList.add('active');
}

function closeTrophyRoom() {
    document.getElementById('trophy-modal').classList.remove('active');
}
// ==========================================
// FUNCIONES AUXILIARES PARA LA FICHA DE JUGADOR
// (P√©galas al final de tu archivo JS)
// ==========================================

// 1. FUNCI√ìN PARA CAMBIAR DE PESTA√ëA
function switchPlayerTab(tabName) {
    // 1. Ocultar todos los contenidos y desactivar botones
    ['visual', 'history', 'fut'].forEach(t => {
        const content = document.getElementById(`tab-content-${t}`);
        const btn = document.getElementById(`tab-btn-${t}`);
        
        if(content) content.classList.add('hidden');
        if(btn) {
            // Estilo inactivo
            btn.className = "pb-3 text-sm font-medium border-b-2 border-transparent text-gray-400 hover:text-gray-600 transition-colors flex items-center gap-2";
        }
    });

    // 2. Mostrar el seleccionado
    const activeContent = document.getElementById(`tab-content-${tabName}`);
    const activeBtn = document.getElementById(`tab-btn-${tabName}`);

    if (activeContent) activeContent.classList.remove('hidden');
    if (activeBtn) {
        // Estilo activo
        activeBtn.className = "pb-3 text-sm font-bold border-b-2 border-indigo-600 text-indigo-600 transition-colors flex items-center gap-2";
    }
}

// 3. GENERADOR DE LA PESTA√ëA HISTORIAL (TABLA)
function renderHistoryTab(player, matches) {
    const isCoach = player.posicion === 'entrenador';
    
    // Helpers seguros
    const safeDate = (d) => typeof formatDate === 'function' ? formatDate(d) : d;
    const safeColor = (r) => typeof getRatingColor === 'function' ? getRatingColor(r) : '';

    if (matches.length === 0) {
        return `<div class="text-center py-10 text-gray-400 italic">No hay partidos registrados.</div>`;
    }

    return `
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left">
                    <thead class="bg-gray-50 text-gray-500 font-bold uppercase text-xs">
                        <tr>
                            <th class="px-4 py-3">Fecha / Rival</th>
                            <th class="px-4 py-3 text-center">Rol</th>
                            <th class="px-4 py-3 text-center">Nota</th>
                            <th class="px-4 py-3 text-center text-emerald-600">G</th>
                            <th class="px-4 py-3 text-center text-blue-600">A</th>
                            <th class="px-4 py-3 text-center">Min</th>
                            <th class="px-4 py-3 text-center">T</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100">
                        ${matches.map(m => `
                            <tr class="hover:bg-slate-50 transition-colors">
                                <td class="px-4 py-3">
                                    <div class="font-bold text-slate-700">${m.opponent}</div>
                                    <div class="text-xs text-gray-400">${safeDate(m.date)}</div>
                                </td>
                                <td class="px-4 py-3 text-center">
                                    ${(m.isStarter === true || m.isStarter === 'true') 
                                        ? '<span class="bg-green-100 text-green-700 px-2 py-0.5 rounded-full text-[10px] font-bold uppercase">Titular</span>' 
                                        : '<span class="bg-gray-100 text-gray-600 px-2 py-0.5 rounded-full text-[10px] font-bold uppercase">Suplente</span>'}
                                </td>
                                <td class="px-4 py-3 text-center font-bold text-base ${safeColor(m.rating)}">
                                    ${m.rating || '-'}
                                </td>
                                <td class="px-4 py-3 text-center font-medium ${m.goals > 0 ? 'text-emerald-600 font-bold' : 'text-gray-300'}">
                                    ${isCoach ? '-' : (m.goals || '-')}
                                </td>
                                <td class="px-4 py-3 text-center font-medium ${m.assists > 0 ? 'text-blue-600 font-bold' : 'text-gray-300'}">
                                    ${isCoach ? '-' : (m.assists || '-')}
                                </td>
                                <td class="px-4 py-3 text-center text-gray-500">
                                    ${isCoach ? '-' : (m.minutes || 0)}'
                                </td>
                                <td class="px-4 py-3 text-center">
                                     ${m.redCards > 0 ? 'üü•' : (m.yellowCards > 0 ? 'üü®' : '')}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        </div>
    `;
}
// =========================================================
// FUNCI√ìN PARA CERRAR EL MODAL
// =========================================================
function closePlayerDetailsModal() {
    const modal = document.getElementById('player-details-modal');
    if (!modal) return;

    // 1. Iniciamos la animaci√≥n de salida (Opacity)
    modal.classList.remove('opacity-100'); // Si usas esta clase para mostrar
    modal.classList.add('opacity-0');

    // 2. Esperamos a que termine la transici√≥n (300ms) para ocultarlo del todo
    setTimeout(() => {
        // Quitamos la clase .active que controla tu CSS
        modal.classList.remove('active'); 
        
        // Quitamos display flex y ponemos hidden
        modal.classList.remove('flex');
        modal.classList.add('hidden');

        // 3. Limpiamos el contenido para que no parpadee informaci√≥n vieja al volver a abrir
        const header = document.getElementById('player-modal-header-container');
        const content = document.getElementById('player-details-content');
        if(header) header.innerHTML = '';
        if(content) content.innerHTML = '';

        currentPlayerDetailsId = null;
    }, 300);
}

// ==========================================
// 1. L√ìGICA DE AUTO-ALINEACI√ìN
// ==========================================

function loadLastLineup() {
    const matches = getData('matches');
    if (matches.length === 0) { alert("No hay partidos previos para copiar."); return; }

    // Intentamos buscar el √∫ltimo de la MISMA competici√≥n actual
    const currentComp = document.getElementById('new-competition').value;
    let lastMatch = matches.slice().reverse().find(m => m.competition === currentComp);
    
    // Si no hay de esta compe, cogemos el √∫ltimo absoluto
    if (!lastMatch) lastMatch = matches[matches.length - 1];

    if(confirm(`¬øCargar alineaci√≥n del partido contra ${lastMatch.opponent}?`)) {
        // Filtramos solo los que fueron titulares
        const starterIds = lastMatch.playerStats
            .filter(s => s.isStarter)
            .map(s => s.playerId);
            
        applyAutoLineup(starterIds);
    }
}

function loadBestXILineup() {
    const players = getPlayers();
    const matches = getData('matches');
    
    if (matches.length === 0) { alert("Necesitas jugar partidos para calcular el Once de Gala."); return; }

    // Calcular media de todos los jugadores activos
    const ratings = players
        .filter(p => p.posicion !== 'entrenador' && p.estado === 'Activo')
        .map(p => {
            let sum = 0, count = 0;
            matches.forEach(m => {
                const ps = m.playerStats.find(s => s.playerId === p.id);
                if (ps && ps.rating) { sum += parseFloat(ps.rating); count++; }
            });
            return { id: p.id, avg: count > 0 ? sum/count : 0, pos: p.posicion };
        })
        .sort((a, b) => b.avg - a.avg); // Ordenar por mejor nota

    // Funci√≥n auxiliar para coger los mejores por posici√≥n
    const getBest = (pos, limit, excludeIds = []) => {
        return ratings
            .filter(r => r.pos === pos && !excludeIds.includes(r.id))
            .slice(0, limit)
            .map(r => r.id);
    };
    
    // Construir un 4-3-3 gen√©rico (o ad√°ptalo si prefieres otra cosa)
    const gk = getBest('portero', 1);
    const defs = getBest('defensa', 4);
    const mids = getBest('centrocampista', 3);
    // Para delanteros unimos delanteros y extremos
    const fwds = ratings
        .filter(r => (r.pos === 'delantero' || r.pos === 'extremo') && !gk.includes(r.id) && !defs.includes(r.id) && !mids.includes(r.id))
        .sort((a, b) => b.avg - a.avg)
        .slice(0, 3)
        .map(r => r.id);

    const bestXI = [...gk, ...defs, ...mids, ...fwds];

    if(bestXI.length < 11) { 
        alert("No hay suficientes datos/jugadores para formar un once completo."); 
        return; 
    }
    
    if(confirm("¬øCargar el Once de Gala basado en nota media?")) {
        applyAutoLineup(bestXI);
    }
}

function applyAutoLineup(playerIds) {
    // 1. Limpiar pizarra actual
    currentPitchPlayers = {}; 
    currentSubstitutes = [];
    
    const players = getPlayers();
    
    // 2. Ordenar jugadores entrantes por l√≥gica posicional para que caigan en orden
    // (Portero -> Defensas -> Medios -> Delanteros)
    const posOrder = { 'portero': 0, 'defensa': 1, 'centrocampista': 2, 'extremo': 3, 'delantero': 4 };
    
    const sortedIds = playerIds.sort((a, b) => {
        const pA = players.find(p => p.id === a);
        const pB = players.find(p => p.id === b);
        const orderA = pA ? posOrder[pA.posicion] : 5;
        const orderB = pB ? posOrder[pB.posicion] : 5;
        return orderA - orderB;
    });

    // 3. Asignar a los slots (0 al 10)
    sortedIds.slice(0, 11).forEach((pid, index) => {
        currentPitchPlayers[`slot-${index}`] = pid;
    });

    // 4. Los que sobren (si enviaste m√°s de 11) o el resto de la plantilla van al banquillo
    // La funci√≥n renderBench se encarga de mostrar en el banquillo a quien no est√© en el campo
    
    // 5. Repintar
    renderAll(); 
}
// ==========================================
// 2. L√ìGICA HISTOGRAMA DE NOTAS
// ==========================================
let histogramChart = null;

function renderRatingHistogram() {
    const ctx = document.getElementById('chart-rating-histogram');
    if (!ctx) return;

    const matches = getData('matches');
    
    // Buckets: <5, 5-6, 6-7, 7-8, 8-9, 9-10
    const buckets = [0, 0, 0, 0, 0, 0]; 
    
    matches.forEach(m => {
        m.playerStats.forEach(ps => {
            if (ps.rating !== null && ps.rating !== "" && ps.rating !== undefined) {
                const r = parseFloat(ps.rating);
                if (r < 5) buckets[0]++;       // Suspenso
                else if (r < 6) buckets[1]++;  // Suficiente
                else if (r < 7) buckets[2]++;  // Bien
                else if (r < 8) buckets[3]++;  // Notable
                else if (r < 9) buckets[4]++;  // Notable Alto
                else buckets[5]++;             // Sobresaliente
            }
        });
    });

    if (histogramChart) histogramChart.destroy();

    const isDark = document.body.classList.contains('dark-mode');
    const textColor = isDark ? '#cbd5e1' : '#4b5563';

    histogramChart = new Chart(ctx, {
        type: 'bar',
        data: {
            labels: ['< 5', '5 - 6', '6 - 7', '7 - 8', '8 - 9', '9 - 10'],
            datasets: [{
                label: 'Frecuencia',
                data: buckets,
                backgroundColor: [
                    '#ef4444', // Rojo (Suspenso)
                    '#f97316', // Naranja
                    '#eab308', // Amarillo
                    '#84cc16', // Lima
                    '#10b981', // Verde
                    '#3b82f6'  // Azul (Top)
                ],
                borderRadius: 6,
                borderSkipped: false
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { 
                legend: { display: false },
                datalabels: {
                    color: textColor,
                    anchor: 'end',
                    align: 'top',
                    font: { weight: 'bold' }
                }
            },
            scales: { 
                y: { beginAtZero: true, display: false },
                x: { 
                    grid: { display: false },
                    ticks: { color: textColor, font: {weight: 'bold'} }
                }
            }
        }
    });
}
// ==========================================
// 3. GENERADOR CARTA FUT (DATOS REALES)
// ==========================================
function renderFutTab(player, stats, avgRating) {
    const container = document.getElementById('tab-content-fut');
    if(!container) return;

    // --- 1. L√ìGICA DE POSICI√ìN ---
    let futPos = player.rol; 
    if (!futPos) {
        const posMap = {
            'portero': 'POR', 'defensa': 'DFC', 'centrocampista': 'MC', 
            'extremo': 'ED', 'delantero': 'DC', 'entrenador': 'ENT'
        };
        futPos = posMap[player.posicion] || 'JUG';
    }

    // --- 2. L√ìGICA DE PIE (NUEVO) ---
    // Si es "Izquierdo" (case insensitive) pone 'I', si no 'D'
    let pieLetra = 'D';
    if (player.piePreferido && player.piePreferido.toLowerCase() === 'izquierdo') {
        pieLetra = 'I';
    }
    
    // MEDIA FUT
    let futRating = parseFloat(avgRating);
    if(isNaN(futRating)) {
        futRating = "?";
    } else {
        futRating = Math.min(99, Math.round(futRating * 10) + 15); 
    }

    // L√≥gica Holo
    let cardHoloClass = '';
    if ((typeof futRating === 'number' && futRating >= 90) || player.estado === 'Leyenda') {
        cardHoloClass = 'holo-effect';
    }

    // Estad√≠sticas
    const v1 = stats.matchesPlayed || 0; const l1 = "PJ";
    const v2 = stats.goals || 0; const l2 = "GOL";
    const v3 = stats.assists || 0; const l3 = "ASI";
    const v4 = avgRating !== '-' ? avgRating : '-'; const l4 = "MED";
    const v5 = stats.starts || 0; const l5 = "TIT";
    const v6 = stats.wins || 0; const l6 = "VIC";

    const marketValue = player.valorMercado || 0; 
    const unitShort = player.unidad || 'M‚Ç¨'; 
    const unitLong = unitShort === 'K‚Ç¨' ? 'MIL ‚Ç¨' : 'MILLONES DE ‚Ç¨';

    container.innerHTML = `
        <div class="fut-card-wrapper animate-in zoom-in duration-300">
            
            <div class="fut-scene" onclick="this.classList.toggle('is-flipped')">
                <div class="fut-card-inner">
                    
                    <div class="fut-card fut-card-front ${cardHoloClass}">
                        <div style="display:flex; justify-content:center; align-items:center; gap:8px; margin-bottom:-10px; padding-left:10px;">
                            <div class="fut-rating counter-anim" data-target="${futRating}">0</div>
                            <div style="display:flex; flex-direction:column; align-items:start; line-height:1;">
                                <div class="fut-pos">${futPos}</div>
                                <div style="font-size:11px; font-weight:bold; margin-top:2px;" title="Pie ${player.piePreferido}">${pieLetra}</div>
                                <div style="font-size:10px; opacity:0.7; display:none;">RM</div> </div>
                        </div>
                        
                        <img src="${player.foto}" class="fut-img" onerror="this.src='https://via.placeholder.com/150'">
                        
                        <div class="fut-name">${player.apodo || player.apellido}</div>
                        
                        <div class="fut-stats">
                            <div title="Partidos Jugados"><span class="fut-stat-val text-green-400 counter-anim" data-target="${v1}">0</span><span class="fut-stat-label">${l1}</span></div>
                            <div title="Nota Media"><span class="fut-stat-val text-yellow-400 counter-anim" data-target="${v4}" data-float="true">0.00</span><span class="fut-stat-label">${l4}</span></div>
                            <div title="Goles"><span class="fut-stat-val text-blue-300 counter-anim" data-target="${v2}">0</span><span class="fut-stat-label">${l2}</span></div>
                            <div title="Titularidades"><span class="fut-stat-val text-gray-300 counter-anim" data-target="${v5}">0</span><span class="fut-stat-label">${l5}</span></div>
                            <div title="Asistencias"><span class="fut-stat-val text-purple-300 counter-anim" data-target="${v3}">0</span><span class="fut-stat-label">${l3}</span></div>
                            <div title="Victorias"><span class="fut-stat-val text-red-300 counter-anim" data-target="${v6}">0</span><span class="fut-stat-label">${l6}</span></div>
                        </div>
                    </div>

                    <div class="fut-card-back">
                        <div class="back-logo">‚öΩ</div>
                        <h3 class="text-xl font-bold mb-4 text-white">${player.apodo}</h3>
                        
                        <div class="back-row">
                            <span class="back-label">Nacionalidad</span>
                            <span class="back-val">${player.nacionalidad}</span>
                        </div>
                        <div class="back-row">
                            <span class="back-label">Edad</span>
                            <span class="back-val">${calculateAge(player.fechaNacimiento)} a√±os</span>
                        </div>
                        <div class="back-row">
                            <span class="back-label">Pie</span>
                            <span class="back-val">${player.piePreferido || '-'}</span>
                        </div>
                        <div class="back-row">
                            <span class="back-label">Estado</span>
                            <span class="back-val">${player.estado}</span>
                        </div>
                         <div class="back-row" style="border-bottom:none; margin-top:10px;">
                            <span class="back-label">Valor Mercado</span>
                            <span class="back-val text-2xl text-yellow-400 counter-anim" data-target="${marketValue}" data-float="${marketValue % 1 !== 0}">0</span>
                        </div>
                        <div class="text-xs text-yellow-600 font-bold mb-6">${unitLong}</div>

                        <div class="tap-hint">‚Üª Toca para girar</div>
                    </div>

                </div>
            </div>
            
            <p class="text-center text-xs text-gray-400 mt-6 italic opacity-50">
                Resumen de Temporada
            </p>
        </div>
    `;
    
    setTimeout(runCounters, 50);
}

// Funci√≥n dummy por si haces click (puedes implementarla con html2canvas m√°s tarde)
function downloadFutCard() {
    alert("Para descargar la carta, haz una captura de pantalla.");
}
function renderTierList() {
    // Solo jugadores Activos
    const players = getPlayers().filter(p => p.estado === 'Activo');
    const matches = getData('matches');
    const container = document.getElementById('tier-list-container');
    
    if (!container || matches.length === 0) return;

    // 1. Calcular medias de todos los jugadores
    const ratedPlayers = players.map(p => {
        let sum = 0, count = 0;
        matches.forEach(m => {
            const ps = m.playerStats.find(s => s.playerId === p.id);
            if (ps && ps.rating) { sum += parseFloat(ps.rating); count++; }
        });
        return { ...p, avg: count > 0 ? (sum/count) : 0 };
    }).filter(p => p.avg > 0); // Solo mostramos los que han jugado y tienen nota

    // 2. Definir los niveles (Tiers)
    const tiers = [
        { name: 'S', color: 'bg-purple-600', min: 8.5, players: [] },
        { name: 'A', color: 'bg-emerald-500', min: 7.0, players: [] },
        { name: 'B', color: 'bg-blue-500',    min: 6.0, players: [] },
        { name: 'C', color: 'bg-yellow-500',  min: 5.0, players: [] },
        { name: 'D', color: 'bg-red-500',     min: 0.0, players: [] }
    ];

    // 3. Clasificar jugadores en sus cajas
    ratedPlayers.forEach(p => {
        for (let tier of tiers) {
            if (p.avg >= tier.min) {
                tier.players.push(p);
                break; // Una vez entra en uno, deja de buscar
            }
        }
    });

    // --- NUEVO: Ordenar dentro de cada Tier (Mejor nota primero) ---
    tiers.forEach(tier => {
        tier.players.sort((a, b) => b.avg - a.avg);
    });

    // 4. Renderizar HTML
    container.innerHTML = tiers.map(tier => {
        if (tier.players.length === 0) return ''; // Ocultar tiers vac√≠os
        
        return `
            <div class="flex border border-gray-200 rounded-lg overflow-hidden mb-2 shadow-sm">
                <div class="${tier.color} w-14 flex items-center justify-center text-white font-black text-2xl shrink-0 shadow-inner">
                    ${tier.name}
                </div>
                
                <div class="flex-1 bg-gray-50 p-2 flex flex-wrap gap-3 items-center content-center">
                    ${tier.players.map(p => `
                        <div class="relative group cursor-pointer transition-transform hover:-translate-y-1" onclick="viewPlayerDetails('${p.id}')">
                            <img src="${p.foto}" 
                                 class="w-11 h-11 rounded-full border-2 border-white shadow-sm object-cover object-top" 
                                 title="${p.nombre} (${p.avg.toFixed(2)})"
                                 onerror="this.src='https://via.placeholder.com/40'">
                            
                            <span class="absolute -bottom-1.5 -right-1 bg-slate-800 text-white text-[9px] px-1.5 py-0.5 rounded-full font-bold border border-white shadow-sm z-10">
                                ${p.avg.toFixed(2)}
                            </span>
                        </div>
                    `).join('')}
                </div>
            </div>
        `;
    }).join('');
}
// ==========================================
// ANIMACI√ìN DE N√öMEROS (COUNTER UP)
// ==========================================
function runCounters() {
    const counters = document.querySelectorAll('.counter-anim');
    
    counters.forEach(counter => {
        // Leemos el valor final y si lleva decimales
        const target = parseFloat(counter.getAttribute('data-target'));
        const isFloat = counter.getAttribute('data-float') === 'true';
        
        if (isNaN(target)) return;
        
        // Configuraci√≥n
        const duration = 1200; // 1.2 segundos de animaci√≥n
        const start = 0;
        const startTime = performance.now();

        function update(currentTime) {
            const elapsed = currentTime - startTime;
            const progress = Math.min(elapsed / duration, 1);
            
            // Efecto "Ease Out" (frena al final)
            const ease = 1 - Math.pow(1 - progress, 3);
            
            const current = start + (target - start) * ease;
            
            if (isFloat) {
                counter.innerText = current.toFixed(2);
            } else {
                counter.innerText = Math.round(current);
            }

            if (progress < 1) {
                requestAnimationFrame(update);
            } else {
                // Asegurar valor final exacto
                counter.innerText = isFloat ? target.toFixed(2) : Math.round(target);
                counter.classList.remove('counter-anim'); // Evitar re-animar
            }
        }
        
        requestAnimationFrame(update);
    });
}
function triggerConfetti() {
    const colors = ['#ef4444', '#3b82f6', '#10b981', '#f59e0b', '#8b5cf6', '#ec4899'];
    const container = document.createElement('div');
    container.className = 'confetti-container';
    document.body.appendChild(container);

    // Crear 100 part√≠culas
    for (let i = 0; i < 100; i++) {
        const piece = document.createElement('div');
        piece.className = 'confetti-piece';
        
        // Propiedades aleatorias
        const bg = colors[Math.floor(Math.random() * colors.length)];
        const left = Math.random() * 100 + '%';
        const duration = Math.random() * 2 + 3; // Entre 3 y 5 segundos
        const delay = Math.random() * 2; // Retraso inicial
        const size = Math.random() * 10 + 5 + 'px';

        piece.style.backgroundColor = bg;
        piece.style.left = left;
        piece.style.width = size;
        piece.style.height = size;
        
        // Asignar animaciones
        piece.style.animation = `fall-y ${duration}s linear ${delay}s forwards, sway-x ${duration}s ease-in-out ${delay}s infinite`;
        
        container.appendChild(piece);
    }

    // Limpiar el DOM despu√©s de 6 segundos
    setTimeout(() => {
        container.remove();
    }, 6000);
}
// Funci√≥n para mostrar notificaciones elegantes
function showToast(message, type = 'success') {
    // Buscar o crear el contenedor
    let container = document.querySelector('.toast-container');
    if (!container) {
        container = document.createElement('div');
        container.className = 'toast-container';
        document.body.appendChild(container);
    }

    // Definir icono seg√∫n el tipo
    const icons = {
        success: '‚úÖ',
        error: '‚ùå',
        info: '‚ÑπÔ∏è'
    };

    // Crear el elemento Toast
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    toast.innerHTML = `
        <span class="toast-icon">${icons[type]}</span>
        <span>${message}</span>
    `;

    // A√±adir al contenedor
    container.appendChild(toast);

    // Eliminar autom√°ticamente a los 3 segundos
    setTimeout(() => {
        toast.classList.add('hide');
        // Esperar a que termine la animaci√≥n de salida para borrar del DOM
        toast.addEventListener('animationend', () => {
            toast.remove();
        });
    }, 3000);
}
async function exportLineupToImage() {
    const boardElement = document.getElementById('tactical-board-container'); 
    
    if (!boardElement) {
        console.error("No se encuentra el contenedor de la pizarra");
        return;
    }

    if(typeof showToast === 'function') showToast("üì∏ Procesando imagen...", "info");

    // 1. Ocultar botones
    const uiElements = document.querySelectorAll('.no-capture, .player-remove-btn');
    uiElements.forEach(el => el.style.display = 'none');

    try {
        // Espera m√≠nima t√©cnica para carga de im√°genes
        await new Promise(resolve => setTimeout(resolve, 500));

        const canvas = await html2canvas(boardElement, {
            useCORS: true,       
            allowTaint: true,    
            scale: 2,            
            backgroundColor: null, 
            logging: false,
            
            // --- LA SOLUCI√ìN "NUCLEAR" ---
            onclone: (clonedDoc) => {
                const tokens = clonedDoc.querySelectorAll('.player-token');
                
                tokens.forEach(t => {
                    // 1. Eliminamos la clase de animaci√≥n
                    t.classList.remove('animate-drop'); 
                    
                    // 2. FORZAMOS EL ESTADO FINAL CON !important
                    // Esto aplasta cualquier residuo del "rebote"
                    t.style.setProperty('animation', 'none', 'important');
                    t.style.setProperty('transition', 'none', 'important');
                    
                    // CRUCIAL: 'transform: none' elimina el efecto de escala/rebote
                    // y deja al jugador plano en su sitio (definido por top/left).
                    t.style.setProperty('transform', 'none', 'important'); 
                    
                    // Aseguramos visibilidad total
                    t.style.setProperty('opacity', '1', 'important');
                });
            }
        });

        // 3. Descargar
        const link = document.createElement('a');
        link.download = `Alineacion_${new Date().toISOString().slice(0,10)}.png`;
        link.href = canvas.toDataURL("image/png");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        if(typeof showToast === 'function') showToast("‚úÖ Imagen guardada", "success");

    } catch (err) {
        console.error("Error al exportar:", err);
        if(typeof showToast === 'function') showToast("‚ö†Ô∏è Error al crear la imagen.", "error");
    } finally {
        // 4. Restaurar botones
        uiElements.forEach(el => el.style.display = '');
    }
}
async function exportLineupToImage() {
    const boardElement = document.getElementById('tactical-board-container'); 
    
    if (!boardElement) {
        console.error("No se encuentra el contenedor de la pizarra");
        return;
    }

    if(typeof showToast === 'function') showToast("üì∏ Capturando...", "info");

    // 1. Ocultar botones
    const uiElements = document.querySelectorAll('.no-capture, .player-remove-btn');
    uiElements.forEach(el => el.style.display = 'none');

    // --- CONGELADO SEGURO (SAFE FREEZE) ---
    const realTokens = boardElement.querySelectorAll('.player-token');
    
    realTokens.forEach(t => {
        // 1. Quitamos la clase que provoca el movimiento de ca√≠da
        t.classList.remove('animate-drop'); 
        
        // 2. Anulamos transiciones suaves (hover, efectos)
        t.style.setProperty('transition', 'none', 'important');
        
        // 3. CAMBIO IMPORTANTE: En vez de quitar el transform (que romp√≠a el centrado),
        // forzamos a que la animaci√≥n sea NULA.
        t.style.setProperty('animation', 'none', 'important');
        
        // 4. Aseguramos que se vean
        t.style.setProperty('opacity', '1', 'important');
    });

    try {
        // Esperamos un instante para que el navegador aplique el "frenazo"
        await new Promise(resolve => setTimeout(resolve, 150));

        const canvas = await html2canvas(boardElement, {
            useCORS: true,       
            allowTaint: true,    
            scale: 2,            
            backgroundColor: null, 
            logging: false
        });

        // Descargar
        const link = document.createElement('a');
        link.download = `Alineacion_${new Date().toISOString().slice(0,10)}.png`;
        link.href = canvas.toDataURL("image/png");
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        if(typeof showToast === 'function') showToast("‚úÖ Foto guardada", "success");

    } catch (err) {
        console.error("Error al exportar:", err);
        if(typeof showToast === 'function') showToast("‚ö†Ô∏è Error al crear la imagen.", "error");
    } finally {
        // Restaurar botones
        uiElements.forEach(el => el.style.display = '');

        // Limpiar estilos forzados para que el usuario pueda seguir interactuando
        realTokens.forEach(t => {
            t.style.transition = '';
            t.style.animation = '';
            t.style.opacity = '';
        });
    }
}
function calculateSquadValue() {
    let startingValue = 0;
    let benchValue = 0;

    // 1. Obtenemos todos los jugadores disponibles
    // Si usas 'getActivePlayers()' √∫salo, si no, usa 'getPlayers()'
    const allPlayers = typeof getActivePlayers === 'function' ? getActivePlayers() : getPlayers();

    // 2. Identificamos qui√©nes est√°n en el campo ahora mismo
    // currentPitchPlayers es el objeto { "slot-0": "id_jugador", ... }
    const starterIds = Object.values(currentPitchPlayers);

    allPlayers.forEach(p => {
        // Convertimos el texto "18" o "18.5" a n√∫mero real. Si no tiene, es 0.
        const val = parseFloat(p.valorMercado || 0);
        
        // Si el ID del jugador est√° en la lista de titulares...
        if (starterIds.includes(p.id)) {
            startingValue += val;
        } else {
            // Si no est√° en el campo, asumimos que es suplente/no convocado
            benchValue += val;
        }
    });

    // Funci√≥n peque√±a para formatear bonito (ej: 150,5 M‚Ç¨)
    const formatMoney = (v) => v.toLocaleString('es-ES', { minimumFractionDigits: 0, maximumFractionDigits: 1 }) + ' M‚Ç¨';

    // 3. Crear el mensaje
    const message = `
üí∞ INFORME FINANCIERO

üî∑ Once Inicial:  ${formatMoney(startingValue)}
üî∏ Banquillo:     ${formatMoney(benchValue)}
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
üèÜ VALOR TOTAL:   ${formatMoney(startingValue + benchValue)}
    `;

    // 4. Mostrar alerta
    alert(message);
}
function updateSquadValueDisplay() {
    // 1. Verificar HTML (Ahora buscamos tambi√©n el de la edad)
    const startersLabel = document.getElementById('value-starters');
    const totalLabel = document.getElementById('value-total');
    const ageLabel = document.getElementById('value-age');
    
    if (!startersLabel || !totalLabel) return;

    // 2. Listas de IDs
    const starterIds = Object.values(currentPitchPlayers || {});
    
    // Suplentes (zona subs-zone)
    const subElements = document.querySelectorAll('#subs-zone [data-player-id]');
    const subIds = Array.from(subElements).map(el => el.getAttribute('data-player-id'));

    // 3. Variables para c√°lculo
    let startingValue = 0;
    let benchValue = 0;
    
    // Variables para Edad
    let totalAgeXI = 0;
    let countXI = 0;

    const allPlayers = getPlayers();

    allPlayers.forEach(p => {
        // --- CALCULO DINERO ---
        let valString = String(p.valorMercado || "0").replace(',', '.');
        let val = parseFloat(valString);
        if (isNaN(val)) val = 0;
        
        const pId = String(p.id);

        // Si es Titular
        if (starterIds.some(id => String(id) === pId)) {
            startingValue += val;
            
            // --- CALCULO EDAD (Solo titulares) ---
            if (p.fechaNacimiento) {
                const age = calculateAgeFromDate(p.fechaNacimiento);
                totalAgeXI += age;
                countXI++;
            }
        }
        // Si es Suplente
        else if (subIds.some(id => String(id) === pId)) {
            benchValue += val;
        }
    });

    // 4. Escribir resultados
    const formatMoney = (v) => v.toLocaleString('es-ES', { minimumFractionDigits: 0, maximumFractionDigits: 1 }) + ' M‚Ç¨';

    // Dinero
    startersLabel.innerText = formatMoney(startingValue);
    totalLabel.innerText = formatMoney(startingValue + benchValue);
    
    // Edad (Media aritm√©tica)
    if (ageLabel) {
        if (countXI > 0) {
            const avgAge = (totalAgeXI / countXI).toFixed(1); // Un decimal (ej: 26.5)
            ageLabel.innerText = avgAge + " a√±os";
        } else {
            ageLabel.innerText = "-";
        }
    }

    // Colores din√°micos
    startersLabel.className = startingValue > 0 ? "font-black text-emerald-600" : "font-black text-gray-400";
}

// Funci√≥n auxiliar para calcular edad exacta
function calculateAgeFromDate(dateString) {
    if (!dateString) return 0;
    const today = new Date();
    const birthDate = new Date(dateString);
    let age = today.getFullYear() - birthDate.getFullYear();
    const m = today.getMonth() - birthDate.getMonth();
    if (m < 0 || (m === 0 && today.getDate() < birthDate.getDate())) {
        age--;
    }
    return age;
}
let currentCaptainId = null;

function toggleCaptain(playerId) {
    // 1. Si ya es capit√°n, se lo quitamos
    if (currentCaptainId === playerId) {
        currentCaptainId = null;
    } else {
        // 2. Si no, lo nombramos nuevo capit√°n
        currentCaptainId = playerId;
    }
    // 3. Repintamos para actualizar iconos
    renderAll(); 
}
function getSquadStats() {
    // 1. Obtener IDs
    const starterIds = Object.values(currentPitchPlayers || {});
    // Buscamos suplentes en la variable global (aseg√∫rate de que currentSubstitutes est√© actualizada)
    // Si no usas la variable global, usamos el DOM como plan B:
    let subIds = currentSubstitutes || [];
    if (subIds.length === 0) {
         const subElements = document.querySelectorAll('#subs-zone [data-player-id]');
         subIds = Array.from(subElements).map(el => el.getAttribute('data-player-id'));
    }

    let startingValue = 0;
    let benchValue = 0;
    let totalAgeXI = 0;
    let countXI = 0;

    const allPlayers = getPlayers();

    allPlayers.forEach(p => {
        let val = parseFloat(String(p.valorMercado || "0").replace(',', '.')) || 0;
        const pId = String(p.id);

        // Titulares
        if (starterIds.some(id => String(id) === pId)) {
            startingValue += val;
            if (p.fechaNacimiento) {
                totalAgeXI += calculateAgeFromDate(p.fechaNacimiento);
                countXI++;
            }
        }
        // Suplentes
        else if (subIds.some(id => String(id) === pId)) {
            benchValue += val;
        }
    });

    const avgAge = countXI > 0 ? (totalAgeXI / countXI).toFixed(1) : "0.0";
    const totalValue = (startingValue + benchValue).toFixed(1);

    // Devolvemos un objeto con los dos datos
    return {
        valorTotal: totalValue, // Ej: "150.5"
        edadMedia: avgAge       // Ej: "24.5"
    };
}
function updateFormationStats() {
    const selector = document.getElementById('formation-select');
    const display = document.getElementById('formation-stats-display');
    
    if (!selector || !display) return;

    const currentFormation = selector.value; // ej: "4-2-3-1"
    const matches = getData('matches') || [];

    // 1. Filtrar partidos jugados con ESTA formaci√≥n
    // (Nota: Los partidos antiguos que no tengan 'formation' guardada no contar√°n)
    const formationMatches = matches.filter(m => m.formation === currentFormation);
    const totalPlayed = formationMatches.length;

    if (totalPlayed === 0) {
        // Si no hay datos, ocultamos o mostramos gris
        display.innerHTML = `<span class="w-2 h-2 rounded-full bg-gray-300"></span><span class="text-gray-400">Sin datos registrados</span>`;
        display.classList.remove('hidden');
        return;
    }

    // 2. Calcular Victorias
    const wins = formationMatches.filter(m => m.outcome === 'victoria').length;
    const winRate = Math.round((wins / totalPlayed) * 100);

    // 3. Decidir color seg√∫n porcentaje
    let colorClass = 'bg-gray-400'; // Por defecto
    let textClass = 'text-gray-500';

    if (winRate >= 60) {
        colorClass = 'bg-emerald-500'; // Verde (Bueno)
        textClass = 'text-emerald-700 font-bold';
    } else if (winRate >= 35) {
        colorClass = 'bg-amber-500';   // Naranja (Regular)
        textClass = 'text-amber-700 font-bold';
    } else {
        colorClass = 'bg-red-500';     // Rojo (Malo)
        textClass = 'text-red-700 font-bold';
    }

    // 4. Mostrar Resultado
    display.classList.remove('hidden');
    display.innerHTML = `
        <span class="w-2 h-2 rounded-full ${colorClass}"></span>
        <span class="${textClass}">${winRate}% Victorias</span>
        <span class="text-gray-400 ml-1">(${wins}/${totalPlayed}P)</span>
    `;
}
function renderFormationStats() {
    const tbody = document.getElementById('formation-stats-body');
    const noData = document.getElementById('formation-no-data');
    
    if (!tbody) return;

    // 1. Obtener partidos
    const matches = getData('matches') || [];
    
    // Si no hay partidos, mostrar aviso
    if (matches.length === 0) {
        tbody.innerHTML = '';
        if(noData) noData.classList.remove('hidden');
        return;
    }
    if(noData) noData.classList.add('hidden');

    // 2. Agrupar datos
    const stats = {};

    matches.forEach(m => {
        // Si es un partido antiguo sin formaci√≥n guardada, lo llamamos 'Desconocido'
        const form = m.formation || 'Desconocido';
        
        if (!stats[form]) {
            stats[form] = { played: 0, win: 0, draw: 0, loss: 0 };
        }

        stats[form].played++;
        
        if (m.outcome === 'victoria') stats[form].win++;
        else if (m.outcome === 'empate') stats[form].draw++;
        else stats[form].loss++; // derrota
    });

    // 3. Convertir a array y ordenar por % de victoria (Win Rate)
    const statsArray = Object.keys(stats).map(key => {
        const s = stats[key];
        const winRate = s.played > 0 ? ((s.win / s.played) * 100) : 0;
        return {
            name: key,
            ...s,
            winRate: winRate
        };
    }).sort((a, b) => b.winRate - a.winRate); // Ordenar: Mejor % primero

    // 4. Generar HTML
    tbody.innerHTML = statsArray.map(item => {
        // Colores para la barra de porcentaje
        let colorClass = 'bg-gray-400';
        let textClass = 'text-gray-600';

        if (item.winRate >= 60) {
            colorClass = 'bg-emerald-500';
            textClass = 'text-emerald-700 font-bold';
        } else if (item.winRate >= 35) {
            colorClass = 'bg-amber-500';
            textClass = 'text-amber-700 font-bold';
        } else {
            colorClass = 'bg-red-500';
            textClass = 'text-red-700 font-bold';
        }

        return `
            <tr class="hover:bg-gray-50 transition-colors">
                <td class="px-4 py-3 font-bold text-gray-800">
                    ${item.name}
                </td>
                <td class="px-4 py-3 text-center font-mono text-gray-600">
                    ${item.played}
                </td>
                <td class="px-4 py-3 text-center font-mono text-emerald-600 bg-emerald-50 rounded-lg">
                    ${item.win}
                </td>
                <td class="px-4 py-3 text-center font-mono text-amber-600">
                    ${item.draw}
                </td>
                <td class="px-4 py-3 text-center font-mono text-red-600">
                    ${item.loss}
                </td>
                <td class="px-4 py-3 text-center">
                    <div class="flex items-center gap-2 justify-end">
                        <div class="w-16 h-1.5 bg-gray-200 rounded-full overflow-hidden">
                            <div class="h-full ${colorClass}" style="width: ${item.winRate}%"></div>
                        </div>
                        <span class="text-xs w-10 text-right ${textClass}">${Math.round(item.winRate)}%</span>
                    </div>
                </td>
            </tr>
        `;
    }).join('');
}

function openMinuteModal(targetId, title) {
    console.log("üîì Abriendo modal minutos para:", targetId);

    const input = document.getElementById(targetId);
    if(!input) return console.error("‚ùå No existe el input oculto con ID:", targetId);

    const modal = document.getElementById('minute-modal');
    if(!modal) return console.error("‚ùå Error: No encuentro el div 'minute-modal'");

    // TRUCO DE CAPAS
    document.body.appendChild(modal); 
    modal.style.zIndex = "99999999"; 

    // Guardamos a qui√©n pertenece este modal y el t√≠tulo
    modal.dataset.targetId = targetId; 
    modal.dataset.title = title; // <--- NUEVO

    // Rellenar datos
    const modalInput = document.getElementById('minute-input-field');
    modalInput.value = input.value;
    
    document.getElementById('minute-modal-title').innerText = title || "Minutos";
    
    // Mostrar
    modal.classList.remove('hidden');
    modal.classList.add('flex');
    modal.style.display = 'flex';
    
    setTimeout(() => modalInput.focus(), 100);
}

// 2. FUNCI√ìN DE CIERRE
function closeMinuteModal() {
    const modal = document.getElementById('minute-modal');
    if(modal) {
        modal.classList.add('hidden');
        modal.style.display = 'none';
    }
}

// 3. FUNCI√ìN DE GUARDADO (¬°AQU√ç EST√Å EL DISPARADOR DE ETIQUETAS!)
function saveMinutesFromModal() {
    const modal = document.getElementById('minute-modal');
    const targetId = modal.dataset.targetId; 
    const title = modal.dataset.title || ""; // <--- RECUPERAMOS T√çTULO
    
    if(!targetId) return closeMinuteModal();
    
    const val = document.getElementById('minute-input-field').value.trim();
    
    // 1. GUARDAR EN EL INPUT OCULTO
    const hiddenInput = document.getElementById(targetId);
    if(hiddenInput) hiddenInput.value = val;
    
    // 2. ACTUALIZAR BOT√ìN VISUAL
    const btn = document.getElementById('btn-' + targetId);
    if(btn) {
        const parts = val === '' ? [] : val.split(',').filter(s => s.trim() !== '');
        const count = parts.length;
        
        btn.innerText = count;
        
        // Estilos
        const baseClasses = "w-full h-9 border rounded text-sm font-bold flex items-center justify-center transition-colors ";
        const isRed = title.includes('Roja');
        const isYellow = title.includes('Amarilla');
        
        let colorClass = "bg-indigo-100 text-indigo-700 border-indigo-300 shadow-sm";
        if(isRed) colorClass = "bg-red-100 text-red-700 border-red-300 shadow-sm";
        else if(isYellow) colorClass = "bg-yellow-100 text-yellow-700 border-yellow-300 shadow-sm";

        if (count > 0) {
            btn.className = baseClasses + colorClass;
        } else {
            btn.className = baseClasses + "bg-white text-gray-400 border-gray-300 hover:border-indigo-300 hover:text-indigo-400";
        }

        // --- MAGIA: DISPARAR ETIQUETADO SI ES UN GOL ---
        if (title.includes('Goles') || title.includes('Gol')) {
            if (count > 0) {
                // Cerramos modal minutos y abrimos etiquetador
                closeMinuteModal();
                setTimeout(() => openGoalTagging(targetId, val), 200);
                return; // Salimos para no ejecutar closeMinuteModal dos veces
            } else {
                // Si borraron los goles, limpiar etiquetas
                const typeInput = document.getElementById(targetId + '-types');
                if(typeInput) typeInput.value = '[]';
            }
        }
    }

    closeMinuteModal();
}

// 4. BOTONES R√ÅPIDOS (+45, +90)
function addMinuteToInput(text) {
    const field = document.getElementById('minute-input-field');
    if(!field) return;
    
    const val = field.value.trim();
    if (val === "") {
        field.value = text;
    } else {
        if (!val.endsWith(',') && !val.endsWith(' ')) {
             if (text !== '+') field.value += ', ';
        }
        field.value += text;
    }
    field.focus();
}
/* ========================================================= */
/* üÜï VISUAL TIMELINE GENERATOR                              */
/* ========================================================= */
function renderMatchTimeline(match) {
    // 1. Recolectar Eventos
    let events = [];
    const players = getPlayers();

    match.playerStats.forEach(ps => {
        const p = players.find(pl => pl.id === ps.playerId) || { apodo: '?', apellido: '?' };
        const name = p.apodo || p.apellido;

        // Helper para parsear "15, 45+2"
        const parseEvents = (str, type, icon) => {
            if (!str) return;
            str.split(',').forEach(timeStr => {
                timeStr = timeStr.trim();
                if (!timeStr) return;
                
                // Extraer n√∫mero para la posici√≥n (ej: "45+2" -> 45)
                let minute = parseInt(timeStr);
                if (isNaN(minute)) return;
                
                // Ajuste visual para el tiempo extra
                let position = minute;
                if (minute > 90) position = 92; // Capar al final
                else if (minute > 45 && minute < 50 && timeStr.includes('+')) position = 46; // Descanso

                events.push({
                    minute: minute,
                    displayTime: timeStr,
                    type: type, // 'goal', 'yellow', 'red'
                    icon: icon,
                    player: name,
                    positionPercent: (position / 95) * 100 // Escala sobre 95 min aprox
                });
            });
        };

        parseEvents(ps.detailGoals, 'goal', '‚öΩ');
        parseEvents(ps.detailYellow, 'yellow', 'üü®');
        parseEvents(ps.detailRed, 'red', 'üü•');
    });

    // 2. Ordenar por minuto
    events.sort((a, b) => a.minute - b.minute);

    // 3. Generar HTML
    if (events.length === 0) {
        return `<div class="text-center text-xs text-gray-400 py-4 italic">Sin eventos registrados en la l√≠nea de tiempo.</div>`;
    }

    const markersHtml = events.map(ev => {
        // Estilos seg√∫n tipo para que no se solapen tanto visualmente
        let colorClass = "";
        let borderClass = "border-white";
        let zIndex = "z-10";
        
        if (ev.type === 'goal') { colorClass = "bg-white text-lg -mt-3"; zIndex = "z-20"; }
        else if (ev.type === 'yellow') { colorClass = "text-xs"; }
        else { colorClass = "text-xs"; }

        // Tooltip al hacer hover
        return `
            <div class="absolute transform -translate-x-1/2 flex flex-col items-center group cursor-pointer ${zIndex}" 
                 style="left: ${ev.positionPercent}%; top: -12px;">
                
                <div class="${colorClass} hover:scale-125 transition-transform shadow-sm rounded-full ${borderClass}">
                    ${ev.icon}
                </div>
                
                <div class="h-3 w-px bg-gray-300"></div>

                <div class="absolute bottom-8 opacity-0 group-hover:opacity-100 transition-opacity bg-slate-800 text-white text-[10px] px-2 py-1 rounded whitespace-nowrap z-50 pointer-events-none shadow-lg mb-1">
                    <span class="font-bold">${ev.displayTime}'</span> ${ev.player}
                    <div class="absolute -bottom-1 left-1/2 -translate-x-1/2 w-2 h-2 bg-slate-800 rotate-45"></div>
                </div>
            </div>
        `;
    }).join('');

    return `
        <div class="w-full px-4 py-6 select-none">
            <div class="relative w-full h-1 bg-gray-200 rounded flex items-center">
                <div class="absolute left-0 -ml-1 w-2 h-2 bg-gray-300 rounded-full"></div>
                <div class="absolute left-0 top-3 text-[9px] text-gray-400 font-mono">0'</div>

                <div class="absolute left-[47%] -ml-px w-px h-3 bg-gray-300 -top-1"></div>
                <div class="absolute left-[47%] top-3 -translate-x-1/2 text-[9px] text-gray-400 font-mono">HT</div>

                <div class="absolute right-0 -mr-1 w-2 h-2 bg-gray-300 rounded-full"></div>
                <div class="absolute right-0 top-3 text-[9px] text-gray-400 font-mono">90'</div>

                ${markersHtml}
            </div>
        </div>
    `;
}
/* --- HTML DEL MODAL DE ETIQUETAS --- */
function ensureGoalTagModal() {
    if (document.getElementById('goal-tag-modal')) return;

    const modal = document.createElement('div');
    modal.id = 'goal-tag-modal';
    modal.className = "fixed inset-0 bg-black/80 hidden z-[10000] items-center justify-center backdrop-blur-sm";
    modal.innerHTML = `
        <div class="bg-white rounded-xl w-full max-w-md shadow-2xl overflow-hidden m-4 flex flex-col max-h-[90vh]">
            <div class="bg-slate-900 text-white p-4 font-bold text-center border-b border-slate-700">
                üè∑Ô∏è ETIQUETAR GOLES
            </div>
            <div id="goal-tag-content" class="p-4 overflow-y-auto flex-1 space-y-4 bg-gray-50">
                </div>
            <div class="p-4 bg-white border-t border-gray-200 flex justify-end gap-3">
                <button onclick="closeGoalTagModal()" class="px-4 py-2 text-gray-500 font-bold hover:bg-gray-100 rounded-lg">Cancelar</button>
                <button onclick="saveGoalTags()" class="px-6 py-2 bg-emerald-600 hover:bg-emerald-700 text-white font-bold rounded-lg shadow-lg">GUARDAR ETIQUETAS</button>
            </div>
        </div>
    `;
    document.body.appendChild(modal);
}
// B. ABRIR ETIQUETADOR
let currentTaggingGoalId = null;

function openGoalTagging(goalInputId, minutesStr) {
    currentTaggingGoalId = goalInputId; 
    ensureGoalTagModal();

    const minutes = minutesStr.split(',').map(s => s.trim()).filter(s => s !== '');
    const container = document.getElementById('goal-tag-content');
    container.innerHTML = '';

    // Recuperar etiquetas existentes
    const typeInput = document.getElementById(goalInputId + '-types');
    let existingTags = [];
    try { existingTags = JSON.parse(typeInput.value) || []; } catch(e) {}

    // Generar Fichas
    minutes.forEach((min, index) => {
        const savedData = existingTags[index] || {};
        const selectedTags = savedData.tags || [];

        // --- LISTA DE ETIQUETAS ACTUALIZADA ---
        const tagsList = [
            'Pie derecho', 
            'Pie izquierdo', 
            'Cabeza', 
            'Chilena', 
            'Volea', 
            'Tac√≥n',           // <--- NUEVA
            'Exterior',
            'Vaselina',
            'Fuera del √°rea',  // <--- NUEVA
            'Bal√≥n parado', 
            'Ol√≠mpico', 
            'Corner', 
            'Falta directa', 
            'Penalti'
        ];
        
        const tagsHtml = tagsList.map(tag => {
            const isChecked = selectedTags.includes(tag) ? 'checked' : '';
            return `
                <label class="flex items-center space-x-3 bg-white border border-gray-200 p-3 rounded-lg hover:bg-indigo-50 hover:border-indigo-200 cursor-pointer transition-all shadow-sm">
                    <input type="checkbox" value="${tag}" ${isChecked} class="form-checkbox h-5 w-5 text-indigo-600 rounded border-gray-300 focus:ring-indigo-500 goal-tag-check-${index}">
                    <span class="text-xs font-bold text-gray-700 uppercase tracking-wide">${tag}</span>
                </label>
            `;
        }).join('');

        const card = `
            <div class="bg-white border border-gray-200 rounded-xl shadow-sm p-5 relative mt-4">
                <div class="absolute -top-3 left-4 bg-indigo-600 text-white text-xs font-black px-3 py-1 rounded-full shadow-md tracking-wider border-2 border-white">
                    GOL ${index + 1} ‚Ä¢ MINUTO ${min}'
                </div>
                <div class="mt-3 grid grid-cols-2 gap-3">
                    ${tagsHtml}
                </div>
            </div>
        `;
        container.innerHTML += card;
    });

    const modal = document.getElementById('goal-tag-modal');
    modal.classList.remove('hidden');
    modal.classList.add('flex');
}

// C. CERRAR
function closeGoalTagModal() {
    const modal = document.getElementById('goal-tag-modal');
    if(modal) {
        modal.classList.add('hidden');
        modal.classList.remove('flex');
    }
}

// D. GUARDAR JSON
function saveGoalTags() {
    if (!currentTaggingGoalId) return;

    const goalInput = document.getElementById(currentTaggingGoalId);
    const minutes = goalInput.value.split(',').map(s => s.trim()).filter(s => s !== '');
    
    const finalData = [];

    minutes.forEach((min, index) => {
        const checks = document.querySelectorAll(`.goal-tag-check-${index}:checked`);
        const tags = Array.from(checks).map(c => c.value);
        
        finalData.push({
            minute: min,
            tags: tags
        });
    });

    const typeInput = document.getElementById(currentTaggingGoalId + '-types');
    if (typeInput) {
        typeInput.value = JSON.stringify(finalData);
    }
    closeGoalTagModal();
}
/* ========================================================= */
/* üìä AN√ÅLISIS DE TIPOS DE GOL (M√ìDULO DE ESTAD√çSTICAS)      */
/* ========================================================= */
function renderGoalAnalysis() {
    const matches = getData('matches');
    
    // 1. AGREGAR DATOS
    let tagCounts = {};
    let totalTaggedGoals = 0;

    matches.forEach(m => {
        m.playerStats.forEach(ps => {
            // Verificamos si tiene etiquetas guardadas
            if (ps.detailGoalTypes && Array.isArray(ps.detailGoalTypes)) {
                ps.detailGoalTypes.forEach(evt => {
                    if (evt.tags && Array.isArray(evt.tags)) {
                        evt.tags.forEach(tag => {
                            tagCounts[tag] = (tagCounts[tag] || 0) + 1;
                            totalTaggedGoals++;
                        });
                    }
                });
            }
        });
    });

    // 2. ORDENAR DE MAYOR A MENOR
    // Convertimos el objeto en array para ordenar
    const sortedTags = Object.entries(tagCounts)
        .sort(([, a], [, b]) => b - a); // Orden descendente

    // 3. GENERAR HTML
    if (sortedTags.length === 0) {
        return `
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-6 flex flex-col items-center justify-center text-center h-full">
                <div class="text-4xl mb-2">ü§∑‚Äç‚ôÇÔ∏è</div>
                <h3 class="font-bold text-gray-700">Sin datos de goles</h3>
                <p class="text-xs text-gray-400 mt-1">Etiqueta tus goles al editar partidos para ver el an√°lisis aqu√≠.</p>
            </div>
        `;
    }

    // Mapeamos iconos para darle un toque visual
    const icons = {
        'Pie derecho': 'ü¶∂üëâ', 'Pie izquierdo': 'üëàü¶∂', 'Cabeza': 'üë§', 
        'Chilena': 'ü§∏', 'Volea': 'üöÄ', 'Tac√≥n': 'üë†','Exterior': 'üëü‚Ü™Ô∏è',  
        'Vaselina': 'üåà','Fuera del √°rea': 'üéØ', 'Bal√≥n parado': '‚è≥', 'Ol√≠mpico': 'üö©', 
        'Corner': 'üìê', 'Falta directa': 'üß±', 'Penalti': 'ü•Ö'
    };

    const barsHtml = sortedTags.map(([tag, count]) => {
        // Calcular porcentaje respecto al total de etiquetas (para la barra)
        // Usamos Math.max(..., 5) para que siempre se vea un poquito de barra
        const percentage = Math.round((count / totalTaggedGoals) * 100);
        const icon = icons[tag] || '‚öΩ';
        
        // Color din√°mico seg√∫n porcentaje
        let barColor = 'bg-indigo-500';
        if (percentage > 40) barColor = 'bg-emerald-500';
        else if (percentage < 10) barColor = 'bg-gray-400';

        return `
            <div class="mb-3 last:mb-0">
                <div class="flex justify-between items-end mb-1">
                    <span class="text-sm font-bold text-gray-700 flex items-center gap-2">
                        <span class="text-base">${icon}</span> ${tag}
                    </span>
                    <div class="text-right">
                        <span class="text-sm font-black text-indigo-900">${count}</span>
                        <span class="text-[10px] text-gray-400 ml-1">(${percentage}%)</span>
                    </div>
                </div>
                <div class="w-full bg-gray-100 rounded-full h-2.5 overflow-hidden">
                    <div class="${barColor} h-2.5 rounded-full transition-all duration-1000" style="width: ${percentage}%"></div>
                </div>
            </div>
        `;
    }).join('');

    return `
        <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
            <div class="bg-indigo-900 text-white px-4 py-3 border-b border-indigo-800 flex justify-between items-center">
                <h3 class="font-bold text-sm uppercase tracking-wider">üî¨ ADN Goleador</h3>
                <span class="bg-indigo-700 text-[10px] px-2 py-0.5 rounded-full">${totalTaggedGoals} Registros</span>
            </div>
            <div class="p-5">
                ${barsHtml}
            </div>
        </div>
    `;
}
/* ========================================================= */
/* üì∏ GENERADOR DE FICHA DE PARTIDO (CORREGIDO Y ROBUSTO)    */
/* ========================================================= */

async function downloadMatchCard(matchId) {
    const matches = getData('matches');
    const match = matches.find(m => m.id === matchId);
    if (!match) return;

    // Notificar al usuario que espere un momento
    const originalText = document.body.style.cursor;
    document.body.style.cursor = 'wait';

    // 1. Crear contenedor temporal (visible pero detr√°s de todo)
    // Esto evita errores de renderizado que ocurren cuando est√° fuera de pantalla (-9999px)
    const container = document.createElement('div');
    container.id = "temp-capture-container";
    container.style.position = 'fixed';
    container.style.top = '0';
    container.style.left = '0';
    container.style.zIndex = '-50'; // Detr√°s de todo
    container.style.width = '600px'; 
    container.style.height = '800px';
    container.style.overflow = 'hidden';
    document.body.appendChild(container);

    // 2. Generar HTML
    container.innerHTML = generateMatchCardHTML(match);

    // 3. Esperar un poco para asegurar que las im√°genes y fuentes carguen
    await new Promise(resolve => setTimeout(resolve, 500));

    try {
        // 4. Capturar
        const canvas = await html2canvas(container.querySelector('#match-share-card'), {
            scale: 2, 
            backgroundColor: '#0f172a',
            useCORS: true, // Intentar cargar im√°genes externas
            allowTaint: true,
            logging: false
        });

        // 5. Descargar
        const image = canvas.toDataURL("image/png");
        const link = document.createElement('a');
        link.download = `MatchReport_RealMadrid_vs_${match.opponent.replace(/\s+/g, '')}.png`;
        link.href = image;
        link.click();

    } catch (err) {
        console.error("Error generando imagen:", err);
        alert("No se pudo generar la imagen. Int√©ntalo de nuevo.");
    } finally {
        // 6. Limpieza
        document.body.removeChild(container);
        document.body.style.cursor = originalText;
    }
}

// Helper para obtener nombre del MVP
function getMvpName(playerId) {
    if(!playerId) return "N/A";
    const players = getPlayers();
    const p = players.find(pl => pl.id === playerId);
    return p ? (p.apodo || p.apellido) : "Desconocido";
}

// FUNCI√ìN DE DISE√ëO (Simplificada para compatibilidad)
function generateMatchCardHTML(match) {
    const players = getPlayers();
    const [homeGoals, awayGoals] = match.result.split('-').map(Number);
    const isWin = homeGoals > awayGoals;
    // Usamos colores hex directos para evitar problemas con clases de Tailwind no cargadas
    const resultColor = isWin ? '#34d399' : (homeGoals === awayGoals ? '#fbbf24' : '#f87171');

    // --- GENERAR LISTA DE JUGADORES CON NOTAS ---
    let playersHtml = '';
    if (match.playerStats) {
        // Filtramos los que jugaron o tienen nota
        const activeStats = match.playerStats.filter(ps => ps.played || ps.minutes > 0 || ps.rating);
        
        // Ordenamos: Titulares primero, luego por nota
        activeStats.sort((a, b) => {
            if (a.isStarter && !b.isStarter) return -1;
            if (!a.isStarter && b.isStarter) return 1;
            return (b.rating || 0) - (a.rating || 0);
        });

        // Limitamos para que quepa en la imagen si son muchos (ej: max 16)
        const displayStats = activeStats.slice(0, 16);

        playersHtml = displayStats.map(ps => {
            const p = players.find(pl => pl.id === ps.playerId);
            const name = p ? (p.apodo || p.apellido) : '???';
            const rating = ps.rating || '-';
            
            // Color de la nota
            let ratingColor = '#9ca3af'; // Gris
            if (rating >= 8) ratingColor = '#34d399'; // Verde
            else if (rating >= 6) ratingColor = '#60a5fa'; // Azul
            else if (rating >= 5) ratingColor = '#fbbf24'; // Amarillo
            else if (rating !== '-') ratingColor = '#f87171'; // Rojo

            // Iconos de rendimiento
            let icons = '';
            if (ps.goals > 0) icons += `‚öΩ${ps.goals > 1 ? 'x'+ps.goals : ''} `;
            if (ps.assists > 0) icons += `üëü${ps.assists > 1 ? 'x'+ps.assists : ''} `;
            if (ps.redCards > 0) icons += `üü• `;
            else if (ps.yellowCards > 0) icons += `üü® `;
            if (match.mvp === ps.playerId) icons += `üëë `;

            return `
                <div style="display: flex; justify-content: space-between; align-items: center; padding: 6px 0; border-bottom: 1px solid rgba(255,255,255,0.05); font-size: 12px;">
                    <div style="display: flex; align-items: center; gap: 8px; overflow: hidden;">
                        <span style="color: ${ps.isStarter ? '#e2e8f0' : '#94a3b8'}; font-weight: ${ps.isStarter ? 'bold' : 'normal'}; white-space: nowrap;">${name}</span>
                        <span style="font-size: 10px;">${icons}</span>
                    </div>
                    <div style="font-weight: 900; color: ${ratingColor}; font-size: 14px;">${rating}</div>
                </div>
            `;
        }).join('');
    }

    // MVP Info
    const mvpName = getMvpName(match.mvp);
    const mvpPlayer = players.find(p => p.id === match.mvp);
    const mvpImg = mvpPlayer?.foto || 'https://via.placeholder.com/60';

    // HTML CON ESTILOS INLINE (M√ÅS SEGURO PARA HTML2CANVAS)
    return `
        <div id="match-share-card" style="width: 600px; height: 800px; background: linear-gradient(135deg, #0f172a 0%, #1e1b4b 100%); font-family: sans-serif; position: relative; overflow: hidden; display: flex; flex-direction: column;">
            
            <div style="width: 100%; height: 8px; background: linear-gradient(90deg, #d97706, #fbbf24, #d97706);"></div>

            <div style="text-align: center; padding-top: 30px; margin-bottom: 10px;">
                <div style="color: #fbbf24; text-transform: uppercase; letter-spacing: 3px; font-weight: bold; font-size: 12px; margin-bottom: 4px;">${match.competition}</div>
                <div style="color: #94a3b8; font-size: 10px; text-transform: uppercase; letter-spacing: 1px;">${match.round}</div>
            </div>

            <div style="display: flex; justify-content: center; align-items: center; margin: 10px 0; padding: 0 20px;">
                <div style="width: 35%; text-align: center;">
                    <div style="font-size: 24px; font-weight: 900; color: white; text-shadow: 0 4px 6px rgba(0,0,0,0.3);">REAL MADRID</div>
                </div>
                <div style="width: 30%; text-align: center;">
                    <div style="background: rgba(30, 41, 59, 0.6); padding: 10px 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.1); display: inline-block;">
                        <div style="font-size: 48px; font-weight: 900; color: ${resultColor}; line-height: 1;">${match.result}</div>
                    </div>
                </div>
                <div style="width: 35%; text-align: center; opacity: 0.9;">
                    <div style="font-size: 18px; font-weight: bold; color: white;">${match.opponent}</div>
                </div>
            </div>

            <div style="margin: 10px 30px; background: rgba(30, 41, 59, 0.4); border-radius: 16px; padding: 20px; border: 1px solid rgba(255,255,255,0.05); flex: 1; display: flex; flex-direction: column;">
                <div style="text-align: center; color: rgba(251, 191, 36, 0.8); font-size: 11px; font-weight: bold; text-transform: uppercase; letter-spacing: 2px; border-bottom: 1px solid rgba(255,255,255,0.1); padding-bottom: 8px; margin-bottom: 8px;">
                    Notas del Partido
                </div>
                <div style="flex: 1; overflow: hidden;"> <!-- Evitar scrollbars en la imagen -->
                    ${playersHtml}
                </div>
            </div>

            ${match.mvp ? `
            <div style="margin: 0 30px 20px 30px; display: flex; align-items: center; background: linear-gradient(90deg, rgba(251, 191, 36, 0.1) 0%, transparent 100%); border-radius: 12px; padding: 10px; border-left: 3px solid #fbbf24;">
                <div style="margin-right: 15px; position: relative;">
                    <div style="width: 48px; height: 48px; border-radius: 50%; background: #fbbf24; display: flex; align-items: center; justify-content: center; overflow: hidden; border: 2px solid #fbbf24;">
                        <img src="${mvpImg}" crossorigin="anonymous" style="width: 100%; height: 100%; object-fit: cover;">
                    </div>
                </div>
                <div>
                    <div style="color: #fbbf24; font-size: 9px; text-transform: uppercase; font-weight: bold; letter-spacing: 1px;">MVP del Partido</div>
                    <div style="font-size: 18px; font-weight: 900; color: white;">${mvpName}</div>
                </div>
            </div>
            ` : ''}

            <div style="text-align: center; padding-bottom: 15px; color: rgba(255,255,255,0.3); font-size: 9px; text-transform: uppercase; letter-spacing: 2px;">
                Reporte Oficial de Partido
            </div>
        </div>
    `;
}
// ==========================================
// ACTIVADOR EFECTO JELLY (GLOBAL)
// ==========================================
document.addEventListener('click', function(e) {
    // Detectamos si lo que se ha clicado es un bot√≥n (o est√° dentro de uno)
    // Buscamos etiquetas button, inputs tipo submit/button, o elementos con clase .btn
    const targetButton = e.target.closest('button, input[type="submit"], input[type="button"], .btn');

    if (targetButton) {
        // 1. Si ya se estaba moviendo, reiniciamos la animaci√≥n
        targetButton.classList.remove('jelly-active');
        
        // Truco para forzar al navegador a reiniciar la animaci√≥n (reflow)
        void targetButton.offsetWidth; 
        
        // 2. A√±adimos la clase que activa el baile
        targetButton.classList.add('jelly-active');

        // 3. Cuando termine el baile, quitamos la clase (limpieza)
        targetButton.addEventListener('animationend', () => {
            targetButton.classList.remove('jelly-active');
        }, { once: true });
    }
});
        // Global Modal Close Handler
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            console.log('App ready');
            initDarkMode();
            preloadCalendars();
        });

    </script>
</body>
</html>