<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notas - Real Madrid CF</title>
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * { font-family: 'Inter', sans-serif; }
        .tab-active { border-bottom: 3px solid #fbbf24; color: #fbbf24; }
        .card { transition: all 0.3s ease; }
        .card:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.15); }
        
        /* Player Photos - Standardized Object Position */
        .player-photo { width: 80px; height: 80px; object-fit: cover; object-position: top !important; border-radius: 50%; }
        .player-photo-small { width: 40px; height: 40px; object-fit: cover; object-position: top !important; border-radius: 50%; }
        .player-photo-xs { width: 32px; height: 32px; object-fit: cover; object-position: top !important; border-radius: 50%; }
        .player-photo-lg { width: 120px; height: 120px; object-fit: cover; object-position: top !important; border-radius: 50%; }
        
        /* Top Form Specific Photo Style */
        .top-form-img { width: 24px; height: 24px; border-radius: 50%; object-fit: cover; object-position: top !important; }

        .modal { display: none; }
        .modal.active { display: flex; }
        .fade-in { animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        
        .position-badge { padding: 2px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; }
        .pos-portero, .pos-portera { background: #fef3c7; color: #92400e; }
        .pos-defensa { background: #dbeafe; color: #1e40af; }
        .pos-centrocampista { background: #d1fae5; color: #065f46; }
        .pos-extremo { background: #ede9fe; color: #5b21b6; }
        .pos-delantero, .pos-delantera { background: #fee2e2; color: #991b1b; }
        .pos-entrenador { background: #1f2937; color: #fbbf24; border: 1px solid #fbbf24; }
        
        .status-active { background: #d1fae5; color: #065f46; }
        .status-inactive { background: #f3f4f6; color: #6b7280; }
        
        input[type="number"]::-webkit-inner-spin-button { opacity: 1; }
        .table-container { overflow-x: auto; }
        table { min-width: 1000px; }
        .sortable { cursor: pointer; user-select: none; }
        .sortable:hover { background: #374151; }
        .th-active { background-color: #4b5563 !important; color: #fbbf24 !important; }
        
        .result-win { background: #d1fae5; color: #065f46; }
        .result-draw { background: #fef3c7; color: #92400e; }
        .result-loss { background: #fee2e2; color: #991b1b; }
        
        /* Calendar Styles based on Competition Colors */
        .match-card { border-left: 4px solid #9ca3af; }
        .match-registered { opacity: 0.6; background-color: #f9fafb; border-color: #6b7280 !important; }
        
        /* Competition Colors for Calendar Borders */
        .border-comp-liga { border-left-color: #1e40af; }
        .border-comp-champions { border-left-color: #5b21b6; }
        .border-comp-copa { border-left-color: #065f46; }
        .border-comp-supercopa { border-left-color: #991b1b; }
        .border-comp-mundial { border-left-color: #92400e; }
        
        .comp-mundial { background: #fef3c7; color: #92400e; }
        .comp-liga { background: #dbeafe; color: #1e40af; }
        .comp-champions { background: #ede9fe; color: #5b21b6; }
        .comp-copa { background: #d1fae5; color: #065f46; }
        .comp-supercopa { background: #fee2e2; color: #991b1b; }
        .comp-unknown { background: #e5e7eb; color: #374151; }
        .comp-eliminated { background: #f3f4f6; color: #9ca3af; text-decoration: line-through; }
        
        /* Backgrounds */
        .welcome-bg {
            background: url("https://i.postimg.cc/HnXKzV3c/bernabeu2.jpg") center/cover no-repeat;
            min-height: 100vh;
        }
        
        @media (max-width: 768px) {
            .welcome-bg {
                background: url("https://i.postimg.cc/zXpprCLS/bernabeu-1-movil-wallpaper.jpg") center/cover no-repeat;
            }
        }

        .rm-header-gradient { background: linear-gradient(135deg, #1e3a5f 0%, #0a1628 100%); }

        .rm-gold { color: #fbbf24; }
        .calendar-loading { animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
        
        .player-inactive { opacity: 0.6; }
        .player-suspended { background-color: #fef2f2; opacity: 0.7; pointer-events: none; border: 1px solid #fecaca; }
        .round-badge { padding: 2px 8px; border-radius: 6px; font-size: 11px; font-weight: 500; }
        .round-available { background: #d1fae5; color: #065f46; border: 1px solid #10b981; }
        .round-completed { background: #e0e7ff; color: #3730a3; }
        .round-locked { background: #f3f4f6; color: #9ca3af; }
        .elimination-warning { background: #fef2f2; border: 1px solid #fecaca; color: #991b1b; }
        .global-result { background: #f0f9ff; border: 1px solid #bae6fd; }
        .calendar-select-hint { background: #ecfdf5; border: 1px solid #a7f3d0; color: #065f46; }
        .selected-fixture { background: #fef3c7; border: 2px solid #f59e0b; }
        .readonly-input { background-color: #f3f4f6; color: #6b7280; cursor: not-allowed; }
        .welcome-card { transition: all 0.3s; cursor: pointer; }
        .welcome-card:hover { transform: scale(1.02); }
        .starter-badge { background: #d1fae5; color: #065f46; border: 1px solid #34d399; font-size: 0.7rem; padding: 1px 4px; border-radius: 4px; }
        .sub-badge { background: #f3f4f6; color: #6b7280; border: 1px solid #d1d5db; font-size: 0.7rem; padding: 1px 4px; border-radius: 4px; }
        
        /* Monthly Calendar Styles */
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #e5e7eb; border: 1px solid #e5e7eb; }
        .calendar-day-header { background: #f9fafb; padding: 8px; text-align: center; font-weight: 600; font-size: 0.85rem; color: #4b5563; }
        .calendar-day { background: white; min-height: 100px; padding: 4px; position: relative; }
        .calendar-day:hover { background: #f9fafb; }
        .calendar-day.other-month { background: #f3f4f6; color: #9ca3af; }
        .calendar-day.today { background: #eff6ff; }
        .day-number { font-size: 0.85rem; font-weight: 600; margin-bottom: 4px; display: block; }
        .cal-event-dot { font-size: 0.7rem; padding: 2px 4px; border-radius: 4px; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: pointer; display: block; }
        .cal-event-dot:hover { opacity: 0.8; }

        /* Comparator */
        .stat-better { background-color: #dcfce7; color: #166534; font-weight: bold; }
        .streak-dot { 
            width: 24px; 
            height: 24px; 
            border-radius: 50%; 
            display: inline-flex; 
            align-items: center; 
            justify-content: center; 
            font-size: 10px; 
            font-weight: bold; 
            color: white; 
            line-height: 1;
        }
        .streak-w { background-color: #22c55e; }
        .streak-d { background-color: #9ca3af; }
        .streak-l { background-color: #ef4444; }

        /* Heatmap Styles */
        .heatmap-pitch {
            background-color: #ecfdf5;
            border: 2px solid #10b981;
            border-radius: 8px;
            position: relative;
            height: 400px; /* Increased height for 4 zones */
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 10px;
        }
        .heatmap-zone {
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            color: white;
            text-shadow: 0 1px 2px rgba(0,0,0,0.3);
            transition: all 0.3s;
            flex: 1;
            margin: 2px;
        }
        .heatmap-val { font-size: 1.5rem; font-weight: bold; }
        .heatmap-label { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.05em; }

       /* Stats Sub-tabs - Estilo Limpio y Legible */
        .stats-subtab { @apply px-5 py-2 text-sm font-bold rounded-lg transition-all duration-200 flex items-center gap-2; }
        .stats-subtab.active { @apply bg-amber-500 text-white shadow-md transform scale-105; }
        .stats-subtab.inactive { @apply text-gray-600 bg-transparent hover:bg-gray-100 hover:text-gray-900; }
        /* Chart Styles */
        .chart-container {
            display: flex;
            align-items: flex-end;
            height: 150px;
            gap: 4px;
            padding-top: 20px;
            border-bottom: 1px solid #e5e7eb;
        }
        .chart-bar {
            flex: 1;
            background-color: #3b82f6;
            border-radius: 4px 4px 0 0;
            position: relative;
            min-width: 8px;
            transition: height 0.3s ease;
        }
        .chart-bar:hover { opacity: 0.8; }
        .chart-label {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 10px;
            font-weight: bold;
            color: #374151;
        }
        /* --- ESTILOS PIZARRA T√ÅCTICA --- */
        .pitch-container {
            width: 100%;
            /* Relaci√≥n de aspecto horizontal (4:3 o 3:2 seg√∫n prefieras) */
            height: 100%; width: 100%;
            background-color: #2e7d32;
            background-image: 
                linear-gradient(rgba(255,255,255,0.2) 2px, transparent 2px),
                linear-gradient(90deg, rgba(255,255,255,0.2) 2px, transparent 2px);
            background-size: 50px 50px; /* Cuadr√≠cula m√°s peque√±a */
            position: relative;
            border: 4px solid white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: inset 0 0 20px rgba(0,0,0,0.3);
            margin: 0 auto;
        }
        
        /* Ajustar l√≠neas para campo horizontal */
        .pitch-line-mid {
            width: 2px; /* Ahora es vertical */
            height: 100%;
            left: 50%;
            top: 0;
            background: rgba(255,255,255,0.6);
            position: absolute;
        }
        .pitch-circle {
            width: 15%; /* Ajustar tama√±o relativo */
            aspect-ratio: 1/1; /* Mantener c√≠rculo perfecto */
            height: auto;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            position: absolute;
            border: 2px solid rgba(255,255,255,0.6);
        }
        .pitch-box-left, .pitch-box-right {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            width: 15%;
            height: 40%;
            border: 2px solid rgba(255,255,255,0.6);
        }
        .pitch-box-left { left: -2px; border-left: none; }
        .pitch-box-right { right: -2px; border-right: none; }

        /* Fichas de Jugadores */
        .player-token {
            width: 45px;
            height: 45px;
            position: absolute;
            transform: translate(-50%, -50%); /* Para centrar exacto en la coordenada */
            background: white;
            border-radius: 50%;
            border: 2px solid #fff;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
            cursor: grab;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 10;
            transition: all 0.2s ease;
        }
        .player-token:active { cursor: grabbing; transform: translate(-50%, -50%) scale(1.1); }
        .player-token img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: top center; /* <--- ESTO ES LA CLAVE */
            border-radius: 50%;
            pointer-events: none;
        }
        .player-token-name {
            position: absolute;
            bottom: -18px;
            background: rgba(0,0,0,0.7);
            color: white;
            font-size: 9px;
            padding: 2px 4px;
            border-radius: 4px;
            white-space: nowrap;
            pointer-events: none;
        }

        /* Zona de Banquillo (Drag Source) */
        .bench-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 10px;
            background: #f3f4f6;
            border-radius: 8px;
            min-height: 100px;
            align-content: flex-start;
        }
        .bench-slot {
            width: 50px;
            height: 50px;
            background: #e5e7eb;
            border-radius: 50%;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 2px dashed #9ca3af;
        }

        /* huecos vac√≠os en el campo */
        .pitch-slot {
            width: 45px;
            height: 45px;
            position: absolute;
            transform: translate(-50%, -50%);
            border: 2px dashed rgba(255,255,255,0.5);
            border-radius: 50%;
            background: rgba(255,255,255,0.1);
            z-index: 5;
        }
        /* --- MODO OSCURO (DARK MODE) --- */
        body.dark-mode { background-color: #0f172a; color: #f1f5f9; }
        
        .dark-mode .bg-white { background-color: #1e293b !important; color: #f1f5f9; border-color: #334155; }
        .dark-mode .bg-gray-50, .dark-mode .bg-gray-100 { background-color: #0f172a !important; color: #cbd5e1; border-color: #334155; }
        .dark-mode .bg-gray-200 { background-color: #334155 !important; color: #e2e8f0; }
        
        .dark-mode .text-gray-800, .dark-mode .text-gray-700, .dark-mode .text-gray-600 { color: #f1f5f9 !important; }
        .dark-mode .text-gray-500 { color: #94a3b8 !important; }
        .dark-mode .text-slate-700 { color: #f8fafc !important; }
        
        .dark-mode .border-gray-200, .dark-mode .border-gray-300, .dark-mode .border-gray-100 { border-color: #334155 !important; }
        
        .dark-mode input, .dark-mode select { 
            background-color: #1e293b; 
            border-color: #475569; 
            color: #f1f5f9; 
        }
        .dark-mode input:focus, .dark-mode select:focus { border-color: #fbbf24; }
        .dark-mode .card:hover { background-color: #334155; }
        
        /* Ajustes Espec√≠ficos */
        .dark-mode .modal .bg-white { background-color: #1e293b !important; }
        .dark-mode th { background-color: #0f172a; color: #fbbf24; }
        .dark-mode .calendar-day { background-color: #1e293b; border-color: #334155; }
        .dark-mode .calendar-day:hover { background-color: #334155; }
        .dark-mode .calendar-day.other-month { background-color: #0f172a; opacity: 0.5; }
        
        /* Ajuste de Pizarra */
        .dark-mode .pitch-container { border-color: #334155; }
        .dark-mode .bench-container { background-color: #0f172a; border-color: #334155; }
        .dark-mode .player-token { border-color: #334155; background-color: #1e293b; color: white; }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-gray-100 min-h-screen">

    <!-- WELCOME SCREEN -->
    <section id="section-welcome" class="welcome-bg min-h-screen flex flex-col items-center justify-center p-4 text-white">
        <div class="text-center mb-10">
            <img src="https://upload.wikimedia.org/wikipedia/en/thumb/5/56/Real_Madrid_CF.svg/1200px-Real_Madrid_CF.svg.png" 
                 alt="Real Madrid" class="w-24 h-24 object-contain mx-auto mb-4 drop-shadow-2xl">
            <h1 class="text-3xl md:text-5xl font-bold mb-2 drop-shadow-md">Notas Real Madrid</h1>
            <p class="text-blue-100 font-medium text-lg drop-shadow-md">Temporada 2025/2026</p>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 w-full max-w-4xl">
            <!-- MASCULINO -->
            <div onclick="selectTeam('masculino')" class="welcome-card bg-white/10 backdrop-blur-sm text-white rounded-2xl p-8 text-center shadow-2xl border-b-8 border-blue-600 hover:bg-white/20 transition-all">
                <h2 class="text-2xl font-bold mb-2">Real Madrid Masculino</h2>
                <p class="text-black-200 font-semibold">Temporada 2025/2026</p>
                <p class="text-sm text-black-300 mt-2">La Liga, Champions, Copa del Rey...</p>
            </div>

            <!-- FEMENINO -->
            <div onclick="selectTeam('femenino')" class="welcome-card bg-white/10 backdrop-blur-sm text-white rounded-2xl p-8 text-center shadow-2xl border-b-8 border-purple-500 hover:bg-white/20 transition-all">
                <h2 class="text-2xl font-bold mb-2">Real Madrid Femenino</h2>
                <p class="text-black-200 font-semibold">Temporada 2025/2026</p>
                <p class="text-sm text-black-300 mt-2">Liga F, UWCL, Copa de la Reina...</p>
            </div>
        </div>
    </section>

    <!-- APP CONTAINER (Hidden initially) -->
    <div id="app-container" class="hidden bg-gray-100">
        <!-- Header Real Madrid -->
        <header class="rm-header-gradient text-white shadow-lg">
            <div class="container mx-auto px-4 py-4">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3 cursor-pointer hover:opacity-80 transition" onclick="returnToWelcome()" title="Volver a selecci√≥n de equipo">
                        <img src="https://upload.wikimedia.org/wikipedia/en/thumb/5/56/Real_Madrid_CF.svg/1200px-Real_Madrid_CF.svg.png" 
                             alt="Real Madrid" class="w-12 h-12 object-contain">
                        <div>
                            <h1 class="text-2xl font-bold">An√°lisis Real Madrid</h1>
                            <p id="header-subtitle" class="text-blue-200 text-sm">Real Madrid CF</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-3 cursor-pointer hover:opacity-80 transition" onclick="returnToWelcome()" ...>
                        </div>

                    <button onclick="toggleDarkMode()" id="btn-dark-mode" class="p-2 rounded-full bg-white/10 hover:bg-white/20 transition backdrop-blur-sm" title="Cambiar Tema">
                        üåô
                    </button>
                </div>
            </div>
        </header>

        <!-- Navigation Tabs -->
        <nav class="bg-slate-800 shadow-sm sticky top-0 z-40">
            <div class="container mx-auto px-4">
                <div class="flex gap-1 overflow-x-auto">
                    <button onclick="showTab('principal')" id="tab-principal" class="tab-btn px-4 py-3 font-medium text-gray-300 hover:text-amber-400 whitespace-nowrap">
                        üè† Principal
                    </button>
                    <button onclick="showTab('plantilla')" id="tab-plantilla" class="tab-btn px-4 py-3 font-medium text-gray-300 hover:text-amber-400 whitespace-nowrap tab-active">
                        üë• Plantilla
                    </button>
                    <button onclick="showTab('calendario')" id="tab-calendario" class="tab-btn px-4 py-3 font-medium text-gray-300 hover:text-amber-400 whitespace-nowrap">
                        üìÖ Calendario
                    </button>
                    <button onclick="showTab('nuevo')" id="tab-nuevo" class="tab-btn px-4 py-3 font-medium text-gray-300 hover:text-amber-400 whitespace-nowrap">
                        ‚ûï Registrar Partido
                    </button>
                    <button onclick="showTab('partidos')" id="tab-partidos" class="tab-btn px-4 py-3 font-medium text-gray-300 hover:text-amber-400 whitespace-nowrap">
                        ‚öΩ Partidos
                    </button>
                    <button onclick="showTab('stats')" id="tab-stats" class="tab-btn px-4 py-3 font-medium text-gray-300 hover:text-amber-400 whitespace-nowrap">
                        üìä Estad√≠sticas
                    </button>
                    <button onclick="showTab('comparador')" id="tab-comparador" class="tab-btn px-4 py-3 font-medium text-gray-300 hover:text-amber-400 whitespace-nowrap">
                        üÜö Comparador
                    </button>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="container mx-auto px-4 py-6">
            <!--Men√∫ principal-->
            <section id="section-principal" class="hidden fade-in">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Panel General</h2>
                    <p class="text-gray-500 text-sm">Resumen de la temporada actual</p>
                </div>
                <div id="competition-status" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 mb-6">
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-6">
                    
                    <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 border-slate-800 relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-4 opacity-10 text-slate-800 text-6xl">üìÖ</div>
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Pr√≥ximo Partido</h3>
                        <div id="dashboard-next-match">
                            <p class="text-gray-500 text-sm">Cargando...</p>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 border-amber-400 relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-4 opacity-10 text-amber-500 text-6xl">üî•</div>
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Estado de Forma (√öltimos 5)</h3>
                        <div id="dashboard-form" class="flex items-center gap-2 mt-2">
                            <span class="text-gray-500 text-sm">Sin datos</span>
                        </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm p-5 border-l-4 border-blue-600 relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-4 opacity-10 text-blue-600 text-6xl">üìä</div>
                        <h3 class="text-xs font-bold text-gray-400 uppercase tracking-wider mb-2">Resumen Temporada</h3>
                        <div id="dashboard-summary" class="flex justify-between items-end mt-2">
                             <div class="text-center">
                                <span class="block text-2xl font-bold text-green-600" id="dash-wins">0</span>
                                <span class="text-xs text-gray-500">Vic</span>
                             </div>
                             <div class="text-center">
                                <span class="block text-2xl font-bold text-amber-600" id="dash-draws">0</span>
                                <span class="text-xs text-gray-500">Emp</span>
                             </div>
                             <div class="text-center">
                                <span class="block text-2xl font-bold text-red-600" id="dash-losses">0</span>
                                <span class="text-xs text-gray-500">Der</span>
                             </div>
                             <div class="w-px h-8 bg-gray-200 mx-1"></div>
                             <div class="text-center">
                                <span class="block text-xl font-bold text-slate-700" id="dash-gf">0</span>
                                <span class="text-xs text-gray-500">GF</span>
                             </div>
                             <div class="text-center">
                                <span class="block text-xl font-bold text-slate-700" id="dash-ga">0</span>
                                <span class="text-xs text-gray-500">GC</span>
                             </div>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    
                    <div class="lg:col-span-2 bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="px-5 py-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center">
                             <h3 class="font-bold text-gray-700">√öltimos Resultados</h3>
                             <button onclick="showTab('partidos')" class="text-xs text-blue-600 hover:underline">Ver todos</button>
                        </div>
                        <div id="dashboard-last-results" class="divide-y divide-gray-100">
                             </div>
                    </div>

                    <div class="bg-white rounded-xl shadow-sm border border-gray-100 overflow-hidden">
                        <div class="px-5 py-4 border-b border-gray-100 bg-gray-50">
                             <h3 class="font-bold text-gray-700">L√≠deres</h3>
                        </div>
                        <div id="dashboard-leaders" class="p-4 space-y-4">
                             </div>
                    </div>

                </div>
                <div class="mt-8 bg-white rounded-xl shadow-sm p-6 border border-gray-200">
                    <h3 class="text-lg font-bold text-gray-800 mb-4 flex items-center gap-2">
                        üíæ Gesti√≥n de Datos
                    </h3>
                    <p class="text-sm text-gray-500 mb-4">
                        Guarda una copia de seguridad de toda tu temporada o restaura un archivo guardado anteriormente. 
                        <span class="text-amber-600 font-bold">¬°Haz esto frecuentemente para no perder datos!</span>
                    </p>
                    
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button onclick="backupData()" class="flex-1 bg-green-50 hover:bg-green-100 text-green-700 border border-green-200 px-4 py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition-all">
                            ‚¨áÔ∏è Descargar Copia de Seguridad
                        </button>

                        <div class="flex-1 relative">
                            <input type="file" id="import-file" accept=".json" class="hidden" onchange="restoreData(this)">
                            <button onclick="document.getElementById('import-file').click()" class="w-full bg-blue-50 hover:bg-blue-100 text-blue-700 border border-blue-200 px-4 py-3 rounded-xl font-bold flex items-center justify-center gap-2 transition-all">
                                ‚¨ÜÔ∏è Restaurar Datos
                            </button>
                        </div>
                    </div>
                    
                    <div class="mt-4 pt-4 border-t border-gray-100 text-right">
                        <button onclick="hardReset()" class="text-xs text-red-400 hover:text-red-600 underline">
                            Borrar todo y empezar de cero
                        </button>
                    </div>
                </div>
            </section>
            
            <!-- PLANTILLA SECTION -->
            <section id="section-plantilla" class="fade-in">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Plantilla</h2>
                        <p class="text-gray-500 text-sm">Gesti√≥n de estado de jugadores</p>
                    </div>
                    <div class="flex gap-2">
                        <button onclick="filterPlayers('all')" id="filter-all" class="px-3 py-1.5 text-sm bg-slate-800 text-white rounded-lg">
                            Todos
                        </button>
                        <button onclick="filterPlayers('active')" id="filter-active" class="px-3 py-1.5 text-sm bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                            Activos
                        </button>
                        <button onclick="filterPlayers('inactive')" id="filter-inactive" class="px-3 py-1.5 text-sm bg-gray-200 text-gray-700 rounded-lg hover:bg-gray-300">
                            Inactivos
                        </button>
                    </div>
                </div>
                
                <!-- Filter by Position -->
                <div class="bg-white rounded-xl shadow-sm p-4 mb-4">
                    <div class="flex flex-wrap gap-2">
                        <button onclick="filterByPosition('')" class="pos-filter px-3 py-1 text-sm rounded-full bg-slate-800 text-white">Todas</button>
                        <button onclick="filterByPosition('entrenador')" class="pos-filter px-3 py-1 text-sm rounded-full bg-gray-200 hover:bg-slate-300 font-bold border border-slate-400">Entrenador</button>
                        <button onclick="filterByPosition('portero')" class="pos-filter px-3 py-1 text-sm rounded-full bg-gray-200 hover:bg-amber-100">Porter√≠a</button>
                        <button onclick="filterByPosition('defensa')" class="pos-filter px-3 py-1 text-sm rounded-full bg-gray-200 hover:bg-blue-100">Defensa</button>
                        <button onclick="filterByPosition('centrocampista')" class="pos-filter px-3 py-1 text-sm rounded-full bg-gray-200 hover:bg-green-100">Medio</button>
                        <button onclick="filterByPosition('extremo')" class="pos-filter px-3 py-1 text-sm rounded-full bg-gray-200 hover:bg-purple-100">Extremo</button>
                        <button onclick="filterByPosition('delantero')" class="pos-filter px-3 py-1 text-sm rounded-full bg-gray-200 hover:bg-red-100">Delantera</button>
                    </div>
                </div>
                
                <div id="players-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                </div>
            </section>

            <!-- CALENDARIO SECTION -->
            <section id="section-calendario" class="hidden fade-in">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Calendario Oficial</h2>
                        <p class="text-gray-500 text-sm">Haz clic en partidos pasados para registrar estad√≠sticas</p>
                    </div>
                    <div class="flex gap-2">
                        <div class="bg-white rounded-lg p-1 border flex">
                            <button onclick="switchCalendarView('list')" id="cal-view-list" class="px-3 py-1.5 text-sm rounded-md font-medium transition text-gray-600 hover:bg-gray-100">
                                üìÉ Lista
                            </button>
                            <button onclick="switchCalendarView('month')" id="cal-view-month" class="px-3 py-1.5 text-sm rounded-md font-medium transition bg-slate-800 text-white">
                                üóìÔ∏è Mes
                            </button>
                        </div>
                        <button onclick="loadCalendar()" class="bg-slate-800 hover:bg-slate-700 text-white px-4 py-2 rounded-lg font-medium flex items-center gap-2">
                            üîÑ Actualizar
                        </button>
                    </div>
                </div>

                <!-- Calendar Select Hint -->
                <div class="calendar-select-hint rounded-xl p-4 mb-4 flex justify-between items-center">
                    <p class="text-sm">
                        <strong>üí° Consejo:</strong> Los partidos marcados en gris ya han sido registrados.
                    </p>
                    <label class="flex items-center gap-2 text-sm font-medium cursor-pointer">
                        <input type="checkbox" id="hide-registered-matches" onchange="renderCalendar()" class="w-4 h-4 text-slate-800">
                        Ocultar registrados
                    </label>
                </div>
                
                <!-- Competition Filters -->
                <div class="bg-white rounded-xl shadow-sm p-4 mb-4">
                    <div id="calendar-filters-container" class="flex flex-wrap gap-2">
                        <!-- Filters populated dynamically -->
                    </div>
                </div>

                <!-- Time Filter (Only for list view) -->
                <div id="cal-time-filters" class="hidden bg-white rounded-xl shadow-sm p-4 mb-4">
                    <div class="flex flex-wrap gap-2">
                        <button onclick="filterCalendarTime('all')" class="time-filter px-3 py-1 text-sm rounded-full bg-slate-800 text-white">Todos</button>
                        <button onclick="filterCalendarTime('past')" class="time-filter px-3 py-1 text-sm rounded-full bg-gray-200 text-gray-700">Pasados</button>
                        <button onclick="filterCalendarTime('future')" class="time-filter px-3 py-1 text-sm rounded-full bg-gray-200 text-gray-700">Pr√≥ximos</button>
                    </div>
                </div>
                
                <!-- Month Navigation (Only for month view) -->
                <div id="cal-month-nav" class="bg-white rounded-xl shadow-sm p-4 mb-4 flex justify-between items-center">
                    <button onclick="changeCalendarMonth(-1)" class="p-2 hover:bg-gray-100 rounded-full">‚¨ÖÔ∏è Anterior</button>
                    <h3 id="current-month-display" class="text-lg font-bold text-slate-800"></h3>
                    <button onclick="changeCalendarMonth(1)" class="p-2 hover:bg-gray-100 rounded-full">Siguiente ‚û°Ô∏è</button>
                </div>
                
                <div id="calendar-container" class="space-y-3">
                    <div class="calendar-loading text-center py-12">
                        <div class="text-4xl mb-4">‚è≥</div>
                        <p class="text-gray-600">Cargando calendario...</p>
                    </div>
                </div>
            </section>

            <!-- NUEVO PARTIDO SECTION -->
            <section id="section-nuevo" class="hidden fade-in">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">Registrar Nuevo Partido</h2>
                    <p class="text-gray-500 text-sm">Registro en 2 pasos: Datos y Jugadores</p>
                </div>
                
                <!-- Prompt to select from Calendar -->
                <div id="select-match-prompt" class="text-center py-12 bg-white rounded-xl shadow-sm">
                    <div class="text-6xl mb-4">üìÖ</div>
                    <h3 class="text-xl font-medium text-gray-800 mb-2">Selecciona un partido del calendario</h3>
                    <p class="text-gray-500 mb-6 max-w-md mx-auto">Para garantizar la integridad de los datos, todos los partidos deben ser seleccionados primero desde la secci√≥n de Calendario.</p>
                    <button onclick="showTab('calendario')" class="bg-slate-800 hover:bg-slate-700 text-white px-6 py-3 rounded-lg font-medium transition">
                        Ir al Calendario
                    </button>
                </div>

                <div id="new-match-form-container" class="hidden">
                    <!-- Selected Fixture Info -->
                    <div id="selected-fixture-info" class="bg-amber-50 border-2 border-amber-400 rounded-xl p-4 mb-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <p class="text-sm text-amber-800 font-medium">üìÖ Partido seleccionado del calendario:</p>
                                <p id="selected-fixture-details" class="text-amber-900 font-semibold"></p>
                            </div>
                            <button onclick="clearSelectedFixture()" class="text-amber-600 hover:text-amber-800 text-sm font-medium">
                                ‚úï Cancelar selecci√≥n
                            </button>
                        </div>
                    </div>

                    <!-- New Match Form -->
                    <div class="bg-white rounded-xl shadow-sm p-6">
                        <form id="new-match-form" class="space-y-6">
                            <input type="hidden" id="calendar-event-id" value="">
                            
                            <!-- STEP 1: DATOS DEL PARTIDO -->
                            <div id="wizard-step-1">
                                <h3 class="text-lg font-bold text-gray-800 mb-4 pb-2 border-b">Paso 1: Datos del Partido</h3>
                                
                                <!-- Competition Selection -->
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Competici√≥n *</label>
                                        <select id="new-competition" required onchange="updateRoundOptions()" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500">
                                            <option value="">Seleccionar competici√≥n...</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Jornada / Ronda *</label>
                                        <select id="new-round" required onchange="handleRoundChange()" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500">
                                            <option value="">Primero selecciona competici√≥n...</option>
                                        </select>
                                        <p id="round-info" class="text-xs text-gray-500 mt-1"></p>
                                    </div>
                                </div>

                                <!-- Match Details -->
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Fecha del Partido *</label>
                                        <input type="date" id="new-date" required class="w-full px-3 py-2 border rounded-lg bg-gray-100 text-gray-500" readonly>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Rival *</label>
                                        <input type="text" id="new-opponent" required class="w-full px-3 py-2 border rounded-lg bg-gray-100 text-gray-500" readonly>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Condici√≥n *</label>
                                        <select id="new-venue" required onchange="updateStadiumField()" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500">
                                            <option value="">Seleccionar...</option>
                                            <option value="local">üè† Local</option>
                                            <option value="visitante">‚úàÔ∏è Visitante</option>
                                            <option value="neutral">üèüÔ∏è Campo Neutral</option>
                                        </select>
                                    </div>
                                </div>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                                    <div id="stadium-container">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Estadio</label>
                                        <input type="text" id="new-stadium" class="w-full px-3 py-2 border rounded-lg bg-gray-100" value="Santiago Bernab√©u" readonly>
                                    </div>
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Resultado *</label>
                                        <input type="text" id="new-result" required oninput="updateOvertimeOptions()" placeholder="ej: 2-1 (local-visitante)" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500" pattern="^\d+-\d+$">
                                        <p class="text-xs text-gray-500 mt-1">Formato: goles_local-goles_visitante</p>
                                    </div>
                                </div>
                                
                                <!-- EXTRA TIME / PENALTIES CONTROLS -->
                                <div id="overtime-controls" class="hidden mt-4 p-4 bg-orange-50 border border-orange-200 rounded-lg">
                                    <h4 class="font-bold text-orange-800 mb-2">Desenlace Eliminatoria</h4>
                                    <div id="extra-time-option" class="hidden mb-2">
                                        <label class="flex items-center gap-2 cursor-pointer">
                                            <input type="checkbox" id="chk-extra-time" class="w-4 h-4 text-orange-600">
                                            <span class="text-sm font-medium text-gray-700">Pr√≥rroga jugada</span>
                                        </label>
                                    </div>
                                    <div id="penalties-option" class="hidden">
                                        <label class="flex items-center gap-2 cursor-pointer mb-2">
                                            <input type="checkbox" id="chk-penalties" class="w-4 h-4 text-orange-600" onchange="togglePenaltyWinner()">
                                            <span class="text-sm font-medium text-gray-700">Tanda de Penaltis</span>
                                        </label>
                                        <div id="penalty-winner-select" class="hidden ml-6">
                                            <p class="text-xs text-gray-500 mb-1">Resultado de la tanda:</p>
                                            <div class="flex gap-4">
                                                <label class="flex items-center gap-1 cursor-pointer">
                                                    <input type="radio" name="penalties-outcome" value="win" class="text-green-600">
                                                    <span class="text-sm text-green-700 font-bold">Victoria</span>
                                                </label>
                                                <label class="flex items-center gap-1 cursor-pointer">
                                                    <input type="radio" name="penalties-outcome" value="loss" class="text-red-600">
                                                    <span class="text-sm text-red-700 font-bold">Derrota</span>
                                                </label>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Ida/Vuelta indicator for two-leg ties -->
                                <div id="leg-indicator" class="hidden p-4 global-result rounded-lg mb-4 mt-4">
                                    <p id="leg-info" class="text-sm text-blue-800"></p>
                                </div>

                                <!-- Venue alternation warning -->
                                <div id="venue-alternation-warning" class="hidden p-4 bg-amber-50 border border-amber-200 rounded-lg mb-4">
                                    <p id="venue-alternation-info" class="text-sm text-amber-800"></p>
                                </div>
                                
                                <div class="flex justify-end pt-4 border-t">
                                    <button type="button" onclick="goToStep2()" class="px-6 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-700 font-medium">
                                        Siguiente: Jugadores ‚û°Ô∏è
                                    </button>
                                </div>
                            </div>

                            <!-- STEP 2: JUGADORES -->
                            <div id="wizard-step-2" class="hidden h-full">
                                <div class="flex flex-col sm:flex-row justify-between items-center mb-2 pb-2 border-b gap-3">
                                    <h3 class="text-lg font-bold text-gray-800">Paso 2: Alineaci√≥n</h3>
                                    
                                    <div class="flex items-center gap-3">
                                        <div class="bg-gray-100 p-1 rounded-lg flex text-sm">
                                            <button type="button" id="btn-mode-list" class="px-3 py-1 text-gray-500 hover:text-gray-700 transition-all" onclick="switchLineupMode('list')">Lista</button>
                                            <button type="button" id="btn-mode-pitch" class="px-3 py-1 bg-white shadow rounded text-gray-800 font-medium transition-all" onclick="switchLineupMode('pitch')">Pizarra</button>
                                        </div>
                                        <button type="button" onclick="goToStep1()" class="text-sm text-blue-600 hover:underline">‚¨ÖÔ∏è Volver</button>
                                    </div>
                                </div>

                                <div id="mode-list-container" class="hidden">
                                    <div class="mb-2 text-sm text-amber-700 bg-amber-50 p-2 rounded">‚ö†Ô∏è Selecciona "Titular" o "Suplente".</div>
                                    <div id="new-match-players-stats" class="space-y-3 h-[60vh] overflow-y-auto border border-gray-200 rounded-xl p-4 bg-gray-50"></div>
                                </div>

                                <div id="mode-pitch-container" class="flex flex-col h-full">
                                    
                                    <div class="mb-2 flex items-center justify-center gap-2">
                                        <label class="text-sm font-bold text-gray-700">Esquema:</label>
                                        <select id="formation-select" class="border rounded px-2 py-1 bg-white text-gray-800 focus:ring-2 focus:ring-green-500 text-sm" onchange="updatePitchFormation()">
                                            <option value="4-3-3">4-3-3</option>
                                            <option value="4-4-2">4-4-2</option>
                                            <option value="4-2-3-1">4-2-3-1</option>
                                            <option value="3-5-2">3-5-2</option>
                                        </select>
                                    </div>

                                    <div class="flex flex-col md:flex-row gap-4 h-[550px]"> 
                                        
                                        <div class="flex-1 relative bg-gray-800 rounded-xl border-4 border-gray-800 overflow-hidden shadow-xl">
                                            <div class="pitch-container w-full h-full" id="tactical-pitch" style="margin: 0; border: none; border-radius: 0;">
                                                <div class="pitch-line-mid"></div>
                                                <div class="pitch-circle"></div>
                                                <div class="pitch-box-left" style="left:0; border-left:none;"></div>
                                                <div class="pitch-box-right" style="right:0; border-right:none;"></div>
                                                
                                                <div id="pitch-slots-layer"></div>
                                                <div id="pitch-players-layer"></div>
                                            </div>
                                        </div>

                                        <div class="w-full md:w-72 flex flex-col gap-2 h-full">
                                            
                                            <div class="flex-1 bg-white rounded-xl border border-gray-300 flex flex-col shadow-sm overflow-hidden">
                                                <div class="bg-gray-100 p-2 border-b border-gray-200">
                                                    <h5 class="text-xs font-bold text-gray-600 uppercase text-center">Plantilla Disponible</h5>
                                                </div>
                                                <div id="bench-zone" class="bench-container flex-1 overflow-y-auto p-2 bg-gray-50 content-start">
                                                    </div>
                                            </div>
                                            
                                            <div class="h-32 bg-blue-50 rounded-xl border-2 border-dashed border-blue-300 flex flex-col overflow-hidden">
                                                <div class="bg-blue-100 p-1 border-b border-blue-200">
                                                    <h5 class="text-[10px] font-bold text-blue-600 uppercase text-center">Suplentes Convocados</h5>
                                                </div>
                                                <div id="subs-zone" class="flex-1 p-2 overflow-y-auto flex flex-wrap gap-2 content-start">
                                                    </div>
                                            </div>

                                        </div>
                                    </div>
                                </div>

                                <div class="flex gap-3 pt-4 border-t mt-4">
                                    <button type="button" onclick="goToStep1()" class="px-6 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 font-medium">Atr√°s</button>
                                    <button type="button" onclick="goToStep3()" class="flex-1 px-4 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-700 font-bold text-lg shadow-lg flex items-center justify-center gap-2 transform hover:scale-[1.01] transition-all">
                                        CONFIRMAR ALINEACI√ìN ‚û°Ô∏è
                                    </button>
                                </div>
                            </div>
                            <div id="wizard-step-3" class="hidden">
                                <div class="flex flex-col sm:flex-row justify-between items-center mb-4 pb-2 border-b gap-3">
                                    <h3 class="text-lg font-bold text-gray-800">Paso 3: Rendimiento</h3>
                                    <button type="button" onclick="goToStep2()" class="text-sm text-blue-600 hover:underline">‚¨ÖÔ∏è Volver a Pizarra</button>
                                </div>

                                <div class="mb-2 text-sm text-green-700 bg-green-50 p-2 rounded">‚úÖ Alineaci√≥n confirmada. Introduce las estad√≠sticas del partido.</div>
                                
                                <div id="final-stats-container" class="space-y-3 h-[60vh] overflow-y-auto border border-gray-200 rounded-xl p-4 bg-gray-50"></div>

                                <div class="flex gap-3 pt-4 border-t mt-4">
                                    <button type="button" onclick="resetNewMatchForm()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">Cancelar</button>
                                    <button type="submit" class="flex-1 px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 font-medium font-bold text-lg shadow-md hover:shadow-lg transition-all transform hover:-translate-y-0.5">üíæ GUARDAR PARTIDO</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>
            </section>

            <!-- PARTIDOS REGISTRADOS SECTION -->
            <section id="section-partidos" class="hidden fade-in">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Partidos Registrados</h2>
                        <p class="text-gray-500 text-sm">Historial de partidos con estad√≠sticas</p>
                    </div>
                </div>

                <!-- Match Filters -->
                <div class="bg-white rounded-xl shadow-sm p-4 mb-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Competici√≥n</label>
                            <select id="filter-competition" onchange="renderMatches()" class="w-full px-3 py-2 border rounded-lg">
                                <option value="">Todas las competiciones</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Condici√≥n</label>
                            <select id="filter-venue" onchange="renderMatches()" class="w-full px-3 py-2 border rounded-lg">
                                <option value="">Todos</option>
                                <option value="local">Local</option>
                                <option value="visitante">Visitante</option>
                                <option value="neutral">Campo Neutral</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Resultado</label>
                            <select id="filter-result" onchange="renderMatches()" class="w-full px-3 py-2 border rounded-lg">
                                <option value="">Todos</option>
                                <option value="victoria">Victorias</option>
                                <option value="empate">Empates</option>
                                <option value="derrota">Derrotas</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="bg-gray-100 p-3 rounded-lg mb-4 flex flex-col md:flex-row gap-3 items-center border border-gray-200">
                                    <div class="flex-1 w-full">
                                        <input type="text" id="filter-rival" placeholder="üîç Buscar rival (ej: Bar√ßa)" 
                                               class="w-full px-3 py-2 rounded border border-gray-300 text-sm focus:ring-2 focus:ring-blue-500"
                                               onkeyup="applyMatchFilters()">
                                    </div>
                                    <div class="w-full md:w-auto">
                                        <select id="filter-competition" class="w-full px-3 py-2 rounded border border-gray-300 text-sm" onchange="applyMatchFilters()">
                                            <option value="all">Todas las Competiciones</option>
                                            <option value="Liga">Liga</option>
                                            <option value="Champions">Champions League</option>
                                            <option value="Copa">Copa del Rey</option>
                                            <option value="Supercopa">Supercopa</option>
                                        </select>
                                    </div>
                                    <div class="w-full md:w-auto">
                                        <select id="filter-result" class="w-full px-3 py-2 rounded border border-gray-300 text-sm" onchange="applyMatchFilters()">
                                            <option value="all">Todos los resultados</option>
                                            <option value="victoria">‚úÖ Victorias</option>
                                            <option value="empate">‚ûñ Empates</option>
                                            <option value="derrota">‚ùå Derrotas</option>
                                        </select>
                                    </div>
                                </div>
                <div id="matches-list" class="space-y-4"></div>
                <div id="no-matches" class="hidden text-center py-12">
                    <div class="text-6xl mb-4">üìÖ</div>
                    <h3 class="text-xl font-medium text-gray-600">No hay partidos registrados</h3>
                    <p class="text-gray-500">Ve a "üìÖ Calendario" y haz clic en un partido pasado para registrarlo</p>
                </div>
            </section>

            <!-- COMPARATOR SECTION -->
            <section id="section-comparador" class="hidden fade-in">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Comparador de Jugadores</h2>
                <div class="bg-white rounded-xl shadow-sm p-6">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Jugador 1</label>
                            <select id="compare-p1" onchange="renderComparator()" class="w-full px-3 py-2 border rounded-lg"></select>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Jugador 2</label>
                            <select id="compare-p2" onchange="renderComparator()" class="w-full px-3 py-2 border rounded-lg"></select>
                        </div>
                    </div>
                    <div id="comparator-result" class="hidden">
                        <!-- Populated by JS -->
                    </div>
                </div>
            </section>

            <!-- STATS SECTION -->
            <section id="section-stats" class="hidden fade-in">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                    <h2 class="text-2xl font-bold text-gray-800">Estad√≠sticas</h2>
                    
                    <div class="flex p-1.5 bg-white border border-gray-200 rounded-xl shadow-sm">
                         <button onclick="switchStatsTab('general')" id="btn-stats-general" class="stats-subtab active">
                            üìä General
                         </button>
                         <button onclick="switchStatsTab('advanced')" id="btn-stats-advanced" class="stats-subtab inactive">
                              üìà Avanzado
                         </button>
                         <button onclick="switchStatsTab('h2h')" id="btn-stats-h2h" class="stats-subtab inactive">
                             ‚öîÔ∏è H2H (Rival)
                         </button>
                    </div>
                </div>
                
                
                
                <!-- SUB-SECTION: GENERAL -->
                     <div id="stats-general" class="fade-in bg-white rounded-xl shadow-lg border-t-4 border-indigo-500 p-6">
                        <div class="flex justify-between items-center mb-6 pb-4 border-b">
                         <h3 class="text-lg font-bold text-gray-800">Estad√≠sticas Generales</h3>

                    <div class="flex gap-2">
                  <button onclick="exportStats()" ...>
                     üì• Exportar CSV
                         </button>

                        <button onclick="openComparatorModal()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-4 py-2 rounded-lg font-bold flex items-center gap-2 shadow transition transform hover:scale-105">
                üÜö Comparador VS
                     </button>
                         </div> </div>

                    <!-- Summary Cards -->
                    <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-4 xl:grid-cols-8 gap-4 mb-8">
                        <div class="bg-gradient-to-br from-slate-700 to-slate-800 rounded-xl p-4 text-white">
                            <p class="text-slate-300 text-sm">Partidos</p>
                            <p id="stat-total-matches" class="text-3xl font-bold">0</p>
                        </div>
                        <div class="bg-gradient-to-br from-green-500 to-green-600 rounded-xl p-4 text-white">
                            <p class="text-green-100 text-sm">Victorias</p>
                            <p id="stat-wins" class="text-3xl font-bold">0</p>
                        </div>
                        <div class="bg-gradient-to-br from-amber-500 to-amber-600 rounded-xl p-4 text-white">
                            <p class="text-amber-100 text-sm">Empates</p>
                            <p id="stat-draws" class="text-3xl font-bold">0</p>
                        </div>
                        <div class="bg-gradient-to-br from-red-500 to-red-600 rounded-xl p-4 text-white">
                            <p class="text-red-100 text-sm">Derrotas</p>
                            <p id="stat-losses" class="text-3xl font-bold">0</p>
                        </div>
                        <div class="bg-gradient-to-br from-emerald-500 to-emerald-600 rounded-xl p-4 text-white">
                            <p class="text-emerald-100 text-sm">Goles Favor</p>
                            <p id="stat-total-goals" class="text-3xl font-bold">0</p>
                        </div>
                        <div class="bg-gradient-to-br from-rose-500 to-rose-600 rounded-xl p-4 text-white">
                            <p class="text-rose-100 text-sm">Goles Contra</p>
                            <p id="stat-total-goals-against" class="text-3xl font-bold">0</p>
                        </div>
                        <div class="bg-gradient-to-br from-purple-500 to-purple-600 rounded-xl p-4 text-white">
                            <p class="text-purple-100 text-sm">Asistencias</p>
                            <p id="stat-total-assists" class="text-3xl font-bold">0</p>
                        </div>
                        <div class="bg-gradient-to-br from-indigo-500 to-indigo-600 rounded-xl p-4 text-white">
                            <p class="text-indigo-100 text-sm">Jugadores</p>
                            <p id="stat-total-players" class="text-3xl font-bold">0</p>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4 flex flex-col items-center">
                            <h4 class="font-bold text-gray-700 mb-4">üéØ Distribuci√≥n de Goles por Posici√≥n</h4>
                            <div class="w-full max-w-xs">
                                <canvas id="chart-goals-distribution"></canvas>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-sm border border-gray-200 p-4">
                            <h4 class="font-bold text-gray-700 mb-4">üìà Evoluci√≥n Nota Media del Equipo</h4>
                            <div class="w-full h-64">
                                <canvas id="chart-season-evolution"></canvas>
                            </div>
                        </div>
                    </div>

                    <!-- Stats Filters -->
                    <div class="bg-gray-50 rounded-xl p-4 mb-6 border border-gray-100">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Filtrar por Competici√≥n</label>
                                <select id="stats-filter-competition" onchange="renderStats()" class="w-full px-3 py-2 border rounded-lg bg-white">
                                    <option value="">Todas las competiciones</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-1">Estado del Jugador</label>
                                <select id="stats-filter-status" onchange="renderStats()" class="w-full px-3 py-2 border rounded-lg bg-white">
                                    <option value="">Todos</option>
                                    <option value="Activo">Solo Activos</option>
                                    <option value="Inactivo">Solo Inactivos</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Stats Table -->
                    <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                        <div class="p-4 border-b bg-gray-50">
                            <h3 class="font-semibold text-gray-800">Rendimiento Individual</h3>
                            <p class="text-xs text-gray-500 mt-1">Haz clic en los encabezados para ordenar.</p>
                        </div>
                        <div class="table-container">
                            <table class="w-full">
                                <thead class="bg-slate-800 text-white">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-xs font-semibold uppercase">Jugador</th>
                                        <th id="th-matchesPlayed" class="px-4 py-3 text-center text-xs font-semibold uppercase sortable" onclick="handleSort('matchesPlayed')">PJ</th>
                                        <th id="th-avgRating" class="px-4 py-3 text-center text-xs font-semibold uppercase sortable" onclick="handleSort('avgRating')">Nota</th>
                                        <th id="th-goals" class="px-4 py-3 text-center text-xs font-semibold uppercase sortable" onclick="handleSort('goals')">Gol</th>
                                        <th id="th-assists" class="px-4 py-3 text-center text-xs font-semibold uppercase sortable" onclick="handleSort('assists')">Asist</th>
                                        <th id="th-ga" class="px-4 py-3 text-center text-xs font-semibold uppercase sortable" onclick="handleSort('ga')">G/A</th>
                                        <th id="th-minutes" class="px-4 py-3 text-center text-xs font-semibold uppercase sortable" onclick="handleSort('minutes')">Min</th>
                                        <th id="th-mvpCount" class="px-4 py-3 text-center text-xs font-semibold uppercase sortable" onclick="handleSort('mvpCount')">MVP</th>
                                        <th id="th-wins" class="px-4 py-3 text-center text-xs font-semibold uppercase sortable" onclick="handleSort('wins')">V</th>
                                        <th id="th-draws" class="px-4 py-3 text-center text-xs font-semibold uppercase sortable" onclick="handleSort('draws')">E</th>
                                        <th id="th-losses" class="px-4 py-3 text-center text-xs font-semibold uppercase sortable" onclick="handleSort('losses')">D</th>
                                        <th class="px-4 py-3 text-center text-xs font-semibold uppercase">üü®</th>
                                        <th class="px-4 py-3 text-center text-xs font-semibold uppercase">üü•</th>
                                    </tr>
                                </thead>
                                <tbody id="stats-table-body"></tbody>
                            </table>
                        </div>
                        <div id="no-stats" class="hidden text-center py-8 text-gray-500">
                            No hay estad√≠sticas disponibles.
                        </div>
                    </div>
                </div>

                <!-- SUB-SECTION: ADVANCED -->
                <div id="stats-advanced" class="hidden fade-in space-y-6 bg-white rounded-xl shadow-lg border-t-4 border-emerald-500 p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-6 pb-2 border-b">Estad√≠sticas Avanzadas</h3>
                    
                    <!-- Home vs Away Comparison -->
                    <div>
                        <h4 class="font-bold text-gray-700 mb-4">Rendimiento: Casa vs Fuera</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4" id="home-away-stats-container">
                            <!-- Populated by JS -->
                        </div>
                    </div>

                    <!-- Heatmap by Position -->
                    <div>
                        <h4 class="font-bold text-gray-700 mb-4">Mapa de Rendimiento (Nota Media por Posici√≥n)</h4>
                        <div class="heatmap-pitch" id="heatmap-container">
                             <!-- Populated by JS -->
                        </div>
                    </div>

                    <!-- Monthly Report -->
                    <div>
                        <h4 class="font-bold text-gray-700 mb-4">Reporte Mensual</h4>
                        <div class="bg-white rounded-xl border border-gray-200 overflow-hidden">
                             <table class="w-full text-sm">
                                <thead class="bg-slate-800 text-white">
                                    <tr>
                                        <th class="px-4 py-2 text-left">Mes</th>
                                        <th class="px-4 py-2 text-center">Partidos</th>
                                        <th class="px-4 py-2 text-center">V-E-D</th>
                                        <th class="px-4 py-2 text-center">GF / GC</th>
                                        <th class="px-4 py-2 text-center">Nota Media Equipo</th>
                                    </tr>
                                </thead>
                                <tbody id="monthly-report-body">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- SUB-SECTION: H2H -->
                <div id="stats-h2h" class="hidden fade-in bg-white rounded-xl shadow-lg border-t-4 border-pink-500 p-6">
                    <h3 class="text-xl font-bold text-gray-800 mb-6 pb-2 border-b">Historial contra Rival (Head to Head)</h3>
                    <div class="bg-gray-50 rounded-xl p-4 mb-6 border border-gray-100">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Selecciona un rival hist√≥rico</label>
                        <select id="h2h-opponent-select" onchange="renderH2H()" class="w-full px-3 py-2 border rounded-lg bg-white">
                            <option value="">Selecciona rival...</option>
                        </select>
                    </div>
                    <div id="h2h-content" class="hidden space-y-6">
                        <!-- Populated by JS -->
                    </div>
                </div>

            </section>
        </main>
    </div>

    <!-- PLAYER DETAILS & STATS MODAL -->
    <div id="player-details-modal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b sticky top-0 bg-slate-800 text-white rounded-t-2xl z-10">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold">Ficha de Jugador</h3>
                    <button onclick="closePlayerDetailsModal()" class="text-slate-300 hover:text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div id="player-details-content" class="p-6"></div>
        </div>
    </div>

    <!-- MATCH DETAIL MODAL -->
    <div id="match-detail-modal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-3xl max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b sticky top-0 bg-slate-800 text-white rounded-t-2xl">
                <div class="flex justify-between items-center">
                    <h3 id="match-detail-title" class="text-xl font-bold">Detalles del Partido</h3>
                    <button onclick="closeMatchDetailModal()" class="text-slate-300 hover:text-white cursor-pointer z-50 p-2">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div id="match-detail-content" class="p-6"></div>
        </div>
    </div>

    <!-- EDIT MATCH MODAL -->
    <div id="edit-match-modal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-4xl max-h-[90vh] overflow-y-auto">
            <div class="p-6 border-b sticky top-0 bg-slate-800 text-white rounded-t-2xl z-10">
                <div class="flex justify-between items-center">
                    <div>
                        <h3 class="text-xl font-bold">Editar Partido</h3>
                        <p id="edit-match-subtitle" class="text-slate-300 text-sm"></p>
                    </div>
                    <button onclick="closeEditMatchModal()" class="text-slate-300 hover:text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
            <form id="edit-match-form" class="p-6 space-y-6">
                <input type="hidden" id="edit-match-id">
                <div id="edit-match-content"></div>
                <div class="flex gap-3 pt-4 border-t">
                    <button type="button" onclick="closeEditMatchModal()" class="flex-1 px-4 py-2 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50">
                        Cancelar
                    </button>
                    <button type="submit" class="flex-1 px-4 py-2 bg-amber-500 text-white rounded-lg hover:bg-amber-600 font-medium">
                        Guardar Cambios
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- PLAYER STATUS MODAL -->
    <div id="player-status-modal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-md">
            <div class="p-6 border-b bg-slate-800 text-white rounded-t-2xl">
                <div class="flex justify-between items-center">
                    <h3 class="text-xl font-bold">Cambiar Estado</h3>
                    <button onclick="closePlayerStatusModal()" class="text-slate-300 hover:text-white">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                        </svg>
                    </button>
                </div>
            </div>
            <div id="player-status-content" class="p-6"></div>
        </div>
    </div>
    <div id="extra-round-modal" class="modal fixed inset-0 bg-black/50 items-center justify-center z-50 p-4">
        <div class="bg-white rounded-2xl w-full max-w-md">
            <div class="p-6 border-b bg-slate-800 text-white rounded-t-2xl">
                <h3 class="text-xl font-bold">Ronda Adicional</h3>
            </div>
            <div class="p-6">
                <p class="text-gray-700 mb-4">Se ha terminado la fase regular. Seg√∫n tu posici√≥n en la tabla:</p>
                <p class="font-bold text-lg text-slate-800 mb-6">¬øDebe jugarse la ronda extra (Play-offs / Eliminatoria previa)?</p>
                
                <div class="bg-amber-50 border border-amber-200 rounded-lg p-3 mb-6 flex items-start gap-3">
                    <input type="checkbox" id="chk-play-extra" class="w-5 h-5 text-amber-600 mt-0.5">
                    <div>
                        <label for="chk-play-extra" class="font-bold text-amber-800 cursor-pointer">S√≠, jugar ronda extra</label>
                        <p class="text-xs text-amber-700">Marca esto si has quedado entre la posici√≥n 9 y 24 (Masculino) o necesitas jugar ronda previa (Femenino).</p>
                    </div>
                </div>

                <div class="flex gap-3">
                    <button onclick="confirmExtraRound()" class="flex-1 px-4 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-700 font-medium">
                        Confirmar
                    </button>
                </div>
            </div>
        </div>
    </div>
    </div>
    </div>
    <div id="modal-comparator" class="fixed inset-0 bg-black/80 hidden z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-2xl shadow-2xl w-full max-w-4xl p-6 m-4 relative overflow-y-auto max-h-[90vh]">
            <button onclick="document.getElementById('modal-comparator').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-gray-800 text-2xl">‚úï</button>
            
            <h2 class="text-2xl font-bold text-gray-800 mb-6 text-center border-b pb-4">‚öîÔ∏è Duelo de Estad√≠sticas</h2>
            
            <div class="flex justify-between items-center gap-4 mb-8">
                <select id="comp-p1" class="flex-1 p-3 border-2 border-blue-100 rounded-xl font-bold text-blue-800 focus:border-blue-500 bg-blue-50" onchange="updateComparatorChart()"></select>
                <div class="text-2xl font-black text-gray-300">VS</div>
                <select id="comp-p2" class="flex-1 p-3 border-2 border-red-100 rounded-xl font-bold text-red-800 focus:border-red-500 bg-red-50" onchange="updateComparatorChart()"></select>
            </div>

            <div class="flex flex-col md:flex-row gap-8 items-center">
                <div class="flex-1 w-full relative h-[350px]">
                    <canvas id="chart-radar-vs"></canvas>
                </div>

                <div class="w-full md:w-1/3 bg-gray-50 p-4 rounded-xl border border-gray-200">
                    <h4 class="text-sm font-bold text-gray-500 uppercase mb-3 text-center">Datos Totales</h4>
                    <div id="comparator-stats-table" class="space-y-3 text-sm">
                        </div>
                </div>
            </div>
        </div>
    </div>
    <script>
        // ==========================================
        // DATA & CONSTANTS
        // ==========================================
        
        let currentTeam = null; 
        let PLANTILLA_ACTUAL = [];
        let COMPETICIONES_ACTUALES = {};
        
        // Custom order for registration as requested
        const CUSTOM_ORDER_MASCULINO = [
            'dt1', 'p1', 'p13', 'p12', 'p2', 'p24', 'p17b', 'p22', 'p3', 'p4', 'p18', 'p20', 'p23', 
            'p14', 'p6', 'p8', 'p19', 'p5', 'p15', 'p7', 'p11', 'p21', 'p10', 'p16', 'p9', 'p30', 
            'p10b', 'p17', 'p44', 'p31','p40','p35','p28'
        ];
        const CUSTOM_ORDER_FEMENINO = [
            'dt_fem', 'pf1', 'pf13', 'pf15', 'pf2', 'pf23', 'pf14', 'pf4','pf22' ,'pf21', 'pf12', 'pf3', 'pf6', 'pf16', 
            'pf17', 'pf10', 'pf8', 'pf18', 'pf7', 'pf19', 'pf5', 'pf20', 'pf9', 'pf11', 'pf24', 'pf28', 'pf29', 
            'pf33', 'pf43', 'pf27','pf38'
        ];
        const PLANTILLA_MASCULINO = [
            { id: "dt1", nombre: "Xabi", apellido: "Alonso", apodo: "Xabi Alonso", posicion: "entrenador", dorsal: "DT", nacionalidad: "Espa√±a", fechaNacimiento: "1981-11-25", categoria: "Primer Equipo", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20XABI_CARITA_380x501%20%E2%80%93%202?$Desktop$&fit=wrap&wid=288&hei=384" },
            { id: "p1", nombre: "Thibaut", apellido: "Courtois", apodo: "Courtois", posicion: "portero", dorsal: 1, nacionalidad: "B√©lgica", fechaNacimiento: "1992-05-11", categoria: "Primer Equipo", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20COURTOIS_EQUIPO_CARITA_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "p2", nombre: "Dani", apellido: "Carvajal", apodo: "Carvajal", posicion: "defensa", dorsal: 2, nacionalidad: "Espa√±a", fechaNacimiento: "1992-01-11", categoria: "Primer Equipo", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20CARVAJAL_EQUIPO_CARITA_380x501%20%E2%80%93%206?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "p3", nombre: "√âder", apellido: "Milit√£o", apodo: "Milit√£o", posicion: "defensa", dorsal: 3, nacionalidad: "Brasil", fechaNacimiento: "1998-01-18", categoria: "Primer Equipo", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20MILITAO_EQUIPO_CARITA_380x501%20%E2%80%93%2013?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "p4", nombre: "David", apellido: "Alaba", apodo: "Alaba", posicion: "defensa", dorsal: 4, nacionalidad: "Austria", fechaNacimiento: "1992-06-24", categoria: "Primer Equipo", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20ALABA_EQUIPO_CARITA_380x501%20%E2%80%93%201?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "p5", nombre: "Jude", apellido: "Bellingham", apodo: "Bellingham", posicion: "centrocampista", dorsal: 5, nacionalidad: "Inglaterra", fechaNacimiento: "2003-06-29", categoria: "Primer Equipo", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20BELLINGHAM_EQUIPO_CARITA_380x501%20%E2%80%93%201?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "p6", nombre: "Eduardo", apellido: "Camavinga", apodo: "Camavinga", posicion: "centrocampista", dorsal: 6, nacionalidad: "Francia", fechaNacimiento: "2002-11-10", categoria: "Primer Equipo", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20CAMAVINGA_EQUIPO_CARITA_380x501%20%E2%80%93%201?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "p7", nombre: "Vin√≠cius", apellido: "J√∫nior", apodo: "Vini Jr.", posicion: "extremo", dorsal: 7, nacionalidad: "Brasil", fechaNacimiento: "2000-07-12", categoria: "Primer Equipo", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20VINI_EQUIPO_CARITA_380x501%20%E2%80%93%201?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "p8", nombre: "Federico", apellido: "Valverde", apodo: "Valverde", posicion: "centrocampista", dorsal: 8, nacionalidad: "Uruguay", fechaNacimiento: "1998-07-22", categoria: "Primer Equipo", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20VALVERDE_EQUIPO_CARITA_380x501%20%E2%80%93%201?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "p9", nombre: "Endrick", apellido: "Felipe", apodo: "Endrick", posicion: "delantero", dorsal: 9, nacionalidad: "Brasil", fechaNacimiento: "2006-07-21", categoria: "Primer Equipo", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20ENDRICK_EQUIPO_CARITA_380x501%20%E2%80%93%208?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "p10", nombre: "Kylian", apellido: "Mbapp√©", apodo: "Mbapp√©", posicion: "delantero", dorsal: 10, nacionalidad: "Francia", fechaNacimiento: "1998-12-20", categoria: "Primer Equipo", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20MBAPPE_EQUIPO_CARITA_380x501%20%E2%80%93%201?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "p10b", nombre: "Luka", apellido: "Modriƒá", apodo: "Modriƒá", posicion: "centrocampista", dorsal: 10, nacionalidad: "Croacia", fechaNacimiento: "1985-09-09", categoria: "Primer Equipo", estado: "Inactivo", foto: "https://assets.realmadrid.com/is/image/realmadrid/MODRIC_EQUIPO_CARITA_550X650+%E2%80%93+1" },
            { id: "p11", nombre: "Rodrygo", apellido: "Goes", apodo: "Rodrygo", posicion: "extremo", dorsal: 11, nacionalidad: "Brasil", fechaNacimiento: "2001-01-09", categoria: "Primer Equipo", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20RODRYGO_EQUIPO_CARITA_380x501%20%E2%80%93%201?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "p12", nombre: "Trent", apellido: "Alexander-Arnold", apodo: "Alexander-Arnold", posicion: "defensa", dorsal: 12, nacionalidad: "Inglaterra", fechaNacimiento: "1998-10-07", categoria: "Primer Equipo", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20TRENT_EQUIPO_CARITA_380x501%20v2?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "p13", nombre: "Andriy", apellido: "Lunin", apodo: "Lunin", posicion: "portero", dorsal: 13, nacionalidad: "Ucrania", fechaNacimiento: "1999-02-11", categoria: "Primer Equipo", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20LUNIN_EQUIPO_CARITA_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "p14", nombre: "Aur√©lien", apellido: "Tchouam√©ni", apodo: "Tchouam√©ni", posicion: "centrocampista", dorsal: 14, nacionalidad: "Francia", fechaNacimiento: "2000-01-27", categoria: "Primer Equipo", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20TCHOUAMENI_EQUIPO_CARITA_380x501%20%E2%80%93%201?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "p15", nombre: "Arda", apellido: "G√ºler", apodo: "Arda G√ºler", posicion: "centrocampista", dorsal: 15, nacionalidad: "Turqu√≠a", fechaNacimiento: "2005-02-25", categoria: "Primer Equipo", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20ARDA_EQUIPO_CARITA_380x501%20%E2%80%93%202?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "p16", nombre: "Gonzalo", apellido: "Garc√≠a", apodo: "Gonzalo", posicion: "delantero", dorsal: 16, nacionalidad: "Espa√±a", fechaNacimiento: "2004-03-24", categoria: "Cantera", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20GONZALO_EQUIPO_CARITA_380x501%20%E2%80%93%202?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "p17", nombre: "Lucas", apellido: "V√°zquez", apodo: "Lucas V√°zquez", posicion: "defensa", dorsal: 17, nacionalidad: "Espa√±a", fechaNacimiento: "1991-07-01", categoria: "Primer Equipo", estado: "Inactivo", foto: "https://assets.realmadrid.com/is/image/realmadrid/LUCAS_VAZQUEZ_EQUIPO_CARITA_550X650+%E2%80%93+1-1" },
            { id: "p17b", nombre: "Ra√∫l", apellido: "Asencio", apodo: "Asencio", posicion: "defensa", dorsal: 17, nacionalidad: "Espa√±a", fechaNacimiento: "2003-03-13", categoria: "Primer Equipo", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20ASENCIO_EQUIPO_CARITA_380x501%20%E2%80%93%203?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "p18", nombre: "√Ålvaro", apellido: "Carreras", apodo: "Carreras", posicion: "defensa", dorsal: 18, nacionalidad: "Espa√±a", fechaNacimiento: "2003-03-23", categoria: "Primer Equipo", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20CARRERAS_EQUIPO_CARITA_380x501%20%E2%80%93%202?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "p19", nombre: "Dani", apellido: "Ceballos", apodo: "Ceballos", posicion: "centrocampista", dorsal: 19, nacionalidad: "Espa√±a", fechaNacimiento: "1996-08-07", categoria: "Primer Equipo", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20CEBALLOS_EQUIPO_CARITA_380x501%20%E2%80%93%201?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "p20", nombre: "Fran", apellido: "Garc√≠a", apodo: "Fran Garc√≠a", posicion: "defensa", dorsal: 20, nacionalidad: "Espa√±a", fechaNacimiento: "1999-08-14", categoria: "Primer Equipo", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20FRAN_GARCIA_EQUIPO_CARITA_380x501%20%E2%80%93%201?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "p21", nombre: "Brahim", apellido: "D√≠az", apodo: "Brahim", posicion: "extremo", dorsal: 21, nacionalidad: "Marruecos", fechaNacimiento: "1999-08-03", categoria: "Primer Equipo", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20BRAHIM_EQUIPO_CARITA_380x501%20%E2%80%93%201?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "p22", nombre: "Antonio", apellido: "R√ºdiger", apodo: "R√ºdiger", posicion: "defensa", dorsal: 22, nacionalidad: "Alemania", fechaNacimiento: "1993-03-03", categoria: "Primer Equipo", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20RUDIGUER_EQUIPO_CARITA_380x501%20%E2%80%93%202?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "p23", nombre: "Ferland", apellido: "Mendy", apodo: "Mendy", posicion: "defensa", dorsal: 23, nacionalidad: "Francia", fechaNacimiento: "1995-06-08", categoria: "Primer Equipo", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20MENDY_EQUIPO_CARITA_380x501%20%E2%80%93%201" },
            { id: "p24", nombre: "Dean", apellido: "Huijsen", apodo: "Huijsen", posicion: "defensa", dorsal: 24, nacionalidad: "Espa√±a", fechaNacimiento: "2005-04-14", categoria: "Primer Equipo", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20HUIJSEN_EQUIPO_CARITA_380x501%20%E2%80%93%201" },
            { id: "p30", nombre: "Franco", apellido: "Mastantuono", apodo: "Mastantuono", posicion: "extremo", dorsal: 30, nacionalidad: "Argentina", fechaNacimiento: "2007-08-14", categoria: "Primer Equipo", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/2025%20Mastantuono_EQUIPO_CARITA_380x501%20%E2%80%93%202%20v2?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "p31", nombre: "Jacobo", apellido: "Ram√≥n", apodo: "Jacobo Ram√≥n", posicion: "defensa", dorsal: 31, nacionalidad: "Espa√±a", fechaNacimiento: "2005-01-06", categoria: "Cantera", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/JACOBO-RAMON-MONTAJE_JT18489" },
            { id: "p44", nombre: "V√≠ctor", apellido: "Mu√±oz", apodo: "V√≠ctor M√∫√±oz", posicion: "extremo", dorsal: 44, nacionalidad: "Espa√±a", fechaNacimiento: "2003-07-13", categoria: "Cantera", estado: "Inactivo", foto: "https://assets.realmadrid.com/is/image/realmadrid/VICTOR_MU%C3%91OZ" },
            { id: "p40", nombre: "Victor", apellido: "Valdepe√±as", apodo: "Valdepe√±as", posicion: "defensa", dorsal: 40, nacionalidad: "Espa√±a", fechaNacimiento: "2006-10-20", categoria: "Cantera", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/VICTOR_VALDEPE%C3%91AS_550x650?$Desktop$&fit=wrap&wid=420" },
            { id: "p35", nombre: "David", apellido: "Jim√©nez", apodo: "David Jim√©nez", posicion: "defensa", dorsal: 35, nacionalidad: "Espa√±a", fechaNacimiento: "2004-03-14", categoria: "Cantera", estado: "Activo", foto: "https://www.realmadrid.com/es-ES/futbol/cantera-masculina/castilla/david-jimenez-corredor" },
            { id: "p28", nombre: "Jorge", apellido: "Cestero", apodo: "Cestero", posicion: "centrocampista", dorsal: 28, nacionalidad: "Espa√±a", fechaNacimiento: "2006-03-24", categoria: "Cantera", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/JORGE_CESTERO_550x650?$Desktop$&fit=wrap&wid=420" }
        ];

        const PLANTILLA_FEMENINO = [
            { id: "dt_fem", nombre: "Pau", apellido: "Quesada", apodo: "Pau Quesada", posicion: "entrenador", dorsal: "DT", nacionalidad: "Espa√±a", fechaNacimiento: "1992-10-31", categoria: "Primer Equipo", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/PAU_QUESADA_CT_AV39125_380x501?$Desktop$&fit=wrap&wid=288&hei=384" },
            { id: "pf1", nombre: "Misa", apellido: "Rodr√≠guez", apodo: "Misa", posicion: "portero", dorsal: 1, nacionalidad: "Espa√±a", fechaNacimiento: "1999-07-22", categoria: "Primer Equipo", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/MISA_AV38131_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf2", nombre: "Ant√¥nia", apellido: "Silva", apodo: "Ant√¥nia Silva", posicion: "defensa", dorsal: 2, nacionalidad: "Brasil", fechaNacimiento: "1994-04-26", categoria: "Primer Equipo", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/ANTONIA_AV38661_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf3", nombre: "Teresa", apellido: "Abelleira", apodo: "Tere", posicion: "centrocampista", dorsal: 3, nacionalidad: "Espa√±a", fechaNacimiento: "2000-01-09", categoria: "Primer Equipo", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/TERESA_AV38432_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf4", nombre: "Roc√≠o", apellido: "G√°lvez", apodo: "Roc√≠o", posicion: "defensa", dorsal: 4, nacionalidad: "Espa√±a", fechaNacimiento: "1997-04-15", categoria: "Primer Equipo", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/ROCIO_SG11273_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf5", nombre: "Paula", apellido: "Comendador", apodo: "Pau Comendador", posicion: "delantero", dorsal: 5, nacionalidad: "Espa√±a", fechaNacimiento: "2007-06-18", categoria: "Cantera", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/PAU_AV38975_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf6", nombre: "Sandie", apellido: "Toletti", apodo: "Toletti", posicion: "centrocampista", dorsal: 6, nacionalidad: "Francia", fechaNacimiento: "1995-07-13", categoria: "Primer Equipo", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/TOLETTI__AV39153_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf7", nombre: "Athenea", apellido: "del Castillo", apodo: "Athenea", posicion: "extremo", dorsal: 7, nacionalidad: "Espa√±a", fechaNacimiento: "2000-10-24", categoria: "Primer Equipo", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/ATHENEA_AV38283_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf8", nombre: "Sara", apellido: "D√§britz", apodo: "D√§britz", posicion: "centrocampista", dorsal: 8, nacionalidad: "Alemania", fechaNacimiento: "1995-02-15", categoria: "Primer Equipo", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/DABRITZ_AV38874_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf9", nombre: "Signe", apellido: "Bruun", apodo: "Bruun", posicion: "delantero", dorsal: 9, nacionalidad: "Dinamarca", fechaNacimiento: "1998-04-02", categoria: "Primer Equipo", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/BRUUN_SG12081_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf10", nombre: "Caroline", apellido: "Weir", apodo: "Weir", posicion: "centrocampista", dorsal: 10, nacionalidad: "Escocia", fechaNacimiento: "1995-06-20", categoria: "Primer Equipo", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/WEIR_AV39819_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf11", nombre: "Alba", apellido: "Redondo", apodo: "Redondo", posicion: "delantero", dorsal: 11, nacionalidad: "Espa√±a", fechaNacimiento: "1996-08-27", categoria: "Primer Equipo", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/REDONDO_SG11818_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf12", nombre: "Yasmim", apellido: "Ribeiro", apodo: "Yasmim", posicion: "defensa", dorsal: 12, nacionalidad: "Brasil", fechaNacimiento: "1996-10-28", categoria: "Primer Equipo", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/YASMIM_AV38779_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf13", nombre: "Merle", apellido: "Frohms", apodo: "Frohms", posicion: "portero", dorsal: 13, nacionalidad: "Alemania", fechaNacimiento: "1995-01-28", categoria: "Primer Equipo", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/FROHMS_SG11686_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf14", nombre: "Mar√≠a", apellido: "M√©ndez", apodo: "Mar√≠a M√©ndez", posicion: "defensa", dorsal: 14, nacionalidad: "Espa√±a", fechaNacimiento: "2001-04-10", categoria: "Primer Equipo", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/MENDEZ_AV39701_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf15", nombre: "Sheila", apellido: "Garc√≠a", apodo: "Sheila", posicion: "defensa", dorsal: 15, nacionalidad: "Espa√±a", fechaNacimiento: "1997-03-15", categoria: "Primer Equipo", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/SHEI_AV38558_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf16", nombre: "Filippa", apellido: "Angeldahl", apodo: "Angeldahl", posicion: "centrocampista", dorsal: 16, nacionalidad: "Suecia", fechaNacimiento: "1997-07-14", categoria: "Primer Equipo", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/ANGELDAHL_SG11965_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf17", nombre: "Hanna", apellido: "Bennison", apodo: "Bennison", posicion: "centrocampista", dorsal: 17, nacionalidad: "Suecia", fechaNacimiento: "2002-10-16", categoria: "Primer Equipo", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/BENNISON_AV39265_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf18", nombre: "Linda", apellido: "Caicedo", apodo: "Linda Caicedo", posicion: "extremo", dorsal: 18, nacionalidad: "Colombia", fechaNacimiento: "2005-02-22", categoria: "Primer Equipo", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/LINDA_AV39478_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf19", nombre: "Eva", apellido: "Navarro", apodo: "Eva Navarro", posicion: "extremo", dorsal: 19, nacionalidad: "Espa√±a", fechaNacimiento: "2001-01-27", categoria: "Primer Equipo", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/EVA_NAVARRO_AV39366_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf20", nombre: "Naomie", apellido: "Feller", apodo: "Feller", posicion: "extremo", dorsal: 20, nacionalidad: "Francia", fechaNacimiento: "2001-11-06", categoria: "Primer Equipo", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/FELLER_AV39583_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf21", nombre: "Sara", apellido: "Holmgaard", apodo: "Holmgaard", posicion: "defensa", dorsal: 21, nacionalidad: "Dinamarca", fechaNacimiento: "1999-01-28", categoria: "Primer Equipo", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/HOLMGAARD_SG11429_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf22", nombre: "Bella", apellido: "Andersson", apodo: "Andersson", posicion: "defensa", dorsal: 22, nacionalidad: "Suecia", fechaNacimiento: "2006-07-12", categoria: "Primer Equipo", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/ANDERSSON_SG11562_380x501?Desktop&fit=wrap&wid=288&hei=384" },
            { id: "pf23", nombre: "Ma√´lle", apellido: "Lakrar", apodo: "Lakrar", posicion: "defensa", dorsal: 23, nacionalidad: "Francia", fechaNacimiento: "2000-05-27", categoria: "Primer Equipo", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/LAKRAR_SG12372_380x501?$Desktop$&fit=wrap&wid=288&hei=384" },
            { id: "pf27", nombre: "Noem√≠", apellido: "Bejarano", apodo: "Noe", posicion: "defensa", dorsal: 27, nacionalidad: "Espa√±a", fechaNacimiento: "2006-06-27", categoria: "Cantera", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/NOE_BEJARANO_JT11209_550x650?$Desktop$&fit=wrap&wid=420" },
            { id: "pf28", nombre: "Irune", apellido: "Dorado", apodo: "Irune", posicion: "centrocampista", dorsal: 28, nacionalidad: "Espa√±a", fechaNacimiento: "2008-03-22", categoria: "Cantera", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/IRUNE_DORADO_JT11218_550x650?$Desktop$&fit=wrap&wid=288&hei=384" },
            { id: "pf29", nombre: "Silvia", apellido: "Cristobal", apodo: "Silvi", posicion: "defensa", dorsal: 29, nacionalidad: "Espa√±a", fechaNacimiento: "2008-05-01", categoria: "Cantera", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/SILVIA_CRISTOBAL_JT11245_550x650?$Desktop$&fit=wrap&wid=288&hei=384" },
            { id: "pf33", nombre: "Adriana", apellido: "Folgado", apodo: "Adri Folgado", posicion: "centrocampista", dorsal: 33, nacionalidad: "Espa√±a", fechaNacimiento: "2007-04-10", categoria: "Cantera", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/ADRIANA_FOLGADO_JT11189_550x650?$Desktop$&fit=wrap&wid=288&hei=384" },
            { id: "pf43", nombre: "Iris", apellido: "Ashley", apodo: "Iris Ashley", posicion: "delantero", dorsal: 43, nacionalidad: "Espa√±a", fechaNacimiento: "2007-11-09", categoria: "Cantera", estado: "Activo", foto: "https://www.realmadrid.com/es-ES/futbol/cantera-masculina/castilla/david-jimenez-corredor" },
            { id: "pf38", nombre: "Naiara", apellido: "Sanmart√≠n", apodo: "Naiara", posicion: "delantero", dorsal: 38, nacionalidad: "Espa√±a", fechaNacimiento: "2006-01-23", categoria: "Cantera", estado: "Activo", foto: "https://assets.realmadrid.com/is/image/realmadrid/NAIARA_SAN_MARTIN_JT11237_550x650?$Desktop$&fit=wrap&wid=420" }
        ];
        // Coordenadas para la Pizarra T√°ctica (top%, left%)
        // El portero siempre es el √≠ndice 0.
        // Coordenadas Horizontal: Portero a la Izquierda (Left ~5%)
        const FORMACIONES = {
            '4-4-2': [
                { left: 5, top: 50 }, // PT
                { left: 25, top: 15 }, { left: 25, top: 38 }, { left: 25, top: 62 }, { left: 25, top: 85 }, // Defensas
                { left: 50, top: 15 }, { left: 50, top: 38 }, { left: 50, top: 62 }, { left: 50, top: 85 }, // Medios
                { left: 80, top: 35 }, { left: 80, top: 65 }  // Delanteros
            ],
            '4-3-3': [
                { left: 5, top: 50 }, // PT
                { left: 25, top: 10 }, { left: 25, top: 35 }, { left: 25, top: 65 }, { left: 25, top: 90 }, // Defensas
                { left: 45, top: 50 }, { left: 60, top: 25 }, { left: 60, top: 75 }, // Medios (Pivote + 2 Interiores)
                { left: 85, top: 15 }, { left: 85, top: 50 }, { left: 85, top: 85 }  // Delanteros
            ],
            '4-2-3-1': [
                { left: 5, top: 50 }, // PT
                { left: 22, top: 10 }, { left: 22, top: 35 }, { left: 22, top: 65 }, { left: 22, top: 90 }, // Defensas
                { left: 42, top: 35 }, { left: 42, top: 65 }, // Doble Pivote
                { left: 65, top: 15 }, { left: 65, top: 50 }, { left: 65, top: 85 }, // Mediapuntas
                { left: 85, top: 50 }  // Punta
            ],
            '3-5-2': [
                { left: 5, top: 50 }, // PT
                { left: 22, top: 30 }, { left: 22, top: 50 }, { left: 22, top: 70 }, // 3 Centrales
                { left: 45, top: 10 }, { left: 45, top: 90 }, // Carrileros
                { left: 45, top: 50 }, { left: 60, top: 35 }, { left: 60, top: 65 }, // Medios
                { left: 80, top: 35 }, { left: 80, top: 65 }  // Delanteros
            ]
        };
        const COMPETICIONES_MASCULINO = {
            'Liga EA Sports': {
                id: 'liga',
                nombre: 'Liga EA Sports',
                color: 'comp-liga',
                borderColor: 'border-comp-liga',
                tipo: 'liga',
                ordenLibre: true,
                fases: [{ tipo: 'liga', rondas: Array.from({length: 38}, (_, i) => ({ id: `jornada-${i+1}`, nombre: `Jornada ${i+1}`, orden: i+1 })) }]
            },
            'Mundial de Clubes': {
                id: 'mundial',
                nombre: 'Mundial de Clubes',
                color: 'comp-mundial',
                borderColor: 'border-comp-mundial',
                tipo: 'copa',
                campoNeutral: true,
                fases: [
                    { tipo: 'grupos', nombre: 'Fase de Grupos', rondas: [
                        { id: 'grupos-1', nombre: 'Fase de Grupos - Jornada 1', orden: 1 },
                        { id: 'grupos-2', nombre: 'Fase de Grupos - Jornada 2', orden: 2 },
                        { id: 'grupos-3', nombre: 'Fase de Grupos - Jornada 3', orden: 3 }
                    ]},
                    { tipo: 'eliminatoria', nombre: 'Eliminatorias', rondas: [
                        { id: 'octavos', nombre: 'Octavos de Final', orden: 4, eliminatoria: true, partidoUnico: true },
                        { id: 'cuartos', nombre: 'Cuartos de Final', orden: 5, eliminatoria: true, partidoUnico: true },
                        { id: 'semifinal', nombre: 'Semifinal', orden: 6, eliminatoria: true, partidoUnico: true },
                        { id: 'final', nombre: 'Final', orden: 7, eliminatoria: true, partidoUnico: true }
                    ]}
                ]
            },
            'Champions League': {
                id: 'champions',
                nombre: 'Champions League',
                color: 'comp-champions',
                borderColor: 'border-comp-champions',
                tipo: 'copa',
                fases: [
                    { tipo: 'liga', nombre: 'Fase de Liga', ordenLibre: true, rondas: Array.from({length: 8}, (_, i) => ({ id: `fase-liga-${i+1}`, nombre: `Fase de Liga - Jornada ${i+1}`, orden: i+1 })) },
                    { tipo: 'eliminatoria', nombre: 'Eliminatorias', rondas: [
                        { id: 'dieciseisavos-ida', nombre: 'Play-offs - Ida', orden: 8.1, eliminatoria: true, idaVuelta: 'ida', pareja: 'dieciseisavos-vuelta', rondaExtra: true },
                        { id: 'dieciseisavos-vuelta', nombre: 'Play-offs - Vuelta', orden: 8.2, eliminatoria: true, idaVuelta: 'vuelta', pareja: 'dieciseisavos-ida', rondaExtra: true },
                        { id: 'octavos-ida', nombre: 'Octavos de Final - Ida', orden: 9, eliminatoria: true, idaVuelta: 'ida', pareja: 'octavos-vuelta' },
                        { id: 'octavos-vuelta', nombre: 'Octavos de Final - Vuelta', orden: 10, eliminatoria: true, idaVuelta: 'vuelta', pareja: 'octavos-ida' },
                        { id: 'cuartos-ida', nombre: 'Cuartos de Final - Ida', orden: 11, eliminatoria: true, idaVuelta: 'ida', pareja: 'cuartos-vuelta' },
                        { id: 'cuartos-vuelta', nombre: 'Cuartos de Final - Vuelta', orden: 12, eliminatoria: true, idaVuelta: 'vuelta', pareja: 'cuartos-ida' },
                        { id: 'semifinal-ida', nombre: 'Semifinal - Ida', orden: 13, eliminatoria: true, idaVuelta: 'ida', pareja: 'semifinal-vuelta' },
                        { id: 'semifinal-vuelta', nombre: 'Semifinal - Vuelta', orden: 14, eliminatoria: true, idaVuelta: 'vuelta', pareja: 'semifinal-ida' },
                        { id: 'final', nombre: 'Final', orden: 15, eliminatoria: true, partidoUnico: true }
                    ]}
                ]
            },
            'Copa del Rey': {
                id: 'copa',
                nombre: 'Copa del Rey',
                color: 'comp-copa',
                borderColor: 'border-comp-copa',
                tipo: 'copa',
                fases: [
                    { tipo: 'eliminatoria', nombre: 'Eliminatorias', rondas: [
                        { id: 'dieciseisavos', nombre: 'Dieciseisavos de Final', orden: 1, eliminatoria: true, partidoUnico: true },
                        { id: 'octavos', nombre: 'Octavos de Final', orden: 2, eliminatoria: true, partidoUnico: true },
                        { id: 'cuartos', nombre: 'Cuartos de Final', orden: 3, eliminatoria: true, partidoUnico: true },
                        { id: 'semifinal-ida', nombre: 'Semifinal - Ida', orden: 4, eliminatoria: true, idaVuelta: 'ida', pareja: 'semifinal-vuelta' },
                        { id: 'semifinal-vuelta', nombre: 'Semifinal - Vuelta', orden: 5, eliminatoria: true, idaVuelta: 'vuelta', pareja: 'semifinal-ida' },
                        { id: 'final', nombre: 'Final', orden: 6, eliminatoria: true, partidoUnico: true }
                    ]}
                ]
            },
            'Supercopa de Espa√±a': {
                id: 'supercopa',
                nombre: 'Supercopa de Espa√±a',
                color: 'comp-supercopa',
                borderColor: 'border-comp-supercopa',
                tipo: 'copa',
                fases: [
                    { tipo: 'eliminatoria', nombre: 'Eliminatorias', rondas: [
                        { id: 'semifinal', nombre: 'Semifinal', orden: 1, eliminatoria: true, partidoUnico: true },
                        { id: 'final', nombre: 'Final', orden: 2, eliminatoria: true, partidoUnico: true }
                    ]}
                ]
            }
        };

        const COMPETICIONES_FEMENINO = {
             'Liga F': {
                id: 'liga-f',
                nombre: 'Liga F',
                color: 'comp-liga',
                borderColor: 'border-comp-liga',
                tipo: 'liga',
                ordenLibre: true,
                fases: [{ tipo: 'liga', rondas: Array.from({length: 30}, (_, i) => ({ id: `jornada-${i+1}`, nombre: `Jornada ${i+1}`, orden: i+1 })) }]
            },
            'UWCL': {
                id: 'uwcl',
                nombre: 'UWCL',
                color: 'comp-champions',
                borderColor: 'border-comp-champions',
                tipo: 'copa',
                fases: [
                    // 1. Fase Previa (2 partidos) - Orden 1 y 2
                    { tipo: 'eliminatoria', nombre: 'Fase Previa', rondas: [
                        { id: 'fase-previa-ida', nombre: 'Fase Previa - Ida', orden: 1, eliminatoria: true, idaVuelta: 'ida', pareja: 'fase-previa-vuelta' },
                        { id: 'fase-previa-vuelta', nombre: 'Fase Previa - Vuelta', orden: 2, eliminatoria: true, idaVuelta: 'vuelta', pareja: 'fase-previa-ida' }
                    ]},
                    // 2. Fase de Grupos (6 partidos) - Orden del 3 al 8
                    // AQU√ç EST√Å EL CAMBIO CLAVE: length: 6
                    { tipo: 'grupos', nombre: 'Fase de Grupos', rondas: Array.from({length: 6}, (_, i) => ({ id: `grupos-${i+1}`, nombre: `Fase Grupos - J${i+1}`, orden: i+3 })) },
                    
                    // 3. Eliminatorias
                    { tipo: 'eliminatoria', nombre: 'Eliminatorias', rondas: [
                        // Ronda Extra (Play-offs) - Orden 8.1 y 8.2 (Justo despu√©s de la jornada 6 que tiene orden 8)
                        { id: 'octavos-ida', nombre: 'Octavos de Final - Ida', orden: 8.1, eliminatoria: true, idaVuelta: 'ida', pareja: 'octavos-vuelta', rondaExtra: true },
                        { id: 'octavos-vuelta', nombre: 'Octavos de Final - Vuelta', orden: 8.2, eliminatoria: true, idaVuelta: 'vuelta', pareja: 'octavos-ida', rondaExtra: true },
                        
                        // Resto de fases
                        { id: 'cuartos-ida', nombre: 'Cuartos de Final - Ida', orden: 9, eliminatoria: true, idaVuelta: 'ida', pareja: 'cuartos-vuelta' },
                        { id: 'cuartos-vuelta', nombre: 'Cuartos de Final - Vuelta', orden: 10, eliminatoria: true, idaVuelta: 'vuelta', pareja: 'cuartos-ida' },
                        { id: 'semifinal-ida', nombre: 'Semifinal - Ida', orden: 11, eliminatoria: true, idaVuelta: 'ida', pareja: 'semifinal-vuelta' },
                        { id: 'semifinal-vuelta', nombre: 'Semifinal - Vuelta', orden: 12, eliminatoria: true, idaVuelta: 'vuelta', pareja: 'semifinal-ida' },
                        { id: 'final', nombre: 'Final', orden: 13, eliminatoria: true, partidoUnico: true }
                    ]}
                ]
            },
             'Copa de la Reina': {
                id: 'copa-reina',
                nombre: 'Copa de la Reina',
                color: 'comp-copa',
                borderColor: 'border-comp-copa',
                tipo: 'copa',
                fases: [
                    { tipo: 'eliminatoria', nombre: 'Eliminatorias', rondas: [
                        { id: 'octavos', nombre: 'Octavos de Final', orden: 1, eliminatoria: true, partidoUnico: true },
                        { id: 'cuartos', nombre: 'Cuartos de Final', orden: 2, eliminatoria: true, partidoUnico: true },
                        { id: 'semifinal-ida', nombre: 'Semifinal - Ida', orden: 3, eliminatoria: true, idaVuelta: 'ida', pareja: 'semifinal-vuelta' },
                        { id: 'semifinal-vuelta', nombre: 'Semifinal - Vuelta', orden: 4, eliminatoria: true, idaVuelta: 'vuelta', pareja: 'semifinal-ida' },
                        { id: 'final', nombre: 'Final', orden: 5, eliminatoria: true, partidoUnico: true }
                    ]}
                ]
            },
            'Supercopa Femenina': {
                id: 'supercopa-fem',
                nombre: 'Supercopa Femenina',
                color: 'comp-supercopa',
                borderColor: 'border-comp-supercopa',
                tipo: 'copa',
                fases: [
                    { tipo: 'eliminatoria', nombre: 'Eliminatorias', rondas: [
                        { id: 'semifinal', nombre: 'Semifinal', orden: 1, eliminatoria: true, partidoUnico: true },
                        { id: 'final', nombre: 'Final', orden: 2, eliminatoria: true, partidoUnico: true }
                    ]}
                ]
            }
        };

        const TEAMS_CONFIG = {
            masculino: {
                icalUrl: 'https://publish.realmadrid.com/content/sling/app-servlets/realmadrid/ical.3kq9cckrnlogidldtdie2fkbl.es-es.ics',
                plantilla: PLANTILLA_MASCULINO,
                competiciones: COMPETICIONES_MASCULINO,
                title: 'Real Madrid Masculino',
                manualJuneMatches: true
            },
            femenino: {
                icalUrl: 'https://publish.realmadrid.com/content/sling/app-servlets/realmadrid/ical.vaikl8nl7hdr4y9jj4jyb9ey.es-es.ics',
                plantilla: PLANTILLA_FEMENINO,
                competiciones: COMPETICIONES_FEMENINO,
                title: 'Real Madrid Femenino',
                manualJuneMatches: false
            }
        };

        // Variables globales
        let calendarEvents = [];
        let currentPlayerFilter = 'all';
        let currentPositionFilter = '';
        let currentCalendarFilter = '';
        let currentTimeFilter = 'all';
        let hideRegisteredMatches = false;
        let selectedCalendarFixture = null;
        let calendarViewMode = 'month'; // 'list' or 'month' - Default to month
        let currentCalendarDate = new Date(); // Tracks the month shown in calendar view
        
        // Sorting State
        let currentSortColumn = 'matchesPlayed';
        let currentSortOrder = 'desc'; // 'asc' or 'desc'

        // ==========================================
        // TEAM SELECTION & INIT
        // ==========================================

        function selectTeam(team) {
            currentTeam = team;
            // IMPORTANT: Clear calendar events to avoid mixing teams
            calendarEvents = [];
            
            const config = TEAMS_CONFIG[team];
            PLANTILLA_ACTUAL = config.plantilla;
            COMPETICIONES_ACTUALES = config.competiciones;

            document.getElementById('header-subtitle').textContent = config.title;
            document.getElementById('section-welcome').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');

            currentPlayerFilter = 'all';
            currentPositionFilter = '';
            
            // RESET FILTERS
            currentTimeFilter = 'all';
            currentCalendarFilter = '';
            hideRegisteredMatches = false;
            document.getElementById('hide-registered-matches').checked = false;
            calendarViewMode = 'month'; // Ensure default is month
            currentCalendarDate = new Date();
            
            renderPlayers();
            populateComparatorSelects();
            populateCompetitionSelect();
            populateH2HOpponents();
            showTab('principal');

            // Force load calendar immediately after setup
            loadCalendar();
        }

        function returnToWelcome() {
            document.getElementById('app-container').classList.add('hidden');
            document.getElementById('section-welcome').classList.remove('hidden');
            currentTeam = null;
            PLANTILLA_ACTUAL = [];
            COMPETICIONES_ACTUALES = {};
            calendarEvents = [];
        }

        // ==========================================
        // DATA MANAGEMENT (TEAM SCOPED)
        // ==========================================
        
        function getData(key) {
            if (!currentTeam) return [];
            const scopedKey = `${currentTeam}_${key}`;
            const data = localStorage.getItem(scopedKey);
            return data ? JSON.parse(data) : [];
        }

        function saveData(key, data) {
            if (!currentTeam) return;
            const scopedKey = `${currentTeam}_${key}`;
            localStorage.setItem(scopedKey, JSON.stringify(data));
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function getPlayers() {
            if (!currentTeam) return [];
            const customStates = getData('playerStates');
            return PLANTILLA_ACTUAL.map(p => {
                const customState = customStates.find(cs => cs.id === p.id);
                return customState ? { ...p, estado: customState.estado } : p;
            });
        }

        function getActivePlayers() {
            return getPlayers().filter(p => p.estado === 'Activo');
        }

        function updatePlayerState(playerId, newState) {
            let customStates = getData('playerStates');
            const existingIndex = customStates.findIndex(cs => cs.id === playerId);
            if (existingIndex !== -1) {
                customStates[existingIndex].estado = newState;
            } else {
                customStates.push({ id: playerId, estado: newState });
            }
            saveData('playerStates', customStates);
        }

        // ==========================================
        // COMPETITION STATE MANAGEMENT
        // ==========================================
        
        function getCompetitionState() {
            return getData('competitionState') || {};
        }

        function saveCompetitionState(state) {
            saveData('competitionState', state);
        }

        function getAvailableRounds(compName) {
            const comp = COMPETICIONES_ACTUALES[compName];
            if (!comp) return [];
            
            const matches = getData('matches').filter(m => m.competition === compName);
            const state = getCompetitionState();
            const extraRoundState = state[compName]?.playsExtra; // true, false o undefined
            
            // 1. Aplanar todas las rondas
            let allRounds = [];
            comp.fases.forEach(fase => {
                fase.rondas.forEach(ronda => {
                    allRounds.push({ ...ronda, faseTipo: fase.tipo, faseNombre: fase.nombre, faseOrdenLibre: fase.ordenLibre });
                });
            });

            // 2. Filtrar rondas seg√∫n la decisi√≥n del usuario
            // Si playsExtra es FALSE, quitamos las rondas extra.
            // Si es TRUE o undefined (a√∫n no decidido), las dejamos para que la l√≥gica las maneje.
            if (extraRoundState === false) {
                allRounds = allRounds.filter(r => !r.rondaExtra);
            }

            // 3. Ordenar correctamente (necesario por los decimales)
            allRounds.sort((a, b) => a.orden - b.orden);
            
            const completedRoundIds = matches.map(m => m.roundId);
            const result = [];
            const isLeagueFormat = comp.ordenLibre || comp.tipo === 'liga';
            
            for (let i = 0; i < allRounds.length; i++) {
                const ronda = allRounds[i];
                const isCompleted = completedRoundIds.includes(ronda.id);
                let isAvailable = false;
                
                if (ronda.faseTipo === 'liga' || ronda.faseOrdenLibre || isLeagueFormat) {
                    isAvailable = !isCompleted;
                } else {
                    // L√≥gica din√°mica: Miramos la ronda ANTERIOR en la lista filtrada
                    // Esto conecta autom√°ticamente la Liga con Octavos si quitamos los Dieciseisavos
                    if (i === 0) {
                        isAvailable = !isCompleted; // Si es la primera, est√° disponible
                    } else {
                        const prevRound = allRounds[i - 1];
                        const isPrevCompleted = completedRoundIds.includes(prevRound.id) || prevRound.faseTipo === 'liga' || prevRound.faseOrdenLibre;
                        isAvailable = !isCompleted && isPrevCompleted;
                    }
                }
                
                // Bloqueo por eliminaci√≥n
                if (state[compName]?.eliminatedAt) {
                    const eliminatedRound = allRounds.find(r => r.id === state[compName].eliminatedAt);
                    // Usamos el √≠ndice para comparar orden relativo en la lista filtrada
                    if (eliminatedRound && allRounds.indexOf(eliminatedRound) < i) {
                        isAvailable = false;
                    }
                }
                
                result.push({
                    ...ronda,
                    status: isCompleted ? 'completed' : (isAvailable ? 'available' : 'locked')
                });
            }
            return result;
        }

        function checkEliminationAfterMatch(match) {
            const comp = COMPETICIONES_ACTUALES[match.competition];
            if (!comp) return;
            
            let roundInfo = null;
            comp.fases.forEach(fase => {
                const found = fase.rondas.find(r => r.id === match.roundId);
                if (found) roundInfo = { ...found, faseTipo: fase.tipo };
            });
            
            if (!roundInfo || !roundInfo.eliminatoria) return;
            if (roundInfo.faseTipo === 'liga') return;
            
            let isEliminated = false;

            if (match.forceElimination) {
                isEliminated = true;
            }
            if (roundInfo.partidoUnico) {
                isEliminated = match.outcome === 'derrota';
            } 
            else if (roundInfo.idaVuelta === 'vuelta') {
                const matches = getData('matches').filter(m => m.competition === match.competition);
                const idaMatch = matches.find(m => m.roundId === roundInfo.pareja);
                
                if (idaMatch) {
                    const globalResult = calculateGlobalResult(idaMatch, match);
                    isEliminated = globalResult.outcome === 'derrota';
                }
            }
            
            if (isEliminated) {
                const state = getCompetitionState();
                state[match.competition] = { eliminated: true, eliminatedAt: match.roundId };
                saveCompetitionState(state);
            }
        }

        function calculateGlobalResult(idaMatch, vueltaMatch) {
            const getGoals = (m) => {
                const parts = m.result.replace('*','').split('-').map(Number);
                if (m.venue === 'local') return { us: parts[0], them: parts[1] };
                if (m.venue === 'visitante') return { us: parts[1], them: parts[0] };
                return { us: parts[0], them: parts[1] }; 
            };

            const ida = getGoals(idaMatch);
            const vuelta = getGoals(vueltaMatch);

            const totalUs = ida.us + vuelta.us;
            const totalThem = ida.them + vuelta.them;

            let outcome;
            if (totalUs > totalThem) outcome = 'victoria';
            else if (totalUs < totalThem) outcome = 'derrota';
            else {
                const awayGoalsUs = (idaMatch.venue === 'visitante' ? ida.us : 0) + (vueltaMatch.venue === 'visitante' ? vuelta.us : 0);
                const awayGoalsThem = (idaMatch.venue === 'local' ? ida.them : 0) + (vueltaMatch.venue === 'local' ? vuelta.them : 0);

                if (awayGoalsUs > awayGoalsThem) outcome = 'victoria';
                else if (awayGoalsUs < awayGoalsThem) outcome = 'derrota';
                else outcome = 'empate'; 
            }
            
            return { totalFavor: totalUs, totalContra: totalThem, outcome };
        }
        
       function recalculateCompetitionState(compName) {
            console.log(`Recalculando estado para: ${compName}`);
            
            // 1. Obtener estado actual y limpiar la competici√≥n espec√≠fica
            let state = getCompetitionState();
            if (state[compName]) {
                delete state[compName];
            }
            saveCompetitionState(state); // Guardamos limpio primero
            
            // 2. Obtener todos los partidos de esa competici√≥n ordenados por fecha
            const matches = getData('matches')
                .filter(m => m.competition === compName)
                .sort((a, b) => new Date(a.date) - new Date(b.date));
                
            // 3. Re-evaluar cada partido uno a uno
            matches.forEach(match => {
                checkEliminationAfterMatch(match);
            });
            
            // 4. Verificar en consola
            const newState = getCompetitionState();
            console.log("Nuevo estado:", newState[compName]);
        }

        // ==========================================
        // STATISTICS
        // ==========================================

        function switchStatsTab(tab) {
            document.querySelectorAll('.stats-subtab').forEach(el => {
                el.classList.remove('active');
                el.classList.add('inactive');
            });
            document.getElementById(`btn-stats-${tab}`).classList.add('active');
            document.getElementById(`btn-stats-${tab}`).classList.remove('inactive');

            document.getElementById('stats-general').classList.add('hidden');
            document.getElementById('stats-advanced').classList.add('hidden');
            document.getElementById('stats-h2h').classList.add('hidden');

            document.getElementById(`stats-${tab}`).classList.remove('hidden');

            if (tab === 'advanced') {
                renderAdvancedStats();
            } else if (tab === 'h2h') {
                populateH2HOpponents();
            }
        }

        function handleSort(column) {
            if (currentSortColumn === column) {
                currentSortOrder = currentSortOrder === 'desc' ? 'asc' : 'desc';
            } else {
                currentSortColumn = column;
                currentSortOrder = 'desc'; // Default to desc for new columns (usually higher is better)
            }
            renderStats();
        }

        function renderStats() {
            const matches = getData('matches');
            const players = getPlayers();
            
            const competitionFilter = document.getElementById('stats-filter-competition').value;
            const statusFilter = document.getElementById('stats-filter-status').value;
            
            // Actualizar visuales de las cabeceras (flechitas de orden)
            document.querySelectorAll('th.sortable').forEach(th => {
                th.classList.remove('th-active');
                th.innerHTML = th.innerText.replace(' ‚ñ≤', '').replace(' ‚ñº', '');
            });
            const activeTh = document.getElementById(`th-${currentSortColumn}`);
            if (activeTh) {
                activeTh.classList.add('th-active');
                activeTh.innerHTML += currentSortOrder === 'asc' ? ' ‚ñ≤' : ' ‚ñº';
            }

            let filteredMatches = matches;
            if (competitionFilter) {
                filteredMatches = filteredMatches.filter(m => m.competition === competitionFilter);
            }

            // L√≥gica de Rachas (√öltimos 5 partidos)
            const streakContainer = document.getElementById('team-streak');
            const last5Matches = [...matches].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5);
            
            if (last5Matches.length > 0 && streakContainer) {
                streakContainer.innerHTML = last5Matches.map(m => {
                    let outcomeClass = 'streak-d';
                    let letter = 'E';
                    if (m.outcome === 'victoria') { outcomeClass = 'streak-w'; letter = 'V'; }
                    else if (m.outcome === 'derrota') { outcomeClass = 'streak-l'; letter = 'D'; }
                    return `<span class="streak-dot ${outcomeClass}" title="${m.opponent} (${m.result})">${letter}</span>`;
                }).join('');
            } else if (streakContainer) {
                streakContainer.innerHTML = '<span class="text-gray-500 text-sm">Sin partidos jugados</span>';
            }

            // C√°lculo de Estad√≠sticas Globales
            let totalWins = 0, totalDraws = 0, totalLosses = 0;
            let totalGoalsFor = 0, totalGoalsAgainst = 0;
            let totalAssists = 0;
            
            filteredMatches.forEach(m => {
                if (m.outcome === 'victoria') totalWins++;
                else if (m.outcome === 'empate') totalDraws++;
                else if (m.outcome === 'derrota') totalLosses++;

                if (m.result && m.result.includes('-')) {
                    const parts = m.result.replace('*','').split('-').map(Number);
                    if (m.venue === 'local') {
                        totalGoalsFor += parts[0];
                        totalGoalsAgainst += parts[1];
                    } else if (m.venue === 'visitante') {
                        totalGoalsFor += parts[1];
                        totalGoalsAgainst += parts[0];
                    } else { // Neutral
                         totalGoalsFor += parts[0]; 
                         totalGoalsAgainst += parts[1];
                    }
                }
            });
            
            if(document.getElementById('stat-total-matches')) document.getElementById('stat-total-matches').textContent = filteredMatches.length;
            if(document.getElementById('stat-wins')) document.getElementById('stat-wins').textContent = totalWins;
            if(document.getElementById('stat-draws')) document.getElementById('stat-draws').textContent = totalDraws;
            if(document.getElementById('stat-losses')) document.getElementById('stat-losses').textContent = totalLosses;
            if(document.getElementById('stat-total-goals')) document.getElementById('stat-total-goals').textContent = totalGoalsFor;
            if(document.getElementById('stat-total-goals-against')) document.getElementById('stat-total-goals-against').textContent = totalGoalsAgainst;

            let filteredPlayers = [...players];
            if (statusFilter) {
                filteredPlayers = filteredPlayers.filter(p => p.estado === statusFilter);
            }
            
            // Excluir entrenador del conteo total
            const playerOnlyCount = filteredPlayers.filter(p => p.posicion !== 'entrenador').length;
            if(document.getElementById('stat-total-players')) document.getElementById('stat-total-players').textContent = playerOnlyCount;

            const playerStats = filteredPlayers.map(player => {
                const stats = {
                    id: player.id,
                    name: player.apodo || `${player.nombre} ${player.apellido}`,
                    number: player.dorsal,
                    foto: player.foto,
                    posicion: player.posicion,
                    estado: player.estado,
                    matchesPlayed: 0,
                    totalRating: 0,
                    ratingCount: 0,
                    goals: 0,
                    assists: 0,
                    ga: 0,
                    minutes: 0,
                    mvpCount: 0,
                    wins: 0,
                    draws: 0,
                    losses: 0,
                    yellowCards: 0,
                    redCards: 0,
                    last5Ratings: [] 
                };
                
                // Ordenar partidos para procesar cronol√≥gicamente
                const playerMatchesSorted = filteredMatches.sort((a, b) => new Date(b.date) - new Date(a.date));

                playerMatchesSorted.forEach(match => {
                    const ps = match.playerStats?.find(s => String(s.playerId) === String(player.id));
                    
                    if (ps) {
                        stats.matchesPlayed++;
                        stats.goals += (ps.goals || 0);
                        stats.assists += (ps.assists || 0);
                        stats.minutes += (ps.minutes || 0);
                        stats.yellowCards += (ps.yellowCards || 0);
                        stats.redCards += (ps.redCards || 0);
                        
                        if (ps.rating !== null && ps.rating !== "" && ps.rating !== undefined) {
                            const r = parseFloat(ps.rating);
                            stats.totalRating += r;
                            stats.ratingCount++;
                            stats.last5Ratings.push(r);
                        }
                        
                        if (match.outcome === 'victoria') stats.wins++;
                        else if (match.outcome === 'empate') stats.draws++;
                        else if (match.outcome === 'derrota') stats.losses++;
                    }
                    if (String(match.mvp) === String(player.id)) {
                        stats.mvpCount++;
                    }
                });
                
                stats.avgRating = stats.ratingCount > 0 ? (stats.totalRating / stats.ratingCount).toFixed(2) : '-';
                stats.ga = stats.goals + stats.assists;

                totalAssists += stats.assists;
                return stats;
            });
            
            if(document.getElementById('stat-total-assists')) document.getElementById('stat-total-assists').textContent = totalAssists;

            // Top Form Players Logic
            const formContainer = document.getElementById('top-form-players');
            if (formContainer) {
                const playersWithRecentGames = playerStats
                    .filter(p => p.last5Ratings.length > 0 && p.posicion !== 'entrenador')
                    .map(p => {
                        const recent = p.last5Ratings.slice(0, 5);
                        const avg = recent.reduce((a, b) => a + b, 0) / recent.length;
                        return { ...p, recentAvg: avg };
                    })
                    .sort((a, b) => b.recentAvg - a.recentAvg)
                    .slice(0, 3);

                if (playersWithRecentGames.length > 0) {
                    formContainer.innerHTML = playersWithRecentGames.map((p, i) => `
                        <div class="flex items-center justify-between">
                            <div class="flex items-center gap-2">
                                <span class="font-bold text-gray-400 w-4">${i+1}.</span>
                                <img src="${p.foto}" class="top-form-img">
                                <span class="text-sm font-medium">${p.name}</span>
                            </div>
                            <span class="text-sm font-bold text-green-600">${p.recentAvg.toFixed(2)}</span>
                        </div>
                    `).join('');
                } else {
                    formContainer.innerHTML = '<span class="text-gray-500 text-sm">Sin datos suficientes</span>';
                }
            }


            playerStats.sort((a, b) => {
                if (a.estado === 'Inactivo' && b.estado !== 'Inactivo') return 1;
                if (a.estado !== 'Inactivo' && b.estado === 'Inactivo') return -1;

                let valA = a[currentSortColumn];
                let valB = b[currentSortColumn];
                
                if (currentSortColumn === 'avgRating') {
                    valA = valA === '-' ? -1 : parseFloat(valA);
                    valB = valB === '-' ? -1 : parseFloat(valB);
                }
                
                if(currentSortColumn === 'number' && valA === 'DT') valA = -1;
                if(currentSortColumn === 'number' && valB === 'DT') valB = -1;

                return currentSortOrder === 'asc' ? valA - valB : valB - valA;
            });

            const tableBody = document.getElementById('stats-table-body');
            const noStats = document.getElementById('no-stats');
            
            if (playerStats.length === 0) {
                tableBody.innerHTML = '';
                noStats.classList.remove('hidden');
                return;
            }
            
            noStats.classList.add('hidden');
            tableBody.innerHTML = playerStats.map(stats => {
                const isCoach = stats.number === 'DT' || stats.posicion === 'entrenador';
                
                return `
                <tr class="border-t hover:bg-gray-50 cursor-pointer ${stats.estado === 'Inactivo' ? 'opacity-60 bg-gray-50' : ''}" onclick="viewPlayerDetails('${stats.id}')">
                    <td class="px-4 py-3">
                        <div class="flex items-center gap-3">
                            <img src="${stats.foto}" class="player-photo-small" onerror="this.src='https://via.placeholder.com/40x40?text=${stats.number}'">
                            <div>
                                <span class="font-medium text-gray-800">${stats.name}</span>
                                <span class="text-gray-500 text-sm ml-1">${stats.number === 'DT' ? 'DT' : '#' + stats.number}</span>
                                ${stats.estado === 'Inactivo' ? '<span class="text-xs text-red-500 font-bold ml-1">(Inactivo)</span>' : ''}
                            </div>
                        </div>
                    </td>
                    <td class="px-4 py-3 text-center font-medium">${stats.matchesPlayed}</td>
                    <td class="px-4 py-3 text-center font-semibold ${getRatingColor(stats.avgRating)}">${stats.avgRating}</td>
                    <td class="px-4 py-3 text-center font-medium text-emerald-600">${isCoach ? '-' : stats.goals}</td>
                    <td class="px-4 py-3 text-center">${isCoach ? '-' : stats.assists}</td>
                    <td class="px-4 py-3 text-center font-bold">${isCoach ? '-' : stats.ga}</td>
                    <td class="px-4 py-3 text-center text-gray-600">${isCoach ? '-' : stats.minutes + "'"}</td>
                    <td class="px-4 py-3 text-center">
                        ${stats.mvpCount > 0 ? `<span class="bg-amber-100 text-amber-700 px-2 py-0.5 rounded-full text-sm font-medium">${stats.mvpCount}</span>` : '-'}
                    </td>
                    <td class="px-4 py-3 text-center text-green-600 font-medium">${stats.wins}</td>
                    <td class="px-4 py-3 text-center text-amber-600">${stats.draws}</td>
                    <td class="px-4 py-3 text-center text-red-600">${stats.losses}</td>
                    <td class="px-4 py-3 text-center">${stats.yellowCards > 0 ? stats.yellowCards : '-'}</td>
                    <td class="px-4 py-3 text-center">${stats.redCards > 0 ? `<span class="text-red-600 font-medium">${stats.redCards}</span>` : '-'}</td>
                </tr>
            `}).join('');
            renderCharts(filteredMatches);
        }
        // ==========================================
        // GR√ÅFICOS INTERACTIVOS (CHART.JS)
        // ==========================================

        let goalsChart = null;
        let evolutionChart = null;

        function renderCharts(filteredMatches) {
            const players = getPlayers();
            
            // --- 1. DATOS PARA GR√ÅFICO DE GOLES (DONUT) ---
            // Definimos solo las 3 grandes categor√≠as
            const goalsByPos = { 'delantero': 0, 'centrocampista': 0, 'defensa': 0 };
            
            filteredMatches.forEach(m => {
                m.playerStats.forEach(ps => {
                    const p = players.find(pl => pl.id === ps.playerId);
                    if (p && ps.goals > 0) {
                        let pos = p.posicion;
                        
                        // FUSI√ìN CLAVE: Si es extremo, lo contamos como delantero para este gr√°fico
                        if (pos === 'extremo') pos = 'delantero';
                        
                        // Solo sumamos si entra en una de las 3 categor√≠as principales (ignoramos porteros si marcaran)
                        if (goalsByPos[pos] !== undefined) {
                            goalsByPos[pos] += ps.goals;
                        }
                    }
                });
            });

            const ctxGoals = document.getElementById('chart-goals-distribution').getContext('2d');
            
            if (goalsChart) goalsChart.destroy();

            goalsChart = new Chart(ctxGoals, {
                type: 'doughnut',
                data: {
                    labels: ['Delanteros (+Ext)', 'Medios', 'Defensas'],
                    datasets: [{
                        data: [goalsByPos['delantero'], goalsByPos['centrocampista'], goalsByPos['defensa']],
                        backgroundColor: ['#ef4444', '#10b981', '#3b82f6'],
                        hoverOffset: 4,
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'bottom', labels: { font: { size: 11 } } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const value = context.raw;
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    const percentage = total > 0 ? Math.round((value / total) * 100) + '%' : '0%';
                                    return ` ${value} Goles (${percentage})`;
                                }
                            }
                        }
                    }
                }
            });

            // --- 2. DATOS PARA EVOLUCI√ìN (L√çNEA) ---
            const sortedMatches = [...filteredMatches].sort((a, b) => new Date(a.date) - new Date(b.date));
            
            const labels = sortedMatches.map(m => {
                const shortRound = m.round.replace('Jornada', 'J').replace('Fase de Liga - ', '').replace('Fase de Grupos - ', 'G');
                return `${shortRound} vs ${m.opponent}`;
            });

            const ratings = sortedMatches.map(m => {
                let total = 0, count = 0;
                m.playerStats.forEach(ps => {
                    if (ps.rating) {
                        total += parseFloat(ps.rating);
                        count++;
                    }
                });
                return count > 0 ? (total / count).toFixed(2) : null;
            });

            const ctxEvo = document.getElementById('chart-season-evolution').getContext('2d');
            
            if (evolutionChart) evolutionChart.destroy();

            evolutionChart = new Chart(ctxEvo, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Nota Media',
                        data: ratings,
                        borderColor: '#f59e0b',
                        backgroundColor: (context) => {
                            const ctx = context.chart.ctx;
                            const gradient = ctx.createLinearGradient(0, 0, 0, 300);
                            gradient.addColorStop(0, 'rgba(245, 158, 11, 0.4)');
                            gradient.addColorStop(1, 'rgba(245, 158, 11, 0.0)');
                            return gradient;
                        },
                        tension: 0.3,
                        fill: true,
                        pointBackgroundColor: '#fff',
                        pointBorderColor: '#f59e0b',
                        pointRadius: 4,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: {
                        mode: 'index',
                        intersect: false,
                    },
                    scales: {
                        y: { min: 0, max: 10, grid: { color: '#f3f4f6' }, border: { display: false } },
                        x: { display: false }
                    },
                    plugins: {
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            titleColor: '#1f2937',
                            bodyColor: '#1f2937',
                            borderColor: '#e5e7eb',
                            borderWidth: 1,
                            callbacks: {
                                title: (context) => context[0].label
                            }
                        },
                        legend: { display: false }
                    }
                }
            });
        }

        // ==========================================
        // ADVANCED STATISTICS
        // ==========================================

        function renderAdvancedStats() {
            const matches = getData('matches');
            const players = getPlayers();

            // 1. Home vs Away
            let homeStats = { wins: 0, draws: 0, losses: 0, gf: 0, ga: 0, count: 0 };
            let awayStats = { wins: 0, draws: 0, losses: 0, gf: 0, ga: 0, count: 0 };

            matches.forEach(m => {
                const parts = m.result.replace('*','').split('-').map(Number);
                const isHome = m.venue === 'local';
                const stats = isHome ? homeStats : awayStats;
                
                // Treat neutral as away for simplicity or ignore? Let's treat as away for now or ignore.
                if (m.venue === 'neutral') return;

                stats.count++;
                if (m.outcome === 'victoria') stats.wins++;
                else if (m.outcome === 'empate') stats.draws++;
                else stats.losses++;

                if (isHome) { stats.gf += parts[0]; stats.ga += parts[1]; }
                else { stats.gf += parts[1]; stats.ga += parts[0]; }
            });

            document.getElementById('home-away-stats-container').innerHTML = `
                <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 shadow-sm">
                    <h4 class="font-bold text-blue-800 mb-2">üè† En Casa</h4>
                    <div class="grid grid-cols-3 gap-2 text-center text-sm">
                        <div><p class="text-gray-500">PJ</p><p class="font-bold">${homeStats.count}</p></div>
                        <div><p class="text-gray-500">V-E-D</p><p class="font-bold">${homeStats.wins}-${homeStats.draws}-${homeStats.losses}</p></div>
                        <div><p class="text-gray-500">GF/GC</p><p class="font-bold">${homeStats.gf}/${homeStats.ga}</p></div>
                    </div>
                </div>
                <div class="bg-purple-50 p-4 rounded-xl border border-purple-100 shadow-sm">
                    <h4 class="font-bold text-purple-800 mb-2">‚úàÔ∏è Fuera de Casa</h4>
                    <div class="grid grid-cols-3 gap-2 text-center text-sm">
                        <div><p class="text-gray-500">PJ</p><p class="font-bold">${awayStats.count}</p></div>
                        <div><p class="text-gray-500">V-E-D</p><p class="font-bold">${awayStats.wins}-${awayStats.draws}-${awayStats.losses}</p></div>
                        <div><p class="text-gray-500">GF/GC</p><p class="font-bold">${awayStats.gf}/${awayStats.ga}</p></div>
                    </div>
                </div>
            `;

            // 2. Heatmap
            const zones = {
                'delantero': { total: 0, count: 0, label: 'Delantera', color: 'bg-red-500' },
                'centrocampista': { total: 0, count: 0, label: 'Medio', color: 'bg-green-500' },
                'defensa': { total: 0, count: 0, label: 'Defensa', color: 'bg-blue-500' },
                'portero': { total: 0, count: 0, label: 'Porter√≠a', color: 'bg-amber-400' }
            };

            matches.forEach(m => {
                m.playerStats.forEach(ps => {
                    const p = players.find(pl => pl.id === ps.playerId);
                    if (p && zones[p.posicion] && ps.rating) {
                        zones[p.posicion].total += parseFloat(ps.rating);
                        zones[p.posicion].count++;
                    }
                });
            });

            const getHeatColor = (avg) => {
                if (avg >= 8) return 'bg-emerald-600';
                if (avg >= 7) return 'bg-emerald-500';
                if (avg >= 6) return 'bg-yellow-500';
                return 'bg-red-500';
            };

            let heatmapHtml = '';
            // Order: Portero at bottom? No, typically pitch: Forward -> Mid -> Def -> GK
            ['delantero', 'centrocampista', 'defensa', 'portero'].forEach(pos => {
                const z = zones[pos];
                const avg = z.count > 0 ? (z.total / z.count).toFixed(2) : '-';
                const colorClass = z.count > 0 ? getHeatColor(parseFloat(avg)) : 'bg-gray-300';
                heatmapHtml += `
                    <div class="heatmap-zone ${colorClass}">
                        <span class="heatmap-val">${avg}</span>
                        <span class="heatmap-label">${z.label}</span>
                    </div>
                `;
            });
            document.getElementById('heatmap-container').innerHTML = heatmapHtml;

            // 3. Monthly Report
            const monthlyData = {};
            matches.forEach(m => {
                const date = new Date(m.date);
                const key = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                if (!monthlyData[key]) monthlyData[key] = { matches: [], wins: 0, draws: 0, losses: 0, gf: 0, ga: 0, totalRating: 0, ratingCount: 0 };
                
                const md = monthlyData[key];
                md.matches.push(m);
                if (m.outcome === 'victoria') md.wins++;
                else if (m.outcome === 'empate') md.draws++;
                else md.losses++;

                const parts = m.result.replace('*','').split('-').map(Number);
                if(m.venue === 'local') { md.gf += parts[0]; md.ga += parts[1]; }
                else if(m.venue === 'visitante') { md.gf += parts[1]; md.ga += parts[0]; }
                else { md.gf += parts[0]; md.ga += parts[1]; }

                m.playerStats.forEach(ps => {
                    if (ps.rating) { md.totalRating += parseFloat(ps.rating); md.ratingCount++; }
                });
            });

            const sortedMonths = Object.keys(monthlyData).sort().reverse();
            document.getElementById('monthly-report-body').innerHTML = sortedMonths.map(key => {
                const d = monthlyData[key];
                const monthName = new Date(key + '-01').toLocaleDateString('es-ES', { month: 'long', year: 'numeric' });
                const avg = d.ratingCount > 0 ? (d.totalRating / d.ratingCount).toFixed(2) : '-';
                return `
                    <tr class="border-t hover:bg-slate-50">
                        <td class="px-4 py-2 capitalize font-medium text-gray-700">${monthName}</td>
                        <td class="px-4 py-2 text-center text-gray-600">${d.matches.length}</td>
                        <td class="px-4 py-2 text-center text-gray-600 font-mono">${d.wins}-${d.draws}-${d.losses}</td>
                        <td class="px-4 py-2 text-center text-gray-600 font-mono">${d.gf} / ${d.ga}</td>
                        <td class="px-4 py-2 text-center font-bold ${getRatingColor(avg)}">${avg}</td>
                    </tr>
                `;
            }).join('');
        }

        // ==========================================
        // H2H STATISTICS
        // ==========================================

        function populateH2HOpponents() {
            const matches = getData('matches');
            const opponents = [...new Set(matches.map(m => m.opponent))].sort();
            const select = document.getElementById('h2h-opponent-select');
            select.innerHTML = '<option value="">Selecciona rival...</option>' + 
                opponents.map(op => `<option value="${op}">${op}</option>`).join('');
        }

        function renderH2H() {
            const opponent = document.getElementById('h2h-opponent-select').value;
            const container = document.getElementById('h2h-content');
            
            if (!opponent) {
                container.classList.add('hidden');
                return;
            }

            const matches = getData('matches').filter(m => m.opponent === opponent);
            const players = getPlayers();

            let wins = 0, draws = 0, losses = 0, gf = 0, ga = 0;
            const playerPerfs = {};

            matches.forEach(m => {
                if (m.outcome === 'victoria') wins++;
                else if (m.outcome === 'empate') draws++;
                else losses++;

                const parts = m.result.replace('*','').split('-').map(Number);
                if (m.venue === 'local') { gf += parts[0]; ga += parts[1]; }
                else if (m.venue === 'visitante') { gf += parts[1]; ga += parts[0]; }
                else { gf += parts[0]; ga += parts[1]; }

                m.playerStats.forEach(ps => {
                    if (!playerPerfs[ps.playerId]) playerPerfs[ps.playerId] = { goals: 0, rating: 0, count: 0, name: '' };
                    const pp = playerPerfs[ps.playerId];
                    pp.goals += ps.goals || 0;
                    if (ps.rating) { pp.rating += parseFloat(ps.rating); pp.count++; }
                });
            });

            // Find top scorer & best rating against this opponent
            let topScorer = { id: null, val: -1 };
            let bestRated = { id: null, val: -1 };

            Object.entries(playerPerfs).forEach(([pid, data]) => {
                if (data.goals > topScorer.val) topScorer = { id: pid, val: data.goals };
                const avg = data.count > 0 ? data.rating / data.count : 0;
                if (avg > bestRated.val && data.count > 0) bestRated = { id: pid, val: avg };
            });

            const scorerP = topScorer.id ? players.find(p => p.id === topScorer.id) : null;
            const ratedP = bestRated.id ? players.find(p => p.id === bestRated.id) : null;

            container.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <div class="bg-slate-800 text-white p-4 rounded-xl text-center shadow-md">
                        <p class="text-slate-400 text-sm">Balance</p>
                        <p class="text-2xl font-bold">${wins}V - ${draws}E - ${losses}D</p>
                        <p class="text-xs text-slate-400 mt-1">${gf} Goles Favor - ${ga} Contra</p>
                    </div>
                    ${scorerP ? `
                    <div class="bg-white border border-gray-200 p-4 rounded-xl flex items-center gap-3 shadow-sm">
                        <img src="${scorerP.foto}" class="w-12 h-12 rounded-full object-cover">
                        <div>
                            <p class="text-xs text-gray-500 uppercase font-bold">Goleador</p>
                            <p class="font-bold text-gray-800">${scorerP.nombre}</p>
                            <p class="text-sm text-green-600 font-bold">${topScorer.val} Goles</p>
                        </div>
                    </div>` : ''}
                    ${ratedP ? `
                    <div class="bg-white border border-gray-200 p-4 rounded-xl flex items-center gap-3 shadow-sm">
                        <img src="${ratedP.foto}" class="w-12 h-12 rounded-full object-cover">
                        <div>
                            <p class="text-xs text-gray-500 uppercase font-bold">Mejor Valoraci√≥n</p>
                            <p class="font-bold text-gray-800">${ratedP.nombre}</p>
                            <p class="text-sm text-blue-600 font-bold">${bestRated.val.toFixed(2)} Nota Media</p>
                        </div>
                    </div>` : ''}
                </div>
                
                <h4 class="font-bold text-gray-800 mt-4">Partidos jugados</h4>
                <div class="space-y-2">
                    ${matches.map(m => `
                        <div class="bg-gray-50 p-3 rounded-lg flex justify-between items-center text-sm border border-gray-100">
                            <span>${formatDate(m.date)} (${m.competition})</span>
                            <span class="font-bold ${getResultClass(m.outcome).replace('bg-', 'text-')}">${m.venue === 'local' ? 'Local' : 'Visitante'}: ${m.result}</span>
                        </div>
                    `).join('')}
                </div>
            `;
            container.classList.remove('hidden');
        }
        
        function exportStats() {
            const matches = getData('matches');
            const players = getPlayers();
            
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "ID,Nombre,Dorsal,Posicion,Estado,Partidos Jugados,Minutos,Goles,Asistencias,G/A,Nota Media,Tarjetas Amarillas,Tarjetas Rojas,MVPs,Victorias,Empates,Derrotas\n";

            players.forEach(player => {
                const stats = { matchesPlayed: 0, minutes: 0, goals: 0, assists: 0, totalRating: 0, ratingCount: 0, yellow: 0, red: 0, mvp: 0, wins: 0, draws: 0, losses: 0 };
                matches.forEach(m => {
                    const ps = m.playerStats?.find(s => String(s.playerId) === String(player.id));
                    if (ps) {
                        stats.matchesPlayed++;
                        stats.minutes += ps.minutes || 0;
                        stats.goals += ps.goals || 0;
                        stats.assists += ps.assists || 0;
                        stats.yellow += ps.yellowCards || 0;
                        stats.red += ps.redCards || 0;
                        // FIX: Ensure 0 is counted
                        if (ps.rating !== null && ps.rating !== "" && ps.rating !== undefined) { stats.totalRating += ps.rating; stats.ratingCount++; }
                        if (m.outcome === 'victoria') stats.wins++;
                        else if (m.outcome === 'empate') stats.draws++;
                        else if (m.outcome === 'derrota') stats.losses++;
                    }
                    if (String(m.mvp) === String(player.id)) stats.mvp++;
                });

                const avgRating = stats.ratingCount > 0 ? (stats.totalRating / stats.ratingCount).toFixed(2) : '0';
                const ga = stats.goals + stats.assists;
                const row = [player.id, `${player.nombre} ${player.apellido}`, player.dorsal, player.posicion, player.estado, stats.matchesPlayed, stats.minutes, stats.goals, stats.assists, ga, avgRating, stats.yellow, stats.red, stats.mvp, stats.wins, stats.draws, stats.losses].join(",");
                csvContent += row + "\n";
            });

            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `real_madrid_${currentTeam}_stats.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // ==========================================
        // COMPARATOR LOGIC
        // ==========================================
        function populateComparatorSelects() {
            const players = getActivePlayers().sort((a,b) => {
                if (a.posicion === 'entrenador') return -1;
                if (b.posicion === 'entrenador') return 1;
                return a.dorsal - b.dorsal;
            });
            const options = '<option value="">Seleccionar jugador...</option>' + 
                players.map(p => `<option value="${p.id}">${p.nombre} ${p.apellido} (#${p.dorsal})</option>`).join('');
            
            document.getElementById('compare-p1').innerHTML = options;
            document.getElementById('compare-p2').innerHTML = options;
        }

        function getPlayerStatsForComparator(playerId) {
            const matches = getData('matches');
            const stats = {
                matchesPlayed: 0, goals: 0, assists: 0, minutes: 0, ga: 0, 
                totalRating: 0, ratingCount: 0, avgRating: 0,
                yellowCards: 0, redCards: 0, mvpCount: 0
            };

            matches.forEach(m => {
                const ps = m.playerStats?.find(s => String(s.playerId) === String(playerId));
                if (ps) {
                    stats.matchesPlayed++;
                    stats.goals += (ps.goals || 0);
                    stats.assists += (ps.assists || 0);
                    stats.minutes += (ps.minutes || 0);
                    stats.yellowCards += (ps.yellowCards || 0);
                    stats.redCards += (ps.redCards || 0);
                    if (ps.rating !== null && ps.rating !== "" && ps.rating !== undefined) {
                        stats.totalRating += parseFloat(ps.rating);
                        stats.ratingCount++;
                    }
                }
                if (String(m.mvp) === String(playerId)) stats.mvpCount++;
            });
            
            stats.avgRating = stats.ratingCount > 0 ? (stats.totalRating / stats.ratingCount).toFixed(2) : 0;
            stats.ga = stats.goals + stats.assists;
            return stats;
        }

        function renderComparator() {
            const p1Id = document.getElementById('compare-p1').value;
            const p2Id = document.getElementById('compare-p2').value;
            const resultContainer = document.getElementById('comparator-result');
            
            if (!p1Id || !p2Id) {
                resultContainer.innerHTML = '';
                resultContainer.classList.add('hidden');
                return;
            }

            const players = getPlayers();
            const p1 = players.find(p => p.id === p1Id);
            const p2 = players.find(p => p.id === p2Id);
            const s1 = getPlayerStatsForComparator(p1Id);
            const s2 = getPlayerStatsForComparator(p2Id);

            const isBetter = (val1, val2) => parseFloat(val1) > parseFloat(val2) ? 'stat-better' : '';
            
            // Allow comparison even if stats are 0
            resultContainer.innerHTML = `
                <div class="overflow-x-auto">
                    <table class="w-full text-center">
                        <thead>
                            <tr class="text-sm text-gray-500">
                                <th class="w-1/3 p-2">
                                    <div class="flex flex-col items-center">
                                        <img src="${p1.foto}" class="w-16 h-16 rounded-full object-cover mb-2 border-2 border-slate-200">
                                        <span>${p1.nombre}</span>
                                    </div>
                                </th>
                                <th class="w-1/3 p-2">Estad√≠stica</th>
                                <th class="w-1/3 p-2">
                                    <div class="flex flex-col items-center">
                                        <img src="${p2.foto}" class="w-16 h-16 rounded-full object-cover mb-2 border-2 border-slate-200">
                                        <span>${p2.nombre}</span>
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody class="text-slate-800 font-medium">
                            <tr class="border-t">
                                <td class="p-3 ${isBetter(s1.matchesPlayed, s2.matchesPlayed)}">${s1.matchesPlayed}</td>
                                <td class="p-3 text-gray-500 text-sm">Partidos</td>
                                <td class="p-3 ${isBetter(s2.matchesPlayed, s1.matchesPlayed)}">${s2.matchesPlayed}</td>
                            </tr>
                            <tr class="border-t">
                                <td class="p-3 ${isBetter(s1.avgRating, s2.avgRating)}">${s1.avgRating}</td>
                                <td class="p-3 text-gray-500 text-sm">Nota Media</td>
                                <td class="p-3 ${isBetter(s2.avgRating, s1.avgRating)}">${s2.avgRating}</td>
                            </tr>
                            <tr class="border-t">
                                <td class="p-3 ${isBetter(s1.goals, s2.goals)}">${s1.goals}</td>
                                <td class="p-3 text-gray-500 text-sm">Goles</td>
                                <td class="p-3 ${isBetter(s2.goals, s1.goals)}">${s2.goals}</td>
                            </tr>
                            <tr class="border-t">
                                <td class="p-3 ${isBetter(s1.assists, s2.assists)}">${s1.assists}</td>
                                <td class="p-3 text-gray-500 text-sm">Asistencias</td>
                                <td class="p-3 ${isBetter(s2.assists, s1.assists)}">${s2.assists}</td>
                            </tr>
                            <tr class="border-t bg-slate-50">
                                <td class="p-3 ${isBetter(s1.ga, s2.ga)}">${s1.ga}</td>
                                <td class="p-3 text-gray-500 text-sm font-bold">Goles + Asist</td>
                                <td class="p-3 ${isBetter(s2.ga, s1.ga)}">${s2.ga}</td>
                            </tr>
                             <tr class="border-t">
                                <td class="p-3 ${isBetter(s1.minutes, s2.minutes)}">${s1.minutes}</td>
                                <td class="p-3 text-gray-500 text-sm">Minutos</td>
                                <td class="p-3 ${isBetter(s2.minutes, s1.minutes)}">${s2.minutes}</td>
                            </tr>
                            <tr class="border-t">
                                <td class="p-3 ${isBetter(s1.mvpCount, s2.mvpCount)}">${s1.mvpCount}</td>
                                <td class="p-3 text-gray-500 text-sm">MVPs</td>
                                <td class="p-3 ${isBetter(s2.mvpCount, s1.mvpCount)}">${s2.mvpCount}</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            `;
            resultContainer.classList.remove('hidden');
        }
        // ==========================================
        // PRINCIPAL / DASHBOARD LOGIC
        // ==========================================

        function renderPrincipal() {
            const matches = getData('matches');
            const players = getPlayers();
            const now = new Date();

            // 1. PR√ìXIMO RIVAL (Desde Calendario)
            // Filtramos eventos futuros y ordenamos por fecha
            const futureEvents = calendarEvents
                .filter(e => e.start > now)
                .sort((a, b) => a.start - b.start);
            
            const nextMatchContainer = document.getElementById('dashboard-next-match');
            
            if (futureEvents.length > 0) {
                const next = futureEvents[0];
                const dateStr = next.start.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
                const timeStr = next.start.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                
                // Intentar detectar competici√≥n si est√° disponible en el evento o mostrar gen√©rico
                const compName = next.possibleCompetition || 'Partido Oficial';
                
                nextMatchContainer.innerHTML = `
                    <div class="flex flex-col">
                        <span class="text-2xl font-bold text-slate-800 truncate" title="${next.opponent}">${next.opponent}</span>
                        <div class="flex items-center gap-2 mt-1">
                            <span class="text-xs font-semibold bg-amber-100 text-amber-800 px-2 py-0.5 rounded">${compName}</span>
                            <span class="text-xs text-gray-500">${next.venue === 'local' ? 'üè† Casa' : '‚úàÔ∏è Fuera'}</span>
                        </div>
                        <div class="mt-3 flex items-center gap-2 text-sm font-medium text-slate-600">
                            <span>üïí ${dateStr} - ${timeStr}</span>
                        </div>
                        <p class="text-xs text-gray-400 mt-1 truncate">üèüÔ∏è ${next.location || 'Estadio'}</p>
                    </div>
                `;
            } else {
                nextMatchContainer.innerHTML = `
                    <div class="py-2">
                        <p class="text-slate-600 font-medium">No hay partidos pr√≥ximos.</p>
                        <p class="text-xs text-gray-400">Actualiza el calendario si es necesario.</p>
                    </div>`;
            }

            // 2. FORMA DEL EQUIPO (L√≥gica copiada y adaptada)
            const last5Matches = [...matches].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 5).reverse(); // Orden cronol√≥gico para la racha
            const formContainer = document.getElementById('dashboard-form');
            
            if (last5Matches.length > 0) {
                formContainer.innerHTML = last5Matches.map(m => {
                    let color = 'bg-gray-400';
                    let letter = 'E';
                    if (m.outcome === 'victoria') { color = 'bg-green-500'; letter = 'V'; }
                    else if (m.outcome === 'derrota') { color = 'bg-red-500'; letter = 'D'; }
                    
                    return `<div class="${color} text-white w-8 h-8 rounded-full flex items-center justify-center font-bold text-sm shadow-sm" title="${m.opponent} (${m.result})">${letter}</div>`;
                }).join('');
            } else {
                formContainer.innerHTML = '<span class="text-gray-400 text-sm italic">Sin partidos jugados</span>';
            }

            // 3. RESUMEN TEMPORADA
            let wins = 0, draws = 0, losses = 0, gf = 0, ga = 0;
            matches.forEach(m => {
                if (m.outcome === 'victoria') wins++;
                else if (m.outcome === 'empate') draws++;
                else losses++;
                
                if (m.result && m.result.includes('-')) {
                    const parts = m.result.replace('*','').split('-').map(Number);
                    if (m.venue === 'local') { gf += parts[0]; ga += parts[1]; }
                    else if (m.venue === 'visitante') { gf += parts[1]; ga += parts[0]; }
                    else { gf += parts[0]; ga += parts[1]; }
                }
            });
            document.getElementById('dash-wins').textContent = wins;
            document.getElementById('dash-draws').textContent = draws;
            document.getElementById('dash-losses').textContent = losses;
            document.getElementById('dash-gf').textContent = gf;
            document.getElementById('dash-ga').textContent = ga;

            // 4. √öLTIMOS 3 RESULTADOS
            const last3 = [...matches].sort((a, b) => new Date(b.date) - new Date(a.date)).slice(0, 3);
            const resultsContainer = document.getElementById('dashboard-last-results');
            
            if (last3.length > 0) {
                resultsContainer.innerHTML = last3.map(m => {
                    const outcomeColor = m.outcome === 'victoria' ? 'text-green-600' : (m.outcome === 'derrota' ? 'text-red-600' : 'text-amber-600');
                    return `
                    <div class="px-5 py-3 hover:bg-gray-50 flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <div class="w-1 h-8 rounded-full ${m.outcome === 'victoria' ? 'bg-green-500' : (m.outcome === 'derrota' ? 'bg-red-500' : 'bg-amber-500')}"></div>
                            <div>
                                <p class="font-bold text-gray-800 text-sm">${m.opponent}</p>
                                <p class="text-xs text-gray-500">${m.competition}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="font-bold text-lg ${outcomeColor}">${m.result}</span>
                            <p class="text-xs text-gray-400">${formatDate(m.date)}</p>
                        </div>
                    </div>`;
                }).join('');
            } else {
                resultsContainer.innerHTML = '<div class="p-5 text-gray-500 text-sm text-center">No hay partidos registrados a√∫n.</div>';
            }

            // 5. L√çDERES (Calculados al vuelo)
            // Estructura para contadores
            const stats = {};
            players.forEach(p => stats[p.id] = { 
                name: p.apodo || p.apellido,
                img: p.foto,
                goals: 0, 
                assists: 0, 
                mvps: 0,
                totalRating: 0,
                ratingCount: 0
            });

            matches.forEach(m => {
                if (stats[m.mvp]) stats[m.mvp].mvps++;
                m.playerStats.forEach(ps => {
                    if (stats[ps.playerId]) {
                        stats[ps.playerId].goals += (ps.goals || 0);
                        stats[ps.playerId].assists += (ps.assists || 0);
                        if (ps.rating) {
                            stats[ps.playerId].totalRating += parseFloat(ps.rating);
                            stats[ps.playerId].ratingCount++;
                        }
                    }
                });
            });

            // Encontrar m√°ximos
            let topG = { id: null, val: -1 }, topA = { id: null, val: -1 }, topM = { id: null, val: -1 }, topR = { id: null, val: -1 };

            Object.entries(stats).forEach(([id, s]) => {
                const avg = s.ratingCount > 0 ? (s.totalRating / s.ratingCount) : 0;
                
                if (s.goals > topG.val) topG = { id, val: s.goals, ...s };
                if (s.assists > topA.val) topA = { id, val: s.assists, ...s };
                if (s.mvps > topM.val) topM = { id, val: s.mvps, ...s };
                if (avg > topR.val && s.ratingCount >= 2) topR = { id, val: avg, ...s }; // M√≠nimo 2 partidos para nota media
            });

            // Renderizar L√≠deres
            const renderLeaderRow = (label, icon, data, isRating = false) => {
                if (!data.id || data.val <= 0) return '';
                const valDisplay = isRating ? data.val.toFixed(2) : data.val;
                return `
                <div class="flex items-center justify-between p-2 bg-gray-50 rounded-lg border border-gray-100">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 rounded-full bg-white flex items-center justify-center text-lg shadow-sm border border-gray-100">${icon}</div>
                        <div>
                            <p class="text-xs font-bold text-gray-500 uppercase">${label}</p>
                            <p class="text-sm font-bold text-slate-800">${data.name}</p>
                        </div>
                    </div>
                    <span class="text-lg font-bold text-amber-600">${valDisplay}</span>
                </div>`;
            };

            const leadersHtml = `
                ${renderLeaderRow('Goleador', '‚öΩ', topG)}
                ${renderLeaderRow('Asistente', 'üëü', topA)}
                ${renderLeaderRow('Mejor Nota', '‚≠ê', topR, true)}
                ${renderLeaderRow('M√°s MVPs', 'üèÜ', topM)}
            `;

            document.getElementById('dashboard-leaders').innerHTML = leadersHtml || '<p class="text-gray-500 text-sm text-center">Faltan datos para calcular l√≠deres.</p>';
        }

        // ==========================================
        // TAB NAVIGATION
        // ==========================================
        
        function showTab(tabName) {
            document.querySelectorAll('main > section').forEach(s => s.classList.add('hidden'));
            document.querySelectorAll('.tab-btn').forEach(t => t.classList.remove('tab-active'));
            
            document.getElementById(`section-${tabName}`).classList.remove('hidden');
            document.getElementById(`tab-${tabName}`).classList.add('tab-active');
            if (tabName === 'principal') renderPrincipal();
            renderCompetitionStatus();
            if (tabName === 'plantilla') renderPlayers();
            if (tabName === 'calendario') renderCalendar();
            if (tabName === 'nuevo') initNewMatchForm();
            if (tabName === 'partidos') renderMatches();
            if (tabName === 'stats') renderStats();
            if (tabName === 'comparador') { populateComparatorSelects(); renderComparator(); }
        }

        // ==========================================
        // PLAYERS RENDERING
        // ==========================================
        
        function filterPlayers(filter) {
            currentPlayerFilter = filter;
            document.querySelectorAll('#section-plantilla > div:first-of-type button').forEach(btn => {
                btn.classList.remove('bg-slate-800', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            document.getElementById(`filter-${filter}`).classList.remove('bg-gray-200', 'text-gray-700');
            document.getElementById(`filter-${filter}`).classList.add('bg-slate-800', 'text-white');
            renderPlayers();
        }

        function filterByPosition(position) {
            currentPositionFilter = position;
            document.querySelectorAll('.pos-filter').forEach(btn => {
                btn.classList.remove('bg-slate-800', 'text-white');
                btn.classList.add('bg-gray-200');
                if (btn.textContent.includes('Entrenador')) btn.classList.remove('bg-gray-200');
            });
            event.target.classList.remove('bg-gray-200');
            event.target.classList.add('bg-slate-800', 'text-white');
            renderPlayers();
        }

        function renderPlayers() {
            let players = getPlayers();
            if (currentPlayerFilter === 'active') players = players.filter(p => p.estado === 'Activo');
            else if (currentPlayerFilter === 'inactive') players = players.filter(p => p.estado === 'Inactivo');
            
            if (currentPositionFilter) players = players.filter(p => p.posicion === currentPositionFilter);
            
            players.sort((a, b) => {
                if (a.posicion === 'entrenador') return -1;
                if (b.posicion === 'entrenador') return 1;
                return a.dorsal - b.dorsal;
            });
            
            const container = document.getElementById('players-list');
            container.innerHTML = players.map(player => `
                <div class="card bg-white rounded-xl shadow-sm p-4 ${player.estado === 'Inactivo' ? 'player-inactive' : ''} cursor-pointer" onclick="viewPlayerDetails('${player.id}')">
                    <div class="flex items-start gap-4">
                        <img src="${player.foto}" 
                             class="player-photo border-4 ${player.estado === 'Activo' ? 'border-amber-400' : 'border-gray-300'}" 
                             onerror="this.src='https://via.placeholder.com/80x80?text=${player.dorsal}'"
                             alt="${player.nombre}">
                        <div class="flex-1 min-w-0">
                            <div class="flex items-center gap-2 mb-1">
                                <span class="text-2xl font-bold text-slate-700">${player.dorsal === "DT" ? "DT" : "#" + player.dorsal}</span>
                            </div>
                            <h3 class="font-semibold text-gray-800 truncate">${player.nombre} ${player.apellido}</h3>
                            <div class="flex flex-wrap gap-1 mt-1">
                                <span class="position-badge pos-${player.posicion}">${capitalizeFirst(player.posicion)}</span>
                                <button onclick="event.stopPropagation(); openPlayerStatusModal('${player.id}')" class="position-badge ${player.estado === 'Activo' ? 'status-active' : 'status-inactive'} cursor-pointer hover:opacity-80">
                                    ${player.estado} ‚úèÔ∏è
                                </button>
                            </div>
                            <div class="mt-2 text-sm text-gray-500">
                                <p>üéÇ ${formatDate(player.fechaNacimiento)} (${calculateAge(player.fechaNacimiento)} a√±os)</p>
                                <p>üåç ${player.nacionalidad}</p>
                                <p>üìã ${player.categoria}</p>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // ==========================================
        // PLAYER DETAILS MODAL
        // ==========================================

        function viewPlayerDetails(playerId) {
            const players = getPlayers();
            const player = players.find(p => p.id === playerId);
            if (!player) return;

            const modal = document.getElementById('player-details-modal');
            const content = document.getElementById('player-details-content');
            
            const matches = getData('matches');
            const playerMatches = [];
            const stats = { matchesPlayed: 0, goals: 0, assists: 0, minutes: 0, yellowCards: 0, redCards: 0, totalRating: 0, ratingCount: 0, wins: 0 };
            
            // For Chart
            const ratingsHistory = [];

            matches.forEach(m => {
                const ps = m.playerStats?.find(s => String(s.playerId) === String(playerId));
                if (ps) {
                    playerMatches.push({
                        date: m.date,
                        opponent: m.opponent,
                        competition: m.competition,
                        venue: m.venue,
                        result: m.result,
                        outcome: m.outcome,
                        ...ps
                    });

                    stats.matchesPlayed++;
                    stats.goals += ps.goals || 0;
                    stats.assists += ps.assists || 0;
                    stats.minutes += ps.minutes || 0;
                    stats.yellowCards += ps.yellowCards || 0;
                    stats.redCards += ps.redCards || 0;
                    if (ps.rating !== null && ps.rating !== "" && ps.rating !== undefined) {
                        stats.totalRating += parseFloat(ps.rating);
                        stats.ratingCount++;
                        ratingsHistory.push({ rating: parseFloat(ps.rating), opponent: m.opponent });
                    }
                    if (m.outcome === 'victoria') stats.wins++;
                }
            });

            // Sort matches newest first for list, oldest first for chart
            playerMatches.sort((a, b) => new Date(b.date) - new Date(a.date));
            const chartData = [...ratingsHistory].reverse().slice(-10); // Last 10 matches for chart

            const avgRating = stats.ratingCount > 0 ? (stats.totalRating / stats.ratingCount).toFixed(2) : '-';
            const isCoach = player.posicion === 'entrenador';

            // Generate Chart HTML
            let chartHtml = '';
            if (chartData.length > 0) {
                 chartHtml = `
                    <div class="mb-8">
                        <h4 class="text-sm font-bold text-gray-500 uppercase mb-2">Evoluci√≥n Rendimiento (√öltimos 10 PJ)</h4>
                        <div class="chart-container">
                            ${chartData.map(d => {
                                const height = (d.rating / 10) * 100;
                                const color = d.rating >= 8 ? '#10b981' : (d.rating >= 6 ? '#3b82f6' : '#ef4444');
                                return `
                                    <div class="chart-bar" style="height: ${height}%; background-color: ${color};" title="${d.opponent}: ${d.rating}">
                                        <span class="chart-label">${d.rating}</span>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                 `;
            }

            content.innerHTML = `
                <div class="flex flex-col md:flex-row gap-6 mb-8 items-center md:items-start">
                    <img src="${player.foto}" class="player-photo-lg border-4 ${player.estado === 'Activo' ? 'border-amber-400' : 'border-gray-300'} shadow-lg" 
                         onerror="this.src='https://via.placeholder.com/120x120?text=${player.dorsal}'">
                    <div class="text-center md:text-left flex-1">
                        <div class="flex items-center justify-center md:justify-start gap-3 mb-2">
                             <span class="text-3xl font-bold text-slate-800">${player.dorsal === "DT" ? "DT" : "#" + player.dorsal}</span>
                             <span class="position-badge pos-${player.posicion} text-base px-3 py-1">${capitalizeFirst(player.posicion)}</span>
                        </div>
                        <h2 class="text-3xl font-bold text-slate-800 mb-1">${player.nombre} ${player.apellido}</h2>
                        <div class="text-gray-600 mb-4">
                            <p>üåç ${player.nacionalidad} | üéÇ ${calculateAge(player.fechaNacimiento)} a√±os</p>
                            <p class="text-sm mt-1">${player.categoria}</p>
                        </div>
                    </div>
                </div>

                <h3 class="text-lg font-bold text-gray-800 mb-4 pb-2 border-b">Estad√≠sticas Generales</h3>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                    <div class="bg-gray-50 p-4 rounded-xl text-center">
                        <p class="text-gray-500 text-sm">Partidos</p>
                        <p class="text-2xl font-bold text-slate-800">${stats.matchesPlayed}</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl text-center">
                        <p class="text-gray-500 text-sm">Nota Media</p>
                        <p class="text-2xl font-bold ${getRatingColor(avgRating)}">${avgRating}</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl text-center">
                        <p class="text-gray-500 text-sm">Victorias</p>
                        <p class="text-2xl font-bold text-green-600">${stats.wins}</p>
                    </div>
                    <div class="bg-gray-50 p-4 rounded-xl text-center">
                         <p class="text-gray-500 text-sm">Tarjetas</p>
                         <div class="flex justify-center gap-3">
                            <span class="text-amber-500 font-bold text-xl">üü® ${stats.yellowCards}</span>
                            <span class="text-red-500 font-bold text-xl">üü• ${stats.redCards}</span>
                         </div>
                    </div>
                </div>

                ${!isCoach ? `
                <div class="grid grid-cols-3 gap-4 mb-8">
                    <div class="bg-slate-800 text-white p-4 rounded-xl text-center">
                        <p class="text-slate-300 text-sm">Goles</p>
                        <p class="text-2xl font-bold">${stats.goals}</p>
                    </div>
                    <div class="bg-slate-700 text-white p-4 rounded-xl text-center">
                        <p class="text-slate-300 text-sm">Asistencias</p>
                        <p class="text-2xl font-bold">${stats.assists}</p>
                    </div>
                    <div class="bg-slate-600 text-white p-4 rounded-xl text-center">
                        <p class="text-slate-300 text-sm">Minutos</p>
                        <p class="text-2xl font-bold">${stats.minutes}'</p>
                    </div>
                </div>
                ` : ''}

                ${chartHtml}

                <h3 class="text-lg font-bold text-gray-800 mb-4 pb-2 border-b">Historial de Partidos</h3>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-slate-700 text-white">
                            <tr>
                                <th class="px-3 py-2 text-left">Fecha</th>
                                <th class="px-3 py-2 text-left">Rival</th>
                                <th class="px-3 py-2 text-left">Rol</th>
                                <th class="px-3 py-2 text-center">Nota</th>
                                <th class="px-3 py-2 text-center">G</th>
                                <th class="px-3 py-2 text-center">A</th>
                                <th class="px-3 py-2 text-center">Min</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${playerMatches.length > 0 ? playerMatches.map(m => `
                                <tr class="border-t hover:bg-gray-50">
                                    <td class="px-3 py-2 text-gray-600">${formatDate(m.date)}</td>
                                    <td class="px-3 py-2">
                                        <div class="font-medium">${m.opponent}</div>
                                        <div class="text-xs text-gray-500">${m.competition}</div>
                                    </td>
                                    <td class="px-3 py-2">
                                        ${m.isStarter === true || m.isStarter === 'true' ? 
                                          '<span class="starter-badge">Titular</span>' : 
                                          '<span class="sub-badge">Suplente</span>'}
                                    </td>
                                    <td class="px-3 py-2 text-center font-bold ${getRatingColor(m.rating)}">${m.rating !== null && m.rating !== undefined ? m.rating : '-'}</td>
                                    <td class="px-3 py-2 text-center">${isCoach ? '-' : (m.goals || 0)}</td>
                                    <td class="px-3 py-2 text-center">${isCoach ? '-' : (m.assists || 0)}</td>
                                    <td class="px-3 py-2 text-center text-gray-600">${isCoach ? '-' : (m.minutes || 0)}'</td>
                                </tr>
                            `).join('') : '<tr><td colspan="7" class="px-3 py-4 text-center text-gray-500">No hay partidos registrados.</td></tr>'}
                        </tbody>
                    </table>
                </div>
            `;
            modal.classList.add('active');
        }

        // ==========================================
        // CALENDAR FIXTURE SELECTION & DISPLAY
        // ==========================================
        
        function selectCalendarFixture(fixtureId) {
            const fixture = calendarEvents.find(e => e.id === fixtureId);
            if (!fixture) return;

            const matches = getData('matches');
            const isRegistered = matches.some(m => m.calendarEventId === fixtureId);
            if (isRegistered) {
                alert('‚ö†Ô∏è Este partido ya ha sido registrado.');
                return;
            }
            
            // Precise Date Validation
            const now = new Date();
            if (fixture.start > now) {
                alert('‚ö†Ô∏è No puedes registrar un partido antes de que comience.');
                return;
            }
            
            selectedCalendarFixture = fixture;
            
            // Switch tab and Show Form
            showTab('nuevo');
            document.getElementById('select-match-prompt').classList.add('hidden');
            document.getElementById('new-match-form-container').classList.remove('hidden');
            
            // Show Step 1, Hide Step 2
            document.getElementById('wizard-step-1').classList.remove('hidden');
            document.getElementById('wizard-step-2').classList.add('hidden');
            
            populateFormFromFixture(fixture);
        }

        function populateFormFromFixture(fixture) {
            document.getElementById('selected-fixture-info').classList.remove('hidden');
            
            const compLabel = fixture.competition ? ` - ${fixture.competition}` : '';
            document.getElementById('selected-fixture-details').textContent = 
                `${fixture.opponent}${compLabel} - ${fixture.start.toLocaleDateString('es-ES')} - ${fixture.location || 'Estadio'}`;
            
            document.getElementById('new-date').value = fixture.start.toISOString().split('T')[0];
            document.getElementById('new-opponent').value = fixture.opponent || '';
            document.getElementById('calendar-event-id').value = fixture.id;

            // --- L√ìGICA ROBUSTA PARA EL SELECTOR ---
            const compSelect = document.getElementById('new-competition');
            let foundCompKey = null;

            if (fixture.competition) {
                // Buscamos ignorando may√∫sculas y espacios (trim)
                foundCompKey = Object.keys(COMPETICIONES_ACTUALES).find(k => 
                    k.toLowerCase().trim() === fixture.competition.toLowerCase().trim()
                );
            }

            if (foundCompKey) {
                compSelect.value = foundCompKey;
                compSelect.disabled = true; 
                compSelect.classList.add('readonly-input', 'bg-gray-100', 'text-gray-600'); 
                updateRoundOptions();
            } else {
                compSelect.value = "";
                compSelect.disabled = false;
                compSelect.classList.remove('readonly-input', 'bg-gray-100', 'text-gray-600');
            }

            const venueSelect = document.getElementById('new-venue');
            venueSelect.value = fixture.venue || '';
            if (fixture.venue) {
                venueSelect.classList.add('readonly-input');
                venueSelect.disabled = true; 
            }
            updateStadiumField();
            
            const stadiumInput = document.getElementById('new-stadium');
            if (fixture.location) {
                stadiumInput.value = fixture.location;
                stadiumInput.readOnly = true;
                stadiumInput.classList.add('readonly-input');
            }
        }

        function clearSelectedFixture() {
            selectedCalendarFixture = null;
            resetNewMatchForm();
        }

        // ==========================================
        // NEW MATCH FORM & WIZARD
        // ==========================================
        
        function initNewMatchForm() {
            populateCompetitionSelect();
            // renderPlayerStatsForm is called when entering Step 2
            
            if (!selectedCalendarFixture) {
                document.getElementById('select-match-prompt').classList.remove('hidden');
                document.getElementById('new-match-form-container').classList.add('hidden');
            } else {
                document.getElementById('select-match-prompt').classList.add('hidden');
                document.getElementById('new-match-form-container').classList.remove('hidden');
                document.getElementById('wizard-step-1').classList.remove('hidden');
                document.getElementById('wizard-step-2').classList.add('hidden');
            }
        }
        
        function goToStep2() {
            // Validate Step 1
            const comp = document.getElementById('new-competition').value;
            const round = document.getElementById('new-round').value;
            const result = document.getElementById('new-result').value;
            
            if (!comp || !round || !result) {
                alert("Por favor, completa todos los campos obligatorios del Paso 1.");
                return;
            }
            if (!/^\d+-\d+$/.test(result)) {
                alert("El formato del resultado debe ser goles_local-goles_visitante (ej: 2-1)");
                return;
            }

            // Render players with suspension logic
            renderPlayerStatsForm('new-match-players-stats', comp);

            document.getElementById('wizard-step-1').classList.add('hidden');
            document.getElementById('wizard-step-2').classList.remove('hidden');
            currentPitchPlayers = {}; // Reseteamos alineaci√≥n
            currentSubstitutes = [];
            renderBench();            // Cargamos jugadores
            updatePitchFormation();   // Pintamos el campo (4-3-3 por defecto)
        }

        function goToStep1() {
            document.getElementById('wizard-step-2').classList.add('hidden');
            document.getElementById('wizard-step-1').classList.remove('hidden');
        }

       function renderCompetitionStatus() {
            const container = document.getElementById('competition-status');
            const state = getCompetitionState();
            
            container.innerHTML = Object.entries(COMPETICIONES_ACTUALES).map(([name, comp]) => {
                const isEliminated = state[name]?.eliminated;
                const eliminatedAtId = state[name]?.eliminatedAt;
                
                // L√≥gica para encontrar el nombre exacto de la ronda de eliminaci√≥n
                let eliminatedText = 'ELIMINADO DE LA COMPETICI√ìN';
                if (isEliminated && eliminatedAtId) {
                    comp.fases.forEach(fase => {
                        const r = fase.rondas.find(round => round.id === eliminatedAtId);
                        if (r) eliminatedText = `Eliminado en ${r.nombre}`;
                    });
                }

                const availableRounds = getAvailableRounds(name);
                const nextRound = availableRounds.find(r => r.status === 'available');
                const matches = getData('matches').filter(m => m.competition === name);
                
                return `
                    <div class="bg-white rounded-xl shadow-sm p-4 ${isEliminated ? 'opacity-60' : ''}">
                        <div class="flex items-center gap-3 mb-3">
                            <span class="${comp.color} px-3 py-1 rounded-full text-sm font-medium ${isEliminated ? 'comp-eliminated' : ''}">${name}</span>
                            ${isEliminated ? '<span class="text-red-500 text-sm">‚ùå Eliminados</span>' : ''}
                        </div>
                        <div class="text-sm text-gray-600">
                            <p>üìä Partidos jugados: <strong>${matches.length}</strong></p>
                            ${nextRound ? `<p>‚û°Ô∏è Disponible: <strong>${nextRound.nombre}</strong></p>` : 
                              (isEliminated ? `<p class="text-red-600 font-bold">‚õî ${eliminatedText}</p>` : '<p class="text-green-500">‚úÖ Competici√≥n completada</p>')}
                        </div>
                    </div>
                `;
            }).join('');
        }

        function populateCompetitionSelect() {
            const select = document.getElementById('new-competition');
            const state = getCompetitionState();
            
            select.innerHTML = '<option value="">Seleccionar competici√≥n...</option>' +
                Object.entries(COMPETICIONES_ACTUALES)
                    .map(([name, comp]) => {
                        const eliminated = state[name]?.eliminated;
                        const label = eliminated ? `${name} (Eliminado)` : name;
                        const disabled = eliminated ? 'disabled' : '';
                        return `<option value="${name}" ${disabled} class="${eliminated ? 'text-red-500' : ''}">${label}</option>`;
                    })
                    .join('');
            
            const filterSelect = document.getElementById('filter-competition');
            const statsFilterSelect = document.getElementById('stats-filter-competition');
            const compOptions = '<option value="">Todas las competiciones</option>' + Object.keys(COMPETICIONES_ACTUALES).map(name => `<option value="${name}">${name}</option>`).join('');
            
            filterSelect.innerHTML = compOptions;
            statsFilterSelect.innerHTML = compOptions;
            
             const calFilterContainer = document.getElementById('calendar-filters-container');
             calFilterContainer.innerHTML = '<button onclick="filterCalendar(\'\')" class="cal-filter px-3 py-1 text-sm rounded-full bg-slate-800 text-white">Todas</button>';
             Object.values(COMPETICIONES_ACTUALES).forEach(comp => {
                 calFilterContainer.innerHTML += `<button onclick="filterCalendar('${comp.id}')" class="cal-filter px-3 py-1 text-sm rounded-full ${comp.color}">${comp.nombre}</button>`;
             });
        }
        
        function updateRoundOptions() {
            const compName = document.getElementById('new-competition').value;
            const roundSelect = document.getElementById('new-round');
            const roundInfo = document.getElementById('round-info');
            const venueSelect = document.getElementById('new-venue');
            
            if (!compName) {
                roundSelect.innerHTML = '<option value="">Primero selecciona competici√≥n...</option>';
                roundInfo.textContent = '';
                return;
            }
            
            const comp = COMPETICIONES_ACTUALES[compName];
            const availableRounds = getAvailableRounds(compName);
            
            if (availableRounds.length === 0) {
                roundSelect.innerHTML = '<option value="">No hay rondas disponibles</option>';
                roundInfo.textContent = 'Esta competici√≥n est√° completada o eliminada.';
                return;
            }
            
            roundSelect.innerHTML = '<option value="">Seleccionar ronda...</option>' +
                availableRounds.map(r => {
                    const statusIcon = r.status === 'completed' ? '‚úÖ' : (r.status === 'available' ? 'üü¢' : 'üîí');
                    const disabled = r.status !== 'available' ? 'disabled' : '';
                    return `<option value="${r.id}" ${disabled} data-orden="${r.orden}">${statusIcon} ${r.nombre}</option>`;
                }).join('');
            
            if (comp.campoNeutral) {
                venueSelect.value = 'neutral';
                updateStadiumField();
                venueSelect.disabled = true;
                roundInfo.textContent = '‚ö†Ô∏è Esta competici√≥n se juega en campo neutral.';
            } else {
                roundInfo.textContent = comp.ordenLibre || comp.tipo === 'liga' ? 
                    'üìã Liga: puedes registrar jornadas en cualquier orden.' :
                    'üü¢ = Disponible, üîí = Ronda anterior pendiente, ‚úÖ = Completada';
            }
            updateOvertimeOptions();
        }

        // Logic for Extra Time and Penalties Controls
        function updateOvertimeOptions() {
            const compName = document.getElementById('new-competition').value;
            const roundId = document.getElementById('new-round').value;
            const result = document.getElementById('new-result').value;
            const container = document.getElementById('overtime-controls');
            const etOption = document.getElementById('extra-time-option');
            const penOption = document.getElementById('penalties-option');
            
            if (!compName || !roundId || !result || !/^\d+-\d+$/.test(result)) {
                container.classList.add('hidden');
                return;
            }

            const comp = COMPETICIONES_ACTUALES[compName];
            let roundInfo = null;
            comp.fases.forEach(fase => {
                const found = fase.rondas.find(r => r.id === roundId);
                if (found) roundInfo = { ...found, faseTipo: fase.tipo };
            });

            if (!roundInfo || !roundInfo.eliminatoria || roundInfo.faseTipo === 'liga') {
                container.classList.add('hidden');
                return;
            }

            let showET = false;
            let showPen = false;
            const currentResultParts = result.split('-').map(Number);
            const currentUs = currentResultParts[0]; // Assuming local input perspective roughly
            const currentThem = currentResultParts[1];

            // 1. Return Leg Logic
            if (roundInfo.idaVuelta === 'vuelta') {
                const matches = getData('matches').filter(m => m.competition === compName);
                const idaMatch = matches.find(m => m.roundId === roundInfo.pareja);

                if (idaMatch) {
                    // Calculate Global
                    // This is complex because we don't know venue yet perfectly from inputs, 
                    // but we can infer from `new-venue` which is likely disabled/set by `handleRoundChange`.
                    // Assume inputs are set correctly.
                    const venue = document.getElementById('new-venue').value;
                    const mockMatch = { result: result, venue: venue };
                    const globalRes = calculateGlobalResult(idaMatch, mockMatch);
                    
                    if (globalRes.outcome === 'empate') {
                         showET = true;
                         showPen = true;
                    }
                }
            }
            // 2. Single Leg Logic
            else if (roundInfo.partidoUnico) {
                if (currentUs === currentThem) {
                    showPen = true;
                }
            }

            if (showET || showPen) {
                container.classList.remove('hidden');
                if (showET) etOption.classList.remove('hidden');
                else etOption.classList.add('hidden');
                
                if (showPen) penOption.classList.remove('hidden');
                else penOption.classList.add('hidden');
            } else {
                container.classList.add('hidden');
            }
        }
        
        function togglePenaltyWinner() {
            const chk = document.getElementById('chk-penalties');
            const winnerSelect = document.getElementById('penalty-winner-select');
            if (chk.checked) winnerSelect.classList.remove('hidden');
            else winnerSelect.classList.add('hidden');
        }
        
        function handleRoundChange() {
            const compName = document.getElementById('new-competition').value;
            const roundId = document.getElementById('new-round').value;
            
            if (!compName || !roundId) return;
            
            const comp = COMPETICIONES_ACTUALES[compName];
            let roundInfo = null;
            
            comp.fases.forEach(fase => {
                const found = fase.rondas.find(r => r.id === roundId);
                if (found) roundInfo = { ...found, faseTipo: fase.tipo };
            });
            
            if (!roundInfo) return;
            
            // Handle two-leg ties
            if (roundInfo.idaVuelta === 'vuelta') {
                const matches = getData('matches').filter(m => m.competition === compName);
                const idaMatch = matches.find(m => m.roundId === roundInfo.pareja);
                
                if (idaMatch) {
                    const legIndicator = document.getElementById('leg-indicator');
                    const legInfo = document.getElementById('leg-info');
                    legIndicator.classList.remove('hidden');
                    legInfo.innerHTML = `<strong>üìä Partido de ida:</strong> vs ${idaMatch.opponent} - Resultado: ${idaMatch.result} (${idaMatch.venue === 'local' ? 'Local' : 'Visitante'})`;
                    
                    document.getElementById('new-opponent').value = idaMatch.opponent;
                    
                    const venueSelect = document.getElementById('new-venue');
                    const alternateVenue = idaMatch.venue === 'local' ? 'visitante' : 'local';
                    venueSelect.value = alternateVenue;
                    venueSelect.disabled = true;
                    
                    const venueWarning = document.getElementById('venue-alternation-warning');
                    const venueInfo = document.getElementById('venue-alternation-info');
                    venueWarning.classList.remove('hidden');
                    venueInfo.innerHTML = `<strong>üîÑ Alternancia autom√°tica:</strong> La ida fue ${idaMatch.venue === 'local' ? 'en casa' : 'fuera'}, la vuelta debe ser ${alternateVenue === 'local' ? 'en casa' : 'fuera'}.`;
                    
                    updateStadiumField();
                }
            } else {
                document.getElementById('leg-indicator').classList.add('hidden');
                document.getElementById('venue-alternation-warning').classList.add('hidden');
            }
            updateOvertimeOptions();
        }
        
        function updateStadiumField() {
            const venue = document.getElementById('new-venue').value;
            const stadiumInput = document.getElementById('new-stadium');
            const compName = document.getElementById('new-competition').value;
            const comp = COMPETICIONES_ACTUALES[compName];
            
            if (venue === 'local') {
                stadiumInput.value = 'Santiago Bernab√©u';
                stadiumInput.readOnly = true;
                stadiumInput.classList.add('bg-gray-100');
            } else if (venue === 'neutral' && comp?.campoNeutral) {
                if (!selectedCalendarFixture?.location) stadiumInput.value = '';
                else stadiumInput.value = selectedCalendarFixture.location;
                
                stadiumInput.readOnly = false;
                stadiumInput.classList.remove('bg-gray-100');
                stadiumInput.placeholder = 'Estadio del partido (campo neutral)';
            } else {
                if (!selectedCalendarFixture?.location) stadiumInput.value = '';
                else stadiumInput.value = selectedCalendarFixture.location;
                
                stadiumInput.readOnly = false;
                stadiumInput.classList.remove('bg-gray-100');
                stadiumInput.placeholder = 'Estadio del rival';
            }
        }

        function renderPlayerStatsForm(containerId, currentCompetition) {
            const container = document.getElementById(containerId);
            let players = getActivePlayers();
            
            // SUSPENSION LOGIC: Find last match of this competition and check red cards
            const matches = getData('matches')
                .filter(m => m.competition === currentCompetition)
                .sort((a, b) => new Date(b.date) - new Date(a.date));
            
            const lastMatch = matches[0]; // Most recent match
            const suspendedPlayers = [];
            
            if (lastMatch) {
                lastMatch.playerStats.forEach(ps => {
                    if (ps.redCards > 0) {
                        suspendedPlayers.push(ps.playerId);
                    }
                });
            }

            // Use custom order for both teams
            if (currentTeam === 'masculino' || currentTeam === 'femenino') {
                const orderList = currentTeam === 'masculino' ? CUSTOM_ORDER_MASCULINO : CUSTOM_ORDER_FEMENINO;
                
                players.sort((a, b) => {
                    const idxA = orderList.indexOf(a.id);
                    const idxB = orderList.indexOf(b.id);
                    if (idxA === -1 && idxB === -1) return 0;
                    if (idxA === -1) return 1; // Los que no est√©n en la lista van al final
                    if (idxB === -1) return -1;
                    return idxA - idxB;
                });
            } else {
                // Fallback por si acaso
                players.sort((a, b) => {
                    if (a.posicion === 'entrenador') return -1;
                    if (b.posicion === 'entrenador') return 1;
                    return a.dorsal - b.dorsal;
                });
            }
            container.innerHTML = players.map(player => {
                const isCoach = player.posicion === 'entrenador';
                const isSuspended = suspendedPlayers.includes(player.id) && !isCoach;
                
                return `
                <div class="bg-gray-50 rounded-lg p-3 ${isSuspended ? 'player-suspended' : ''}" data-player-id="${player.id}">
                    <div class="flex items-center gap-3 mb-3">
                        <img src="${player.foto}" class="player-photo-xs" onerror="this.src='https://via.placeholder.com/32x32?text=${player.dorsal}'">
                        <div class="flex-1">
                        <span class="font-medium text-gray-800">${player.apodo || player.nombre + ' ' + player.apellido}</span>
                            <span class="text-gray-500 text-sm ml-1">${player.dorsal === "DT" ? "DT" : "#" + player.dorsal}</span>
                            ${isSuspended ? '<span class="text-xs text-red-600 font-bold ml-2">‚õî SUSPENDIDO (Roja directa)</span>' : ''}
                        </div>
                        
                         <!-- NEW CHECKBOXES: STARTER / SUB (Mutually Exclusive) -->
                         ${!isCoach ? `
                         <label class="flex items-center gap-1 text-sm cursor-pointer">
                            <input type="checkbox" class="chk-starter w-4 h-4 text-green-600" onchange="handleRoleCheck(this, 'starter')" ${isSuspended ? 'disabled' : ''}>
                            <span>Titular</span>
                         </label>
                         <label class="flex items-center gap-1 text-sm cursor-pointer">
                            <input type="checkbox" class="chk-sub w-4 h-4 text-blue-600" onchange="handleRoleCheck(this, 'sub')" ${isSuspended ? 'disabled' : ''}>
                            <span>Suplente</span>
                         </label>
                         ` : `
                         <span class="text-xs font-bold text-gray-500 bg-gray-200 px-2 py-1 rounded">Staff T√©cnico</span>
                         `}

                    </div>
                    
                    <!-- Stats Section (Hidden/Shown based on participation) -->
                    <div class="player-performance-inputs grid grid-cols-2 md:grid-cols-4 gap-2" style="${isCoach ? 'display:grid' : 'display:none'}">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Nota (0-10)</label>
                            <input type="number" class="stat-rating w-full px-2 py-1 border rounded text-sm" min="0" max="10" step="0.25" placeholder="‚Äì">
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Goles</label>
                            ${!isCoach ? `<input type="number" class="stat-goals w-full px-2 py-1 border rounded text-sm" min="0" value="0">` : `<span class="block text-center text-gray-400 mt-1">-</span>`}
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Asist.</label>
                            ${!isCoach ? `<input type="number" class="stat-assists w-full px-2 py-1 border rounded text-sm" min="0" value="0">` : `<span class="block text-center text-gray-400 mt-1">-</span>`}
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">Minutos</label>
                            ${!isCoach ? `<input type="number" class="stat-minutes w-full px-2 py-1 border rounded text-sm" min="0" max="120" value="90">` : `<span class="block text-center text-gray-400 mt-1">-</span>`}
                        </div>
                    </div>
                    
                    <!-- Cards Section (Always visible unless suspended) -->
                     <div class="grid grid-cols-2 gap-2 mt-2 pt-2 border-t border-gray-200">
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">üü® Amarillas</label>
                            <input type="number" class="stat-yellow w-full px-2 py-1 border rounded text-sm" min="0" max="2" value="0" ${isSuspended ? 'disabled' : ''}>
                        </div>
                        <div>
                            <label class="block text-xs text-gray-500 mb-1">üü• Rojas</label>
                            <input type="number" class="stat-red w-full px-2 py-1 border rounded text-sm" min="0" max="1" value="0" ${isSuspended ? 'disabled' : ''}>
                        </div>
                    </div>
                </div>
            `}).join('');
        }
        
        // Handles mutual exclusion for Starter/Sub checkboxes
        function handleRoleCheck(checkbox, role) {
            const container = checkbox.closest('[data-player-id]');
            const starterChk = container.querySelector('.chk-starter');
            const subChk = container.querySelector('.chk-sub');
            const inputs = container.querySelector('.player-performance-inputs');
            
            if (role === 'starter' && checkbox.checked) {
                subChk.checked = false;
            } else if (role === 'sub' && checkbox.checked) {
                starterChk.checked = false;
            }
            
            // Show inputs if either is checked
            inputs.style.display = (starterChk.checked || subChk.checked) ? 'grid' : 'none';
        }

        function resetNewMatchForm() {
            document.getElementById('new-match-form').reset();
            document.getElementById('new-round').innerHTML = '<option value="">Primero selecciona competici√≥n...</option>';
            document.getElementById('round-info').textContent = '';
            document.getElementById('leg-indicator').classList.add('hidden');
            document.getElementById('venue-alternation-warning').classList.add('hidden');
            
            // Resetear select de competici√≥n
            const compSelect = document.getElementById('new-competition');
            compSelect.disabled = false;
            compSelect.classList.remove('readonly-input', 'bg-gray-100', 'text-gray-600');
            
            document.getElementById('new-venue').disabled = false;
            document.getElementById('new-venue').classList.remove('readonly-input');
            document.getElementById('new-stadium').readOnly = true;
            document.getElementById('new-stadium').classList.add('readonly-input');
            document.getElementById('overtime-controls').classList.add('hidden');
            
            selectedCalendarFixture = null;
            document.getElementById('selected-fixture-info').classList.add('hidden');
            document.getElementById('new-match-form-container').classList.add('hidden');
            document.getElementById('select-match-prompt').classList.remove('hidden');
            
            // Reset Wizard
            document.getElementById('wizard-step-1').classList.remove('hidden');
            document.getElementById('wizard-step-2').classList.add('hidden');
            document.getElementById('new-match-players-stats').innerHTML = '';
        }
        
 document.getElementById('new-match-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const calendarEventId = document.getElementById('calendar-event-id').value;
            if (!calendarEventId) {
                alert('Error: No se ha seleccionado un partido del calendario.');
                return;
            }

            const compName = document.getElementById('new-competition').value;
            const roundId = document.getElementById('new-round').value;
            const date = document.getElementById('new-date').value;
            const opponent = document.getElementById('new-opponent').value;
            const venue = document.getElementById('new-venue').value;
            const stadium = document.getElementById('new-stadium').value;
            let result = document.getElementById('new-result').value.trim();
            
            // L√≥gica de Penaltis (igual que antes)
            const chkPenalties = document.getElementById('chk-penalties');
            if (chkPenalties.checked) {
                 const outcomeRadio = document.querySelector('input[name="penalties-outcome"]:checked');
                 if (outcomeRadio) {
                     const isWin = outcomeRadio.value === 'win';
                     const parts = result.split('-').map(Number);
                     let usIndex = 0;
                     if (venue === 'visitante') usIndex = 1;
                     
                     if (isWin) {
                         parts[usIndex]++;
                     } else {
                         parts[usIndex === 0 ? 1 : 0]++;
                     }
                     result = `${parts[0]}-${parts[1]}*`;
                 }
            }

            const comp = COMPETICIONES_ACTUALES[compName];
            let roundInfo = null;
            comp.fases.forEach(fase => {
                const found = fase.rondas.find(r => r.id === roundId);
                if (found) roundInfo = { ...found, faseTipo: fase.tipo };
            });
            
            const outcome = calculateMatchOutcome(result, venue);
            
            // --- AQU√ç EST√Å EL CAMBIO IMPORTANTE ---
            // Leemos del contenedor del PASO 3 (final-stats-container) en vez del Paso 2
            const statsContainer = document.getElementById('final-stats-container');
            const playerStats = [];
            
            // Recorremos la lista final (que ya solo tiene a los que jugaron)
            statsContainer.querySelectorAll('[data-player-id]').forEach(row => {
                const playerId = row.getAttribute('data-player-id');
                const rol = row.getAttribute('data-rol'); // Este dato lo guardamos al pasar al paso 3
                const isCoach = rol === 'Entrenador';
                
                // Ya no hay checkboxes, el rol nos dice si fue titular
                const isStarter = (rol === 'Titular');
                
                // Leemos los inputs
                let yellow = parseInt(row.querySelector('.stat-yellow').value) || 0;
                let red = parseInt(row.querySelector('.stat-red').value) || 0;
                if (yellow >= 2) red = 1;

                let rating = null;
                let goals = 0;
                let assists = 0;
                let minutes = 0;

                const ratingInput = row.querySelector('.stat-rating').value;
                rating = (ratingInput === "" || ratingInput === null) ? null : parseFloat(ratingInput);
                goals = isCoach ? 0 : (parseInt(row.querySelector('.stat-goals').value) || 0);
                assists = isCoach ? 0 : (parseInt(row.querySelector('.stat-assists').value) || 0);
                minutes = isCoach ? 0 : (parseInt(row.querySelector('.stat-minutes').value) || 0);

                playerStats.push({
                    playerId: playerId,
                    isStarter: isStarter,
                    rating: rating,
                    goals: goals,
                    assists: assists,
                    minutes: minutes,
                    yellowCards: yellow,
                    redCards: red,
                    played: true // Si est√° en esta lista, es que jug√≥ (o es el m√≠ster)
                });
            });
            // -------------------------------------
            
            const mvp = calculateAutoMVP(playerStats);
            
            const matchData = {
                id: generateId(),
                calendarEventId: calendarEventId,
                competition: compName,
                roundId: roundId,
                round: roundInfo.nombre,
                date: date,
                opponent: opponent,
                venue: venue,
                stadium: stadium,
                result: result,
                outcome: outcome,
                mvp: mvp,
                playerStats: playerStats
            };
            
            const matches = getData('matches');
            matches.push(matchData);
            saveData('matches', matches);
            
            checkEliminationAfterMatch(matchData);

            // L√≥gica de Ronda Extra
            const triggered = checkExtraRoundTrigger(matchData);
            
            if (!triggered) {
                resetNewMatchForm();
                renderCompetitionStatus();
                populateCompetitionSelect();
                
                alert('‚úÖ Partido registrado correctamente');
                showTab('partidos');
            }
        });
        
        // ==========================================
        // CALENDAR
        // ==========================================
        // ==========================================
        // SISTEMA DE PRECARGA DE CALENDARIO
        // ==========================================
        
        // Memoria para guardar los calendarios y no tener que recargarlos
        const CALENDAR_CACHE = { masculino: null, femenino: null };

        async function getCalendarEvents(team) {
            // 1. Si ya lo tenemos en memoria, lo devolvemos al instante (¬°Velocidad pura!)
            if (CALENDAR_CACHE[team]) return CALENDAR_CACHE[team];

            const config = TEAMS_CONFIG[team];
            if (!config) return [];

            const icalUrl = config.icalUrl;
            
            // Lista de proxies para saltar el bloqueo CORS
            const proxies = [
                (url) => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
                (url) => `https://corsproxy.io/?${encodeURIComponent(url)}`,
                (url) => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`
            ];

            let icalData = null;

            // Intentamos descargar con cada proxy
            for (const proxyFn of proxies) {
                try {
                    const proxyUrl = proxyFn(icalUrl);
                    const response = await fetch(proxyUrl, { method: 'GET' });
                    if (response.ok) {
                        const text = await response.text();
                        if (text.includes('BEGIN:VCALENDAR') || text.includes('BEGIN:VEVENT')) {
                            icalData = text;
                            break;
                        }
                    }
                } catch (error) {
                    console.warn('Proxy failed');
                }
            }

            let events = [];
            if (icalData) {
                // Pasamos 'team' expl√≠citamente para no depender de 'currentTeam'
                events = parseICalData(icalData, team);
            }

            // A√±adir partidos manuales (Mundial de Clubes) si corresponde
            if (config.manualJuneMatches) {
                const manualMatches = [
                    { id: 'jun-1', start: new Date('2025-06-18T21:00:00'), summary: 'Real Madrid vs Al-Hilal', opponent: 'Al-Hilal', competition: 'Mundial de Clubes', venue: 'neutral', location: 'Hard Rock Stadium' },
                    { id: 'jun-2', start: new Date('2025-06-22T21:00:00'), summary: 'Real Madrid vs Pachuca', opponent: 'Pachuca', competition: 'Mundial de Clubes', venue: 'neutral', location: 'Bank of America Stadium' },
                    { id: 'jun-3', start: new Date('2025-06-27T03:00:00'), summary: 'Salzburgo vs Real Madrid', opponent: 'Salzburgo', competition: 'Mundial de Clubes', venue: 'neutral', location: 'Lincoln Financial Field' }
                ];
                events = [...manualMatches, ...events];
                events.sort((a, b) => a.start - b.start);
            }
            
            // Guardamos en cach√© para el futuro
            CALENDAR_CACHE[team] = events;
            return events;
        }

        function preloadCalendars() {
            console.log("üöÄ Iniciando precarga inteligente de calendarios...");
            getCalendarEvents('masculino');
            getCalendarEvents('femenino');
        }


       async function loadCalendar() {
            if (!currentTeam) return;
            
            const container = document.getElementById('calendar-container');
            
            // Si NO est√° en cach√©, mostramos "Cargando..." (solo pasar√° si entras muy muy r√°pido)
            if (!CALENDAR_CACHE[currentTeam]) {
                container.innerHTML = `
                    <div class="calendar-loading text-center py-12">
                        <div class="text-4xl mb-4">‚è≥</div>
                        <p class="text-gray-600">Cargando calendario oficial...</p>
                    </div>
                `;
            }

            // Pedimos los eventos (si la precarga funcion√≥, esto es instant√°neo)
            calendarEvents = await getCalendarEvents(currentTeam);
            
            renderCalendar();
        }

        // Mapa de traducci√≥n: Nombre en Calendario (.ics) -> Nombre en tu Web
        function mapIcsCompetition(icsDescription) {
            if (!icsDescription) return null;
            
            // 1. Convertimos todo a min√∫sculas para evitar errores de may√∫sculas
            const desc = icsDescription.toLowerCase().trim(); 

            // --- MASCULINO ---
            if (desc.includes('la liga') || desc.includes('laliga')) return 'Liga EA Sports';
            if (desc.includes('champions league')) return 'Champions League';
            if (desc.includes('fifa club world cup') || desc.includes('mundial de clubes') || desc.includes('intercontinental')) return 'Mundial de Clubes';
            if (desc.includes('supercopa de espa√±a')) return 'Supercopa de Espa√±a';
            if (desc.includes('copa del rey')) return 'Copa del Rey';
            
            // --- FEMENINO ---
            // Detecta "Primera Divisi√≥n" aunque venga con may√∫sculas
            if (desc.includes('primera divisi√≥n') || desc.includes('primera division') || desc.includes('liga f')) return 'Liga F';
            
            // Detecta Champions Femenina
            if ((desc.includes('women') && desc.includes('champions')) || desc.includes('uwcl')) return 'UWCL';
            
            // Copas
            if (desc.includes('copa de la reina')) return 'Copa de la Reina';
            if (desc.includes('supercopa') && (desc.includes('femenina') || desc.includes('women'))) return 'Supercopa Femenina';

            // --- OTROS ---
            if (desc.includes('amistoso')) return 'Amistoso';

            return null;
        }
       // AHORA ACEPTA 'teamContext' PARA SABER QU√â EQUIPO ES DURANTE LA PRECARGA
        function parseICalData(icalData, teamContext = currentTeam) {
            const events = [];
            const normalizedData = icalData.replace(/\r\n /g, '').replace(/\r\n/g, '\n').replace(/\r/g, '\n');
            const lines = normalizedData.split('\n');
            
            let currentEvent = null;
            
            for (let i = 0; i < lines.length; i++) {
                let line = lines[i];
                while (i + 1 < lines.length && (lines[i + 1].startsWith(' ') || lines[i + 1].startsWith('\t'))) {
                    i++;
                    line += lines[i].substring(1);
                }
                line = line.trim();
                if (!line) continue;
                
                if (line === 'BEGIN:VEVENT') {
                    currentEvent = { id: generateId() };
                } else if (line === 'END:VEVENT' && currentEvent) {
                    if (currentEvent.summary && currentEvent.start) {
                        currentEvent.opponent = extractOpponent(currentEvent.summary);
                        currentEvent.venue = detectVenue(currentEvent.summary, currentEvent.location);
                        
                        // 1. Detecci√≥n por Descripci√≥n (Plan A)
                        let realComp = mapIcsCompetition(currentEvent.description);
                        
                        // CORRECCI√ìN AUTOM√ÅTICA USANDO teamContext
                        if (teamContext === 'femenino' && realComp) {
                            if (realComp === 'Champions League') realComp = 'UWCL';
                            if (realComp === 'Liga EA Sports') realComp = 'Liga F';
                            if (realComp === 'Copa del Rey') realComp = 'Copa de la Reina';
                            if (realComp === 'Supercopa de Espa√±a') realComp = 'Supercopa Femenina';
                        }
                        
                        if (realComp) {
                            currentEvent.competition = realComp; 
                            currentEvent.possibleCompetition = realComp;
                        } else {
                            // 2. Detecci√≥n por T√≠tulo (Plan B)
                            const summaryLower = currentEvent.summary.toLowerCase();
                            let detectedComp = null;
                            
                             if (summaryLower.includes('champions') || summaryLower.includes('uwcl')) {
                                 detectedComp = teamContext === 'femenino' ? 'UWCL' : 'Champions League';
                             }
                             else if (summaryLower.includes('copa')) {
                                 detectedComp = teamContext === 'femenino' ? 'Copa de la Reina' : 'Copa del Rey';
                             }
                             else if (summaryLower.includes('liga')) {
                                 detectedComp = teamContext === 'femenino' ? 'Liga F' : 'Liga EA Sports';
                             }
                             else if (summaryLower.includes('supercopa')) {
                                 detectedComp = teamContext === 'femenino' ? 'Supercopa Femenina' : 'Supercopa de Espa√±a';
                             }
                             
                             // Fallback por defecto
                             if (!detectedComp && teamContext === 'femenino') {
                                 detectedComp = 'Liga F';
                             }
                             
                             if (detectedComp) {
                                 currentEvent.competition = detectedComp;
                             }
                             
                             currentEvent.possibleCompetition = detectedComp || 'Partido Oficial';
                        }
                        
                        events.push(currentEvent);
                    }
                    currentEvent = null;
                } else if (currentEvent) {
                    const colonIndex = line.indexOf(':');
                    if (colonIndex > 0) {
                        let key = line.substring(0, colonIndex);
                        let value = line.substring(colonIndex + 1);
                        if (key.includes(';')) key = key.split(';')[0];
                        
                        if (key === 'SUMMARY') currentEvent.summary = value.replace(/\\,/g, ',').replace(/\\;/g, ';').replace(/\\n/g, ' ');
                        else if (key === 'DTSTART') currentEvent.start = parseICalDate(value);
                        else if (key === 'LOCATION') currentEvent.location = value.replace(/\\,/g, ',').replace(/\\;/g, ';');
                        else if (key === 'DESCRIPTION') currentEvent.description = value.replace(/\\,/g, ',').replace(/\\;/g, ';').replace(/\\n/g, ' ');
                    }
                }
            }
            return events.filter(e => e.start).sort((a, b) => a.start - b.start);
        }
        
        function parseICalDate(dateStr) {
            if (!dateStr) return null;
            dateStr = dateStr.trim();
            try {
                const year = parseInt(dateStr.substring(0, 4));
                const month = parseInt(dateStr.substring(4, 6)) - 1;
                const day = parseInt(dateStr.substring(6, 8));
                if (dateStr.includes('T')) {
                    const hour = parseInt(dateStr.substring(9, 11)) || 0;
                    const minute = parseInt(dateStr.substring(11, 13)) || 0;
                    if (dateStr.endsWith('Z')) return new Date(Date.UTC(year, month, day, hour, minute));
                    return new Date(year, month, day, hour, minute);
                }
                return new Date(year, month, day, 21, 0);
            } catch (e) { return null; }
        }
        
        function extractOpponent(summary) {
            if (!summary) return 'Rival';
            let opponent = summary
                .replace(/real madrid c\.?f\.?/gi, '')
                .replace(/real madrid/gi, '')
                .replace(/vs\.?/gi, '')
                .replace(/\s*-\s*/g, ' ')
                .trim();
            const words = opponent.split(/\s+/).filter(w => w.length > 1);
            return words.length > 4 ? words.slice(0, 3).join(' ') : words.join(' ');
        }
        
        function detectVenue(summary, location) {
            const s = ((summary || '') + ' ' + (location || '')).toLowerCase();
            if (s.includes('bernab√©u') || s.includes('di st√©fano') || s.includes('valdebebas')) return 'local';
            if (summary && summary.toLowerCase().trim().startsWith('real madrid')) return 'local';
            return 'visitante';
        }
        
        function switchCalendarView(mode) {
            calendarViewMode = mode;
            document.getElementById('cal-view-list').className = mode === 'list' ? 
                'px-3 py-1.5 text-sm rounded-md font-medium transition bg-slate-800 text-white' : 
                'px-3 py-1.5 text-sm rounded-md font-medium transition text-gray-600 hover:bg-gray-100';
            document.getElementById('cal-view-month').className = mode === 'month' ? 
                'px-3 py-1.5 text-sm rounded-md font-medium transition bg-slate-800 text-white' : 
                'px-3 py-1.5 text-sm rounded-md font-medium transition text-gray-600 hover:bg-gray-100';
            
            const timeFilters = document.getElementById('cal-time-filters');
            const monthNav = document.getElementById('cal-month-nav');
            
            if (mode === 'list') {
                timeFilters.classList.remove('hidden');
                monthNav.classList.add('hidden');
            } else {
                timeFilters.classList.add('hidden');
                monthNav.classList.remove('hidden');
            }
            
            renderCalendar();
        }
        
        function changeCalendarMonth(delta) {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + delta);
            renderCalendar();
        }

        function filterCalendar(comp) {
            currentCalendarFilter = comp;
            document.querySelectorAll('.cal-filter').forEach(btn => btn.classList.remove('bg-slate-800', 'text-white'));
            event.target.classList.add('bg-slate-800', 'text-white');
            renderCalendar();
        }
        
        function filterCalendarTime(time) {
            currentTimeFilter = time;
            document.querySelectorAll('.time-filter').forEach(btn => {
                btn.classList.remove('bg-slate-800', 'text-white');
                btn.classList.add('bg-gray-200', 'text-gray-700');
            });
            event.target.classList.remove('bg-gray-200', 'text-gray-700');
            event.target.classList.add('bg-slate-800', 'text-white');
            renderCalendar();
        }
        
        function renderCalendar() {
            hideRegisteredMatches = document.getElementById('hide-registered-matches').checked;
            if (calendarViewMode === 'list') {
                renderCalendarList();
            } else {
                renderCalendarMonth();
            }
        }
        
        function renderCalendarList() {
            const container = document.getElementById('calendar-container');
            const now = new Date();
            now.setHours(23, 59, 59, 999);
            
            const matches = getData('matches');
            const registeredEventIds = matches.map(m => m.calendarEventId);
            
            let events = [...calendarEvents];
            
            if (hideRegisteredMatches) {
                events = events.filter(e => !registeredEventIds.includes(e.id));
            }

            if (currentCalendarFilter) {
                 events = events.filter(e => {
                     const isReg = registeredEventIds.includes(e.id);
                     if (isReg) {
                         const m = matches.find(m => m.calendarEventId === e.id);
                         return m.competition === currentCalendarFilter;
                     } else {
                         return false; // Don't show unregistered matches when filtering by specific comp
                     }
                 });
            }
            
            if (currentTimeFilter === 'past') events = events.filter(e => e.start <= now);
            else if (currentTimeFilter === 'future') events = events.filter(e => e.start > now);
            
            if (events.length === 0) {
                container.innerHTML = '<div class="text-center py-12 text-gray-500">No hay partidos.</div>';
                return;
            }
            
            container.innerHTML = events.map(event => {
                const isPast = event.start <= now;
                const isRegistered = registeredEventIds.includes(event.id);
                const registeredMatch = isRegistered ? matches.find(m => m.calendarEventId === event.id) : null;
                
                const dateStr = event.start.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
                const timeStr = event.start.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
                
                // Logic: Only show real competition name and color if registered. Otherwise default/grey.
               // L√≥gica NUEVA: Mostrar competici√≥n si est√° registrada O si la hemos detectado en el calendario
                let compName = event.competition || 'Pendiente de registro'; // Aqu√≠ est√° la clave: usa la del evento si existe
                let compColorClass = 'bg-gray-200 text-gray-600';
                let borderColorClass = 'border-gray-300';

                // Si ya lo registraste, priorizamos lo que t√∫ guardaste
                if (isRegistered) {
                    compName = registeredMatch.competition;
                }

                // Buscamos los colores para esa competici√≥n (sea detectada o registrada)
                const compObj = Object.values(COMPETICIONES_ACTUALES).find(c => c.nombre === compName);
                if (compObj) {
                    compColorClass = compObj.color;
                    borderColorClass = compObj.borderColor;
                } else if (compName === 'Amistoso') {
                    // Un colorcito especial para amistosos
                    compColorClass = 'bg-yellow-100 text-yellow-800 border border-yellow-200';
                }

                const venueText = isRegistered ? (registeredMatch.venue === 'local' ? 'üè† Local' : (registeredMatch.venue === 'neutral' ? 'üèüÔ∏è Neutral' : '‚úàÔ∏è Visitante')) 
                                               : (event.venue === 'local' ? 'üè† Local' : (event.venue === 'neutral' ? 'üèüÔ∏è Neutral' : '‚úàÔ∏è Visitante'));
                
                return `
                    <div class="bg-white rounded-xl shadow-sm p-4 match-card ${borderColorClass} ${isRegistered ? 'match-registered' : ''}" 
                         ${isPast && !isRegistered ? `onclick="selectCalendarFixture('${event.id}')"` : ''} 
                         style="cursor: ${isPast && !isRegistered ? 'pointer' : 'default'}">
                        <div class="flex flex-col md:flex-row md:items-center gap-3">
                            <div class="flex-1">
                                <div class="flex flex-wrap items-center gap-2 mb-2">
                                    <span class="${compColorClass} px-2 py-0.5 rounded text-xs font-medium">${compName}</span>
                                    <span class="text-xs text-gray-500">${venueText}</span>
                                    ${isRegistered ? '<span class="text-xs bg-gray-200 text-gray-700 px-2 py-0.5 rounded">‚úÖ Registrado</span>' : 
                                      (isPast ? '<span class="text-xs bg-green-100 text-green-700 px-2 py-0.5 rounded">üìù Clic para registrar</span>' : '')}
                                </div>
                                <h4 class="font-semibold text-gray-800">${event.opponent}</h4>
                                <p class="text-sm text-gray-500">üèüÔ∏è ${event.location || 'Estadio'}</p>
                            </div>
                            <div class="text-right">
                                <p class="font-medium text-gray-800">${dateStr}</p>
                                <p class="text-amber-600 font-semibold">${timeStr}</p>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function renderCalendarMonth() {
            const container = document.getElementById('calendar-container');
            const matches = getData('matches');
            const registeredEventIds = matches.map(m => m.calendarEventId);
            
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            document.getElementById('current-month-display').textContent = new Date(year, month).toLocaleDateString('es-ES', { month: 'long', year: 'numeric' }).toUpperCase();
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            
            // Start on Monday (adjust so Sunday is 6, Monday is 0)
            let startDayOfWeek = firstDay.getDay() - 1;
            if (startDayOfWeek < 0) startDayOfWeek = 6;
            
            const totalDays = lastDay.getDate();
            
            let gridHtml = `
                <div class="calendar-grid bg-white rounded-xl overflow-hidden shadow-sm">
                    <div class="calendar-day-header">LUN</div>
                    <div class="calendar-day-header">MAR</div>
                    <div class="calendar-day-header">MIE</div>
                    <div class="calendar-day-header">JUE</div>
                    <div class="calendar-day-header">VIE</div>
                    <div class="calendar-day-header">SAB</div>
                    <div class="calendar-day-header">DOM</div>
            `;
            
            // Empty cells for days before start
            for (let i = 0; i < startDayOfWeek; i++) {
                gridHtml += `<div class="calendar-day other-month"></div>`;
            }
            
            const now = new Date();
            now.setHours(0, 0, 0, 0);

            for (let day = 1; day <= totalDays; day++) {
                const currentDate = new Date(year, month, day);
                currentDate.setHours(0, 0, 0, 0);
                
                const isToday = currentDate.getTime() === now.getTime();
                
                // Find events for this day
                const daysEvents = calendarEvents.filter(e => {
                    const eDate = new Date(e.start);
                    return eDate.getDate() === day && eDate.getMonth() === month && eDate.getFullYear() === year;
                });
                
                let eventsHtml = '';
                daysEvents.forEach(e => {
                    const isRegistered = registeredEventIds.includes(e.id);
                    if (hideRegisteredMatches && isRegistered) return;

                    const isPast = e.start <= new Date();
                    
                    // 1. Estilo Base (Neutro)
                    let style = 'background-color: #e5e7eb; color: #374151;'; 
                    let title = e.opponent;

                    // 2. Determinar Competici√≥n (Registrada > Detectada > Nada)
                    let compName = e.competition; 
                    if (isRegistered) {
                        const m = matches.find(m => m.calendarEventId === e.id);
                        compName = m.competition;
                    }

                    // 3. Aplicar Colores (Mismos HEX que en CSS)
                    if (compName) {
                         const compObj = Object.values(COMPETICIONES_ACTUALES).find(c => c.nombre === compName);
                         
                         if (compObj) {
                             // L√≥gica para asignar colores seg√∫n el tipo de competici√≥n
                             const id = compObj.id;
                             if (id.includes('liga') || id === 'liga-f') style = 'background-color: #dbeafe; color: #1e40af;';
                             else if (id.includes('champions') || id === 'uwcl') style = 'background-color: #ede9fe; color: #5b21b6;';
                             else if (id.includes('copa')) style = 'background-color: #d1fae5; color: #065f46;';
                             else if (id.includes('mundial')) style = 'background-color: #fef3c7; color: #92400e;';
                             else if (id.includes('supercopa')) style = 'background-color: #fee2e2; color: #991b1b;';
                         } 
                         else if (compName === 'Amistoso') {
                             style = 'background-color: #fef9c3; color: #854d0e;'; // Amarillo suave para amistosos
                         }
                    }

                    // 4. Si est√° registrado, a√±adir tachado y opacidad (pero manteniendo el color de fondo)
                    if (isRegistered) {
                         style += ' text-decoration: line-through; opacity: 0.7; border: 1px solid rgba(0,0,0,0.1);';
                    }

                    const action = (isPast && !isRegistered) ? `onclick="selectCalendarFixture('${e.id}')"` : '';
                    
                    eventsHtml += `<div class="cal-event-dot" style="${style}" ${action} title="${title}">
                        ${e.start.getHours()}:${e.start.getMinutes().toString().padStart(2,'0')} ${e.opponent}
                    </div>`;
                });
                
                gridHtml += `
                    <div class="calendar-day ${isToday ? 'today' : ''}">
                        <span class="day-number">${day}</span>
                        ${eventsHtml}
                    </div>
                `;
            }
            
            gridHtml += '</div>';
            container.innerHTML = gridHtml;
        }

        // ==========================================
        // MATCH HELPERS
        // ==========================================
        
        function calculateMatchOutcome(result, venue) {
            if (!result || !result.includes('-')) return null;
            const parts = result.replace('*','').split('-');
            const homeGoals = parseInt(parts[0]);
            const awayGoals = parseInt(parts[1]);
            if (isNaN(homeGoals) || isNaN(awayGoals)) return null;
            
            if (homeGoals === awayGoals) return 'empate';
            
            if (venue === 'local') return homeGoals > awayGoals ? 'victoria' : 'derrota';
            if (venue === 'visitante') return awayGoals > homeGoals ? 'victoria' : 'derrota';
            
            return homeGoals > awayGoals ? 'victoria' : 'derrota';
        }

        function calculateAutoMVP(playerStats) {
            if (!playerStats || playerStats.length === 0) return '';
            let bestPlayer = null;
            let highestRating = -1;
            playerStats.forEach(ps => {
                if (ps.rating !== null && ps.rating !== "" && ps.rating > highestRating) {
                    highestRating = ps.rating;
                    bestPlayer = ps.playerId;
                }
            });
            return bestPlayer || '';
        }

        function getResultClass(outcome) {
            if (outcome === 'victoria') return 'result-win';
            if (outcome === 'empate') return 'result-draw';
            if (outcome === 'derrota') return 'result-loss';
            return 'bg-gray-100';
        }

        function getRatingColor(rating) {
            if (rating === '-' || rating === null) return 'text-gray-400';
            const num = parseFloat(rating);
            if (num >= 8) return 'text-emerald-600';
            if (num >= 6) return 'text-blue-600';
            if (num >= 5) return 'text-amber-600';
            return 'text-red-600';
        }

        // ==========================================
        // MATCH DISPLAY & ACTIONS
        // ==========================================
        // Funci√≥n para obtener el color exacto seg√∫n la escala solicitada
        function getTeamRatingColor(rating) {
            if (rating === '-' || !rating) return '#6b7280'; // Gris por defecto
            const num = parseFloat(rating);
            
            if (num < 5) return '#dc0c00';      // Rojo
            if (num >= 5 && num < 6) return '#ed7e07'; // Naranja
            if (num >= 6 && num < 7) return '#d9af00'; // Amarillo
            if (num >= 7 && num < 8) return '#00c424'; // Verde
            if (num >= 8) return '#00adc4';     // Azul
            
            return '#6b7280';
        }
        function renderMatches(matchesData = null) { // 1. Aceptamos un dato opcional
             // 2. Si nos pasan datos (del buscador), usamos esos. Si no, cargamos todos.
            let matches = matchesData || getData('matches');
            const players = getPlayers();
            const container = document.getElementById('matches-list');
            const noMatches = document.getElementById('no-matches');
            
            const competitionFilter = document.getElementById('filter-competition').value;
            const venueFilter = document.getElementById('filter-venue').value;
            const resultFilter = document.getElementById('filter-result').value;
            
            if (competitionFilter) matches = matches.filter(m => m.competition === competitionFilter);
            if (venueFilter) matches = matches.filter(m => m.venue === venueFilter);
            if (resultFilter) matches = matches.filter(m => m.outcome === resultFilter);
            
            if (matches.length === 0) {
                container.innerHTML = '';
                noMatches.classList.remove('hidden');
                return;
            }
            
            noMatches.classList.add('hidden');
            matches.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            container.innerHTML = matches.map(match => {
                const mvpPlayer = players.find(p => p.id === match.mvp);
                const totalGoals = match.playerStats.reduce((sum, ps) => sum + (ps.goals || 0), 0);
                const outcomeClass = getResultClass(match.outcome);
                const compColor = COMPETICIONES_ACTUALES[match.competition]?.color || 'bg-gray-200';
                
                // C√°lculo de nota media
                let totalRating = 0;
                let ratedCount = 0;
                match.playerStats.forEach(ps => {
                    if (ps.rating !== null && ps.rating !== "" && ps.rating !== undefined) {
                        totalRating += parseFloat(ps.rating);
                        ratedCount++;
                    }
                });
                const teamAvg = ratedCount > 0 ? (totalRating / ratedCount).toFixed(2) : '-';
                const ratingColor = getTeamRatingColor(teamAvg);

                return `
                    <div class="card bg-white rounded-xl shadow-sm p-4">
                        <div class="flex flex-col sm:flex-row sm:items-center gap-4">
                            <div class="flex-1">
                                <div class="flex flex-wrap items-center gap-2 mb-2">
                                    <span class="text-gray-500 text-sm">${formatDate(match.date)}</span>
                                    <span class="${compColor} px-2 py-0.5 rounded text-xs font-medium">${match.competition}</span>
                                    <span class="text-xs text-gray-500">${match.venue}</span>
                                    <span class="text-xs text-gray-500">${match.round}</span>
                                    ${match.result ? `<span class="${outcomeClass} px-2 py-0.5 rounded text-sm font-semibold">${match.result}</span>` : ''}
                                </div>
                                <h3 class="text-lg font-bold text-gray-800">vs ${match.opponent}</h3>
                                
                                <div class="flex flex-wrap gap-3 text-sm text-gray-600 mt-2 items-center">
                                    <span>‚öΩ ${totalGoals} goles</span>
                                    
                                    ${mvpPlayer ? `<span class="text-amber-600 border-l border-gray-300 pl-3">üèÜ MVP: ${mvpPlayer.apodo || mvpPlayer.nombre}</span>` : ''}
                                    
                                    <span class="border-l border-gray-300 pl-3 font-bold" style="color: ${ratingColor}">
                                        üìä Nota Equipo: ${teamAvg}
                                    </span>
                                </div>

                            </div>
                            <div class="flex gap-2">
                                <button onclick="viewMatchDetails('${match.id}')" class="px-3 py-1.5 text-sm bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200">
                                    üëÅÔ∏è Ver
                                </button>
                                <button onclick="editMatch('${match.id}')" class="px-3 py-1.5 text-sm bg-blue-50 text-blue-600 rounded-lg hover:bg-blue-100">
                                    ‚úèÔ∏è Editar
                                </button>
                                <button onclick="deleteMatch('${match.id}')" class="px-3 py-1.5 text-sm bg-red-50 text-red-600 rounded-lg hover:bg-red-100">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        function viewMatchDetails(matchId) {
            const matches = getData('matches');
            const players = getPlayers();
            const match = matches.find(m => m.id === matchId);
            if (!match) return;
            
            const modal = document.getElementById('match-detail-modal');
            const content = document.getElementById('match-detail-content');
            const title = document.getElementById('match-detail-title');
            
            title.textContent = `vs ${match.opponent}`;
            
            // Auto Analysis
            const mvpPlayer = players.find(p => p.id === match.mvp);
            const mvpStats = match.playerStats.find(ps => ps.playerId === match.mvp);
            let analysisText = "";
            
            if (match.outcome === 'victoria') analysisText += `El Real Madrid logr√≥ una victoria`;
            else if (match.outcome === 'derrota') analysisText += `El Real Madrid sufri√≥ una derrota`;
            else analysisText += `El partido termin√≥ en empate`;
            
            analysisText += ` contra ${match.opponent} con un resultado de ${match.result}.`;
            
            if (mvpPlayer) {
                analysisText += ` El jugador m√°s destacado fue <strong>${mvpPlayer.nombre} ${mvpPlayer.apellido}</strong>`;
                if (mvpStats && mvpStats.rating) analysisText += ` con una nota de <span class="${getRatingColor(mvpStats.rating)} font-bold">${mvpStats.rating}</span>.`;
                else analysisText += ".";
            }

            content.innerHTML = `
                <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6 text-sm text-blue-900">
                    ü§ñ <strong>An√°lisis Autom√°tico:</strong> ${analysisText}
                </div>
                <div class="mb-4 flex gap-4 text-sm text-gray-600">
                    <p><strong>Estadio:</strong> ${match.stadium}</p>
                    <p><strong>Competici√≥n:</strong> ${match.competition}</p>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm">
                        <thead class="bg-slate-700 text-white">
                            <tr>
                                <th class="px-3 py-2 text-left">Jugador</th>
                                <th class="px-3 py-2 text-center">Rol</th>
                                <th class="px-3 py-2 text-center">Nota</th>
                                <th class="px-3 py-2 text-center">Goles</th>
                                <th class="px-3 py-2 text-center">Asist</th>
                                <th class="px-3 py-2 text-center">Min</th>
                                <th class="px-3 py-2 text-center">T</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${match.playerStats.map(ps => {
                                const p = players.find(pl => pl.id === ps.playerId);
                                const isCoach = p && p.posicion === 'entrenador';
                                let cards = '';
                                if(ps.redCards > 0) cards = 'üü•';
                                else if(ps.yellowCards > 0) cards = ps.yellowCards === 1 ? 'üü®' : 'üü®üü®';
                                
                                const played = ps.played !== false; // Backwards compatibility for old records

                                return `
                                    <tr class="border-t">
                                        <td class="px-3 py-2 flex items-center gap-2">
                                            ${match.mvp === ps.playerId ? 'üèÜ' : ''}
                                            ${p ? (p.apodo || p.nombre + ' ' + p.apellido) : 'Unknown'}
                                        </td>
                                        <td class="px-3 py-2 text-center">
                                            ${isCoach ? '<span class="text-xs text-gray-500">Staff</span>' : 
                                              (!played ? '<span class="text-xs text-gray-400">No jug√≥</span>' : 
                                              (ps.isStarter === true || ps.isStarter === 'true' ? '<span class="starter-badge">T</span>' : '<span class="sub-badge">S</span>'))}
                                        </td>
                                        <td class="px-3 py-2 text-center font-bold ${getRatingColor(ps.rating)}">${ps.rating !== null && ps.rating !== undefined && ps.rating !== "" ? ps.rating : '-'}</td>
                                        <td class="px-3 py-2 text-center">${isCoach ? '-' : (ps.goals || 0)}</td>
                                        <td class="px-3 py-2 text-center">${isCoach ? '-' : (ps.assists || 0)}</td>
                                        <td class="px-3 py-2 text-center">${isCoach ? '-' : (ps.minutes || 0)}</td>
                                        <td class="px-3 py-2 text-center">${cards}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            modal.classList.add('active');
        }
        
        function deleteMatch(matchId) {
            if (!confirm('¬øEst√°s seguro de eliminar este partido?')) return;
            
            let matches = getData('matches');
            const matchToDelete = matches.find(m => m.id === matchId);
            if (!matchToDelete) return;
            
            const compName = matchToDelete.competition;
            matches = matches.filter(m => m.id !== matchId);
            saveData('matches', matches);
            
            recalculateCompetitionState(compName);
            
            renderMatches();
            renderCalendar(); 
        }

        function editMatch(matchId) {
            const matches = getData('matches');
            const match = matches.find(m => m.id === matchId);
            if (!match) return;
            
            // Ordenar jugadores (igual que antes)
            const players = getActivePlayers();
            if (currentTeam === 'masculino' || currentTeam === 'femenino') {
                const orderList = currentTeam === 'masculino' ? CUSTOM_ORDER_MASCULINO : CUSTOM_ORDER_FEMENINO;
                players.sort((a, b) => {
                    const idxA = orderList.indexOf(a.id);
                    const idxB = orderList.indexOf(b.id);
                    if (idxA === -1 && idxB === -1) return 0;
                    if (idxA === -1) return 1;
                    if (idxB === -1) return -1;
                    return idxA - idxB;
                });
            }

            const modal = document.getElementById('edit-match-modal');
            const subtitle = document.getElementById('edit-match-subtitle');
            const content = document.getElementById('edit-match-content');
            
            document.getElementById('edit-match-id').value = match.id;
            subtitle.textContent = `vs ${match.opponent} - ${match.round}`;
            
            // Detectar si hubo penaltis guardados previamente (si el resultado tiene asterisco o outcome manual)
            const hadPenalties = match.result.includes('*') || (match.outcome !== 'empate' && match.result.split('-')[0] === match.result.split('-')[1]);
            
            content.innerHTML = `
                <div class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Fecha</label>
                            <input type="date" id="edit-date" value="${match.date}" readonly class="w-full px-3 py-2 border rounded-lg bg-gray-100 text-gray-600 cursor-not-allowed">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Rival</label>
                            <input type="text" id="edit-opponent" value="${match.opponent}" readonly class="w-full px-3 py-2 border rounded-lg bg-gray-100 text-gray-600 cursor-not-allowed">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-1">Resultado</label>
                            <input type="text" id="edit-result" value="${match.result.replace('*','')}" class="w-full px-3 py-2 border rounded-lg focus:ring-2 focus:ring-amber-500 font-bold text-gray-800">
                        </div>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Estadio</label>
                        <input type="text" id="edit-stadium" value="${match.stadium}" readonly class="w-full px-3 py-2 border rounded-lg bg-gray-100 text-gray-600 cursor-not-allowed">
                    </div>

                    <div class="bg-orange-50 p-3 rounded-lg border border-orange-200">
                        <label class="flex items-center gap-2 cursor-pointer mb-2">
                            <input type="checkbox" id="edit-chk-penalties" class="w-4 h-4 text-orange-600" onchange="document.getElementById('edit-penalty-outcome').classList.toggle('hidden')" ${hadPenalties ? 'checked' : ''}>
                            <span class="text-sm font-bold text-orange-800">Hubo Tanda de Penaltis</span>
                        </label>
                        <div id="edit-penalty-outcome" class="${hadPenalties ? '' : 'hidden'} ml-6 flex gap-4">
                            <label class="flex items-center gap-1 cursor-pointer">
                                <input type="radio" name="edit-penalties-result" value="win" class="text-green-600" ${match.outcome === 'victoria' && hadPenalties ? 'checked' : ''}>
                                <span class="text-sm text-green-700 font-bold">Ganamos</span>
                            </label>
                            <label class="flex items-center gap-1 cursor-pointer">
                                <input type="radio" name="edit-penalties-result" value="loss" class="text-red-600" ${match.outcome === 'derrota' && hadPenalties ? 'checked' : ''}>
                                <span class="text-sm text-red-700 font-bold">Perdimos</span>
                            </label>
                        </div>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-800 mb-3">Estad√≠sticas de Jugadores</h4>
                        <div class="mb-2 text-sm text-amber-700 bg-amber-50 p-2 rounded">‚ö†Ô∏è Deben seleccionarse exactamente 11 titulares (sin contar al entrenador).</div>
                        <div id="edit-players-stats" class="space-y-3 h-[50vh] overflow-y-auto"></div>
                    </div>
                </div>
            `;
            
            // Renderizar lista de jugadores (Igual que antes)
            const statsContainer = document.getElementById('edit-players-stats');
            statsContainer.innerHTML = players.map(player => {
                const ps = match.playerStats.find(s => s.playerId === player.id);
                const played = ps ? (ps.played !== false) : false;
                const isCoach = player.posicion === 'entrenador';
                const isStarter = ps ? (ps.isStarter === true || ps.isStarter === 'true') : false;
                
                return `
                <div class="bg-gray-50 rounded-lg p-3" data-player-id="${player.id}">
                    <div class="flex items-center gap-3 mb-3">
                        <img src="${player.foto}" class="player-photo-xs" onerror="this.src='https://via.placeholder.com/32x32?text=${player.dorsal}'">
                        <div class="flex-1">
                        <span class="font-medium text-gray-800">${player.apodo || player.nombre + ' ' + player.apellido}</span>
                            <span class="text-gray-500 text-sm ml-1">${player.dorsal === "DT" ? "DT" : "#" + player.dorsal}</span>
                        </div>
                         ${!isCoach ? `
                         <label class="flex items-center gap-1 text-sm cursor-pointer">
                            <input type="checkbox" class="chk-starter w-4 h-4 text-green-600" onchange="handleRoleCheck(this, 'starter')" ${played && isStarter ? 'checked' : ''}>
                            <span>Titular</span>
                         </label>
                         <label class="flex items-center gap-1 text-sm cursor-pointer">
                            <input type="checkbox" class="chk-sub w-4 h-4 text-blue-600" onchange="handleRoleCheck(this, 'sub')" ${played && !isStarter ? 'checked' : ''}>
                            <span>Suplente</span>
                         </label>
                         ` : `<span class="text-xs font-bold text-gray-500 bg-gray-200 px-2 py-1 rounded">Staff T√©cnico</span>`}
                    </div>
                    <div class="player-performance-inputs grid grid-cols-2 md:grid-cols-4 gap-2" style="display: ${played || isCoach ? 'grid' : 'none'}">
                        <div><label class="block text-xs text-gray-500 mb-1">Nota</label><input type="number" class="stat-rating w-full px-2 py-1 border rounded text-sm" min="0" max="10" step="0.25" value="${ps?.rating !== null && ps?.rating !== undefined ? ps.rating : ''}" placeholder="‚Äì"></div>
                        <div><label class="block text-xs text-gray-500 mb-1">Goles</label>${!isCoach ? `<input type="number" class="stat-goals w-full px-2 py-1 border rounded text-sm" min="0" value="${ps?.goals || 0}">` : `<span class="block text-center text-gray-400 mt-1">-</span>`}</div>
                        <div><label class="block text-xs text-gray-500 mb-1">Asist.</label>${!isCoach ? `<input type="number" class="stat-assists w-full px-2 py-1 border rounded text-sm" min="0" value="${ps?.assists || 0}">` : `<span class="block text-center text-gray-400 mt-1">-</span>`}</div>
                        <div><label class="block text-xs text-gray-500 mb-1">Minutos</label>${!isCoach ? `<input type="number" class="stat-minutes w-full px-2 py-1 border rounded text-sm" min="0" max="120" value="${ps?.minutes || 90}">` : `<span class="block text-center text-gray-400 mt-1">-</span>`}</div>
                    </div>
                     <div class="grid grid-cols-2 gap-2 mt-2 pt-2 border-t border-gray-200">
                        <div><label class="block text-xs text-gray-500 mb-1">üü® Amarillas</label><input type="number" class="stat-yellow w-full px-2 py-1 border rounded text-sm" min="0" max="2" value="${ps?.yellowCards || 0}"></div>
                        <div><label class="block text-xs text-gray-500 mb-1">üü• Rojas</label><input type="number" class="stat-red w-full px-2 py-1 border rounded text-sm" min="0" max="1" value="${ps?.redCards || 0}"></div>
                    </div>
                </div>`;
            }).join('');
            
            modal.classList.add('active');
        }

        document.getElementById('edit-match-form').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const matchId = document.getElementById('edit-match-id').value;
            const matches = getData('matches');
            const matchIndex = matches.findIndex(m => m.id === matchId);
            if (matchIndex === -1) return;
            const match = matches[matchIndex];
            
            // 1. Recoger datos de jugadores (C√≥digo est√°ndar)
            const statsContainer = document.getElementById('edit-players-stats');
            const playerStats = [];
            let starterCount = 0;

            statsContainer.querySelectorAll('[data-player-id]').forEach(row => {
                const isCoach = row.querySelector('.stat-goals') === null;
                const starterChk = row.querySelector('.chk-starter');
                const subChk = row.querySelector('.chk-sub');
                let played = isCoach ? true : ((starterChk && starterChk.checked) || (subChk && subChk.checked));
                let isStarter = (starterChk && starterChk.checked);
                let yellow = parseInt(row.querySelector('.stat-yellow').value) || 0;
                let red = parseInt(row.querySelector('.stat-red').value) || 0;
                if (yellow >= 2) red = 1;

                if (played || yellow > 0 || red > 0) {
                    let rating = null, goals = 0, assists = 0, minutes = 0;
                    if (played) {
                        if (!isCoach && isStarter) starterCount++;
                        const ratingInput = row.querySelector('.stat-rating').value;
                        rating = (ratingInput === "") ? null : parseFloat(ratingInput);
                        goals = isCoach ? 0 : (parseInt(row.querySelector('.stat-goals').value) || 0);
                        assists = isCoach ? 0 : (parseInt(row.querySelector('.stat-assists').value) || 0);
                        minutes = isCoach ? 0 : (parseInt(row.querySelector('.stat-minutes').value) || 0);
                    }
                    playerStats.push({ playerId: row.dataset.playerId, isStarter, rating, goals, assists, minutes, yellowCards: yellow, redCards: red, played });
                }
            });
            
            if (starterCount !== 11) {
                alert(`‚ö†Ô∏è Se han seleccionado ${starterCount} titulares. Deben ser 11.`);
                return;
            }

            // 2. Calcular Resultado y Desenlace (Autom√°tico)
            let result = document.getElementById('edit-result').value.trim();
            let outcome = calculateMatchOutcome(result, match.venue);
            
            // L√≥gica de Penaltis en Edici√≥n
            const chkPenalties = document.getElementById('edit-chk-penalties');
            if (chkPenalties && chkPenalties.checked) {
                const radioWin = document.querySelector('input[name="edit-penalties-result"][value="win"]');
                const radioLoss = document.querySelector('input[name="edit-penalties-result"][value="loss"]');
                
                if (radioWin && radioWin.checked) outcome = 'victoria';
                if (radioLoss && radioLoss.checked) outcome = 'derrota';
                
                if (!result.includes('*')) result += '*'; // Marca visual de penaltis
            }

            // 3. Guardar Partido
            matches[matchIndex] = {
                ...match,
                result: result,
                outcome: outcome,
                mvp: calculateAutoMVP(playerStats),
                playerStats: playerStats,
                forceElimination: false // Limpiamos flags manuales antiguos
            };
            
            saveData('matches', matches);
            closeEditMatchModal();
            
            // 4. Recalcular Estado de Competici√≥n (CRUCIAL para el 0-4)
            recalculateCompetitionState(match.competition);
            
            // 5. Refrescar Vistas
            renderMatches();
            renderStats();
            renderCompetitionStatus();
            renderPrincipal();
            
            alert('‚úÖ Partido actualizado y estado recalculado.');
        });

        
        function closeEditMatchModal() {
            document.getElementById('edit-match-modal').classList.remove('active');
        }
        
        function closePlayerStatusModal() {
             document.getElementById('player-status-modal').classList.remove('active');
        }
        
        function closePlayerDetailsModal() {
             document.getElementById('player-details-modal').classList.remove('active');
        }
        
        function closeMatchDetailModal() {
             document.getElementById('match-detail-modal').classList.remove('active');
        }
        
        function openPlayerStatusModal(playerId) {
            const players = getPlayers();
            const player = players.find(p => p.id === playerId);
            if (!player) return;
            
            const modal = document.getElementById('player-status-modal');
            const content = document.getElementById('player-status-content');
            
            content.innerHTML = `
                <div class="text-center mb-6">
                    <img src="${player.foto}" class="player-photo mx-auto mb-3 border-4 ${player.estado === 'Activo' ? 'border-amber-400' : 'border-gray-300'}">
                    <h4 class="font-bold text-lg">${player.nombre} ${player.apellido}</h4>
                    <p class="text-gray-500">Estado actual: <strong>${player.estado}</strong></p>
                </div>
                <div class="space-y-3">
                    <button onclick="changePlayerStatus('${player.id}', 'Activo')" class="w-full py-3 rounded-lg font-medium bg-green-500 text-white">‚úÖ Activo</button>
                    <button onclick="changePlayerStatus('${player.id}', 'Inactivo')" class="w-full py-3 rounded-lg font-medium bg-gray-500 text-white">‚ùå Inactivo</button>
                </div>
            `;
            modal.classList.add('active');
        }
        
        function changePlayerStatus(playerId, newStatus) {
            updatePlayerState(playerId, newStatus);
            closePlayerStatusModal();
            renderPlayers();
        }
        // ==========================================
        // EXTRA ROUND LOGIC (CHAMPIONS/UWCL)
        // ==========================================

        let pendingExtraRoundComp = null;

        function checkExtraRoundTrigger(match) {
            // Identificadores del "√öltimo partido de liga"
            const MEN_LAST_LEAGUE = 'fase-liga-8'; // Masculino
            const WOMEN_LAST_LEAGUE = 'grupos-6';  // Femenino
            
            if (match.roundId === MEN_LAST_LEAGUE || match.roundId === WOMEN_LAST_LEAGUE) {
                pendingExtraRoundComp = match.competition;
                
                // Mostrar Modal
                document.getElementById('extra-round-modal').classList.add('active');
                return true; // Indica que se ha disparado el trigger (pausando el cierre)
            }
            return false;
        }

        function confirmExtraRound() {
            const playExtra = document.getElementById('chk-play-extra').checked;
            
            if (pendingExtraRoundComp) {
                const state = getCompetitionState();
                if (!state[pendingExtraRoundComp]) state[pendingExtraRoundComp] = {};
                
                // Guardamos la decisi√≥n: TRUE (juega) o FALSE (salta directo a octavos/cuartos)
                state[pendingExtraRoundComp].playsExtra = playExtra;
                saveCompetitionState(state);
            }
            
            document.getElementById('extra-round-modal').classList.remove('active');
            
            // Refrescar y salir como si hubiera terminado el registro normal
            resetNewMatchForm();
            renderCompetitionStatus();
            populateCompetitionSelect();
            alert('‚úÖ Partido registrado y configuraci√≥n de fase final actualizada.');
            showTab('partidos');
        }

        // ==========================================
        // UTILS
        // ==========================================
        
        function formatDate(dateStr) {
            return new Date(dateStr).toLocaleDateString('es-ES', { day: 'numeric', month: 'short', year: 'numeric' });
        }
        
        function calculateAge(birthdate) {
            const today = new Date();
            const birth = new Date(birthdate);
            let age = today.getFullYear() - birth.getFullYear();
            const m = today.getMonth() - birth.getMonth();
            if (m < 0 || (m === 0 && today.getDate() < birth.getDate())) age--;
            return age;
        }
        
        function capitalizeFirst(str) {
            return str.charAt(0).toUpperCase() + str.slice(1);
        }
        function switchLineupMode(mode) {
            const listContainer = document.getElementById('mode-list-container');
            const pitchContainer = document.getElementById('mode-pitch-container');
            const btnList = document.getElementById('btn-mode-list');
            const btnPitch = document.getElementById('btn-mode-pitch');

            if (mode === 'list') {
                listContainer.classList.remove('hidden');
                pitchContainer.classList.add('hidden');
                
                btnList.classList.add('bg-white', 'shadow', 'text-gray-800', 'font-medium');
                btnList.classList.remove('text-gray-500');
                
                btnPitch.classList.remove('bg-white', 'shadow', 'text-gray-800', 'font-medium');
                btnPitch.classList.add('text-gray-500');
            } else {
                listContainer.classList.add('hidden');
                pitchContainer.classList.remove('hidden');
                
                btnPitch.classList.add('bg-white', 'shadow', 'text-gray-800', 'font-medium');
                btnPitch.classList.remove('text-gray-500');
                
                btnList.classList.remove('bg-white', 'shadow', 'text-gray-800', 'font-medium');
                btnList.classList.add('text-gray-500');
                
                // Aqu√≠ llamaremos a renderizar la pizarra en la Fase 2
                // renderTacticalBoard(); 
            }
        }
        // ==========================================
        // TACTICAL BOARD LOGIC (FASE 2)
        // ==========================================

        let currentPitchPlayers = {}; // Guardar√° { "slot-0": playerId, "slot-1": playerId... }
        let currentSubstitutes = [];
        let currentFormation = '4-3-3'; // Formaci√≥n por defecto

        function updatePitchFormation() {
            currentFormation = document.getElementById('formation-select').value;
            renderTacticalBoard();
        }

        function renderTacticalBoard() {
            const slotsLayer = document.getElementById('pitch-slots-layer');
            const playersLayer = document.getElementById('pitch-players-layer');
            const coords = FORMACIONES[currentFormation];

            // 1. Pintar los huecos vac√≠os (Slots)
            slotsLayer.innerHTML = coords.map((pos, index) => `
                <div class="pitch-slot" 
                     id="slot-${index}"
                     style="top: ${pos.top}%; left: ${pos.left}%;"
                     ondragover="allowDrop(event)" 
                     ondrop="drop(event)">
                </div>
            `).join('');

            // 2. Repintar jugadores que ya estuvieran en el campo
            // (Si cambiamos de 4-3-3 a 4-4-2, intentamos mantenerlos en su sitio por √≠ndice)
            playersLayer.innerHTML = ''; // Limpiamos capa visual
            
            Object.keys(currentPitchPlayers).forEach(slotId => {
                const playerId = currentPitchPlayers[slotId];
                // Solo pintamos si el hueco existe en la nueva formaci√≥n
                const slotEl = document.getElementById(slotId);
                if (slotEl && playerId) {
                    const player = getPlayers().find(p => p.id === playerId);
                    if (player) {
                        renderPlayerOnPitch(player, slotId, playersLayer);
                    }
                } else {
                    // Si el hueco ya no existe (ej: pasamos de 3 delanteros a 2), 
                    // devolvemos al jugador al banquillo virtualmente (lo borramos del campo)
                    delete currentPitchPlayers[slotId];
                    renderBench(); // Actualizamos banquillo para que vuelva a aparecer
                }
            });
        }

        // Pinta la ficha redonda del jugador en el campo
        function renderPlayerOnPitch(player, slotId, container) {
            const slotEl = document.getElementById(slotId);
            if (!slotEl) return;

            const div = document.createElement('div');
            div.className = 'player-token';
            div.style.top = slotEl.style.top;
            div.style.left = slotEl.style.left;
            div.draggable = true;
            div.id = `token-${player.id}`;
            div.setAttribute('data-player-id', player.id);
            div.setAttribute('data-current-slot', slotId);
            
            // Eventos Drag para moverlo del campo a otro lado
            div.ondragstart = drag;

            div.innerHTML = `
                <img src="${player.foto}" onerror="this.src='https://via.placeholder.com/40x40?text=${player.dorsal}'">
                <div class="player-token-name">${player.apodo || player.apellido}</div>
            `;
            
            container.appendChild(div);
        }

        function renderBench() {
            const benchZone = document.getElementById('bench-zone');
            const subsZone = document.getElementById('subs-zone');
            
            // 1. Filtrar: Activos Y QUE NO SEAN ENTRENADOR
            const players = getActivePlayers().filter(p => p.posicion !== 'entrenador');
            
            // 2. Identificar qui√©n est√° d√≥nde
            const playersOnPitchIds = Object.values(currentPitchPlayers);
            
            // Disponibles: No est√°n en el campo NI en la lista de suplentes
            const availablePlayers = players.filter(p => 
                !playersOnPitchIds.includes(p.id) && !currentSubstitutes.includes(p.id)
            );
            
            // Suplentes: Est√°n en la lista de suplentes
            const subPlayers = players.filter(p => currentSubstitutes.includes(p.id));

            // Ordenar (Porteros primero, luego dorsal)
            const sorter = (a, b) => {
                if (a.posicion === 'portero') return -1;
                if (b.posicion === 'portero') return 1;
                return a.dorsal - b.dorsal;
            };
            availablePlayers.sort(sorter);
            subPlayers.sort(sorter);

            // 3. Helper para crear la ficha HTML
            const createToken = (p) => `
                <div class="player-token relative" 
                     style="position: relative; transform: none; width: 50px; height: 50px; margin: 4px;"
                     draggable="true" 
                     data-player-id="${p.id}"
                     ondragstart="drag(event)">
                    <img src="${p.foto}" onerror="this.src='https://via.placeholder.com/40x40?text=${p.dorsal}'">
                    <div class="player-token-name">${p.apodo || p.apellido}</div>
                </div>
            `;

            // 4. Renderizar en sus zonas
            benchZone.innerHTML = availablePlayers.map(createToken).join('');
            subsZone.innerHTML = subPlayers.map(createToken).join('');
            
            // Activar zonas de drop
            benchZone.ondragover = allowDrop;
            benchZone.ondrop = dropToBench; // Soltar aqu√≠ = Quitar de suplente/titular
            
            subsZone.ondragover = allowDrop;
            subsZone.ondrop = dropToSubs;   // Soltar aqu√≠ = Hacer suplente
        }

        // --- DRAG & DROP NATIVO ---

        function allowDrop(ev) {
            ev.preventDefault();
        }

        function drag(ev) {
            // Guardamos el ID del jugador que estamos arrastrando
            const playerId = ev.target.getAttribute('data-player-id');
            const sourceSlot = ev.target.getAttribute('data-current-slot'); // Si viene del campo
            
            ev.dataTransfer.setData("playerId", playerId);
            if (sourceSlot) ev.dataTransfer.setData("sourceSlot", sourceSlot);
        }

// --- L√ìGICA DE MOVIMIENTO ---

        function removePlayerFromAllZones(playerId) {
            // 1. Quitar del campo si estaba
            const slot = Object.keys(currentPitchPlayers).find(key => currentPitchPlayers[key] === playerId);
            if (slot) delete currentPitchPlayers[slot];
            
            // 2. Quitar de suplentes si estaba
            const subIndex = currentSubstitutes.indexOf(playerId);
            if (subIndex > -1) currentSubstitutes.splice(subIndex, 1);
        }

        // Soltar en el CAMPO (Titular)
        function drop(ev) {
            ev.preventDefault();
            const playerId = ev.dataTransfer.getData("playerId");
            
            // Validar que soltamos en un slot vac√≠o
            let target = ev.target;
            if (!target.classList.contains('pitch-slot')) return;
            const targetSlotId = target.id;

            removePlayerFromAllZones(playerId);
            
            // Si el hueco estaba ocupado, sobrescribimos (el anterior se va a disponibles)
            currentPitchPlayers[targetSlotId] = playerId;

            renderAll();
        }

        // Soltar en SUPLENTES
        function dropToSubs(ev) {
            ev.preventDefault();
            const playerId = ev.dataTransfer.getData("playerId");
            
            removePlayerFromAllZones(playerId);
            currentSubstitutes.push(playerId); // A√±adir a lista de suplentes
            
            renderAll();
        }

        // Soltar en DISPONIBLES (Quitar de convocatoria)
        function dropToBench(ev) {
            ev.preventDefault();
            const playerId = ev.dataTransfer.getData("playerId");
            
            removePlayerFromAllZones(playerId);
            // Al no estar en pitch ni subs, renderBench lo pondr√° en disponibles autom√°ticamente
            
            renderAll();
        }

        function renderAll() {
            renderTacticalBoard();
            renderBench();
        }

        // FASE 3 (Adelanto): Sincronizar Pizarra -> Checkbox de la Lista
        // Esta funci√≥n marca los checkboxes ocultos bas√°ndose en qui√©n est√° en el campo
        function syncListWithBoard() {
            // 1. Limpiar todos los checkboxes
            document.querySelectorAll('.chk-starter').forEach(chk => {
                chk.checked = false;
                handleRoleCheck(chk, 'starter'); // Actualizar visuales
            });

            // 2. Marcar los que est√°n en currentPitchPlayers
            Object.values(currentPitchPlayers).forEach(playerId => {
                // Buscar el div del jugador en la lista oculta
                const playerRow = document.querySelector(`div[data-player-id="${playerId}"]`);
                if (playerRow) {
                    const starterChk = playerRow.querySelector('.chk-starter');
                    if (starterChk) {
                        starterChk.checked = true;
                        handleRoleCheck(starterChk, 'starter');
                    }
                }
            });
        }
        function goToStep3() {
            // 1. Validar que hay 11 titulares
            const titularesIds = Object.values(currentPitchPlayers);
            // Filtramos undefined o null por si acaso
            const titularesReales = titularesIds.filter(id => id);
            
            if (titularesReales.length !== 11) {
                alert(`‚ö†Ô∏è Tienes ${titularesReales.length} jugadores en el campo. Deben ser exactamente 11.`);
                return;
            }
            const suplentesIds = currentSubstitutes;
            // 2. Identificar Suplentes (Est√°n en la zona #subs-zone)
            const subsZone = document.getElementById('subs-zone');

            // 3. Generar la lista limpia
            const container = document.getElementById('final-stats-container');
            const allPlayers = getPlayers(); // Todos los datos
            
            // Unimos y marcamos rol
            let selectedPlayers = [];
            
            // Titulares
            titularesReales.forEach(id => {
                const p = allPlayers.find(pl => pl.id === id);
                if(p) selectedPlayers.push({ ...p, rol: 'Titular' });
            });
            
            // Suplentes
            suplentesIds.forEach(id => {
                const p = allPlayers.find(pl => pl.id === id);
                if(p) selectedPlayers.push({ ...p, rol: 'Suplente' });
            });
            
            // Entrenador (Siempre va)
            const coach = allPlayers.find(p => p.posicion === 'entrenador');
            if(coach) selectedPlayers.push({ ...coach, rol: 'Entrenador' });

            // Renderizar HTML limpio
            container.innerHTML = selectedPlayers.map(p => {
                const isCoach = p.posicion === 'entrenador';
                const rolBadge = p.rol === 'Titular' 
                    ? '<span class="bg-green-100 text-green-800 text-xs font-bold px-2 py-1 rounded border border-green-200">TITULAR</span>'
                    : (isCoach ? '<span class="bg-gray-200 text-gray-800 text-xs font-bold px-2 py-1 rounded">STAFF</span>' 
                    : '<span class="bg-blue-100 text-blue-800 text-xs font-bold px-2 py-1 rounded border border-blue-200">SUPLENTE</span>');

                return `
                <div class="bg-white rounded-lg p-3 border border-gray-200 shadow-sm flex flex-col md:flex-row items-center gap-4" data-player-id="${p.id}" data-rol="${p.rol}">
                    <div class="flex items-center gap-3 w-full md:w-1/3">
                        <img src="${p.foto}" class="player-photo-xs border border-gray-200" onerror="this.src='https://via.placeholder.com/40x40'">
                        <div class="flex-1">
                            <div class="flex justify-between items-center">
                                <span class="font-bold text-gray-800 text-sm">${p.apodo || p.apellido}</span>
                                ${rolBadge}
                            </div>
                            <span class="text-xs text-gray-500">#${p.dorsal} - ${p.posicion}</span>
                        </div>
                    </div>

                    <div class="grid grid-cols-4 gap-2 w-full md:flex-1">
                        <div class="flex flex-col">
                            <label class="text-[10px] uppercase font-bold text-gray-500 mb-1">Nota</label>
                            <input type="number" class="stat-rating w-full px-2 py-1 border rounded text-sm text-center font-bold focus:ring-2 focus:ring-amber-500 outline-none" min="0" max="10" step="0.25" placeholder="-">
                        </div>
                        <div class="flex flex-col">
                            <label class="text-[10px] uppercase font-bold text-gray-500 mb-1">Goles</label>
                            ${!isCoach ? `<input type="number" class="stat-goals w-full px-2 py-1 border rounded text-sm text-center" min="0" value="0">` : `<span class="text-center text-gray-300 py-1">-</span>`}
                        </div>
                        <div class="flex flex-col">
                            <label class="text-[10px] uppercase font-bold text-gray-500 mb-1">Asist</label>
                            ${!isCoach ? `<input type="number" class="stat-assists w-full px-2 py-1 border rounded text-sm text-center" min="0" value="0">` : `<span class="text-center text-gray-300 py-1">-</span>`}
                        </div>
                        <div class="flex flex-col">
                            <label class="text-[10px] uppercase font-bold text-gray-500 mb-1">Min</label>
                            ${!isCoach ? `<input type="number" class="stat-minutes w-full px-2 py-1 border rounded text-sm text-center" min="0" max="120" value="${p.rol === 'Titular' ? 90 : 45}">` : `<span class="text-center text-gray-300 py-1">-</span>`}
                        </div>
                    </div>

                    <div class="flex gap-2 w-full md:w-auto border-t md:border-t-0 md:border-l border-gray-100 pt-2 md:pt-0 md:pl-3 justify-center">
                        <div class="flex flex-col items-center">
                            <label class="text-[10px] mb-1">üü®</label>
                            <input type="number" class="stat-yellow w-12 px-1 py-1 border rounded text-sm text-center" min="0" max="2" value="0">
                        </div>
                        <div class="flex flex-col items-center">
                            <label class="text-[10px] mb-1">üü•</label>
                            <input type="number" class="stat-red w-12 px-1 py-1 border rounded text-sm text-center" min="0" max="1" value="0">
                        </div>
                    </div>
                </div>
                `;
            }).join('');

            // 4. Cambiar Pantalla
            document.getElementById('wizard-step-2').classList.add('hidden');
            document.getElementById('wizard-step-3').classList.remove('hidden');
        }
        // ==========================================
        // SISTEMA DE COPIA DE SEGURIDAD (BACKUP)
        // ==========================================

        // ==========================================
        // SISTEMA DE COPIA DE SEGURIDAD (CORREGIDO)
        // ==========================================

        function backupData() {
            if (!currentTeam) {
                alert("‚ö†Ô∏è Error: No hay un equipo seleccionado.");
                return;
            }

            // CORRECCI√ìN: Usamos getData() que sabe buscar en la carpeta correcta (ej: masculino_matches)
            const matches = getData('matches');
            const competitionState = getData('competitionState') || {}; // Usamos getData en vez de getCompetitionState para consistencia
            const playerStates = getData('playerStates') || []; // Tambi√©n guardamos los estados (activo/inactivo)

            // Creamos el paquete completo
            const data = {
                team: currentTeam, // "masculino" o "femenino"
                matches: matches,
                competitionState: competitionState,
                playerStates: playerStates,
                timestamp: new Date().toISOString(),
                version: '1.1'
            };

            // Convertir y descargar
            const dataStr = JSON.stringify(data, null, 2);
            const blob = new Blob([dataStr], { type: "application/json" });
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            const date = new Date().toISOString().split('T')[0];
            // El nombre del archivo ahora incluye el equipo para no confundirlos
            a.download = `Backup_RealMadrid_${currentTeam}_${date}.json`;
            a.href = url;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
            
            alert(`‚úÖ Copia de seguridad descargada (${matches.length} partidos).`);
        }

      function restoreData(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    const data = JSON.parse(content);
                    
                    // 1. Validaciones b√°sicas
                    if (!data.matches || !data.team) {
                        throw new Error("El archivo no es v√°lido (faltan datos o equipo).");
                    }

                    // 2. Validaci√≥n de Equipo Cruzado (Importante)
                    if (data.team !== currentTeam) {
                        if (!confirm(`‚ö†Ô∏è ARCHIVO DE OTRO EQUIPO\n\nEl archivo es del: ${data.team.toUpperCase()}\nEst√°s en: ${currentTeam.toUpperCase()}\n\n¬øQuieres sobrescribir los datos de ${currentTeam.toUpperCase()} con los del archivo?`)) {
                            input.value = '';
                            return;
                        }
                    } else {
                        if (!confirm(`‚ö†Ô∏è RESTAURAR COPIA\n\nSe van a cargar ${data.matches.length} partidos.\nLos datos actuales se perder√°n.\n¬øContinuar?`)) {
                            input.value = '';
                            return;
                        }
                    }

                    // 3. Guardar Datos
                    saveData('matches', data.matches);
                    saveData('competitionState', data.competitionState || {});
                    if (data.playerStates) {
                        saveData('playerStates', data.playerStates);
                    }

                    // 4. VERIFICACI√ìN (Comprobamos si se ha guardado bien)
                    const checkMatches = getData('matches');
                    if (!checkMatches || checkMatches.length !== data.matches.length) {
                        throw new Error("Error al escribir en la memoria del navegador.");
                    }

                    // 5. Refrescar TODO al instante (Sin recargar p√°gina)
                    // Esto fuerza a la web a leer los nuevos datos inmediatamente
                    calendarEvents = []; // Limpiamos cach√© de calendario para evitar conflictos
                    loadCalendar();      // Recargamos calendario
                    
                    renderPlayers();          // Actualizamos estados de jugadores
                    renderCompetitionStatus(); // Actualizamos rondas
                    renderMatches();           // Actualizamos lista de partidos
                    renderStats();             // Actualizamos estad√≠sticas
                    renderPrincipal();         // Actualizamos panel principal
                    
                    alert(`‚úÖ √âXITO: ${checkMatches.length} partidos restaurados correctamente.`);
                    
                    // Te llevamos a la pesta√±a de partidos para que veas que est√°n ah√≠
                    showTab('partidos');

                } catch (err) {
                    console.error(err);
                    alert("‚ùå ERROR: " + err.message);
                } finally {
                    input.value = ''; // Limpiar input para permitir recargar el mismo archivo si hace falta
                }
            };
            
            reader.readAsText(file);
        }

        function hardReset() {
            if (confirm("‚õî ¬øEST√ÅS SEGURO?\n\nEsto borrar√° TODOS los partidos y estad√≠sticas para siempre.\nNo se puede deshacer.")) {
                const team = currentTeam; // Guardar equipo actual para no perdernos
                localStorage.clear();
                localStorage.setItem('currentTeam', team); // Restaurar preferencia
                alert("üóëÔ∏è Todo borrado. Empezamos de cero.");
                location.reload();
            }
        }
        function toggleDarkMode() {
            document.body.classList.toggle('dark-mode');
            const isDark = document.body.classList.contains('dark-mode');
            
            // Guardar preferencia
            localStorage.setItem('darkMode', isDark);
            
            // Actualizar bot√≥n
            updateDarkModeButton(isDark);
            
            // Actualizar gr√°ficos (si estamos en esa pesta√±a)
            updateChartsTheme(isDark);
        }

        function updateDarkModeButton(isDark) {
            const btn = document.getElementById('btn-dark-mode');
            if(btn) btn.textContent = isDark ? '‚òÄÔ∏è' : 'üåô';
        }

        function updateChartsTheme(isDark) {
            // Cambiar colores globales de Chart.js
            Chart.defaults.color = isDark ? '#e2e8f0' : '#4b5563';
            Chart.defaults.borderColor = isDark ? '#334155' : '#e5e7eb';
            
            // Si los gr√°ficos existen, redibujarlos para aplicar nuevos colores
            // Simplemente llamamos a renderStats si la pesta√±a est√° activa
            if (!document.getElementById('section-stats').classList.contains('hidden')) {
                renderStats(); 
            }
        }

        function initDarkMode() {
            const savedMode = localStorage.getItem('darkMode') === 'true';
            if (savedMode) {
                document.body.classList.add('dark-mode');
                updateChartsTheme(true);
            }
            updateDarkModeButton(savedMode);
        }
        function applyMatchFilters() {
            const text = document.getElementById('filter-rival').value.toLowerCase();
            const comp = document.getElementById('filter-competition').value;
            const res = document.getElementById('filter-result').value;
            
            const matches = getData('matches');

            const filtered = matches.filter(m => {
                // 1. Filtro Texto (Rival)
                const matchText = m.opponent.toLowerCase();
                if (text && !matchText.includes(text)) return false;

                // 2. Filtro Competici√≥n
                if (comp !== 'all' && m.competition !== comp) return false;

                // 3. Filtro Resultado
                if (res !== 'all' && m.outcome !== res) return false;

                return true;
            });

            renderMatches(filtered); // Reutilizamos tu funci√≥n pas√°ndole la lista filtrada
        }
        // ==========================================
        // COMPARADOR DE JUGADORES (RADAR)
        // ==========================================
        let radarChart = null;

        function openComparatorModal() {
            const modal = document.getElementById('modal-comparator');
            const p1Select = document.getElementById('comp-p1');
            const p2Select = document.getElementById('comp-p2');
            const players = getPlayers().filter(p => p.posicion !== 'entrenador');

            // Llenar selects si est√°n vac√≠os
            if (p1Select.options.length === 0) {
                players.forEach(p => {
                    const opt = `<option value="${p.id}">${p.apodo || p.apellido}</option>`;
                    p1Select.innerHTML += opt;
                    p2Select.innerHTML += opt;
                });
                // Seleccionar dos diferentes por defecto
                if(players.length > 1) p2Select.selectedIndex = 1; 
            }

            modal.classList.remove('hidden');
            updateComparatorChart();
        }

        function updateComparatorChart() {
            const id1 = document.getElementById('comp-p1').value;
            const id2 = document.getElementById('comp-p2').value;
            const players = getPlayers();
            const matches = getData('matches');

            const p1 = players.find(p => p.id === id1);
            const p2 = players.find(p => p.id === id2);

            // Calcular Stats de cada uno
            const getStats = (pid) => {
                let g = 0, a = 0, mins = 0, mvp = 0, rateSum = 0, rateCount = 0, matchesCount = 0;
                matches.forEach(m => {
                    const ps = m.playerStats.find(s => s.playerId === pid);
                    if (ps) {
                        g += ps.goals || 0;
                        a += ps.assists || 0;
                        mins += ps.minutes || 0;
                        matchesCount++;
                        if(m.mvp === pid) mvp++;
                        if (ps.rating) { rateSum += parseFloat(ps.rating); rateCount++; }
                    }
                });
                return { 
                    goals: g, 
                    assists: a, 
                    minutes: mins, 
                    mvp: mvp, 
                    avg: rateCount > 0 ? (rateSum / rateCount) : 0,
                    matches: matchesCount
                };
            };

            const s1 = getStats(id1);
            const s2 = getStats(id2);

            // --- NORMALIZACI√ìN (Para que el gr√°fico se vea bien 0-100) ---
            // Buscamos el "M√°ximo" del equipo para usarlo de referencia (techo)
            // Si el m√°ximo goleador lleva 20 goles, 20 goles = 100 puntos.
            let maxGoals = 1, maxAssists = 1, maxMins = 1;
            matches.forEach(m => m.playerStats.forEach(ps => {
                // C√°lculo r√°pido de m√°ximos globales (simplificado)
                if(ps.goals > 0 && ps.goals * 5 > maxGoals) maxGoals = 15; // Aproximaci√≥n
            }));
            // Ajustamos techos manuales para evitar divisiones por cero o gr√°ficos feos
            const ceilings = { goals: 20, assists: 15, minutes: matches.length * 90, avg: 10, mvp: 5 };

            const normalize = (val, max) => Math.min(100, Math.round((val / max) * 100));

            const data1 = [
                normalize(s1.goals, ceilings.goals),
                normalize(s1.assists, ceilings.assists),
                normalize(s1.avg, ceilings.avg),
                normalize(s1.minutes, ceilings.minutes),
                normalize(s1.mvp, ceilings.mvp)
            ];
            
            const data2 = [
                normalize(s2.goals, ceilings.goals),
                normalize(s2.assists, ceilings.assists),
                normalize(s2.avg, ceilings.avg),
                normalize(s2.minutes, ceilings.minutes),
                normalize(s2.mvp, ceilings.mvp)
            ];

            // --- RENDERIZAR GR√ÅFICO ---
            const ctx = document.getElementById('chart-radar-vs').getContext('2d');
            if (radarChart) radarChart.destroy();

            const isDark = document.body.classList.contains('dark-mode');
            const color1 = 'rgba(59, 130, 246,'; // Blue
            const color2 = 'rgba(239, 68, 68,';  // Red

            radarChart = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: ['Goles', 'Asistencias', 'Nota Media', 'Minutos', 'MVPs'],
                    datasets: [
                        {
                            label: p1.apodo || p1.apellido,
                            data: data1,
                            borderColor: color1 + ' 1)',
                            backgroundColor: color1 + ' 0.2)',
                            pointBackgroundColor: color1 + ' 1)',
                            borderWidth: 2
                        },
                        {
                            label: p2.apodo || p2.apellido,
                            data: data2,
                            borderColor: color2 + ' 1)',
                            backgroundColor: color2 + ' 0.2)',
                            pointBackgroundColor: color2 + ' 1)',
                            borderWidth: 2
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        r: {
                            beginAtZero: true,
                            max: 100,
                            ticks: { display: false }, // Ocultar n√∫meros del eje
                            grid: { color: isDark ? '#334155' : '#e5e7eb' },
                            pointLabels: {
                                font: { size: 12, weight: 'bold' },
                                color: isDark ? '#f1f5f9' : '#374151'
                            }
                        }
                    }
                }
            });

            // --- ACTUALIZAR TABLA DE DATOS ---
            const row = (label, v1, v2) => `
                <div class="flex justify-between items-center border-b border-gray-200 pb-1 last:border-0">
                    <span class="font-bold ${v1 > v2 ? 'text-blue-600' : 'text-gray-400'}">${typeof v1 === 'number' && v1 % 1 !== 0 ? v1.toFixed(2) : v1}</span>
                    <span class="text-xs text-gray-500 uppercase mx-2">${label}</span>
                    <span class="font-bold ${v2 > v1 ? 'text-red-600' : 'text-gray-400'}">${typeof v2 === 'number' && v2 % 1 !== 0 ? v2.toFixed(2) : v2}</span>
                </div>
            `;
            
            document.getElementById('comparator-stats-table').innerHTML = `
                ${row('Goles', s1.goals, s2.goals)}
                ${row('Asistencias', s1.assists, s2.assists)}
                ${row('Nota Media', s1.avg, s2.avg)}
                ${row('Minutos', s1.minutes, s2.minutes)}
                ${row('MVPs', s1.mvp, s2.mvp)}
                ${row('Partidos', s1.matches, s2.matches)}
            `;
        }

        // Global Modal Close Handler
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    modal.classList.remove('active');
                }
            });
        });

        // Init
        document.addEventListener('DOMContentLoaded', () => {
            console.log('App ready');
            initDarkMode();
            preloadCalendars();
        });

    </script>
</body>
</html>